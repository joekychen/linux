<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ceph › osdmap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>osdmap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &lt;linux/ceph/libceph.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/osdmap.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>
<span class="cp">#include &lt;linux/crush/hash.h&gt;</span>
<span class="cp">#include &lt;linux/crush/mapper.h&gt;</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">ceph_osdmap_state_str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_EXISTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;exists&quot;</span><span class="p">);</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s%s%s&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="p">(</span><span class="n">flag</span> <span class="o">?</span> <span class="s">&quot;, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
				 <span class="s">&quot;up&quot;</span><span class="p">);</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;doesn&#39;t exist&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* maps */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_bits_of</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * the foo_mask is the smallest value 2^n-1 that is &gt;= foo.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_pg_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pg_num_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">calc_bits_of</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pg_num</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pgp_num_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">calc_bits_of</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pgp_num</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">lpg_num_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">calc_bits_of</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">lpg_num</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">lpgp_num_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">calc_bits_of</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">lpgp_num</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode crush map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">crush_decode_uniform_bucket</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">crush_bucket_uniform</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode_uniform_bucket %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weight</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crush_decode_list_bucket</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crush_bucket_list</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode_list_bucket %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">sum_weights</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">sum_weights</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">sum_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crush_decode_tree_bucket</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crush_bucket_tree</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode_tree_bucket %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">node_weights</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">node_weights</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">num_nodes</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">num_nodes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">node_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crush_decode_straw_bucket</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">crush_bucket_straw</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode_straw_bucket %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">straws</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">straws</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">item_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">straws</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crush_map</span> <span class="o">*</span><span class="nf">crush_decode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pbyval</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crush_map</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbyval</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">pbyval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">magic</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode %p to %p len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span> <span class="o">-</span> <span class="o">*</span><span class="n">p</span><span class="p">));</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">magic</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">CRUSH_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;crush_decode magic %x != current %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">magic</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">CRUSH_MAGIC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_buckets</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_rules</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_devices</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_buckets</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_rules</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>

	<span class="cm">/* buckets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_buckets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">alg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">crush_bucket</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode bucket %d off %x %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="o">-</span><span class="n">start</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_UNIFORM</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_uniform</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_LIST</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_TREE</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_tree</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_STRAW</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_straw</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>

		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ceph_decode_16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode bucket size %d off %x %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="o">-</span><span class="n">start</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="n">b</span><span class="o">-&gt;</span><span class="n">items</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__s32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">items</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">perm</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">perm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">perm_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_UNIFORM</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">crush_decode_uniform_bucket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span>
				  <span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_uniform</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_LIST</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">crush_decode_list_bucket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span>
			       <span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_list</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_TREE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">crush_decode_tree_bucket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_tree</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRUSH_BUCKET_STRAW</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">crush_decode_straw_bucket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">crush_bucket_straw</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* rules */</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rule vec is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_rules</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">yes</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">crush_rule</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">yes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode NO rule %d off %x %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="o">-</span><span class="n">start</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode rule %d off %x %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="o">-</span><span class="n">start</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="cm">/* len */</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ULONG_MAX</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
			  <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_rule_step</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span>
					  <span class="n">yes</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crush_rule_step</span><span class="p">),</span>
					  <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">badmem</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; rule %d is at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">yes</span><span class="p">;</span>
		<span class="n">ceph_decode_copy_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span> <span class="cm">/* 4 u8&#39;s */</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">steps</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">steps</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">steps</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ignore trailing name maps. */</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

<span class="nl">badmem:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;crush_decode fail %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">crush_destroy</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rbtree of pg_mapping for handling pg_temp (explicit mapping of pgid</span>
<span class="cm"> * to a set of osds)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pgid_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">l</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__insert_pg_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__insert_pg_mapping %llx %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_mapping</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">pgid_cmp</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="nf">__lookup_pg_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_mapping</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">pgid_cmp</span><span class="p">(</span><span class="n">pgid</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__lookup_pg_mapping %llx got %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">pg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__remove_pg_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="n">__lookup_pg_mapping</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_pg_mapping %llx %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="n">pg</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_pg_mapping %llx dne</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgid</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rbtree of pg pool info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__insert_pg_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="nf">__lookup_pg_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">pi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_pg_poolid_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rbp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rbp</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">);</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">rbp</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">rbp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span>
			<span class="n">rb_entry</span><span class="p">(</span><span class="n">rbp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_pg_poolid_by_name</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__remove_pg_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__decode_pool</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">));</span>
	<span class="n">calc_pg_masks</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="cm">/* num_snaps * snap_info_t */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">num_snaps</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">+</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_timespec</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">+</span>       <span class="cm">/* key */</span>
			<span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">+</span> <span class="cm">/* u8, snapid */</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_timespec</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    <span class="cm">/* snap name */</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">num_removed_snap_intervals</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__decode_pool_names</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pool</span><span class="p">;</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; %d pool names</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;  pool %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">__lookup_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;  name is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * osd map</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_osdmap_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_destroy %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">)</span>
		<span class="n">crush_destroy</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span>
			<span class="n">rb_entry</span><span class="p">(</span><span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">),</span>
				 <span class="k">struct</span> <span class="n">ceph_pg_mapping</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span>
			<span class="n">rb_entry</span><span class="p">(</span><span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">),</span>
				 <span class="k">struct</span> <span class="n">ceph_pg_pool_info</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">__remove_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * adjust max osd value.  reallocate arrays.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osdmap_set_max_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">weight</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">weight</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">weight</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">weight</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">weight</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy old? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">weight</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode a full map.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="nf">osdmap_decode</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_decode %p to %p len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span> <span class="o">-</span> <span class="o">*</span><span class="n">p</span><span class="p">));</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>

	<span class="n">ceph_decode_16_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">CEPH_OSDMAP_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got unknown v %d &gt; %d of osdmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
			   <span class="n">CEPH_OSDMAP_VERSION</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">));</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">));</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">modified</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">modified</span><span class="p">));</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pi</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="cm">/* encoding version */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&gt;</span> <span class="n">CEPH_PG_POOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got unknown v %d &gt; %d of ceph_pg_pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ev</span><span class="p">,</span> <span class="n">CEPH_PG_POOL_VERSION</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__decode_pool</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__insert_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">__decode_pool_names</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pool_max</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="cm">/* (re)alloc osd arrays */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">osdmap_set_max_osd</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_decode max_osd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">);</span>

	<span class="cm">/* osds */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span>
			 <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">)</span> <span class="o">+</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">)),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* skip length field (should match max) */</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* skip length field (should match max) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* skip length field (should match max) */</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ceph_decode_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* pg_temp */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pgid</span><span class="p">));</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pg</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgid</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pg</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">__insert_pg_mapping</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; added pg_temp %llx len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* crush */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_decode crush len %d from off 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="n">start</span><span class="p">));</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span> <span class="o">=</span> <span class="n">crush_decode</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ignore the rest of the map */</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_decode done %p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">map</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdmap_decode fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ceph_osdmap_destroy</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode and apply an incremental map update.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="nf">osdmap_apply_incremental</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crush_map</span> <span class="o">*</span><span class="n">newcrush</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">modified</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">pool</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">new_pool_max</span><span class="p">,</span> <span class="n">new_flags</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">ceph_decode_16_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">CEPH_OSDMAP_INC_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got unknown v %d &gt; %d of inc osdmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
			   <span class="n">CEPH_OSDMAP_INC_VERSION</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			 <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">));</span>
	<span class="n">epoch</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epoch</span> <span class="o">!=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modified</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">modified</span><span class="p">));</span>
	<span class="n">new_pool_max</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">new_flags</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="cm">/* full map? */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;apply_incremental full map len %d, %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">osdmap_decode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">end</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* new crush? */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;apply_incremental new crush map len %d, %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="n">newcrush</span> <span class="o">=</span> <span class="n">crush_decode</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">end</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newcrush</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">newcrush</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new flags? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_flags</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new_flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_pool_max</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">pool_max</span> <span class="o">=</span> <span class="n">new_pool_max</span><span class="p">;</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>

	<span class="cm">/* new max? */</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">osdmap_set_max_osd</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="o">++</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">modified</span> <span class="o">=</span> <span class="n">modified</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newcrush</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">)</span>
			<span class="n">crush_destroy</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">crush</span> <span class="o">=</span> <span class="n">newcrush</span><span class="p">;</span>
		<span class="n">newcrush</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new_pool */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">ev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>  <span class="cm">/* encoding version */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&gt;</span> <span class="n">CEPH_PG_POOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got unknown v %d &gt; %d of ceph_pg_pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ev</span><span class="p">,</span> <span class="n">CEPH_PG_POOL_VERSION</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">__lookup_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pi</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
			<span class="n">__insert_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__decode_pool</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">__decode_pool_names</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="cm">/* old_pool */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>

		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">__lookup_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="p">)</span>
			<span class="n">__remove_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* new_up */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">osd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_copy_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;osd%d up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">osd</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">[</span><span class="n">osd</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CEPH_OSD_UP</span><span class="p">;</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">[</span><span class="n">osd</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new_state */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">osd</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">xorstate</span><span class="p">;</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">xorstate</span> <span class="o">=</span> <span class="o">**</span><span class="p">(</span><span class="n">u8</span> <span class="o">**</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* clean flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xorstate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xorstate</span> <span class="o">=</span> <span class="n">CEPH_OSD_UP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xorstate</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_UP</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;osd%d down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osd</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">)</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_state</span><span class="p">[</span><span class="n">osd</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xorstate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new_weight */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">osd</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">osd</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;osd%d weight 0x%x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span>
		     <span class="n">off</span> <span class="o">==</span> <span class="n">CEPH_OSD_IN</span> <span class="o">?</span> <span class="s">&quot;(in)&quot;</span> <span class="o">:</span>
		     <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">CEPH_OSD_OUT</span> <span class="o">?</span> <span class="s">&quot;(out)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osd</span> <span class="o">&lt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">max_osd</span><span class="p">)</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">[</span><span class="n">osd</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new_pg_temp */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pglen</span><span class="p">;</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pgid</span><span class="p">));</span>
		<span class="n">pglen</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pglen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pglen</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>

			<span class="cm">/* removing existing (if any) */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__remove_pg_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>

			<span class="cm">/* insert */</span>
			<span class="n">pg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pg</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">pglen</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgid</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>
			<span class="n">pg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pglen</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pglen</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pg</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">__insert_pg_mapping</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; added pg_temp %llx len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span>
			     <span class="n">pglen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* remove */</span>
			<span class="n">__remove_pg_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ignore the rest */</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">map</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;corrupt inc osdmap epoch %d off %d (%p of %p-%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">epoch</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;osdmap: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newcrush</span><span class="p">)</span>
		<span class="n">crush_destroy</span><span class="p">(</span><span class="n">newcrush</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * calculate file layout from given offset, length.</span>
<span class="cm"> * fill in correct oid, logical length, and object extent</span>
<span class="cm"> * offset, length.</span>
<span class="cm"> *</span>
<span class="cm"> * for now, we write only a single su, until we can</span>
<span class="cm"> * pass a stride back to the caller.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_calc_file_object_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="o">*</span><span class="n">ono</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="o">*</span><span class="n">oxoff</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">oxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">osize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_object_size</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">su</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_stripe_unit</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_stripe_count</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bl</span><span class="p">,</span> <span class="n">stripeno</span><span class="p">,</span> <span class="n">stripepos</span><span class="p">,</span> <span class="n">objsetno</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">su_per_object</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">t</span><span class="p">,</span> <span class="n">su_offset</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mapping %llu~%llu  osize %u fl_su %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
	     <span class="n">osize</span><span class="p">,</span> <span class="n">su</span><span class="p">);</span>
	<span class="n">su_per_object</span> <span class="o">=</span> <span class="n">osize</span> <span class="o">/</span> <span class="n">su</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osize %u / su %u = su_per_object %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osize</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span>
	     <span class="n">su_per_object</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">su</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* bl = *off / su; */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">su</span><span class="p">);</span>
	<span class="n">bl</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;off %llu / su %u = bl %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">bl</span><span class="p">);</span>

	<span class="n">stripeno</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">/</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">stripepos</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">%</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">objsetno</span> <span class="o">=</span> <span class="n">stripeno</span> <span class="o">/</span> <span class="n">su_per_object</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ono</span> <span class="o">=</span> <span class="n">objsetno</span> <span class="o">*</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">stripepos</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;objset %u * sc %u = ono %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">objsetno</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">ono</span><span class="p">);</span>

	<span class="cm">/* *oxoff = *off % layout-&gt;fl_stripe_unit;  # offset in su */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">su_offset</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">su</span><span class="p">);</span>
	<span class="o">*</span><span class="n">oxoff</span> <span class="o">=</span> <span class="n">su_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">stripeno</span> <span class="o">%</span> <span class="n">su_per_object</span><span class="p">)</span> <span class="o">*</span> <span class="n">su</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the length of the extent being written to the selected</span>
<span class="cm">	 * object. This is the minimum of the full length requested (plen) or</span>
<span class="cm">	 * the remainder of the current stripe being written to.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">oxlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span> <span class="n">su</span> <span class="o">-</span> <span class="n">su_offset</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="o">*</span><span class="n">oxlen</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; obj extent %llu~%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">oxoff</span><span class="p">,</span> <span class="o">*</span><span class="n">oxlen</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_calc_file_object_mapping</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * calculate an object layout (i.e. pgid) from an oid,</span>
<span class="cm"> * file_layout, and osdmap</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_calc_object_layout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_object_layout</span> <span class="o">*</span><span class="n">ol</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oid</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">osdmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">num_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poolid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pg_pool</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ps</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">osdmap</span><span class="p">);</span>

	<span class="n">pool</span> <span class="o">=</span> <span class="n">__lookup_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">poolid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">ceph_str_hash</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">object_hash</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">oid</span><span class="p">));</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pg_num</span><span class="p">);</span>
	<span class="n">num_mask</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pg_num_mask</span><span class="p">;</span>

	<span class="n">pgid</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
	<span class="n">pgid</span><span class="p">.</span><span class="n">preferred</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">pgid</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pg_pool</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;calc_object_layout &#39;%s&#39; pgid %d.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">poolid</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>

	<span class="n">ol</span><span class="o">-&gt;</span><span class="n">ol_pgid</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="n">ol</span><span class="o">-&gt;</span><span class="n">ol_stripe_unit</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_object_stripe_unit</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_calc_object_layout</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate raw osd vector for the given pgid.  Return pointer to osd</span>
<span class="cm"> * array, or NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">calc_pg_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">osdmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">osds</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pg_mapping</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg_pool_info</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ruleno</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">poolid</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">pps</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">poolid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pgid</span><span class="p">.</span><span class="n">pool</span><span class="p">);</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pgid</span><span class="p">.</span><span class="n">ps</span><span class="p">);</span>

	<span class="n">pool</span> <span class="o">=</span> <span class="n">__lookup_pg_pool</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">pg_pools</span><span class="p">,</span> <span class="n">poolid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* pg_temp? */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ceph_stable_mod</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pg_num</span><span class="p">),</span>
			    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pgp_num_mask</span><span class="p">);</span>
	<span class="n">pgid</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">pg</span> <span class="o">=</span> <span class="n">__lookup_pg_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">pg_temp</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* crush */</span>
	<span class="n">ruleno</span> <span class="o">=</span> <span class="n">crush_find_rule</span><span class="p">(</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">crush_ruleset</span><span class="p">,</span>
				 <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ruleno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no crush rule pool %d ruleset %d type %d size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">poolid</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">crush_ruleset</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		       <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pps</span> <span class="o">=</span> <span class="n">ceph_stable_mod</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span>
			      <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pgp_num</span><span class="p">),</span>
			      <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pgp_num_mask</span><span class="p">);</span>
	<span class="n">pps</span> <span class="o">+=</span> <span class="n">poolid</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">crush_do_rule</span><span class="p">(</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">crush</span><span class="p">,</span> <span class="n">ruleno</span><span class="p">,</span> <span class="n">pps</span><span class="p">,</span> <span class="n">osds</span><span class="p">,</span>
			  <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">num</span><span class="p">),</span>
			  <span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">osd_weight</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d from crush rule: pool %d ruleset %d type %d&quot;</span>
		       <span class="s">&quot; size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">poolid</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">crush_ruleset</span><span class="p">,</span>
		       <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">osds</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return acting set for given pgid.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_calc_pg_acting</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">osdmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">acting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rawosds</span><span class="p">[</span><span class="n">CEPH_PG_MAX_SIZE</span><span class="p">],</span> <span class="o">*</span><span class="n">osds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">CEPH_PG_MAX_SIZE</span><span class="p">;</span>

	<span class="n">osds</span> <span class="o">=</span> <span class="n">calc_pg_raw</span><span class="p">(</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">rawosds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osds</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* primary is first up osd */</span>
	<span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ceph_osd_is_up</span><span class="p">(</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">osds</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">acting</span><span class="p">[</span><span class="n">o</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">osds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return primary osd for given pgid, or -1 if none.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_calc_pg_primary</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">osdmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rawosds</span><span class="p">[</span><span class="n">CEPH_PG_MAX_SIZE</span><span class="p">],</span> <span class="o">*</span><span class="n">osds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">CEPH_PG_MAX_SIZE</span><span class="p">;</span>

	<span class="n">osds</span> <span class="o">=</span> <span class="n">calc_pg_raw</span><span class="p">(</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">rawosds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osds</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* primary is first up osd */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ceph_osd_is_up</span><span class="p">(</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">osds</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">osds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_calc_pg_primary</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
