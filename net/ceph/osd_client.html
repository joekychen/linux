<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ceph › osd_client.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>osd_client.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/ceph/libceph.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/osd_client.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/messenger.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/auth.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/pagelist.h&gt;</span>

<span class="cp">#define OSD_OP_FRONT_LEN	4096</span>
<span class="cp">#define OSD_OPREPLY_FRONT_LEN	512</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_connection_operations</span> <span class="n">osd_con_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">send_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__reset_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__register_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__unregister_linger_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">op_needs_trail</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_GETXATTR</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_SETXATTR</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_CMPXATTR</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_CALL</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_NOTIFY</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">op_has_extent</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_READ</span> <span class="o">||</span>
		<span class="n">op</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_WRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_calc_raw_layout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bno</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="o">*</span><span class="n">reqhead</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orig_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">plen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">objoff</span><span class="p">,</span> <span class="n">objlen</span><span class="p">;</span>    <span class="cm">/* extent in object */</span>

	<span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">snapid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">snapid</span><span class="p">);</span>

	<span class="cm">/* object extent? */</span>
	<span class="n">ceph_calc_file_object_mapping</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">objoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="n">orig_len</span><span class="p">)</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; skipping last %llu, final file extent %llu~%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">orig_len</span> <span class="o">-</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_has_extent</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">objoff</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">objlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_page_alignment</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_WRITE</span><span class="p">)</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">plen</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;calc_layout bno=%llx %llu~%llu (%d pages)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="o">*</span><span class="n">bno</span><span class="p">,</span> <span class="n">objoff</span><span class="p">,</span> <span class="n">objlen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_calc_raw_layout</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Implement client access to distributed object storage cluster.</span>
<span class="cm"> *</span>
<span class="cm"> * All data objects are stored within a cluster/cloud of OSDs, or</span>
<span class="cm"> * &quot;object storage devices.&quot;  (Note that Ceph OSDs have _nothing_ to</span>
<span class="cm"> * do with the T10 OSD extensions to SCSI.)  Ceph OSDs are simply</span>
<span class="cm"> * remote daemons serving up and coordinating consistent and safe</span>
<span class="cm"> * access to storage.</span>
<span class="cm"> *</span>
<span class="cm"> * Cluster membership and the mapping of data objects onto storage devices</span>
<span class="cm"> * are described by the osd map.</span>
<span class="cm"> *</span>
<span class="cm"> * We keep track of pending OSD requests (read, write), resubmit</span>
<span class="cm"> * requests to different OSDs when the cluster topology/data layout</span>
<span class="cm"> * change, or retry the affected requests when the communications</span>
<span class="cm"> * channel with an OSD is reset.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * calculate the mapping of a file extent onto an object, and fill out the</span>
<span class="cm"> * request accordingly.  shorten extent as necessary if it crosses an</span>
<span class="cm"> * object boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * fill osd op in request message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_layout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">bno</span><span class="p">;</span>

	<span class="n">ceph_calc_raw_layout</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">vino</span><span class="p">.</span><span class="n">snap</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span>
			     <span class="n">plen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">),</span> <span class="s">&quot;%llx.%08llx&quot;</span><span class="p">,</span> <span class="n">vino</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span> <span class="n">bno</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * requests</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_osdc_release_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span>
						    <span class="n">r_kref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">)</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;release_request revoking pages %p from con %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">);</span>
		<span class="n">ceph_con_revoke_message</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">,</span>
				      <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">)</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_own_pages</span><span class="p">)</span>
		<span class="n">ceph_release_page_vector</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span><span class="p">,</span>
					 <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span><span class="p">)</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ceph_put_snap_context</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_snapc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_pagelist_release</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_mempool</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_release_request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_num_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">needs_trail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needs_trail</span><span class="p">)</span>
		<span class="o">*</span><span class="n">needs_trail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">needs_trail</span> <span class="o">&amp;&amp;</span> <span class="n">op_needs_trail</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op</span><span class="p">))</span>
			<span class="o">*</span><span class="n">needs_trail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="nf">ceph_osdc_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
					       <span class="n">bool</span> <span class="n">use_mempool</span><span class="p">,</span>
					       <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_trail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_op</span> <span class="o">=</span> <span class="n">get_num_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needs_trail</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">msg_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request_head</span><span class="p">);</span>

	<span class="n">msg_size</span> <span class="o">+=</span> <span class="n">num_op</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_op</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_mempool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osdc</span> <span class="o">=</span> <span class="n">osdc</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_mempool</span> <span class="o">=</span> <span class="n">use_mempool</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_kref</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_item</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_item</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_osd</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CEPH_OSD_FLAG_READ</span><span class="o">|</span><span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* create reply message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_mempool</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msgpool_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op_reply</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_OSD_OPREPLY</span><span class="p">,</span>
				   <span class="n">OSD_OPREPLY_FRONT_LEN</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/* allocate space for the trailing data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_trail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_pagelist</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ceph_pagelist_init</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* create request message; allow space for oid */</span>
	<span class="n">msg_size</span> <span class="o">+=</span> <span class="n">MAX_OBJ_NAME_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snapc</span><span class="p">)</span>
		<span class="n">msg_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">snapc</span><span class="o">-&gt;</span><span class="n">num_snaps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_mempool</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msgpool_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_OSD_OP</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CEPH_MSG_OSD_OP</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">bio_get</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_alloc_request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_req_encode_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_READ</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_WRITE</span>:
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_size</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_size</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_seq</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_OSD_OP_GETXATTR</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_SETXATTR</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_CMPXATTR</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">name_len</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">value_len</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">cmp_op</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">cmp_op</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">cmp_mode</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">cmp_mode</span><span class="p">;</span>
		<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				     <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">name_len</span><span class="p">);</span>
		<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
				     <span class="n">src</span><span class="o">-&gt;</span><span class="n">xattr</span><span class="p">.</span><span class="n">value_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_CALL</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">class_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">class_len</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">method_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">method_len</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">indata_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">indata_len</span><span class="p">);</span>

		<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">class_name</span><span class="p">,</span>
				     <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">class_len</span><span class="p">);</span>
		<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">method_name</span><span class="p">,</span>
				     <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">method_len</span><span class="p">);</span>
		<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">indata</span><span class="p">,</span>
				     <span class="n">src</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">.</span><span class="n">indata_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_ROLLBACK</span>:
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">snap</span><span class="p">.</span><span class="n">snapid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">snap</span><span class="p">.</span><span class="n">snapid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_STARTSYNC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_NOTIFY</span>:
		<span class="p">{</span>
			<span class="n">__le32</span> <span class="n">prot_ver</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">prot_ver</span><span class="p">);</span>
			<span class="n">__le32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">);</span>

			<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">prot_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prot_ver</span><span class="p">));</span>
			<span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_NOTIFY_ACK</span>:
	<span class="k">case</span> <span class="n">CEPH_OSD_OP_WATCH</span>:
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unrecognized osd opcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">payload_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * build new request AND message</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_osdc_build_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">src_ops</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">mtime</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oid</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">oid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">src_op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_op</span> <span class="o">=</span> <span class="n">get_num_ops</span><span class="p">(</span><span class="n">src_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">msg_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_op</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">op</span> <span class="o">+</span> <span class="n">num_op</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_snapc</span> <span class="o">=</span> <span class="n">ceph_get_snap_context</span><span class="p">(</span><span class="n">snapc</span><span class="p">);</span>

	<span class="n">head</span><span class="o">-&gt;</span><span class="n">client_inc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* always, for now. */</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">)</span>
		<span class="n">ceph_encode_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">num_ops</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">num_op</span><span class="p">);</span>


	<span class="cm">/* fill in oid */</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">object_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">oid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">oid_len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">oid_len</span><span class="p">;</span>

	<span class="n">src_op</span> <span class="o">=</span> <span class="n">src_ops</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">src_op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd_req_encode_op</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">src_op</span><span class="p">);</span>
		<span class="n">src_op</span><span class="o">++</span><span class="p">;</span>
		<span class="n">op</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snapc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">snap_seq</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">num_snaps</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">num_snaps</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">snapc</span><span class="o">-&gt;</span><span class="n">num_snaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_unaligned_le64</span><span class="p">(</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_off</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">plen</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">page_alignment</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_page_alignment</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">msg_size</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg_size</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_build_request</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * build new request AND message, calculate layout, and adjust file</span>
<span class="cm"> * extent as needed.</span>
<span class="cm"> *</span>
<span class="cm"> * if the file was recently truncated, we include information about its</span>
<span class="cm"> * old and new size so that the object can be updated appropriately.  (we</span>
<span class="cm"> * avoid synchronously deleting truncated objects because it&#39;s slow.)</span>
<span class="cm"> *</span>
<span class="cm"> * if @do_sync, include a &#39;startsync&#39; command so that the osd will flush</span>
<span class="cm"> * data quickly.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="nf">ceph_osdc_new_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">,</span>
					       <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">do_sync</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">truncate_seq</span><span class="p">,</span>
					       <span class="n">u64</span> <span class="n">truncate_size</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">mtime</span><span class="p">,</span>
					       <span class="n">bool</span> <span class="n">use_mempool</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_reply</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">page_align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="n">ops</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_seq</span> <span class="o">=</span> <span class="n">truncate_seq</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extent</span><span class="p">.</span><span class="n">truncate_size</span> <span class="o">=</span> <span class="n">truncate_size</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_STARTSYNC</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ops</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_osdc_alloc_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
					 <span class="n">snapc</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span>
					 <span class="n">use_mempool</span><span class="p">,</span>
					 <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* calculate max write size */</span>
	<span class="n">calc_layout</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">vino</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_file_layout</span> <span class="o">=</span> <span class="o">*</span><span class="n">layout</span><span class="p">;</span>  <span class="cm">/* keep a copy */</span>

	<span class="cm">/* in case it differs from natural (file) alignment that</span>
<span class="cm">	   calc_layout filled in for us */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="n">page_align</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_page_alignment</span> <span class="o">=</span> <span class="n">page_align</span><span class="p">;</span>

	<span class="n">ceph_osdc_build_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span>
				<span class="n">snapc</span><span class="p">,</span>
				<span class="n">mtime</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_new_request</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We keep osd requests in an rbtree, sorted by -&gt;r_tid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__insert_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="nf">__lookup_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
						 <span class="n">u64</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span>
<span class="nf">__lookup_request_ge</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
		    <span class="n">u64</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Resubmit requests pending on the given osd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__kick_osd_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">nreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__kick_osd_requests osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__reset_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">,</span> <span class="n">r_osd_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_unsent</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;requeued %p tid %llu osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span>
		     <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span> <span class="o">|=</span> <span class="n">CEPH_OSD_FLAG_RETRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">nreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">,</span>
				 <span class="n">r_linger_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * reregister request prior to unregistering linger so</span>
<span class="cm">		 * that r_osd is preserved.</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">));</span>
		<span class="n">__register_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_unsent</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">);</span>
		<span class="n">__unregister_linger_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;requeued lingering %p tid %llu osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span>
		     <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kick_osd_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">kickosd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">__kick_osd_requests</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">kickosd</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If the osd connection drops, we need to resubmit all requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osd_reset osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
	<span class="n">osdc</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">kick_osd_requests</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="n">send_queued</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Track open sessions with osds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="nf">create_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">;</span>

	<span class="n">osd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">osd</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osdc</span> <span class="o">=</span> <span class="n">osdc</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">);</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_incarnation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ceph_con_init</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">);</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">osd</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osd_con_ops</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">peer_name</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CEPH_ENTITY_TYPE_OSD</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_keepalive_item</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">osd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="nf">get_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;get_osd %p %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">osd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;get_osd %p FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;put_osd %p %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">),</span>
	     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_ref</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">)</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove an osd from our map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__remove_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_osd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">));</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">);</span>
	<span class="n">ceph_con_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">);</span>
	<span class="n">put_osd</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_all_osds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_old_osds %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osdc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">),</span>
						<span class="k">struct</span> <span class="n">ceph_osd</span><span class="p">,</span> <span class="n">o_node</span><span class="p">);</span>
		<span class="n">__remove_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__move_osd_to_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__move_osd_to_lru %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">));</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osd_lru</span><span class="p">);</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">lru_ttl</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_idle_ttl</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__remove_osd_from_lru</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_osd_from_lru %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">))</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd_lru</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_old_osds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">,</span> <span class="o">*</span><span class="n">nosd</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_old_osds %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osdc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">nosd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osd_lru</span><span class="p">,</span> <span class="n">o_osd_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">lru_ttl</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">__remove_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset osd connect</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__reset_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__reset_osd %p osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osd</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__remove_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">[</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">],</span>
			  <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">peer_addr</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">peer_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">ceph_con_opened</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; osd addr hasn&#39;t changed and connection never opened,&quot;</span>
		     <span class="s">&quot; letting msgr retry&quot;</span><span class="p">);</span>
		<span class="cm">/* touch each r_stamp for handle_timeout()&#39;s benfit */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">,</span> <span class="n">r_osd_item</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ceph_con_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">);</span>
		<span class="n">ceph_con_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">[</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">]);</span>
		<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_incarnation</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__insert_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__insert_osd %p osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">osd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span><span class="p">,</span> <span class="n">o_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">&lt;</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">&gt;</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">o_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">o_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="nf">__lookup_osd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span><span class="p">,</span> <span class="n">o_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&lt;</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">osd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__schedule_osd_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">,</span>
			<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_keepalive_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cancel_osd_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register request, assign tid.  If this is the first request, set up</span>
<span class="cm"> * the timeout event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__register_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">=</span> <span class="o">++</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">last_tid</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__register_request %p tid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">__insert_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">ceph_osdc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">num_requests</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">num_requests</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; first request, scheduling timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__schedule_osd_timeout</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">register_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">__register_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under osdc-&gt;request_mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unregister_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__unregister_request %p tid %lld not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__unregister_request %p tid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">num_requests</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make sure the original request isn&#39;t in flight. */</span>
		<span class="n">ceph_con_revoke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>

		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd_item</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;moving osd to %p lru</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>
			<span class="n">__move_osd_to_lru</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_item</span><span class="p">))</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">num_requests</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; no requests, canceling timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__cancel_osd_timeout</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cancel a previously queued request message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cancel_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_con_revoke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__register_linger_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__register_linger_request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_linger</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_osd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unregister_linger_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__unregister_linger_request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_item</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger_osd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_linger_requests</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;moving osd to %p lru</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>
			<span class="n">__move_osd_to_lru</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd_item</span><span class="p">))</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_osdc_unregister_linger_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__unregister_linger_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_unregister_linger_request</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_osdc_set_request_linger</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;set_request_linger %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * caller is now responsible for calling</span>
<span class="cm">		 * unregister_linger_request</span>
<span class="cm">		 */</span>
		<span class="n">ceph_osdc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_set_request_linger</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Pick an osd (the first &#39;up&#39; osd in the pg), allocate the osd struct</span>
<span class="cm"> * (as needed), and set the request r_osd appropriately.  If there is</span>
<span class="cm"> * no up osd, set r_osd to NULL.  Move the request to the appropriate list</span>
<span class="cm"> * (unsent, homeless) or leave on in-flight lru.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if unchanged, 1 if changed, or negative on error.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should hold map_sem for read and request_mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__map_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_resend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="o">*</span><span class="n">reqhead</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acting</span><span class="p">[</span><span class="n">CEPH_PG_MAX_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">o</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;map_request %p tid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_calc_object_layout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_file_layout</span><span class="p">,</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_notarget</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pgid</span> <span class="o">=</span> <span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">.</span><span class="n">ol_pgid</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pgid</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_calc_pg_acting</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">acting</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">o</span> <span class="o">=</span> <span class="n">acting</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">force_resend</span> <span class="o">&amp;&amp;</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">==</span> <span class="n">o</span> <span class="o">&amp;&amp;</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_incarnation</span> <span class="o">&amp;&amp;</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pg_osds</span> <span class="o">==</span> <span class="n">num</span> <span class="o">&amp;&amp;</span>
	     <span class="n">memcmp</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pg_osds</span><span class="p">,</span> <span class="n">acting</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acting</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">o</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no change */</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;map_request tid %llu pgid %d.%x osd%d (was osd%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pgid</span><span class="p">.</span><span class="n">pool</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pgid</span><span class="p">.</span><span class="n">ps</span><span class="p">),</span> <span class="n">o</span><span class="p">,</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* record full pg acting set */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pg_osds</span><span class="p">,</span> <span class="n">acting</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acting</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pg_osds</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__cancel_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd_item</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">=</span> <span class="n">__lookup_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">&amp;&amp;</span> <span class="n">o</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">=</span> <span class="n">create_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_notarget</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;map_request osd %p is osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">peer_name</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
		<span class="n">__insert_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>

		<span class="n">ceph_con_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">osd_addr</span><span class="p">[</span><span class="n">o</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__remove_osd_from_lru</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_requests</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_unsent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_notarget</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* osd or pg changed */</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * caller should hold map_sem (for read) and request_mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="o">*</span><span class="n">reqhead</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_request %p tid %llu to osd%d flags %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span><span class="p">);</span>

	<span class="n">reqhead</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">osdmap_epoch</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">);</span>
	<span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span><span class="p">);</span>  <span class="cm">/* e.g., RETRY */</span>
	<span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">reassert_version</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reassert_version</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_req_lru_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_lru</span><span class="p">);</span>

	<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span> <span class="cm">/* send consumes a ref */</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_incarnation</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send any requests in the queue (req_unsent).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_unsent</span><span class="p">,</span> <span class="n">r_req_lru_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__send_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timeout callback, called every N seconds when 1 or more osd</span>
<span class="cm"> * requests has been active for more than N seconds.  When this</span>
<span class="cm"> * happens, we ping all OSDs with requests who have timed out to</span>
<span class="cm"> * ensure any communications channel reset is detected.  Reset the</span>
<span class="cm"> * request timeouts another N seconds in the future as we go.</span>
<span class="cm"> * Reschedule the timeout event another N seconds in future (unless</span>
<span class="cm"> * there are no open requests).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_client</span><span class="p">,</span> <span class="n">timeout_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">last_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">keepalive</span> <span class="o">=</span>
		<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_keepalive_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">slow_osds</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>

	<span class="n">ceph_monc_request_next_osdmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset osds that appear to be _really_ unresponsive.  this</span>
<span class="cm">	 * is a failsafe measure.. we really shouldn&#39;t be getting to</span>
<span class="cm">	 * this point if the system is working properly.  the monitors</span>
<span class="cm">	 * should mark the osd as failed and we should find out about</span>
<span class="cm">	 * it from an updated osd map.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_lru</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_lru</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span>
				 <span class="n">r_req_lru_item</span><span class="p">);</span>

		<span class="cm">/* hasn&#39;t been long enough since we sent it? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* hasn&#39;t been long enough since it was acked? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">ack_stamp</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">ack_stamp</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">last_req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span> <span class="o">==</span> <span class="n">last_stamp</span><span class="p">);</span>
		<span class="n">last_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">last_stamp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span><span class="p">;</span>

		<span class="n">osd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="p">);</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot; tid %llu timed out on osd%d, will reset osd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
		<span class="n">__kick_osd_requests</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ping osds that are a bit slow.  this ensures that if there</span>
<span class="cm">	 * is a break in the TCP connection we will notice, and reopen</span>
<span class="cm">	 * a connection with that osd (from the fault callback).</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_osds</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_lru</span><span class="p">,</span> <span class="n">r_req_lru_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_stamp</span> <span class="o">+</span> <span class="n">keepalive</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">osd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; tid %llu is slow, will send keepalive on osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_keepalive_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slow_osds</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_osds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">osd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">slow_osds</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span><span class="p">,</span>
				 <span class="n">o_keepalive_item</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_keepalive_item</span><span class="p">);</span>
		<span class="n">ceph_con_keepalive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__schedule_osd_timeout</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">send_queued</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_osds_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_client</span><span class="p">,</span>
			     <span class="n">osds_timeout_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span>
		<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_idle_ttl</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osds timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">remove_old_osds</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds_timeout_work</span><span class="p">,</span>
			      <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">complete_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_callback</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_callback</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>  <span class="cm">/* fsync waiter */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle osd op reply.  either call the callback if it is specified,</span>
<span class="cm"> * or do the completion to wake up the waiting thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_reply_head</span> <span class="o">*</span><span class="n">rhead</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numops</span><span class="p">,</span> <span class="n">object_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rhead</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">numops</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">num_ops</span><span class="p">);</span>
	<span class="n">object_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">object_len</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rhead</span><span class="p">)</span> <span class="o">+</span> <span class="n">object_len</span> <span class="o">+</span>
	    <span class="n">numops</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_op</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply %p tid %llu result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
	<span class="cm">/* lookup */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">__lookup_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply tid %llu dne</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ceph_osdc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if this connection filled our message, drop our reference now, to</span>
<span class="cm">	 * avoid a (safe but slower) revoke later.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span> <span class="o">==</span> <span class="n">con</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span> <span class="o">==</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; dropping con_filling_msg ref %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply result %d bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span><span class="p">,</span>
		     <span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="cm">/* in case this is a write and we need to replay, */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reassert_version</span> <span class="o">=</span> <span class="n">rhead</span><span class="o">-&gt;</span><span class="n">reassert_version</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_reply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply tid %llu dup ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply tid %llu flags %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">))</span>
		<span class="n">__register_linger_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* either this is a read, or we got the safe response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">__unregister_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_callback</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_callback</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">)</span>
		<span class="n">complete_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;req=%p req-&gt;r_linger=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;corrupt osd_op_reply got %d %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rhead</span><span class="p">));</span>
	<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_changed_osds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span><span class="p">);</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd</span><span class="p">,</span> <span class="n">o_node</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_osd_is_up</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_con</span><span class="p">.</span><span class="n">peer_addr</span><span class="p">,</span>
			   <span class="n">ceph_osd_addr</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span>
					 <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_entity_addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">__reset_osd</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">osd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Requeue requests whose mapping to an OSD has changed.  If requests map to</span>
<span class="cm"> * no osd, request a new map.</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should hold map_sem for read and request_mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kick_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_resend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">nreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;kick_requests %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">force_resend</span> <span class="o">?</span> <span class="s">&quot; (force resend)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__map_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">force_resend</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;%p tid %llu maps to no osd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
			<span class="n">needmap</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* request a newer map */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;%p tid %llu requeued on osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span>
			     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_linger</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span> <span class="o">|=</span> <span class="n">CEPH_OSD_FLAG_RETRY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">nreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_linger</span><span class="p">,</span>
				 <span class="n">r_linger_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;linger req=%p req-&gt;r_osd=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">__map_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">force_resend</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* no change and no osd was specified */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* hrm! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;tid %llu maps to no valid osd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
			<span class="n">needmap</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* request a newer map */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;kicking lingering %p tid %llu osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span><span class="o">-&gt;</span><span class="n">o_osd</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">__unregister_linger_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">__register_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;%d requests for down osds, need new map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">needmap</span><span class="p">);</span>
		<span class="n">ceph_monc_request_next_osdmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Process updated osd map.</span>
<span class="cm"> *</span>
<span class="cm"> * The message contains any number of incremental and full maps, normally</span>
<span class="cm"> * indicating some sort of topology change in the cluster.  Kick requests</span>
<span class="cm"> * off to different OSDs as needed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_osdc_handle_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr_maps</span><span class="p">,</span> <span class="n">maplen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epoch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osdmap</span> <span class="o">*</span><span class="n">newmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">oldmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_map have %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">?</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="cm">/* verify fsid */</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_check_fsid</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>

	<span class="cm">/* incremental maps */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">nr_maps</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; %d inc maps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_maps</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr_maps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">epoch</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">maplen</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">maplen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">&amp;&amp;</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;applying incremental map %u len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">epoch</span><span class="p">,</span> <span class="n">maplen</span><span class="p">);</span>
			<span class="n">newmap</span> <span class="o">=</span> <span class="n">osdmap_apply_incremental</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
							  <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span>
							  <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">newmap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">newmap</span> <span class="o">!=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ceph_osdmap_destroy</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">);</span>
				<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">=</span> <span class="n">newmap</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kick_requests</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reset_changed_osds</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ignoring incremental map %u len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">epoch</span><span class="p">,</span> <span class="n">maplen</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">nr_maps</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* full maps */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">nr_maps</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; %d full maps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_maps</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr_maps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">epoch</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">maplen</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_maps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;skipping non-latest full map %u len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">epoch</span><span class="p">,</span> <span class="n">maplen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">&amp;&amp;</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;skipping full map %u len %d, &quot;</span>
			     <span class="s">&quot;older than our %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
			     <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">skipped_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;taking full map %u len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">maplen</span><span class="p">);</span>
			<span class="n">newmap</span> <span class="o">=</span> <span class="n">osdmap_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">maplen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">newmap</span><span class="p">);</span>
			<span class="n">oldmap</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">;</span>
			<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">=</span> <span class="n">newmap</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oldmap</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">oldmap</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">newmap</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">)</span>
					<span class="n">skipped_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ceph_osdmap_destroy</span><span class="p">(</span><span class="n">oldmap</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kick_requests</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">skipped_map</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">maplen</span><span class="p">;</span>
		<span class="n">nr_maps</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">downgrade_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">ceph_monc_got_osdmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">,</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * subscribe to subsequent osdmap updates if full to ensure</span>
<span class="cm">	 * we find out when we are no longer full and stop returning</span>
<span class="cm">	 * ENOSPC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_osdmap_flag</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">CEPH_OSDMAP_FULL</span><span class="p">))</span>
		<span class="n">ceph_monc_request_next_osdmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>

	<span class="n">send_queued</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">auth_wq</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;osdc handle_map corrupt msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * watch/notify callback event infrastructure</span>
<span class="cm"> *</span>
<span class="cm"> * These callbacks are used both for watch and notify operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__release_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_event</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__release_event %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_osdc_put_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">__release_event</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_put_event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__insert_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_event</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_tree</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="nf">__find_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
					        <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_event</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__remove_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_event removed %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_tree</span><span class="p">);</span>
		<span class="n">ceph_osdc_put_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__remove_event didn&#39;t remove %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_osdc_create_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">event_cb</span><span class="p">)(</span><span class="n">u64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			   <span class="kt">int</span> <span class="n">one_shot</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">**</span><span class="n">pevent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;create_event %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">=</span> <span class="n">event_cb</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">one_shot</span> <span class="o">=</span> <span class="n">one_shot</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">osdc</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">osd_node</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>   <span class="cm">/* one ref for us */</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>    <span class="cm">/* one ref for the caller */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">++</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_count</span><span class="p">;</span>
	<span class="n">__insert_event</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_create_event</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_osdc_cancel_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;cancel_event %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">__remove_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span> <span class="cm">/* caller&#39;s */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_cancel_event</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event_work</span> <span class="o">*</span><span class="n">event_work</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_osd_event_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">event_work</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">event_work</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">notify_id</span> <span class="o">=</span> <span class="n">event_work</span><span class="o">-&gt;</span><span class="n">notify_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">event_work</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_event_work completing %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">notify_id</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_event_work completed %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">event_work</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Process osd watch notifications</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">handle_watch_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">proto_ver</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">notify_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event_work</span> <span class="o">*</span><span class="n">event_work</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="n">ceph_decode_8_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">proto_ver</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_8_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_64_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_64_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_64_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">notify_id</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">__find_event</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">one_shot</span><span class="p">)</span>
			<span class="n">__remove_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_watch_notify cookie %lld ver %lld event %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">cookie</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event_work</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_work</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event_work</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ERROR: could not allocate event_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">do_event_work</span><span class="p">);</span>
		<span class="n">event_work</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">event_work</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="p">;</span>
		<span class="n">event_work</span><span class="o">-&gt;</span><span class="n">notify_id</span> <span class="o">=</span> <span class="n">notify_id</span><span class="p">;</span>
		<span class="n">event_work</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_work</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;WARNING: failed to queue notify event work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">done_err:</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;osdc handle_watch_notify corrupt msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_osdc_wait_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_event %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span>
							<span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_event %p returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_wait_event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Register request, send initial attempt.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_osdc_start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">nofail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">trail</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_trail</span><span class="p">;</span>

	<span class="n">register_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * a racing kick_requests() may have sent the message for us</span>
<span class="cm">	 * while we dropped request_mutex above, so only send now if</span>
<span class="cm">	 * the request still han&#39;t been touched yet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__map_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nofail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;osdc_start_request failed map, &quot;</span>
				     <span class="s">&quot; will retry %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_osd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_request %p no up osds in pg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">ceph_monc_request_next_osdmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__send_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_start_request</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * wait for a request to complete</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_osdc_wait_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="n">__cancel_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">__unregister_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="n">complete_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_request tid %llu canceled/timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_request tid %llu result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_wait_request</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * sync - wait for all in-flight requests to flush.  avoid starvation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_osdc_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last_tid</span><span class="p">,</span> <span class="n">next_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">last_tid</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">last_tid</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">__lookup_request_ge</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">next_tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&gt;</span> <span class="n">last_tid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">next_tid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ceph_osdc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;sync waiting on tid %llu (last is %llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">last_tid</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
		<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;sync done (thru tid %llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_tid</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_sync</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * init, shutdown</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_osdc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_sem</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">map_waiters</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">last_requested_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">last_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osd_lru</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">requests</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_lru</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_unsent</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_notarget</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_linger</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">num_requests</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">,</span> <span class="n">handle_timeout</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds_timeout_work</span><span class="p">,</span> <span class="n">handle_osds_timeout</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_tree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds_timeout_work</span><span class="p">,</span>
	   <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">osd_idle_ttl</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span> <span class="o">=</span> <span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_msgpool_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op</span><span class="p">,</span> <span class="n">OSD_OP_FRONT_LEN</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				<span class="s">&quot;osd_op&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mempool</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_msgpool_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op_reply</span><span class="p">,</span>
				<span class="n">OSD_OPREPLY_FRONT_LEN</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				<span class="s">&quot;osd_op_reply&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_msgpool</span><span class="p">;</span>

	<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ceph-watch-notify&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span><span class="p">);</span>
		<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_msgpool</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_msgpool:</span>
	<span class="n">ceph_msgpool_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op</span><span class="p">);</span>
<span class="nl">out_mempool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_osdc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">notify_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osds_timeout_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_osdmap_destroy</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">);</span>
		<span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remove_all_osds</span><span class="p">(</span><span class="n">osdc</span><span class="p">);</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">req_mempool</span><span class="p">);</span>
	<span class="n">ceph_msgpool_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op</span><span class="p">);</span>
	<span class="n">ceph_msgpool_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">msgpool_op_reply</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_stop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Read some contiguous pages.  If we cross a stripe boundary, shorten</span>
<span class="cm"> * *plen.  Return number of bytes read, or error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_osdc_readpages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">truncate_seq</span><span class="p">,</span> <span class="n">u64</span> <span class="n">truncate_size</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readpages on ino %llx.%llx on %llu~%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span>
	     <span class="n">vino</span><span class="p">.</span><span class="n">snap</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_osdc_new_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">vino</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span>
				    <span class="n">CEPH_OSD_OP_READ</span><span class="p">,</span> <span class="n">CEPH_OSD_FLAG_READ</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">truncate_seq</span><span class="p">,</span> <span class="n">truncate_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="nb">false</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">page_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* it may be a short read due to an object boundary */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readpages  final extent is %llu~%llu (%d pages align %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">,</span> <span class="n">page_align</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ceph_osdc_start_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ceph_osdc_wait_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readpages result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_readpages</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * do a synchronous write on N pages</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_osdc_writepages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">truncate_seq</span><span class="p">,</span> <span class="n">u64</span> <span class="n">truncate_size</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">mtime</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_pages</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_sync</span><span class="p">,</span> <span class="n">bool</span> <span class="n">nofail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_align</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">vino</span><span class="p">.</span><span class="n">snap</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_osdc_new_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">vino</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span>
				    <span class="n">CEPH_OSD_OP_WRITE</span><span class="p">,</span>
				    <span class="n">flags</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span> <span class="o">|</span>
					    <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">,</span>
				    <span class="n">snapc</span><span class="p">,</span> <span class="n">do_sync</span><span class="p">,</span>
				    <span class="n">truncate_seq</span><span class="p">,</span> <span class="n">truncate_size</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span>
				    <span class="n">nofail</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">page_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* it may be a short write due to an object boundary */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;writepages %llu~%llu (%d pages)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ceph_osdc_start_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">nofail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ceph_osdc_wait_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;writepages result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_osdc_writepages</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * handle incoming message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">osdc</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_OSD_MAP</span>:
		<span class="n">ceph_osdc_handle_map</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_OSD_OPREPLY</span>:
		<span class="n">handle_reply</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_WATCH_NOTIFY</span>:
		<span class="n">handle_watch_notify</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;received unknown message type %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		       <span class="n">ceph_msg_type_name</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lookup and return message for incoming reply.  set up reply message</span>
<span class="cm"> * pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">get_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_msg_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="o">*</span><span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">front</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">front_len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">tid</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">__lookup_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;get_reply unknown tid %llu from osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;get_reply revoking msg %p from old con %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">);</span>
		<span class="n">ceph_con_revoke_message</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">front</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;get_reply front %d &gt; preallocated %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">front</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_OSD_OPREPLY</span><span class="p">,</span> <span class="n">front</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">want</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_page_alignment</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span> <span class="o">&lt;</span> <span class="n">want</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;tid %lld reply has %d bytes %d pages, we&quot;</span>
				   <span class="s">&quot; had only %d pages ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
				   <span class="n">want</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">);</span>
			<span class="o">*</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
			<span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">page_alignment</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_page_alignment</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_bio</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_con_filling_msg</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;get_reply tid %lld %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">request_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">m</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">alloc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_msg_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="o">*</span><span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">front</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">front_len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_OSD_MAP</span>:
	<span class="k">case</span> <span class="n">CEPH_MSG_WATCH_NOTIFY</span>:
		<span class="k">return</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">front</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_OSD_OPREPLY</span>:
		<span class="k">return</span> <span class="n">get_reply</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;alloc_msg unexpected msg type %d from osd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">o_osd</span><span class="p">);</span>
		<span class="o">*</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrappers to refcount containing ceph_osd struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="nf">get_osd_con</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_osd</span><span class="p">(</span><span class="n">osd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_osd_con</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">osd</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">put_osd</span><span class="p">(</span><span class="n">osd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * authentication</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Note: returned pointer is the address of a structure that&#39;s</span>
<span class="cm"> * managed separately.  Caller must *not* attempt to free it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="nf">get_authorizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">o_auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_new</span> <span class="o">&amp;&amp;</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">)</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span><span class="p">);</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">create_authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">create_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">CEPH_ENTITY_TYPE_OSD</span><span class="p">,</span>
							<span class="n">auth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">proto</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">auth</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_authorizer_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX If ac-&gt;ops or ac-&gt;ops-&gt;verify_authorizer_reply is null,</span>
<span class="cm">	 * XXX which do we do:  succeed or fail?</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">verify_authorizer_reply</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">o_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invalidate_authorizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">o_osdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">)</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">CEPH_ENTITY_TYPE_OSD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ceph_monc_validate_auth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_connection_operations</span> <span class="n">osd_con_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">get_osd_con</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">put_osd_con</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">dispatch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_authorizer</span> <span class="o">=</span> <span class="n">get_authorizer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_authorizer_reply</span> <span class="o">=</span> <span class="n">verify_authorizer_reply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidate_authorizer</span> <span class="o">=</span> <span class="n">invalidate_authorizer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_msg</span> <span class="o">=</span> <span class="n">alloc_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fault</span> <span class="o">=</span> <span class="n">osd_reset</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
