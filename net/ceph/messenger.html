<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ceph › messenger.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>messenger.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/crc32c.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/dns_resolver.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="cp">#include &lt;linux/ceph/libceph.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/messenger.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/pagelist.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Ceph uses the messenger to exchange ceph_msg messages with other</span>
<span class="cm"> * hosts in the system.  The messenger provides ordered and reliable</span>
<span class="cm"> * delivery.  We tolerate TCP disconnects by reconnecting (with</span>
<span class="cm"> * exponential backoff) in the case of a fault (disconnection, bad</span>
<span class="cm"> * crc, protocol error).  Acks allow sent messages to be discarded by</span>
<span class="cm"> * the sender.</span>
<span class="cm"> */</span>

<span class="cm">/* static tag bytes (protocol control messages) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">tag_msg</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_MSG</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">tag_ack</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_ACK</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">tag_keepalive</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_KEEPALIVE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LOCKDEP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">socket_class</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * When skipping (ignoring) a block of input we read it into a &quot;skip</span>
<span class="cm"> * buffer,&quot; which is this many bytes in size.</span>
<span class="cm"> */</span>
<span class="cp">#define SKIP_BUF_SIZE	1024</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">queue_con</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">con_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ceph_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Nicely render a sockaddr as a string.  An array of formatted</span>
<span class="cm"> * strings is used, to approximate reentrancy.</span>
<span class="cm"> */</span>
<span class="cp">#define ADDR_STR_COUNT_LOG	5	</span><span class="cm">/* log2(# address strings in array) */</span><span class="cp"></span>
<span class="cp">#define ADDR_STR_COUNT		(1 &lt;&lt; ADDR_STR_COUNT_LOG)</span>
<span class="cp">#define ADDR_STR_COUNT_MASK	(ADDR_STR_COUNT - 1)</span>
<span class="cp">#define MAX_ADDR_STR_LEN	64	</span><span class="cm">/* 54 is enough */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">addr_str</span><span class="p">[</span><span class="n">ADDR_STR_COUNT</span><span class="p">][</span><span class="n">MAX_ADDR_STR_LEN</span><span class="p">];</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">addr_str_seq</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">zero_page</span><span class="p">;</span>		<span class="cm">/* used in certain error cases */</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ceph_pr_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">in4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">ss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">in6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">ss</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_str_seq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADDR_STR_COUNT_MASK</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">addr_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MAX_ADDR_STR_LEN</span><span class="p">,</span> <span class="s">&quot;%pI4:%hu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">,</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">in4</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MAX_ADDR_STR_LEN</span><span class="p">,</span> <span class="s">&quot;[%pI6c]:%hu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">in6</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MAX_ADDR_STR_LEN</span><span class="p">,</span> <span class="s">&quot;(unknown sockaddr family %hu)&quot;</span><span class="p">,</span>
			 <span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_pr_addr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">encode_my_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">my_enc_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">my_enc_addr</span><span class="p">));</span>
	<span class="n">ceph_encode_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">my_enc_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * work queue for all reading and writing to/from the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">ceph_msgr_wq</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">_ceph_msgr_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">);</span>
		<span class="n">ceph_msgr_wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">zero_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">zero_page</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">zero_page</span><span class="p">);</span>
	<span class="n">zero_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_msgr_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">zero_page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">zero_page</span> <span class="o">=</span> <span class="n">ZERO_PAGE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">page_cache_get</span><span class="p">(</span><span class="n">zero_page</span><span class="p">);</span>

	<span class="n">ceph_msgr_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;ceph-msgr&quot;</span><span class="p">,</span> <span class="n">WQ_NON_REENTRANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;msgr_init failed to create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">_ceph_msgr_exit</span><span class="p">();</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msgr_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_msgr_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ceph_msgr_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">_ceph_msgr_exit</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msgr_exit</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_msgr_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msgr_flush</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * socket callback functions</span>
<span class="cm"> */</span>

<span class="cm">/* data available on socket, or listen socket received a connect */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count_unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_data_ready on %p state = %lu, queueing work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* socket has buffer space for writing */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>

	<span class="cm">/* only queue to workqueue if there is data we want to write,</span>
<span class="cm">	 * and there is sufficient space in the socket buffer to accept</span>
<span class="cm">	 * more data.  clear SOCK_NOSPACE so that ceph_write_space()</span>
<span class="cm">	 * doesn&#39;t get called again until try_write() fills the socket</span>
<span class="cm">	 * buffer. See net/ipv4/tcp_input.c:tcp_check_space()</span>
<span class="cm">	 * and net/core/stream.c:sk_stream_write_space().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sk_stream_min_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_write_space %p queueing write work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_write_space %p nothing to write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* socket&#39;s state has changed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_state_change %p state = %lu sk_state = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_CLOSE</span>:
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_state_change TCP_CLOSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCP_CLOSE_WAIT</span>:
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_state_change TCP_CLOSE_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">SOCK_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;connection failed&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;socket closed&quot;</span><span class="p">;</span>
			<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_ESTABLISHED</span>:
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_state_change TCP_ESTABLISHED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* Everything else is uninteresting */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set up socket callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_sock_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">=</span> <span class="n">con</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span> <span class="o">=</span> <span class="n">ceph_data_ready</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span> <span class="o">=</span> <span class="n">ceph_write_space</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span> <span class="o">=</span> <span class="n">ceph_state_change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * socket helpers</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * initiate connection to a remote socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_tcp_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sock_create_kern</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">.</span><span class="n">ss_family</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span>
			       <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span> <span class="o">=</span> <span class="n">GFP_NOFS</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LOCKDEP</span>
	<span class="n">lockdep_set_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket_class</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">set_sock_callbacks</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;connect %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">paddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">paddr</span><span class="p">),</span>
				 <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;connect %s EINPROGRESS sk_state = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
		     <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;connect %s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;connect error&quot;</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_tcp_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kernel_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write something.  @more is true if caller will be sending more data</span>
<span class="cm"> * shortly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_tcp_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="n">kvlen</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_MORE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>  <span class="cm">/* superfluous, but what the hell */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kernel_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">kvlen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_tcp_sendpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span> <span class="o">|</span> <span class="p">(</span><span class="n">more</span> <span class="o">?</span> <span class="n">MSG_MORE</span> <span class="o">:</span> <span class="n">MSG_EOR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kernel_sendpage</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Shutdown/close the socket for the given connection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_close_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_close_socket on %p sock %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">SHUT_RDWR</span><span class="p">);</span>
	<span class="n">sock_release</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset a connection.  Discard all incoming and outgoing messages</span>
<span class="cm"> * and clear *_seq state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_msg_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
	<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_msg_remove_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span>
							<span class="n">list_head</span><span class="p">);</span>
		<span class="n">ceph_msg_remove</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset connection, out_queue, msg_ and connect_seq */</span>
	<span class="cm">/* discard existing out_queue and msg_seq */</span>
	<span class="n">ceph_msg_remove_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">);</span>
	<span class="n">ceph_msg_remove_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mark a peer down.  drop any open connections.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_close %p peer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
	     <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>  <span class="cm">/* in case there&#39;s queued work */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>  <span class="cm">/* avoid connect_seq bump */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOSSYTX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>  <span class="cm">/* so we retry next connect */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">KEEPALIVE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">reset_connection</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_global_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_con_close</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reopen a closed connection, with a new peer address.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_open %p %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">in_addr</span><span class="p">));</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">OPENING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* reset backoff memory */</span>
	<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_con_open</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * return true if this connection ever successfully opened</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">ceph_con_opened</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generic get/put</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="nf">ceph_con_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nref</span> <span class="o">=</span> <span class="n">__atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_get %p nref = %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">nref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nref</span> <span class="o">?</span> <span class="n">con</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_con_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nref</span> <span class="o">=</span> <span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nref</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_put %p nref = %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">nref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize a new connection.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_init %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">con</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span> <span class="o">=</span> <span class="n">msgr</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">con_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_con_init</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * We maintain a global counter to order connection attempts.  Get</span>
<span class="cm"> * a unique seq greater than @gt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_global_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq</span> <span class="o">&lt;</span> <span class="n">gt</span><span class="p">)</span>
		<span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq</span> <span class="o">=</span> <span class="n">gt</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">++</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_con_out_kvec_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">));</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="o">++</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare footer for currently outgoing message, and finish things</span>
<span class="cm"> * off.  Assumes out_kvec* are already valid.. we just add on to the end.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_write_message_footer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_message_footer %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_is_msg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="o">++</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">more_to_follow</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare headers for the next outgoing message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_write_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_is_msg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Sneak an ack in there first?  If we can get it into the same</span>
<span class="cm">	 * TCP packet that&#39;s a good thing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">&gt;</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="p">;</span>
		<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tag_ack</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tag_ack</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span><span class="p">);</span>
		<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

	<span class="cm">/* put message on sent list */</span>
	<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * only assign outgoing seq # if we haven&#39;t sent this message</span>
<span class="cm">	 * yet.  if it is requeued, resend with it&#39;s original seq.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">needs_out_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">++</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_seq</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">needs_out_seq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">else</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_message %p seq %lld type %d len %d+%d+%d %d pgs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">m</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_seq</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">middle_len</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
	     <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="cm">/* tag + hdr + front + middle */</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tag_msg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tag_msg</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span>
		<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span><span class="p">,</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">);</span>

	<span class="cm">/* fill in crc (except data pages), footer */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg_header</span><span class="p">,</span> <span class="n">crc</span><span class="p">));</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">crc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CEPH_MSG_FOOTER_COMPLETE</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_message front_crc %u data_crc %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span><span class="p">));</span>

	<span class="cm">/* is there a data payload? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize page iterator */</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">page_alignment</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">did_page_crc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* data + footer will follow */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no, queue up footer too and be done */</span>
		<span class="n">prepare_write_message_footer</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare an ack.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_write_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_ack %p %llu -&gt; %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="p">;</span>

	<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>

	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tag_ack</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tag_ack</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_temp_ack</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* more will follow.. eventually.. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare to write keepalive byte.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_write_keepalive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_keepalive %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tag_keepalive</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tag_keepalive</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Connection negotiation.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="nf">get_connect_authorizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
						<span class="kt">int</span> <span class="o">*</span><span class="n">auth_proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">authorizer_protocol</span> <span class="o">=</span> <span class="n">CEPH_AUTH_UNKNOWN</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">authorizer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Can&#39;t hold the mutex while getting authorizer */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_authorizer</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">auth_proto</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">auth</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">auth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">OPENING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_reply_buf</span> <span class="o">=</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_reply_buf</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_reply_buf_len</span> <span class="o">=</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_reply_buf_len</span><span class="p">;</span>


	<span class="k">return</span> <span class="n">auth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We connected to a peer and are saying hello.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_write_banner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CEPH_BANNER</span><span class="p">),</span> <span class="n">CEPH_BANNER</span><span class="p">);</span>
	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">my_enc_addr</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">my_enc_addr</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_write_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">global_seq</span> <span class="o">=</span> <span class="n">get_global_seq</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auth_proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_ENTITY_TYPE_MON</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">CEPH_MONC_PROTOCOL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_ENTITY_TYPE_OSD</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">CEPH_OSDC_PROTOCOL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_ENTITY_TYPE_MDS</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">CEPH_MDSC_PROTOCOL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_write_connect %p cseq=%d gseq=%d proto=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span><span class="p">,</span> <span class="n">global_seq</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">supported_features</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">host_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CEPH_ENTITY_TYPE_CLIENT</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">connect_seq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">global_seq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">global_seq</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">auth_proto</span> <span class="o">=</span> <span class="n">CEPH_AUTH_UNKNOWN</span><span class="p">;</span>
	<span class="n">auth</span> <span class="o">=</span> <span class="n">get_connect_authorizer</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auth_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">auth</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">authorizer_protocol</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">auth_proto</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">authorizer_len</span> <span class="o">=</span> <span class="n">auth</span> <span class="o">?</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_buf_len</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth</span> <span class="o">&amp;&amp;</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_buf_len</span><span class="p">)</span>
		<span class="n">ceph_con_out_kvec_add</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_buf_len</span><span class="p">,</span>
					<span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer_buf</span><span class="p">);</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write as much of pending kvecs to the socket as we can.</span>
<span class="cm"> *  1 -&gt; done</span>
<span class="cm"> *  0 -&gt; socket full, but more to do</span>
<span class="cm"> * &lt;0 -&gt; error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_partial_kvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;write_partial_kvec %p %d left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_sendmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="p">,</span>
				       <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span><span class="p">,</span>
				       <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_more</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>            <span class="cm">/* done */</span>

		<span class="cm">/* account for full iov entries consumed */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">-=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="o">++</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* and for a partially-consumed entry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_cur</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_is_msg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;write_partial_kvec %p %d left in %d kvecs ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>  <span class="cm">/* done! */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_bio_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">iter</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="o">*</span><span class="n">seg</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iter_bio_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">bio_iter</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bio_iter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">seg</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="o">*</span><span class="n">bio_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">seg</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">seg</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">bio_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">)</span>
		<span class="n">init_bio_iter</span><span class="p">((</span><span class="o">*</span><span class="n">bio_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">,</span> <span class="n">bio_iter</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Write as much message data payload as we can.  If we finish, queue</span>
<span class="cm"> * up the footer.</span>
<span class="cm"> *  1 -&gt; done, footer is now queued in out_kvec[].</span>
<span class="cm"> *  0 -&gt; socket full, but more to do</span>
<span class="cm"> * &lt;0 -&gt; error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_partial_msg_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_datacrc</span> <span class="o">=</span> <span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">nocrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_max_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_trail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">trail_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">trail</span> <span class="o">?</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">trail</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;write_partial_msg_pages %p msg %p page %d/%d offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">)</span>
		<span class="n">init_bio_iter</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_seg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_write</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bio_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">total_max_write</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">trail_len</span> <span class="o">-</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if we are calculating the data crc (the default), we need</span>
<span class="cm">		 * to map the page.  if our pages[] has been revoked, use the</span>
<span class="cm">		 * zero page.</span>
<span class="cm">		 */</span>

		<span class="cm">/* have we reached the trail part of the data? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">&gt;=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">trail_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">in_trail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">total_max_write</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span><span class="p">;</span>

			<span class="n">page</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">trail</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
			<span class="n">max_write</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>

			<span class="n">bv</span> <span class="o">=</span> <span class="n">bio_iovec_idx</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_seg</span><span class="p">);</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>
			<span class="n">bio_offset</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
			<span class="n">max_write</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">zero_page</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">max_write</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">,</span>
			    <span class="n">total_max_write</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_datacrc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">did_page_crc</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">tmpcrc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span><span class="p">);</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>

			<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">+</span> <span class="n">bio_offset</span><span class="p">;</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="n">tmpcrc</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">did_page_crc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_sendpage</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
				      <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">+</span> <span class="n">bio_offset</span><span class="p">,</span>
				      <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_datacrc</span><span class="p">)</span>
			<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="o">++</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_pos</span><span class="p">.</span><span class="n">did_page_crc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_trail</span><span class="p">)</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">trail</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">)</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span>
				<span class="n">iter_bio_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">bio_seg</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;write_partial_msg_pages %p msg %p done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="cm">/* prepare and queue up footer, too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_datacrc</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_MSG_FOOTER_NOCRC</span><span class="p">;</span>
	<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">prepare_write_message_footer</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write some zeros</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_partial_skip</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_skip</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_sendpage</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">zero_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_skip</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare to read connection handshake, or an ack.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_read_banner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_read_banner %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_read_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_read_connect %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_read_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_read_ack %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_read_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_read_tag %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare to read a message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_read_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_read_message %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_front_crc</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_middle_crc</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">end</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">have</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">object</span> <span class="o">+</span> <span class="n">have</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read all or part of the connect-side handshake on a new connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_banner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;read_partial_banner %p at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">);</span>

	<span class="cm">/* peer&#39;s banner */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CEPH_BANNER</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_banner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr_for_me</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr_for_me</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;read_partial_connect %p at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">authorizer_len</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_reply_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;read_partial_connect %p tag %d, con_seq = %u, g_seq = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">con</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">tag</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">global_seq</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Verify the hello banner looks okay.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_hello</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_banner</span><span class="p">,</span> <span class="n">CEPH_BANNER</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CEPH_BANNER</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;connect to %s got bad banner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;protocol error, bad banner&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">addr_is_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span>
		     <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">addr_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">addr_set_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">ss</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unlike other *_pton function semantics, zero indicates success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_pton</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">delim</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ipend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">in4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">ss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">in6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">ss</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in4_pton</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">in4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">ipend</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in6_pton</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">in6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">ipend</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ss</span><span class="o">-&gt;</span><span class="n">ss_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Extract hostname string and resolve using kernel DNS facility.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_CEPH_LIB_USE_DNS_RESOLVER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_dns_resolve_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">namelen</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="kt">char</span> <span class="n">delim</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ipend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">delim_p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">colon_p</span><span class="p">,</span> <span class="o">*</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ip_len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The end of the hostname occurs immediately preceding the delimiter or</span>
<span class="cm">	 * the port marker (&#39;:&#39;) where the delimiter takes precedence.</span>
<span class="cm">	 */</span>
	<span class="n">delim_p</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
	<span class="n">colon_p</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delim_p</span> <span class="o">&amp;&amp;</span> <span class="n">colon_p</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">delim_p</span> <span class="o">&lt;</span> <span class="n">colon_p</span> <span class="o">?</span> <span class="n">delim_p</span> <span class="o">:</span> <span class="n">colon_p</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delim_p</span> <span class="o">&amp;&amp;</span> <span class="n">colon_p</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">colon_p</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">delim_p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span> <span class="cm">/* case: hostname:/ */</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* do dns_resolve upcall */</span>
	<span class="n">ip_len</span> <span class="o">=</span> <span class="n">dns_query</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_pton</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">ip_len</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ipend</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;resolve &#39;%.*s&#39; (ret=%d): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span> <span class="o">-</span> <span class="n">name</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="n">ss</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_dns_resolve_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">namelen</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="kt">char</span> <span class="n">delim</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ipend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Parse a server name (IP or hostname). If a valid IP address is not found</span>
<span class="cm"> * then try to extract a hostname to resolve using userspace DNS upcall.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_parse_server_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">namelen</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="kt">char</span> <span class="n">delim</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ipend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_pton</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">ipend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_dns_resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">ipend</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse an ip[:port] list into an addr array.  Use the default</span>
<span class="cm"> * monitor port if a port isn&#39;t specified.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_parse_ips</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">max_count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;parse_ips on &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="o">-</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ipend</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">delim</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delim</span> <span class="o">=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_parse_server_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipend</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">ipend</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delim</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;missing matching &#39;]&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* port? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">||</span> <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">CEPH_MON_PORT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr_set_port</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;parse_ips got %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="n">ss</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;parse_ips bad ip &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span> <span class="o">-</span> <span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_parse_ips</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_banner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_banner on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verify_hello</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ceph_decode_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">);</span>
	<span class="n">ceph_decode_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr_for_me</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the other end is who we wanted.  note that the other</span>
<span class="cm">	 * end may not yet know their ip address, so if it&#39;s 0.0.0.0, give</span>
<span class="cm">	 * them the benefit of the doubt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">addr_is_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">.</span><span class="n">nonce</span> <span class="o">==</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">nonce</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;wrong peer, want %s/%d, got %s/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">nonce</span><span class="p">),</span>
			   <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">actual_peer_addr</span><span class="p">.</span><span class="n">nonce</span><span class="p">));</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;wrong peer at address&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * did we learn our address?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_is_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">addr_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr_for_me</span><span class="p">.</span><span class="n">in_addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr_for_me</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>
		<span class="n">addr_set_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">encode_my_addr</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_banner learned my addr is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">NEGOTIATING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">prepare_read_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fail_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reset_connection</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>  <span class="cm">/* in case there&#39;s queued work */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bad_proto</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bad_proto</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sup_feat</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">supported_features</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">req_feat</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">required_features</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">server_feat</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">features</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect on %p tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_FEATURES</span>:
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s%lld %s feature set mismatch,&quot;</span>
		       <span class="s">&quot; my %llx &lt; server&#39;s %llx, missing %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
		       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
		       <span class="n">sup_feat</span><span class="p">,</span> <span class="n">server_feat</span><span class="p">,</span> <span class="n">server_feat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sup_feat</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;missing required protocol features&quot;</span><span class="p">;</span>
		<span class="n">fail_protocol</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_BADPROTOVER</span>:
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s%lld %s protocol version mismatch,&quot;</span>
		       <span class="s">&quot; my %d != server&#39;s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
		       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">protocol_version</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">protocol_version</span><span class="p">));</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;protocol version mismatch&quot;</span><span class="p">;</span>
		<span class="n">fail_protocol</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_BADAUTHORIZER</span>:
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect %p got BADAUTHORIZER attempt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
		     <span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;connect authorization failure&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_write_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">prepare_read_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_RESETSESSION</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If we connected with a large connect_seq but the peer</span>
<span class="cm">		 * has no record of a session with us (no connection, or</span>
<span class="cm">		 * connect_seq == 0), they will send RESETSESION to indicate</span>
<span class="cm">		 * that they must have reset their session, and may have</span>
<span class="cm">		 * dropped messages.</span>
<span class="cm">		 */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect got RESET peer seq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_connect</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">));</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s%lld %s connection reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
		       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>
		<span class="n">reset_connection</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_write_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">prepare_read_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>

		<span class="cm">/* Tell ceph about it. */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;reset on %s%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_reset</span><span class="p">)</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">peer_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">OPENING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_RETRY_SESSION</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If we sent a smaller connect_seq than the peer has, try</span>
<span class="cm">		 * again with a larger value.</span>
<span class="cm">		 */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect got RETRY my seq = %u, peer_seq = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_connect</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">),</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_connect</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">));</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_connect</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">);</span>
		<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_write_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">prepare_read_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_RETRY_GLOBAL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If we sent a smaller global_seq than the peer has, try</span>
<span class="cm">		 * again with a larger value.</span>
<span class="cm">		 */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect got RETRY_GLOBAL my %u peer_gseq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_global_seq</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_connect</span><span class="p">.</span><span class="n">global_seq</span><span class="p">));</span>
		<span class="n">get_global_seq</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_connect</span><span class="p">.</span><span class="n">global_seq</span><span class="p">));</span>
		<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_write_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">prepare_read_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">req_feat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">server_feat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s%lld %s protocol feature mismatch,&quot;</span>
			       <span class="s">&quot; my required %llx &gt; server&#39;s %llx, need %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
			       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
			       <span class="n">req_feat</span><span class="p">,</span> <span class="n">server_feat</span><span class="p">,</span> <span class="n">req_feat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">server_feat</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;missing required protocol features&quot;</span><span class="p">;</span>
			<span class="n">fail_protocol</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_global_seq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">global_seq</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_features</span> <span class="o">=</span> <span class="n">server_feat</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;process_connect got READY gseq %d cseq %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_global_seq</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">),</span>
		     <span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span> <span class="o">!=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">connect_seq</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_reply</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_MSG_CONNECT_LOSSY</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOSSYTX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="n">prepare_read_tag</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_WAIT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If there is a connection race (we are opening</span>
<span class="cm">		 * connections to each other), one of us may just have</span>
<span class="cm">		 * to WAIT.  This shouldn&#39;t happen if we are the</span>
<span class="cm">		 * client.</span>
<span class="cm">		 */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;process_connect got WAIT as client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;protocol error, got WAIT as client&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;connect protocol error, will retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;protocol error, garbage tag during connect&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * read (part of) an ack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_temp_ack</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_temp_ack</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * We can finally discard anything that&#39;s been acked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_temp_ack</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span>
				     <span class="n">list_head</span><span class="p">);</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&gt;</span> <span class="n">ack</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got ack for seq %llu type %d at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">),</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">ack_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ceph_msg_remove</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">prepare_read_tag</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>




<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_message_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sec_len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">crc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">section</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="n">sec_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">sec_len</span> <span class="o">-</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">+</span>
				       <span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">==</span> <span class="n">sec_len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">ceph_alloc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ceph_msg_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">skip</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_message_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_datacrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">data_len</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">));</span>
	<span class="cm">/* (page) data */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="p">]);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">,</span>
			       <span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">do_datacrc</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span> <span class="o">=</span>
			<span class="n">crc32c</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span><span class="p">,</span>
				  <span class="n">p</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">==</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_message_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">bio_iter</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bio_seg</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_datacrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span> <span class="o">=</span> <span class="n">bio_iovec_idx</span><span class="p">(</span><span class="o">*</span><span class="n">bio_iter</span><span class="p">,</span> <span class="o">*</span><span class="n">bio_seg</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bv</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bv</span><span class="p">);</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">data_len</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">-</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">));</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">,</span>
			       <span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">do_datacrc</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span> <span class="o">=</span>
			<span class="n">crc32c</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span><span class="p">,</span>
				  <span class="n">p</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">==</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iter_bio_next</span><span class="p">(</span><span class="n">bio_iter</span><span class="p">,</span> <span class="n">bio_seg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * read (part of) a message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_partial_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_len</span><span class="p">,</span> <span class="n">middle_len</span><span class="p">,</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_datacrc</span> <span class="o">=</span> <span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">nocrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;read_partial_message con %p msg %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="cm">/* header */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg_header</span><span class="p">,</span> <span class="n">crc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">crc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read_partial_message bad hdr &quot;</span>
		       <span class="s">&quot; crc %u != expected %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">crc</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">crc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">front_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">front_len</span> <span class="o">&gt;</span> <span class="n">CEPH_MSG_MAX_FRONT_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">middle_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">middle_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">middle_len</span> <span class="o">&gt;</span> <span class="n">CEPH_MSG_MAX_DATA_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">CEPH_MSG_MAX_DATA_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* verify seq# */</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">seq</span> <span class="o">-</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;skipping %s%lld %s seq %lld expected %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
			<span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span>
			<span class="n">seq</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">front_len</span> <span class="o">-</span> <span class="n">middle_len</span> <span class="o">-</span> <span class="n">data_len</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">seq</span> <span class="o">-</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read_partial_message bad seq %lld expected %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">seq</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;bad message sequence # for incoming message&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate message? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got hdr type %d front %d data %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		     <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">=</span> <span class="n">ceph_alloc_msg</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip this message */</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;alloc_msg said skip message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">front_len</span> <span class="o">-</span> <span class="n">middle_len</span> <span class="o">-</span> <span class="n">data_len</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span>
				<span class="s">&quot;error allocating memory for incoming message&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* haven&#39;t read it yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">page_alignment</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">page_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* front */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_message_section</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">,</span> <span class="n">front_len</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_front_crc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* middle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_message_section</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">,</span>
						   <span class="n">middle_len</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_middle_crc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">)</span>
		<span class="n">init_bio_iter</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_seg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* (page) data */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg_pos</span><span class="p">.</span><span class="n">data_pos</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_message_pages</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
						 <span class="n">data_len</span><span class="p">,</span> <span class="n">do_datacrc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_message_bio</span><span class="p">(</span><span class="n">con</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_seg</span><span class="p">,</span>
						 <span class="n">data_len</span><span class="p">,</span> <span class="n">do_datacrc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* footer */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;read_partial_message got msg %p %d (%u) + %d (%u) + %d (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">m</span><span class="p">,</span> <span class="n">front_len</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span><span class="p">,</span> <span class="n">middle_len</span><span class="p">,</span>
	     <span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span><span class="p">);</span>

	<span class="cm">/* crc ok? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_front_crc</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read_partial_message %p front crc %u != exp. %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_front_crc</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_middle_crc</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read_partial_message %p middle crc %u != exp %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_middle_crc</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_datacrc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_MSG_FOOTER_NOCRC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read_partial_message %p data crc %u != exp. %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
		       <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* done! */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process message.  This happens in the worker thread.  The callback should</span>
<span class="cm"> * be careful not to do anything that waits on other incoming messages or it</span>
<span class="cm"> * may deadlock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">;</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* if first message, set peer_name */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">src</span><span class="p">;</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;===== %p %llu from %s%lld %d=%s len %d+%d (%u %u %u) =====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">msg</span><span class="p">,</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">),</span>
	     <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">src</span><span class="p">),</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">),</span>
	     <span class="n">ceph_msg_type_name</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">)),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_front_crc</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_middle_crc</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_data_crc</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dispatch</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">prepare_read_tag</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Write something to the socket.  Called in a worker thread when the</span>
<span class="cm"> * socket appears to be writeable and we have something ready to send.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write start %p state %lu nref %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
	     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">));</span>

<span class="nl">more:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write out_kvec_bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span><span class="p">);</span>

	<span class="cm">/* open the socket first? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_con_out_kvec_reset</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">prepare_write_banner</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_write_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">prepare_read_banner</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NEGOTIATING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write initiating connect on %p new state %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;connect error&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">more_kvec:</span>
	<span class="cm">/* kvec data queued? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_partial_skip</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_partial_kvec</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* msg pages? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* we&#39;re done with this one */</span>
			<span class="k">goto</span> <span class="n">do_next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_partial_msg_pages</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">more_kvec</span><span class="p">;</span>  <span class="cm">/* we need to send the footer, too! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write write_partial_msg_pages err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">do_next:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* is anything else pending? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prepare_write_message</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span> <span class="o">&gt;</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq_acked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prepare_write_ack</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">KEEPALIVE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prepare_write_keepalive</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Nothing to do! */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write nothing else to write.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_write done on %p ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Read what we can from the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_read start on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>

<span class="nl">more:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_read tag %d in_base_pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">,</span>
	     <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * process_connect and process_message drop and re-take</span>
<span class="cm">	 * con-&gt;mutex.  make sure we handle a racing close or reopen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">OPENING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NEGOTIATING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_read connecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_banner</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_banner</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_connect</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * skipping + discarding content.</span>
<span class="cm">		 *</span>
<span class="cm">		 * FIXME: there must be a better way to do this!</span>
<span class="cm">		 */</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SKIP_BUF_SIZE</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">-</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;skipping %d / %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="o">-</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">==</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * what&#39;s next?</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_tcp_recvmsg</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_read got tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_MSG</span>:
			<span class="n">prepare_read_message</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_ACK</span>:
			<span class="n">prepare_read_ack</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CEPH_MSGR_TAG_CLOSE</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>   <span class="cm">/* fixme */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">bad_tag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">==</span> <span class="n">CEPH_MSGR_TAG_MSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_message</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EBADMSG</span>:
				<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;bad crc&quot;</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
				<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;io error&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">==</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
		<span class="n">process_message</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">==</span> <span class="n">CEPH_MSGR_TAG_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read_partial_ack</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">process_ack</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;try_read done on %p ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">bad_tag:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;try_read bad con-&gt;in_tag = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span><span class="p">);</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;protocol error, garbage tag&quot;</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Atomically queue work on a connection.  Bump @con reference to</span>
<span class="cm"> * avoid races with connection teardown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_con</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;queue_con %p ignoring: DEAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">con</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;queue_con %p ref count 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;queue_con %p - already queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;queue_con %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do some work on a connection.  Drop a connection ref when we&#39;re done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_connection</span><span class="p">,</span>
						   <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">restart:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BACKOFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work %p backing off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
				       <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work %p backoff %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work %p FAILED to back off %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span>
			     <span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work %p STANDBY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* e.g. if we are replaced */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work CLOSED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">con_close_socket</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">OPENING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reopen w/ new peer */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_work OPENING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">con_close_socket</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">SOCK_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_read</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_write</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">done_unlocked:</span>
	<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fault:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ceph_fault</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>     <span class="cm">/* error/fault path */</span>
	<span class="k">goto</span> <span class="n">done_unlocked</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Generic error/fault handler.  A retry mechanism is used with</span>
<span class="cm"> * exponential backoff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s%lld %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span>
	       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">),</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">error_msg</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fault %p state %lu to peer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">in_addr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOSSYTX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fault on LOSSYTX channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">con_close_socket</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Requeue anything that hasn&#39;t been acked */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_sent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">);</span>

	<span class="cm">/* If there are no messages queued or keepalive pending, place</span>
<span class="cm">	 * the connection in a STANDBY state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">KEEPALIVE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fault %p setting STANDBY clearing WRITE_PENDING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* retry after a delay. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">BASE_DELAY_INTERVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">MAX_DELAY_INTERVAL</span><span class="p">)</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ceph_msgr_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
				       <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fault queued %p delay %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fault failed to queue %p delay %lu, backoff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * In many cases we see a socket state change</span>
<span class="cm">			 * while con_work is running and end up</span>
<span class="cm">			 * queuing (non-delayed) work, such that we</span>
<span class="cm">			 * can&#39;t backoff with a delay.  Set a flag so</span>
<span class="cm">			 * that when con_work restarts we schedule the</span>
<span class="cm">			 * delay then.</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BACKOFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * in case we faulted due to authentication, invalidate our</span>
<span class="cm">	 * current tickets so that we can get new ones.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">auth_retry</span> <span class="o">&amp;&amp;</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;calling invalidate_authorizer()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">)</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * create a new messenger instance</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="nf">ceph_messenger_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="o">*</span><span class="n">myaddr</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">supported_features</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">required_features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">;</span>

	<span class="n">msgr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msgr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">msgr</span><span class="o">-&gt;</span><span class="n">supported_features</span> <span class="o">=</span> <span class="n">supported_features</span><span class="p">;</span>
	<span class="n">msgr</span><span class="o">-&gt;</span><span class="n">required_features</span> <span class="o">=</span> <span class="n">required_features</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">global_seq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">myaddr</span><span class="p">)</span>
		<span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">myaddr</span><span class="p">;</span>

	<span class="cm">/* select a random nonce */</span>
	<span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">nonce</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">nonce</span><span class="p">));</span>
	<span class="n">encode_my_addr</span><span class="p">(</span><span class="n">msgr</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;messenger_create %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">msgr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_messenger_create</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_messenger_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_messenger</span> <span class="o">*</span><span class="n">msgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;destroy %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msgr</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;destroyed messenger %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msgr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_messenger_destroy</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_standby</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* come back from STANDBY? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;clear_standby %p and ++connect_seq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">connect_seq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">KEEPALIVE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue up an outgoing message on the given connection.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_send %p closed, dropping %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set src+dst */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">));</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">needs_out_seq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* queue */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">));</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_queue</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;----- %p to %s%lld %d=%s len %d+%d+%d -----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
	     <span class="n">ENTITY_NAME</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">peer_name</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">),</span>
	     <span class="n">ceph_msg_type_name</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">)),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">middle_len</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* if there wasn&#39;t anything waiting to send before, queue</span>
<span class="cm">	 * new work */</span>
	<span class="n">clear_standby</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_con_send</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Revoke a message that was previously queued for send</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_revoke</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_revoke %p msg %p - was on queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span> <span class="o">==</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_revoke %p msg %p - was sending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_is_msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_skip</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_bytes</span><span class="p">;</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">out_kvec_is_msg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Revoke a message that we may be reading data into</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_revoke_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">&amp;&amp;</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">==</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">front_len</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">middle_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">middle_len</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>

		<span class="cm">/* skip rest of message */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_revoke_pages %p msg %p revoked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_base_pos</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg_header</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">front_len</span> <span class="o">-</span>
				<span class="n">middle_len</span> <span class="o">-</span>
				<span class="n">data_len</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg_footer</span><span class="p">);</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_tag</span> <span class="o">=</span> <span class="n">CEPH_MSGR_TAG_READY</span><span class="p">;</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">in_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_revoke_pages %p msg %p pages %p no-op</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">in_msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue a keepalive byte to ensure the tcp connection is alive.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_con_keepalive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;con_keepalive %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">clear_standby</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">KEEPALIVE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WRITE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_con</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_con_keepalive</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * construct a new message with given type, size</span>
<span class="cm"> * the new msg has a ref count of 1.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">ceph_msg_new</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">front_len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">can_fail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CEPH_MSG_PRIO_DEFAULT</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">front_len</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">middle_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">front_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">middle_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">data_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">front_max</span> <span class="o">=</span> <span class="n">front_len</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">front_is_vmalloc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">more_to_follow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">ack_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* middle */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* data */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">page_alignment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pagelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bio_seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">trail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* front */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">front_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">front_len</span> <span class="o">&gt;</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">__vmalloc</span><span class="p">(</span><span class="n">front_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
						      <span class="n">PAGE_KERNEL</span><span class="p">);</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">front_is_vmalloc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">front_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_msg_new can&#39;t allocate %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">front_len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">front_len</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_msg_new %p front %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">front_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">m</span><span class="p">;</span>

<span class="nl">out2:</span>
	<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">can_fail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;msg_new can&#39;t create type %d front %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		       <span class="n">front_len</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;msg_new can&#39;t create type %d front %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		     <span class="n">front_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msg_new</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate &quot;middle&quot; portion of a message, if it is needed and wasn&#39;t</span>
<span class="cm"> * allocated by alloc_msg.  This allows us to read a small fixed-size</span>
<span class="cm"> * per-type header in the front and then gracefully fail (i.e.,</span>
<span class="cm"> * propagate the error to the caller based on info in the front) when</span>
<span class="cm"> * the middle is too large.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_alloc_middle</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">middle_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">middle_len</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;alloc_middle %p type %d %s middle_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
	     <span class="n">ceph_msg_type_name</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="n">middle_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">middle_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span> <span class="o">=</span> <span class="n">ceph_buffer_new</span><span class="p">(</span><span class="n">middle_len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic message allocator, for incoming messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">ceph_alloc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ceph_msg_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">front_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">front_len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">middle_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">middle_len</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_msg</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span> <span class="o">||</span> <span class="o">*</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">front_len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to allocate msg type %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">type</span><span class="p">,</span> <span class="n">front_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">page_alignment</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data_off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">in_hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">middle_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_alloc_middle</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Free a generically kmalloc&#39;d message.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_msg_kfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;msg_kfree %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">front_is_vmalloc</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Drop a msg ref.  Destroy as needed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_msg_last_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_msg_put last one on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">));</span>

	<span class="cm">/* drop middle, data, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_buffer_put</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">middle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_pagelist_release</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pagelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">trail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span>
		<span class="n">ceph_msgpool_put</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ceph_msg_kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msg_last_put</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ceph_msg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;msg_dump %p (front_max %d nr_pages %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
		 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front_max</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;header: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot; front: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">)</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;middle: &quot;</span><span class="p">,</span>
			       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">middle</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;footer: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">footer</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ceph_msg_dump</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
