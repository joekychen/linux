f | osd_client.c | s | 56K | 1910 | Sage Weil | sage@inktank.com | 1340196229 |  | libceph: use con get/put ops from osd_client  There were a few direct calls to ceph_con_{get,put}() instead of the con ops from osd_client.c.  This is a bug since those ops aren't defined to be ceph_con_get/put.  This breaks refcounting on the ceph_osd structs that contain the ceph_connections, and could lead to all manner of strangeness.  The purpose of the ->get and ->put methods in a ceph connection are to allow the connection to indicate it has a reference to something external to the messaging system, *not* to indicate something external has a reference to the connection.  [elder@inktank.com: added that last sentence]  Signed-off-by: Sage Weil <sage@newdream.net> Reviewed-by: Alex Elder <elder@inktank.com> (cherry picked from commit 0d47766f14211a73eaf54cab234db134ece79f49)
f | messenger.c | s | 63K | 2272 | Yan, Zheng | zheng.z.yan@intel.com | 1340196230 |  | rbd: Clear ceph_msg->bio_iter for retransmitted message  The bug can cause NULL pointer dereference in write_partial_msg_pages  Signed-off-by: Zheng Yan <zheng.z.yan@intel.com> Reviewed-by: Alex Elder <elder@inktank.com> (cherry picked from commit 43643528cce60ca184fe8197efa8e8da7c89a037)
f | ceph_common.c | s | 14K | 547 | Sage Weil | sage@inktank.com | 1340196230 |  | libceph: flush msgr queue during mon_client shutdown  We need to flush the msgr workqueue during mon_client shutdown to ensure that any work affecting our embedded ceph_connection is finished so that we can be safely destroyed.  Previously, we were flushing the work queue after osd_client shutdown and before mon_client shutdown to ensure that any osd connection refs to authorizers are flushed.  Remove the redundant flush, and document in the comment that the mon_client flush is needed to cover that case as well.  Signed-off-by: Sage Weil <sage@inktank.com> Reviewed-by: Alex Elder <elder@inktank.com> (cherry picked from commit f3dea7edd3d449fe7a6d402c1ce56a294b985261)
f | Makefile | g | 346B |  | David S. Miller | davem@davemloft.net | 1291844858 |  | Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6  Conflicts: 	drivers/net/wireless/ath/ath9k/ar9003_eeprom.c 	net/llc/af_llc.c
f | osdmap.c | s | 26K | 985 | Linus Torvalds | torvalds@linux-foundation.org | 1338401839 |  | Merge git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client  Pull ceph updates from Sage Weil:  "There are some updates and cleanups to the CRUSH placement code, a bug   fix with incremental maps, several cleanups and fixes from Josh Durgin   in the RBD block device code, a series of cleanups and bug fixes from   Alex Elder in the messenger code, and some miscellaneous bounds   checking and gfp cleanups/fixes."  Fix up trivial conflicts in net/ceph/{messenger.c,osdmap.c} due to the networking people preferring "unsigned int" over just "unsigned".  * git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client: (45 commits)   libceph: fix pg_temp updates   libceph: avoid unregistering osd request when not registered   ceph: add auth buf in prepare_write_connect()   ceph: rename prepare_connect_authorizer()   ceph: return pointer from prepare_connect_authorizer()   ceph: use info returned by get_authorizer   ceph: have get_authorizer methods return pointers   ceph: ensure auth ops are defined before use   ceph: messenger: reduce args to create_authorizer   ceph: define ceph_auth_handshake type   ceph: messenger: check return from get_authorizer   ceph: messenger: rework prepare_connect_authorizer()   ceph: messenger: check prepare_write_connect() result   ceph: don't set WRITE_PENDING too early   ceph: drop msgr argument from prepare_write_connect()   ceph: messenger: send banner in process_connect()   ceph: messenger: reset connection kvec caller   libceph: don't reset kvec in prepare_write_banner()   ceph: ignore preferred_osd field   ceph: fully initialize new layout   ...
f | auth_x.c | s | 16K | 577 | Alex Elder | elder@inktank.com | 1337260692 |  | ceph: messenger: reduce args to create_authorizer  Make use of the new ceph_auth_handshake structure in order to reduce the number of arguments passed to the create_authorizor method in ceph_auth_client_ops.  Use a local variable of that type as a shorthand in the get_authorizer method definitions.  Signed-off-by: Alex Elder <elder@inktank.com> Reviewed-by: Sage Weil <sage@inktank.com>
f | armor.c | s | 1.9K | 92 | Tommi Virtanen | tommi.virtanen@dreamhost.com | 1300205642 |  | libceph: Fix base64-decoding when input ends in newline.  It used to return -EINVAL because it thought the end was not aligned to 4 bytes.  Clean up superfluous src < end test in if, the while itself guarantees that.  Signed-off-by: Tommi Virtanen <tommi.virtanen@dreamhost.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | auth_x.h | s | 859B | 34 | Eric Dumazet | eric.dumazet@gmail.com | 1334508280 |  | net: cleanup unsigned to unsigned int  Use of "unsigned int" is preferred to bare "unsigned" in net tree.  Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com> Signed-off-by: David S. Miller <davem@davemloft.net>
d | crush |  | 3 items |  | Linus Torvalds | torvalds@linux-foundation.org | 1338401839 |  | Merge git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client  Pull ceph updates from Sage Weil:  "There are some updates and cleanups to the CRUSH placement code, a bug   fix with incremental maps, several cleanups and fixes from Josh Durgin   in the RBD block device code, a series of cleanups and bug fixes from   Alex Elder in the messenger code, and some miscellaneous bounds   checking and gfp cleanups/fixes."  Fix up trivial conflicts in net/ceph/{messenger.c,osdmap.c} due to the networking people preferring "unsigned int" over just "unsigned".  * git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client: (45 commits)   libceph: fix pg_temp updates   libceph: avoid unregistering osd request when not registered   ceph: add auth buf in prepare_write_connect()   ceph: rename prepare_connect_authorizer()   ceph: return pointer from prepare_connect_authorizer()   ceph: use info returned by get_authorizer   ceph: have get_authorizer methods return pointers   ceph: ensure auth ops are defined before use   ceph: messenger: reduce args to create_authorizer   ceph: define ceph_auth_handshake type   ceph: messenger: check return from get_authorizer   ceph: messenger: rework prepare_connect_authorizer()   ceph: messenger: check prepare_write_connect() result   ceph: don't set WRITE_PENDING too early   ceph: drop msgr argument from prepare_write_connect()   ceph: messenger: send banner in process_connect()   ceph: messenger: reset connection kvec caller   libceph: don't reset kvec in prepare_write_banner()   ceph: ignore preferred_osd field   ceph: fully initialize new layout   ...
f | pagevec.c | s | 4.8K | 208 | Sage Weil | sage@newdream.net | 1299188859 |  | libceph: fix handling of short returns from get_user_pages  get_user_pages() can return fewer pages than we ask for.  We were returning a bogus pointer/error code in that case.  Instead, loop until we get all the pages we want or get an error we can return to the caller.  Signed-off-by: Sage Weil <sage@newdream.net>
f | ceph_fs.c | s | 1.7K | 68 | Sage Weil | sage@newdream.net | 1311099904 |  | ceph: fix file mode calculation  open(2) must always include one of O_RDONLY, O_WRONLY, or O_RDWR.  No need for any O_APPEND special case.  Passing O_WRONLY||O_RDWR is undefined according to the man page, but the Linux VFS interprets this as O_RDWR, so we'll do the same.  This fixes open(2) with flags O_RDWR||O_APPEND, which was incorrectly being translated to readonly.  Reported-by: Fyodor Ustinov <ufm@ufm.su> Signed-off-by: Sage Weil <sage@newdream.net>
f | buffer.c | s | 1.4K | 57 | Eric Dumazet | eric.dumazet@gmail.com | 1290362644 |  | net: allow GFP_HIGHMEM in __vmalloc()  We forgot to use __GFP_HIGHMEM in several __vmalloc() calls.  In ceph, add the missing flag.  In fib_trie.c, xfrm_hash.c and request_sock.c, using vzalloc() is cleaner and allows using HIGHMEM pages as well.  Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com> Signed-off-by: David S. Miller <davem@davemloft.net>
f | mon_client.c | s | 25K | 903 | Sage Weil | sage@inktank.com | 1340196230 |  | libceph: flush msgr queue during mon_client shutdown  We need to flush the msgr workqueue during mon_client shutdown to ensure that any work affecting our embedded ceph_connection is finished so that we can be safely destroyed.  Previously, we were flushing the work queue after osd_client shutdown and before mon_client shutdown to ensure that any osd connection refs to authorizers are flushed.  Remove the redundant flush, and document in the comment that the mon_client flush is needed to cover that case as well.  Signed-off-by: Sage Weil <sage@inktank.com> Reviewed-by: Alex Elder <elder@inktank.com> (cherry picked from commit f3dea7edd3d449fe7a6d402c1ce56a294b985261)
f | Kconfig | g | 1.1K |  | Noah Watkins | noahwatkins@gmail.com | 1319584216 |  | ceph: use kernel DNS resolver  Change ceph_parse_ips to take either names given as IP addresses or standard hostnames (e.g. localhost). The DNS lookup is done using the dns_resolver facility similar to its use in AFS, NFS, and CIFS.  This patch defines CONFIG_CEPH_LIB_USE_DNS_RESOLVER that controls if this feature is on or off.  Signed-off-by: Noah Watkins <noahwatkins@gmail.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | auth_none.c | s | 2.9K | 106 | Alex Elder | elder@inktank.com | 1337260692 |  | ceph: messenger: reduce args to create_authorizer  Make use of the new ceph_auth_handshake structure in order to reduce the number of arguments passed to the create_authorizor method in ceph_auth_client_ops.  Use a local variable of that type as a shorthand in the get_authorizer method definitions.  Signed-off-by: Alex Elder <elder@inktank.com> Reviewed-by: Sage Weil <sage@inktank.com>
f | auth_none.h | s | 536B | 22 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | msgpool.c | s | 1.9K | 67 | Sage Weil | sage@newdream.net | 1319584215 |  | libceph: don't complain on msgpool alloc failures  The pool allocation failures are masked by the pool; there is no need to spam the console about them.  (That's the whole point of having the pool in the first place.)  Mark msg allocations whose failure is safely handled as such.  Signed-off-by: Sage Weil <sage@newdream.net>
f | debugfs.c | s | 6.5K | 221 | Eric Dumazet | eric.dumazet@gmail.com | 1334508280 |  | net: cleanup unsigned to unsigned int  Use of "unsigned int" is preferred to bare "unsigned" in net tree.  Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com> Signed-off-by: David S. Miller <davem@davemloft.net>
f | ceph_hash.c | s | 2.8K | 109 | Eric Dumazet | eric.dumazet@gmail.com | 1334508280 |  | net: cleanup unsigned to unsigned int  Use of "unsigned int" is preferred to bare "unsigned" in net tree.  Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com> Signed-off-by: David S. Miller <davem@davemloft.net>
f | auth_x_protocol.h | s | 1.7K | 69 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | crypto.c | s | 11K | 412 | Thomas Meyer | thomas@m3y3r.de | 1326214614 |  | ceph: Use kmemdup rather than duplicating its implementation  Use kmemdup rather than duplicating its implementation  The semantic patch that makes this change is available in scripts/coccinelle/api/memdup.cocci.  Signed-off-by: Thomas Meyer <thomas@m3y3r.de> Signed-off-by: Sage Weil <sage@newdream.net>
f | crypto.h | s | 1.5K | 45 | Tommi Virtanen | tommi.virtanen@dreamhost.com | 1301425884 |  | libceph: Create a new key type "ceph".  This allows us to use existence of the key type as a feature test, from userspace.  Signed-off-by: Tommi Virtanen <tommi.virtanen@dreamhost.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | auth.c | s | 5.6K | 222 | Tommi Virtanen | tommi.virtanen@dreamhost.com | 1301425876 |  | ceph: Move secret key parsing earlier.  This makes the base64 logic be contained in mount option parsing, and prepares us for replacing the homebew key management with the kernel key retention service.  Signed-off-by: Tommi Virtanen <tommi.virtanen@dreamhost.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | pagelist.c | s | 3.6K | 140 | Sage Weil | sage@newdream.net | 1287614303 |  | ceph: fix num_pages_free accounting in pagelist  Decrement the free page counter when removing a page from the free_list.  Signed-off-by: Sage Weil <sage@newdream.net>
f | ceph_strings.c | s | 2.5K | 71 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
