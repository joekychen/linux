<!DOCTYPE html>
<html><head><title>joekychen/linux » net › x25 › af_x25.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_x25.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	X.25 Packet Layer release 002</span>
<span class="cm"> *</span>
<span class="cm"> *	This is ALPHA test software. This code may break your machine,</span>
<span class="cm"> *	randomly fail to work with new releases, misbehave and/or generally</span>
<span class="cm"> *	screw up. It might even work.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code REQUIRES 2.1.15 or higher</span>
<span class="cm"> *</span>
<span class="cm"> *	This module:</span>
<span class="cm"> *		This module is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	History</span>
<span class="cm"> *	X.25 001	Jonathan Naylor	Started coding.</span>
<span class="cm"> *	X.25 002	Jonathan Naylor	Centralised disconnect handling.</span>
<span class="cm"> *					New timer architecture.</span>
<span class="cm"> *	2000-03-11	Henner Eisen	MSG_EOR handling more POSIX compliant.</span>
<span class="cm"> *	2000-03-22	Daniela Squassoni Allowed disabling/enabling of</span>
<span class="cm"> *					  facilities negotiation and increased</span>
<span class="cm"> *					  the throughput upper limit.</span>
<span class="cm"> *	2000-08-27	Arnaldo C. Melo s/suser/capable/ + micro cleanups</span>
<span class="cm"> *	2000-09-04	Henner Eisen	Set sock-&gt;state in x25_accept().</span>
<span class="cm"> *					Fixed x25_output() related skb leakage.</span>
<span class="cm"> *	2000-10-02	Henner Eisen	Made x25_kick() single threaded per socket.</span>
<span class="cm"> *	2000-10-27	Henner Eisen    MSG_DONTWAIT for fragment allocation.</span>
<span class="cm"> *	2000-11-14	Henner Eisen    Closing datalink from NETDEV_GOING_DOWN</span>
<span class="cm"> *	2002-10-06	Arnaldo C. Melo Get rid of cli/sti, move proc stuff to</span>
<span class="cm"> *					x25_proc.c, using seq_file</span>
<span class="cm"> *	2005-04-02	Shaun Pereira	Selective sub address matching</span>
<span class="cm"> *					with call user data</span>
<span class="cm"> *	2005-04-15	Shaun Pereira	Fast select with no restriction on</span>
<span class="cm"> *					response</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp_states.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;	</span><span class="cm">/* For TIOCINQ/OUTQ */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#include &lt;net/x25.h&gt;</span>
<span class="cp">#include &lt;net/compat.h&gt;</span>

<span class="kt">int</span> <span class="n">sysctl_x25_restart_request_timeout</span> <span class="o">=</span> <span class="n">X25_DEFAULT_T20</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_x25_call_request_timeout</span>    <span class="o">=</span> <span class="n">X25_DEFAULT_T21</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_x25_reset_request_timeout</span>   <span class="o">=</span> <span class="n">X25_DEFAULT_T22</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_x25_clear_request_timeout</span>   <span class="o">=</span> <span class="n">X25_DEFAULT_T23</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_x25_ack_holdback_timeout</span>    <span class="o">=</span> <span class="n">X25_DEFAULT_T2</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_x25_forward</span>                 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">HLIST_HEAD</span><span class="p">(</span><span class="n">x25_list</span><span class="p">);</span>
<span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">x25_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">x25_proto_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">x25_address</span> <span class="n">null_x25_address</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;               &quot;</span><span class="p">};</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">struct</span> <span class="n">compat_x25_subscrip_struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">device</span><span class="p">[</span><span class="mi">200</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">compat_ulong_t</span><span class="p">)];</span>
	<span class="n">compat_ulong_t</span> <span class="n">global_facil_mask</span><span class="p">;</span>
	<span class="n">compat_uint_t</span> <span class="n">extended</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="kt">int</span> <span class="nf">x25_parse_address_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">called_addr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">calling_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* packet has no address block */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">empty</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">needed</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">needed</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* packet is too short to hold the addresses it claims</span>
<span class="cm">		   to hold */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">empty</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">x25_addr_ntoa</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">called_addr</span><span class="p">,</span> <span class="n">calling_addr</span><span class="p">);</span>

<span class="nl">empty:</span>
	<span class="o">*</span><span class="n">called_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">calling_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">x25_addr_ntoa</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">called_addr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">calling_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">called_len</span><span class="p">,</span> <span class="n">calling_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">called</span><span class="p">,</span> <span class="o">*</span><span class="n">calling</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">called_len</span>  <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">calling_len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="n">called</span>  <span class="o">=</span> <span class="n">called_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">;</span>
	<span class="n">calling</span> <span class="o">=</span> <span class="n">calling_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">;</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">called_len</span> <span class="o">+</span> <span class="n">calling_len</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">called_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">called</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">called</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">calling</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">calling</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">called</span> <span class="o">=</span> <span class="o">*</span><span class="n">calling</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">called_len</span> <span class="o">+</span> <span class="n">calling_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">x25_addr_aton</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">called_addr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">calling_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">called_len</span><span class="p">,</span> <span class="n">calling_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">called</span><span class="p">,</span> <span class="o">*</span><span class="n">calling</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">called</span>  <span class="o">=</span> <span class="n">called_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">;</span>
	<span class="n">calling</span> <span class="o">=</span> <span class="n">calling_addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">;</span>

	<span class="n">called_len</span>  <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">called</span><span class="p">);</span>
	<span class="n">calling_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">calling</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">calling_len</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">called_len</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">called_len</span> <span class="o">+</span> <span class="n">calling_len</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">called_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">calling</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">calling</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">called_len</span> <span class="o">+</span> <span class="n">calling_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Socket removal during an interrupt is now safe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">x25_remove_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Kill all bound sockets on a dropped device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">x25_kill_by_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">neighbour</span> <span class="o">&amp;&amp;</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
			<span class="n">x25_disconnect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ENETUNREACH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Handle device status changes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_X25</span>
<span class="cp">#if IS_ENABLED(CONFIG_LLC)</span>
	 <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_ETHER</span>
<span class="cp">#endif</span>
	 <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NETDEV_UP</span>:
			<span class="n">x25_link_device_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
			<span class="n">nb</span> <span class="o">=</span> <span class="n">x25_get_neigh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">x25_terminate_link</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
				<span class="n">x25_neigh_put</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
			<span class="n">x25_kill_by_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">x25_route_device_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">x25_link_device_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Add a socket to the bound sockets list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">x25_insert_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="n">sk_add_node</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Find a socket that wants to accept the Call Request we just</span>
<span class="cm"> *	received. Check the full list for an address/cud match.</span>
<span class="cm"> *	If no cuds match return the next_best thing, an address match.</span>
<span class="cm"> *	Note: if a listening socket has cud set it must only get calls</span>
<span class="cm"> *	with matching cud.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">x25_find_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">x25_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">next_best</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="n">next_best</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">,</span>
			<span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">source_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">)</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">x25_addr</span><span class="p">,</span>
					<span class="n">null_x25_address</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Found a listening socket, now check the incoming</span>
<span class="cm">			 * call user data vs this sockets call user data</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">calluserdata</span><span class="p">.</span><span class="n">cuddata</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sock_hold</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
				 <span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">next_best</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">next_best</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Find a connected X.25 socket given my LCI and neighbour.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">__x25_find_socket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">==</span> <span class="n">lci</span> <span class="o">&amp;&amp;</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">neighbour</span> <span class="o">==</span> <span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_hold</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">x25_find_socket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">__x25_find_socket</span><span class="p">(</span><span class="n">lci</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Find a unique LCI for a given device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">x25_new_lci</span><span class="p">(</span><span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">sk</span> <span class="o">=</span> <span class="n">__x25_find_socket</span><span class="p">(</span><span class="n">lci</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lci</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lci</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Deferred destroy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__x25_destroy_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	handler for deferred kills.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">x25_destroy_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">x25_destroy_socket_from_timer</span><span class="p">((</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	This is called from user mode and the timers. Thus it protects itself</span>
<span class="cm"> *	against interrupt users but doesn&#39;t worry about being called during</span>
<span class="cm"> *	work. Once it is removed from the queue no interrupt or bottom half</span>
<span class="cm"> *	will touch it and we are (fairly 8-) ) safe.</span>
<span class="cm"> *	Not static as it&#39;s used by the timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__x25_destroy_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">x25_stop_heartbeat</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">x25_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">x25_remove_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">x25_clear_queues</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>		<span class="cm">/* Flush the queues */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">!=</span> <span class="n">sk</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* A pending connection */</span>
			<span class="cm">/*</span>
<span class="cm">			 * Queue the unaccepted socket for death</span>
<span class="cm">			 */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
			<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">);</span>
			<span class="n">x25_start_heartbeat</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">x25_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk_has_allocations</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Defer: outstanding buffers */</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">.</span><span class="n">expires</span>  <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">x25_destroy_timer</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* drop last reference so sock_put will free */</span>
		<span class="n">__sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">x25_destroy_socket_from_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__x25_destroy_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Handling for system calls applied via the various interfaces to a</span>
<span class="cm"> *	X.25 socket object.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_X25</span> <span class="o">||</span> <span class="n">optname</span> <span class="o">!=</span> <span class="n">X25_QBITINCL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_X25</span> <span class="o">||</span> <span class="n">optname</span> <span class="o">!=</span> <span class="n">X25_QBITINCL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">X25_ADDR_LEN</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>           <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">x25_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;X25&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">x25_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">x25_alloc_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">AF_X25</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_proto</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock_init_data</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">ack_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">fragment_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">interrupt_in_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">interrupt_out_queue</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sk</span> <span class="o">=</span> <span class="n">x25_alloc_socket</span><span class="p">(</span><span class="n">net</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">x25_init_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">x25_proto_ops</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog_rcv</span> <span class="o">=</span> <span class="n">x25_backlog_rcv</span><span class="p">;</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t21</span>   <span class="o">=</span> <span class="n">sysctl_x25_call_request_timeout</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t22</span>   <span class="o">=</span> <span class="n">sysctl_x25_reset_request_timeout</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t23</span>   <span class="o">=</span> <span class="n">sysctl_x25_clear_request_timeout</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t2</span>    <span class="o">=</span> <span class="n">sysctl_x25_ack_holdback_timeout</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_0</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">X25_ACCPT_APPRV_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* normally no cud  */</span>
							<span class="cm">/* on call accept   */</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">winsize_in</span>  <span class="o">=</span> <span class="n">X25_DEFAULT_WINDOW_SIZE</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">winsize_out</span> <span class="o">=</span> <span class="n">X25_DEFAULT_WINDOW_SIZE</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_in</span>  <span class="o">=</span> <span class="n">X25_DEFAULT_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_out</span> <span class="o">=</span> <span class="n">X25_DEFAULT_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* by default don&#39;t negotiate</span>
<span class="cm">						   throughput */</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">.</span><span class="n">reverse</span>     <span class="o">=</span> <span class="n">X25_DEFAULT_REVERSE</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">calling_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">called_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">called_ae</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">called_ae</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">calling_ae</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">.</span><span class="n">calling_ae</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">x25_make_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">osk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span><span class="p">,</span> <span class="o">*</span><span class="n">ox25</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sk</span> <span class="o">=</span> <span class="n">x25_alloc_socket</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">osk</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span>        <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span>    <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_priority</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span>    <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span>      <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span>      <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>       <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_backlog_rcv</span> <span class="o">=</span> <span class="n">osk</span><span class="o">-&gt;</span><span class="n">sk_backlog_rcv</span><span class="p">;</span>
	<span class="n">sock_copy_flags</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">osk</span><span class="p">);</span>

	<span class="n">ox25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">osk</span><span class="p">);</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t21</span>        <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">t21</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t22</span>        <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">t22</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t23</span>        <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">t23</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">t2</span>         <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span> <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span> <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">;</span>
	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span> <span class="o">=</span> <span class="n">ox25</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">X25_INTERRUPT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">x25_init_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">X25_STATE_0</span>:
		<span class="k">case</span> <span class="n">X25_STATE_2</span>:
			<span class="n">x25_disconnect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">__x25_destroy_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">X25_STATE_1</span>:
		<span class="k">case</span> <span class="n">X25_STATE_3</span>:
		<span class="k">case</span> <span class="n">X25_STATE_4</span>:
			<span class="n">x25_clear_queues</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">x25_write_internal</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">X25_CLEAR_REQUEST</span><span class="p">);</span>
			<span class="n">x25_start_t23timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">x25</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_2</span><span class="p">;</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>	<span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span>	<span class="o">|=</span> <span class="n">SEND_SHUTDOWN</span><span class="p">;</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">);</span>
			<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DESTROY</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_family</span> <span class="o">!=</span> <span class="n">AF_X25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">source_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_addr</span><span class="p">;</span>
	<span class="n">x25_insert_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_bind: socket is bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_wait_for_connection_establishment</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">add_wait_queue_exclusive</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_route</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* Connect completed during a ERESTARTSYS event */</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SS_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>	<span class="cm">/* No reconnect on a seqpacket socket */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>   <span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_family</span> <span class="o">!=</span> <span class="n">AF_X25</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">x25_get_route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span> <span class="o">=</span> <span class="n">x25_get_neigh</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_route</span><span class="p">;</span>

	<span class="n">x25_limit_facilities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">,</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="p">);</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">=</span> <span class="n">x25_new_lci</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_neigh</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span> <span class="cm">/* Must bind first - autobinding does not work */</span>
		<span class="k">goto</span> <span class="n">out_put_neigh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">source_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">,</span> <span class="n">null_x25_address</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">source_addr</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">X25_ADDR_LEN</span><span class="p">);</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">dest_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sx25_addr</span><span class="p">;</span>

	<span class="cm">/* Move to connecting socket, start sending Connect Requests */</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span>   <span class="o">=</span> <span class="n">SS_CONNECTING</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>  <span class="o">=</span> <span class="n">TCP_SYN_SENT</span><span class="p">;</span>

	<span class="n">x25</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_1</span><span class="p">;</span>

	<span class="n">x25_write_internal</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">X25_CALL_REQUEST</span><span class="p">);</span>

	<span class="n">x25_start_heartbeat</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">x25_start_t21timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Now the loop */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put_neigh</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_wait_for_connection_establishment</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_neigh</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_put_neigh:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">x25_neigh_put</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="p">);</span>
<span class="nl">out_put_route:</span>
	<span class="n">x25_route_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_wait_for_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">add_wait_queue_exclusive</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">newsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_wait_for_data</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="n">newsk</span>		 <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">sock_graft</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>

	<span class="cm">/* Now attach up the new socket */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="o">--</span><span class="p">;</span>
	<span class="n">newsock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="o">*</span><span class="n">uaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="n">sx25</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sx25</span><span class="o">-&gt;</span><span class="n">sx25_addr</span> <span class="o">=</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sx25</span><span class="o">-&gt;</span><span class="n">sx25_addr</span> <span class="o">=</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">source_addr</span><span class="p">;</span>

	<span class="n">sx25</span><span class="o">-&gt;</span><span class="n">sx25_family</span> <span class="o">=</span> <span class="n">AF_X25</span><span class="p">;</span>
	<span class="o">*</span><span class="n">uaddr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sx25</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">x25_rx_call_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">make</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">makex25</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_address</span> <span class="n">source_addr</span><span class="p">,</span> <span class="n">dest_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_facilities</span> <span class="n">facilities</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_dte_facilities</span> <span class="n">dte_facilities</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Remove the LCI and frame type.</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Extract the X.25 addresses and convert them to ASCII strings,</span>
<span class="cm">	 *	and remove them.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Address block is mandatory in call request packets</span>
<span class="cm">	 */</span>
	<span class="n">addr_len</span> <span class="o">=</span> <span class="n">x25_parse_address_block</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Get the length of the facilities, skip past them for the moment</span>
<span class="cm">	 *	get the call user data because this is needed to determine</span>
<span class="cm">	 *	the correct listener</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Facilities length is mandatory in call request packets</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Ensure that the amount of call user data is valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">X25_MAX_CUD_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Get all the call user data so it can be used in</span>
<span class="cm">	 *	x25_find_listener and skb_copy_from_linear_data up ahead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Find a listener for the particular address/cud pair.</span>
<span class="cm">	 */</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">x25_find_listener</span><span class="p">(</span><span class="o">&amp;</span><span class="n">source_addr</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_sock_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	We dont have any listeners for this incoming call.</span>
<span class="cm">	 *	Try forwarding it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">addr_len</span> <span class="o">+</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysctl_x25_forward</span> <span class="o">&amp;&amp;</span>
				<span class="n">x25_forward_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">lci</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* Call was forwarded, dont process it any more */</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No listeners, can&#39;t forward, clear the call */</span>
			<span class="k">goto</span> <span class="n">out_clear_request</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Try to reach a compromise on the requested facilities.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">x25_negotiate_facilities</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">facilities</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dte_facilities</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sock_put</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * current neighbour/link might impose additional limits</span>
<span class="cm">	 * on certain facilties</span>
<span class="cm">	 */</span>

	<span class="n">x25_limit_facilities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">facilities</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Try to create a new socket.</span>
<span class="cm">	 */</span>
	<span class="n">make</span> <span class="o">=</span> <span class="n">x25_make_new</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">make</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sock_put</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Remove the facilities</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span>     <span class="o">=</span> <span class="n">make</span><span class="p">;</span>
	<span class="n">make</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>

	<span class="n">makex25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">make</span><span class="p">);</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">lci</span>           <span class="o">=</span> <span class="n">lci</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">dest_addr</span>     <span class="o">=</span> <span class="n">dest_addr</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">source_addr</span>   <span class="o">=</span> <span class="n">source_addr</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">neighbour</span>     <span class="o">=</span> <span class="n">nb</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">facilities</span>    <span class="o">=</span> <span class="n">facilities</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="o">=</span> <span class="n">dte_facilities</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">vc_facil_mask</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vc_facil_mask</span><span class="p">;</span>
	<span class="cm">/* ensure no reverse facil on accept */</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">vc_facil_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X25_MASK_REVERSE</span><span class="p">;</span>
	<span class="cm">/* ensure no calling address extension on accept */</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">vc_facil_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X25_MASK_CALLING_AE</span><span class="p">;</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span><span class="p">;</span>

	<span class="cm">/* Normally all calls are accepted immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_ACCPT_APPRV_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">makex25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">x25_write_internal</span><span class="p">(</span><span class="n">make</span><span class="p">,</span> <span class="n">X25_CALL_ACCEPTED</span><span class="p">);</span>
		<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Incoming Call User Data.</span>
<span class="cm">	 */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">makex25</span><span class="o">-&gt;</span><span class="n">calluserdata</span><span class="p">.</span><span class="n">cuddata</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">makex25</span><span class="o">-&gt;</span><span class="n">calluserdata</span><span class="p">.</span><span class="n">cudlength</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="o">++</span><span class="p">;</span>

	<span class="n">x25_insert_socket</span><span class="p">(</span><span class="n">make</span><span class="p">);</span>

	<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">x25_start_heartbeat</span><span class="p">(</span><span class="n">make</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">out_sock_put:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out_clear_request:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x25_transmit_clear_request</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">lci</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="n">usx25</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="n">sx25</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">asmptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_OOB</span><span class="o">|</span><span class="n">MSG_EOR</span><span class="o">|</span><span class="n">MSG_CMSG_COMPAT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* we currently don&#39;t support segmented records at the user interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSG_EOR</span><span class="o">|</span><span class="n">MSG_OOB</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usx25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sx25</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sx25</span><span class="p">,</span> <span class="n">usx25</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sx25</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">,</span> <span class="n">sx25</span><span class="p">.</span><span class="n">sx25_addr</span><span class="p">.</span><span class="n">x25_addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sx25</span><span class="p">.</span><span class="n">sx25_family</span> <span class="o">!=</span> <span class="n">AF_X25</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	FIXME 1003.1g - if the socket is like this because</span>
<span class="cm">		 *	it has become closed (not started closed) we ought</span>
<span class="cm">		 *	to SIGPIPE, EPIPE;</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">sx25</span><span class="p">.</span><span class="n">sx25_family</span> <span class="o">=</span> <span class="n">AF_X25</span><span class="p">;</span>
		<span class="n">sx25</span><span class="p">.</span><span class="n">sx25_addr</span>   <span class="o">=</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sanity check the packet size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: sendto: Addresses built.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Build a packet */</span>
	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: sendto: building packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">X25_MAX_L2_LEN</span> <span class="o">+</span> <span class="n">X25_EXT_MIN_LEN</span><span class="p">;</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">noblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">X25_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_MAX_L2_LEN</span> <span class="o">+</span> <span class="n">X25_EXT_MIN_LEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Put the data on the end</span>
<span class="cm">	 */</span>
	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: Copying user data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree_skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	If the Q BIT Include socket option is in force, the first</span>
<span class="cm">	 *	byte of the user data is the logical value of the Q Bit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_kfree_skb</span><span class="p">;</span>

		<span class="n">qbit</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Push down the X.25 header</span>
<span class="cm">	 */</span>
	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: Building X.25 Header.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="o">-&gt;</span><span class="n">extended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">asmptr</span>    <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">X25_GFI_EXTSEQ</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">X25_INTERRUPT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">asmptr</span>    <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">X25_GFI_STDSEQ</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">X25_INTERRUPT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="o">-&gt;</span><span class="n">extended</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Build an Extended X.25 header */</span>
			<span class="n">asmptr</span>    <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_EXT_MIN_LEN</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">X25_GFI_EXTSEQ</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">X25_DATA</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">X25_DATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Build an Standard X.25 header */</span>
			<span class="n">asmptr</span>    <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">X25_GFI_STDSEQ</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">lci</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="o">*</span><span class="n">asmptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">X25_DATA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qbit</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">X25_Q_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: Built header.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;x25_sendmsg: Transmitting buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">interrupt_out_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_output</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x25_kick</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">out_kfree_skb:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="n">sx25</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">copied</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qbit</span><span class="p">,</span> <span class="n">header_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">asmptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">header_len</span> <span class="o">=</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">neighbour</span><span class="o">-&gt;</span><span class="n">extended</span> <span class="o">?</span>
		<span class="n">X25_EXT_MIN_LEN</span> <span class="o">:</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This works for seqpacket too. The receiver has ordered the queue for</span>
<span class="cm">	 * us! We do one quick check first though</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_URGINLINE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">interrupt_in_queue</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">interrupt_in_queue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free_dgram</span><span class="p">;</span>

		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">X25_STD_MIN_LEN</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *	No Q bit information on Interrupt data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">asmptr</span>  <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_OOB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Now we can treat all alike */</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSG_DONTWAIT</span><span class="p">,</span>
					<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free_dgram</span><span class="p">;</span>

		<span class="n">qbit</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">X25_Q_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="n">X25_Q_BIT</span><span class="p">;</span>

		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_Q_BIT_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">asmptr</span>  <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="n">asmptr</span> <span class="o">=</span> <span class="n">qbit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Currently, each datagram always contains a complete record */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_dgram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sx25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sx25</span><span class="o">-&gt;</span><span class="n">sx25_family</span> <span class="o">=</span> <span class="n">AF_X25</span><span class="p">;</span>
		<span class="n">sx25</span><span class="o">-&gt;</span><span class="n">sx25_addr</span>   <span class="o">=</span> <span class="n">x25</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_x25</span><span class="p">);</span>

	<span class="n">x25_check_rbuf</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>
<span class="nl">out_free_dgram:</span>
	<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_sock</span> <span class="o">*</span><span class="n">x25</span> <span class="o">=</span> <span class="n">x25_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCOUTQ</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">amount</span><span class="p">;</span>

		<span class="n">amount</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">-</span> <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">TIOCINQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * These two are safe on a single CPU system as</span>
<span class="cm">		 * only user tasks fiddle here</span>
<span class="cm">		 */</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCGSTAMP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_get_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMPNS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_get_timestampns</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCGIFMETRIC</span>:
	<span class="k">case</span> <span class="n">SIOCSIFMETRIC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCADDRT</span>:
	<span class="k">case</span> <span class="n">SIOCDELRT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_route_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25GSUBSCRIP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_subscr_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25SSUBSCRIP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_subscr_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25GFACILITIES</span>: <span class="p">{</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">))</span>
			<span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SFACILITIES</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">x25_facilities</span> <span class="n">facilities</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">facilities</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">facilities</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_in</span> <span class="o">&lt;</span> <span class="n">X25_PS16</span> <span class="o">||</span>
		    <span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_in</span> <span class="o">&gt;</span> <span class="n">X25_PS4096</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_out</span> <span class="o">&lt;</span> <span class="n">X25_PS16</span> <span class="o">||</span>
		    <span class="n">facilities</span><span class="p">.</span><span class="n">pacsize_out</span> <span class="o">&gt;</span> <span class="n">X25_PS4096</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">winsize_in</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
		    <span class="n">facilities</span><span class="p">.</span><span class="n">winsize_in</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">out</span> <span class="o">=</span> <span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">in</span>  <span class="o">=</span> <span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
				<span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span> <span class="o">|=</span>
					<span class="n">X25_DEFAULT_THROUGHPUT</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">&lt;</span> <span class="mh">0x30</span> <span class="o">||</span> <span class="n">out</span> <span class="o">&gt;</span> <span class="mh">0xD0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">)</span>
				<span class="n">facilities</span><span class="p">.</span><span class="n">throughput</span> <span class="o">|=</span>
					<span class="n">X25_DEFAULT_THROUGHPUT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">&lt;</span> <span class="mh">0x03</span> <span class="o">||</span> <span class="n">in</span> <span class="o">&gt;</span> <span class="mh">0x0D</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">reverse</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">facilities</span><span class="p">.</span><span class="n">reverse</span> <span class="o">&amp;</span> <span class="mh">0x81</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x81</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fac_release</span><span class="p">;</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">facilities</span> <span class="o">=</span> <span class="n">facilities</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_fac_release:</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25GDTEFACILITIES</span>: <span class="p">{</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span><span class="p">));</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SDTEFACILITIES</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">x25_dte_facilities</span> <span class="n">dtefacs</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtefacs</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dtefacs</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dtefac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtefacs</span><span class="p">.</span><span class="n">calling_len</span> <span class="o">&gt;</span> <span class="n">X25_MAX_AE_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dtefac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtefacs</span><span class="p">.</span><span class="n">calling_ae</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dtefac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtefacs</span><span class="p">.</span><span class="n">called_len</span> <span class="o">&gt;</span> <span class="n">X25_MAX_AE_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dtefac_release</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtefacs</span><span class="p">.</span><span class="n">called_ae</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dtefac_release</span><span class="p">;</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">dte_facilities</span> <span class="o">=</span> <span class="n">dtefacs</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_dtefac_release:</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25GCALLUSERDATA</span>: <span class="p">{</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">calluserdata</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">calluserdata</span><span class="p">))</span>
			<span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SCALLUSERDATA</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">x25_calluserdata</span> <span class="n">calluserdata</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">calluserdata</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">calluserdata</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">calluserdata</span><span class="p">.</span><span class="n">cudlength</span> <span class="o">&gt;</span> <span class="n">X25_MAX_CUD_LEN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">calluserdata</span> <span class="o">=</span> <span class="n">calluserdata</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25GCAUSEDIAG</span>: <span class="p">{</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">causediag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">causediag</span><span class="p">))</span>
			<span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SCAUSEDIAG</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">x25_causediag</span> <span class="n">causediag</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">causediag</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">causediag</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">causediag</span> <span class="o">=</span> <span class="n">causediag</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SCUDMATCHLEN</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">x25_subaddr</span> <span class="n">sub_addr</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_cud_release</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub_addr</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">sub_addr</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out_cud_release</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sub_addr</span><span class="p">.</span><span class="n">cudmatchlength</span> <span class="o">&gt;</span> <span class="n">X25_MAX_CUD_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_cud_release</span><span class="p">;</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">cudmatchlength</span> <span class="o">=</span> <span class="n">sub_addr</span><span class="p">.</span><span class="n">cudmatchlength</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_cud_release:</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25CALLACCPTAPPRV</span>: <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">X25_ACCPT_APPRV_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCX25SENDCALLACCPT</span>:  <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* must call accptapprv above */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X25_ACCPT_APPRV_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">x25_write_internal</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">X25_CALL_ACCEPTED</span><span class="p">);</span>
		<span class="n">x25</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">X25_STATE_3</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">x25_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">AF_X25</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span>	<span class="n">x25_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_x25_subscr_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_x25_subscrip_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">x25_subscr32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compat_x25_subscrip_struct</span> <span class="n">x25_subscr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_subscr</span><span class="p">,</span> <span class="n">x25_subscr32</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x25_subscr32</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">x25_dev_get</span><span class="p">(</span><span class="n">x25_subscr</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nb</span> <span class="o">=</span> <span class="n">x25_get_neigh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dev_put</span><span class="p">;</span>

	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCX25GSUBSCRIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_neigh_list_lock</span><span class="p">);</span>
		<span class="n">x25_subscr</span><span class="p">.</span><span class="n">extended</span> <span class="o">=</span> <span class="n">nb</span><span class="o">-&gt;</span><span class="n">extended</span><span class="p">;</span>
		<span class="n">x25_subscr</span><span class="p">.</span><span class="n">global_facil_mask</span> <span class="o">=</span> <span class="n">nb</span><span class="o">-&gt;</span><span class="n">global_facil_mask</span><span class="p">;</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_neigh_list_lock</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">x25_subscr32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_subscr</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">x25_subscr32</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25_subscr</span><span class="p">.</span><span class="n">extended</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x25_subscr</span><span class="p">.</span><span class="n">extended</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_neigh_list_lock</span><span class="p">);</span>
			<span class="n">nb</span><span class="o">-&gt;</span><span class="n">extended</span> <span class="o">=</span> <span class="n">x25_subscr</span><span class="p">.</span><span class="n">extended</span><span class="p">;</span>
			<span class="n">nb</span><span class="o">-&gt;</span><span class="n">global_facil_mask</span> <span class="o">=</span> <span class="n">x25_subscr</span><span class="p">.</span><span class="n">global_facil_mask</span><span class="p">;</span>
			<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_neigh_list_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">x25_neigh_put</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">out_dev_put:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_x25_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCOUTQ</span>:
	<span class="k">case</span> <span class="n">TIOCINQ</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">compat_sock_get_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMPNS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">compat_sock_get_timestampns</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCGIFMETRIC</span>:
	<span class="k">case</span> <span class="n">SIOCSIFMETRIC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCADDRT</span>:
	<span class="k">case</span> <span class="n">SIOCDELRT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_route_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25GSUBSCRIP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">compat_x25_subscr_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25SSUBSCRIP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">compat_x25_subscr_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCX25GFACILITIES</span>:
	<span class="k">case</span> <span class="n">SIOCX25SFACILITIES</span>:
	<span class="k">case</span> <span class="n">SIOCX25GDTEFACILITIES</span>:
	<span class="k">case</span> <span class="n">SIOCX25SDTEFACILITIES</span>:
	<span class="k">case</span> <span class="n">SIOCX25GCALLUSERDATA</span>:
	<span class="k">case</span> <span class="n">SIOCX25SCALLUSERDATA</span>:
	<span class="k">case</span> <span class="n">SIOCX25GCAUSEDIAG</span>:
	<span class="k">case</span> <span class="n">SIOCX25SCAUSEDIAG</span>:
	<span class="k">case</span> <span class="n">SIOCX25SCUDMATCHLEN</span>:
	<span class="k">case</span> <span class="n">SIOCX25CALLACCPTAPPRV</span>:
	<span class="k">case</span> <span class="n">SIOCX25SENDCALLACCPT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">x25_proto_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>	<span class="n">AF_X25</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">x25_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">x25_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span>	<span class="n">x25_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span> <span class="o">=</span>	<span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span> <span class="o">=</span>	<span class="n">x25_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span> <span class="o">=</span>	<span class="n">x25_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">x25_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">compat_x25_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">listen</span> <span class="o">=</span>	<span class="n">x25_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>	<span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span> <span class="o">=</span>	<span class="n">x25_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span> <span class="o">=</span>	<span class="n">x25_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span> <span class="o">=</span>	<span class="n">x25_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span> <span class="o">=</span>	<span class="n">x25_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span> <span class="o">=</span>	<span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">x25_packet_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>	<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_X25</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span> <span class="o">=</span>	<span class="n">x25_lapb_receive_frame</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">x25_dev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">x25_device_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">x25_kill_by_neigh</span><span class="p">(</span><span class="k">struct</span> <span class="n">x25_neigh</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x25_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x25_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">neighbour</span> <span class="o">==</span> <span class="n">nb</span><span class="p">)</span>
			<span class="n">x25_disconnect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ENETUNREACH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_list_lock</span><span class="p">);</span>

	<span class="cm">/* Remove any related forwards */</span>
	<span class="n">x25_clear_forward_by_dev</span><span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">x25_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_family_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_proto</span><span class="p">;</span>

	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_packet_type</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_dev_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sock</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;X.25 for Linux Version 0.2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x25_register_sysctl</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">x25_proc_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">out_dev:</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_dev_notifier</span><span class="p">);</span>
<span class="nl">out_sock:</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">AF_X25</span><span class="p">);</span>
<span class="nl">out_proto:</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_proto</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">x25_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">x25_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">x25_proc_exit</span><span class="p">();</span>
	<span class="n">x25_link_free</span><span class="p">();</span>
	<span class="n">x25_route_free</span><span class="p">();</span>

	<span class="n">x25_unregister_sysctl</span><span class="p">();</span>

	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_dev_notifier</span><span class="p">);</span>

	<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_packet_type</span><span class="p">);</span>

	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">AF_X25</span><span class="p">);</span>
	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_proto</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">x25_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jonathan Naylor &lt;g4klx@g4klx.demon.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;The X.25 Packet Layer network layer protocol&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_X25</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
