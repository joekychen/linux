<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › xt_hashlimit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xt_hashlimit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	xt_hashlimit - Netfilter module to limit the number of packets per time</span>
<span class="cm"> *	separately for each hashbucket (sourceip/sourceport/dstip/dstport)</span>
<span class="cm"> *</span>
<span class="cm"> *	(C) 2003-2004 by Harald Welte &lt;laforge@netfilter.org&gt;</span>
<span class="cm"> *	Copyright © CC Computer Consultants GmbH, 2007 - 2008</span>
<span class="cm"> *</span>
<span class="cm"> * Development of this code was funded by Astaro AG, http://www.astaro.com/</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/netns/generic.h&gt;</span>

<span class="cp">#include &lt;linux/netfilter/x_tables.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv6/ip6_tables.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/xt_hashlimit.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Harald Welte &lt;laforge@netfilter.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jan Engelhardt &lt;jengelh@medozas.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xtables: per hash-bucket rate-limit match&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ipt_hashlimit&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ip6t_hashlimit&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span>	<span class="n">htables</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">ipt_hashlimit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">ip6t_hashlimit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hashlimit_net_id</span><span class="p">;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="nf">hashlimit_pernet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">hashlimit_net_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* need to declare this at the top */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dl_file_ops</span><span class="p">;</span>

<span class="cm">/* hash table crap */</span>
<span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">src</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">dst</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ip</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">__be32</span> <span class="n">dst</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">ip6</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">};</span>
	<span class="n">__be16</span> <span class="n">src_port</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dst_port</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="p">{</span>
	<span class="cm">/* static / read-only parts in the beginning */</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="n">dst</span><span class="p">;</span>

	<span class="cm">/* modified structure members in the end */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">;</span>		<span class="cm">/* precalculated expiry time */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prev</span><span class="p">;</span>	<span class="cm">/* last modification */</span>
		<span class="n">u_int32_t</span> <span class="n">credit</span><span class="p">;</span>
		<span class="n">u_int32_t</span> <span class="n">credit_cap</span><span class="p">,</span> <span class="n">cost</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rateinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">node</span><span class="p">;</span>		<span class="cm">/* global list of all htables */</span>
	<span class="kt">int</span> <span class="n">use</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rnd_initialized</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hashlimit_cfg1</span> <span class="n">cfg</span><span class="p">;</span>	<span class="cm">/* config */</span>

	<span class="cm">/* used internally */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>		<span class="cm">/* lock for list_head */</span>
	<span class="n">u_int32_t</span> <span class="n">rnd</span><span class="p">;</span>			<span class="cm">/* random seed for hash */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* number entries in table */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* timer for gc */</span>

	<span class="cm">/* seq_file stuff */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* hashtable itself */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">hashlimit_mutex</span><span class="p">);</span>	<span class="cm">/* protects htables list */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">hashlimit_cachep</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">dst_cmp</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int32_t</span>
<span class="nf">hash_dst</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">jhash2</span><span class="p">((</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				<span class="n">ht</span><span class="o">-&gt;</span><span class="n">rnd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Instead of returning hash % ht-&gt;cfg.size (implying a divide)</span>
<span class="cm">	 * we return the high 32 bits of the (hash * ht-&gt;cfg.size) that will</span>
<span class="cm">	 * give results between [0 and cfg.size-1] and same hash distribution,</span>
<span class="cm">	 * but using a multiply, less expensive than a divide</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">hash</span> <span class="o">*</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span>
<span class="nf">dsthash_find</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
	     <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash_dst</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="n">hash</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dst_cmp</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allocate dsthash_ent, initialize dst, put in htable and lock it */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span>
<span class="nf">dsthash_alloc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* initialize hash with random val at the time we allocate</span>
<span class="cm">	 * the first hashtable entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">rnd_initialized</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">rnd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">rnd</span><span class="p">));</span>
		<span class="n">ht</span><span class="o">-&gt;</span><span class="n">rnd_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: do something. question is what.. */</span>
		<span class="n">net_err_ratelimited</span><span class="p">(</span><span class="s">&quot;max count of %u reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">hashlimit_cachep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">));</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">hlist_add_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="n">hash_dst</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">dst</span><span class="p">)]);</span>
		<span class="n">ht</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsthash_free_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsthash_ent</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">hashlimit_cachep</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dsthash_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hlist_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">call_rcu_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">dsthash_free_rcu</span><span class="p">);</span>
	<span class="n">ht</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">htable_gc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">htlong</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htable_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
			 <span class="n">u_int8_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalram_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16384</span> <span class="o">/</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">totalram_pages</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME: don&#39;t use vmalloc() here or anywhere else -HW */</span>
	<span class="n">hinfo</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span><span class="p">)</span> <span class="o">+</span>
	                <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">hinfo</span> <span class="o">=</span> <span class="n">hinfo</span><span class="p">;</span>

	<span class="cm">/* copy match config into hashtable config */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">));</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">rnd_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">NFPROTO_IPV4</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ipt_hashlimit</span> <span class="o">:</span> <span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ip6t_hashlimit</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dl_file_ops</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">hinfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">htable_gc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hinfo</span><span class="p">);</span>
	<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gc_interval</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">htables</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">select_all</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">he</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">select_gc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">he</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">he</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htable_selective_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
			<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">select</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">he</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* lock hash table and iterate over it */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">dh</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">dh</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">select</span><span class="p">)(</span><span class="n">ht</span><span class="p">,</span> <span class="n">dh</span><span class="p">))</span>
				<span class="n">dsthash_free</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">dh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hash table garbage collector, run by timer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">htable_gc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">htlong</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="p">)</span><span class="n">htlong</span><span class="p">;</span>

	<span class="n">htable_selective_cleanup</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">select_gc</span><span class="p">);</span>

	<span class="cm">/* re-add the timer accordingly */</span>
	<span class="n">ht</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gc_interval</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htable_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">NFPROTO_IPV4</span><span class="p">)</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ipt_hashlimit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ip6t_hashlimit</span><span class="p">;</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">pde</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="n">htable_selective_cleanup</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="n">select_all</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">hinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="nf">htable_find_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
						   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						   <span class="n">u_int8_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">htables</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">pde</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">family</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">use</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">hinfo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htable_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">htable_destroy</span><span class="p">(</span><span class="n">hinfo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The algorithm used is the Simple Token Bucket Filter (TBF)</span>
<span class="cm"> * see net/sched/sch_tbf.c in the linux source tree</span>
<span class="cm"> */</span>

<span class="cm">/* Rusty: This is my (non-mathematically-inclined) understanding of</span>
<span class="cm">   this algorithm.  The `average rate&#39; in jiffies becomes your initial</span>
<span class="cm">   amount of credit `credit&#39; and the most credit you can ever have</span>
<span class="cm">   `credit_cap&#39;.  The `peak rate&#39; becomes the cost of passing the</span>
<span class="cm">   test, `cost&#39;.</span>

<span class="cm">   `prev&#39; tracks the last packet hit: you gain one credit per jiffy.</span>
<span class="cm">   If you get credit balance more than this, the extra credit is</span>
<span class="cm">   discarded.  Every time the match passes, you lose `cost&#39; credits;</span>
<span class="cm">   if you don&#39;t have that many, the test fails.</span>

<span class="cm">   See Alexey&#39;s formal explanation in net/sched/sch_tbf.c.</span>

<span class="cm">   To get the maximum range, we multiply by this factor (ie. you get N</span>
<span class="cm">   credits per jiffy).  We want to allow a rate as low as 1 per day</span>
<span class="cm">   (slowest userspace tool allows), which means</span>
<span class="cm">   CREDITS_PER_JIFFY*HZ*60*60*24 &lt; 2^32 ie.</span>
<span class="cm">*/</span>
<span class="cp">#define MAX_CPJ (0xFFFFFFFF / (HZ*60*60*24))</span>

<span class="cm">/* Repeated shift and or gives us all 1s, final shift and add 1 gives</span>
<span class="cm"> * us the power of 2 below the theoretical max, so GCC simply does a</span>
<span class="cm"> * shift. */</span>
<span class="cp">#define _POW2_BELOW2(x) ((x)|((x)&gt;&gt;1))</span>
<span class="cp">#define _POW2_BELOW4(x) (_POW2_BELOW2(x)|_POW2_BELOW2((x)&gt;&gt;2))</span>
<span class="cp">#define _POW2_BELOW8(x) (_POW2_BELOW4(x)|_POW2_BELOW4((x)&gt;&gt;4))</span>
<span class="cp">#define _POW2_BELOW16(x) (_POW2_BELOW8(x)|_POW2_BELOW8((x)&gt;&gt;8))</span>
<span class="cp">#define _POW2_BELOW32(x) (_POW2_BELOW16(x)|_POW2_BELOW16((x)&gt;&gt;16))</span>
<span class="cp">#define POW2_BELOW32(x) ((_POW2_BELOW32(x)&gt;&gt;1) + 1)</span>

<span class="cp">#define CREDITS_PER_JIFFY POW2_BELOW32(MAX_CPJ)</span>

<span class="cm">/* in byte mode, the lowest possible rate is one packet/second.</span>
<span class="cm"> * credit_cap is used as a counter that tells us how many times we can</span>
<span class="cm"> * refill the &quot;credits available&quot; counter when it becomes empty.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_CPJ_BYTES (0xFFFFFFFF / HZ)</span>
<span class="cp">#define CREDITS_PER_JIFFY_BYTES POW2_BELOW32(MAX_CPJ_BYTES)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">xt_hashlimit_len_to_chunks</span><span class="p">(</span><span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">XT_HASHLIMIT_BYTE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Precision saver. */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">user2credits</span><span class="p">(</span><span class="n">u32</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If multiplying would overflow... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFFFF</span> <span class="o">/</span> <span class="p">(</span><span class="n">HZ</span><span class="o">*</span><span class="n">CREDITS_PER_JIFFY</span><span class="p">))</span>
		<span class="cm">/* Divide first. */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">user</span> <span class="o">/</span> <span class="n">XT_HASHLIMIT_SCALE</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">CREDITS_PER_JIFFY</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">user</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">CREDITS_PER_JIFFY</span><span class="p">)</span> <span class="o">/</span> <span class="n">XT_HASHLIMIT_SCALE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">user2credits_byte</span><span class="p">(</span><span class="n">u32</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">us</span> <span class="o">=</span> <span class="n">user</span><span class="p">;</span>
	<span class="n">us</span> <span class="o">*=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">us</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rateinfo_recalc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span><span class="p">;</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">+=</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* overflow */</span>
			<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">CREDITS_PER_JIFFY</span><span class="p">;</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">)</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rateinfo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">dh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">=</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span> <span class="o">=</span> <span class="n">user2credits_byte</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">);</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span> <span class="o">=</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">burst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">=</span> <span class="n">user2credits</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span> <span class="o">*</span>
						   <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">burst</span><span class="p">);</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span> <span class="o">=</span> <span class="n">user2credits</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">);</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span> <span class="o">=</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span> <span class="nf">maskl</span><span class="p">(</span><span class="n">__be32</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">l</span> <span class="o">?</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">l</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hashlimit_ipv6_mask</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span> <span class="p">...</span> <span class="mi">31</span>:
		<span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span> <span class="p">...</span> <span class="mi">63</span>:
		<span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span> <span class="p">...</span> <span class="mi">95</span>:
		<span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96</span> <span class="p">...</span> <span class="mi">127</span>:
		<span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">96</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hashlimit_init_dst</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="n">_ports</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nexthdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFPROTO_IPV4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_DIP</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
			              <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">dstmask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_SIP</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">maskl</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
			              <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">srcmask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">XT_HASHLIMIT_HASH_DPT</span> <span class="o">|</span> <span class="n">XT_HASHLIMIT_HASH_SPT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nexthdr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
	<span class="k">case</span> <span class="n">NFPROTO_IPV6</span>:
	<span class="p">{</span>
		<span class="n">__be16</span> <span class="n">frag_off</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_DIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">dst</span><span class="p">));</span>
			<span class="n">hashlimit_ipv6_mask</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">dstmask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_SIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">src</span><span class="p">));</span>
			<span class="n">hashlimit_ipv6_mask</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip6</span><span class="p">.</span><span class="n">src</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">srcmask</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">XT_HASHLIMIT_HASH_DPT</span> <span class="o">|</span> <span class="n">XT_HASHLIMIT_HASH_SPT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nexthdr</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>
		<span class="n">protoff</span> <span class="o">=</span> <span class="n">ipv6_skip_exthdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">nexthdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frag_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">protoff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">poff</span> <span class="o">=</span> <span class="n">proto_ports_offset</span><span class="p">(</span><span class="n">nexthdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span> <span class="o">+</span> <span class="n">poff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_ports</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">_ports</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="n">_ports</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ports</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_SPT</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">src_port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_HASH_DPT</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">dst_port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hashlimit_byte_cost</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">dh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">xt_hashlimit_len_to_chunks</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">&lt;</span> <span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">=</span> <span class="n">CREDITS_PER_JIFFY_BYTES</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">hashlimit_mt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_action_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">matchinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">hinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">dh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsthash_dst</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hashlimit_init_dst</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">thoff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">hotdrop</span><span class="p">;</span>

	<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
	<span class="n">dh</span> <span class="o">=</span> <span class="n">dsthash_find</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dh</span> <span class="o">=</span> <span class="n">dsthash_alloc_init</span><span class="p">(</span><span class="n">hinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">hotdrop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
		<span class="n">rateinfo_init</span><span class="p">(</span><span class="n">dh</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* update expiration timeout */</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">expire</span><span class="p">);</span>
		<span class="n">rateinfo_recalc</span><span class="p">(</span><span class="n">dh</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hinfo</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_BYTES</span><span class="p">)</span>
		<span class="n">cost</span> <span class="o">=</span> <span class="n">hashlimit_byte_cost</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dh</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cost</span> <span class="o">=</span> <span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">&gt;=</span> <span class="n">cost</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* below the limit */</span>
		<span class="n">dh</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span> <span class="o">-=</span> <span class="n">cost</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_INVERT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
	<span class="cm">/* default match is underlimit - so over the limit, we need to invert */</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_INVERT</span><span class="p">;</span>

 <span class="nl">hotdrop:</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hotdrop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hashlimit_mt_check</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_mtchk_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">matchinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gc_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">expire</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">NFPROTO_IPV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">srcmask</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">dstmask</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">srcmask</span> <span class="o">&gt;</span> <span class="mi">128</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">dstmask</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XT_HASHLIMIT_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown mode mask %X, kernel too old?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for overflow. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">XT_HASHLIMIT_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user2credits_byte</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;overflow, rate too high: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">burst</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">user2credits</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">burst</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">user2credits</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;overflow, try lower: %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">burst</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_mutex</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">hinfo</span> <span class="o">=</span> <span class="n">htable_find_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">htable_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hashlimit_mt_destroy</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_mtdtor_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">matchinfo</span><span class="p">;</span>

	<span class="n">htable_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xt_match</span> <span class="n">hashlimit_mt_reg</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;hashlimit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">revision</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">family</span>         <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">match</span>          <span class="o">=</span> <span class="n">hashlimit_mt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matchsize</span>      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">checkentry</span>     <span class="o">=</span> <span class="n">hashlimit_mt_check</span><span class="p">,</span>
		<span class="p">.</span><span class="n">destroy</span>        <span class="o">=</span> <span class="n">hashlimit_mt_destroy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>             <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;hashlimit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">revision</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">family</span>         <span class="o">=</span> <span class="n">NFPROTO_IPV6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">match</span>          <span class="o">=</span> <span class="n">hashlimit_mt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matchsize</span>      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_hashlimit_mtinfo1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">checkentry</span>     <span class="o">=</span> <span class="n">hashlimit_mt_check</span><span class="p">,</span>
		<span class="p">.</span><span class="n">destroy</span>        <span class="o">=</span> <span class="n">hashlimit_mt_destroy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>             <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* PROC stuff */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dl_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">htable</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bucket</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">htable</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bucket</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bucket</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bucket</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bucket</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dl_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">htable</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">bucket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">htable</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bucket</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dl_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">htable</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bucket</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bucket</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dl_seq_real_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="n">u_int8_t</span> <span class="n">family</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">ht</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* recalculate to show accurate numbers */</span>
	<span class="n">rateinfo_recalc</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFPROTO_IPV4</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%ld %pI4:%u-&gt;%pI4:%u %u %u %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span><span class="p">,</span>
				 <span class="n">ntohs</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">src_port</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span>
				 <span class="n">ntohs</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dst_port</span><span class="p">),</span>
				 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span><span class="p">,</span>
				 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
	<span class="k">case</span> <span class="n">NFPROTO_IPV6</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%ld %pI6:%u-&gt;%pI6:%u %u %u %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">ip6</span><span class="p">.</span><span class="n">src</span><span class="p">,</span>
				 <span class="n">ntohs</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">src_port</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">ip6</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span>
				 <span class="n">ntohs</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dst_port</span><span class="p">),</span>
				 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">credit_cap</span><span class="p">,</span>
				 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">rateinfo</span><span class="p">.</span><span class="n">cost</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dl_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_hashlimit_htable</span> <span class="o">*</span><span class="n">htable</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsthash_ent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="o">*</span><span class="n">bucket</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">htable</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">[</span><span class="o">*</span><span class="n">bucket</span><span class="p">],</span> <span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dl_seq_real_show</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">htable</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">dl_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">dl_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>  <span class="o">=</span> <span class="n">dl_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>  <span class="o">=</span> <span class="n">dl_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">dl_seq_show</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dl_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dl_seq_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">sf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">sf</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dl_file_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">dl_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">hashlimit_proc_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ipt_hashlimit</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;ipt_hashlimit&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ipt_hashlimit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
	<span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ip6t_hashlimit</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;ip6t_hashlimit&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">ip6t_hashlimit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;ipt_hashlimit&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">hashlimit_proc_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;ipt_hashlimit&quot;</span><span class="p">);</span>
<span class="cp">#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;ip6t_hashlimit&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">hashlimit_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">htables</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hashlimit_proc_net_init</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">hashlimit_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hashlimit_net</span> <span class="o">*</span><span class="n">hashlimit_net</span> <span class="o">=</span> <span class="n">hashlimit_pernet</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_net</span><span class="o">-&gt;</span><span class="n">htables</span><span class="p">));</span>
	<span class="n">hashlimit_proc_net_exit</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">hashlimit_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>	<span class="o">=</span> <span class="n">hashlimit_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>	<span class="o">=</span> <span class="n">hashlimit_net_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hashlimit_net_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashlimit_net</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hashlimit_mt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xt_register_matches</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">,</span>
	      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hashlimit_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;xt_hashlimit&quot;</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsthash_ent</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hashlimit_cachep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unable to create slab cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">xt_unregister_matches</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">));</span>
<span class="nl">err1:</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_net_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hashlimit_mt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xt_unregister_matches</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hashlimit_mt_reg</span><span class="p">));</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashlimit_net_ops</span><span class="p">);</span>

	<span class="n">rcu_barrier_bh</span><span class="p">();</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">hashlimit_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hashlimit_mt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hashlimit_mt_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
