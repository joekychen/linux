<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › nf_conntrack_pptp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nf_conntrack_pptp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Connection tracking support for PPTP (Point to Point Tunneling Protocol).</span>
<span class="cm"> * PPTP is a a protocol for creating virtual private networks.</span>
<span class="cm"> * It is a specification defined by Microsoft and some vendors</span>
<span class="cm"> * working with Microsoft.  PPTP is built on top of a modified</span>
<span class="cm"> * version of the Internet Generic Routing Encapsulation Protocol.</span>
<span class="cm"> * GRE is defined in RFC 1701 and RFC 1702.  Documentation of</span>
<span class="cm"> * PPTP can be found in RFC 2637</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2000-2005 by Harald Welte &lt;laforge@gnumonks.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Development of this code funded by Astaro AG (http://www.astaro.com/)</span>
<span class="cm"> *</span>
<span class="cm"> * Limitations:</span>
<span class="cm"> * 	 - We blindly assume that control connections are always</span>
<span class="cm"> * 	   established in PNS-&gt;PAC direction.  This is a violation</span>
<span class="cm"> * 	   of RFFC2673</span>
<span class="cm"> * 	 - We can only support one single call within each session</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *	 - testing of incoming PPTP calls</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>

<span class="cp">#include &lt;net/netfilter/nf_conntrack.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_core.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_helper.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_zones.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nf_conntrack_proto_gre.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nf_conntrack_pptp.h&gt;</span>

<span class="cp">#define NF_CT_PPTP_VERSION &quot;3.1&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Harald Welte &lt;laforge@gnumonks.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Netfilter connection tracking helper module for PPTP&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ip_conntrack_pptp&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NFCT_HELPER</span><span class="p">(</span><span class="s">&quot;pptp&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">nf_pptp_lock</span><span class="p">);</span>

<span class="kt">int</span>
<span class="p">(</span><span class="o">*</span><span class="n">nf_nat_pptp_hook_outbound</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">PptpControlHeader</span> <span class="o">*</span><span class="n">ctlh</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">pptp_ctrl_union</span> <span class="o">*</span><span class="n">pptpReq</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_outbound</span><span class="p">);</span>

<span class="kt">int</span>
<span class="p">(</span><span class="o">*</span><span class="n">nf_nat_pptp_hook_inbound</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">PptpControlHeader</span> <span class="o">*</span><span class="n">ctlh</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">pptp_ctrl_union</span> <span class="o">*</span><span class="n">pptpReq</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_inbound</span><span class="p">);</span>

<span class="kt">void</span>
<span class="p">(</span><span class="o">*</span><span class="n">nf_nat_pptp_hook_exp_gre</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">expect_orig</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">expect_reply</span><span class="p">)</span>
			    <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_exp_gre</span><span class="p">);</span>

<span class="kt">void</span>
<span class="p">(</span><span class="o">*</span><span class="n">nf_nat_pptp_hook_expectfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_expectfn</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG) || defined(CONFIG_DYNAMIC_DEBUG)</span>
<span class="cm">/* PptpControlMessageType names */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">pptp_msg_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;UNKNOWN_MESSAGE&quot;</span><span class="p">,</span>
	<span class="s">&quot;START_SESSION_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;START_SESSION_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;STOP_SESSION_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;STOP_SESSION_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;ECHO_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;ECHO_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;OUT_CALL_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;OUT_CALL_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;IN_CALL_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;IN_CALL_REPLY&quot;</span><span class="p">,</span>
	<span class="s">&quot;IN_CALL_CONNECT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CALL_CLEAR_REQUEST&quot;</span><span class="p">,</span>
	<span class="s">&quot;CALL_DISCONNECT_NOTIFY&quot;</span><span class="p">,</span>
	<span class="s">&quot;WAN_ERROR_NOTIFY&quot;</span><span class="p">,</span>
	<span class="s">&quot;SET_LINK_INFO&quot;</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pptp_msg_name</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define SECS *HZ</span>
<span class="cp">#define MINS * 60 SECS</span>
<span class="cp">#define HOURS * 60 MINS</span>

<span class="cp">#define PPTP_GRE_TIMEOUT 		(10 MINS)</span>
<span class="cp">#define PPTP_GRE_STREAM_TIMEOUT 	(5 HOURS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pptp_expectfn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">nf_ct_net</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_expectfn</span><span class="p">)</span> <span class="n">nf_nat_pptp_expectfn</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;increasing timeouts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* increase timeout of GRE data channel conntrack entry */</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">timeout</span>	     <span class="o">=</span> <span class="n">PPTP_GRE_TIMEOUT</span><span class="p">;</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">stream_timeout</span> <span class="o">=</span> <span class="n">PPTP_GRE_STREAM_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* Can you see how rusty this code is, compared with the pre-2.6.11</span>
<span class="cm">	 * one? That&#39;s what happened to my shiny newnat of 2002 ;( -HW */</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">nf_nat_pptp_expectfn</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_expectfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_nat_pptp_expectfn</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
		<span class="n">nf_nat_pptp_expectfn</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="n">inv_t</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp_other</span><span class="p">;</span>

		<span class="cm">/* obviously this tuple inversion only works until you do NAT */</span>
		<span class="n">nf_ct_invert_tuplepr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inv_t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;trying to unexpect other dir: &quot;</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inv_t</span><span class="p">);</span>

		<span class="n">exp_other</span> <span class="o">=</span> <span class="n">nf_ct_expect_find_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nf_ct_zone</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">inv_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp_other</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* delete other expectation.  */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nf_ct_unexpect_related</span><span class="p">(</span><span class="n">exp_other</span><span class="p">);</span>
			<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp_other</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">destroy_sibling_or_exp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple_hash</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">sibling</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">nf_ct_zone</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;trying to timeout ct or exp for tuple &quot;</span><span class="p">);</span>
	<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">nf_conntrack_find_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">sibling</span> <span class="o">=</span> <span class="n">nf_ct_tuplehash_to_ctrack</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setting timeout of conntrack %p to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sibling</span><span class="p">);</span>
		<span class="n">sibling</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">timeout</span>	  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sibling</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">stream_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">))</span>
			<span class="n">sibling</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sibling</span><span class="p">);</span>
		<span class="n">nf_ct_put</span><span class="p">(</span><span class="n">sibling</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_find_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unexpect_related of expect %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
			<span class="n">nf_ct_unexpect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
			<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* timeout GRE data connections */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pptp_destroy_siblings</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">nf_ct_net</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conn_help</span> <span class="o">*</span><span class="n">help</span> <span class="o">=</span> <span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">nf_ct_gre_keymap_destroy</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>

	<span class="cm">/* try original (pns-&gt;pac) tuple */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">].</span><span class="n">tuple</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
	<span class="n">t</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span> <span class="o">=</span> <span class="n">IPPROTO_GRE</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">help</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">.</span><span class="n">pns_call_id</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">help</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">.</span><span class="n">pac_call_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">destroy_sibling_or_exp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to timeout original pns-&gt;pac ct/exp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* try reply (pac-&gt;pns) tuple */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">IP_CT_DIR_REPLY</span><span class="p">].</span><span class="n">tuple</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
	<span class="n">t</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span> <span class="o">=</span> <span class="n">IPPROTO_GRE</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">help</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">.</span><span class="n">pac_call_id</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gre</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">help</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">.</span><span class="n">pns_call_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">destroy_sibling_or_exp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to timeout reply pac-&gt;pns ct/exp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* expect GRE connections (PNS-&gt;PAC and PAC-&gt;PNS direction) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">exp_gre</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">callid</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">peer_callid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp_orig</span><span class="p">,</span> <span class="o">*</span><span class="n">exp_reply</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_exp_gre</span><span class="p">)</span> <span class="n">nf_nat_pptp_exp_gre</span><span class="p">;</span>

	<span class="n">exp_orig</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp_orig</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">exp_reply</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp_reply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_orig</span><span class="p">;</span>

	<span class="cm">/* original direction, PNS-&gt;PAC */</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp_orig</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span>
			  <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_GRE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_callid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callid</span><span class="p">);</span>
	<span class="n">exp_orig</span><span class="o">-&gt;</span><span class="n">expectfn</span> <span class="o">=</span> <span class="n">pptp_expectfn</span><span class="p">;</span>

	<span class="cm">/* reply direction, PAC-&gt;PNS */</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">IP_CT_DIR_REPLY</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp_reply</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span>
			  <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_GRE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_callid</span><span class="p">);</span>
	<span class="n">exp_reply</span><span class="o">-&gt;</span><span class="n">expectfn</span> <span class="o">=</span> <span class="n">pptp_expectfn</span><span class="p">;</span>

	<span class="n">nf_nat_pptp_exp_gre</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_exp_gre</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_nat_pptp_exp_gre</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
		<span class="n">nf_nat_pptp_exp_gre</span><span class="p">(</span><span class="n">exp_orig</span><span class="p">,</span> <span class="n">exp_reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp_orig</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_both</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp_reply</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unexpect_orig</span><span class="p">;</span>

	<span class="cm">/* Add GRE keymap entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_gre_keymap_add</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp_orig</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unexpect_both</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_gre_keymap_add</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">IP_CT_DIR_REPLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exp_reply</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf_ct_gre_keymap_destroy</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unexpect_both</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_put_both:</span>
	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp_reply</span><span class="p">);</span>
<span class="nl">out_put_orig:</span>
	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp_orig</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out_unexpect_both:</span>
	<span class="n">nf_ct_unexpect_related</span><span class="p">(</span><span class="n">exp_reply</span><span class="p">);</span>
<span class="nl">out_unexpect_orig:</span>
	<span class="n">nf_ct_unexpect_related</span><span class="p">(</span><span class="n">exp_orig</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_put_both</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">pptp_inbound_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">PptpControlHeader</span> <span class="o">*</span><span class="n">ctlh</span><span class="p">,</span>
		 <span class="k">union</span> <span class="n">pptp_ctrl_union</span> <span class="o">*</span><span class="n">pptpReq</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		 <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_pptp_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pcid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_inbound</span><span class="p">)</span> <span class="n">nf_nat_pptp_inbound</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ctlh</span><span class="o">-&gt;</span><span class="n">messageType</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;inbound control message %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPTP_START_SESSION_REPLY</span>:
		<span class="cm">/* server confirms new control session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">&lt;</span> <span class="n">PPTP_SESSION_REQUESTED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">srep</span><span class="p">.</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">PPTP_START_OK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_STOP_SESSION_REPLY</span>:
		<span class="cm">/* server confirms end of control session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">&gt;</span> <span class="n">PPTP_SESSION_STOPREQ</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">strep</span><span class="p">.</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">PPTP_STOP_OK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_NONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_OUT_CALL_REPLY</span>:
		<span class="cm">/* server accepted call, we now expect GRE frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_OUT_REQ</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_OUT_CONF</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="n">cid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">ocack</span><span class="p">.</span><span class="n">callID</span><span class="p">;</span>
		<span class="n">pcid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">ocack</span><span class="p">.</span><span class="n">peersCallID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span> <span class="o">!=</span> <span class="n">pcid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, CID=%X, PCID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pcid</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">ocack</span><span class="p">.</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">PPTP_OUTCALL_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_OUT_CONF</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
			<span class="n">exp_gre</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">pcid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_IN_CALL_REQUEST</span>:
		<span class="cm">/* server tells us about incoming call request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="n">cid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">icreq</span><span class="p">.</span><span class="n">callID</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, CID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_IN_REQ</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_IN_CALL_CONNECT</span>:
		<span class="cm">/* server tells us about incoming call established */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_IN_REP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_IN_CONF</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="n">pcid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">iccon</span><span class="p">.</span><span class="n">peersCallID</span><span class="p">;</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span> <span class="o">!=</span> <span class="n">pcid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, PCID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pcid</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_IN_CONF</span><span class="p">;</span>

		<span class="cm">/* we expect a GRE connection from PAC to PNS */</span>
		<span class="n">exp_gre</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">pcid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_CALL_DISCONNECT_NOTIFY</span>:
		<span class="cm">/* server confirms disconnect */</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">callID</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, CID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_NONE</span><span class="p">;</span>

		<span class="cm">/* untrack this call id, unexpect GRE packets */</span>
		<span class="n">pptp_destroy_siblings</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_WAN_ERROR_NOTIFY</span>:
	<span class="k">case</span> <span class="n">PPTP_SET_LINK_INFO</span>:
	<span class="k">case</span> <span class="n">PPTP_ECHO_REQUEST</span>:
	<span class="k">case</span> <span class="n">PPTP_ECHO_REPLY</span>:
		<span class="cm">/* I don&#39;t have to explain these ;) */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_nat_pptp_inbound</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_inbound</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_nat_pptp_inbound</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nf_nat_pptp_inbound</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">ctlh</span><span class="p">,</span> <span class="n">pptpReq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

<span class="nl">invalid:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid %s: type=%d cid=%u pcid=%u &quot;</span>
		 <span class="s">&quot;cstate=%d sstate=%d pns_cid=%u pac_cid=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">msg</span> <span class="o">&lt;=</span> <span class="n">PPTP_MSG_MAX</span> <span class="o">?</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span> <span class="o">:</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">msg</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pcid</span><span class="p">),</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span><span class="p">,</span>
		 <span class="n">ntohs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">pptp_outbound_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">PptpControlHeader</span> <span class="o">*</span><span class="n">ctlh</span><span class="p">,</span>
		  <span class="k">union</span> <span class="n">pptp_ctrl_union</span> <span class="o">*</span><span class="n">pptpReq</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_pptp_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pcid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_outbound</span><span class="p">)</span> <span class="n">nf_nat_pptp_outbound</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ctlh</span><span class="o">-&gt;</span><span class="n">messageType</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;outbound control message %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPTP_START_SESSION_REQUEST</span>:
		<span class="cm">/* client requests for new control session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_NONE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_REQUESTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_STOP_SESSION_REQUEST</span>:
		<span class="cm">/* client requests end of control session */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">=</span> <span class="n">PPTP_SESSION_STOPREQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_OUT_CALL_REQUEST</span>:
		<span class="cm">/* client initiating connection to server */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_OUT_REQ</span><span class="p">;</span>
		<span class="cm">/* track PNS call id */</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">ocreq</span><span class="p">.</span><span class="n">callID</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, CID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_IN_CALL_REPLY</span>:
		<span class="cm">/* client answers incoming call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_IN_REQ</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">!=</span> <span class="n">PPTP_CALL_IN_REP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

		<span class="n">cid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">icack</span><span class="p">.</span><span class="n">callID</span><span class="p">;</span>
		<span class="n">pcid</span> <span class="o">=</span> <span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">icack</span><span class="p">.</span><span class="n">peersCallID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span> <span class="o">!=</span> <span class="n">pcid</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, CID=%X PCID=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">],</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pcid</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pptpReq</span><span class="o">-&gt;</span><span class="n">icack</span><span class="p">.</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">PPTP_INCALL_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* part two of the three-way handshake */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_IN_REP</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_CALL_CLEAR_REQUEST</span>:
		<span class="cm">/* client requests hangup of call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span> <span class="o">!=</span> <span class="n">PPTP_SESSION_CONFIRMED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
		<span class="cm">/* FUTURE: iterate over all calls and check if</span>
<span class="cm">		 * call ID is valid.  We don&#39;t do this without newnat,</span>
<span class="cm">		 * because we only know about last call */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span> <span class="o">=</span> <span class="n">PPTP_CALL_CLEAR_REQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPTP_SET_LINK_INFO</span>:
	<span class="k">case</span> <span class="n">PPTP_ECHO_REQUEST</span>:
	<span class="k">case</span> <span class="n">PPTP_ECHO_REPLY</span>:
		<span class="cm">/* I don&#39;t have to explain these ;) */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_nat_pptp_outbound</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nf_nat_pptp_hook_outbound</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nf_nat_pptp_outbound</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nf_nat_pptp_outbound</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">ctlh</span><span class="p">,</span> <span class="n">pptpReq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

<span class="nl">invalid:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid %s: type=%d cid=%u pcid=%u &quot;</span>
		 <span class="s">&quot;cstate=%d sstate=%d pns_cid=%u pac_cid=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">msg</span> <span class="o">&lt;=</span> <span class="n">PPTP_MSG_MAX</span> <span class="o">?</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span> <span class="o">:</span> <span class="n">pptp_msg_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">msg</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pcid</span><span class="p">),</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span><span class="p">,</span>
		 <span class="n">ntohs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pns_call_id</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pac_call_id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pptp_msg_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PPTP_START_SESSION_REQUEST</span><span class="p">]</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpStartSessionRequest</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_START_SESSION_REPLY</span><span class="p">]</span>    <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpStartSessionReply</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_STOP_SESSION_REQUEST</span><span class="p">]</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpStopSessionRequest</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_STOP_SESSION_REPLY</span><span class="p">]</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpStopSessionReply</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_OUT_CALL_REQUEST</span><span class="p">]</span>       <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpOutCallRequest</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_OUT_CALL_REPLY</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpOutCallReply</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_IN_CALL_REQUEST</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpInCallRequest</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_IN_CALL_REPLY</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpInCallReply</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_IN_CALL_CONNECT</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpInCallConnected</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_CALL_CLEAR_REQUEST</span><span class="p">]</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpClearCallRequest</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_CALL_DISCONNECT_NOTIFY</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpCallDisconnectNotify</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_WAN_ERROR_NOTIFY</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpWanErrorNotify</span><span class="p">),</span>
	<span class="p">[</span><span class="n">PPTP_SET_LINK_INFO</span><span class="p">]</span>	      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PptpSetLinkInfo</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* track caller id inside control connection, call expect_related */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">conntrack_pptp_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_ct_pptp_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_pptp_info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_tcph</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pptp_pkt_hdr</span> <span class="o">*</span><span class="n">pptph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pptp_pkt_hdr</span> <span class="n">_pptph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PptpControlHeader</span> <span class="n">_ctlh</span><span class="p">,</span> <span class="o">*</span><span class="n">ctlh</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pptp_ctrl_union</span> <span class="n">_pptpReq</span><span class="p">,</span> <span class="o">*</span><span class="n">pptpReq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">protoff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">,</span> <span class="n">nexthdr_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldsstate</span><span class="p">,</span> <span class="n">oldcstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/* don&#39;t do any tracking before tcp handshake complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED</span> <span class="o">&amp;&amp;</span> <span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED_REPLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="n">nexthdr_off</span> <span class="o">=</span> <span class="n">protoff</span><span class="p">;</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nexthdr_off</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_tcph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_tcph</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tcph</span><span class="p">);</span>
	<span class="n">nexthdr_off</span> <span class="o">+=</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">datalen</span> <span class="o">=</span> <span class="n">tcplen</span> <span class="o">-</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">pptph</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nexthdr_off</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_pptph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_pptph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pptph</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;no full PPTP header, can&#39;t track</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nexthdr_off</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_pptph</span><span class="p">);</span>
	<span class="n">datalen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_pptph</span><span class="p">);</span>

	<span class="cm">/* if it&#39;s not a control message we can&#39;t do anything with it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pptph</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PPTP_PACKET_CONTROL</span> <span class="o">||</span>
	    <span class="n">ntohl</span><span class="p">(</span><span class="n">pptph</span><span class="o">-&gt;</span><span class="n">magicCookie</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PPTP_MAGIC_COOKIE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;not a control packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctlh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nexthdr_off</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_ctlh</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_ctlh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlh</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="n">nexthdr_off</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_ctlh</span><span class="p">);</span>
	<span class="n">datalen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_ctlh</span><span class="p">);</span>

	<span class="n">reqlen</span> <span class="o">=</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ctlh</span><span class="o">-&gt;</span><span class="n">messageType</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span> <span class="o">&lt;=</span> <span class="n">PPTP_MSG_MAX</span> <span class="o">&amp;&amp;</span> <span class="n">reqlen</span> <span class="o">&lt;</span> <span class="n">pptp_msg_size</span><span class="p">[</span><span class="n">msg</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pptpReq</span><span class="p">))</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pptpReq</span><span class="p">);</span>

	<span class="n">pptpReq</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nexthdr_off</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_pptpReq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pptpReq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="n">oldsstate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span><span class="p">;</span>
	<span class="n">oldcstate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_pptp_lock</span><span class="p">);</span>

	<span class="cm">/* FIXME: We just blindly assume that the control connection is always</span>
<span class="cm">	 * established from PNS-&gt;PAC.  However, RFC makes no guarantee */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">)</span>
		<span class="cm">/* client -&gt; server (PNS -&gt; PAC) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pptp_outbound_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ctlh</span><span class="p">,</span> <span class="n">pptpReq</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span>
					<span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* server -&gt; client (PAC -&gt; PNS) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pptp_inbound_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ctlh</span><span class="p">,</span> <span class="n">pptpReq</span><span class="p">,</span> <span class="n">reqlen</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span>
				       <span class="n">ctinfo</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sstate: %d-&gt;%d, cstate: %d-&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">oldsstate</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sstate</span><span class="p">,</span> <span class="n">oldcstate</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cstate</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_pptp_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect_policy</span> <span class="n">pptp_exp_policy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">max_expected</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>	<span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* control protocol helper */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">pptp</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;pptp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">PPTP_CONTROL_PORT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">conntrack_pptp_help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>		<span class="o">=</span> <span class="n">pptp_destroy_siblings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pptp_exp_policy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nf_conntrack_pptp_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nf_ct_gre_keymap_flush</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">nf_conntrack_pptp_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">nf_conntrack_pptp_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nf_conntrack_pptp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pptp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_pptp_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pptp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nf_conntrack_pptp_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pptp</span><span class="p">);</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_pptp_net_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nf_conntrack_pptp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nf_conntrack_pptp_fini</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
