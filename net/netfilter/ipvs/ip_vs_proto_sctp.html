<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › ipvs › ip_vs_proto_sctp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ip_vs_proto_sctp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/sctp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4.h&gt;</span>
<span class="cp">#include &lt;net/sctp/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip_vs.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sctp_conn_schedule</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="o">*</span><span class="n">verdict</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">**</span><span class="n">cpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_vs_service</span> <span class="o">*</span><span class="n">svc</span><span class="p">;</span>
	<span class="n">sctp_chunkhdr_t</span> <span class="n">_schunkh</span><span class="p">,</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="n">sctp_sctphdr_t</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="n">_sctph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_vs_iphdr</span> <span class="n">iph</span><span class="p">;</span>

	<span class="n">ip_vs_fill_iphdr</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">iph</span><span class="p">);</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_sctph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_sctphdr_t</span><span class="p">),</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">_schunkh</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_schunkh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">net</span> <span class="o">=</span> <span class="n">skb_net</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">svc</span> <span class="o">=</span> <span class="n">ip_vs_service_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">,</span> <span class="n">iph</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">iph</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ignored</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ip_vs_todrop</span><span class="p">(</span><span class="n">net_ipvs</span><span class="p">(</span><span class="n">net</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * It seems that we are very loaded.</span>
<span class="cm">			 * We have to drop this packet :(</span>
<span class="cm">			 */</span>
			<span class="n">ip_vs_service_put</span><span class="p">(</span><span class="n">svc</span><span class="p">);</span>
			<span class="o">*</span><span class="n">verdict</span> <span class="o">=</span> <span class="n">NF_DROP</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Let the virtual server select a real server for the</span>
<span class="cm">		 * incoming connection, and create a connection entry.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">cpp</span> <span class="o">=</span> <span class="n">ip_vs_schedule</span><span class="p">(</span><span class="n">svc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ignored</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">cpp</span> <span class="o">&amp;&amp;</span> <span class="n">ignored</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignored</span><span class="p">)</span>
				<span class="o">*</span><span class="n">verdict</span> <span class="o">=</span> <span class="n">ip_vs_leave</span><span class="p">(</span><span class="n">svc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ip_vs_service_put</span><span class="p">(</span><span class="n">svc</span><span class="p">);</span>
				<span class="o">*</span><span class="n">verdict</span> <span class="o">=</span> <span class="n">NF_DROP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ip_vs_service_put</span><span class="p">(</span><span class="n">svc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* NF_ACCEPT */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sctp_snat_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ip_vs_protocol</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sctp_sctphdr_t</span> <span class="o">*</span><span class="n">sctph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctphoff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">crc32</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_VS_IPV6</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* csum_check requires unshared skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_make_writable</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sctphoff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sctph</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">app</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Some checks before mangling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">csum_check</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">csum_check</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Call application helper if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_vs_app_pkt_out</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sctph</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">sctphoff</span><span class="p">;</span>
	<span class="n">sctph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="cm">/* Calculate the checksum */</span>
	<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_start_cksum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sctph</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">sctphoff</span><span class="p">);</span>
	<span class="n">skb_walk_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span>
		<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_update_cksum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">iter</span><span class="p">),</span>
				          <span class="n">crc32</span><span class="p">);</span>
	<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_end_cksum</span><span class="p">(</span><span class="n">crc32</span><span class="p">);</span>
	<span class="n">sctph</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sctp_dnat_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ip_vs_protocol</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sctp_sctphdr_t</span> <span class="o">*</span><span class="n">sctph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctphoff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">crc32</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_VS_IPV6</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* csum_check requires unshared skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_make_writable</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sctphoff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sctph</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">app</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Some checks before mangling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">csum_check</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">csum_check</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Call application helper if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_vs_app_pkt_in</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sctph</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">sctphoff</span><span class="p">;</span>
	<span class="n">sctph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">;</span>

	<span class="cm">/* Calculate the checksum */</span>
	<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_start_cksum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sctph</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">sctphoff</span><span class="p">);</span>
	<span class="n">skb_walk_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span>
		<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_update_cksum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">iter</span><span class="p">),</span>
					  <span class="n">crc32</span><span class="p">);</span>
	<span class="n">crc32</span> <span class="o">=</span> <span class="n">sctp_end_cksum</span><span class="p">(</span><span class="n">crc32</span><span class="p">);</span>
	<span class="n">sctph</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sctp_csum_check</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_protocol</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctphoff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="n">_sctph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_VS_IPV6</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">sctphoff</span> <span class="o">=</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sctphoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_sctph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmp</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sctp_start_cksum</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sh</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">skb_walk_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">sctp_update_cksum</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">skb_headlen</span><span class="p">(</span><span class="n">iter</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">sctp_end_cksum</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">cmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CRC failure, dump it. */</span>
		<span class="n">IP_VS_DBG_RL_PKT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;Failed checksum for&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ipvs_sctp_nextstate</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">next_state</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">ipvs_sctp_event_t</span> <span class="p">{</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_ACK_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ECHO_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ECHO_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ACK_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_ABORT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE__ABORT_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_ACK_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_COM_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_COM_SER</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_LAST</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ipvs_sctp_event_t</span> <span class="n">sctp_events</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_INIT_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_ABORT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ECHO_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_COOKIE_ACK_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_DATA_CLI</span><span class="p">,</span>
	<span class="n">IP_VS_SCTP_EVE_SHUT_COM_CLI</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipvs_sctp_nextstate</span>
 <span class="n">sctp_states_table</span><span class="p">[</span><span class="n">IP_VS_SCTP_S_LAST</span><span class="p">][</span><span class="n">IP_VS_SCTP_EVE_LAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * STATE : IP_VS_SCTP_S_NONE</span>
<span class="cm">	 */</span>
	<span class="cm">/*next state *//*event */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">},</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * STATE : IP_VS_SCTP_S_INIT_CLI</span>
<span class="cm">	 * Cient sent INIT and is waiting for reply from server(In ECHO_WAIT)</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_INIT_SER</span>
<span class="cm">	 * Server sent INIT and waiting for INIT ACK from the client</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_INIT_ACK_CLI</span>
<span class="cm">	 * Client sent INIT ACK and waiting for ECHO from the server</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK has been resent by the client, let us stay is in</span>
<span class="cm">	  * the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * ECHO by client, it should not happen, close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * ECHO by server, this is what we are expecting, move to ECHO_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, it should not happen, close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Unexpected COOKIE ACK from server, staty in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_INIT_ACK_SER</span>
<span class="cm">	 * Server sent INIT ACK and waiting for ECHO from the client</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Unexpected INIT_ACK by the client, let us close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK resent by the server, let us move to same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client send the ECHO, this is what we are expecting,</span>
<span class="cm">	  * move to ECHO_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * ECHO received from the server, Not sure what to do,</span>
<span class="cm">	  * let us close it</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, let us stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from server, hmm... this should not happen, lets close</span>
<span class="cm">	  * the connection.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_ECHO_CLI</span>
<span class="cm">	 * Cient  sent ECHO and waiting COOKEI ACK from the Server</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK has been by the client, let us close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client resent the ECHO, let us stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * ECHO received from the server, Not sure what to do,</span>
<span class="cm">	  * let us close it</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, this shoud not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from server, this is what we are awaiting,lets move to</span>
<span class="cm">	  * ESTABLISHED.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_ECHO_SER</span>
<span class="cm">	 * Server sent ECHO and waiting COOKEI ACK from the client</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK has been by the server, let us close the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent the ECHO, not sure what to do, let&#39;s close the</span>
<span class="cm">	  * connection.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * ECHO resent by the server, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ECHO_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, this is what we are expecting, let&#39;s move</span>
<span class="cm">	  * to ESTABLISHED.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from server, this should not happen, lets close the</span>
<span class="cm">	  * connection.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_ESTABLISHED</span>
<span class="cm">	 * Association established</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent ECHO, Spec(sec 5.2.4) says it may be handled by the</span>
<span class="cm">	  * peer and peer shall move to the ESTABISHED. if it doesn&#39;t handle</span>
<span class="cm">	  * it will send ERROR chunk. So, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, not sure what to do stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN from the client, move to SHUDDOWN_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN from the server, move to SHUTDOWN_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * client sent SHUDTDOWN_ACK, this should not happen, let&#39;s close</span>
<span class="cm">	  * the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_SHUT_CLI</span>
<span class="cm">	 * SHUTDOWN sent from the client, waitinf for SHUT ACK from the server</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * We received the data chuck, keep the state unchanged. I assume</span>
<span class="cm">	 * that still data chuncks  can be received by both the peers in</span>
<span class="cm">	 * SHUDOWN state</span>
<span class="cm">	 */</span>

	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent ECHO, Spec(sec 5.2.4) says it may be handled by the</span>
<span class="cm">	  * peer and peer shall move to the ESTABISHED. if it doesn&#39;t handle</span>
<span class="cm">	  * it will send ERROR chunk. So, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, not sure what to do stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN resent from the client, move to SHUDDOWN_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN from the server, move to SHUTDOWN_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * client sent SHUDTDOWN_ACK, this should not happen, let&#39;s close</span>
<span class="cm">	  * the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Server sent SHUTDOWN ACK, this is what we are expecting, let&#39;s move</span>
<span class="cm">	  * to SHUDOWN_ACK_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COM from client, this should not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_SHUT_SER</span>
<span class="cm">	 * SHUTDOWN sent from the server, waitinf for SHUTDOWN ACK from client</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * We received the data chuck, keep the state unchanged. I assume</span>
<span class="cm">	 * that still data chuncks  can be received by both the peers in</span>
<span class="cm">	 * SHUDOWN state</span>
<span class="cm">	 */</span>

	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent ECHO, Spec(sec 5.2.4) says it may be handled by the</span>
<span class="cm">	  * peer and peer shall move to the ESTABISHED. if it doesn&#39;t handle</span>
<span class="cm">	  * it will send ERROR chunk. So, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, not sure what to do stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN resent from the client, move to SHUDDOWN_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN resent from the server, move to SHUTDOWN_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * client sent SHUDTDOWN_ACK, this is what we are expecting, let&#39;s</span>
<span class="cm">	  * move to SHUT_ACK_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Server sent SHUTDOWN ACK, this should not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COM from client, this should not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_SHUT_ACK_CLI</span>
<span class="cm">	 * SHUTDOWN ACK from the client, awaiting for SHUTDOWN COM from server</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * We received the data chuck, keep the state unchanged. I assume</span>
<span class="cm">	 * that still data chuncks  can be received by both the peers in</span>
<span class="cm">	 * SHUDOWN state</span>
<span class="cm">	 */</span>

	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent ECHO, Spec(sec 5.2.4) says it may be handled by the</span>
<span class="cm">	  * peer and peer shall move to the ESTABISHED. if it doesn&#39;t handle</span>
<span class="cm">	  * it will send ERROR chunk. So, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, not sure what to do stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN sent from the client, move to SHUDDOWN_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN sent from the server, move to SHUTDOWN_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * client resent SHUDTDOWN_ACK, let&#39;s stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Server sent SHUTDOWN ACK, this should not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COM from client, this should not happen, let&#39;s close the</span>
<span class="cm">	  * connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COMPLETE from server this is what we are expecting.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_SHUT_ACK_SER</span>
<span class="cm">	 * SHUTDOWN ACK from the server, awaiting for SHUTDOWN COM from client</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * We received the data chuck, keep the state unchanged. I assume</span>
<span class="cm">	 * that still data chuncks  can be received by both the peers in</span>
<span class="cm">	 * SHUDOWN state</span>
<span class="cm">	 */</span>

	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * We have got an INIT from client. From the spec.“Upon receipt of</span>
<span class="cm">	  * an INIT in the COOKIE-WAIT state, an endpoint MUST respond with</span>
<span class="cm">	  * an INIT ACK using the same parameters it sent in its  original</span>
<span class="cm">	  * INIT chunk (including its Initiate Tag, unchanged”).</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * INIT_ACK sent by the server, Unexpected INIT ACK, spec says,</span>
<span class="cm">	  * “If an INIT ACK is received by an endpoint in any state other</span>
<span class="cm">	  * than the COOKIE-WAIT state, the endpoint should discard the</span>
<span class="cm">	  * INIT ACK chunk”. Stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Client sent ECHO, Spec(sec 5.2.4) says it may be handled by the</span>
<span class="cm">	  * peer and peer shall move to the ESTABISHED. if it doesn&#39;t handle</span>
<span class="cm">	  * it will send ERROR chunk. So, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * COOKIE ACK from client, not sure what to do stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN sent from the client, move to SHUDDOWN_CLI</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN sent from the server, move to SHUTDOWN_SER</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * client sent SHUDTDOWN_ACK, this should not happen let&#39;s close</span>
<span class="cm">	  * the connection.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * Server resent SHUTDOWN ACK, stay in the same state</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COM from client, this what we are expecting, let&#39;s close</span>
<span class="cm">	  * the connection</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="cm">/*</span>
<span class="cm">	  * SHUTDOWN COMPLETE from server this should not happen.</span>
<span class="cm">	  */</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * State : IP_VS_SCTP_S_CLOSED</span>
<span class="cm">	 */</span>
	<span class="p">{{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_DATA_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_INIT_SER</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_INIT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ECHO_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_COOKIE_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_ABORT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_ACK_SER */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_CLI */</span> <span class="p">},</span>
	 <span class="p">{</span><span class="n">IP_VS_SCTP_S_CLOSED</span> <span class="cm">/* IP_VS_SCTP_EVE_SHUT_COM_SER */</span> <span class="p">}</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *      Timeout table[state]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">IP_VS_SCTP_S_LAST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_NONE</span><span class="p">]</span>         <span class="o">=</span>     <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_SER</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_ACK_CLI</span><span class="p">]</span> <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_ACK_SER</span><span class="p">]</span> <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ECHO_CLI</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ECHO_SER</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span><span class="p">]</span>  <span class="o">=</span>    <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span><span class="p">]</span>     <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span><span class="p">]</span> <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span><span class="p">]</span> <span class="o">=</span>     <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_CLOSED</span><span class="p">]</span>       <span class="o">=</span>    <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_LAST</span><span class="p">]</span>         <span class="o">=</span>     <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sctp_state_name_table</span><span class="p">[</span><span class="n">IP_VS_SCTP_S_LAST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_NONE</span><span class="p">]</span>         <span class="o">=</span>    <span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_CLI</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;INIT_CLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_SER</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;INIT_SER&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_ACK_CLI</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;INIT_ACK_CLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_INIT_ACK_SER</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;INIT_ACK_SER&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ECHO_CLI</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;COOKIE_ECHO_CLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ECHO_SER</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;COOKIE_ECHO_SER&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_ESTABLISHED</span><span class="p">]</span>  <span class="o">=</span>    <span class="s">&quot;ESTABISHED&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_CLI</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;SHUTDOWN_CLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_SER</span><span class="p">]</span>     <span class="o">=</span>    <span class="s">&quot;SHUTDOWN_SER&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_CLI</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;SHUTDOWN_ACK_CLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_SHUT_ACK_SER</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;SHUTDOWN_ACK_SER&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_CLOSED</span><span class="p">]</span>       <span class="o">=</span>    <span class="s">&quot;CLOSED&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IP_VS_SCTP_S_LAST</span><span class="p">]</span>         <span class="o">=</span>    <span class="s">&quot;BUG!&quot;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sctp_state_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">IP_VS_SCTP_S_LAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;ERR!&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sctp_state_name_table</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">sctp_state_name_table</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
	<span class="k">return</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_sctp_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sctp_chunkhdr_t</span> <span class="n">_sctpch</span><span class="p">,</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chunk_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="n">next_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ihl</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_VS_IPV6</span>
	<span class="n">ihl</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span> <span class="o">==</span> <span class="n">AF_INET</span> <span class="o">?</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">ihl</span> <span class="o">=</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ihl</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_sctphdr_t</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">_sctpch</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctpch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chunk_type</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Section 3: Multiple chunks can be bundled into one SCTP packet</span>
<span class="cm">	 * up to the MTU size, except for the INIT, INIT ACK, and</span>
<span class="cm">	 * SHUTDOWN COMPLETE chunks. These chunks MUST NOT be bundled with</span>
<span class="cm">	 * any other chunk in a packet.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Section 3.3.7: DATA chunks MUST NOT be bundled with ABORT. Control</span>
<span class="cm">	 * chunks (except for INIT, INIT ACK, and SHUTDOWN COMPLETE) MAY be</span>
<span class="cm">	 * bundled with an ABORT, but they MUST be placed before the ABORT</span>
<span class="cm">	 * in the SCTP packet or they will be ignored by the receiver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_COOKIE_ECHO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_COOKIE_ACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sch</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">ihl</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_sctphdr_t</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">sch</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_sctpch</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctpch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_ABORT</span><span class="p">)</span>
				<span class="n">chunk_type</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">sctp_events</span><span class="p">[</span><span class="n">chunk_type</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If the direction is IP_VS_DIR_OUTPUT, this event is from server</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IP_VS_DIR_OUTPUT</span><span class="p">)</span>
		<span class="n">event</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * get next state</span>
<span class="cm">	 */</span>
	<span class="n">next_state</span> <span class="o">=</span> <span class="n">sctp_states_table</span><span class="p">[</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">][</span><span class="n">event</span><span class="p">].</span><span class="n">next_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_state</span> <span class="o">!=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip_vs_dest</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>

		<span class="n">IP_VS_DBG_BUF</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%s %s  %s:%d-&gt;&quot;</span>
				<span class="s">&quot;%s:%d state: %s-&gt;%s conn-&gt;refcnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">((</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IP_VS_DIR_OUTPUT</span><span class="p">)</span> <span class="o">?</span>
				 <span class="s">&quot;output &quot;</span> <span class="o">:</span> <span class="s">&quot;input &quot;</span><span class="p">),</span>
				<span class="n">IP_VS_DBG_ADDR</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">),</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">),</span>
				<span class="n">IP_VS_DBG_ADDR</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">caddr</span><span class="p">),</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cport</span><span class="p">),</span>
				<span class="n">sctp_state_name</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
				<span class="n">sctp_state_name</span><span class="p">(</span><span class="n">next_state</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_VS_CONN_F_INACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">next_state</span> <span class="o">!=</span> <span class="n">IP_VS_SCTP_S_ESTABLISHED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">activeconns</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">inactconns</span><span class="p">);</span>
				<span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IP_VS_CONN_F_INACTIVE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_VS_CONN_F_INACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">next_state</span> <span class="o">==</span> <span class="n">IP_VS_SCTP_S_ESTABLISHED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">activeconns</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">inactconns</span><span class="p">);</span>
				<span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IP_VS_CONN_F_INACTIVE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">timeout_table</span><span class="p">[</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">];</span>
	<span class="k">else</span>	<span class="cm">/* What to do ? */</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sctp_state_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">set_sctp_state</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u16</span> <span class="nf">sctp_app_hashkey</span><span class="p">(</span><span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">__force</span> <span class="n">u16</span><span class="p">)</span><span class="n">port</span> <span class="o">&gt;&gt;</span> <span class="n">SCTP_APP_TAB_BITS</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u16</span><span class="p">)</span><span class="n">port</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">SCTP_APP_TAB_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_register_app</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_app</span> <span class="o">*</span><span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_vs_app</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">hash</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">inc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span> <span class="o">=</span> <span class="n">net_ipvs</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ip_vs_proto_data_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_SCTP</span><span class="p">);</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">sctp_app_hashkey</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_apps</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">p_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inc</span><span class="o">-&gt;</span><span class="n">p_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_apps</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sctp_unregister_app</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_app</span> <span class="o">*</span><span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span> <span class="o">=</span> <span class="n">net_ipvs</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ip_vs_proto_data_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_SCTP</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">appcnt</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inc</span><span class="o">-&gt;</span><span class="n">p_list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_app_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span> <span class="o">=</span> <span class="n">net_ipvs</span><span class="p">(</span><span class="n">ip_vs_conn_net</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_vs_app</span> <span class="o">*</span><span class="n">inc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Default binding: bind app only for NAT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IP_VS_FWD_METHOD</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IP_VS_CONN_F_MASQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Lookup application incarnations and bind the right one */</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">sctp_app_hashkey</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_apps</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">p_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inc</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ip_vs_app_inc_get</span><span class="p">(</span><span class="n">inc</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>

			<span class="n">IP_VS_DBG_BUF</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s">&quot;%s: Binding conn %s:%u-&gt;&quot;</span>
					<span class="s">&quot;%s:%u to app %s on port %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span>
					<span class="n">IP_VS_DBG_ADDR</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">caddr</span><span class="p">),</span>
					<span class="n">ntohs</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cport</span><span class="p">),</span>
					<span class="n">IP_VS_DBG_ADDR</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">),</span>
					<span class="n">ntohs</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">),</span>
					<span class="n">inc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">inc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">app</span> <span class="o">=</span> <span class="n">inc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inc</span><span class="o">-&gt;</span><span class="n">init_conn</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">inc</span><span class="o">-&gt;</span><span class="n">init_conn</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------</span>
<span class="cm"> *   timeouts is netns related now.</span>
<span class="cm"> * ---------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ip_vs_sctp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span> <span class="o">=</span> <span class="n">net_ipvs</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">ip_vs_init_hash_table</span><span class="p">(</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_apps</span><span class="p">,</span> <span class="n">SCTP_APP_TAB_SIZE</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipvs</span><span class="o">-&gt;</span><span class="n">sctp_app_lock</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">timeout_table</span> <span class="o">=</span> <span class="n">ip_vs_create_timeout_table</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">sctp_timeouts</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_timeouts</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">timeout_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ip_vs_sctp_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_proto_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">timeout_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ip_vs_protocol</span> <span class="n">ip_vs_protocol_sctp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SCTP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_states</span>	<span class="o">=</span> <span class="n">IP_VS_SCTP_S_LAST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dont_defrag</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_netns</span>	<span class="o">=</span> <span class="n">__ip_vs_sctp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit_netns</span>	<span class="o">=</span> <span class="n">__ip_vs_sctp_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">register_app</span>	<span class="o">=</span> <span class="n">sctp_register_app</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unregister_app</span> <span class="o">=</span> <span class="n">sctp_unregister_app</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_schedule</span>	<span class="o">=</span> <span class="n">sctp_conn_schedule</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_in_get</span>	<span class="o">=</span> <span class="n">ip_vs_conn_in_get_proto</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_out_get</span>	<span class="o">=</span> <span class="n">ip_vs_conn_out_get_proto</span><span class="p">,</span>
	<span class="p">.</span><span class="n">snat_handler</span>	<span class="o">=</span> <span class="n">sctp_snat_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dnat_handler</span>	<span class="o">=</span> <span class="n">sctp_dnat_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">csum_check</span>	<span class="o">=</span> <span class="n">sctp_csum_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_name</span>	<span class="o">=</span> <span class="n">sctp_state_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_transition</span> <span class="o">=</span> <span class="n">sctp_state_transition</span><span class="p">,</span>
	<span class="p">.</span><span class="n">app_conn_bind</span>	<span class="o">=</span> <span class="n">sctp_app_conn_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">debug_packet</span>	<span class="o">=</span> <span class="n">ip_vs_tcpudp_debug_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout_change</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
