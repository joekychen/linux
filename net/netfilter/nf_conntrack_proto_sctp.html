<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › nf_conntrack_proto_sctp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nf_conntrack_proto_sctp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Connection tracking protocol helper module for SCTP.</span>
<span class="cm"> *</span>
<span class="cm"> * SCTP is defined in RFC 2960. References to various sections in this code</span>
<span class="cm"> * are to this RFC.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/sctp.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;net/netfilter/nf_conntrack.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_l4proto.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_ecache.h&gt;</span>

<span class="cm">/* FIXME: Examine ipfilter&#39;s timeouts and conntrack transitions more</span>
<span class="cm">   closely.  They&#39;re more complex. --RR</span>

<span class="cm">   And so for me for SCTP :D -Kiran */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">sctp_conntrack_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLOSED&quot;</span><span class="p">,</span>
	<span class="s">&quot;COOKIE_WAIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;COOKIE_ECHOED&quot;</span><span class="p">,</span>
	<span class="s">&quot;ESTABLISHED&quot;</span><span class="p">,</span>
	<span class="s">&quot;SHUTDOWN_SENT&quot;</span><span class="p">,</span>
	<span class="s">&quot;SHUTDOWN_RECD&quot;</span><span class="p">,</span>
	<span class="s">&quot;SHUTDOWN_ACK_SENT&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SECS  * HZ</span>
<span class="cp">#define MINS  * 60 SECS</span>
<span class="cp">#define HOURS * 60 MINS</span>
<span class="cp">#define DAYS  * 24 HOURS</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_CLOSED</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">10</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_WAIT</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_ECHOED</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_ESTABLISHED</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">5</span> <span class="n">DAYS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_SENT</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">300</span> <span class="n">SECS</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_RECD</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">300</span> <span class="n">SECS</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_ACK_SENT</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">3</span> <span class="n">SECS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define sNO SCTP_CONNTRACK_NONE</span>
<span class="cp">#define	sCL SCTP_CONNTRACK_CLOSED</span>
<span class="cp">#define	sCW SCTP_CONNTRACK_COOKIE_WAIT</span>
<span class="cp">#define	sCE SCTP_CONNTRACK_COOKIE_ECHOED</span>
<span class="cp">#define	sES SCTP_CONNTRACK_ESTABLISHED</span>
<span class="cp">#define	sSS SCTP_CONNTRACK_SHUTDOWN_SENT</span>
<span class="cp">#define	sSR SCTP_CONNTRACK_SHUTDOWN_RECD</span>
<span class="cp">#define	sSA SCTP_CONNTRACK_SHUTDOWN_ACK_SENT</span>
<span class="cp">#define	sIV SCTP_CONNTRACK_MAX</span>

<span class="cm">/*</span>
<span class="cm">	These are the descriptions of the states:</span>

<span class="cm">NOTE: These state names are tantalizingly similar to the states of an</span>
<span class="cm">SCTP endpoint. But the interpretation of the states is a little different,</span>
<span class="cm">considering that these are the states of the connection and not of an end</span>
<span class="cm">point. Please note the subtleties. -Kiran</span>

<span class="cm">NONE              - Nothing so far.</span>
<span class="cm">COOKIE WAIT       - We have seen an INIT chunk in the original direction, or also</span>
<span class="cm">		    an INIT_ACK chunk in the reply direction.</span>
<span class="cm">COOKIE ECHOED     - We have seen a COOKIE_ECHO chunk in the original direction.</span>
<span class="cm">ESTABLISHED       - We have seen a COOKIE_ACK in the reply direction.</span>
<span class="cm">SHUTDOWN_SENT     - We have seen a SHUTDOWN chunk in the original direction.</span>
<span class="cm">SHUTDOWN_RECD     - We have seen a SHUTDOWN chunk in the reply directoin.</span>
<span class="cm">SHUTDOWN_ACK_SENT - We have seen a SHUTDOWN_ACK chunk in the direction opposite</span>
<span class="cm">		    to that of the SHUTDOWN chunk.</span>
<span class="cm">CLOSED            - We have seen a SHUTDOWN_COMPLETE chunk in the direction of</span>
<span class="cm">		    the SHUTDOWN chunk. Connection is closed.</span>
<span class="cm">*/</span>

<span class="cm">/* TODO</span>
<span class="cm"> - I have assumed that the first INIT is in the original direction.</span>
<span class="cm"> This messes things when an INIT comes in the reply direction in CLOSED</span>
<span class="cm"> state.</span>
<span class="cm"> - Check the error type in the reply dir before transitioning from</span>
<span class="cm">cookie echoed to closed.</span>
<span class="cm"> - Sec 5.2.4 of RFC 2960</span>
<span class="cm"> - Multi Homing support.</span>
<span class="cm">*/</span>

<span class="cm">/* SCTP conntrack state transitions */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sctp_conntracks</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">][</span><span class="n">SCTP_CONNTRACK_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
<span class="cm">/*	ORIGINAL	*/</span>
<span class="cm">/*                  sNO, sCL, sCW, sCE, sES, sSS, sSR, sSA */</span>
<span class="cm">/* init         */</span> <span class="p">{</span><span class="n">sCW</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* init_ack     */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* abort        */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">},</span>
<span class="cm">/* shutdown     */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* shutdown_ack */</span> <span class="p">{</span><span class="n">sSA</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSA</span><span class="p">,</span> <span class="n">sSA</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* error        */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span><span class="cm">/* Can&#39;t have Stale cookie*/</span>
<span class="cm">/* cookie_echo  */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span><span class="cm">/* 5.2.4 - Big TODO */</span>
<span class="cm">/* cookie_ack   */</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span><span class="cm">/* Can&#39;t come in orig dir */</span>
<span class="cm">/* shutdown_comp*/</span> <span class="p">{</span><span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sCL</span><span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
<span class="cm">/*	REPLY	*/</span>
<span class="cm">/*                  sNO, sCL, sCW, sCE, sES, sSS, sSR, sSA */</span>
<span class="cm">/* init         */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span><span class="cm">/* INIT in sCL Big TODO */</span>
<span class="cm">/* init_ack     */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* abort        */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">},</span>
<span class="cm">/* shutdown     */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* shutdown_ack */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSA</span><span class="p">,</span> <span class="n">sSA</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* error        */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* cookie_echo  */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span><span class="cm">/* Can&#39;t come in reply dir */</span>
<span class="cm">/* cookie_ack   */</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sSA</span><span class="p">},</span>
<span class="cm">/* shutdown_comp*/</span> <span class="p">{</span><span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCE</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sCL</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sctp_pkt_to_tuple</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="n">_hdr</span><span class="p">;</span>

	<span class="cm">/* Actually only need first 8 bytes. */</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sctp_invert_tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Print out the per-protocol part of the tuple. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_print_tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sport=%hu dport=%hu &quot;</span><span class="p">,</span>
			  <span class="n">ntohs</span><span class="p">(</span><span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span><span class="p">),</span>
			  <span class="n">ntohs</span><span class="p">(</span><span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Print out the private part of the conntrack. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_print_conntrack</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sctp_conntrack</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">sctp_conntrack_names</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define for_each_sctp_chunk(skb, sch, _sch, offset, dataoff, count)	\</span>
<span class="cp">for ((offset) = (dataoff) + sizeof(sctp_sctphdr_t), (count) = 0;	\</span>
<span class="cp">	(offset) &lt; (skb)-&gt;len &amp;&amp;					\</span>
<span class="cp">	((sch) = skb_header_pointer((skb), (offset), sizeof(_sch), &amp;(_sch)));	\</span>
<span class="cp">	(offset) += (ntohs((sch)-&gt;length) + 3) &amp; ~3, (count)++)</span>

<span class="cm">/* Some validity checks to make sure the chunks are fine */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_basic_checks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">sctp_chunkhdr_t</span> <span class="n">_sch</span><span class="p">,</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_sctp_chunk</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="n">_sch</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Chunk Num: %d  Type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT</span> <span class="o">||</span>
		    <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT_ACK</span> <span class="o">||</span>
		    <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_SHUTDOWN_COMPLETE</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Cookie Ack/Echo chunks not the first OR</span>
<span class="cm">		 * Init / Init Ack / Shutdown compl chunks not the only chunks</span>
<span class="cm">		 * OR zero-length.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_COOKIE_ACK</span> <span class="o">||</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_COOKIE_ECHO</span> <span class="o">||</span>
		      <span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Basic checks failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Basic checks passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_new_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">sctp_conntrack</span> <span class="n">cur_state</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">chunk_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Chunk type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chunk_type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCTP_CID_INIT</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_INIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_INIT_ACK</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_INIT_ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_ABORT</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_ABORT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_SHUTDOWN</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_SHUTDOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_SHUTDOWN_ACK</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_SHUTDOWN_ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_ERROR</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_COOKIE_ECHO</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_COOKIE_ECHO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_COOKIE_ACK</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_COOKIE_ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCTP_CID_SHUTDOWN_COMPLETE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SCTP_CID_SHUTDOWN_COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Other chunks like DATA, SACK, HEARTBEAT and</span>
<span class="cm">		its ACK do not cause a change in state */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unknown chunk type, Will stay in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sctp_conntrack_names</span><span class="p">[</span><span class="n">cur_state</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">cur_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dir: %d   cur_state: %s  chunk_type: %d  new_state: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dir</span><span class="p">,</span> <span class="n">sctp_conntrack_names</span><span class="p">[</span><span class="n">cur_state</span><span class="p">],</span> <span class="n">chunk_type</span><span class="p">,</span>
		 <span class="n">sctp_conntrack_names</span><span class="p">[</span><span class="n">sctp_conntracks</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">cur_state</span><span class="p">]]);</span>

	<span class="k">return</span> <span class="n">sctp_conntracks</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">cur_state</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">sctp_get_timeouts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sctp_timeouts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns verdict for packet, or -NF_ACCEPT for invalid. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="n">u_int8_t</span> <span class="n">pf</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hooknum</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sctp_conntrack</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="n">_sctph</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sctp_chunkhdr</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_chunkhdr</span> <span class="n">_sch</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_sctph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_basic_checks</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check the verification tag (Sec 8.5) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_INIT</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_SHUTDOWN_COMPLETE</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_COOKIE_ECHO</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_ABORT</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_SHUTDOWN_ACK</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">dir</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Verification tag check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_state</span> <span class="o">=</span> <span class="n">new_state</span> <span class="o">=</span> <span class="n">SCTP_CONNTRACK_NONE</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">for_each_sctp_chunk</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="n">_sch</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Special cases of Verification tag check (Sec 8.5.1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sec 8.5.1 (A) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_ABORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sec 8.5.1 (B) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_SHUTDOWN_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sec 8.5.1 (C) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCTP_CHUNK_FLAG_T</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_COOKIE_ECHO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sec 8.5.1 (D) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">!=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">dir</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">old_state</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
		<span class="n">new_state</span> <span class="o">=</span> <span class="n">sctp_new_state</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="cm">/* Invalid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">SCTP_CONNTRACK_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_conntrack_sctp: Invalid dir=%i ctype=%u &quot;</span>
				 <span class="s">&quot;conntrack=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dir</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If it is an INIT or an INIT ACK note down the vtag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT</span> <span class="o">||</span>
		    <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sctp_inithdr_t</span> <span class="n">_inithdr</span><span class="p">,</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>

			<span class="n">ih</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_chunkhdr_t</span><span class="p">),</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">_inithdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_inithdr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ih</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting vtag %x for dir %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ih</span><span class="o">-&gt;</span><span class="n">init_tag</span><span class="p">,</span> <span class="o">!</span><span class="n">dir</span><span class="p">);</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">ih</span><span class="o">-&gt;</span><span class="n">init_tag</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">new_state</span><span class="p">)</span>
			<span class="n">nf_conntrack_event_cache</span><span class="p">(</span><span class="n">IPCT_PROTOINFO</span><span class="p">,</span> <span class="n">ct</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">nf_ct_refresh_acct</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">new_state</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">SCTP_CONNTRACK_COOKIE_ECHOED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_REPLY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">SCTP_CONNTRACK_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting assured bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IPS_ASSURED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">nf_conntrack_event_cache</span><span class="p">(</span><span class="n">IPCT_ASSURED</span><span class="p">,</span> <span class="n">ct</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when a new connection for this protocol found. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">sctp_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sctp_conntrack</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sctphdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctphdr</span> <span class="n">_sctph</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sctp_chunkhdr</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sctp_chunkhdr</span> <span class="n">_sch</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_sctph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_sctph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_basic_checks</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* If an OOTB packet has any of these chunks discard (Sec 8.4) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_ABORT</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_SHUTDOWN_COMPLETE</span><span class="p">,</span> <span class="n">map</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">SCTP_CID_COOKIE_ACK</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">));</span>
	<span class="n">new_state</span> <span class="o">=</span> <span class="n">SCTP_CONNTRACK_MAX</span><span class="p">;</span>
	<span class="n">for_each_sctp_chunk</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="n">_sch</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t need lock here: this conntrack not in circulation yet */</span>
		<span class="n">new_state</span> <span class="o">=</span> <span class="n">sctp_new_state</span><span class="p">(</span><span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">,</span>
					   <span class="n">SCTP_CONNTRACK_NONE</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="cm">/* Invalid: delete conntrack */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">SCTP_CONNTRACK_NONE</span> <span class="o">||</span>
		    <span class="n">new_state</span> <span class="o">==</span> <span class="n">SCTP_CONNTRACK_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_conntrack_sctp: invalid new deleting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy the vtag into the state info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCTP_CID_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sctp_inithdr_t</span> <span class="n">_inithdr</span><span class="p">,</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>

				<span class="n">ih</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sctp_chunkhdr_t</span><span class="p">),</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">_inithdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_inithdr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ih</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting vtag %x for new conn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ih</span><span class="o">-&gt;</span><span class="n">init_tag</span><span class="p">);</span>

				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_REPLY</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">ih</span><span class="o">-&gt;</span><span class="n">init_tag</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Sec 8.5.1 (A) */</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* If it is a shutdown ack OOTB packet, we expect a return</span>
<span class="cm">		   shutdown complete, otherwise an ABORT Sec 8.4 (5) and (8) */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting vtag %x for new conn OOTB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span><span class="p">);</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_REPLY</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">vtag</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>

<span class="cp">#include &lt;linux/netfilter/nfnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nfnetlink_conntrack.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_to_nlattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest_parms</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nest_parms</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_SCTP</span> <span class="o">|</span> <span class="n">NLA_F_NESTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest_parms</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_SCTP_STATE</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_SCTP_VTAG_ORIGINAL</span><span class="p">,</span>
			 <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_SCTP_VTAG_REPLY</span><span class="p">,</span>
			 <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_REPLY</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest_parms</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">sctp_nla_policy</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_STATE</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_ORIGINAL</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_REPLY</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlattr_to_sctp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">cda</span><span class="p">[],</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">cda</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* updates may not contain the internal protocol info, skip parsing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span>
			       <span class="n">CTA_PROTOINFO_SCTP_MAX</span><span class="p">,</span>
			       <span class="n">attr</span><span class="p">,</span>
			       <span class="n">sctp_nla_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_STATE</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_ORIGINAL</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_REPLY</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_STATE</span><span class="p">]);</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_ORIGINAL</span><span class="p">]);</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">sctp</span><span class="p">.</span><span class="n">vtag</span><span class="p">[</span><span class="n">IP_CT_DIR_REPLY</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_SCTP_VTAG_REPLY</span><span class="p">]);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_nlattr_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>	<span class="cm">/* CTA_PROTOINFO_SCTP */</span>
		<span class="o">+</span> <span class="n">nla_policy_len</span><span class="p">(</span><span class="n">sctp_nla_policy</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_SCTP_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>

<span class="cp">#include &lt;linux/netfilter/nfnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nfnetlink_cttimeout.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sctp_timeout_nlattr_to_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set default SCTP timeouts. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SCTP_CONNTRACK_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* there&#39;s a 1:1 mapping between attributes and protocol states. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">CTA_TIMEOUT_SCTP_UNSPEC</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CTA_TIMEOUT_SCTP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sctp_timeout_obj_to_nlattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">CTA_TIMEOUT_SCTP_UNSPEC</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CTA_TIMEOUT_SCTP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span>
<span class="n">sctp_timeout_nla_policy</span><span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_CLOSED</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_COOKIE_WAIT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_COOKIE_ECHOED</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_ESTABLISHED</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_SHUTDOWN_SENT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_SHUTDOWN_RECD</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_SCTP_SHUTDOWN_ACK_SENT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sctp_sysctl_table_users</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">sctp_sysctl_header</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">sctp_sysctl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_closed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_CLOSED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_cookie_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_cookie_echoed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_ECHOED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_established&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_ESTABLISHED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_shutdown_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_shutdown_recd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_RECD</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_sctp_timeout_shutdown_ack_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_ACK_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_NF_CONNTRACK_PROC_COMPAT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">sctp_compat_sysctl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_closed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_CLOSED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_cookie_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_cookie_echoed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_COOKIE_ECHOED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_established&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_ESTABLISHED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_shutdown_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_shutdown_recd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_RECD</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_sctp_timeout_shutdown_ack_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_timeouts</span><span class="p">[</span><span class="n">SCTP_CONNTRACK_SHUTDOWN_ACK_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CONNTRACK_PROC_COMPAT */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_l4proto</span> <span class="n">nf_conntrack_l4proto_sctp4</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">l3proto</span>		<span class="o">=</span> <span class="n">PF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l4proto</span> 		<span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> 			<span class="o">=</span> <span class="s">&quot;sctp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_to_tuple</span> 		<span class="o">=</span> <span class="n">sctp_pkt_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_tuple</span> 		<span class="o">=</span> <span class="n">sctp_invert_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_tuple</span> 		<span class="o">=</span> <span class="n">sctp_print_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_conntrack</span>	<span class="o">=</span> <span class="n">sctp_print_conntrack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">packet</span> 		<span class="o">=</span> <span class="n">sctp_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_timeouts</span>		<span class="o">=</span> <span class="n">sctp_get_timeouts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new</span> 			<span class="o">=</span> <span class="n">sctp_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">me</span> 			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>
	<span class="p">.</span><span class="n">to_nlattr</span>		<span class="o">=</span> <span class="n">sctp_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_size</span>		<span class="o">=</span> <span class="n">sctp_nlattr_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_nlattr</span>		<span class="o">=</span> <span class="n">nlattr_to_sctp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple_to_nlattr</span>	<span class="o">=</span> <span class="n">nf_ct_port_tuple_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_tuple_size</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_tuple_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_to_tuple</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nla_policy</span>		<span class="o">=</span> <span class="n">nf_ct_port_nla_policy</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>
	<span class="p">.</span><span class="n">ctnl_timeout</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nlattr_to_obj</span>	<span class="o">=</span> <span class="n">sctp_timeout_nlattr_to_obj</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_to_nlattr</span>	<span class="o">=</span> <span class="n">sctp_timeout_obj_to_nlattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlattr_max</span>	<span class="o">=</span> <span class="n">CTA_TIMEOUT_SCTP_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">SCTP_CONNTRACK_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nla_policy</span>	<span class="o">=</span> <span class="n">sctp_timeout_nla_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="p">.</span><span class="n">ctl_table_users</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_sysctl_table_users</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table_header</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_sysctl_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table</span>		<span class="o">=</span> <span class="n">sctp_sysctl_table</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NF_CONNTRACK_PROC_COMPAT</span>
	<span class="p">.</span><span class="n">ctl_compat_table</span>	<span class="o">=</span> <span class="n">sctp_compat_sysctl_table</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_l4proto</span> <span class="n">nf_conntrack_l4proto_sctp6</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">l3proto</span>		<span class="o">=</span> <span class="n">PF_INET6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l4proto</span> 		<span class="o">=</span> <span class="n">IPPROTO_SCTP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> 			<span class="o">=</span> <span class="s">&quot;sctp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_to_tuple</span> 		<span class="o">=</span> <span class="n">sctp_pkt_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_tuple</span> 		<span class="o">=</span> <span class="n">sctp_invert_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_tuple</span> 		<span class="o">=</span> <span class="n">sctp_print_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_conntrack</span>	<span class="o">=</span> <span class="n">sctp_print_conntrack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">packet</span> 		<span class="o">=</span> <span class="n">sctp_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_timeouts</span>		<span class="o">=</span> <span class="n">sctp_get_timeouts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new</span> 			<span class="o">=</span> <span class="n">sctp_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">me</span> 			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>
	<span class="p">.</span><span class="n">to_nlattr</span>		<span class="o">=</span> <span class="n">sctp_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_size</span>		<span class="o">=</span> <span class="n">sctp_nlattr_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_nlattr</span>		<span class="o">=</span> <span class="n">nlattr_to_sctp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple_to_nlattr</span>	<span class="o">=</span> <span class="n">nf_ct_port_tuple_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_tuple_size</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_tuple_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_to_tuple</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nla_policy</span>		<span class="o">=</span> <span class="n">nf_ct_port_nla_policy</span><span class="p">,</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>
	<span class="p">.</span><span class="n">ctnl_timeout</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nlattr_to_obj</span>	<span class="o">=</span> <span class="n">sctp_timeout_nlattr_to_obj</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_to_nlattr</span>	<span class="o">=</span> <span class="n">sctp_timeout_obj_to_nlattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlattr_max</span>	<span class="o">=</span> <span class="n">CTA_TIMEOUT_SCTP_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">SCTP_CONNTRACK_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nla_policy</span>	<span class="o">=</span> <span class="n">sctp_timeout_nla_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="p">.</span><span class="n">ctl_table_users</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_sysctl_table_users</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table_header</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sctp_sysctl_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table</span>		<span class="o">=</span> <span class="n">sctp_sysctl_table</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nf_conntrack_proto_sctp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_l4proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_l4proto_sctp4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;nf_conntrack_l4proto_sctp4: protocol register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_l4proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_l4proto_sctp6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;nf_conntrack_l4proto_sctp6: protocol register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup_sctp4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">cleanup_sctp4:</span>
	<span class="n">nf_conntrack_l4proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_l4proto_sctp4</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nf_conntrack_proto_sctp_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nf_conntrack_l4proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_l4proto_sctp6</span><span class="p">);</span>
	<span class="n">nf_conntrack_l4proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_l4proto_sctp4</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nf_conntrack_proto_sctp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nf_conntrack_proto_sctp_fini</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kiran Kumar Immidi&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Netfilter connection tracking protocol helper for SCTP&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ip_conntrack_proto_sctp&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
