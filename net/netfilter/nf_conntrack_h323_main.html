<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › nf_conntrack_h323_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nf_conntrack_h323_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * H.323 connection tracking helper</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 Jing Min Zhao &lt;zhaojingmin@users.sourceforge.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This source code is licensed under General Public License version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the &#39;brute force&#39; H.323 connection tracking module by</span>
<span class="cm"> * Jozsef Kadlecsik &lt;kadlec@blackhole.kfki.hu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * For more information, please see http://nath323.sourceforge.net/</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/ip6_route.h&gt;</span>

<span class="cp">#include &lt;net/netfilter/nf_conntrack.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_core.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_tuple.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_expect.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_ecache.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_helper.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_zones.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nf_conntrack_h323.h&gt;</span>

<span class="cm">/* Parameters */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">default_rrq_ttl</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_rrq_ttl</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_rrq_ttl</span><span class="p">,</span> <span class="s">&quot;use this TTL if it&#39;s missing in RRQ&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gkrouted_only</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gkrouted_only</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gkrouted_only</span><span class="p">,</span> <span class="s">&quot;only accept calls from gatekeeper&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">callforward_filter</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">callforward_filter</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">callforward_filter</span><span class="p">,</span> <span class="s">&quot;only create call forwarding expectations &quot;</span>
				     <span class="s">&quot;if both endpoints are on different sides &quot;</span>
				     <span class="s">&quot;(determined by routing information)&quot;</span><span class="p">);</span>

<span class="cm">/* Hooks for NAT */</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_h245_addr_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			   <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
			   <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_h225_addr_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			   <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
			   <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_sig_addr_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_ras_addr_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">nat_rtp_rtcp_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			  <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span>
			  <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">rtp_port</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">rtp_exp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">rtcp_exp</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">nat_t120_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		      <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">nat_h245_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		      <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">nat_callforwarding_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
				<span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">nat_q931_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
		      <span class="n">__be16</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">)</span>
		      <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">nf_h323_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">h323_buffer</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_h245</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">[];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_ras</span><span class="p">[];</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_tpkt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">datalen</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dataoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_tcph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcpdatalen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcpdataoff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tpkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tpktlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tpktoff</span><span class="p">;</span>

	<span class="cm">/* Get TCP header */</span>
	<span class="n">th</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_tcph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_tcph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get TCP data offset */</span>
	<span class="n">tcpdataoff</span> <span class="o">=</span> <span class="n">protoff</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Get TCP data length */</span>
	<span class="n">tcpdatalen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">tcpdataoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcpdatalen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* No TCP data */</span>
		<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* first TPKT */</span>
		<span class="cm">/* Get first TPKT pointer */</span>
		<span class="n">tpkt</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcpdataoff</span><span class="p">,</span> <span class="n">tcpdatalen</span><span class="p">,</span>
					  <span class="n">h323_buffer</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tpkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* Validate TPKT identifier */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcpdatalen</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">tpkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span> <span class="o">||</span> <span class="n">tpkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Netmeeting sends TPKT header and data separately */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: previous packet &quot;</span>
					 <span class="s">&quot;indicated separate TPKT data of %hu &quot;</span>
					 <span class="s">&quot;bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tcpdatalen</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Yes, there was a TPKT header</span>
<span class="cm">					 * received */</span>
					<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">tpkt</span><span class="p">;</span>
					<span class="o">*</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span>
					<span class="o">*</span><span class="n">dataoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Fragmented TPKT */</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: fragmented TPKT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* It is not even a TPKT */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tpktoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Next TPKT */</span>
		<span class="n">tpktoff</span> <span class="o">=</span> <span class="o">*</span><span class="n">dataoff</span> <span class="o">+</span> <span class="o">*</span><span class="n">datalen</span><span class="p">;</span>
		<span class="n">tcpdatalen</span> <span class="o">-=</span> <span class="n">tpktoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcpdatalen</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* No more TPKT */</span>
			<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>
		<span class="n">tpkt</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="n">datalen</span><span class="p">;</span>

		<span class="cm">/* Validate TPKT identifier */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span> <span class="o">||</span> <span class="n">tpkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate TPKT length */</span>
	<span class="n">tpktlen</span> <span class="o">=</span> <span class="n">tpkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">tpkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpktlen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpktlen</span> <span class="o">&gt;</span> <span class="n">tcpdatalen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcpdatalen</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Separate TPKT header */</span>
			<span class="cm">/* Netmeeting sends TPKT header and data separately */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: separate TPKT header indicates &quot;</span>
				 <span class="s">&quot;there will be TPKT data of %hu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">tpktlen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpktlen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: incomplete TPKT (fragmented?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clear_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is the encapsulated data */</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">tpkt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">tpktlen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dataoff</span> <span class="o">=</span> <span class="n">tpktoff</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="cm">/* Clear TPKT length */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

      <span class="nl">clear_out:</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tpkt_len</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_h245_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">taddr</span><span class="o">-&gt;</span><span class="n">choice</span> <span class="o">!=</span> <span class="n">eH245_TransportAddress_unicastAddress</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">taddr</span><span class="o">-&gt;</span><span class="n">unicastAddress</span><span class="p">.</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eUnicastAddress_iPAddress</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">taddr</span><span class="o">-&gt;</span><span class="n">unicastAddress</span><span class="p">.</span><span class="n">iPAddress</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eUnicastAddress_iP6Address</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AF_INET6</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">taddr</span><span class="o">-&gt;</span><span class="n">unicastAddress</span><span class="p">.</span><span class="n">iP6Address</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">expect_rtp_rtcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			   <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">rtp_port</span><span class="p">,</span> <span class="n">rtcp_port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">rtp_exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">rtcp_exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nat_rtp_rtcp_hook</span><span class="p">)</span> <span class="n">nat_rtp_rtcp</span><span class="p">;</span>

	<span class="cm">/* Read RTP or RTCP address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h245_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* RTP port is even */</span>
	<span class="n">rtp_port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rtcp_port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">|</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Create expect for RTP */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtp_exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">rtp_exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtp_port</span><span class="p">);</span>

	<span class="cm">/* Create expect for RTCP */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rtcp_exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">rtp_exp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">rtcp_exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtcp_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">nat_rtp_rtcp</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nat_rtp_rtcp_hook</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NAT needed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nat_rtp_rtcp</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				   <span class="n">taddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rtp_port</span><span class="p">,</span> <span class="n">rtp_exp</span><span class="p">,</span> <span class="n">rtcp_exp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Conntrack only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">rtp_exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">rtcp_exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: expect RTP &quot;</span><span class="p">);</span>
				<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtp_exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: expect RTCP &quot;</span><span class="p">);</span>
				<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtcp_exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nf_ct_unexpect_related</span><span class="p">(</span><span class="n">rtp_exp</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">rtp_exp</span><span class="p">);</span>
	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">rtcp_exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">expect_t120</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		       <span class="n">H245_TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nat_t120_hook</span><span class="p">)</span> <span class="n">nat_t120</span><span class="p">;</span>

	<span class="cm">/* Read T.120 address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h245_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Create expect for T.120 connections */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NF_CT_EXPECT_PERMANENT</span><span class="p">;</span>	<span class="cm">/* Accept multiple channels */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nat_t120</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nat_t120_hook</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NAT needed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nat_t120</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Conntrack only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: expect T.120 &quot;</span><span class="p">);</span>
			<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_h245_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
				<span class="n">H2250LogicalChannelParameters</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eH2250LogicalChannelParameters_mediaChannel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RTP */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_rtp_rtcp</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mediaChannel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span>
	    <span class="n">options</span> <span class="o">&amp;</span> <span class="n">eH2250LogicalChannelParameters_mediaControlChannel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RTCP */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_rtp_rtcp</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">mediaControlChannel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_olc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		       <span class="n">OpenLogicalChannel</span> <span class="o">*</span><span class="n">olc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: OpenLogicalChannel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">forwardLogicalChannelParameters</span><span class="p">.</span><span class="n">multiplexParameters</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
	    <span class="n">eOpenLogicalChannel_forwardLogicalChannelParameters_multiplexParameters_h2250LogicalChannelParameters</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_h245_channel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">olc</span><span class="o">-&gt;</span>
					   <span class="n">forwardLogicalChannelParameters</span><span class="p">.</span>
					   <span class="n">multiplexParameters</span><span class="p">.</span>
					   <span class="n">h2250LogicalChannelParameters</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span>
	     <span class="n">eOpenLogicalChannel_reverseLogicalChannelParameters</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">reverseLogicalChannelParameters</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span>
	     <span class="n">eOpenLogicalChannel_reverseLogicalChannelParameters_multiplexParameters</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">reverseLogicalChannelParameters</span><span class="p">.</span><span class="n">multiplexParameters</span><span class="p">.</span>
		<span class="n">choice</span> <span class="o">==</span>
		<span class="n">eOpenLogicalChannel_reverseLogicalChannelParameters_multiplexParameters_h2250LogicalChannelParameters</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">process_h245_channel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">olc</span><span class="o">-&gt;</span>
					 <span class="n">reverseLogicalChannelParameters</span><span class="p">.</span>
					 <span class="n">multiplexParameters</span><span class="p">.</span>
					 <span class="n">h2250LogicalChannelParameters</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eOpenLogicalChannel_separateStack</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">olc</span><span class="o">-&gt;</span><span class="n">forwardLogicalChannelParameters</span><span class="p">.</span><span class="n">dataType</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
	    <span class="n">eDataType_data</span> <span class="o">&amp;&amp;</span>
	    <span class="n">olc</span><span class="o">-&gt;</span><span class="n">forwardLogicalChannelParameters</span><span class="p">.</span><span class="n">dataType</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">application</span><span class="p">.</span>
	    <span class="n">choice</span> <span class="o">==</span> <span class="n">eDataApplicationCapability_application_t120</span> <span class="o">&amp;&amp;</span>
	    <span class="n">olc</span><span class="o">-&gt;</span><span class="n">forwardLogicalChannelParameters</span><span class="p">.</span><span class="n">dataType</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">application</span><span class="p">.</span>
	    <span class="n">t120</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span> <span class="n">eDataProtocolCapability_separateLANStack</span> <span class="o">&amp;&amp;</span>
	    <span class="n">olc</span><span class="o">-&gt;</span><span class="n">separateStack</span><span class="p">.</span><span class="n">networkAddress</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
	    <span class="n">eNetworkAccessParameters_networkAddress_localAreaAddress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_t120</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">olc</span><span class="o">-&gt;</span><span class="n">separateStack</span><span class="p">.</span><span class="n">networkAddress</span><span class="p">.</span>
				  <span class="n">localAreaAddress</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_olca</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			<span class="n">OpenLogicalChannelAck</span> <span class="o">*</span><span class="n">olca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">H2250LogicalChannelAckParameters</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: OpenLogicalChannelAck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span>
	     <span class="n">eOpenLogicalChannelAck_reverseLogicalChannelParameters</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">reverseLogicalChannelParameters</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span>
	     <span class="n">eOpenLogicalChannelAck_reverseLogicalChannelParameters_multiplexParameters</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">reverseLogicalChannelParameters</span><span class="p">.</span><span class="n">multiplexParameters</span><span class="p">.</span>
		<span class="n">choice</span> <span class="o">==</span>
		<span class="n">eOpenLogicalChannelAck_reverseLogicalChannelParameters_multiplexParameters_h2250LogicalChannelParameters</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_h245_channel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">olca</span><span class="o">-&gt;</span>
					   <span class="n">reverseLogicalChannelParameters</span><span class="p">.</span>
					   <span class="n">multiplexParameters</span><span class="p">.</span>
					   <span class="n">h2250LogicalChannelParameters</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span>
	     <span class="n">eOpenLogicalChannelAck_forwardMultiplexAckParameters</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">forwardMultiplexAckParameters</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
	     <span class="n">eOpenLogicalChannelAck_forwardMultiplexAckParameters_h2250LogicalChannelAckParameters</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">forwardMultiplexAckParameters</span><span class="p">.</span>
		    <span class="n">h2250LogicalChannelAckParameters</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span>
		    <span class="n">eH2250LogicalChannelAckParameters_mediaChannel</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RTP */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_rtp_rtcp</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ack</span><span class="o">-&gt;</span><span class="n">mediaChannel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span>
		    <span class="n">eH2250LogicalChannelAckParameters_mediaControlChannel</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RTCP */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_rtp_rtcp</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ack</span><span class="o">-&gt;</span><span class="n">mediaControlChannel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eOpenLogicalChannelAck_separateStack</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">olca</span><span class="o">-&gt;</span><span class="n">separateStack</span><span class="p">.</span><span class="n">networkAddress</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
		<span class="n">eNetworkAccessParameters_networkAddress_localAreaAddress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_t120</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">olca</span><span class="o">-&gt;</span><span class="n">separateStack</span><span class="p">.</span><span class="n">networkAddress</span><span class="p">.</span>
				  <span class="n">localAreaAddress</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_h245</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			<span class="n">MultimediaSystemControlMessage</span> <span class="o">*</span><span class="n">mscm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mscm</span><span class="o">-&gt;</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eMultimediaSystemControlMessage_request</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mscm</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
		    <span class="n">eRequestMessage_openLogicalChannel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">mscm</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">openLogicalChannel</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: H.245 Request %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mscm</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">choice</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eMultimediaSystemControlMessage_response</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mscm</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span>
		    <span class="n">eResponseMessage_openLogicalChannelAck</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">process_olca</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">mscm</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span>
					    <span class="n">openLogicalChannelAck</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: H.245 Response %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mscm</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">choice</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: H.245 signal %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mscm</span><span class="o">-&gt;</span><span class="n">choice</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">h245_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">MultimediaSystemControlMessage</span> <span class="n">mscm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Until there&#39;s been traffic both ways, don&#39;t look in packets. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED</span> <span class="o">&amp;&amp;</span> <span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED_REPLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h245: skblen = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>

	<span class="cm">/* Process each TPKT */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">get_tpkt_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dataoff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h245: TPKT len=%d &quot;</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">)].</span><span class="n">tuple</span><span class="p">);</span>

		<span class="cm">/* Decode H.245 signal */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DecodeMultimediaSystemControlMessage</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">mscm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h245: decoding error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span> <span class="o">==</span> <span class="n">H323_ERROR_BOUND</span> <span class="o">?</span>
				 <span class="s">&quot;out of bound&quot;</span> <span class="o">:</span> <span class="s">&quot;out of range&quot;</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t drop when decoding error */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Process H.245 signal */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mscm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

      <span class="nl">drop:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;nf_ct_h245: packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect_policy</span> <span class="n">h245_exp_policy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">max_expected</span>	<span class="o">=</span> <span class="n">H323_RTP_CHANNEL_MAX</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="cm">/* T.120 */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_h245</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;H.245&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">h245_help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">h245_exp_policy</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">get_h225_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span>
		  <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">taddr</span><span class="o">-&gt;</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eTransportAddress_ipAddress</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">taddr</span><span class="o">-&gt;</span><span class="n">ipAddress</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eTransportAddress_ip6Address</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AF_INET6</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">taddr</span><span class="o">-&gt;</span><span class="n">ip6Address</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">expect_h245</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		       <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nat_h245_hook</span><span class="p">)</span> <span class="n">nat_h245</span><span class="p">;</span>

	<span class="cm">/* Read h245Address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Create expect for h245 connection */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_conntrack_helper_h245</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nat_h245</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nat_h245_hook</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NAT needed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nat_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Conntrack only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: expect H.245 &quot;</span><span class="p">);</span>
			<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If the calling party is on the same side of the forward-to party,</span>
<span class="cm"> * we don&#39;t need to track the second call */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">callforward_do_filter</span><span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				 <span class="n">u_int8_t</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_afinfo</span> <span class="o">*</span><span class="n">afinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* rcu_read_lock()ed by nf_hook_slow() */</span>
	<span class="n">afinfo</span> <span class="o">=</span> <span class="n">nf_get_afinfo</span><span class="p">(</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">afinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl1</span><span class="p">,</span> <span class="n">fl2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt1</span><span class="p">,</span> <span class="o">*</span><span class="n">rt2</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl1</span><span class="p">));</span>
		<span class="n">fl1</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl2</span><span class="p">));</span>
		<span class="n">fl2</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt1</span><span class="p">,</span>
				   <span class="n">flowi4_to_flowi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl1</span><span class="p">),</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2</span><span class="p">,</span>
					   <span class="n">flowi4_to_flowi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl2</span><span class="p">),</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">==</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">&amp;&amp;</span>
				    <span class="n">rt1</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span>  <span class="o">==</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CONNTRACK_IPV6)</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flowi6</span> <span class="n">fl1</span><span class="p">,</span> <span class="n">fl2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt1</span><span class="p">,</span> <span class="o">*</span><span class="n">rt2</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl1</span><span class="p">));</span>
		<span class="n">fl1</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">in6</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl2</span><span class="p">));</span>
		<span class="n">fl2</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">in6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt1</span><span class="p">,</span>
				   <span class="n">flowi6_to_flowi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl1</span><span class="p">),</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2</span><span class="p">,</span>
					   <span class="n">flowi6_to_flowi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl2</span><span class="p">),</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="n">rt1</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">expect_callforwarding</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
				 <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nat_callforwarding_hook</span><span class="p">)</span> <span class="n">nat_callforwarding</span><span class="p">;</span>

	<span class="cm">/* Read alternativeAddress */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span> <span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the calling party is on the same side of the forward-to party,</span>
<span class="cm">	 * we don&#39;t need to track the second call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callforward_filter</span> <span class="o">&amp;&amp;</span>
	    <span class="n">callforward_do_filter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				  <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Call Forwarding not tracked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create expect for the second call leg */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nat_callforwarding</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nat_callforwarding_hook</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need NAT */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nat_callforwarding</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					 <span class="n">taddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Conntrack only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: expect Call Forwarding &quot;</span><span class="p">);</span>
			<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			 <span class="n">Setup_UUIE</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_h225_addr_hook</span><span class="p">)</span> <span class="n">set_h225_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eSetup_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_h225_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_h225_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eSetup_UUIE_destCallSignalAddress</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">set_h225_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: set destCallSignalAddress %pI6:%hu-&gt;%pI6:%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_h225_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eSetup_UUIE_sourceCallSignalAddress</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">set_h225_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">sourceCallSignalAddress</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: set sourceCallSignalAddress %pI6:%hu-&gt;%pI6:%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			 <span class="n">ntohs</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_h225_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">sourceCallSignalAddress</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eSetup_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_callproceeding</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="n">CallProceeding_UUIE</span> <span class="o">*</span><span class="n">callproc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: CallProceeding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callproc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eCallProceeding_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">callproc</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callproc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eCallProceeding_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">callproc</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">callproc</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			   <span class="n">Connect_UUIE</span> <span class="o">*</span><span class="n">connect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eConnect_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">connect</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eConnect_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">connect</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">connect</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_alerting</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			    <span class="n">Alerting_UUIE</span> <span class="o">*</span><span class="n">alert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Alerting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alert</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eAlerting_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">alert</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alert</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eAlerting_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alert</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">alert</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_facility</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			    <span class="n">Facility_UUIE</span> <span class="o">*</span><span class="n">facility</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Facility</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">.</span><span class="n">choice</span> <span class="o">==</span> <span class="n">eFacilityReason_callForwarded</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eFacility_UUIE_alternativeAddress</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">expect_callforwarding</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						     <span class="n">dataoff</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">facility</span><span class="o">-&gt;</span>
						     <span class="n">alternativeAddress</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eFacility_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eFacility_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">facility</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">facility</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_progress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			    <span class="n">Progress_UUIE</span> <span class="o">*</span><span class="n">progress</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eProgress_UUIE_h245Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">progress</span><span class="o">-&gt;</span><span class="n">h245Address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eProgress_UUIE_fastStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">progress</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_olc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">progress</span><span class="o">-&gt;</span><span class="n">fastStart</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_q931</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">Q931</span> <span class="o">*</span><span class="n">q931</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">H323_UU_PDU</span> <span class="o">*</span><span class="n">pdu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q931</span><span class="o">-&gt;</span><span class="n">UUIE</span><span class="p">.</span><span class="n">h323_uu_pdu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_setup</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_setup</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">setup</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_callProceeding</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_callproceeding</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span>
					     <span class="n">callProceeding</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_connect</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_connect</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">connect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_alerting</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_alerting</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">alerting</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_facility</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_facility</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">facility</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eH323_UU_PDU_h323_message_body_progress</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">process_progress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">progress</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: Q.931 signal %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h323_message_body</span><span class="p">.</span><span class="n">choice</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eH323_UU_PDU_h245Control</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h245Control</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">process_h245</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">h245Control</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">q931_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">Q931</span> <span class="n">q931</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Until there&#39;s been traffic both ways, don&#39;t look in packets. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED</span> <span class="o">&amp;&amp;</span> <span class="n">ctinfo</span> <span class="o">!=</span> <span class="n">IP_CT_ESTABLISHED_REPLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: skblen = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>

	<span class="cm">/* Process each TPKT */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">get_tpkt_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dataoff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: TPKT len=%d &quot;</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">)].</span><span class="n">tuple</span><span class="p">);</span>

		<span class="cm">/* Decode Q.931 signal */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DecodeQ931</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q931</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: decoding error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span> <span class="o">==</span> <span class="n">H323_ERROR_BOUND</span> <span class="o">?</span>
				 <span class="s">&quot;out of bound&quot;</span> <span class="o">:</span> <span class="s">&quot;out of range&quot;</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t drop when decoding error */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Process Q.931 signal */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process_q931</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q931</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

      <span class="nl">drop:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;nf_ct_q931: packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect_policy</span> <span class="n">q931_exp_policy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* T.120 and H.245 */</span>
	<span class="p">.</span><span class="n">max_expected</span>		<span class="o">=</span> <span class="n">H323_RTP_CHANNEL_MAX</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>		<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Q.931&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">Q931_PORT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">q931_help</span><span class="p">,</span>
		<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">q931_exp_policy</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Q.931&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">Q931_PORT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">q931_help</span><span class="p">,</span>
		<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">q931_exp_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_udp_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">uh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udphdr</span> <span class="n">_uh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataoff</span><span class="p">;</span>

	<span class="n">uh</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_uh</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_uh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dataoff</span> <span class="o">=</span> <span class="n">protoff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_uh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dataoff</span> <span class="o">&gt;=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">dataoff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="o">*</span><span class="n">datalen</span><span class="p">,</span> <span class="n">h323_buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="nf">find_expect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
					       <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
					       <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">nf_ct_net</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="n">tuple</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">));</span>
	<span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">));</span>
	<span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">__nf_ct_expect_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nf_ct_zone</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tuple</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&amp;&amp;</span> <span class="n">exp</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">==</span> <span class="n">ct</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_expect_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exp</span> <span class="o">||</span> <span class="o">!</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">expect_q931</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">TransportAddress</span> <span class="o">*</span><span class="n">taddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nat_q931_hook</span><span class="p">)</span> <span class="n">nat_q931</span><span class="p">;</span>

	<span class="cm">/* Look for the first related address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">taddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>		<span class="cm">/* Not found */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Create expect for Q.931 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="n">gkrouted_only</span> <span class="o">?</span> <span class="cm">/* only accept calls from GK? */</span>
				<span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">;</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NF_CT_EXPECT_PERMANENT</span><span class="p">;</span>	<span class="cm">/* Accept multiple calls */</span>

	<span class="n">nat_q931</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nat_q931_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nat_q931</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Need NAT */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nat_q931</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">taddr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Conntrack only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: expect Q.931 &quot;</span><span class="p">);</span>
			<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>

			<span class="cm">/* Save port for looking up expect in processing RCF */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_grq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">GatekeeperRequest</span> <span class="o">*</span><span class="n">grq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">)</span> <span class="n">set_ras_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: GRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_ras_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_ras_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>	<span class="cm">/* NATed */</span>
		<span class="k">return</span> <span class="n">set_ras_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">grq</span><span class="o">-&gt;</span><span class="n">rasAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_gcf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">GatekeeperConfirm</span> <span class="o">*</span><span class="n">gcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: GCF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gcf</span><span class="o">-&gt;</span><span class="n">rasAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Registration port is the same as discovery port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">udp</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Avoid RAS expectation loops. A GCF is never expected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPS_EXPECTED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Need new expect */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
			  <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_ras</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: expect RAS &quot;</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_rrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">RegistrationRequest</span> <span class="o">*</span><span class="n">rrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">)</span> <span class="n">set_ras_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">expect_q931</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			  <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">item</span><span class="p">,</span>
			  <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">set_ras_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_ras_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_ras_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">rasAddress</span><span class="p">.</span><span class="n">item</span><span class="p">,</span>
				   <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">rasAddress</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eRegistrationRequest_timeToLive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RRQ TTL = %u seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">timeToLive</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">timeToLive</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">default_rrq_ttl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_rcf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">RegistrationConfirm</span> <span class="o">*</span><span class="n">rcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">)</span> <span class="n">set_sig_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RCF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_sig_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_sig_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_sig_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					<span class="n">rcf</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">item</span><span class="p">,</span>
					<span class="n">rcf</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcf</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eRegistrationConfirm_timeToLive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RCF TTL = %u seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcf</span><span class="o">-&gt;</span><span class="n">timeToLive</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">rcf</span><span class="o">-&gt;</span><span class="n">timeToLive</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: set RAS connection timeout to &quot;</span>
			 <span class="s">&quot;%u seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">nf_ct_refresh</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="cm">/* Set expect timeout */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_lock</span><span class="p">);</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">find_expect</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: set Q.931 expect &quot;</span>
				 <span class="s">&quot;timeout to %u seconds for&quot;</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
			<span class="n">set_expect_timeout</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_urq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">UnregistrationRequest</span> <span class="o">*</span><span class="n">urq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">)</span> <span class="n">set_sig_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: URQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_sig_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_sig_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_sig_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="n">urq</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">item</span><span class="p">,</span>
				   <span class="n">urq</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear old expect */</span>
	<span class="n">nf_ct_remove_expectations</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Give it 30 seconds for UCF or URJ */</span>
	<span class="n">nf_ct_refresh</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_arq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">AdmissionRequest</span> <span class="o">*</span><span class="n">arq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_ct_h323_master</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfct_help</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">help</span><span class="p">.</span><span class="n">ct_h323_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_h225_addr_hook</span><span class="p">)</span> <span class="n">set_h225_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: ARQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_h225_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_h225_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eAdmissionRequest_destCallSignalAddress</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">port</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">set_h225_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Answering ARQ */</span>
		<span class="k">return</span> <span class="n">set_h225_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				     <span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_port</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">eAdmissionRequest_srcCallSignalAddress</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">srcCallSignalAddress</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">set_h225_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calling ARQ */</span>
		<span class="k">return</span> <span class="n">set_h225_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">arq</span><span class="o">-&gt;</span><span class="n">srcCallSignalAddress</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span>
				     <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_acf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">AdmissionConfirm</span> <span class="o">*</span><span class="n">acf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">)</span> <span class="n">set_sig_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: ACF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acf</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Answering ACF */</span>
		<span class="n">set_sig_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_sig_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">set_sig_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">acf</span><span class="o">-&gt;</span><span class="n">destCallSignalAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Need new expect */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NF_CT_EXPECT_PERMANENT</span><span class="p">;</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: expect Q.931 &quot;</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_lrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">LocationRequest</span> <span class="o">*</span><span class="n">lrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">)</span> <span class="n">set_ras_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: LRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_ras_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_ras_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">set_ras_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">lrq</span><span class="o">-&gt;</span><span class="n">replyAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_lcf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">LocationConfirm</span> <span class="o">*</span><span class="n">lcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_expect</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: LCF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_h225_addr</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcf</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Need new expect for call signal */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">=</span> <span class="n">nf_ct_expect_alloc</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">nf_ct_expect_init</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">NF_CT_EXPECT_CLASS_DEFAULT</span><span class="p">,</span> <span class="n">nf_ct_l3num</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
			  <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NF_CT_EXPECT_PERMANENT</span><span class="p">;</span>
	<span class="n">exp</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_q931</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_expect_related</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: expect Q.931 &quot;</span><span class="p">);</span>
		<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exp</span><span class="o">-&gt;</span><span class="n">tuple</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">nf_ct_expect_put</span><span class="p">(</span><span class="n">exp</span><span class="p">);</span>

	<span class="cm">/* Ignore rasAddress */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_irr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">InfoRequestResponse</span> <span class="o">*</span><span class="n">irr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">)</span> <span class="n">set_ras_addr</span><span class="p">;</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">)</span> <span class="n">set_sig_addr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: IRR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_ras_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_ras_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_ras_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">irr</span><span class="o">-&gt;</span><span class="n">rasAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_sig_addr</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_sig_addr</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_sig_addr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					<span class="n">irr</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">item</span><span class="p">,</span>
					<span class="n">irr</span><span class="o">-&gt;</span><span class="n">callSignalAddress</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_ras</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">RasMessage</span> <span class="o">*</span><span class="n">ras</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">choice</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eRasMessage_gatekeeperRequest</span>:
		<span class="k">return</span> <span class="n">process_grq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">gatekeeperRequest</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_gatekeeperConfirm</span>:
		<span class="k">return</span> <span class="n">process_gcf</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">gatekeeperConfirm</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_registrationRequest</span>:
		<span class="k">return</span> <span class="n">process_rrq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">registrationRequest</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_registrationConfirm</span>:
		<span class="k">return</span> <span class="n">process_rcf</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">registrationConfirm</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_unregistrationRequest</span>:
		<span class="k">return</span> <span class="n">process_urq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">unregistrationRequest</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_admissionRequest</span>:
		<span class="k">return</span> <span class="n">process_arq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">admissionRequest</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_admissionConfirm</span>:
		<span class="k">return</span> <span class="n">process_acf</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">admissionConfirm</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_locationRequest</span>:
		<span class="k">return</span> <span class="n">process_lrq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">locationRequest</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_locationConfirm</span>:
		<span class="k">return</span> <span class="n">process_lcf</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">locationConfirm</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">eRasMessage_infoRequestResponse</span>:
		<span class="k">return</span> <span class="n">process_irr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ras</span><span class="o">-&gt;</span><span class="n">infoRequestResponse</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RAS message %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ras</span><span class="o">-&gt;</span><span class="n">choice</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ras_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">RasMessage</span> <span class="n">ras</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: skblen = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>

	<span class="cm">/* Get UDP data */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">get_udp_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">accept</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: RAS message len=%d &quot;</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">)].</span><span class="n">tuple</span><span class="p">);</span>

	<span class="cm">/* Decode RAS message */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">DecodeRasMessage</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ras</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: decoding error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ret</span> <span class="o">==</span> <span class="n">H323_ERROR_BOUND</span> <span class="o">?</span>
			 <span class="s">&quot;out of bound&quot;</span> <span class="o">:</span> <span class="s">&quot;out of range&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">accept</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Process RAS message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">process_ras</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ras</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

      <span class="nl">accept:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

      <span class="nl">drop:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_h323_lock</span><span class="p">);</span>
	<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;nf_ct_ras: packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect_policy</span> <span class="n">ras_exp_policy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">max_expected</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>		<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">nf_conntrack_helper_ras</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;RAS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">udp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">RAS_PORT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">ras_help</span><span class="p">,</span>
		<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ras_exp_policy</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;RAS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">udp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">RAS_PORT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">ras_help</span><span class="p">,</span>
		<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ras_exp_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nf_conntrack_h323_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_ras</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_h245</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h323_buffer</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: fini</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nf_conntrack_h323_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">h323_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">65536</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h323_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_h245</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_ras</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_h323: init success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err5:</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">err4:</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">err3:</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_q931</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">err2:</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nf_conntrack_helper_h245</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h323_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">nf_conntrack_h323_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nf_conntrack_h323_fini</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">get_h225_addr</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">set_h245_addr_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">set_h225_addr_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">set_sig_addr_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">set_ras_addr_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nat_rtp_rtcp_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nat_t120_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nat_h245_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nat_callforwarding_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nat_q931_hook</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jing Min Zhao &lt;zhaojingmin@users.sourceforge.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;H.323 connection tracking helper&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ip_conntrack_h323&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NFCT_HELPER</span><span class="p">(</span><span class="s">&quot;RAS&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NFCT_HELPER</span><span class="p">(</span><span class="s">&quot;Q.931&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NFCT_HELPER</span><span class="p">(</span><span class="s">&quot;H.245&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
