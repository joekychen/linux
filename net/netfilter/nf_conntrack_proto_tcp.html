<!DOCTYPE html>
<html><head><title>joekychen/linux » net › netfilter › nf_conntrack_proto_tcp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nf_conntrack_proto_tcp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* (C) 1999-2001 Paul `Rusty&#39; Russell</span>
<span class="cm"> * (C) 2002-2004 Netfilter Core Team &lt;coreteam@netfilter.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="cp">#include &lt;linux/netfilter.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv6.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_l4proto.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_ecache.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_log.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/ipv4/nf_conntrack_ipv4.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/ipv6/nf_conntrack_ipv6.h&gt;</span>

<span class="cm">/* &quot;Be conservative in what you do,</span>
<span class="cm">    be liberal in what you accept from others.&quot;</span>
<span class="cm">    If it&#39;s non-zero, we mark only out of window RST segments as INVALID. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nf_ct_tcp_be_liberal</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* If it is set to zero, we disable picking up already established</span>
<span class="cm">   connections. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nf_ct_tcp_loose</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Max number of the retransmitted packets without receiving an (acceptable)</span>
<span class="cm">   ACK from the destination. If this number is reached, a shorter timer</span>
<span class="cm">   will be started. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nf_ct_tcp_max_retrans</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

  <span class="cm">/* FIXME: Examine ipfilter&#39;s timeouts and conntrack transitions more</span>
<span class="cm">     closely.  They&#39;re more complex. --RR */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">tcp_conntrack_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYN_SENT&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYN_RECV&quot;</span><span class="p">,</span>
	<span class="s">&quot;ESTABLISHED&quot;</span><span class="p">,</span>
	<span class="s">&quot;FIN_WAIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLOSE_WAIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;LAST_ACK&quot;</span><span class="p">,</span>
	<span class="s">&quot;TIME_WAIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CLOSE&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYN_SENT2&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SECS * HZ</span>
<span class="cp">#define MINS * 60 SECS</span>
<span class="cp">#define HOURS * 60 MINS</span>
<span class="cp">#define DAYS * 24 HOURS</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_TIMEOUT_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span> <span class="n">MINS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">60</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">5</span> <span class="n">DAYS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span> <span class="n">MINS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">60</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_LAST_ACK</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">30</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span> <span class="n">MINS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">10</span> <span class="n">SECS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT2</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span> <span class="n">MINS</span><span class="p">,</span>
<span class="cm">/* RFC1122 says the R2 limit should be at least 100 seconds.</span>
<span class="cm">   Linux uses 15 packets as limit, which corresponds</span>
<span class="cm">   to ~13-30min depending on RTO. */</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">5</span> <span class="n">MINS</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">5</span> <span class="n">MINS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define sNO TCP_CONNTRACK_NONE</span>
<span class="cp">#define sSS TCP_CONNTRACK_SYN_SENT</span>
<span class="cp">#define sSR TCP_CONNTRACK_SYN_RECV</span>
<span class="cp">#define sES TCP_CONNTRACK_ESTABLISHED</span>
<span class="cp">#define sFW TCP_CONNTRACK_FIN_WAIT</span>
<span class="cp">#define sCW TCP_CONNTRACK_CLOSE_WAIT</span>
<span class="cp">#define sLA TCP_CONNTRACK_LAST_ACK</span>
<span class="cp">#define sTW TCP_CONNTRACK_TIME_WAIT</span>
<span class="cp">#define sCL TCP_CONNTRACK_CLOSE</span>
<span class="cp">#define sS2 TCP_CONNTRACK_SYN_SENT2</span>
<span class="cp">#define sIV TCP_CONNTRACK_MAX</span>
<span class="cp">#define sIG TCP_CONNTRACK_IGNORE</span>

<span class="cm">/* What TCP flags are set from RST/SYN/FIN/ACK. */</span>
<span class="k">enum</span> <span class="n">tcp_bit_set</span> <span class="p">{</span>
	<span class="n">TCP_SYN_SET</span><span class="p">,</span>
	<span class="n">TCP_SYNACK_SET</span><span class="p">,</span>
	<span class="n">TCP_FIN_SET</span><span class="p">,</span>
	<span class="n">TCP_ACK_SET</span><span class="p">,</span>
	<span class="n">TCP_RST_SET</span><span class="p">,</span>
	<span class="n">TCP_NONE_SET</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The TCP state transition table needs a few words...</span>
<span class="cm"> *</span>
<span class="cm"> * We are the man in the middle. All the packets go through us</span>
<span class="cm"> * but might get lost in transit to the destination.</span>
<span class="cm"> * It is assumed that the destinations can&#39;t receive segments</span>
<span class="cm"> * we haven&#39;t seen.</span>
<span class="cm"> *</span>
<span class="cm"> * The checked segment is in window, but our windows are *not*</span>
<span class="cm"> * equivalent with the ones of the sender/receiver. We always</span>
<span class="cm"> * try to guess the state of the current sender.</span>
<span class="cm"> *</span>
<span class="cm"> * The meaning of the states are:</span>
<span class="cm"> *</span>
<span class="cm"> * NONE:	initial state</span>
<span class="cm"> * SYN_SENT:	SYN-only packet seen</span>
<span class="cm"> * SYN_SENT2:	SYN-only packet seen from reply dir, simultaneous open</span>
<span class="cm"> * SYN_RECV:	SYN-ACK packet seen</span>
<span class="cm"> * ESTABLISHED:	ACK packet seen</span>
<span class="cm"> * FIN_WAIT:	FIN packet seen</span>
<span class="cm"> * CLOSE_WAIT:	ACK seen (after FIN)</span>
<span class="cm"> * LAST_ACK:	FIN seen (after FIN)</span>
<span class="cm"> * TIME_WAIT:	last ACK seen</span>
<span class="cm"> * CLOSE:	closed connection (RST)</span>
<span class="cm"> *</span>
<span class="cm"> * Packets marked as IGNORED (sIG):</span>
<span class="cm"> *	if they may be either invalid or valid</span>
<span class="cm"> *	and the receiver may send back a connection</span>
<span class="cm"> *	closing RST or a SYN/ACK.</span>
<span class="cm"> *</span>
<span class="cm"> * Packets marked as INVALID (sIV):</span>
<span class="cm"> *	if we regard them as truly invalid packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tcp_conntracks</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="n">TCP_CONNTRACK_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
<span class="cm">/* ORIGINAL */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*syn*/</span>	   <span class="p">{</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sSS</span><span class="p">,</span> <span class="n">sS2</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sNO -&gt; sSS	Initialize a new connection</span>
<span class="cm"> *	sSS -&gt; sSS	Retransmitted SYN</span>
<span class="cm"> *	sS2 -&gt; sS2	Late retransmitted SYN</span>
<span class="cm"> *	sSR -&gt; sIG</span>
<span class="cm"> *	sES -&gt; sIG	Error: SYNs in window outside the SYN_SENT state</span>
<span class="cm"> *			are errors. Receiver will reply with RST</span>
<span class="cm"> *			and close the connection.</span>
<span class="cm"> *			Or we are not in sync and hold a dead connection.</span>
<span class="cm"> *	sFW -&gt; sIG</span>
<span class="cm"> *	sCW -&gt; sIG</span>
<span class="cm"> *	sLA -&gt; sIG</span>
<span class="cm"> *	sTW -&gt; sSS	Reopened connection (RFC 1122).</span>
<span class="cm"> *	sCL -&gt; sSS</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*synack*/</span> <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sSR</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sNO -&gt; sIV	Too late and no reason to do anything</span>
<span class="cm"> *	sSS -&gt; sIV	Client can&#39;t send SYN and then SYN/ACK</span>
<span class="cm"> *	sS2 -&gt; sSR	SYN/ACK sent to SYN2 in simultaneous open</span>
<span class="cm"> *	sSR -&gt; sIG</span>
<span class="cm"> *	sES -&gt; sIG	Error: SYNs in window outside the SYN_SENT state</span>
<span class="cm"> *			are errors. Receiver will reply with RST</span>
<span class="cm"> *			and close the connection.</span>
<span class="cm"> *			Or we are not in sync and hold a dead connection.</span>
<span class="cm"> *	sFW -&gt; sIG</span>
<span class="cm"> *	sCW -&gt; sIG</span>
<span class="cm"> *	sLA -&gt; sIG</span>
<span class="cm"> *	sTW -&gt; sIG</span>
<span class="cm"> *	sCL -&gt; sIG</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*fin*/</span>    <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sFW</span><span class="p">,</span> <span class="n">sFW</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sIV</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sNO -&gt; sIV	Too late and no reason to do anything...</span>
<span class="cm"> *	sSS -&gt; sIV	Client migth not send FIN in this state:</span>
<span class="cm"> *			we enforce waiting for a SYN/ACK reply first.</span>
<span class="cm"> *	sS2 -&gt; sIV</span>
<span class="cm"> *	sSR -&gt; sFW	Close started.</span>
<span class="cm"> *	sES -&gt; sFW</span>
<span class="cm"> *	sFW -&gt; sLA	FIN seen in both directions, waiting for</span>
<span class="cm"> *			the last ACK.</span>
<span class="cm"> *			Migth be a retransmitted FIN as well...</span>
<span class="cm"> *	sCW -&gt; sLA</span>
<span class="cm"> *	sLA -&gt; sLA	Retransmitted FIN. Remain in the same state.</span>
<span class="cm"> *	sTW -&gt; sTW</span>
<span class="cm"> *	sCL -&gt; sCL</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*ack*/</span>	   <span class="p">{</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sIV</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sNO -&gt; sES	Assumed.</span>
<span class="cm"> *	sSS -&gt; sIV	ACK is invalid: we haven&#39;t seen a SYN/ACK yet.</span>
<span class="cm"> *	sS2 -&gt; sIV</span>
<span class="cm"> *	sSR -&gt; sES	Established state is reached.</span>
<span class="cm"> *	sES -&gt; sES	:-)</span>
<span class="cm"> *	sFW -&gt; sCW	Normal close request answered by ACK.</span>
<span class="cm"> *	sCW -&gt; sCW</span>
<span class="cm"> *	sLA -&gt; sTW	Last ACK detected.</span>
<span class="cm"> *	sTW -&gt; sTW	Retransmitted last ACK. Remain in the same state.</span>
<span class="cm"> *	sCL -&gt; sCL</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*rst*/</span>    <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span> <span class="p">},</span>
<span class="cm">/*none*/</span>   <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
<span class="cm">/* REPLY */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*syn*/</span>	   <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sS2</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sS2</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sNO -&gt; sIV	Never reached.</span>
<span class="cm"> *	sSS -&gt; sS2	Simultaneous open</span>
<span class="cm"> *	sS2 -&gt; sS2	Retransmitted simultaneous SYN</span>
<span class="cm"> *	sSR -&gt; sIV	Invalid SYN packets sent by the server</span>
<span class="cm"> *	sES -&gt; sIV</span>
<span class="cm"> *	sFW -&gt; sIV</span>
<span class="cm"> *	sCW -&gt; sIV</span>
<span class="cm"> *	sLA -&gt; sIV</span>
<span class="cm"> *	sTW -&gt; sIV	Reopened connection, but server may not do it.</span>
<span class="cm"> *	sCL -&gt; sIV</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*synack*/</span> <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sSR</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sSS -&gt; sSR	Standard open.</span>
<span class="cm"> *	sS2 -&gt; sSR	Simultaneous open</span>
<span class="cm"> *	sSR -&gt; sIG	Retransmitted SYN/ACK, ignore it.</span>
<span class="cm"> *	sES -&gt; sIG	Late retransmitted SYN/ACK?</span>
<span class="cm"> *	sFW -&gt; sIG	Might be SYN/ACK answering ignored SYN</span>
<span class="cm"> *	sCW -&gt; sIG</span>
<span class="cm"> *	sLA -&gt; sIG</span>
<span class="cm"> *	sTW -&gt; sIG</span>
<span class="cm"> *	sCL -&gt; sIG</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*fin*/</span>    <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sFW</span><span class="p">,</span> <span class="n">sFW</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sLA</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sIV</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sSS -&gt; sIV	Server might not send FIN in this state.</span>
<span class="cm"> *	sS2 -&gt; sIV</span>
<span class="cm"> *	sSR -&gt; sFW	Close started.</span>
<span class="cm"> *	sES -&gt; sFW</span>
<span class="cm"> *	sFW -&gt; sLA	FIN seen in both directions.</span>
<span class="cm"> *	sCW -&gt; sLA</span>
<span class="cm"> *	sLA -&gt; sLA	Retransmitted FIN.</span>
<span class="cm"> *	sTW -&gt; sTW</span>
<span class="cm"> *	sCL -&gt; sCL</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*ack*/</span>	   <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIG</span><span class="p">,</span> <span class="n">sSR</span><span class="p">,</span> <span class="n">sES</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sCW</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sTW</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sIG</span> <span class="p">},</span>
<span class="cm">/*</span>
<span class="cm"> *	sSS -&gt; sIG	Might be a half-open connection.</span>
<span class="cm"> *	sS2 -&gt; sIG</span>
<span class="cm"> *	sSR -&gt; sSR	Might answer late resent SYN.</span>
<span class="cm"> *	sES -&gt; sES	:-)</span>
<span class="cm"> *	sFW -&gt; sCW	Normal close request answered by ACK.</span>
<span class="cm"> *	sCW -&gt; sCW</span>
<span class="cm"> *	sLA -&gt; sTW	Last ACK detected.</span>
<span class="cm"> *	sTW -&gt; sTW	Retransmitted last ACK.</span>
<span class="cm"> *	sCL -&gt; sCL</span>
<span class="cm"> */</span>
<span class="cm">/* 	     sNO, sSS, sSR, sES, sFW, sCW, sLA, sTW, sCL, sS2	*/</span>
<span class="cm">/*rst*/</span>    <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span><span class="p">,</span> <span class="n">sCL</span> <span class="p">},</span>
<span class="cm">/*none*/</span>   <span class="p">{</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span><span class="p">,</span> <span class="n">sIV</span> <span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tcp_pkt_to_tuple</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_hdr</span><span class="p">;</span>

	<span class="cm">/* Actually only need first 8 bytes. */</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tcp_invert_tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">orig</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Print out the per-protocol part of the tuple. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_print_tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sport=%hu dport=%hu &quot;</span><span class="p">,</span>
			  <span class="n">ntohs</span><span class="p">(</span><span class="n">tuple</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">),</span>
			  <span class="n">ntohs</span><span class="p">(</span><span class="n">tuple</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Print out the private part of the conntrack. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_print_conntrack</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">tcp_conntrack</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">tcp_conntrack_names</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_conntrack_index</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span> <span class="k">return</span> <span class="n">TCP_RST_SET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">?</span> <span class="n">TCP_SYNACK_SET</span> <span class="o">:</span> <span class="n">TCP_SYN_SET</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">)</span> <span class="k">return</span> <span class="n">TCP_FIN_SET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="k">return</span> <span class="n">TCP_ACK_SET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="n">TCP_NONE_SET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TCP connection tracking based on &#39;Real Stateful TCP Packet Filtering</span>
<span class="cm">   in IP Filter&#39; by Guido van Rooij.</span>

<span class="cm">   http://www.sane.nl/events/sane2000/papers.html</span>
<span class="cm">   http://www.darkart.com/mirrors/www.obfuscation.org/ipf/</span>

<span class="cm">   The boundaries and the conditions are changed according to RFC793:</span>
<span class="cm">   the packet must intersect the window (i.e. segments may be</span>
<span class="cm">   after the right or before the left edge) and thus receivers may ACK</span>
<span class="cm">   segments after the right edge of the window.</span>

<span class="cm">	td_maxend = max(sack + max(win,1)) seen in reply packets</span>
<span class="cm">	td_maxwin = max(max(win, 1)) + (sack - ack) seen in sent packets</span>
<span class="cm">	td_maxwin += seq + len - sender.td_maxend</span>
<span class="cm">			if seq + len &gt; sender.td_maxend</span>
<span class="cm">	td_end    = max(seq + len) seen in sent packets</span>

<span class="cm">   I.   Upper bound for valid data:	seq &lt;= sender.td_maxend</span>
<span class="cm">   II.  Lower bound for valid data:	seq + len &gt;= sender.td_end - receiver.td_maxwin</span>
<span class="cm">   III.	Upper bound for valid (s)ack:   sack &lt;= receiver.td_end</span>
<span class="cm">   IV.	Lower bound for valid (s)ack:	sack &gt;= receiver.td_end - MAXACKWINDOW</span>

<span class="cm">   where sack is the highest right edge of sack block found in the packet</span>
<span class="cm">   or ack in the case of packet without SACK option.</span>

<span class="cm">   The upper bound limit for a valid (s)ack is not ignored -</span>
<span class="cm">   we doesn&#39;t have to deal with fragments.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">segment_seq_plus_len</span><span class="p">(</span><span class="n">__u32</span> <span class="n">seq</span><span class="p">,</span>
					 <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Should I use payload length field in IP/IPv6 header ?</span>
<span class="cm">	 * - YK */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">seq</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">dataoff</span> <span class="o">-</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Fixme: what about big packets? */</span>
<span class="cp">#define MAXACKWINCONST			66000</span>
<span class="cp">#define MAXACKWINDOW(sender)						\</span>
<span class="cp">	((sender)-&gt;td_maxwin &gt; MAXACKWINCONST ? (sender)-&gt;td_maxwin	\</span>
<span class="cp">					      : MAXACKWINCONST)</span>

<span class="cm">/*</span>
<span class="cm"> * Simplified tcp_parse_options routine from tcp_input.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_options</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buff</span><span class="p">[(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)];</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">),</span>
				 <span class="n">length</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">=</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">opcode</span><span class="o">=*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">opsize</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCPOPT_EOL</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCPOPT_NOP</span>:	<span class="cm">/* Ref: RFC 793 section 3.1 */</span>
			<span class="n">length</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">opsize</span><span class="o">=*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opsize</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* &quot;silly options&quot; */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opsize</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>	<span class="cm">/* don&#39;t parse partial options */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">TCPOPT_SACK_PERM</span>
			    <span class="o">&amp;&amp;</span> <span class="n">opsize</span> <span class="o">==</span> <span class="n">TCPOLEN_SACK_PERM</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IP_CT_TCP_FLAG_SACK_PERM</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">TCPOPT_WINDOW</span>
				 <span class="o">&amp;&amp;</span> <span class="n">opsize</span> <span class="o">==</span> <span class="n">TCPOLEN_WINDOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_int8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* See RFC1323 */</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">opsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">opsize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_sack</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
                     <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">sack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buff</span><span class="p">[(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)];</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">),</span>
				 <span class="n">length</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Fast path for timestamp-only option */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="n">TCPOLEN_TSTAMP_ALIGNED</span>
	    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">htonl</span><span class="p">((</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
				       <span class="o">|</span> <span class="p">(</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				       <span class="o">|</span> <span class="p">(</span><span class="n">TCPOPT_TIMESTAMP</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				       <span class="o">|</span> <span class="n">TCPOLEN_TIMESTAMP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">opsize</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCPOPT_EOL</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCPOPT_NOP</span>:	<span class="cm">/* Ref: RFC 793 section 3.1 */</span>
			<span class="n">length</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">opsize</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opsize</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* &quot;silly options&quot; */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opsize</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>	<span class="cm">/* don&#39;t parse partial options */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">TCPOPT_SACK</span>
			    <span class="o">&amp;&amp;</span> <span class="n">opsize</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TCPOLEN_SACK_BASE</span>
					  <span class="o">+</span> <span class="n">TCPOLEN_SACK_PERBLOCK</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">opsize</span> <span class="o">-</span> <span class="n">TCPOLEN_SACK_BASE</span><span class="p">)</span>
				 <span class="o">%</span> <span class="n">TCPOLEN_SACK_PERBLOCK</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				     <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">opsize</span> <span class="o">-</span> <span class="n">TCPOLEN_SACK_BASE</span><span class="p">);</span>
				     <span class="n">i</span> <span class="o">+=</span> <span class="n">TCPOLEN_SACK_PERBLOCK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">after</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">sack</span><span class="p">))</span>
						<span class="o">*</span><span class="n">sack</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">opsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">opsize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NF_NAT_NEEDED</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">s16</span> <span class="nf">nat_offset</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">typeof</span><span class="p">(</span><span class="n">nf_ct_nat_offset</span><span class="p">)</span> <span class="n">get_offset</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nf_ct_nat_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_offset</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="n">get_offset</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define NAT_OFFSET(pf, ct, dir, seq) \</span>
<span class="cp">	(pf == NFPROTO_IPV4 ? nat_offset(ct, dir, seq) : 0)</span>
<span class="cp">#else</span>
<span class="cp">#define NAT_OFFSET(pf, ct, dir, seq)	0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tcp_in_window</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ip_ct_tcp</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">,</span>
			  <span class="n">u_int8_t</span> <span class="n">pf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">nf_ct_net</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seen</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="o">*</span><span class="n">receiver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seen</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">sack</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">swin</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">receiver_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the required data from the packet.</span>
<span class="cm">	 */</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">sack</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
	<span class="n">win</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">segment_seq_plus_len</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_SACK_PERM</span><span class="p">)</span>
		<span class="n">tcp_sack</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sack</span><span class="p">);</span>

	<span class="cm">/* Take into account NAT sequence number mangling */</span>
	<span class="n">receiver_offset</span> <span class="o">=</span> <span class="n">NAT_OFFSET</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="o">!</span><span class="n">dir</span><span class="p">,</span> <span class="n">ack</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ack</span> <span class="o">-=</span> <span class="n">receiver_offset</span><span class="p">;</span>
	<span class="n">sack</span> <span class="o">-=</span> <span class="n">receiver_offset</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: &quot;</span><span class="p">);</span>
	<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;seq=%u ack=%u+(%d) sack=%u+(%d) win=%u end=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">seq</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">receiver_offset</span><span class="p">,</span> <span class="n">sack</span><span class="p">,</span> <span class="n">receiver_offset</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: sender end=%u maxend=%u maxwin=%u scale=%i &quot;</span>
		 <span class="s">&quot;receiver end=%u maxend=%u maxwin=%u scale=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize sender data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * SYN-ACK in reply to a SYN</span>
<span class="cm">			 * or SYN from reply direction in simultaneous open.</span>
<span class="cm">			 */</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">=</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">win</span><span class="p">);</span>

			<span class="n">tcp_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">sender</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * RFC 1323:</span>
<span class="cm">			 * Both sides must send the Window Scale option</span>
<span class="cm">			 * to enable window scaling in either direction.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span>
			      <span class="o">&amp;&amp;</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span><span class="p">))</span>
				<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">=</span>
				<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_scale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span>
				<span class="cm">/* Simultaneous open */</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We are in the middle of a connection,</span>
<span class="cm">			 * its history is lost for us.</span>
<span class="cm">			 * Let&#39;s try to use the data from the packet.</span>
<span class="cm">			 */</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
			<span class="n">swin</span> <span class="o">=</span> <span class="n">win</span> <span class="o">&lt;&lt;</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">;</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="p">(</span><span class="n">swin</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">swin</span><span class="p">);</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * We haven&#39;t seen traffic in the other direction yet</span>
<span class="cm">			 * but we have to tweak window tracking to pass III</span>
<span class="cm">			 * and IV until that happens.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">=</span> <span class="n">sack</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_SYN_SENT</span>
		     <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">)</span>
		   <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_SYN_RECV</span>
		     <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_REPLY</span><span class="p">))</span>
		   <span class="o">&amp;&amp;</span> <span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * RFC 793: &quot;if a TCP is reinitialized ... then it need</span>
<span class="cm">		 * not wait at all; it must only be sure to use sequence</span>
<span class="cm">		 * numbers larger than those recently used.&quot;</span>
<span class="cm">		 */</span>
		<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">=</span>
		<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
		<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">win</span><span class="p">);</span>

		<span class="n">tcp_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="n">sender</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If there is no ACK, just pretend it was set and OK.</span>
<span class="cm">		 */</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">sack</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">tcp_flag_word</span><span class="p">(</span><span class="n">tcph</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TCP_FLAG_ACK</span><span class="o">|</span><span class="n">TCP_FLAG_RST</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">TCP_FLAG_ACK</span><span class="o">|</span><span class="n">TCP_FLAG_RST</span><span class="p">))</span>
		   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Broken TCP stacks, that set ACK in RST packets as well</span>
<span class="cm">		 * with zero ack value.</span>
<span class="cm">		 */</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">sack</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">==</span> <span class="n">end</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">rst</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">seq</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">)))</span>
		<span class="cm">/*</span>
<span class="cm">		 * Packets contains no data: we assume it is valid</span>
<span class="cm">		 * and check the ack value only.</span>
<span class="cm">		 * However RST segments are always validated by their</span>
<span class="cm">		 * SEQ number, except when seq == 0 (reset sent answering</span>
<span class="cm">		 * SYN.</span>
<span class="cm">		 */</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: &quot;</span><span class="p">);</span>
	<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;seq=%u ack=%u+(%d) sack=%u+(%d) win=%u end=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">seq</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">receiver_offset</span><span class="p">,</span> <span class="n">sack</span><span class="p">,</span> <span class="n">receiver_offset</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: sender end=%u maxend=%u maxwin=%u scale=%i &quot;</span>
		 <span class="s">&quot;receiver end=%u maxend=%u maxwin=%u scale=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: I=%i II=%i III=%i IV=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">before</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		 <span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		 <span class="n">before</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		 <span class="n">after</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">MAXACKWINDOW</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">before</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">before</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">after</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">MAXACKWINDOW</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Take into account window scaling (RFC 1323).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span>
			<span class="n">win</span> <span class="o">&lt;&lt;=</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update sender data.</span>
<span class="cm">		 */</span>
		<span class="n">swin</span> <span class="o">=</span> <span class="n">win</span> <span class="o">+</span> <span class="p">(</span><span class="n">sack</span> <span class="o">-</span> <span class="n">ack</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">&lt;</span> <span class="n">swin</span><span class="p">)</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="n">swin</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
			<span class="n">sender</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IP_CT_TCP_FLAG_DATA_UNACKNOWLEDGED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_MAXACK_SET</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxack</span> <span class="o">=</span> <span class="n">ack</span><span class="p">;</span>
				<span class="n">sender</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IP_CT_TCP_FLAG_MAXACK_SET</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">after</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxack</span><span class="p">))</span>
				<span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxack</span> <span class="o">=</span> <span class="n">ack</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update receiver data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">))</span>
			<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">after</span><span class="p">(</span><span class="n">sack</span> <span class="o">+</span> <span class="n">win</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">=</span> <span class="n">sack</span> <span class="o">+</span> <span class="n">win</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">win</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">)</span>
			<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IP_CT_TCP_FLAG_DATA_UNACKNOWLEDGED</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check retransmissions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">TCP_ACK_SET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">==</span> <span class="n">dir</span>
			    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">last_seq</span> <span class="o">==</span> <span class="n">seq</span>
			    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">last_ack</span> <span class="o">==</span> <span class="n">ack</span>
			    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">last_end</span> <span class="o">==</span> <span class="n">end</span>
			    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">last_win</span> <span class="o">==</span> <span class="n">win</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_ack</span> <span class="o">=</span> <span class="n">ack</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_win</span> <span class="o">=</span> <span class="n">win</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">retrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sender</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_BE_LIBERAL</span> <span class="o">||</span>
		    <span class="n">nf_ct_tcp_be_liberal</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="s">&quot;nf_ct_tcp: %s &quot;</span><span class="p">,</span>
			<span class="n">before</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">after</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">before</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">after</span><span class="p">(</span><span class="n">sack</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span> <span class="o">-</span> <span class="n">MAXACKWINDOW</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;BUG&quot;</span>
			<span class="o">:</span> <span class="s">&quot;ACK is under the lower bound (possible overly delayed ACK)&quot;</span>
			<span class="o">:</span> <span class="s">&quot;ACK is over the upper bound (ACKed data not seen yet)&quot;</span>
			<span class="o">:</span> <span class="s">&quot;SEQ is under the lower bound (already ACKed data retransmitted)&quot;</span>
			<span class="o">:</span> <span class="s">&quot;SEQ is over the upper bound (over the window of the receiver)&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_in_window: res=%u sender end=%u maxend=%u maxwin=%u &quot;</span>
		 <span class="s">&quot;receiver end=%u maxend=%u maxwin=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">res</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* table of valid flag combinations - PUSH, ECE and CWR are always valid */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tcp_valid_flags</span><span class="p">[(</span><span class="n">TCPHDR_FIN</span><span class="o">|</span><span class="n">TCPHDR_SYN</span><span class="o">|</span><span class="n">TCPHDR_RST</span><span class="o">|</span><span class="n">TCPHDR_ACK</span><span class="o">|</span>
				 <span class="n">TCPHDR_URG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">[</span><span class="n">TCPHDR_SYN</span><span class="p">]</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_SYN</span><span class="o">|</span><span class="n">TCPHDR_URG</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_SYN</span><span class="o">|</span><span class="n">TCPHDR_ACK</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_RST</span><span class="p">]</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_RST</span><span class="o">|</span><span class="n">TCPHDR_ACK</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_FIN</span><span class="o">|</span><span class="n">TCPHDR_ACK</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_FIN</span><span class="o">|</span><span class="n">TCPHDR_ACK</span><span class="o">|</span><span class="n">TCPHDR_URG</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_ACK</span><span class="p">]</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TCPHDR_ACK</span><span class="o">|</span><span class="n">TCPHDR_URG</span><span class="p">]</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Protect conntrack agaist broken packets. Code taken from ipt_unclean.c.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">tmpl</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="o">*</span><span class="n">ctinfo</span><span class="p">,</span>
		     <span class="n">u_int8_t</span> <span class="n">pf</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hooknum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_tcph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">dataoff</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">tcpflags</span><span class="p">;</span>

	<span class="cm">/* Smaller that minimal TCP header? */</span>
	<span class="n">th</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_tcph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_tcph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="s">&quot;nf_ct_tcp: short packet &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Not whole TCP header or malformed packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)</span> <span class="o">||</span> <span class="n">tcplen</span> <span class="o">&lt;</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="s">&quot;nf_ct_tcp: truncated/malformed packet &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Checksum invalid? Ignore.</span>
<span class="cm">	 * We skip checking packets on the outgoing path</span>
<span class="cm">	 * because the checksum is assumed to be correct.</span>
<span class="cm">	 */</span>
	<span class="cm">/* FIXME: Source route IP option packets --RR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ct</span><span class="p">.</span><span class="n">sysctl_checksum</span> <span class="o">&amp;&amp;</span> <span class="n">hooknum</span> <span class="o">==</span> <span class="n">NF_INET_PRE_ROUTING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nf_checksum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hooknum</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">pf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="s">&quot;nf_ct_tcp: bad TCP checksum &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check TCP flags. */</span>
	<span class="n">tcpflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcp_flag_byte</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TCPHDR_ECE</span><span class="o">|</span><span class="n">TCPHDR_CWR</span><span class="o">|</span><span class="n">TCPHDR_PSH</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_valid_flags</span><span class="p">[</span><span class="n">tcpflags</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="s">&quot;nf_ct_tcp: invalid TCP flag combination &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">tcp_get_timeouts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tcp_timeouts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns verdict for packet, or -1 for invalid. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
		      <span class="n">u_int8_t</span> <span class="n">pf</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hooknum</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">nf_ct_net</span><span class="p">(</span><span class="n">ct</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nf_conntrack_tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tcp_conntrack</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ip_conntrack_dir</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_tcph</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">th</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_tcph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_tcph</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">old_state</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">get_conntrack_index</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
	<span class="n">new_state</span> <span class="o">=</span> <span class="n">tcp_conntracks</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="n">old_state</span><span class="p">];</span>
	<span class="n">tuple</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_CONNTRACK_SYN_SENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">&lt;</span> <span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* RFC 1122: &quot;When a connection is closed actively,</span>
<span class="cm">		 * it MUST linger in TIME-WAIT state for a time 2xMSL</span>
<span class="cm">		 * (Maximum Segment Lifetime). However, it MAY accept</span>
<span class="cm">		 * a new SYN from the remote TCP to reopen the connection</span>
<span class="cm">		 * directly from TIME-WAIT state, if...&quot;</span>
<span class="cm">		 * We ignore the conditions because we are in the</span>
<span class="cm">		 * TIME-WAIT state anyway.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Handle aborted connections: we and the server</span>
<span class="cm">		 * think there is an existing connection but the client</span>
<span class="cm">		 * aborts it and starts a new one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">flags</span>
		      <span class="o">|</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span>
		     <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_CLOSE_INIT</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span> <span class="o">==</span> <span class="n">dir</span>
		        <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">==</span> <span class="n">TCP_RST_SET</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Attempt to reopen a closed/aborted connection.</span>
<span class="cm">			 * Delete this connection and look up again. */</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="cm">/* Only repeat if we can actually remove the timer.</span>
<span class="cm">			 * Destruction may already be in progress in process</span>
<span class="cm">			 * context and we must give it a chance to terminate.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_kill</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">NF_REPEAT</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">TCP_CONNTRACK_IGNORE</span>:
		<span class="cm">/* Ignored packets:</span>
<span class="cm">		 *</span>
<span class="cm">		 * Our connection entry may be out of sync, so ignore</span>
<span class="cm">		 * packets which may signal the real connection between</span>
<span class="cm">		 * the client and the server.</span>
<span class="cm">		 *</span>
<span class="cm">		 * a) SYN in ORIGINAL</span>
<span class="cm">		 * b) SYN/ACK in REPLY</span>
<span class="cm">		 * c) ACK in reply direction after initial SYN in original.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the ignored packet is invalid, the receiver will send</span>
<span class="cm">		 * a RST we&#39;ll catch below.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">TCP_SYNACK_SET</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">==</span> <span class="n">TCP_SYN_SET</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span> <span class="o">!=</span> <span class="n">dir</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* b) This SYN/ACK acknowledges a SYN that we earlier</span>
<span class="cm">			 * ignored as invalid. This means that the client and</span>
<span class="cm">			 * the server are both in sync, while the firewall is</span>
<span class="cm">			 * not. We get in sync from the previously annotated</span>
<span class="cm">			 * values.</span>
<span class="cm">			 */</span>
			<span class="n">old_state</span> <span class="o">=</span> <span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">;</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">;</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span><span class="p">].</span><span class="n">td_end</span> <span class="o">=</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_end</span><span class="p">;</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span><span class="p">].</span><span class="n">td_maxend</span> <span class="o">=</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_end</span><span class="p">;</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">=</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_win</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
					<span class="mi">1</span> <span class="o">:</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_win</span><span class="p">;</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span><span class="p">].</span><span class="n">td_scale</span> <span class="o">=</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_wscale</span><span class="p">;</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_flags</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">dir</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_ct_tcp_state</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_end</span> <span class="o">=</span>
		    <span class="n">segment_seq_plus_len</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_win</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>

		<span class="cm">/* a) This is a SYN in ORIGINAL. The client and the server</span>
<span class="cm">		 * may be in sync but we are not. In that case, we annotate</span>
<span class="cm">		 * the TCP options and let the packet go through. If it is a</span>
<span class="cm">		 * valid SYN packet, the server will reply with a SYN/ACK, and</span>
<span class="cm">		 * then we&#39;ll get in sync. Otherwise, the server ignores it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">TCP_SYN_SET</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">{};</span>

			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_flags</span> <span class="o">=</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_wscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tcp_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seen</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_flags</span> <span class="o">|=</span>
					<span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span><span class="p">;</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_wscale</span> <span class="o">=</span> <span class="n">seen</span><span class="p">.</span><span class="n">td_scale</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seen</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_SACK_PERM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_flags</span> <span class="o">|=</span>
					<span class="n">IP_CT_TCP_FLAG_SACK_PERM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="s">&quot;nf_ct_tcp: invalid packet ignored in &quot;</span>
				  <span class="s">&quot;state %s &quot;</span><span class="p">,</span> <span class="n">tcp_conntrack_names</span><span class="p">[</span><span class="n">old_state</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_CONNTRACK_MAX</span>:
		<span class="cm">/* Invalid packet */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_tcp: Invalid dir=%i index=%u ostate=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dir</span><span class="p">,</span> <span class="n">get_conntrack_index</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">old_state</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
			<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="s">&quot;nf_ct_tcp: invalid state &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_CONNTRACK_CLOSE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">TCP_RST_SET</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_MAXACK_SET</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">before</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">),</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">td_maxack</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Invalid RST  */</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">LOG_INVALID</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span>
				<span class="n">nf_log_packet</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="s">&quot;nf_ct_tcp: invalid RST &quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">TCP_RST_SET</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPS_SEEN_REPLY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">==</span> <span class="n">TCP_SYN_SET</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPS_ASSURED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">==</span> <span class="n">TCP_ACK_SET</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RST sent to invalid SYN or ACK we had let through</span>
<span class="cm">			 * at a) and c) above:</span>
<span class="cm">			 *</span>
<span class="cm">			 * a) SYN was in window then</span>
<span class="cm">			 * c) we hold a half-open connection.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Delete our connection entry.</span>
<span class="cm">			 * We skip window checking, because packet might ACK</span>
<span class="cm">			 * segments we ignored. */</span>
			<span class="k">goto</span> <span class="n">in_window</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Just fall through */</span>
	<span class="nl">default:</span>
		<span class="cm">/* Keep compilers happy. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_in_window</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
			   <span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">pf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>
     <span class="nl">in_window:</span>
	<span class="cm">/* From now on we have got in-window packets */</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_conntracks: &quot;</span><span class="p">);</span>
	<span class="n">nf_ct_dump_tuple</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;syn=%i ack=%i fin=%i rst=%i old=%i new=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		 <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		 <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>

	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">new_state</span>
	    <span class="o">&amp;&amp;</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">)</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IP_CT_TCP_FLAG_CLOSE_INIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">retrans</span> <span class="o">&gt;=</span> <span class="n">nf_ct_tcp_max_retrans</span> <span class="o">&amp;&amp;</span>
	    <span class="n">timeouts</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">])</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">IP_CT_TCP_FLAG_DATA_UNACKNOWLEDGED</span> <span class="o">&amp;&amp;</span>
		 <span class="n">timeouts</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">])</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeouts</span><span class="p">[</span><span class="n">new_state</span><span class="p">];</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">old_state</span><span class="p">)</span>
		<span class="n">nf_conntrack_event_cache</span><span class="p">(</span><span class="n">IPCT_PROTOINFO</span><span class="p">,</span> <span class="n">ct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPS_SEEN_REPLY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If only reply is a RST, we can consider ourselves not to</span>
<span class="cm">		   have an established connection: this is a fairly common</span>
<span class="cm">		   problem case, so we can delete the conntrack</span>
<span class="cm">		   immediately.  --RR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nf_ct_kill_acct</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPS_ASSURED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_SYN_RECV</span>
		       <span class="o">||</span> <span class="n">old_state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set ASSURED if we see see valid ack in ESTABLISHED</span>
<span class="cm">		   after SYN_RECV or a valid answer for a picked up</span>
<span class="cm">		   connection. */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IPS_ASSURED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">nf_conntrack_event_cache</span><span class="p">(</span><span class="n">IPCT_ASSURED</span><span class="p">,</span> <span class="n">ct</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nf_ct_refresh_acct</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when a new connection for this protocol found. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tcp_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataoff</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">tcp_conntrack</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">_tcph</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="o">*</span><span class="n">sender</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ip_ct_tcp_state</span> <span class="o">*</span><span class="n">receiver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">th</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_tcph</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">_tcph</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t need lock here: this conntrack not in circulation yet */</span>
	<span class="n">new_state</span> <span class="o">=</span> <span class="n">tcp_conntracks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">get_conntrack_index</span><span class="p">(</span><span class="n">th</span><span class="p">)][</span><span class="n">TCP_CONNTRACK_NONE</span><span class="p">];</span>

	<span class="cm">/* Invalid: delete conntrack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">&gt;=</span> <span class="n">TCP_CONNTRACK_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;nf_ct_tcp: invalid new deleting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">));</span>
		<span class="cm">/* SYN packet */</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_end</span> <span class="o">=</span>
			<span class="n">segment_seq_plus_len</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					     <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxend</span> <span class="o">=</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_end</span><span class="p">;</span>

		<span class="n">tcp_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nf_ct_tcp_loose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t try to pick up connections. */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are in the middle of a connection,</span>
<span class="cm">		 * its history is lost for us.</span>
<span class="cm">		 * Let&#39;s try to use the data from the packet.</span>
<span class="cm">		 */</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_end</span> <span class="o">=</span>
			<span class="n">segment_seq_plus_len</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					     <span class="n">dataoff</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxend</span> <span class="o">=</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_end</span> <span class="o">+</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_maxwin</span><span class="p">;</span>

		<span class="cm">/* We assume SACK and liberal window checking to handle</span>
<span class="cm">		 * window scaling */</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IP_CT_TCP_FLAG_SACK_PERM</span> <span class="o">|</span>
					      <span class="n">IP_CT_TCP_FLAG_BE_LIBERAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tcp_packet will set them */</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">TCP_NONE_SET</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tcp_new: sender end=%u maxend=%u maxwin=%u scale=%i &quot;</span>
		 <span class="s">&quot;receiver end=%u maxend=%u maxwin=%u scale=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">sender</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_end</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxend</span><span class="p">,</span> <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_maxwin</span><span class="p">,</span>
		 <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">td_scale</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>

<span class="cp">#include &lt;linux/netfilter/nfnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nfnetlink_conntrack.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_to_nlattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest_parms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nest_parms</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP</span> <span class="o">|</span> <span class="n">NLA_F_NESTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nest_parms</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_WSCALE_ORIGINAL</span><span class="p">,</span>
		       <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_scale</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nla_put_u8</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_WSCALE_REPLY</span><span class="p">,</span>
		       <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">td_scale</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_FLAGS_ORIGINAL</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_FLAGS_REPLY</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest_parms</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">tcp_nla_policy</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_ORIGINAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_REPLY</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U8</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_ORIGINAL</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_REPLY</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlattr_to_tcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">cda</span><span class="p">[],</span> <span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">pattr</span> <span class="o">=</span> <span class="n">cda</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* updates could not contain anything about the private</span>
<span class="cm">	 * protocol info, in that case skip the parsing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pattr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_MAX</span><span class="p">,</span> <span class="n">pattr</span><span class="p">,</span> <span class="n">tcp_nla_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">TCP_CONNTRACK_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">])</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_STATE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_ORIGINAL</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_ORIGINAL</span><span class="p">]);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_REPLY</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nf_ct_tcp_flags</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span>
			<span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_FLAGS_REPLY</span><span class="p">]);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_ORIGINAL</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_REPLY</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_CT_TCP_FLAG_WINDOW_SCALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">td_scale</span> <span class="o">=</span>
			<span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_ORIGINAL</span><span class="p">]);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">.</span><span class="n">tcp</span><span class="p">.</span><span class="n">seen</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">td_scale</span> <span class="o">=</span>
			<span class="n">nla_get_u8</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_PROTOINFO_TCP_WSCALE_REPLY</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_nlattr_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>	   <span class="cm">/* CTA_PROTOINFO_TCP */</span>
		<span class="o">+</span> <span class="n">nla_policy_len</span><span class="p">(</span><span class="n">tcp_nla_policy</span><span class="p">,</span> <span class="n">CTA_PROTOINFO_TCP_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_nlattr_tuple_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nla_policy_len</span><span class="p">(</span><span class="n">nf_ct_port_nla_policy</span><span class="p">,</span> <span class="n">CTA_PROTO_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>

<span class="cp">#include &lt;linux/netfilter/nfnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nfnetlink_cttimeout.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_timeout_nlattr_to_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set default TCP timeouts. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">TCP_CONNTRACK_TIMEOUT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_RECV</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_RECV</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_ESTABLISHED</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_ESTABLISHED</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_FIN_WAIT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_FIN_WAIT</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE_WAIT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE_WAIT</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE_WAIT</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_LAST_ACK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_LAST_ACK</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_LAST_ACK</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_TIME_WAIT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_TIME_WAIT</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT2</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT2</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT2</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_RETRANS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_RETRANS</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_UNACK</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_UNACK</span><span class="p">]))</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tcp_timeout_obj_to_nlattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_SYN_SENT</span><span class="p">,</span>
			<span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_SYN_RECV</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_ESTABLISHED</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_FIN_WAIT</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_CLOSE_WAIT</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE_WAIT</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_LAST_ACK</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_LAST_ACK</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_TIME_WAIT</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_CLOSE</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_SYN_SENT2</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT2</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_RETRANS</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CTA_TIMEOUT_TCP_UNACK</span><span class="p">,</span>
			 <span class="n">htonl</span><span class="p">(</span><span class="n">timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">tcp_timeout_nla_policy</span><span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_RECV</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_ESTABLISHED</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_FIN_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_LAST_ACK</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_TIME_WAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_CLOSE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CTA_TIMEOUT_TCP_SYN_SENT2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcp_sysctl_table_users</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">tcp_sysctl_header</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">tcp_sysctl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_syn_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_syn_recv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_established&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_fin_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_close_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_last_ack&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_LAST_ACK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_time_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_close&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_max_retrans&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_timeout_unacknowledged&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_UNACK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_loose&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_loose</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>       <span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_be_liberal&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_be_liberal</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>         <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>           <span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>   <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nf_conntrack_tcp_max_retrans&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_max_retrans</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_NF_CONNTRACK_PROC_COMPAT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">tcp_compat_sysctl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_syn_sent&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_syn_sent2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_SENT2</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_syn_recv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_SYN_RECV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_established&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_ESTABLISHED</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_fin_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_FIN_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_close_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_last_ack&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_LAST_ACK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_time_wait&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_TIME_WAIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_close&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_CLOSE</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_timeout_max_retrans&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timeouts</span><span class="p">[</span><span class="n">TCP_CONNTRACK_RETRANS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_loose&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_loose</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_be_liberal&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_be_liberal</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_conntrack_tcp_max_retrans&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nf_ct_tcp_max_retrans</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CONNTRACK_PROC_COMPAT */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSCTL */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">nf_conntrack_l4proto</span> <span class="n">nf_conntrack_l4proto_tcp4</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">l3proto</span>		<span class="o">=</span> <span class="n">PF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l4proto</span> 		<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> 			<span class="o">=</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_to_tuple</span> 		<span class="o">=</span> <span class="n">tcp_pkt_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_tuple</span> 		<span class="o">=</span> <span class="n">tcp_invert_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_tuple</span> 		<span class="o">=</span> <span class="n">tcp_print_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_conntrack</span> 	<span class="o">=</span> <span class="n">tcp_print_conntrack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">packet</span> 		<span class="o">=</span> <span class="n">tcp_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_timeouts</span>		<span class="o">=</span> <span class="n">tcp_get_timeouts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new</span> 			<span class="o">=</span> <span class="n">tcp_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>			<span class="o">=</span> <span class="n">tcp_error</span><span class="p">,</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>
	<span class="p">.</span><span class="n">to_nlattr</span>		<span class="o">=</span> <span class="n">tcp_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_size</span>		<span class="o">=</span> <span class="n">tcp_nlattr_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_nlattr</span>		<span class="o">=</span> <span class="n">nlattr_to_tcp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple_to_nlattr</span>	<span class="o">=</span> <span class="n">nf_ct_port_tuple_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_to_tuple</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_tuple_size</span>	<span class="o">=</span> <span class="n">tcp_nlattr_tuple_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nla_policy</span>		<span class="o">=</span> <span class="n">nf_ct_port_nla_policy</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>
	<span class="p">.</span><span class="n">ctnl_timeout</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nlattr_to_obj</span>	<span class="o">=</span> <span class="n">tcp_timeout_nlattr_to_obj</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_to_nlattr</span>	<span class="o">=</span> <span class="n">tcp_timeout_obj_to_nlattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlattr_max</span>	<span class="o">=</span> <span class="n">CTA_TIMEOUT_TCP_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">TCP_CONNTRACK_TIMEOUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nla_policy</span>	<span class="o">=</span> <span class="n">tcp_timeout_nla_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="p">.</span><span class="n">ctl_table_users</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sysctl_table_users</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table_header</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sysctl_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table</span>		<span class="o">=</span> <span class="n">tcp_sysctl_table</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NF_CONNTRACK_PROC_COMPAT</span>
	<span class="p">.</span><span class="n">ctl_compat_table</span>	<span class="o">=</span> <span class="n">tcp_compat_sysctl_table</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_conntrack_l4proto_tcp4</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">nf_conntrack_l4proto</span> <span class="n">nf_conntrack_l4proto_tcp6</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">l3proto</span>		<span class="o">=</span> <span class="n">PF_INET6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">l4proto</span> 		<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> 			<span class="o">=</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pkt_to_tuple</span> 		<span class="o">=</span> <span class="n">tcp_pkt_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_tuple</span> 		<span class="o">=</span> <span class="n">tcp_invert_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_tuple</span> 		<span class="o">=</span> <span class="n">tcp_print_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_conntrack</span> 	<span class="o">=</span> <span class="n">tcp_print_conntrack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">packet</span> 		<span class="o">=</span> <span class="n">tcp_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_timeouts</span>		<span class="o">=</span> <span class="n">tcp_get_timeouts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new</span> 			<span class="o">=</span> <span class="n">tcp_new</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>			<span class="o">=</span> <span class="n">tcp_error</span><span class="p">,</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK)</span>
	<span class="p">.</span><span class="n">to_nlattr</span>		<span class="o">=</span> <span class="n">tcp_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_size</span>		<span class="o">=</span> <span class="n">tcp_nlattr_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">from_nlattr</span>		<span class="o">=</span> <span class="n">nlattr_to_tcp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple_to_nlattr</span>	<span class="o">=</span> <span class="n">nf_ct_port_tuple_to_nlattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_to_tuple</span>	<span class="o">=</span> <span class="n">nf_ct_port_nlattr_to_tuple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nlattr_tuple_size</span>	<span class="o">=</span> <span class="n">tcp_nlattr_tuple_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nla_policy</span>		<span class="o">=</span> <span class="n">nf_ct_port_nla_policy</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if IS_ENABLED(CONFIG_NF_CT_NETLINK_TIMEOUT)</span>
	<span class="p">.</span><span class="n">ctnl_timeout</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nlattr_to_obj</span>	<span class="o">=</span> <span class="n">tcp_timeout_nlattr_to_obj</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_to_nlattr</span>	<span class="o">=</span> <span class="n">tcp_timeout_obj_to_nlattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlattr_max</span>	<span class="o">=</span> <span class="n">CTA_TIMEOUT_TCP_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">TCP_CONNTRACK_TIMEOUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nla_policy</span>	<span class="o">=</span> <span class="n">tcp_timeout_nla_policy</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NF_CT_NETLINK_TIMEOUT */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="p">.</span><span class="n">ctl_table_users</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sysctl_table_users</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table_header</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sysctl_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctl_table</span>		<span class="o">=</span> <span class="n">tcp_sysctl_table</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nf_conntrack_l4proto_tcp6</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
