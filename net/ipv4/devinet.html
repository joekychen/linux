<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › devinet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>devinet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	NET3	IP device support routines.</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Derived from the IP parts of dev.c 1.0.19</span>
<span class="cm"> * 		Authors:	Ross Biro</span>
<span class="cm"> *				Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;</span>
<span class="cm"> *				Mark Evans, &lt;evansmp@uhura.aston.ac.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Additional Authors:</span>
<span class="cm"> *		Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;</span>
<span class="cm"> *		Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Changes:</span>
<span class="cm"> *		Alexey Kuznetsov:	pa_* fields are replaced with ifaddr</span>
<span class="cm"> *					lists.</span>
<span class="cm"> *		Cyrus Durgin:		updated for kmod</span>
<span class="cm"> *		Matthias Andree:	in devinet_ioctl, compare label and</span>
<span class="cm"> *					address (4.4BSD alias style support),</span>
<span class="cm"> *					fall back to comparing just the label</span>
<span class="cm"> *					if no match found.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/if_addr.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/igmp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hash.h&gt;</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/ip_fib.h&gt;</span>
<span class="cp">#include &lt;net/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="cp">#include &quot;fib_lookup.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="n">ipv4_devconf</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_ACCEPT_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SEND_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SECURE_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SHARED_MEDIA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="n">ipv4_devconf_dflt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_ACCEPT_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SEND_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SECURE_REDIRECTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_SHARED_MEDIA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IPV4_DEVCONF_ACCEPT_SOURCE_ROUTE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define IPV4_DEVCONF_DFLT(net, attr) \</span>
<span class="cp">	IPV4_DEVCONF((*net-&gt;ipv4.devconf_dflt), attr)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">ifa_ipv4_policy</span><span class="p">[</span><span class="n">IFA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">]</span>     	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]</span>   	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">IFA_BROADCAST</span><span class="p">]</span> 	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_U32</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">IFA_LABEL</span><span class="p">]</span>     	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_STRING</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* inet_addr_hash&#39;s shifting is dependent upon this IN4_ADDR_HSIZE</span>
<span class="cm"> * value.  So if you change this define, make appropriate changes to</span>
<span class="cm"> * inet_addr_hash as well.</span>
<span class="cm"> */</span>
<span class="cp">#define IN4_ADDR_HSIZE	256</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">inet_addr_lst</span><span class="p">[</span><span class="n">IN4_ADDR_HSIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">inet_addr_hash_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">inet_addr_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">addr</span> <span class="o">^</span> <span class="n">hash_ptr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">IN4_ADDR_HSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inet_hash_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">inet_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_addr_hash_lock</span><span class="p">);</span>
	<span class="n">hlist_add_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inet_addr_lst</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_addr_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inet_hash_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_addr_hash_lock</span><span class="p">);</span>
	<span class="n">hlist_del_init_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_addr_hash_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ip_dev_find - find the first device with a given source address.</span>
<span class="cm"> * @net: the net namespace</span>
<span class="cm"> * @addr: the source address</span>
<span class="cm"> * @devref: if true, take a reference on the found device</span>
<span class="cm"> *</span>
<span class="cm"> * If a caller uses devref=false, it should be protected by RCU, or RTNL</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">__ip_dev_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">devref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">inet_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inet_addr_lst</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">addr</span> <span class="p">};</span>
		<span class="k">struct</span> <span class="n">fib_result</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
		<span class="k">struct</span> <span class="n">fib_table</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

		<span class="cm">/* Fallback to FIB local table so that communication</span>
<span class="cm">		 * over loopback subnets work.</span>
<span class="cm">		 */</span>
		<span class="n">local</span> <span class="o">=</span> <span class="n">fib_get_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">RT_TABLE_LOCAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">fib_table_lookup</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">FIB_LOOKUP_NOREF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_LOCAL</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">FIB_RES_DEV</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">devref</span><span class="p">)</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__ip_dev_find</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rtmsg_ifa</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">inetaddr_chain</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">inet_del_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">destroy</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">devinet_sysctl_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">devinet_sysctl_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">devinet_sysctl_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">devinet_sysctl_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Locks all the inet devices. */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="nf">inet_alloc_ifa</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inet_rcu_free_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span><span class="p">,</span> <span class="n">rcu_head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="p">)</span>
		<span class="n">in_dev_put</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_free_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">rcu_head</span><span class="p">,</span> <span class="n">inet_rcu_free_ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">in_dev_finish_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
<span class="cp">#ifdef NET_REFCNT_DEBUG</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %p=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">dev</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;NIL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Freeing alive in_device %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">in_dev_finish_destroy</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="nf">inetdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">in_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">,</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">));</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">.</span><span class="n">sysctl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">arp_parms</span> <span class="o">=</span> <span class="n">neigh_parms_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arp_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">arp_parms</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPV4_DEVCONF</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">))</span>
		<span class="n">dev_disable_lro</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Reference in_dev-&gt;dev */</span>
	<span class="n">dev_hold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Account for reference dev-&gt;ip_ptr (below) */</span>
	<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="n">devinet_sysctl_register</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">ip_mc_init_dev</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span>
		<span class="n">ip_mc_up</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="cm">/* we can receive as soon as ip_ptr is set -- do this last */</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">in_dev</span><span class="p">;</span>
<span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">in_dev_rcu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span><span class="p">,</span> <span class="n">rcu_head</span><span class="p">);</span>
	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inetdev_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ip_mc_destroy_dev</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">devinet_sysctl_unregister</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">neigh_parms_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arp_tbl</span><span class="p">,</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">arp_parms</span><span class="p">);</span>
	<span class="n">arp_ifdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">rcu_head</span><span class="p">,</span> <span class="n">in_dev_rcu_put</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">inet_addr_onlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">a</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_primary_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span> <span class="o">||</span> <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__inet_del_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">destroy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">promote</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span> <span class="o">*</span><span class="n">ifa1</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">last_prim</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">prev_prom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_promote</span> <span class="o">=</span> <span class="n">IN_DEV_PROMOTE_SECONDARIES</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="cm">/* 1. Deleting primary ifaddr forces deletion all secondaries</span>
<span class="cm">	 * unless alias promotion is set</span>
<span class="cm">	 **/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_SECONDARY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_SECONDARY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&lt;=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span><span class="p">)</span>
				<span class="n">last_prim</span> <span class="o">=</span> <span class="n">ifa</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_SECONDARY</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">!=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ifap1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
				<span class="n">prev_prom</span> <span class="o">=</span> <span class="n">ifa</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_promote</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">inet_hash_remove</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ifap1</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>

				<span class="n">rtmsg_ifa</span><span class="p">(</span><span class="n">RTM_DELADDR</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
				<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span>
						<span class="n">NETDEV_DOWN</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
				<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">promote</span> <span class="o">=</span> <span class="n">ifa</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* On promotion all secondaries from subnet are changing</span>
<span class="cm">	 * the primary IP, we must remove all their routes silently</span>
<span class="cm">	 * and later to add them back with new prefsrc. Do this</span>
<span class="cm">	 * while all addresses are on the device list.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">promote</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">&amp;&amp;</span>
		    <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span>
			<span class="n">fib_del_ifaddr</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">ifa1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 2. Unlink it */</span>

	<span class="o">*</span><span class="n">ifap</span> <span class="o">=</span> <span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
	<span class="n">inet_hash_remove</span><span class="p">(</span><span class="n">ifa1</span><span class="p">);</span>

	<span class="cm">/* 3. Announce address deletion */</span>

	<span class="cm">/* Send message first, then call notifier.</span>
<span class="cm">	   At first sight, FIB update triggered by notifier</span>
<span class="cm">	   will refer to already deleted ifaddr, that could confuse</span>
<span class="cm">	   netlink listeners. It is not true: look, gated sees</span>
<span class="cm">	   that route deleted and if it still thinks that ifaddr</span>
<span class="cm">	   is valid, it will try to restore deleted routes... Grr.</span>
<span class="cm">	   So that, this order is correct.</span>
<span class="cm">	 */</span>
	<span class="n">rtmsg_ifa</span><span class="p">(</span><span class="n">RTM_DELADDR</span><span class="p">,</span> <span class="n">ifa1</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span> <span class="n">NETDEV_DOWN</span><span class="p">,</span> <span class="n">ifa1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">promote</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">next_sec</span> <span class="o">=</span> <span class="n">promote</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_prom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prev_prom</span><span class="o">-&gt;</span><span class="n">ifa_next</span> <span class="o">=</span> <span class="n">promote</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
			<span class="n">promote</span><span class="o">-&gt;</span><span class="n">ifa_next</span> <span class="o">=</span> <span class="n">last_prim</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
			<span class="n">last_prim</span><span class="o">-&gt;</span><span class="n">ifa_next</span> <span class="o">=</span> <span class="n">promote</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">promote</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFA_F_SECONDARY</span><span class="p">;</span>
		<span class="n">rtmsg_ifa</span><span class="p">(</span><span class="n">RTM_NEWADDR</span><span class="p">,</span> <span class="n">promote</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span>
				<span class="n">NETDEV_UP</span><span class="p">,</span> <span class="n">promote</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">next_sec</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">!=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="n">fib_add_ifaddr</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">destroy</span><span class="p">)</span>
		<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inet_del_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">destroy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="n">destroy</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__inet_insert_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa1</span><span class="p">,</span> <span class="o">**</span><span class="n">ifap</span><span class="p">,</span> <span class="o">**</span><span class="n">last_primary</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFA_F_SECONDARY</span><span class="p">;</span>
	<span class="n">last_primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa1</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_SECONDARY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&lt;=</span> <span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_scope</span><span class="p">)</span>
			<span class="n">last_primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">&amp;&amp;</span>
		    <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifa1</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">!=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">|=</span> <span class="n">IFA_F_SECONDARY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">&amp;</span> <span class="n">IFA_F_SECONDARY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_srandom</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">);</span>
		<span class="n">ifap</span> <span class="o">=</span> <span class="n">last_primary</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ifap</span> <span class="o">=</span> <span class="n">ifa</span><span class="p">;</span>

	<span class="n">inet_hash_insert</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">ifa</span><span class="p">);</span>

	<span class="cm">/* Send message first, then call notifier.</span>
<span class="cm">	   Notifier will trigger FIB update, so that</span>
<span class="cm">	   listeners of netlink will know about new ifaddr */</span>
	<span class="n">rtmsg_ifa</span><span class="p">(</span><span class="n">RTM_NEWADDR</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_insert_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_set_ifa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_free_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipv4_devconf_setall</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">!=</span> <span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="p">);</span>
		<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">))</span>
		<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">=</span> <span class="n">RT_SCOPE_HOST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Caller must hold RCU or RTNL :</span>
<span class="cm"> * We dont take a reference on found in_device</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="nf">inetdev_by_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">rcu_dereference_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">in_dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inetdev_by_index</span><span class="p">);</span>

<span class="cm">/* Called only from RTNL semaphored context. No locks. */</span>

<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="nf">inet_ifa_byprefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">prefix</span><span class="p">,</span>
				    <span class="n">__be32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">for_primary_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">==</span> <span class="n">mask</span> <span class="o">&amp;&amp;</span> <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ifa</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_rtm_deladdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifaddrmsg</span> <span class="o">*</span><span class="n">ifm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span> <span class="o">**</span><span class="n">ifap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ifm</span><span class="p">),</span> <span class="n">tb</span><span class="p">,</span> <span class="n">IFA_MAX</span><span class="p">,</span> <span class="n">ifa_ipv4_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">ifm</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">inetdev_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">!=</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LABEL</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">nla_strcmp</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LABEL</span><span class="p">],</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">!=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]),</span> <span class="n">ifa</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="nf">rtm_to_ifaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifaddrmsg</span> <span class="o">*</span><span class="n">ifm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ifm</span><span class="p">),</span> <span class="n">tb</span><span class="p">,</span> <span class="n">IFA_MAX</span><span class="p">,</span> <span class="n">ifa_ipv4_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">ifm</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">tb</span><span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_index</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">inet_alloc_ifa</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * A potential indev allocation can be left alive, it stays</span>
<span class="cm">		 * assigned to its device and is destroy with it.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">ipv4_devconf_setall</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tb</span><span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">];</span>

	<span class="n">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span><span class="p">;</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span><span class="p">);</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">=</span> <span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_flags</span><span class="p">;</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">=</span> <span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_scope</span><span class="p">;</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="p">;</span>

	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">=</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LOCAL</span><span class="p">]);</span>
	<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">=</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_ADDRESS</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_BROADCAST</span><span class="p">])</span>
		<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_BROADCAST</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFA_LABEL</span><span class="p">])</span>
		<span class="n">nla_strlcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">IFA_LABEL</span><span class="p">],</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ifa</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_rtm_newaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">rtm_to_ifaddr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ifa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Determine a default network mask, based on the IP address.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inet_abc_len</span><span class="p">(</span><span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Something else, probably a multicast. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">haddr</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSA</span><span class="p">(</span><span class="n">haddr</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSB</span><span class="p">(</span><span class="n">haddr</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSC</span><span class="p">(</span><span class="n">haddr</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">devinet_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin_orig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">**</span><span class="n">ifap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">colon</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tryaddrmatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Fetch the caller&#39;s info block into kernel space</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* save original address for comparison */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin_orig</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sin</span><span class="p">));</span>

	<span class="n">colon</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
		<span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_load</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:	<span class="cm">/* Get interface address */</span>
	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:	<span class="cm">/* Get the broadcast address */</span>
	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:	<span class="cm">/* Get the destination address */</span>
	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:	<span class="cm">/* Get the netmask for the interface */</span>
		<span class="cm">/* Note that these ioctls will not sleep,</span>
<span class="cm">		   so that we do not impose a lock.</span>
<span class="cm">		   One day we will be forced to put shlock here (I mean SMP)</span>
<span class="cm">		 */</span>
		<span class="n">tryaddrmatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin_orig</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sin</span><span class="p">));</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFFLAGS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:	<span class="cm">/* Set interface address (and family) */</span>
	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:	<span class="cm">/* Set the broadcast address */</span>
	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:	<span class="cm">/* Set the destination address */</span>
	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>: 	<span class="cm">/* Set the netmask for the interface */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
		<span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>

	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tryaddrmatch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Matthias Andree */</span>
			<span class="cm">/* compare label and address (4.4BSD style) */</span>
			<span class="cm">/* note: we only do this for a limited set of ioctls</span>
<span class="cm">			   and only if the original address family was AF_INET.</span>
<span class="cm">			   This is checked above. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
			     <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">sin_orig</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span>
							<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span> <span class="cm">/* found */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* we didn&#39;t get a match, maybe the application is</span>
<span class="cm">		   4.3BSD-style and passed in junk so we fall back to</span>
<span class="cm">		   comparing just the label */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="o">*</span><span class="n">ifap</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
			     <span class="n">ifap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCSIFADDR</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCSIFFLAGS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:	<span class="cm">/* Get interface address */</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rarok</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:	<span class="cm">/* Get the broadcast address */</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rarok</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:	<span class="cm">/* Get the destination address */</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rarok</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:	<span class="cm">/* Get the netmask for the interface */</span>
		<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rarok</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFFLAGS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
				<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_change_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:	<span class="cm">/* Set interface address (and family) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_abc_len</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="n">ifa</span> <span class="o">=</span> <span class="n">inet_alloc_ifa</span><span class="p">();</span>
			<span class="n">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifa</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">colon</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">==</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_POINTOPOINT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="n">inet_abc_len</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">);</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_BROADCAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">)</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">|</span>
						     <span class="o">~</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">inet_set_ifa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:	<span class="cm">/* Set the broadcast address */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">!=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
			<span class="n">inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:	<span class="cm">/* Set the destination address */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">==</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_abc_len</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="n">inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>: 	<span class="cm">/* Set the netmask for the interface */</span>

		<span class="cm">/*</span>
<span class="cm">		 *	The mask we set must be legal.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bad_mask</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">!=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">old_mask</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
			<span class="n">inet_del_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ifap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
			<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="n">inet_mask_len</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">);</span>

			<span class="cm">/* See if current broadcast address matches</span>
<span class="cm">			 * with current netmask, then recalculate</span>
<span class="cm">			 * the broadcast address. Otherwise it&#39;s a</span>
<span class="cm">			 * funny address, so don&#39;t touch it since</span>
<span class="cm">			 * the user seems to know what (s)he&#39;s doing...</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_BROADCAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">==</span>
			     <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="o">|~</span><span class="n">old_mask</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">=</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">|</span>
						      <span class="o">~</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">rarok:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_gifconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">).</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">).</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span>
								<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span>  <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">);</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__be32</span> <span class="nf">inet_select_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scope</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_in_dev</span><span class="p">;</span>

	<span class="n">for_primary_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&gt;</span> <span class="n">scope</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span> <span class="o">||</span> <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
<span class="nl">no_in_dev:</span>

	<span class="cm">/* Not loopback addresses on loopback should be preferred</span>
<span class="cm">	   in this case. It is importnat that lo is the first interface</span>
<span class="cm">	   in dev_base list.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">for_primary_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">!=</span> <span class="n">RT_SCOPE_LINK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&lt;=</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inet_select_addr</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">confirm_addr_indev</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">dst</span><span class="p">,</span>
			      <span class="n">__be32</span> <span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scope</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">same</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">local</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">||</span> <span class="o">!</span><span class="n">local</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&lt;=</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">same</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">same</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span> <span class="o">||</span> <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">dst</span> <span class="o">||</span> <span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">ifa</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">same</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">local</span> <span class="o">||</span> <span class="o">!</span><span class="n">dst</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="cm">/* Is the selected addr into dst subnet? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inet_ifa_match</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ifa</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="cm">/* No, then can we use new local src? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">&lt;=</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* search for large dst subnet for addr */</span>
				<span class="n">same</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">same</span> <span class="o">?</span> <span class="n">addr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Confirm that local IP address exists using wildcards:</span>
<span class="cm"> * - in_dev: only on this interface, 0=any interface</span>
<span class="cm"> * - dst: only in the same subnet as dst, 0=any dst</span>
<span class="cm"> * - local: address, 0=autoselect the local address</span>
<span class="cm"> * - scope: maximum allowed scope value for the local address</span>
<span class="cm"> */</span>
<span class="n">__be32</span> <span class="nf">inet_confirm_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span>
			 <span class="n">__be32</span> <span class="n">dst</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scope</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">RT_SCOPE_LINK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">confirm_addr_indev</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">confirm_addr_indev</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">inet_confirm_addr</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Device notifier</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">register_inetaddr_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_inetaddr_notifier</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">unregister_inetaddr_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inetaddr_chain</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_inetaddr_notifier</span><span class="p">);</span>

<span class="cm">/* Rename ifa_labels for a device name change. Make some effort to preserve</span>
<span class="cm"> * existing alias numbering and to create unique labels if possible.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">inetdev_changename</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">named</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">old</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">],</span> <span class="o">*</span><span class="n">dot</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">named</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="n">dot</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="s">&quot;:%d&quot;</span><span class="p">,</span> <span class="n">named</span><span class="p">);</span>
			<span class="n">dot</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IFNAMSIZ</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dot</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span> <span class="o">+</span> <span class="p">(</span><span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dot</span><span class="p">);</span>
<span class="nl">skip:</span>
		<span class="n">rtmsg_ifa</span><span class="p">(</span><span class="n">RTM_NEWADDR</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">inetdev_valid_mtu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">68</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inetdev_send_gratuitous_arp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span>
	     <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arp_send</span><span class="p">(</span><span class="n">ARPOP_REQUEST</span><span class="p">,</span> <span class="n">ETH_P_ARP</span><span class="p">,</span>
			 <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			 <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called only under RTNL semaphore */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inetdev_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">NETDEV_REGISTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">in_dev</span> <span class="o">=</span> <span class="n">inetdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IN_DEV_CONF_SET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOXFRM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">IN_DEV_CONF_SET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOPOLICY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">NETDEV_CHANGEMTU</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Re-enabling IP */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inetdev_valid_mtu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">))</span>
				<span class="n">in_dev</span> <span class="o">=</span> <span class="n">inetdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_REGISTER</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inetdev_valid_mtu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">inet_alloc_ifa</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">=</span>
				  <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_LOOPBACK</span><span class="p">);</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span> <span class="o">=</span> <span class="n">inet_make_mask</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
				<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="p">;</span>
				<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">=</span> <span class="n">RT_SCOPE_HOST</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
				<span class="n">inet_insert_ifa</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ip_mc_up</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGEADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IN_DEV_ARP_NOTIFY</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">NETDEV_NOTIFY_PEERS</span>:
		<span class="cm">/* Send gratuitous ARP to notify of link change */</span>
		<span class="n">inetdev_send_gratuitous_arp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">ip_mc_down</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_PRE_TYPE_CHANGE</span>:
		<span class="n">ip_mc_unmap</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_POST_TYPE_CHANGE</span>:
		<span class="n">ip_mc_remap</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGEMTU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">inetdev_valid_mtu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* disable IP when MTU is not enough */</span>
	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="n">inetdev_destroy</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGENAME</span>:
		<span class="cm">/* Do not notify about label change, this event is</span>
<span class="cm">		 * not interesting to applications using netlink.</span>
<span class="cm">		 */</span>
		<span class="n">inetdev_changename</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>

		<span class="n">devinet_sysctl_unregister</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="n">devinet_sysctl_register</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ip_netdev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">inetdev_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">inet_nlmsg_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifaddrmsg</span><span class="p">))</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="cm">/* IFA_ADDRESS */</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="cm">/* IFA_LOCAL */</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="cm">/* IFA_BROADCAST */</span>
	       <span class="o">+</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">IFNAMSIZ</span><span class="p">);</span> <span class="cm">/* IFA_LABEL */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_fill_ifaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifaddrmsg</span> <span class="o">*</span><span class="n">ifm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span>  <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ifm</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">ifm</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_prefixlen</span><span class="p">;</span>
	<span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_flags</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_flags</span><span class="o">|</span><span class="n">IFA_F_PERMANENT</span><span class="p">;</span>
	<span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_scope</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_scope</span><span class="p">;</span>
	<span class="n">ifm</span><span class="o">-&gt;</span><span class="n">ifa_index</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFA_ADDRESS</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFA_LOCAL</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFA_BROADCAST</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_broadcast</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	     <span class="n">nla_put_string</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFA_LABEL</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_label</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_dump_ifaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="n">s_h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ip_idx</span><span class="p">,</span> <span class="n">s_ip_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">s_h</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">s_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">s_ip_idx</span> <span class="o">=</span> <span class="n">ip_idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">s_h</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">NETDEV_HASHENTRIES</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">,</span> <span class="n">s_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_index_head</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">index_hlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s_idx</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">s_h</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="n">s_idx</span><span class="p">)</span>
				<span class="n">s_ip_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">,</span> <span class="n">ip_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span>
			     <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">,</span> <span class="n">ip_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ip_idx</span> <span class="o">&lt;</span> <span class="n">s_ip_idx</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inet_fill_ifaddr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span>
					     <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					     <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
					     <span class="n">RTM_NEWADDR</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rcu_read_unlock</span><span class="p">();</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="nl">cont:</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtmsg_ifa</span><span class="p">(</span><span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">nlh</span> <span class="o">?</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">nlmsg_new</span><span class="p">(</span><span class="n">inet_nlmsg_size</span><span class="p">(),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">inet_fill_ifaddr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -EMSGSIZE implies BUG in inet_nlmsg_size() */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtnl_notify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">RTNLGRP_IPV4_IFADDR</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">errout:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rtnl_set_sk_err</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">RTNLGRP_IPV4_IFADDR</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">inet_get_link_af_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">rcu_dereference_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nla_total_size</span><span class="p">(</span><span class="n">IPV4_DEVCONF_MAX</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* IFLA_INET_CONF */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_fill_link_af</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">rcu_dereference_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IFLA_INET_CONF</span><span class="p">,</span> <span class="n">IPV4_DEVCONF_MAX</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPV4_DEVCONF_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">inet_af_policy</span><span class="p">[</span><span class="n">IFLA_INET_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IFLA_INET_CONF</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_NESTED</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_validate_link_af</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">IFLA_INET_MAX</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="n">inet_af_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_CONF</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_CONF</span><span class="p">],</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cfgid</span> <span class="o">=</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cfgid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cfgid</span> <span class="o">&gt;</span> <span class="n">IPV4_DEVCONF_MAX</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_set_link_af</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">IFLA_INET_MAX</span><span class="p">,</span> <span class="n">nla</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_CONF</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nla_for_each_nested</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">IFLA_INET_CONF</span><span class="p">],</span> <span class="n">rem</span><span class="p">)</span>
			<span class="n">ipv4_devconf_set</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">nla_type</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devinet_copy_dflt_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">.</span><span class="n">state</span><span class="p">))</span>
			<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* called with RTNL locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">inet_forward_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">on</span> <span class="o">=</span> <span class="n">IPV4_DEVCONF_ALL</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">);</span>

	<span class="n">IPV4_DEVCONF_ALL</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ACCEPT_REDIRECTS</span><span class="p">)</span> <span class="o">=</span> <span class="o">!</span><span class="n">on</span><span class="p">;</span>
	<span class="n">IPV4_DEVCONF_DFLT</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">)</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span>

	<span class="n">for_each_netdev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">dev_disable_lro</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="n">IN_DEV_CONF_SET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">devinet_conf_proc</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="o">*</span><span class="n">cnf</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">extra1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">extra2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">cnf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cnf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnf</span> <span class="o">==</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span><span class="p">)</span>
			<span class="n">devinet_copy_dflt_conf</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IPV4_DEVCONF_ACCEPT_LOCAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">rt_cache_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">devinet_sysctl_forward</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">valp</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">extra2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">valp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">IPV4_DEVCONF_DFLT</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span> <span class="p">{</span>
				<span class="cm">/* Restore the original values before restarting */</span>
				<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">IPV4_DEVCONF_ALL</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">inet_forward_change</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">valp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="o">*</span><span class="n">cnf</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">extra1</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span>
					<span class="n">container_of</span><span class="p">(</span><span class="n">cnf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span><span class="p">,</span> <span class="n">cnf</span><span class="p">);</span>
				<span class="n">dev_disable_lro</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="n">rt_cache_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipv4_doint_and_flush</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">extra2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">valp</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">rt_cache_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEVINET_SYSCTL_ENTRY(attr, name, mval, proc) \</span>
<span class="cp">	{ \</span>
<span class="cp">		.procname	= name, \</span>
<span class="cp">		.data		= ipv4_devconf.data + \</span>
<span class="cp">				  IPV4_DEVCONF_ ## attr - 1, \</span>
<span class="cp">		.maxlen		= sizeof(int), \</span>
<span class="cp">		.mode		= mval, \</span>
<span class="cp">		.proc_handler	= proc, \</span>
<span class="cp">		.extra1		= &amp;ipv4_devconf, \</span>
<span class="cp">	}</span>

<span class="cp">#define DEVINET_SYSCTL_RW_ENTRY(attr, name) \</span>
<span class="cp">	DEVINET_SYSCTL_ENTRY(attr, name, 0644, devinet_conf_proc)</span>

<span class="cp">#define DEVINET_SYSCTL_RO_ENTRY(attr, name) \</span>
<span class="cp">	DEVINET_SYSCTL_ENTRY(attr, name, 0444, devinet_conf_proc)</span>

<span class="cp">#define DEVINET_SYSCTL_COMPLEX_ENTRY(attr, name, proc) \</span>
<span class="cp">	DEVINET_SYSCTL_ENTRY(attr, name, 0644, proc)</span>

<span class="cp">#define DEVINET_SYSCTL_FLUSHING_ENTRY(attr, name) \</span>
<span class="cp">	DEVINET_SYSCTL_COMPLEX_ENTRY(attr, name, ipv4_doint_and_flush)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">devinet_sysctl_table</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">sysctl_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">devinet_vars</span><span class="p">[</span><span class="n">__IPV4_DEVCONF_MAX</span><span class="p">];</span>
<span class="p">}</span> <span class="n">devinet_sysctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">devinet_vars</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DEVINET_SYSCTL_COMPLEX_ENTRY</span><span class="p">(</span><span class="n">FORWARDING</span><span class="p">,</span> <span class="s">&quot;forwarding&quot;</span><span class="p">,</span>
					     <span class="n">devinet_sysctl_forward</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RO_ENTRY</span><span class="p">(</span><span class="n">MC_FORWARDING</span><span class="p">,</span> <span class="s">&quot;mc_forwarding&quot;</span><span class="p">),</span>

		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ACCEPT_REDIRECTS</span><span class="p">,</span> <span class="s">&quot;accept_redirects&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">SECURE_REDIRECTS</span><span class="p">,</span> <span class="s">&quot;secure_redirects&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">SHARED_MEDIA</span><span class="p">,</span> <span class="s">&quot;shared_media&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">RP_FILTER</span><span class="p">,</span> <span class="s">&quot;rp_filter&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">SEND_REDIRECTS</span><span class="p">,</span> <span class="s">&quot;send_redirects&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ACCEPT_SOURCE_ROUTE</span><span class="p">,</span>
					<span class="s">&quot;accept_source_route&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ACCEPT_LOCAL</span><span class="p">,</span> <span class="s">&quot;accept_local&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">SRC_VMARK</span><span class="p">,</span> <span class="s">&quot;src_valid_mark&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">PROXY_ARP</span><span class="p">,</span> <span class="s">&quot;proxy_arp&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">MEDIUM_ID</span><span class="p">,</span> <span class="s">&quot;medium_id&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">BOOTP_RELAY</span><span class="p">,</span> <span class="s">&quot;bootp_relay&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">LOG_MARTIANS</span><span class="p">,</span> <span class="s">&quot;log_martians&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;tag&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ARPFILTER</span><span class="p">,</span> <span class="s">&quot;arp_filter&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ARP_ANNOUNCE</span><span class="p">,</span> <span class="s">&quot;arp_announce&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ARP_IGNORE</span><span class="p">,</span> <span class="s">&quot;arp_ignore&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ARP_ACCEPT</span><span class="p">,</span> <span class="s">&quot;arp_accept&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">ARP_NOTIFY</span><span class="p">,</span> <span class="s">&quot;arp_notify&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_RW_ENTRY</span><span class="p">(</span><span class="n">PROXY_ARP_PVLAN</span><span class="p">,</span> <span class="s">&quot;proxy_arp_pvlan&quot;</span><span class="p">),</span>

		<span class="n">DEVINET_SYSCTL_FLUSHING_ENTRY</span><span class="p">(</span><span class="n">NOXFRM</span><span class="p">,</span> <span class="s">&quot;disable_xfrm&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_FLUSHING_ENTRY</span><span class="p">(</span><span class="n">NOPOLICY</span><span class="p">,</span> <span class="s">&quot;disable_policy&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_FLUSHING_ENTRY</span><span class="p">(</span><span class="n">FORCE_IGMP_VERSION</span><span class="p">,</span>
					      <span class="s">&quot;force_igmp_version&quot;</span><span class="p">),</span>
		<span class="n">DEVINET_SYSCTL_FLUSHING_ENTRY</span><span class="p">(</span><span class="n">PROMOTE_SECONDARIES</span><span class="p">,</span>
					      <span class="s">&quot;promote_secondaries&quot;</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__devinet_sysctl_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">devinet_sysctl_table</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;net/ipv4/conf/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinet_sysctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">devinet_vars</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">devinet_vars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ipv4_devconf</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">devinet_vars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">extra1</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">devinet_vars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">extra2</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">&quot;net/ipv4/conf/%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sysctl_header</span> <span class="o">=</span> <span class="n">register_net_sysctl</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">devinet_vars</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sysctl_header</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sysctl</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__devinet_sysctl_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="o">*</span><span class="n">cnf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devinet_sysctl_table</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">cnf</span><span class="o">-&gt;</span><span class="n">sysctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cnf</span><span class="o">-&gt;</span><span class="n">sysctl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">unregister_net_sysctl_table</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sysctl_header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devinet_sysctl_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">neigh_sysctl_register</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">arp_parms</span><span class="p">,</span> <span class="s">&quot;ipv4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__devinet_sysctl_register</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devinet_sysctl_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__devinet_sysctl_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">);</span>
	<span class="n">neigh_sysctl_unregister</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">arp_parms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">ctl_forward_entry</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;ip_forward&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf</span><span class="p">.</span><span class="n">data</span><span class="p">[</span>
					<span class="n">IPV4_DEVCONF_FORWARDING</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">devinet_sysctl_forward</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">devinet_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv4_devconf</span> <span class="o">*</span><span class="n">all</span><span class="p">,</span> <span class="o">*</span><span class="n">dflt</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="k">struct</span> <span class="n">ctl_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">ctl_forward_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">forw_hdr</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf</span><span class="p">;</span>
	<span class="n">dflt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf_dflt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">all</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">all</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ipv4_devconf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">all</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_alloc_all</span><span class="p">;</span>

		<span class="n">dflt</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">dflt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ipv4_devconf_dflt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dflt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_alloc_dflt</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctl_forward_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_alloc_ctl</span><span class="p">;</span>

		<span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">all</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">IPV4_DEVCONF_FORWARDING</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extra1</span> <span class="o">=</span> <span class="n">all</span><span class="p">;</span>
		<span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extra2</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__devinet_sysctl_register</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="n">all</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg_all</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__devinet_sysctl_register</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="n">dflt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg_dflt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">forw_hdr</span> <span class="o">=</span> <span class="n">register_net_sysctl</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;net/ipv4&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">forw_hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg_ctl</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">forw_hdr</span> <span class="o">=</span> <span class="n">forw_hdr</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_all</span> <span class="o">=</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span> <span class="o">=</span> <span class="n">dflt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="nl">err_reg_ctl:</span>
	<span class="n">__devinet_sysctl_unregister</span><span class="p">(</span><span class="n">dflt</span><span class="p">);</span>
<span class="nl">err_reg_dflt:</span>
	<span class="n">__devinet_sysctl_unregister</span><span class="p">(</span><span class="n">all</span><span class="p">);</span>
<span class="nl">err_reg_all:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">!=</span> <span class="n">ctl_forward_entry</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
<span class="nl">err_alloc_ctl:</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dflt</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf_dflt</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dflt</span><span class="p">);</span>
<span class="nl">err_alloc_dflt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">all</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ipv4_devconf</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">all</span><span class="p">);</span>
<span class="nl">err_alloc_all:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_exit</span> <span class="kt">void</span> <span class="nf">devinet_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="k">struct</span> <span class="n">ctl_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">forw_hdr</span><span class="o">-&gt;</span><span class="n">ctl_table_arg</span><span class="p">;</span>
	<span class="n">unregister_net_sysctl_table</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">forw_hdr</span><span class="p">);</span>
	<span class="n">__devinet_sysctl_unregister</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span><span class="p">);</span>
	<span class="n">__devinet_sysctl_unregister</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_all</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_dflt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">devconf_all</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_initdata</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">devinet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">devinet_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">devinet_exit_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_af_ops</span> <span class="n">inet_af_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		  <span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_link_af</span>	  <span class="o">=</span> <span class="n">inet_fill_link_af</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_af_size</span> <span class="o">=</span> <span class="n">inet_get_link_af_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">validate_link_af</span> <span class="o">=</span> <span class="n">inet_validate_link_af</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_af</span>	  <span class="o">=</span> <span class="n">inet_set_link_af</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">devinet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IN4_ADDR_HSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_addr_lst</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinet_ops</span><span class="p">);</span>

	<span class="n">register_gifconf</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">inet_gifconf</span><span class="p">);</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_netdev_notifier</span><span class="p">);</span>

	<span class="n">rtnl_af_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_af_ops</span><span class="p">);</span>

	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">RTM_NEWADDR</span><span class="p">,</span> <span class="n">inet_rtm_newaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">RTM_DELADDR</span><span class="p">,</span> <span class="n">inet_rtm_deladdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">RTM_GETADDR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">inet_dump_ifaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
