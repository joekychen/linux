<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › ipconfig.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ipconfig.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Automatic Configuration of IP -- use DHCP, BOOTP, RARP, or</span>
<span class="cm"> *  user-supplied information to configure own IP address and routes.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1996-1998 Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Derived from network configuration code in fs/nfs/nfsroot.c,</span>
<span class="cm"> *  originally Copyright (C) 1995, 1996 Gero Kuhlmann and me.</span>
<span class="cm"> *</span>
<span class="cm"> *  BOOTP rewritten to construct and analyse packets itself instead</span>
<span class="cm"> *  of misusing the IP layer. num_bugs_causing_wrong_arp_replies--;</span>
<span class="cm"> *					     -- MJ, December 1998</span>
<span class="cm"> *</span>
<span class="cm"> *  Fixed ip_auto_config_setup calling at startup in the new &quot;Linker Magic&quot;</span>
<span class="cm"> *  initialization scheme.</span>
<span class="cm"> *	- Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;, 08/11/1999</span>
<span class="cm"> *</span>
<span class="cm"> *  DHCP support added.  To users this looks like a whole separate</span>
<span class="cm"> *  protocol, but we know it&#39;s just a bag on the side of BOOTP.</span>
<span class="cm"> *		-- Chip Salzenberg &lt;chip@valinux.com&gt;, May 2000</span>
<span class="cm"> *</span>
<span class="cm"> *  Ported DHCP support from 2.2.16 to 2.4.0-test4</span>
<span class="cm"> *              -- Eric Biederman &lt;ebiederman@lnxi.com&gt;, 30 Aug 2000</span>
<span class="cm"> *</span>
<span class="cm"> *  Merged changes from 2.2.19 into 2.4.3</span>
<span class="cm"> *              -- Eric Biederman &lt;ebiederman@lnxi.com&gt;, 22 April Aug 2001</span>
<span class="cm"> *</span>
<span class="cm"> *  Multiple Nameservers in /proc/net/pnp</span>
<span class="cm"> *              --  Josef Siemes &lt;jsiemes@web.de&gt;, Aug 2002</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ipconfig.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>

<span class="cm">/* Define this to allow debugging output */</span>
<span class="cp">#undef IPCONFIG_DEBUG</span>

<span class="cp">#ifdef IPCONFIG_DEBUG</span>
<span class="cp">#define DBG(x) printk x</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(x) do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_IP_PNP_DHCP)</span>
<span class="cp">#define IPCONFIG_DHCP</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_IP_PNP_BOOTP) || defined(CONFIG_IP_PNP_DHCP)</span>
<span class="cp">#define IPCONFIG_BOOTP</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_IP_PNP_RARP)</span>
<span class="cp">#define IPCONFIG_RARP</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(IPCONFIG_BOOTP) || defined(IPCONFIG_RARP)</span>
<span class="cp">#define IPCONFIG_DYNAMIC</span>
<span class="cp">#endif</span>

<span class="cm">/* Define the friendly delay before and after opening net devices */</span>
<span class="cp">#define CONF_POST_OPEN		10	</span><span class="cm">/* After opening: 10 msecs */</span><span class="cp"></span>
<span class="cp">#define CONF_CARRIER_TIMEOUT	120000	</span><span class="cm">/* Wait for carrier timeout */</span><span class="cp"></span>

<span class="cm">/* Define the timeout for waiting for a DHCP/BOOTP/RARP reply */</span>
<span class="cp">#define CONF_OPEN_RETRIES 	2	</span><span class="cm">/* (Re)open devices twice */</span><span class="cp"></span>
<span class="cp">#define CONF_SEND_RETRIES 	6	</span><span class="cm">/* Send six requests per open */</span><span class="cp"></span>
<span class="cp">#define CONF_INTER_TIMEOUT	(HZ/2)	</span><span class="cm">/* Inter-device timeout: 1/2 second */</span><span class="cp"></span>
<span class="cp">#define CONF_BASE_TIMEOUT	(HZ*2)	</span><span class="cm">/* Initial timeout: 2 seconds */</span><span class="cp"></span>
<span class="cp">#define CONF_TIMEOUT_RANDOM	(HZ)	</span><span class="cm">/* Maximum amount of randomization */</span><span class="cp"></span>
<span class="cp">#define CONF_TIMEOUT_MULT	*7/4	</span><span class="cm">/* Rate of timeout growth */</span><span class="cp"></span>
<span class="cp">#define CONF_TIMEOUT_MAX	(HZ*30)	</span><span class="cm">/* Maximum allowed timeout */</span><span class="cp"></span>
<span class="cp">#define CONF_NAMESERVERS_MAX   3       </span><span class="cm">/* Maximum number of nameservers</span>
<span class="cm">					   - &#39;3&#39; from resolv.h */</span><span class="cp"></span>

<span class="cp">#define NONE cpu_to_be32(INADDR_NONE)</span>
<span class="cp">#define ANY cpu_to_be32(INADDR_ANY)</span>

<span class="cm">/*</span>
<span class="cm"> * Public IP configuration</span>
<span class="cm"> */</span>

<span class="cm">/* This is used by platforms which might be able to set the ipconfig</span>
<span class="cm"> * variables using firmware environment vars.  If this is set, it will</span>
<span class="cm"> * ignore such firmware variables.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ic_set_manually</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* IPconfig parameters set manually */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_enable</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* IP config enabled? */</span>

<span class="cm">/* Protocol choice */</span>
<span class="kt">int</span> <span class="n">ic_proto_enabled</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#ifdef IPCONFIG_BOOTP</span>
			<span class="o">|</span> <span class="n">IC_BOOTP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IP_PNP_DHCP</span>
			<span class="o">|</span> <span class="n">IC_USE_DHCP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_RARP</span>
			<span class="o">|</span> <span class="n">IC_RARP</span>
<span class="cp">#endif</span>
			<span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_host_name_set</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Host name set by us? */</span>

<span class="n">__be32</span> <span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>		<span class="cm">/* My IP address */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>	<span class="cm">/* Netmask for local subnet */</span>
<span class="n">__be32</span> <span class="n">ic_gateway</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>	<span class="cm">/* Gateway IP address */</span>

<span class="n">__be32</span> <span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>	<span class="cm">/* Boot server IP address */</span>

<span class="n">__be32</span> <span class="n">root_server_addr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>	<span class="cm">/* Address of NFS server */</span>
<span class="n">u8</span> <span class="n">root_server_path</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>	<span class="cm">/* Path to mount as root */</span>

<span class="n">__be32</span> <span class="n">ic_dev_xid</span><span class="p">;</span>		<span class="cm">/* Device under configuration */</span>

<span class="cm">/* vendor class identifier */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">vendor_class_identifier</span><span class="p">[</span><span class="mi">253</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cm">/* Persistent data: */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_proto_used</span><span class="p">;</span>			<span class="cm">/* Protocol used, if any */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="n">ic_nameservers</span><span class="p">[</span><span class="n">CONF_NAMESERVERS_MAX</span><span class="p">];</span> <span class="cm">/* DNS Server IP addresses */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ic_domain</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>		<span class="cm">/* DNS (not NIS) domain name */</span>

<span class="cm">/*</span>
<span class="cm"> * Private state.</span>
<span class="cm"> */</span>

<span class="cm">/* Name of user-selected boot device */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">user_dev_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="cm">/* Protocols supported by available interfaces */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_proto_have_if</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* MTU for boot device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_dev_mtu</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ic_recv_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">ic_got_reply</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Proto(s) that replied */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_DHCP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_dhcp_msgtype</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* DHCP msg type received */</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *	Network devices</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ic_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">able</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">xid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">ic_first_dev</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="cm">/* List of open device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ic_dev</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* Selected device */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">ic_is_init_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">user_dev_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">user_dev_name</span><span class="p">)</span> <span class="o">:</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_POINTOPOINT</span><span class="o">|</span><span class="n">IFF_BROADCAST</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_open_devs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">last</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oflags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ic_first_dev</span><span class="p">;</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="cm">/* bring loopback device up first */</span>
	<span class="n">for_each_netdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_change_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Failed to open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_netdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_is_init_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">able</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">364</span><span class="p">)</span>
				<span class="n">able</span> <span class="o">|=</span> <span class="n">IC_BOOTP</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: Ignoring device %s, MTU %d too small&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_NOARP</span><span class="p">))</span>
				<span class="n">able</span> <span class="o">|=</span> <span class="n">IC_RARP</span><span class="p">;</span>
			<span class="n">able</span> <span class="o">&amp;=</span> <span class="n">ic_proto_enabled</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">able</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">oflags</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_change_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">oflags</span> <span class="o">|</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Failed to open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ic_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rtnl_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">oflags</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">able</span> <span class="o">=</span> <span class="n">able</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">able</span> <span class="o">&amp;</span> <span class="n">IC_BOOTP</span><span class="p">)</span>
				<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ic_proto_have_if</span> <span class="o">|=</span> <span class="n">able</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;IP-Config: %s UP (able=%d, xid=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">able</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no point in waiting if we could not bring up at least one device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_first_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">have_carrier</span><span class="p">;</span>

	<span class="cm">/* wait for a carrier on at least one device */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CONF_CARRIER_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_netdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ic_is_init_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">have_carrier</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">have_carrier:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_first_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_dev_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Device `%s&#39; not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">user_dev_name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: No network devices available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_close_devs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">d</span> <span class="o">=</span> <span class="n">next</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">ic_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;IP-Config: Downing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="n">dev_change_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Interface to various network functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_sockaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_devinet_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">devinet_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_dev_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">dev_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_route_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtentry</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ip_rt_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Set up interface addresses and routes.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_setup_if</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">.</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="n">ifr_ifrn</span><span class="p">.</span><span class="n">ifrn_name</span><span class="p">,</span> <span class="n">ic_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">set_sockaddr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">ic_myaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ic_devinet_ioctl</span><span class="p">(</span><span class="n">SIOCSIFADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Unable to set interface address (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_sockaddr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">ic_netmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ic_devinet_ioctl</span><span class="p">(</span><span class="n">SIOCSIFNETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Unable to set interface netmask (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_sockaddr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">ic_myaddr</span> <span class="o">|</span> <span class="o">~</span><span class="n">ic_netmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ic_devinet_ioctl</span><span class="p">(</span><span class="n">SIOCSIFBRDADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Unable to set interface broadcast address (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Handle the case where we need non-standard MTU on the boot link (a network</span>
<span class="cm">	 * using jumbo frames, for instance).  If we can&#39;t set the mtu, don&#39;t error</span>
<span class="cm">	 * out, we&#39;ll try to muddle along.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_dev_mtu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ic_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ir</span><span class="p">.</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">ic_dev_mtu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ic_dev_ioctl</span><span class="p">(</span><span class="n">SIOCSIFMTU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Unable to set interface mtu to %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ic_dev_mtu</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_setup_routes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No need to setup device routes, only the default route... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ic_gateway</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtentry</span> <span class="n">rm</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rm</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ic_gateway</span> <span class="o">^</span> <span class="n">ic_myaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ic_netmask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Gateway not on directly connected network</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_sockaddr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rm</span><span class="p">.</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_sockaddr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rm</span><span class="p">.</span><span class="n">rt_genmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_sockaddr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rm</span><span class="p">.</span><span class="n">rt_gateway</span><span class="p">,</span> <span class="n">ic_gateway</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rm</span><span class="p">.</span><span class="n">rt_flags</span> <span class="o">=</span> <span class="n">RTF_UP</span> <span class="o">|</span> <span class="n">RTF_GATEWAY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ic_route_ioctl</span><span class="p">(</span><span class="n">SIOCADDRT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Cannot add default route (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Fill in default values for all missing parameters.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_defaults</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *	At this point we have no userspace running so need not</span>
<span class="cm">	 *	claim locks on system_utsname</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_host_name_set</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root_server_addr</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">root_server_addr</span> <span class="o">=</span> <span class="n">ic_servaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ic_netmask</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSA</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ic_myaddr</span><span class="p">)))</span>
			<span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">IN_CLASSA_NET</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSB</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ic_myaddr</span><span class="p">)))</span>
			<span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">IN_CLASSB_NET</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IN_CLASSC</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ic_myaddr</span><span class="p">)))</span>
			<span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">IN_CLASSC_NET</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Unable to guess netmask for address %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IP-Config: Guessing netmask %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_netmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	RARP support.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef IPCONFIG_RARP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_rarp_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">rarp_packet_type</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>	<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_RARP</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span> <span class="o">=</span>	<span class="n">ic_rarp_recv</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_rarp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rarp_packet_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_rarp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rarp_packet_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Process received RARP packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ic_rarp_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arphdr</span> <span class="o">*</span><span class="n">rarp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rarp_ptr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">sip</span><span class="p">,</span> <span class="n">tip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha</span><span class="p">,</span> <span class="o">*</span><span class="n">tha</span><span class="p">;</span>		<span class="cm">/* s for &quot;source&quot;, t for &quot;target&quot; */</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NET_RX_DROP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arphdr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* Basic sanity checks can be done without the lock.  */</span>
	<span class="n">rarp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">arphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* If this test doesn&#39;t pass, it&#39;s not IP, or we should</span>
<span class="cm">	 * ignore it anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rarp</span><span class="o">-&gt;</span><span class="n">ar_hln</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">rarp</span><span class="o">-&gt;</span><span class="n">ar_hrd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s not a RARP reply, delete it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rarp</span><span class="o">-&gt;</span><span class="n">ar_op</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ARPOP_RREPLY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s not Ethernet, delete it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rarp</span><span class="o">-&gt;</span><span class="n">ar_pro</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_hdr_len</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* OK, it is all there and looks valid, process... */</span>
	<span class="n">rarp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">arphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rarp_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rarp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* One reply at a time, please. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_recv_lock</span><span class="p">);</span>

	<span class="cm">/* If we already have a reply, just drop the packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_got_reply</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

	<span class="cm">/* Find the ic_device that the packet arrived on */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>	<span class="cm">/* should never happen */</span>

	<span class="cm">/* Extract variable-width fields */</span>
	<span class="n">sha</span> <span class="o">=</span> <span class="n">rarp_ptr</span><span class="p">;</span>
	<span class="n">rarp_ptr</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sip</span><span class="p">,</span> <span class="n">rarp_ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rarp_ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">tha</span> <span class="o">=</span> <span class="n">rarp_ptr</span><span class="p">;</span>
	<span class="n">rarp_ptr</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tip</span><span class="p">,</span> <span class="n">rarp_ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Discard packets which are not meant for us. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tha</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

	<span class="cm">/* Discard packets which are not from specified server. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_servaddr</span> <span class="o">!=</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span> <span class="n">ic_servaddr</span> <span class="o">!=</span> <span class="n">sip</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

	<span class="cm">/* We have a winner! */</span>
	<span class="n">ic_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_myaddr</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">tip</span><span class="p">;</span>
	<span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">sip</span><span class="p">;</span>
	<span class="n">ic_got_reply</span> <span class="o">=</span> <span class="n">IC_RARP</span><span class="p">;</span>

<span class="nl">drop_unlock:</span>
	<span class="cm">/* Show&#39;s over.  Nothing to see here.  */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_recv_lock</span><span class="p">);</span>

<span class="nl">drop:</span>
	<span class="cm">/* Throw the packet out. */</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Send RARP request packet over a single interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_rarp_send_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">arp_send</span><span class="p">(</span><span class="n">ARPOP_RREQUEST</span><span class="p">,</span> <span class="n">ETH_P_RARP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	DHCP/BOOTP support.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef IPCONFIG_BOOTP</span>

<span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="p">{</span>		<span class="cm">/* BOOTP packet format */</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="n">iph</span><span class="p">;</span>	<span class="cm">/* IP header */</span>
	<span class="k">struct</span> <span class="n">udphdr</span> <span class="n">udph</span><span class="p">;</span>	<span class="cm">/* UDP header */</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>			<span class="cm">/* 1=request, 2=reply */</span>
	<span class="n">u8</span> <span class="n">htype</span><span class="p">;</span>		<span class="cm">/* HW address type */</span>
	<span class="n">u8</span> <span class="n">hlen</span><span class="p">;</span>		<span class="cm">/* HW address length */</span>
	<span class="n">u8</span> <span class="n">hops</span><span class="p">;</span>		<span class="cm">/* Used only by gateways */</span>
	<span class="n">__be32</span> <span class="n">xid</span><span class="p">;</span>		<span class="cm">/* Transaction ID */</span>
	<span class="n">__be16</span> <span class="n">secs</span><span class="p">;</span>		<span class="cm">/* Seconds since we started */</span>
	<span class="n">__be16</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Just what it says */</span>
	<span class="n">__be32</span> <span class="n">client_ip</span><span class="p">;</span>		<span class="cm">/* Client&#39;s IP address if known */</span>
	<span class="n">__be32</span> <span class="n">your_ip</span><span class="p">;</span>		<span class="cm">/* Assigned IP address */</span>
	<span class="n">__be32</span> <span class="n">server_ip</span><span class="p">;</span>		<span class="cm">/* (Next, e.g. NFS) Server&#39;s IP address */</span>
	<span class="n">__be32</span> <span class="n">relay_ip</span><span class="p">;</span>		<span class="cm">/* IP address of BOOTP relay */</span>
	<span class="n">u8</span> <span class="n">hw_addr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>		<span class="cm">/* Client&#39;s HW address */</span>
	<span class="n">u8</span> <span class="n">serv_name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>	<span class="cm">/* Server host name */</span>
	<span class="n">u8</span> <span class="n">boot_file</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>	<span class="cm">/* Name of boot file */</span>
	<span class="n">u8</span> <span class="n">exten</span><span class="p">[</span><span class="mi">312</span><span class="p">];</span>		<span class="cm">/* DHCP options / BOOTP vendor extensions */</span>
<span class="p">};</span>

<span class="cm">/* packet ops */</span>
<span class="cp">#define BOOTP_REQUEST	1</span>
<span class="cp">#define BOOTP_REPLY	2</span>

<span class="cm">/* DHCP message types */</span>
<span class="cp">#define DHCPDISCOVER	1</span>
<span class="cp">#define DHCPOFFER	2</span>
<span class="cp">#define DHCPREQUEST	3</span>
<span class="cp">#define DHCPDECLINE	4</span>
<span class="cp">#define DHCPACK		5</span>
<span class="cp">#define DHCPNAK		6</span>
<span class="cp">#define DHCPRELEASE	7</span>
<span class="cp">#define DHCPINFORM	8</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ic_bootp_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">bootp_packet_type</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>	<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span> <span class="o">=</span>	<span class="n">ic_bootp_recv</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *  Initialize DHCP/BOOTP extension fields in the request.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ic_bootp_cookie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">99</span> <span class="p">};</span>

<span class="cp">#ifdef IPCONFIG_DHCP</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">ic_dhcp_init_options</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mt</span> <span class="o">=</span> <span class="p">((</span><span class="n">ic_servaddr</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		 <span class="o">?</span> <span class="n">DHCPDISCOVER</span> <span class="o">:</span> <span class="n">DHCPREQUEST</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

<span class="cp">#ifdef IPCONFIG_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DHCP: Sending message type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ic_bootp_cookie</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* RFC1048 Magic Cookie */</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">53</span><span class="p">;</span>		<span class="cm">/* DHCP message type */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="n">mt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">DHCPREQUEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">54</span><span class="p">;</span>	<span class="cm">/* Server ID (IP address) */</span>
		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_servaddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* Requested IP address */</span>
		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always? */</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ic_req_params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Subnet mask */</span>
			<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* Default gateway */</span>
			<span class="mi">6</span><span class="p">,</span>	<span class="cm">/* DNS server */</span>
			<span class="mi">12</span><span class="p">,</span>	<span class="cm">/* Host name */</span>
			<span class="mi">15</span><span class="p">,</span>	<span class="cm">/* Domain name */</span>
			<span class="mi">17</span><span class="p">,</span>	<span class="cm">/* Boot path */</span>
			<span class="mi">26</span><span class="p">,</span>	<span class="cm">/* MTU */</span>
			<span class="mi">40</span><span class="p">,</span>	<span class="cm">/* NIS domain name */</span>
		<span class="p">};</span>

		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>	<span class="cm">/* Parameter request list */</span>
		<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ic_req_params</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ic_req_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ic_req_params</span><span class="p">));</span>
		<span class="n">e</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ic_req_params</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ic_host_name_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* host-name */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">);</span>
			<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">e</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">vendor_class_identifier</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DHCP: sending class identifier </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vendor_class_identifier</span><span class="p">);</span>
			<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>	<span class="cm">/* Class-identifier */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">vendor_class_identifier</span><span class="p">);</span>
			<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vendor_class_identifier</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">e</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>	<span class="cm">/* End of the list */</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IPCONFIG_DHCP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_bootp_init_ext</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ic_bootp_cookie</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* RFC1048 Magic Cookie */</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Subnet mask request */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Default gateway request */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>		<span class="cm">/* Name server request */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>		<span class="cm">/* Host name request */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>		<span class="cm">/* NIS Domain name request */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>		<span class="cm">/* Boot path */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">+=</span> <span class="mi">40</span><span class="p">;</span>

	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">57</span><span class="p">;</span>		<span class="cm">/* set extension buffer size for reply */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 128+236+8+20+14, see dhcpd sources */</span>
	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>

	<span class="o">*</span><span class="n">e</span><span class="o">++</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>		<span class="cm">/* End of the list */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Initialize the DHCP/BOOTP mechanism.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_bootp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONF_NAMESERVERS_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ic_nameservers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>

	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bootp_packet_type</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  DHCP/BOOTP cleanup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_bootp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bootp_packet_type</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Send DHCP/BOOTP request to single interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_bootp_send_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jiffies_diff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>

	<span class="cm">/* Allocate packet */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span><span class="p">)</span> <span class="o">+</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span><span class="p">));</span>

	<span class="cm">/* Construct IP header */</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span><span class="p">));</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">IP_DF</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_BROADCAST</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>

	<span class="cm">/* Construct UDP header */</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">68</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">67</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">));</span>
	<span class="cm">/* UDP checksum not calculated -- explicitly allowed in BOOTP RFC */</span>

	<span class="cm">/* Construct DHCP/BOOTP header */</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">BOOTP_REQUEST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="cm">/* check for false types */</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">htype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_FDDI</span><span class="p">)</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">htype</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown ARP type 0x%04x for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">htype</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span> <span class="cm">/* can cause undefined behavior */</span>
	<span class="p">}</span>

	<span class="cm">/* server_ip and your_ip address are both already zero per RFC2131 */</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">hlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">secs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">jiffies_diff</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>

	<span class="cm">/* add DHCP options or BOOTP extensions */</span>
<span class="cp">#ifdef IPCONFIG_DHCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span>
		<span class="n">ic_dhcp_init_options</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">ic_bootp_init_ext</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">);</span>

	<span class="cm">/* Chain packet down the line... */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">),</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;E&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;E&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Copy BOOTP-supplied string if not already set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_bootp_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">max</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">dest</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Process BOOTP extensions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ic_do_bootp_ext</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">servers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">mtu</span><span class="p">;</span>

<span class="cp">#ifdef IPCONFIG_DEBUG</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: Got extension %d:&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">ext</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">ext</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* Subnet mask */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_netmask</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_netmask</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* Default gateway */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_gateway</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_gateway</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:		<span class="cm">/* DNS server */</span>
		<span class="n">servers</span><span class="o">=</span> <span class="o">*</span><span class="n">ext</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">servers</span> <span class="o">&gt;</span> <span class="n">CONF_NAMESERVERS_MAX</span><span class="p">)</span>
			<span class="n">servers</span> <span class="o">=</span> <span class="n">CONF_NAMESERVERS_MAX</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">servers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ic_nameservers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_nameservers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:	<span class="cm">/* Host name */</span>
		<span class="n">ic_bootp_string</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span>
				<span class="n">__NEW_UTS_LEN</span><span class="p">);</span>
		<span class="n">ic_host_name_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:	<span class="cm">/* Domain name (DNS) */</span>
		<span class="n">ic_bootp_string</span><span class="p">(</span><span class="n">ic_domain</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ic_domain</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">17</span>:	<span class="cm">/* Root path */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root_server_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">ic_bootp_string</span><span class="p">(</span><span class="n">root_server_path</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">root_server_path</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">26</span>:	<span class="cm">/* Interface MTU */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mtu</span><span class="p">));</span>
		<span class="n">ic_dev_mtu</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mtu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">40</span>:	<span class="cm">/* NIS Domain name (_not_ DNS) */</span>
		<span class="n">ic_bootp_string</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">,</span> <span class="n">ext</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span>
				<span class="n">__NEW_UTS_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Receive BOOTP reply.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_bootp_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ext_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* Perform verifications before taking the lock.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_OTHERHOST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NET_RX_DROP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">iph</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* Fragments are not supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_is_fragment</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_err_ratelimited</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: Ignoring fragmented reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip_fast_csum</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">source</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">67</span><span class="p">)</span> <span class="o">||</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">dest</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">68</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">udph</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">);</span>
	<span class="n">ext_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">-</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">-</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* Ok the front looks good, make sure we can get at the rest.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootp_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">iph</span><span class="p">;</span>

	<span class="cm">/* One reply at a time, please. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_recv_lock</span><span class="p">);</span>

	<span class="cm">/* If we already have a reply, just drop the packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_got_reply</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

	<span class="cm">/* Find the ic_device that the packet arrived on */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>  <span class="cm">/* should never happen */</span>

	<span class="cm">/* Is it a reply to our BOOTP request? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">!=</span> <span class="n">BOOTP_REPLY</span> <span class="o">||</span>
	    <span class="n">b</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_err_ratelimited</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: Reply not for us, op[%x] xid[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">b</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Is it a reply for the device we are configuring? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">!=</span> <span class="n">ic_dev_xid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_err_ratelimited</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: Ignoring delayed packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse extensions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">,</span> <span class="n">ic_bootp_cookie</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Check magic cookie */</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">b</span> <span class="o">+</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">iph</span><span class="p">.</span><span class="n">tot_len</span><span class="p">);</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>

<span class="cp">#ifdef IPCONFIG_DHCP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">server_id</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">mt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ext</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="n">ext</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">opt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Padding */</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">ext</span> <span class="o">+=</span> <span class="o">*</span><span class="n">ext</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">53</span>:	<span class="cm">/* Message type */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
						<span class="n">mt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">54</span>:	<span class="cm">/* Server ID (IP address) */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_id</span><span class="p">,</span> <span class="n">opt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

<span class="cp">#ifdef IPCONFIG_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DHCP: Got message type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DHCPOFFER</span>:
				<span class="cm">/* While in the process of accepting one offer,</span>
<span class="cm">				 * ignore all others.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ic_myaddr</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

				<span class="cm">/* Let&#39;s accept that offer. */</span>
				<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">your_ip</span><span class="p">;</span>
				<span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">server_id</span><span class="p">;</span>
<span class="cp">#ifdef IPCONFIG_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DHCP: Offered address %pI4 by server %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_servaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="cm">/* The DHCP indicated server address takes</span>
<span class="cm">				 * precedence over the bootp header one if</span>
<span class="cm">				 * they are different.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">server_id</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">server_ip</span> <span class="o">!=</span> <span class="n">server_id</span><span class="p">))</span>
					<span class="n">b</span><span class="o">-&gt;</span><span class="n">server_ip</span> <span class="o">=</span> <span class="n">ic_servaddr</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DHCPACK</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>

				<span class="cm">/* Yeah! */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="cm">/* Urque.  Forget it*/</span>
				<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ic_dhcp_msgtype</span> <span class="o">=</span> <span class="n">mt</span><span class="p">;</span>

		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IPCONFIG_DHCP */</span><span class="cp"></span>

		<span class="n">ext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">exten</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ext</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="n">ext</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">opt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Padding */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ext</span> <span class="o">+=</span> <span class="o">*</span><span class="n">ext</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="n">ic_do_bootp_ext</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We have a winner! */</span>
	<span class="n">ic_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">your_ip</span><span class="p">;</span>
	<span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">server_ip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_gateway</span> <span class="o">==</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">relay_ip</span><span class="p">)</span>
		<span class="n">ic_gateway</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">relay_ip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_nameservers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">ic_nameservers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic_servaddr</span><span class="p">;</span>
	<span class="n">ic_got_reply</span> <span class="o">=</span> <span class="n">IC_BOOTP</span><span class="p">;</span>

<span class="nl">drop_unlock:</span>
	<span class="cm">/* Show&#39;s over.  Nothing to see here.  */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic_recv_lock</span><span class="p">);</span>

<span class="nl">drop:</span>
	<span class="cm">/* Throw the packet out. */</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *	Dynamic IP configuration -- DHCP, BOOTP, RARP.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_dynamic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ic_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">jiff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_bootp</span> <span class="o">=</span> <span class="n">ic_proto_have_if</span> <span class="o">&amp;</span> <span class="n">IC_BOOTP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_rarp</span> <span class="o">=</span> <span class="n">ic_proto_have_if</span> <span class="o">&amp;</span> <span class="n">IC_RARP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If none of DHCP/BOOTP/RARP was selected, return with an error.</span>
<span class="cm">	 * This routine gets only called when some pieces of information</span>
<span class="cm">	 * are missing, and without DHCP/BOOTP/RARP we are unable to get it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_proto_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Incomplete network configuration information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef IPCONFIG_BOOTP</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ic_proto_enabled</span> <span class="o">^</span> <span class="n">ic_proto_have_if</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IC_BOOTP</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DHCP/BOOTP: No suitable device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_RARP</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ic_proto_enabled</span> <span class="o">^</span> <span class="n">ic_proto_have_if</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IC_RARP</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RARP: No suitable device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_proto_have_if</span><span class="p">)</span>
		<span class="cm">/* Error message already printed */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup protocols</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef IPCONFIG_BOOTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_bootp</span><span class="p">)</span>
		<span class="n">ic_bootp_init</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_RARP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_rarp</span><span class="p">)</span>
		<span class="n">ic_rarp_init</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send requests and wait, until we get an answer. This loop</span>
<span class="cm">	 * seems to be a terrible waste of CPU time, but actually there is</span>
<span class="cm">	 * only one process running at all, so we don&#39;t need to use any</span>
<span class="cm">	 * scheduler functions.</span>
<span class="cm">	 * [Actually we could now, but the nothing else running note still</span>
<span class="cm">	 *  applies.. - AC]</span>
<span class="cm">	 */</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Sending %s%s%s requests .&quot;</span><span class="p">,</span>
		  <span class="n">do_bootp</span>
		  <span class="o">?</span> <span class="p">((</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DHCP&quot;</span> <span class="o">:</span> <span class="s">&quot;BOOTP&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">do_bootp</span> <span class="o">&amp;&amp;</span> <span class="n">do_rarp</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; and &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">do_rarp</span> <span class="o">?</span> <span class="s">&quot;RARP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">start_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="p">;</span>
	<span class="n">retries</span> <span class="o">=</span> <span class="n">CONF_SEND_RETRIES</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">CONF_BASE_TIMEOUT</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">CONF_TIMEOUT_RANDOM</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Track the device we are configuring */</span>
		<span class="n">ic_dev_xid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>

<span class="cp">#ifdef IPCONFIG_BOOTP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_bootp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">able</span> <span class="o">&amp;</span> <span class="n">IC_BOOTP</span><span class="p">))</span>
			<span class="n">ic_bootp_send_if</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_RARP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_rarp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">able</span> <span class="o">&amp;</span> <span class="n">IC_RARP</span><span class="p">))</span>
			<span class="n">ic_rarp_send_if</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">jiff</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">?</span> <span class="n">CONF_INTER_TIMEOUT</span> <span class="o">:</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">jiff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ic_got_reply</span><span class="p">)</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef IPCONFIG_DHCP</span>
		<span class="cm">/* DHCP isn&#39;t done until we get a DHCPACK. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ic_got_reply</span> <span class="o">&amp;</span> <span class="n">IC_BOOTP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ic_dhcp_msgtype</span> <span class="o">!=</span> <span class="n">DHCPACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ic_got_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IPCONFIG_DHCP */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ic_got_reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="o">--</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">d</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="p">;</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="n">CONF_TIMEOUT_MULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">CONF_TIMEOUT_MAX</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">CONF_TIMEOUT_MAX</span><span class="p">;</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef IPCONFIG_BOOTP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_bootp</span><span class="p">)</span>
		<span class="n">ic_bootp_cleanup</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_RARP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_rarp</span><span class="p">)</span>
		<span class="n">ic_rarp_cleanup</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_got_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IP-Config: Got %s answer from %pI4, &quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="n">ic_got_reply</span> <span class="o">&amp;</span> <span class="n">IC_RARP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RARP&quot;</span>
		 <span class="o">:</span> <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DHCP&quot;</span> <span class="o">:</span> <span class="s">&quot;BOOTP&quot;</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">ic_servaddr</span><span class="p">);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;my address is %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IPCONFIG_DYNAMIC */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pnp_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_used</span> <span class="o">&amp;</span> <span class="n">IC_PROTO</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;#PROTO: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ic_proto_used</span> <span class="o">&amp;</span> <span class="n">IC_RARP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RARP&quot;</span>
			   <span class="o">:</span> <span class="p">(</span><span class="n">ic_proto_used</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DHCP&quot;</span> <span class="o">:</span> <span class="s">&quot;BOOTP&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;#MANUAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ic_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;domain %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ic_domain</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONF_NAMESERVERS_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_nameservers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;nameserver %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ic_nameservers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_servaddr</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;bootserver %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">ic_servaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pnp_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">indoe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pnp_seq_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pnp_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pnp_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Extract IP address from the parameter string if needed. Note that we</span>
<span class="cm"> *  need to have root_server_addr set _before_ IPConfig gets called as it</span>
<span class="cm"> *  can override it.</span>
<span class="cm"> */</span>
<span class="n">__be32</span> <span class="n">__init</span> <span class="nf">root_nfs_parse_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">octets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">octets</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="n">cq</span> <span class="o">||</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">cq</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="o">||</span> <span class="n">octets</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">octets</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">octets</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">octets</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEVICE_WAIT_MAX		12 </span><span class="cm">/* 12 seconds */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wait_for_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_WAIT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">for_each_netdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ic_is_init_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	IP Autoconfig dispatcher.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ip_auto_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">addr</span><span class="p">;</span>
<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">CONF_OPEN_RETRIES</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">proc_net_fops_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;pnp&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pnp_seq_fops</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;IP-Config: Entered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
 <span class="nl">try_try_again:</span>
<span class="cp">#endif</span>
	<span class="cm">/* Wait for devices to appear */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_devices</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup all network devices */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ic_open_devs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Give drivers a chance to settle */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">CONF_POST_OPEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the config information is insufficient (e.g., our IP address or</span>
<span class="cm">	 * IP address of the boot server is missing or we have multiple network</span>
<span class="cm">	 * interfaces and no default was set), use BOOTP or RARP to get the</span>
<span class="cm">	 * missing values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_myaddr</span> <span class="o">==</span> <span class="n">NONE</span> <span class="o">||</span>
<span class="cp">#ifdef CONFIG_ROOT_NFS</span>
	    <span class="p">(</span><span class="n">root_server_addr</span> <span class="o">==</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ic_servaddr</span> <span class="o">==</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ROOT_DEV</span> <span class="o">==</span> <span class="n">Root_NFS</span><span class="p">)</span> <span class="o">||</span>
<span class="cp">#endif</span>
	    <span class="n">ic_first_dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic_dynamic</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ic_close_devs</span><span class="p">();</span>

			<span class="cm">/*</span>
<span class="cm">			 * I don&#39;t know why, but sometimes the</span>
<span class="cm">			 * eepro100 driver (at least) gets upset and</span>
<span class="cm">			 * doesn&#39;t work the first time it&#39;s opened.</span>
<span class="cm">			 * But then if you close it and reopen it, it</span>
<span class="cm">			 * works just fine.  So we need to try that at</span>
<span class="cm">			 * least once before giving up.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Also, if the root will be NFS-mounted, we</span>
<span class="cm">			 * have nowhere to go if DHCP fails.  So we</span>
<span class="cm">			 * just have to keep trying forever.</span>
<span class="cm">			 *</span>
<span class="cm">			 * 				-- Chip</span>
<span class="cm">			 */</span>
<span class="cp">#ifdef CONFIG_ROOT_NFS</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ROOT_DEV</span> <span class="o">==</span>  <span class="n">Root_NFS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Retrying forever (NFS root)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">try_try_again</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Reopening network devices...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">try_try_again</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Oh, well.  At least we tried. */</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Auto-configuration of network failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !DYNAMIC */</span><span class="cp"></span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;IP-Config: Incomplete network configuration information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ic_close_devs</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* IPCONFIG_DYNAMIC */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Device selected manually or only one device -&gt; use it */</span>
		<span class="n">ic_dev</span> <span class="o">=</span> <span class="n">ic_first_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">root_nfs_parse_addr</span><span class="p">(</span><span class="n">root_server_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root_server_addr</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">root_server_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use defaults wherever applicable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_defaults</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Close all network devices except the device we&#39;ve</span>
<span class="cm">	 * autoconfigured and set up routes.</span>
<span class="cm">	 */</span>
	<span class="n">ic_close_devs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_setup_if</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ic_setup_routes</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Record which protocol was actually used.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
	<span class="n">ic_proto_used</span> <span class="o">=</span> <span class="n">ic_got_reply</span> <span class="o">|</span> <span class="p">(</span><span class="n">ic_proto_enabled</span> <span class="o">&amp;</span> <span class="n">IC_USE_DHCP</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef IPCONFIG_SILENT</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clue in the operator.</span>
<span class="cm">	 */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;IP-Config: Complete:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;     device=%s, addr=%pI4, mask=%pI4, gw=%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ic_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_myaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_netmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic_gateway</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;     host=%s, domain=%s, nis-domain=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="n">ic_domain</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;     bootserver=%pI4, rootserver=%pI4, rootpath=%s&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ic_servaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root_server_addr</span><span class="p">,</span> <span class="n">root_server_path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_dev_mtu</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, mtu=%d&quot;</span><span class="p">,</span> <span class="n">ic_dev_mtu</span><span class="p">);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !SILENT */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">ip_auto_config</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *  Decode any IP configuration options in the &quot;ip=&quot; or &quot;nfsaddrs=&quot; kernel</span>
<span class="cm"> *  command line parameter.  See Documentation/filesystems/nfs/nfsroot.txt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ic_proto_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;any&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IP_PNP_DHCP</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dhcp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ic_proto_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IC_RARP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IP_PNP_BOOTP</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;bootp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ic_proto_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IC_RARP</span> <span class="o">|</span> <span class="n">IC_USE_DHCP</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IP_PNP_RARP</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rarp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ic_proto_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IC_BOOTP</span> <span class="o">|</span> <span class="n">IC_USE_DHCP</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IPCONFIG_DYNAMIC</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;both&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ic_proto_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IC_USE_DHCP</span><span class="p">;</span> <span class="cm">/* backward compat :-( */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ip_auto_config_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ic_set_manually</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ic_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If any dhcp, bootp etc options are set, leave autoconfig on</span>
<span class="cm">	 * and skip the below static IP processing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_name</span><span class="p">(</span><span class="n">addrs</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If no static IP is given, turn off autoconfig and bail.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">addrs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ic_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse string for static IP assignment.  */</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">addrs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;IP-Config: Parameter #%d: `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">ip</span><span class="p">));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">==</span> <span class="n">ANY</span><span class="p">)</span>
					<span class="n">ic_myaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">==</span> <span class="n">ANY</span><span class="p">)</span>
					<span class="n">ic_servaddr</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">ic_gateway</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">==</span> <span class="n">ANY</span><span class="p">)</span>
					<span class="n">ic_gateway</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">==</span> <span class="n">ANY</span><span class="p">)</span>
					<span class="n">ic_netmask</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">dp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">)))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
					<span class="n">strlcpy</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">));</span>
				<span class="n">ic_host_name_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">user_dev_name</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">user_dev_name</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ic_proto_name</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ic_myaddr</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ic_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ip=&quot;</span><span class="p">,</span> <span class="n">ip_auto_config_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nfsaddrs_config_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ip_auto_config_setup</span><span class="p">(</span><span class="n">addrs</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nfsaddrs=&quot;</span><span class="p">,</span> <span class="n">nfsaddrs_config_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vendor_class_identifier_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlcpy</span><span class="p">(</span><span class="n">vendor_class_identifier</span><span class="p">,</span> <span class="n">addrs</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">vendor_class_identifier</span><span class="p">))</span>
	    <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vendor_class_identifier</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;DHCP: vendorclass too long, truncated to </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vendor_class_identifier</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;dhcpclass=&quot;</span><span class="p">,</span> <span class="n">vendor_class_identifier_setup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
