<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › cipso_ipv4.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cipso_ipv4.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * CIPSO - Commercial IP Security Option</span>
<span class="cm"> *</span>
<span class="cm"> * This is an implementation of the CIPSO 2.2 protocol as specified in</span>
<span class="cm"> * draft-ietf-cipso-ipsecurity-01.txt with additional tag types as found in</span>
<span class="cm"> * FIPS-188.  While CIPSO never became a full IETF RFC standard many vendors</span>
<span class="cm"> * have chosen to adopt the protocol and over the years it has become a</span>
<span class="cm"> * de-facto standard for labeled networking.</span>
<span class="cm"> *</span>
<span class="cm"> * The CIPSO draft specification can be found in the kernel&#39;s Documentation</span>
<span class="cm"> * directory as well as the following URL:</span>
<span class="cm"> *   http://tools.ietf.org/id/draft-ietf-cipso-ipsecurity-01.txt</span>
<span class="cm"> * The FIPS-188 specification can be found at the following URL:</span>
<span class="cm"> *   http://www.itl.nist.gov/fipspubs/fip188.htm</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Paul Moore &lt;paul.moore@hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * (c) Copyright Hewlett-Packard Development Company, L.P., 2006, 2008</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software;  you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY;  without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> * the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program;  if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/icmp.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/netlabel.h&gt;</span>
<span class="cp">#include &lt;net/cipso_ipv4.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/bug.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/* List of available DOI definitions */</span>
<span class="cm">/* XXX - This currently assumes a minimal number of different DOIs in use,</span>
<span class="cm"> * if in practice there are a lot of different DOIs this list should</span>
<span class="cm"> * probably be turned into a hash table or something similar so we</span>
<span class="cm"> * can do quick lookups. */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cipso_v4_doi_list</span><span class="p">);</span>

<span class="cm">/* Label mapping cache */</span>
<span class="kt">int</span> <span class="n">cipso_v4_cache_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cipso_v4_cache_bucketsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="cp">#define CIPSO_V4_CACHE_BUCKETBITS     7</span>
<span class="cp">#define CIPSO_V4_CACHE_BUCKETS        (1 &lt;&lt; CIPSO_V4_CACHE_BUCKETBITS)</span>
<span class="cp">#define CIPSO_V4_CACHE_REORDERLIMIT   10</span>
<span class="k">struct</span> <span class="n">cipso_v4_map_cache_bkt</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">key_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">netlbl_lsm_cache</span> <span class="o">*</span><span class="n">lsm_data</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">activity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cipso_v4_map_cache_bkt</span> <span class="o">*</span><span class="n">cipso_v4_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* Restricted bitmap (tag #1) flags */</span>
<span class="kt">int</span> <span class="n">cipso_v4_rbm_optfmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cipso_v4_rbm_strictvalid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Protocol Constants</span>
<span class="cm"> */</span>

<span class="cm">/* Maximum size of the CIPSO IP option, derived from the fact that the maximum</span>
<span class="cm"> * IPv4 header size is 60 bytes and the base IPv4 header is 20 bytes long. */</span>
<span class="cp">#define CIPSO_V4_OPT_LEN_MAX          40</span>

<span class="cm">/* Length of the base CIPSO option, this includes the option type (1 byte), the</span>
<span class="cm"> * option length (1 byte), and the DOI (4 bytes). */</span>
<span class="cp">#define CIPSO_V4_HDR_LEN              6</span>

<span class="cm">/* Base length of the restrictive category bitmap tag (tag #1). */</span>
<span class="cp">#define CIPSO_V4_TAG_RBM_BLEN         4</span>

<span class="cm">/* Base length of the enumerated category tag (tag #2). */</span>
<span class="cp">#define CIPSO_V4_TAG_ENUM_BLEN        4</span>

<span class="cm">/* Base length of the ranged categories bitmap tag (tag #5). */</span>
<span class="cp">#define CIPSO_V4_TAG_RNG_BLEN         4</span>
<span class="cm">/* The maximum number of category ranges permitted in the ranged category tag</span>
<span class="cm"> * (tag #5).  You may note that the IETF draft states that the maximum number</span>
<span class="cm"> * of category ranges is 7, but if the low end of the last category range is</span>
<span class="cm"> * zero then it is possible to fit 8 category ranges because the zero should</span>
<span class="cm"> * be omitted. */</span>
<span class="cp">#define CIPSO_V4_TAG_RNG_CAT_MAX      8</span>

<span class="cm">/* Base length of the local tag (non-standard tag).</span>
<span class="cm"> *  Tag definition (may change between kernel versions)</span>
<span class="cm"> *</span>
<span class="cm"> * 0          8          16         24         32</span>
<span class="cm"> * +----------+----------+----------+----------+</span>
<span class="cm"> * | 10000000 | 00000110 | 32-bit secid value  |</span>
<span class="cm"> * +----------+----------+----------+----------+</span>
<span class="cm"> * | in (host byte order)|</span>
<span class="cm"> * +----------+----------+</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define CIPSO_V4_TAG_LOC_BLEN         6</span>

<span class="cm">/*</span>
<span class="cm"> * Helper Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_bitmap_walk - Walk a bitmap looking for a bit</span>
<span class="cm"> * @bitmap: the bitmap</span>
<span class="cm"> * @bitmap_len: length in bits</span>
<span class="cm"> * @offset: starting offset</span>
<span class="cm"> * @state: if non-zero, look for a set (1) bit else look for a cleared (0) bit</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Starting at @offset, walk the bitmap from left to right until either the</span>
<span class="cm"> * desired bit is found or we reach the end.  Return the bit offset, -1 if</span>
<span class="cm"> * not found, or -2 if error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_bitmap_walk</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">bitmap_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bit_spot</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">byte_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bitmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

	<span class="cm">/* gcc always rounds to zero when doing integer division */</span>
	<span class="n">byte_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">[</span><span class="n">byte_offset</span><span class="p">];</span>
	<span class="n">bit_spot</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">bitmask</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bit_spot</span> <span class="o">&lt;</span> <span class="n">bitmap_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">==</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">bit_spot</span><span class="p">;</span>

		<span class="n">bit_spot</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bitmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">[</span><span class="o">++</span><span class="n">byte_offset</span><span class="p">];</span>
			<span class="n">bitmask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_bitmap_setbit - Sets a single bit in a bitmap</span>
<span class="cm"> * @bitmap: the bitmap</span>
<span class="cm"> * @bit: the bit</span>
<span class="cm"> * @state: if non-zero, set the bit (1) else clear the bit (0)</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Set a single bit in the bitmask.  Returns zero on success, negative values</span>
<span class="cm"> * on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cipso_v4_bitmap_setbit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">bit</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">byte_spot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bitmask</span><span class="p">;</span>

	<span class="cm">/* gcc always rounds to zero when doing integer division */</span>
	<span class="n">byte_spot</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bitmask</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">bitmap</span><span class="p">[</span><span class="n">byte_spot</span><span class="p">]</span> <span class="o">|=</span> <span class="n">bitmask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bitmap</span><span class="p">[</span><span class="n">byte_spot</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bitmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_cache_entry_free - Frees a cache entry</span>
<span class="cm"> * @entry: the entry to free</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function frees the memory associated with a cache entry including the</span>
<span class="cm"> * LSM cache data if there are no longer any users, i.e. reference count == 0.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cipso_v4_cache_entry_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">lsm_data</span><span class="p">)</span>
		<span class="n">netlbl_secattr_cache_free</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">lsm_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cache_hash - Hashing function for the CIPSO cache</span>
<span class="cm"> * @key: the hash key</span>
<span class="cm"> * @key_len: the length of the key in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * The CIPSO tag hashing function.  Returns a 32-bit hash value.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">cipso_v4_map_cache_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">key_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jhash</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Label Mapping Cache Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_cache_init - Initialize the CIPSO cache</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Initializes the CIPSO label mapping cache, this function should be called</span>
<span class="cm"> * before any of the other functions defined in this file.  Returns zero on</span>
<span class="cm"> * success, negative values on error.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_cache_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="n">cipso_v4_cache</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">CIPSO_V4_CACHE_BUCKETS</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_map_cache_bkt</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_CACHE_BUCKETS</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_cache_invalidate - Invalidates the current CIPSO cache</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Invalidates and frees any entries in the CIPSO cache.  Returns zero on</span>
<span class="cm"> * success and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_cache_invalidate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_CACHE_BUCKETS</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span>
					 <span class="n">tmp_entry</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">cipso_v4_cache_entry_free</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">iter</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_cache_check - Check the CIPSO cache for a label mapping</span>
<span class="cm"> * @key: the buffer to check</span>
<span class="cm"> * @key_len: buffer length in bytes</span>
<span class="cm"> * @secattr: the security attribute struct to use</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function checks the cache to see if a label mapping already exists for</span>
<span class="cm"> * the given key.  If there is a match then the cache is adjusted and the</span>
<span class="cm"> * @secattr struct is populated with the correct LSM security attributes.  The</span>
<span class="cm"> * cache is adjusted in the following manner if the entry is not already the</span>
<span class="cm"> * first in the cache bucket:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. The cache entry&#39;s activity counter is incremented</span>
<span class="cm"> *  2. The previous (higher ranking) entry&#39;s activity counter is decremented</span>
<span class="cm"> *  3. If the difference between the two activity counters is geater than</span>
<span class="cm"> *     CIPSO_V4_CACHE_REORDERLIMIT the two entries are swapped</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success, -ENOENT for a cache miss, and other negative values</span>
<span class="cm"> * on error.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_cache_check</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">key_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">prev_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cipso_v4_cache_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">cipso_v4_map_cache_hash</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="n">bkt</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CIPSO_V4_CACHE_BUCKETS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">lsm_data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
			<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">lsm_data</span><span class="p">;</span>
			<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_CACHE</span><span class="p">;</span>
			<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">NETLBL_NLTYPE_CIPSOV4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">&gt;</span> <span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">&amp;&amp;</span>
			    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">-</span> <span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">&gt;</span>
			    <span class="n">CIPSO_V4_CACHE_REORDERLIMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__list_del</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
				<span class="n">__list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
					   <span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">prev_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_cache_add - Add an entry to the CIPSO cache</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> * @secattr: the packet&#39;s security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Add a new entry into the CIPSO label mapping cache.  Add the new entry to</span>
<span class="cm"> * head of the cache bucket&#39;s list, if the cache bucket is out of room remove</span>
<span class="cm"> * the last entry in the list first.  It is important to note that there is</span>
<span class="cm"> * currently no checking for duplicate keys.  Returns zero on success,</span>
<span class="cm"> * negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_cache_add</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span> <span class="o">*</span><span class="n">old_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cipso_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cipso_ptr_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cipso_v4_cache_enabled</span> <span class="o">||</span> <span class="n">cipso_v4_cache_bucketsize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cipso_ptr</span> <span class="o">=</span> <span class="n">CIPSO_V4_OPTPTR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">cipso_ptr_len</span> <span class="o">=</span> <span class="n">cipso_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">cipso_ptr</span><span class="p">,</span> <span class="n">cipso_ptr_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cache_add_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">cipso_ptr_len</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">cipso_v4_map_cache_hash</span><span class="p">(</span><span class="n">cipso_ptr</span><span class="p">,</span> <span class="n">cipso_ptr_len</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">lsm_data</span> <span class="o">=</span> <span class="n">secattr</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">;</span>

	<span class="n">bkt</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CIPSO_V4_CACHE_BUCKETS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">cipso_v4_cache_bucketsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">list</span><span class="p">);</span>
		<span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">old_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cipso_v4_map_cache_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">list</span><span class="p">);</span>
		<span class="n">cipso_v4_cache_entry_free</span><span class="p">(</span><span class="n">old_entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_cache</span><span class="p">[</span><span class="n">bkt</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cache_add_failure:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
		<span class="n">cipso_v4_cache_entry_free</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DOI List Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_search - Searches for a DOI definition</span>
<span class="cm"> * @doi: the DOI to search for</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Search the DOI definition list for a DOI definition with a DOI value that</span>
<span class="cm"> * matches @doi.  The caller is responsible for calling rcu_read_[un]lock().</span>
<span class="cm"> * Returns a pointer to the DOI definition on success and NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="nf">cipso_v4_doi_search</span><span class="p">(</span><span class="n">u32</span> <span class="n">doi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_doi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">doi</span> <span class="o">==</span> <span class="n">doi</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_add - Add a new DOI to the CIPSO protocol engine</span>
<span class="cm"> * @doi_def: the DOI structure</span>
<span class="cm"> * @audit_info: NetLabel audit information</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * The caller defines a new DOI for use by the CIPSO engine and calls this</span>
<span class="cm"> * function to add it to the list of acceptable domains.  The caller must</span>
<span class="cm"> * ensure that the mapping table specified in @doi_def-&gt;map meets all of the</span>
<span class="cm"> * requirements of the mapping type (see cipso_ipv4.h for details).  Returns</span>
<span class="cm"> * zero on success and non-zero on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_doi_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">netlbl_audit</span> <span class="o">*</span><span class="n">audit_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doi_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">audit_buf</span><span class="p">;</span>

	<span class="n">doi</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">doi</span><span class="p">;</span>
	<span class="n">doi_type</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">doi</span> <span class="o">==</span> <span class="n">CIPSO_V4_DOI_UNKNOWN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_TAG_MAXCNT</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">[</span><span class="n">iter</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RBITMAP</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RANGE</span>:
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_ENUM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CIPSO_V4_MAP_PASS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_LOCAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CIPSO_V4_MAP_LOCAL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_INVALID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_doi_search</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">doi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">doi_add_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_doi_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">doi_add_return:</span>
	<span class="n">audit_buf</span> <span class="o">=</span> <span class="n">netlbl_audit_start</span><span class="p">(</span><span class="n">AUDIT_MAC_CIPSOV4_ADD</span><span class="p">,</span> <span class="n">audit_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audit_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_str</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">doi_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;trans&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;pass&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_LOCAL</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;local&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">audit_buf</span><span class="p">,</span>
				 <span class="s">&quot; cipso_doi=%u cipso_type=%s res=%u&quot;</span><span class="p">,</span>
				 <span class="n">doi</span><span class="p">,</span> <span class="n">type_str</span><span class="p">,</span> <span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">audit_log_end</span><span class="p">(</span><span class="n">audit_buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_free - Frees a DOI definition</span>
<span class="cm"> * @entry: the entry&#39;s RCU field</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function frees all of the memory associated with a DOI definition.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_doi_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
		<span class="n">kfree</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">cipso</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">local</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">cipso</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">local</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">doi_def</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_free_rcu - Frees a DOI definition via the RCU pointer</span>
<span class="cm"> * @entry: the entry&#39;s RCU field</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function is designed to be used as a callback to the call_rcu()</span>
<span class="cm"> * function so that the memory allocated to the DOI definition can be released</span>
<span class="cm"> * safely.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cipso_v4_doi_free_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">;</span>

	<span class="n">doi_def</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="n">cipso_v4_doi_free</span><span class="p">(</span><span class="n">doi_def</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_remove - Remove an existing DOI from the CIPSO protocol engine</span>
<span class="cm"> * @doi: the DOI value</span>
<span class="cm"> * @audit_secid: the LSM secid to use in the audit message</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Removes a DOI definition from the CIPSO engine.  The NetLabel routines will</span>
<span class="cm"> * be called to release their own LSM domain mappings as well as our own</span>
<span class="cm"> * domain list.  Returns zero on success and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_doi_remove</span><span class="p">(</span><span class="n">u32</span> <span class="n">doi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlbl_audit</span> <span class="o">*</span><span class="n">audit_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">audit_buf</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
	<span class="n">doi_def</span> <span class="o">=</span> <span class="n">cipso_v4_doi_search</span><span class="p">(</span><span class="n">doi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">doi_remove_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">doi_remove_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>

	<span class="n">cipso_v4_cache_invalidate</span><span class="p">();</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">cipso_v4_doi_free_rcu</span><span class="p">);</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">doi_remove_return:</span>
	<span class="n">audit_buf</span> <span class="o">=</span> <span class="n">netlbl_audit_start</span><span class="p">(</span><span class="n">AUDIT_MAC_CIPSOV4_DEL</span><span class="p">,</span> <span class="n">audit_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audit_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">audit_buf</span><span class="p">,</span>
				 <span class="s">&quot; cipso_doi=%u res=%u&quot;</span><span class="p">,</span>
				 <span class="n">doi</span><span class="p">,</span> <span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">audit_log_end</span><span class="p">(</span><span class="n">audit_buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_getdef - Returns a reference to a valid DOI definition</span>
<span class="cm"> * @doi: the DOI value</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Searches for a valid DOI definition and if one is found it is returned to</span>
<span class="cm"> * the caller.  Otherwise NULL is returned.  The caller must ensure that</span>
<span class="cm"> * rcu_read_lock() is held while accessing the returned definition and the DOI</span>
<span class="cm"> * definition reference count is decremented when the caller is done.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="nf">cipso_v4_doi_getdef</span><span class="p">(</span><span class="n">u32</span> <span class="n">doi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">doi_def</span> <span class="o">=</span> <span class="n">cipso_v4_doi_search</span><span class="p">(</span><span class="n">doi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">doi_getdef_return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="n">doi_def</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">doi_getdef_return:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">doi_def</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_putdef - Releases a reference for the given DOI definition</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Releases a DOI definition reference obtained from cipso_v4_doi_getdef().</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_doi_putdef</span><span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso_v4_doi_list_lock</span><span class="p">);</span>

	<span class="n">cipso_v4_cache_invalidate</span><span class="p">();</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">cipso_v4_doi_free_rcu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_doi_walk - Iterate through the DOI definitions</span>
<span class="cm"> * @skip_cnt: skip past this number of DOI definitions, updated</span>
<span class="cm"> * @callback: callback for each DOI definition</span>
<span class="cm"> * @cb_arg: argument for the callback function</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Iterate over the DOI definition list, skipping the first @skip_cnt entries.</span>
<span class="cm"> * For each entry call @callback, if @callback returns a negative value stop</span>
<span class="cm"> * &#39;walking&#39; through the list and return.  Updates the value in @skip_cnt upon</span>
<span class="cm"> * return.  Returns zero on success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_doi_walk</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">skip_cnt</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">),</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">cb_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doi_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">iter_doi</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">iter_doi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso_v4_doi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_doi</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">doi_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">skip_cnt</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">iter_doi</span><span class="p">,</span> <span class="n">cb_arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">doi_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">doi_walk_return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

<span class="nl">doi_walk_return:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">skip_cnt</span> <span class="o">=</span> <span class="n">doi_cnt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Label Mapping Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_lvl_valid - Checks to see if the given level is understood</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @level: the level to check</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Checks the given level against the given DOI definition and returns a</span>
<span class="cm"> * negative value if the level does not have a valid mapping and a zero value</span>
<span class="cm"> * if the level is defined by the DOI.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_lvl_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span> <span class="n">u8</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">cipso</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_INV_LVL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_lvl_hton - Perform a level mapping from the host to the network</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @host_lvl: the host MLS level</span>
<span class="cm"> * @net_lvl: the network/CIPSO MLS level</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a local MLS level to the correct</span>
<span class="cm"> * CIPSO level using the given DOI definition.  Returns zero on success,</span>
<span class="cm"> * negative values otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_lvl_hton</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">host_lvl</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="o">*</span><span class="n">net_lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
		<span class="o">*</span><span class="n">net_lvl</span> <span class="o">=</span> <span class="n">host_lvl</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">host_lvl</span> <span class="o">&lt;</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">local_size</span> <span class="o">&amp;&amp;</span>
		    <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">local</span><span class="p">[</span><span class="n">host_lvl</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_INV_LVL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">net_lvl</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">local</span><span class="p">[</span><span class="n">host_lvl</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_lvl_ntoh - Perform a level mapping from the network to the host</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @net_lvl: the network/CIPSO MLS level</span>
<span class="cm"> * @host_lvl: the host MLS level</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a CIPSO level to the correct local MLS</span>
<span class="cm"> * level using the given DOI definition.  Returns zero on success, negative</span>
<span class="cm"> * values otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_lvl_ntoh</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">net_lvl</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="o">*</span><span class="n">host_lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cipso_v4_std_map_tbl</span> <span class="o">*</span><span class="n">map_tbl</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
		<span class="o">*</span><span class="n">host_lvl</span> <span class="o">=</span> <span class="n">net_lvl</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
		<span class="n">map_tbl</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_lvl</span> <span class="o">&lt;</span> <span class="n">map_tbl</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">cipso_size</span> <span class="o">&amp;&amp;</span>
		    <span class="n">map_tbl</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">cipso</span><span class="p">[</span><span class="n">net_lvl</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_INV_LVL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">host_lvl</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">lvl</span><span class="p">.</span><span class="n">cipso</span><span class="p">[</span><span class="n">net_lvl</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rbm_valid - Checks to see if the category bitmap is valid</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @bitmap: category bitmap</span>
<span class="cm"> * @bitmap_len: bitmap length in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Checks the given category bitmap against the given DOI definition and</span>
<span class="cm"> * returns a negative value if any of the categories in the bitmap do not have</span>
<span class="cm"> * a valid mapping and a zero value if all of the categories are valid.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rbm_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">bitmap_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitmap_len_bits</span> <span class="o">=</span> <span class="n">bitmap_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cipso_cat_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cipso_array</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
		<span class="n">cipso_cat_size</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">cipso_size</span><span class="p">;</span>
		<span class="n">cipso_array</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">cipso</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">cat</span> <span class="o">=</span> <span class="n">cipso_v4_bitmap_walk</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span>
						   <span class="n">bitmap_len_bits</span><span class="p">,</span>
						   <span class="n">cat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						   <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">&gt;=</span> <span class="n">cipso_cat_size</span> <span class="o">||</span>
			    <span class="n">cipso_array</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">CIPSO_V4_INV_CAT</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rbm_hton - Perform a category mapping from host to network</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @net_cat: the zero&#39;d out category bitmap in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO bitmap in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a local MLS category bitmap to the</span>
<span class="cm"> * correct CIPSO bitmap using the given DOI definition.  Returns the minimum</span>
<span class="cm"> * size in bytes of the network bitmap on success, negative values otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rbm_hton</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">host_spot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_spot</span> <span class="o">=</span> <span class="n">CIPSO_V4_INV_CAT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_spot_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_clen_bits</span> <span class="o">=</span> <span class="n">net_cat_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">host_cat_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">host_cat_array</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CIPSO_V4_MAP_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host_cat_size</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">local_size</span><span class="p">;</span>
		<span class="n">host_cat_array</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">local</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">host_spot</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_walk</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						       <span class="n">host_spot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host_spot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
			<span class="n">net_spot</span> <span class="o">=</span> <span class="n">host_spot</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">host_spot</span> <span class="o">&gt;=</span> <span class="n">host_cat_size</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="n">net_spot</span> <span class="o">=</span> <span class="n">host_cat_array</span><span class="p">[</span><span class="n">host_spot</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">&gt;=</span> <span class="n">CIPSO_V4_INV_CAT</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">&gt;=</span> <span class="n">net_clen_bits</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">cipso_v4_bitmap_setbit</span><span class="p">(</span><span class="n">net_cat</span><span class="p">,</span> <span class="n">net_spot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">&gt;</span> <span class="n">net_spot_max</span><span class="p">)</span>
			<span class="n">net_spot_max</span> <span class="o">=</span> <span class="n">net_spot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">net_spot_max</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">net_spot_max</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">net_spot_max</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rbm_ntoh - Perform a category mapping from network to host</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @net_cat: the category bitmap in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO bitmap in bytes</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a CIPSO bitmap to the correct local</span>
<span class="cm"> * MLS category bitmap using the given DOI definition.  Returns zero on</span>
<span class="cm"> * success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rbm_ntoh</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">net_spot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">host_spot</span> <span class="o">=</span> <span class="n">CIPSO_V4_INV_CAT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_clen_bits</span> <span class="o">=</span> <span class="n">net_cat_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_cat_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">net_cat_array</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CIPSO_V4_MAP_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_cat_size</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">cipso_size</span><span class="p">;</span>
		<span class="n">net_cat_array</span> <span class="o">=</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">cipso</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">net_spot</span> <span class="o">=</span> <span class="n">cipso_v4_bitmap_walk</span><span class="p">(</span><span class="n">net_cat</span><span class="p">,</span>
						<span class="n">net_clen_bits</span><span class="p">,</span>
						<span class="n">net_spot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						<span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_PASS</span>:
			<span class="n">host_spot</span> <span class="o">=</span> <span class="n">net_spot</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_MAP_TRANS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">net_spot</span> <span class="o">&gt;=</span> <span class="n">net_cat_size</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="n">host_spot</span> <span class="o">=</span> <span class="n">net_cat_array</span><span class="p">[</span><span class="n">net_spot</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_spot</span> <span class="o">&gt;=</span> <span class="n">CIPSO_V4_INV_CAT</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_setbit</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						       <span class="n">host_spot</span><span class="p">,</span>
						       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_enum_valid - Checks to see if the categories are valid</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @enumcat: category list</span>
<span class="cm"> * @enumcat_len: length of the category list in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Checks the given categories against the given DOI definition and returns a</span>
<span class="cm"> * negative value if any of the categories do not have a valid mapping and a</span>
<span class="cm"> * zero value if all of the categories are valid.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_enum_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">enumcat</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">enumcat_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cat_prev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CIPSO_V4_MAP_PASS</span> <span class="o">||</span> <span class="n">enumcat_len</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">enumcat_len</span><span class="p">;</span> <span class="n">iter</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cat</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enumcat</span><span class="p">[</span><span class="n">iter</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">&lt;=</span> <span class="n">cat_prev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">cat_prev</span> <span class="o">=</span> <span class="n">cat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_enum_hton - Perform a category mapping from host to network</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @net_cat: the zero&#39;d out category list in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO category list in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a local MLS category bitmap to the</span>
<span class="cm"> * correct CIPSO category list using the given DOI definition.   Returns the</span>
<span class="cm"> * size in bytes of the network category bitmap on success, negative values</span>
<span class="cm"> * otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_enum_hton</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cat_iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">cat</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_walk</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						 <span class="n">cat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cat_iter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">net_cat_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">cat_iter</span><span class="p">])</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>
		<span class="n">cat_iter</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cat_iter</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_enum_ntoh - Perform a category mapping from network to host</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @net_cat: the category list in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO bitmap in bytes</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a CIPSO category list to the correct</span>
<span class="cm"> * local MLS category bitmap using the given DOI definition.  Returns zero on</span>
<span class="cm"> * success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_enum_ntoh</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">net_cat_len</span><span class="p">;</span> <span class="n">iter</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_setbit</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
				<span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">iter</span><span class="p">]),</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rng_valid - Checks to see if the categories are valid</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @rngcat: category list</span>
<span class="cm"> * @rngcat_len: length of the category list in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Checks the given categories against the given DOI definition and returns a</span>
<span class="cm"> * negative value if any of the categories do not have a valid mapping and a</span>
<span class="cm"> * zero value if all of the categories are valid.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rng_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rngcat</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">rngcat_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cat_high</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cat_low</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cat_prev</span> <span class="o">=</span> <span class="n">CIPSO_V4_MAX_REM_CATS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CIPSO_V4_MAP_PASS</span> <span class="o">||</span> <span class="n">rngcat_len</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">rngcat_len</span><span class="p">;</span> <span class="n">iter</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cat_high</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rngcat</span><span class="p">[</span><span class="n">iter</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">iter</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">rngcat_len</span><span class="p">)</span>
			<span class="n">cat_low</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rngcat</span><span class="p">[</span><span class="n">iter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">cat_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cat_high</span> <span class="o">&gt;</span> <span class="n">cat_prev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">cat_prev</span> <span class="o">=</span> <span class="n">cat_low</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rng_hton - Perform a category mapping from host to network</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @net_cat: the zero&#39;d out category list in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO category list in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a local MLS category bitmap to the</span>
<span class="cm"> * correct CIPSO category list using the given DOI definition.   Returns the</span>
<span class="cm"> * size in bytes of the network category bitmap on success, negative values</span>
<span class="cm"> * otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rng_hton</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">array</span><span class="p">[</span><span class="n">CIPSO_V4_TAG_RNG_CAT_MAX</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">array_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cat_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* make sure we don&#39;t overflow the &#39;array[]&#39; variable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_cat_len</span> <span class="o">&gt;</span>
	    <span class="p">(</span><span class="n">CIPSO_V4_OPT_LEN_MAX</span> <span class="o">-</span> <span class="n">CIPSO_V4_HDR_LEN</span> <span class="o">-</span> <span class="n">CIPSO_V4_TAG_RNG_BLEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_walk</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						  <span class="n">iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cat_size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cat_size</span> <span class="o">&gt;</span> <span class="n">net_cat_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">array</span><span class="p">[</span><span class="n">array_cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>

		<span class="n">iter</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_walk_rng</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						      <span class="n">iter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">cat_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cat_size</span> <span class="o">&gt;</span> <span class="n">net_cat_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">array</span><span class="p">[</span><span class="n">array_cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">array_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">iter</span><span class="p">])</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="o">--</span><span class="n">array_cnt</span><span class="p">]);</span>
		<span class="n">iter</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">array_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">array_cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">iter</span><span class="p">])</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">array_cnt</span><span class="p">]);</span>
			<span class="n">iter</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cat_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_map_cat_rng_ntoh - Perform a category mapping from network to host</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @net_cat: the category list in network/CIPSO format</span>
<span class="cm"> * @net_cat_len: the length of the CIPSO bitmap in bytes</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Perform a label mapping to translate a CIPSO category list to the correct</span>
<span class="cm"> * local MLS category bitmap using the given DOI definition.  Returns zero on</span>
<span class="cm"> * success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_map_cat_rng_ntoh</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">net_cat</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">net_cat_len</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">net_iter</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cat_low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cat_high</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">net_iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">net_iter</span> <span class="o">&lt;</span> <span class="n">net_cat_len</span><span class="p">;</span> <span class="n">net_iter</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cat_high</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">net_iter</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">net_iter</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">net_cat_len</span><span class="p">)</span>
			<span class="n">cat_low</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_cat</span><span class="p">[</span><span class="n">net_iter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">cat_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">netlbl_secattr_catmap_setrng</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">,</span>
						       <span class="n">cat_low</span><span class="p">,</span>
						       <span class="n">cat_high</span><span class="p">,</span>
						       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Protocol Handling Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_gentag_hdr - Generate a CIPSO option header</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @len: the total tag length in bytes, not including this header</span>
<span class="cm"> * @buf: the CIPSO option buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Write a CIPSO header into the beginning of @buffer.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cipso_v4_gentag_hdr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPOPT_CIPSO</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_HDR_LEN</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">doi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_gentag_rbm - Generate a CIPSO restricted bitmap tag (type #1)</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @buffer: the option buffer</span>
<span class="cm"> * @buffer_len: length of buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Generate a CIPSO option using the restricted bitmap tag, tag type #1.  The</span>
<span class="cm"> * actual buffer length may be larger than the indicated size due to</span>
<span class="cm"> * translation between host and network category bitmaps.  Returns the size of</span>
<span class="cm"> * the tag on success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_gentag_rbm</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
					<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_rbm_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						    <span class="n">secattr</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						    <span class="n">buffer_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="cm">/* This will send packets using the &quot;optimized&quot; format when</span>
<span class="cm">		 * possible as specified in  section 3.4.2.6 of the</span>
<span class="cm">		 * CIPSO draft. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_rbm_optfmt</span> <span class="o">&amp;&amp;</span> <span class="n">ret_val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret_val</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_TAG_RBITMAP</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tag_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_parsetag_rbm - Parse a CIPSO restricted bitmap tag</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @tag: the CIPSO tag</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Parse a CIPSO restricted bitmap tag (tag type #1) and return the security</span>
<span class="cm"> * attributes in @secattr.  Return zero on success, negatives values on</span>
<span class="cm"> * failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_parsetag_rbm</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">=</span>
		                       <span class="n">netlbl_secattr_catmap_alloc</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_rbm_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						    <span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
						    <span class="n">secattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netlbl_secattr_catmap_free</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_gentag_enum - Generate a CIPSO enumerated tag (type #2)</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @buffer: the option buffer</span>
<span class="cm"> * @buffer_len: length of buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Generate a CIPSO option using the enumerated tag, tag type #2.  Returns the</span>
<span class="cm"> * size of the tag on success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_gentag_enum</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
					<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_enum_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						     <span class="n">secattr</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						     <span class="n">buffer_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_TAG_ENUM</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tag_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_parsetag_enum - Parse a CIPSO enumerated tag</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @tag: the CIPSO tag</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Parse a CIPSO enumerated tag (tag type #2) and return the security</span>
<span class="cm"> * attributes in @secattr.  Return zero on success, negatives values on</span>
<span class="cm"> * failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_parsetag_enum</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">=</span>
			               <span class="n">netlbl_secattr_catmap_alloc</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_enum_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						     <span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
						     <span class="n">secattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netlbl_secattr_catmap_free</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_gentag_rng - Generate a CIPSO ranged tag (type #5)</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @buffer: the option buffer</span>
<span class="cm"> * @buffer_len: length of buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Generate a CIPSO option using the ranged tag, tag type #5.  Returns the</span>
<span class="cm"> * size of the tag on success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_gentag_rng</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
					<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_rng_hton</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						    <span class="n">secattr</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						    <span class="n">buffer_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_TAG_RANGE</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tag_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_parsetag_rng - Parse a CIPSO ranged tag</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @tag: the CIPSO tag</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Parse a CIPSO ranged tag (tag type #5) and return the security attributes</span>
<span class="cm"> * in @secattr.  Return zero on success, negatives values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_parsetag_rng</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_lvl_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">lvl</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_LVL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">=</span>
			               <span class="n">netlbl_secattr_catmap_alloc</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_map_cat_rng_ntoh</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						    <span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
						    <span class="n">secattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netlbl_secattr_catmap_free</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mls</span><span class="p">.</span><span class="n">cat</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_MLS_CAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_gentag_loc - Generate a CIPSO local tag (non-standard)</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> * @buffer: the option buffer</span>
<span class="cm"> * @buffer_len: length of buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Generate a CIPSO option using the local tag.  Returns the size of the tag</span>
<span class="cm"> * on success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_gentag_loc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">buffer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETLBL_SECATTR_SECID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_TAG_LOCAL</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIPSO_V4_TAG_LOC_BLEN</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">secid</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">CIPSO_V4_TAG_LOC_BLEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_parsetag_loc - Parse a CIPSO local tag</span>
<span class="cm"> * @doi_def: the DOI definition</span>
<span class="cm"> * @tag: the CIPSO tag</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Parse a CIPSO local tag and return the security attributes in @secattr.</span>
<span class="cm"> * Return zero on success, negatives values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_parsetag_loc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">secid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETLBL_SECATTR_SECID</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_validate - Validate a CIPSO option</span>
<span class="cm"> * @option: the start of the option, on error it is set to point to the error</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is called to validate a CIPSO option, it checks all of the</span>
<span class="cm"> * fields to ensure that they are at least valid, see the draft snippet below</span>
<span class="cm"> * for details.  If the option is valid then a zero value is returned and</span>
<span class="cm"> * the value of @option is unchanged.  If the option is invalid then a</span>
<span class="cm"> * non-zero value is returned and @option is adjusted to point to the</span>
<span class="cm"> * offending portion of the option.  From the IETF draft ...</span>
<span class="cm"> *</span>
<span class="cm"> *  &quot;If any field within the CIPSO options, such as the DOI identifier, is not</span>
<span class="cm"> *   recognized the IP datagram is discarded and an ICMP &#39;parameter problem&#39;</span>
<span class="cm"> *   (type 12) is generated and returned.  The ICMP code field is set to &#39;bad</span>
<span class="cm"> *   parameter&#39; (code 0) and the pointer is set to the start of the CIPSO field</span>
<span class="cm"> *   that is unrecognized.&quot;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_validate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">*</span><span class="n">option</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opt_iter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">err_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_iter</span><span class="p">;</span>

	<span class="cm">/* caller already checks for length values that are too large */</span>
	<span class="n">opt_len</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt_len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">validate_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">doi_def</span> <span class="o">=</span> <span class="n">cipso_v4_doi_search</span><span class="p">(</span><span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opt_iter</span> <span class="o">=</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">+</span> <span class="n">opt_iter</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">opt_iter</span> <span class="o">&lt;</span> <span class="n">opt_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tag_iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">[</span><span class="n">tag_iter</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">];)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">[</span><span class="n">tag_iter</span><span class="p">]</span> <span class="o">==</span> <span class="n">CIPSO_V4_TAG_INVALID</span> <span class="o">||</span>
			    <span class="o">++</span><span class="n">tag_iter</span> <span class="o">==</span> <span class="n">CIPSO_V4_TAG_MAXCNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">opt_len</span> <span class="o">-</span> <span class="n">opt_iter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RBITMAP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_TAG_RBM_BLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* We are already going to do all the verification</span>
<span class="cm">			 * necessary at the socket layer so from our point of</span>
<span class="cm">			 * view it is safe to turn these checks off (and less</span>
<span class="cm">			 * work), however, the CIPSO draft says we should do</span>
<span class="cm">			 * all the CIPSO validations here but it doesn&#39;t</span>
<span class="cm">			 * really specify _exactly_ what we need to validate</span>
<span class="cm">			 * ... so, just make it a sysctl tunable. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_rbm_strictvalid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_map_lvl_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
							   <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="n">CIPSO_V4_TAG_RBM_BLEN</span> <span class="o">&amp;&amp;</span>
				    <span class="n">cipso_v4_map_cat_rbm_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
							    <span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_ENUM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_TAG_ENUM_BLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_map_lvl_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="n">CIPSO_V4_TAG_ENUM_BLEN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cipso_v4_map_cat_enum_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
							<span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_TAG_RNG_BLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_map_lvl_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">&gt;</span> <span class="n">CIPSO_V4_TAG_RNG_BLEN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cipso_v4_map_cat_rng_valid</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						       <span class="n">tag_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_LOCAL</span>:
			<span class="cm">/* This is a non-standard tag that we only allow for</span>
<span class="cm">			 * local connections, so if the incoming interface is</span>
<span class="cm">			 * not the loopback device drop the packet. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tag_len</span> <span class="o">!=</span> <span class="n">CIPSO_V4_TAG_LOC_BLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err_offset</span> <span class="o">=</span> <span class="n">opt_iter</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">validate_return_locked</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tag</span> <span class="o">+=</span> <span class="n">tag_len</span><span class="p">;</span>
		<span class="n">opt_iter</span> <span class="o">+=</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">validate_return_locked:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="nl">validate_return:</span>
	<span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">+</span> <span class="n">err_offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_error - Send the correct response for a bad packet</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> * @error: the error code</span>
<span class="cm"> * @gateway: CIPSO gateway flag</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Based on the error code given in @error, send an ICMP error message back to</span>
<span class="cm"> * the originating host.  From the IETF draft ...</span>
<span class="cm"> *</span>
<span class="cm"> *  &quot;If the contents of the CIPSO [option] are valid but the security label is</span>
<span class="cm"> *   outside of the configured host or port label range, the datagram is</span>
<span class="cm"> *   discarded and an ICMP &#39;destination unreachable&#39; (type 3) is generated and</span>
<span class="cm"> *   returned.  The code field of the ICMP is set to &#39;communication with</span>
<span class="cm"> *   destination network administratively prohibited&#39; (code 9) or to</span>
<span class="cm"> *   &#39;communication with destination host administratively prohibited&#39;</span>
<span class="cm"> *   (code 10).  The value of the code is dependent on whether the originator</span>
<span class="cm"> *   of the ICMP message is acting as a CIPSO host or a CIPSO gateway.  The</span>
<span class="cm"> *   recipient of the ICMP message MUST be able to handle either value.  The</span>
<span class="cm"> *   same procedure is performed if a CIPSO [option] can not be added to an</span>
<span class="cm"> *   IP packet because it is too large to fit in the IP options area.&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *  &quot;If the error is triggered by receipt of an ICMP message, the message is</span>
<span class="cm"> *   discarded and no response is permitted (consistent with general ICMP</span>
<span class="cm"> *   processing rules).&quot;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gateway</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_ICMP</span> <span class="o">||</span> <span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gateway</span><span class="p">)</span>
		<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span><span class="p">,</span> <span class="n">ICMP_NET_ANO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span><span class="p">,</span> <span class="n">ICMP_HOST_ANO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_genopt - Generate a CIPSO option</span>
<span class="cm"> * @buf: the option buffer</span>
<span class="cm"> * @buf_len: the size of opt_buf</span>
<span class="cm"> * @doi_def: the CIPSO DOI to use</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Generate a CIPSO option using the DOI definition and security attributes</span>
<span class="cm"> * passed to the function.  Returns the length of the option on success and</span>
<span class="cm"> * negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_genopt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_len</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;=</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* XXX - This code assumes only one tag per CIPSO option which isn&#39;t</span>
<span class="cm">	 * really a good assumption to make but since we only support the MAC</span>
<span class="cm">	 * tags right now it is a safe assumption. */</span>
	<span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">[</span><span class="n">iter</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RBITMAP</span>:
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_gentag_rbm</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">secattr</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">CIPSO_V4_HDR_LEN</span><span class="p">],</span>
						   <span class="n">buf_len</span> <span class="o">-</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_ENUM</span>:
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_gentag_enum</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">secattr</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">CIPSO_V4_HDR_LEN</span><span class="p">],</span>
						   <span class="n">buf_len</span> <span class="o">-</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RANGE</span>:
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_gentag_rng</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">secattr</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">CIPSO_V4_HDR_LEN</span><span class="p">],</span>
						   <span class="n">buf_len</span> <span class="o">-</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CIPSO_V4_TAG_LOCAL</span>:
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_gentag_loc</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span>
						   <span class="n">secattr</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">CIPSO_V4_HDR_LEN</span><span class="p">],</span>
						   <span class="n">buf_len</span> <span class="o">-</span> <span class="n">CIPSO_V4_HDR_LEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">CIPSO_V4_TAG_MAXCNT</span> <span class="o">&amp;&amp;</span>
		 <span class="n">doi_def</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">[</span><span class="n">iter</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CIPSO_V4_TAG_INVALID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">cipso_v4_gentag_hdr</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CIPSO_V4_HDR_LEN</span> <span class="o">+</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_sock_setattr - Add a CIPSO option to a socket</span>
<span class="cm"> * @sk: the socket</span>
<span class="cm"> * @doi_def: the CIPSO DOI to use</span>
<span class="cm"> * @secattr: the specific security attributes of the socket</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Set the CIPSO option on the given socket using the DOI definition and</span>
<span class="cm"> * security attributes passed to the function.  This function requires</span>
<span class="cm"> * exclusive access to @sk, which means it either needs to be in the</span>
<span class="cm"> * process of being created or locked.  Returns zero on success and negative</span>
<span class="cm"> * values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_sock_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">sk_inet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">sk_conn</span><span class="p">;</span>

	<span class="cm">/* In the case of sock_create_lite(), the sock-&gt;sk field is not</span>
<span class="cm">	 * defined yet but it is not a problem as the only users of these</span>
<span class="cm">	 * &quot;lite&quot; PF_INET sockets are functions which do an accept() call</span>
<span class="cm">	 * afterwards so we will label the socket as part of the accept(). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We allocate the maximum CIPSO option size here so we are probably</span>
<span class="cm">	 * being a little wasteful, but it makes our life _much_ easier later</span>
<span class="cm">	 * on and after all we are only talking about 40 bytes. */</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">CIPSO_V4_OPT_LEN_MAX</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">socket_setattr_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_genopt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">doi_def</span><span class="p">,</span> <span class="n">secattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">socket_setattr_failure</span><span class="p">;</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* We can&#39;t use ip_options_get() directly because it makes a call to</span>
<span class="cm">	 * ip_options_get_alloc() which allocates memory with GFP_KERNEL and</span>
<span class="cm">	 * we won&#39;t always have CAP_NET_RAW even though we _always_ want to</span>
<span class="cm">	 * set the IPOPT_CIPSO option. */</span>
	<span class="n">opt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">)</span> <span class="o">+</span> <span class="n">opt_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">socket_setattr_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span> <span class="o">=</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sk_inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">,</span> <span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">is_icsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk_conn</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
			<span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">-=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
		<span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">+=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
		<span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_sync_mss</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_pmtu_cookie</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">socket_setattr_failure:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_req_setattr - Add a CIPSO option to a connection request socket</span>
<span class="cm"> * @req: the connection request socket</span>
<span class="cm"> * @doi_def: the CIPSO DOI to use</span>
<span class="cm"> * @secattr: the specific security attributes of the socket</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Set the CIPSO option on the given socket using the DOI definition and</span>
<span class="cm"> * security attributes passed to the function.  Returns zero on success and</span>
<span class="cm"> * negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_req_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">req_inet</span><span class="p">;</span>

	<span class="cm">/* We allocate the maximum CIPSO option size here so we are probably</span>
<span class="cm">	 * being a little wasteful, but it makes our life _much_ easier later</span>
<span class="cm">	 * on and after all we are only talking about 40 bytes. */</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">CIPSO_V4_OPT_LEN_MAX</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">req_setattr_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_genopt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">doi_def</span><span class="p">,</span> <span class="n">secattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">req_setattr_failure</span><span class="p">;</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* We can&#39;t use ip_options_get() directly because it makes a call to</span>
<span class="cm">	 * ip_options_get_alloc() which allocates memory with GFP_KERNEL and</span>
<span class="cm">	 * we won&#39;t always have CAP_NET_RAW even though we _always_ want to</span>
<span class="cm">	 * set the IPOPT_CIPSO option. */</span>
	<span class="n">opt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">)</span> <span class="o">+</span> <span class="n">opt_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">req_setattr_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span> <span class="o">=</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req_inet</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_inet</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">req_setattr_failure:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_delopt - Delete the CIPSO option from a set of IP options</span>
<span class="cm"> * @opt_ptr: IP option pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Deletes the CIPSO IP option from a set of IP options and makes the necessary</span>
<span class="cm"> * adjustments to the IP option structure.  Returns zero on success, negative</span>
<span class="cm"> * values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_delopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">**</span><span class="n">opt_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hdr_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">*</span><span class="n">opt_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">srr</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">rr</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">ts</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">router_alert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cipso_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cipso_off</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cipso_ptr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">iter</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">optlen_new</span><span class="p">;</span>

		<span class="n">cipso_off</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">);</span>
		<span class="n">cipso_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">cipso_off</span><span class="p">];</span>
		<span class="n">cipso_len</span> <span class="o">=</span> <span class="n">cipso_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">srr</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span><span class="p">)</span>
			<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">srr</span> <span class="o">-=</span> <span class="n">cipso_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span><span class="p">)</span>
			<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">rr</span> <span class="o">-=</span> <span class="n">cipso_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">ts</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span><span class="p">)</span>
			<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">ts</span> <span class="o">-=</span> <span class="n">cipso_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">router_alert</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span><span class="p">)</span>
			<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">router_alert</span> <span class="o">-=</span> <span class="n">cipso_len</span><span class="p">;</span>
		<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memmove</span><span class="p">(</span><span class="n">cipso_ptr</span><span class="p">,</span> <span class="n">cipso_ptr</span> <span class="o">+</span> <span class="n">cipso_len</span><span class="p">,</span>
			<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span> <span class="o">-</span> <span class="n">cipso_off</span> <span class="o">-</span> <span class="n">cipso_len</span><span class="p">);</span>

		<span class="cm">/* determining the new total option length is tricky because of</span>
<span class="cm">		 * the padding necessary, the only thing i can think to do at</span>
<span class="cm">		 * this point is walk the options one-by-one, skipping the</span>
<span class="cm">		 * padding at the end to determine the actual option size and</span>
<span class="cm">		 * from there we can determine the new total option length */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">optlen_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">iter</span> <span class="o">&lt;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">iter</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IPOPT_NOP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iter</span> <span class="o">+=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">optlen_new</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hdr_delta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
		<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">optlen_new</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">hdr_delta</span> <span class="o">-=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* only the cipso option was present on the socket so we can</span>
<span class="cm">		 * remove the entire option struct */</span>
		<span class="o">*</span><span class="n">opt_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hdr_delta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hdr_delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_sock_delattr - Delete the CIPSO option from a socket</span>
<span class="cm"> * @sk: the socket</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Removes the CIPSO option from a socket, if present.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_sock_delattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hdr_delta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">sk_inet</span><span class="p">;</span>

	<span class="n">sk_inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr_delta</span> <span class="o">=</span> <span class="n">cipso_v4_delopt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_inet</span><span class="o">-&gt;</span><span class="n">is_icsk</span> <span class="o">&amp;&amp;</span> <span class="n">hdr_delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">sk_conn</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">-=</span> <span class="n">hdr_delta</span><span class="p">;</span>
		<span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_sync_mss</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sk_conn</span><span class="o">-&gt;</span><span class="n">icsk_pmtu_cookie</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_req_delattr - Delete the CIPSO option from a request socket</span>
<span class="cm"> * @reg: the request socket</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Removes the CIPSO option from a request socket, if present.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cipso_v4_req_delattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">req_inet</span><span class="p">;</span>

	<span class="n">req_inet</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">req_inet</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cipso_v4_delopt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_inet</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_getattr - Helper function for the cipso_v4_*_getattr functions</span>
<span class="cm"> * @cipso: the CIPSO v4 option</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Inspect @cipso and return the security attributes in @secattr.  Returns zero</span>
<span class="cm"> * on success and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cipso_v4_getattr</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cipso</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMSG</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cipso_v4_cache_check</span><span class="p">(</span><span class="n">cipso</span><span class="p">,</span> <span class="n">cipso</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">secattr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">doi</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipso</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">doi_def</span> <span class="o">=</span> <span class="n">cipso_v4_doi_search</span><span class="p">(</span><span class="n">doi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doi_def</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">getattr_return</span><span class="p">;</span>
	<span class="cm">/* XXX - This code assumes only one tag per CIPSO option which isn&#39;t</span>
<span class="cm">	 * really a good assumption to make but since we only support the MAC</span>
<span class="cm">	 * tags right now it is a safe assumption. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cipso</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RBITMAP</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_parsetag_rbm</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">secattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_TAG_ENUM</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_parsetag_enum</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">secattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_TAG_RANGE</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_parsetag_rng</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">secattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CIPSO_V4_TAG_LOCAL</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_parsetag_loc</span><span class="p">(</span><span class="n">doi_def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipso</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">secattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">secattr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">NETLBL_NLTYPE_CIPSOV4</span><span class="p">;</span>

<span class="nl">getattr_return:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_sock_getattr - Get the security attributes from a sock</span>
<span class="cm"> * @sk: the sock</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Query @sk to see if there is a CIPSO option attached to the sock and if</span>
<span class="cm"> * there is return the CIPSO security attributes in @secattr.  This function</span>
<span class="cm"> * requires that @sk be locked, or privately held, but it does not do any</span>
<span class="cm"> * locking itself.  Returns zero on success and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_sock_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMSG</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;&amp;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">cipso_v4_getattr</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">__data</span> <span class="o">+</span>
						<span class="n">opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">cipso</span> <span class="o">-</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">),</span>
				       <span class="n">secattr</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_skbuff_setattr - Set the CIPSO option on a packet</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Set the CIPSO option on the given packet based on the security attributes.</span>
<span class="cm"> * Returns a pointer to the IP header on success and NULL on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_skbuff_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">cipso_v4_doi</span> <span class="o">*</span><span class="n">doi_def</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">IPCB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">CIPSO_V4_OPT_LEN_MAX</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="n">CIPSO_V4_OPT_LEN_MAX</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_delta</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_genopt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">doi_def</span><span class="p">,</span> <span class="n">secattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">opt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* we overwrite any existing options to ensure that we have enough</span>
<span class="cm">	 * room for the CIPSO option, the reason is that we _need_ to guarantee</span>
<span class="cm">	 * that the security label is applied to the packet - we do the same</span>
<span class="cm">	 * thing when using the socket options and it hasn&#39;t caused a problem,</span>
<span class="cm">	 * if we need to we can always revisit this choice later */</span>

	<span class="n">len_delta</span> <span class="o">=</span> <span class="n">opt_len</span> <span class="o">-</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span><span class="p">;</span>
	<span class="cm">/* if we don&#39;t ensure enough headroom we could panic on the skb_push()</span>
<span class="cm">	 * call below so make sure we have enough, we are also &quot;mangling&quot; the</span>
<span class="cm">	 * packet so we should probably do a copy-on-write call anyway */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">skb_cow</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">len_delta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len_delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we assume that the header + opt-&gt;optlen have already been</span>
<span class="cm">		 * &quot;pushed&quot; in ip_options_build() or similar */</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len_delta</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span> <span class="o">-</span> <span class="n">len_delta</span><span class="p">,</span> <span class="n">iph</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len_delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPOPT_NOP</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">));</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span> <span class="o">=</span> <span class="n">opt_len</span><span class="p">;</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">cipso</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">);</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">is_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* we have to do the following because we are being called from a</span>
<span class="cm">	 * netfilter hook which means the packet already has had the header</span>
<span class="cm">	 * fields populated and the checksum calculated - yes this means we</span>
<span class="cm">	 * are doing more work than needed but we do it to keep the core</span>
<span class="cm">	 * stack clean and tidy */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt_len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">iph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opt_len</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">opt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ip_send_check</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_skbuff_delattr - Delete any CIPSO options from a packet</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Removes any and all CIPSO options from the given packet.  Returns zero on</span>
<span class="cm"> * success, negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_skbuff_delattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">IPCB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cipso_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">cipso</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* since we are changing the packet we should make a copy */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">skb_cow</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* the easiest thing to do is just replace the cipso option with noop</span>
<span class="cm">	 * options since we don&#39;t change the size of the packet, although we</span>
<span class="cm">	 * still need to recalculate the checksum */</span>

	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">cipso_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span> <span class="o">+</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">cipso</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cipso_ptr</span><span class="p">,</span> <span class="n">IPOPT_NOOP</span><span class="p">,</span> <span class="n">cipso_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">cipso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">is_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ip_send_check</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_skbuff_getattr - Get the security attributes from the CIPSO option</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> * @secattr: the security attributes</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Parse the given packet&#39;s CIPSO option and return the security attributes.</span>
<span class="cm"> * Returns zero on success and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cipso_v4_skbuff_getattr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">netlbl_lsm_secattr</span> <span class="o">*</span><span class="n">secattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cipso_v4_getattr</span><span class="p">(</span><span class="n">CIPSO_V4_OPTPTR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">secattr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup Functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * cipso_v4_init - Initialize the CIPSO module</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Initialize the CIPSO module and prepare it for use.  Returns zero on success</span>
<span class="cm"> * and negative values on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cipso_v4_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cipso_v4_cache_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to initialize the CIPSO/IPv4 cache (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ret_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">cipso_v4_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
