<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › netfilter › ipt_CLUSTERIP.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ipt_CLUSTERIP.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Cluster IP hashmark target</span>
<span class="cm"> * (C) 2003-2004 by Harald Welte &lt;laforge@netfilter.org&gt;</span>
<span class="cm"> * based on ideas of Fabio Olive Leite &lt;olive@unixforge.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Development of this code funded by SuSE Linux AG, http://www.suse.com/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/icmp.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_arp.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/x_tables.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4/ipt_CLUSTERIP.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#define CLUSTERIP_VERSION &quot;0.8&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Harald Welte &lt;laforge@netfilter.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xtables: CLUSTERIP target&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>			<span class="cm">/* list of all configs */</span>
	<span class="n">atomic_t</span> <span class="n">refcount</span><span class="p">;</span>			<span class="cm">/* reference count */</span>
	<span class="n">atomic_t</span> <span class="n">entries</span><span class="p">;</span>			<span class="cm">/* number of entries/rules</span>
<span class="cm">						 * referencing us */</span>

	<span class="n">__be32</span> <span class="n">clusterip</span><span class="p">;</span>			<span class="cm">/* the IP address */</span>
	<span class="n">u_int8_t</span> <span class="n">clustermac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>		<span class="cm">/* the MAC address */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>			<span class="cm">/* device */</span>
	<span class="n">u_int16_t</span> <span class="n">num_total_nodes</span><span class="p">;</span>		<span class="cm">/* total number of nodes */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">local_nodes</span><span class="p">;</span>		<span class="cm">/* node number array */</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>		<span class="cm">/* proc dir entry */</span>
<span class="cp">#endif</span>
	<span class="k">enum</span> <span class="n">clusterip_hashmode</span> <span class="n">hash_mode</span><span class="p">;</span>	<span class="cm">/* which hashing mode */</span>
	<span class="n">u_int32_t</span> <span class="n">hash_initval</span><span class="p">;</span>			<span class="cm">/* hash initialization */</span>
	<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">clusterip_configs</span><span class="p">);</span>

<span class="cm">/* clusterip_lock protects the clusterip_configs list */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">clusterip_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">clusterip_proc_fops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">clusterip_procdir</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">clusterip_config_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">clusterip_config_rcu_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clusterip_config</span><span class="p">,</span> <span class="n">rcu</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">clusterip_config_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="n">call_rcu_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rcu</span><span class="p">,</span> <span class="n">clusterip_config_rcu_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* decrease the count of entries using/referencing this config.  If last</span>
<span class="cm"> * entry(rule) is removed, remove the config from lists, but don&#39;t free it</span>
<span class="cm"> * yet, since proc-files could still be holding references */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">clusterip_config_entry_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clusterip_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_lock</span><span class="p">);</span>
		<span class="n">local_bh_enable</span><span class="p">();</span>

		<span class="n">dev_mc_del</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">clustermac</span><span class="p">);</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* In case anyone still accesses the file, the open/close</span>
<span class="cm">		 * functions are also incrementing the refcount on their own,</span>
<span class="cm">		 * so it&#39;s safe to remove the entry even if it&#39;s in use. */</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">pde</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pde</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span>
<span class="nf">__clusterip_config_find</span><span class="p">(</span><span class="n">__be32</span> <span class="n">clusterip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clusterip_configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clusterip</span> <span class="o">==</span> <span class="n">clusterip</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span>
<span class="nf">clusterip_config_find_get</span><span class="p">(</span><span class="n">__be32</span> <span class="n">clusterip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">__clusterip_config_find</span><span class="p">(</span><span class="n">clusterip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">)))</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">clusterip_config_init_nodelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">num_local_nodes</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span>
<span class="nf">clusterip_config_init</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">ip</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">clusterip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clustermac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">clustermac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">num_total_nodes</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">num_total_nodes</span><span class="p">;</span>
	<span class="n">clusterip_config_init_nodelist</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">hash_mode</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">hash_initval</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">hash_initval</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="cm">/* create proc dir entry */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IRUSR</span><span class="p">,</span>
					  <span class="n">clusterip_procdir</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">clusterip_proc_fops</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">pde</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_lock</span><span class="p">);</span>
	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clusterip_configs</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">clusterip_add_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u_int16_t</span> <span class="n">nodenum</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nodenum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">nodenum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">num_total_nodes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check if we already have this number in our bitfield */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">nodenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">clusterip_del_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u_int16_t</span> <span class="n">nodenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodenum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">nodenum</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">num_total_nodes</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">nodenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int32_t</span>
<span class="nf">clusterip_hashfn</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">const</span> <span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hashval</span><span class="p">;</span>
	<span class="n">u_int16_t</span> <span class="n">sport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poff</span><span class="p">;</span>

	<span class="n">poff</span> <span class="o">=</span> <span class="n">proto_ports_offset</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u_int16_t</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">_ports</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">ports</span> <span class="o">=</span> <span class="n">skb_header_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">poff</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">_ports</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sport</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dport</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;unknown protocol %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLUSTERIP_HASHMODE_SIP</span>:
		<span class="n">hashval</span> <span class="o">=</span> <span class="n">jhash_1word</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span>
				      <span class="n">config</span><span class="o">-&gt;</span><span class="n">hash_initval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLUSTERIP_HASHMODE_SIP_SPT</span>:
		<span class="n">hashval</span> <span class="o">=</span> <span class="n">jhash_2words</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span> <span class="n">sport</span><span class="p">,</span>
				       <span class="n">config</span><span class="o">-&gt;</span><span class="n">hash_initval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLUSTERIP_HASHMODE_SIP_SPT_DPT</span>:
		<span class="n">hashval</span> <span class="o">=</span> <span class="n">jhash_3words</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">),</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span>
				       <span class="n">config</span><span class="o">-&gt;</span><span class="n">hash_initval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* to make gcc happy */</span>
		<span class="n">hashval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* This cannot happen, unless the check function wasn&#39;t called</span>
<span class="cm">		 * at rule load time */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unknown mode %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* node numbers are 1..n, not 0..n */</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">hashval</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">num_total_nodes</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">clusterip_responsible</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="n">u_int32_t</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">hash</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * IPTABLES TARGET</span>
<span class="cm"> ***********************************************************************/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">clusterip_tg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_action_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span> <span class="o">*</span><span class="n">cipinfo</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">targinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">hash</span><span class="p">;</span>

	<span class="cm">/* don&#39;t need to clusterip_config_get() here, since refcount</span>
<span class="cm">	 * is only decremented by destroy() - and ip_tables guarantees</span>
<span class="cm">	 * that the -&gt;target() function isn&#39;t called after -&gt;destroy() */</span>

	<span class="n">ct</span> <span class="o">=</span> <span class="n">nf_ct_get</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>

	<span class="cm">/* special case: ICMP error handling. conntrack distinguishes between</span>
<span class="cm">	 * error messages (RELATED) and information requests (see below) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_ICMP</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ctinfo</span> <span class="o">==</span> <span class="n">IP_CT_RELATED</span> <span class="o">||</span>
	     <span class="n">ctinfo</span> <span class="o">==</span> <span class="n">IP_CT_RELATED_REPLY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XT_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* ip_conntrack_icmp guarantees us that we only have ICMP_ECHO,</span>
<span class="cm">	 * TIMESTAMP, INFO_REQUEST or ADDRESS type icmp packets from here</span>
<span class="cm">	 * on, which all have an ID field [relevant for hashing]. */</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">clusterip_hashfn</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctinfo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IP_CT_NEW</span>:
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IP_CT_RELATED</span>:
	<span class="k">case</span> <span class="n">IP_CT_RELATED_REPLY</span>:
		<span class="cm">/* FIXME: we don&#39;t handle expectations at the moment.</span>
<span class="cm">		 * They can arrive on a different node than</span>
<span class="cm">		 * the master connection (e.g. FTP passive mode) */</span>
	<span class="k">case</span> <span class="n">IP_CT_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">IP_CT_ESTABLISHED_REPLY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>			<span class="cm">/* Prevent gcc warnings */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">nf_ct_dump_tuple_ip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">].</span><span class="n">tuple</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hash=%u ct_hash=%u &quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clusterip_responsible</span><span class="p">(</span><span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">hash</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;not responsible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;responsible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* despite being received via linklayer multicast, this is</span>
<span class="cm">	 * actually a unicast IP packet. TCP doesn&#39;t like PACKET_MULTICAST */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">XT_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clusterip_tg_check</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_tgchk_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span> <span class="o">*</span><span class="n">cipinfo</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">targinfo</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">entryinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">hash_mode</span> <span class="o">!=</span> <span class="n">CLUSTERIP_HASHMODE_SIP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">hash_mode</span> <span class="o">!=</span> <span class="n">CLUSTERIP_HASHMODE_SIP_SPT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">hash_mode</span> <span class="o">!=</span> <span class="n">CLUSTERIP_HASHMODE_SIP_SPT_DPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unknown mode %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dmsk</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Please specify destination IP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: further sanity checks */</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">clusterip_config_find_get</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLUSTERIP_FLAG_NEW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no config found for %pI4, need &#39;new&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Please specify an interface name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no such interface %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">config</span> <span class="o">=</span> <span class="n">clusterip_config_init</span><span class="p">(</span><span class="n">cipinfo</span><span class="p">,</span>
							<span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_mc_add</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">clustermac</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_ct_l3proto_try_module_get</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cannot load conntrack support for proto=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drop reference count of cluster config when rule is deleted */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clusterip_tg_destroy</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_tgdtor_param</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span> <span class="o">*</span><span class="n">cipinfo</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">targinfo</span><span class="p">;</span>

	<span class="cm">/* if no more entries are referencing the config, remove it</span>
<span class="cm">	 * from the list and destroy the proc entry */</span>
	<span class="n">clusterip_config_entry_put</span><span class="p">(</span><span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="n">clusterip_config_put</span><span class="p">(</span><span class="n">cipinfo</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="n">nf_ct_l3proto_module_put</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">struct</span> <span class="n">compat_ipt_clusterip_tgt_info</span>
<span class="p">{</span>
	<span class="n">u_int32_t</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u_int8_t</span>	<span class="n">clustermac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u_int16_t</span>	<span class="n">num_total_nodes</span><span class="p">;</span>
	<span class="n">u_int16_t</span>	<span class="n">num_local_nodes</span><span class="p">;</span>
	<span class="n">u_int16_t</span>	<span class="n">local_nodes</span><span class="p">[</span><span class="n">CLUSTERIP_MAX_NODES</span><span class="p">];</span>
	<span class="n">u_int32_t</span>	<span class="n">hash_mode</span><span class="p">;</span>
	<span class="n">u_int32_t</span>	<span class="n">hash_initval</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span>	<span class="n">config</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xt_target</span> <span class="n">clusterip_tg_reg</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;CLUSTERIP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>		<span class="o">=</span> <span class="n">clusterip_tg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">checkentry</span>	<span class="o">=</span> <span class="n">clusterip_tg_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span> <span class="n">clusterip_tg_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">targetsize</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipt_clusterip_tgt_info</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compatsize</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_ipt_clusterip_tgt_info</span><span class="p">),</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">me</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>


<span class="cm">/***********************************************************************</span>
<span class="cm"> * ARP MANGLING CODE</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/* hardcoded for 48bit ethernet and 32bit ipv4 addresses */</span>
<span class="k">struct</span> <span class="n">arp_payload</span> <span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">src_hw</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">src_ip</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">dst_hw</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">dst_ip</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arp_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">arp_payload</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define HBUFFERLEN 30</span>
	<span class="kt">char</span> <span class="n">hbuffer</span><span class="p">[</span><span class="n">HBUFFERLEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">HBUFFERLEN</span><span class="o">-</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hbuffer</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">src_hw</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">hbuffer</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">src_hw</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">hbuffer</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hbuffer</span><span class="p">[</span><span class="o">--</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;src %pI4@%s, dst %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">src_ip</span><span class="p">,</span> <span class="n">hbuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">dst_ip</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">arp_mangle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hook</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	   <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
	   <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
	   <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">okfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arphdr</span> <span class="o">*</span><span class="n">arp</span> <span class="o">=</span> <span class="n">arp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">arp_payload</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t care about non-ethernet and non-ipv4 ARP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_hrd</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ARPHRD_ETHER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_pro</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_pln</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_hln</span> <span class="o">!=</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="cm">/* we only want to mangle arp requests and replies */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_op</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ARPOP_REPLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_op</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ARPOP_REQUEST</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">arp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* if there is no clusterip configuration for the arp reply&#39;s</span>
<span class="cm">	 * source ip, we don&#39;t want to mangle it */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">clusterip_config_find_get</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">src_ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="cm">/* normally the linux kernel always replies to arp queries of</span>
<span class="cm">	 * addresses on different interfacs.  However, in the CLUSTERIP case</span>
<span class="cm">	 * this wouldn&#39;t work, since we didn&#39;t subscribe the mcast group on</span>
<span class="cm">	 * other interfaces */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;not mangling arp reply on different &quot;</span>
			 <span class="s">&quot;interface: cip&#39;%s&#39;-skb&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">clusterip_config_put</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mangle reply hardware address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">src_hw</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">clustermac</span><span class="p">,</span> <span class="n">arp</span><span class="o">-&gt;</span><span class="n">ar_hln</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mangled arp reply: &quot;</span><span class="p">);</span>
	<span class="n">arp_print</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">clusterip_config_put</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="n">cip_arp_ops</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">arp_mangle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pf</span> <span class="o">=</span> <span class="n">NFPROTO_ARP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hooknum</span> <span class="o">=</span> <span class="n">NF_ARP_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * PROC DIR HANDLING</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">struct</span> <span class="n">clusterip_seq_position</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>	<span class="cm">/* position */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">weight</span><span class="p">;</span>	<span class="cm">/* number of bits set == size */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>	<span class="cm">/* current bit */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>	<span class="cm">/* current value */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">clusterip_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">weight</span><span class="p">;</span>
	<span class="n">u_int32_t</span> <span class="n">local_nodes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clusterip_seq_position</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* FIXME: possible race */</span>
	<span class="n">local_nodes</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">local_nodes</span><span class="p">;</span>
	<span class="n">weight</span> <span class="o">=</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">local_nodes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">weight</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clusterip_seq_position</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">;</span>
	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">bit</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">local_nodes</span><span class="p">);</span>
	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">local_nodes</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">bit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">clusterip_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_seq_position</span> <span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="o">++</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">idx</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">bit</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">bit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clusterip_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clusterip_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_seq_position</span> <span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="o">-&gt;</span><span class="n">bit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">==</span> <span class="n">idx</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">clusterip_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">clusterip_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">clusterip_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">clusterip_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">clusterip_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clusterip_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clusterip_seq_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">sf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">sf</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="n">clusterip_config_get</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clusterip_proc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">clusterip_config_put</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">clusterip_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clusterip_config</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="cp">#define PROC_WRITELEN	10</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">PROC_WRITELEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nodenum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PROC_WRITELEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nodenum</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clusterip_add_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nodenum</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nodenum</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clusterip_del_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nodenum</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">clusterip_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">clusterip_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	 <span class="o">=</span> <span class="n">clusterip_proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">clusterip_proc_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">clusterip_tg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xt_register_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_tg_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_register_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cip_arp_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_target</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">clusterip_procdir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;ipt_CLUSTERIP&quot;</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clusterip_procdir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to proc dir entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_hook</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ClusterIP Version %s loaded successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CLUSTERIP_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="nl">cleanup_hook:</span>
	<span class="n">nf_unregister_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cip_arp_ops</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="nl">cleanup_target:</span>
	<span class="n">xt_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_tg_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">clusterip_tg_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ClusterIP Version %s unloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLUSTERIP_VERSION</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">clusterip_procdir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">clusterip_procdir</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">nf_unregister_hook</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cip_arp_ops</span><span class="p">);</span>
	<span class="n">xt_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clusterip_tg_reg</span><span class="p">);</span>

	<span class="cm">/* Wait for completion of call_rcu_bh()&#39;s (clusterip_config_rcu_free) */</span>
	<span class="n">rcu_barrier_bh</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">clusterip_tg_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">clusterip_tg_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
