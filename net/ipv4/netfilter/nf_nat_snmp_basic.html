<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › netfilter › nf_nat_snmp_basic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nf_nat_snmp_basic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * nf_nat_snmp_basic.c</span>
<span class="cm"> *</span>
<span class="cm"> * Basic SNMP Application Layer Gateway</span>
<span class="cm"> *</span>
<span class="cm"> * This IP NAT module is intended for use with SNMP network</span>
<span class="cm"> * discovery and monitoring applications where target networks use</span>
<span class="cm"> * conflicting private address realms.</span>
<span class="cm"> *</span>
<span class="cm"> * Static NAT is used to remap the networks from the view of the network</span>
<span class="cm"> * management system at the IP layer, and this module remaps some application</span>
<span class="cm"> * layer addresses to match.</span>
<span class="cm"> *</span>
<span class="cm"> * The simplest form of ALG is performed, where only tagged IP addresses</span>
<span class="cm"> * are modified.  The module does not need to be MIB aware and only scans</span>
<span class="cm"> * messages at the ASN.1/BER level.</span>
<span class="cm"> *</span>
<span class="cm"> * Currently, only SNMPv1 and SNMPv2 are supported.</span>
<span class="cm"> *</span>
<span class="cm"> * More information on ALG and associated issues can be found in</span>
<span class="cm"> * RFC 2962</span>
<span class="cm"> *</span>
<span class="cm"> * The ASB.1/BER parsing code is derived from the gxsnmp package by Gregory</span>
<span class="cm"> * McLean &amp; Jochen Friedrich, stripped down for use in the kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000 RP Internet (www.rpi.net.au).</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Author: James Morris &lt;jmorris@intercode.com.au&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/udp.h&gt;</span>

<span class="cp">#include &lt;net/netfilter/nf_nat.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_expect.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_conntrack_helper.h&gt;</span>
<span class="cp">#include &lt;net/netfilter/nf_nat_helper.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter/nf_conntrack_snmp.h&gt;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;James Morris &lt;jmorris@intercode.com.au&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Basic SNMP Application Layer Gateway&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ip_nat_snmp_basic&quot;</span><span class="p">);</span>

<span class="cp">#define SNMP_PORT 161</span>
<span class="cp">#define SNMP_TRAP_PORT 162</span>
<span class="cp">#define NOCT1(n) (*(u8 *)(n))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">snmp_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Application layer address mapping mimics the NAT mapping, but</span>
<span class="cm"> * only for the first octet in this case (a more flexible system</span>
<span class="cm"> * can be implemented if needed).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">oct1_map</span>
<span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">from</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">to</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Basic ASN.1 decoding routines (gxsnmp author Dirk Wisse)</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/* Class */</span>
<span class="cp">#define ASN1_UNI	0	</span><span class="cm">/* Universal */</span><span class="cp"></span>
<span class="cp">#define ASN1_APL	1	</span><span class="cm">/* Application */</span><span class="cp"></span>
<span class="cp">#define ASN1_CTX	2	</span><span class="cm">/* Context */</span><span class="cp"></span>
<span class="cp">#define ASN1_PRV	3	</span><span class="cm">/* Private */</span><span class="cp"></span>

<span class="cm">/* Tag */</span>
<span class="cp">#define ASN1_EOC	0	</span><span class="cm">/* End Of Contents */</span><span class="cp"></span>
<span class="cp">#define ASN1_BOL	1	</span><span class="cm">/* Boolean */</span><span class="cp"></span>
<span class="cp">#define ASN1_INT	2	</span><span class="cm">/* Integer */</span><span class="cp"></span>
<span class="cp">#define ASN1_BTS	3	</span><span class="cm">/* Bit String */</span><span class="cp"></span>
<span class="cp">#define ASN1_OTS	4	</span><span class="cm">/* Octet String */</span><span class="cp"></span>
<span class="cp">#define ASN1_NUL	5	</span><span class="cm">/* Null */</span><span class="cp"></span>
<span class="cp">#define ASN1_OJI	6	</span><span class="cm">/* Object Identifier  */</span><span class="cp"></span>
<span class="cp">#define ASN1_OJD	7	</span><span class="cm">/* Object Description */</span><span class="cp"></span>
<span class="cp">#define ASN1_EXT	8	</span><span class="cm">/* External */</span><span class="cp"></span>
<span class="cp">#define ASN1_SEQ	16	</span><span class="cm">/* Sequence */</span><span class="cp"></span>
<span class="cp">#define ASN1_SET	17	</span><span class="cm">/* Set */</span><span class="cp"></span>
<span class="cp">#define ASN1_NUMSTR	18	</span><span class="cm">/* Numerical String */</span><span class="cp"></span>
<span class="cp">#define ASN1_PRNSTR	19	</span><span class="cm">/* Printable String */</span><span class="cp"></span>
<span class="cp">#define ASN1_TEXSTR	20	</span><span class="cm">/* Teletext String */</span><span class="cp"></span>
<span class="cp">#define ASN1_VIDSTR	21	</span><span class="cm">/* Video String */</span><span class="cp"></span>
<span class="cp">#define ASN1_IA5STR	22	</span><span class="cm">/* IA5 String */</span><span class="cp"></span>
<span class="cp">#define ASN1_UNITIM	23	</span><span class="cm">/* Universal Time */</span><span class="cp"></span>
<span class="cp">#define ASN1_GENTIM	24	</span><span class="cm">/* General Time */</span><span class="cp"></span>
<span class="cp">#define ASN1_GRASTR	25	</span><span class="cm">/* Graphical String */</span><span class="cp"></span>
<span class="cp">#define ASN1_VISSTR	26	</span><span class="cm">/* Visible String */</span><span class="cp"></span>
<span class="cp">#define ASN1_GENSTR	27	</span><span class="cm">/* General String */</span><span class="cp"></span>

<span class="cm">/* Primitive / Constructed methods*/</span>
<span class="cp">#define ASN1_PRI	0	</span><span class="cm">/* Primitive */</span><span class="cp"></span>
<span class="cp">#define ASN1_CON	1	</span><span class="cm">/* Constructed */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Error codes.</span>
<span class="cm"> */</span>
<span class="cp">#define ASN1_ERR_NOERROR		0</span>
<span class="cp">#define ASN1_ERR_DEC_EMPTY		2</span>
<span class="cp">#define ASN1_ERR_DEC_EOC_MISMATCH	3</span>
<span class="cp">#define ASN1_ERR_DEC_LENGTH_MISMATCH	4</span>
<span class="cp">#define ASN1_ERR_DEC_BADVALUE		5</span>

<span class="cm">/*</span>
<span class="cm"> * ASN.1 context.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asn1_ctx</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>			<span class="cm">/* Error condition */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>		<span class="cm">/* Octet just to be decoded */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span>		<span class="cm">/* First octet */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>		<span class="cm">/* Octet after last octet */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Octet string (not null terminated)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asn1_octstr</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asn1_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">begin</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_NOERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_octet_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_EMPTY</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_tag_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span> <span class="o">|=</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_id_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cls</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tag</span> <span class="o">==</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_tag_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_length_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">len</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="o">*</span><span class="n">len</span> <span class="o">|=</span> <span class="n">ch</span><span class="p">;</span>
				<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t trust len bigger than ctx buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_header_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">eoc</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_id_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">def</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_length_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* primitive shall be definite, indefinite shall be constructed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">con</span> <span class="o">==</span> <span class="n">ASN1_PRI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">def</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">def</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eoc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">eoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_eoc_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eoc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_EOC_MISMATCH</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_EOC_MISMATCH</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">!=</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_LENGTH_MISMATCH</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_null_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">eoc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_long_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span>
				      <span class="kt">long</span> <span class="o">*</span><span class="n">integer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">integer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&lt;</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_BADVALUE</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">integer</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">integer</span> <span class="o">|=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_uint_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">integer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">integer</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&lt;</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_BADVALUE</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">integer</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">integer</span> <span class="o">|=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_ulong_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">integer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">integer</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&lt;</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_BADVALUE</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">integer</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">integer</span> <span class="o">|=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_octets_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">octets</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">octets</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">eoc</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">octets</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">octets</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&lt;</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">octets</span><span class="p">);</span>
			<span class="o">*</span><span class="n">octets</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_subid_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">subid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="o">*</span><span class="n">subid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octet_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="o">*</span><span class="n">subid</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="o">*</span><span class="n">subid</span> <span class="o">|=</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">asn1_oid_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="n">oid</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">subid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">optr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">eoc</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* first subid actually encodes first two subids */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">ULONG_MAX</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">oid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">oid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">optr</span> <span class="o">=</span> <span class="o">*</span><span class="n">oid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_subid_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">oid</span><span class="p">);</span>
		<span class="o">*</span><span class="n">oid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subid</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">subid</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subid</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">optr</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subid</span> <span class="o">-</span> <span class="mi">80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">optr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">&lt;</span> <span class="n">eoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ASN1_ERR_DEC_BADVALUE</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">oid</span><span class="p">);</span>
			<span class="o">*</span><span class="n">oid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_subid_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">optr</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">oid</span><span class="p">);</span>
			<span class="o">*</span><span class="n">oid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * SNMP decoding routines (gxsnmp author Dirk Wisse)</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/* SNMP Versions */</span>
<span class="cp">#define SNMP_V1				0</span>
<span class="cp">#define SNMP_V2C			1</span>
<span class="cp">#define SNMP_V2				2</span>
<span class="cp">#define SNMP_V3				3</span>

<span class="cm">/* Default Sizes */</span>
<span class="cp">#define SNMP_SIZE_COMM			256</span>
<span class="cp">#define SNMP_SIZE_OBJECTID		128</span>
<span class="cp">#define SNMP_SIZE_BUFCHR		256</span>
<span class="cp">#define SNMP_SIZE_BUFINT		128</span>
<span class="cp">#define SNMP_SIZE_SMALLOBJECTID		16</span>

<span class="cm">/* Requests */</span>
<span class="cp">#define SNMP_PDU_GET			0</span>
<span class="cp">#define SNMP_PDU_NEXT			1</span>
<span class="cp">#define SNMP_PDU_RESPONSE		2</span>
<span class="cp">#define SNMP_PDU_SET			3</span>
<span class="cp">#define SNMP_PDU_TRAP1			4</span>
<span class="cp">#define SNMP_PDU_BULK			5</span>
<span class="cp">#define SNMP_PDU_INFORM			6</span>
<span class="cp">#define SNMP_PDU_TRAP2			7</span>

<span class="cm">/* Errors */</span>
<span class="cp">#define SNMP_NOERROR			0</span>
<span class="cp">#define SNMP_TOOBIG			1</span>
<span class="cp">#define SNMP_NOSUCHNAME			2</span>
<span class="cp">#define SNMP_BADVALUE			3</span>
<span class="cp">#define SNMP_READONLY			4</span>
<span class="cp">#define SNMP_GENERROR			5</span>
<span class="cp">#define SNMP_NOACCESS			6</span>
<span class="cp">#define SNMP_WRONGTYPE			7</span>
<span class="cp">#define SNMP_WRONGLENGTH		8</span>
<span class="cp">#define SNMP_WRONGENCODING		9</span>
<span class="cp">#define SNMP_WRONGVALUE			10</span>
<span class="cp">#define SNMP_NOCREATION			11</span>
<span class="cp">#define SNMP_INCONSISTENTVALUE		12</span>
<span class="cp">#define SNMP_RESOURCEUNAVAILABLE	13</span>
<span class="cp">#define SNMP_COMMITFAILED		14</span>
<span class="cp">#define SNMP_UNDOFAILED			15</span>
<span class="cp">#define SNMP_AUTHORIZATIONERROR		16</span>
<span class="cp">#define SNMP_NOTWRITABLE		17</span>
<span class="cp">#define SNMP_INCONSISTENTNAME		18</span>

<span class="cm">/* General SNMP V1 Traps */</span>
<span class="cp">#define SNMP_TRAP_COLDSTART		0</span>
<span class="cp">#define SNMP_TRAP_WARMSTART		1</span>
<span class="cp">#define SNMP_TRAP_LINKDOWN		2</span>
<span class="cp">#define SNMP_TRAP_LINKUP		3</span>
<span class="cp">#define SNMP_TRAP_AUTFAILURE		4</span>
<span class="cp">#define SNMP_TRAP_EQPNEIGHBORLOSS	5</span>
<span class="cp">#define SNMP_TRAP_ENTSPECIFIC		6</span>

<span class="cm">/* SNMPv1 Types */</span>
<span class="cp">#define SNMP_NULL                0</span>
<span class="cp">#define SNMP_INTEGER             1    </span><span class="cm">/* l  */</span><span class="cp"></span>
<span class="cp">#define SNMP_OCTETSTR            2    </span><span class="cm">/* c  */</span><span class="cp"></span>
<span class="cp">#define SNMP_DISPLAYSTR          2    </span><span class="cm">/* c  */</span><span class="cp"></span>
<span class="cp">#define SNMP_OBJECTID            3    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_IPADDR              4    </span><span class="cm">/* uc */</span><span class="cp"></span>
<span class="cp">#define SNMP_COUNTER             5    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_GAUGE               6    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_TIMETICKS           7    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_OPAQUE              8    </span><span class="cm">/* c  */</span><span class="cp"></span>

<span class="cm">/* Additional SNMPv2 Types */</span>
<span class="cp">#define SNMP_UINTEGER            5    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_BITSTR              9    </span><span class="cm">/* uc */</span><span class="cp"></span>
<span class="cp">#define SNMP_NSAP               10    </span><span class="cm">/* uc */</span><span class="cp"></span>
<span class="cp">#define SNMP_COUNTER64          11    </span><span class="cm">/* ul */</span><span class="cp"></span>
<span class="cp">#define SNMP_NOSUCHOBJECT       12</span>
<span class="cp">#define SNMP_NOSUCHINSTANCE     13</span>
<span class="cp">#define SNMP_ENDOFMIBVIEW       14</span>

<span class="k">union</span> <span class="n">snmp_syntax</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">uc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* 8 bit unsigned */</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>		<span class="cm">/* 8 bit signed */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* 32 bit unsigned */</span>
	<span class="kt">long</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>		<span class="cm">/* 32 bit signed */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snmp_object</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syntax_len</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">snmp_syntax</span> <span class="n">syntax</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snmp_request</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">error_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">error_index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snmp_v1_trap</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip_address</span><span class="p">;</span>	<span class="cm">/* pointer  */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">general</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">specific</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SNMP types */</span>
<span class="cp">#define SNMP_IPA    0</span>
<span class="cp">#define SNMP_CNT    1</span>
<span class="cp">#define SNMP_GGE    2</span>
<span class="cp">#define SNMP_TIT    3</span>
<span class="cp">#define SNMP_OPQ    4</span>
<span class="cp">#define SNMP_C64    6</span>

<span class="cm">/* SNMP errors */</span>
<span class="cp">#define SERR_NSO    0</span>
<span class="cp">#define SERR_NSI    1</span>
<span class="cp">#define SERR_EOM    2</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">mangle_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">oct1_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
				  <span class="n">__sum16</span> <span class="o">*</span><span class="n">check</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">snmp_cnv</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">class</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syntax</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_cnv</span> <span class="n">snmp_conv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_NUL</span><span class="p">,</span> <span class="n">SNMP_NULL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_INT</span><span class="p">,</span> <span class="n">SNMP_INTEGER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_OTS</span><span class="p">,</span> <span class="n">SNMP_OCTETSTR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_OTS</span><span class="p">,</span> <span class="n">SNMP_DISPLAYSTR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_OJI</span><span class="p">,</span> <span class="n">SNMP_OBJECTID</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_IPA</span><span class="p">,</span> <span class="n">SNMP_IPADDR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_CNT</span><span class="p">,</span> <span class="n">SNMP_COUNTER</span><span class="p">},</span>	<span class="cm">/* Counter32 */</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_GGE</span><span class="p">,</span> <span class="n">SNMP_GAUGE</span><span class="p">},</span>	<span class="cm">/* Gauge32 == Unsigned32  */</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_TIT</span><span class="p">,</span> <span class="n">SNMP_TIMETICKS</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_OPQ</span><span class="p">,</span> <span class="n">SNMP_OPAQUE</span><span class="p">},</span>

	<span class="cm">/* SNMPv2 data types and errors */</span>
	<span class="p">{</span><span class="n">ASN1_UNI</span><span class="p">,</span> <span class="n">ASN1_BTS</span><span class="p">,</span> <span class="n">SNMP_BITSTR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_APL</span><span class="p">,</span> <span class="n">SNMP_C64</span><span class="p">,</span> <span class="n">SNMP_COUNTER64</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_CTX</span><span class="p">,</span> <span class="n">SERR_NSO</span><span class="p">,</span> <span class="n">SNMP_NOSUCHOBJECT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_CTX</span><span class="p">,</span> <span class="n">SERR_NSI</span><span class="p">,</span> <span class="n">SNMP_NOSUCHINSTANCE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ASN1_CTX</span><span class="p">,</span> <span class="n">SERR_EOM</span><span class="p">,</span> <span class="n">SNMP_ENDOFMIBVIEW</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>       <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snmp_tag_cls2syntax</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cls</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">syntax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_cnv</span> <span class="o">*</span><span class="n">cnv</span><span class="p">;</span>

	<span class="n">cnv</span> <span class="o">=</span> <span class="n">snmp_conv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cnv</span><span class="o">-&gt;</span><span class="n">syntax</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnv</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">tag</span> <span class="o">&amp;&amp;</span> <span class="n">cnv</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">cls</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">syntax</span> <span class="o">=</span> <span class="n">cnv</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnv</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snmp_object_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snmp_object</span> <span class="o">**</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cls</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">idlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ul</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">l</span><span class="p">;</span>

	<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_CON</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_SEQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_OJI</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_oid_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snmp_tag_cls2syntax</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNMP_INTEGER</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_long_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNMP_OCTETSTR</span>:
	<span class="k">case</span> <span class="n">SNMP_OPAQUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octets_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">.</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNMP_NULL</span>:
	<span class="k">case</span> <span class="n">SNMP_NOSUCHOBJECT</span>:
	<span class="k">case</span> <span class="n">SNMP_NOSUCHINSTANCE</span>:
	<span class="k">case</span> <span class="n">SNMP_ENDOFMIBVIEW</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_null_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>
			<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNMP_OBJECTID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_oid_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">.</span><span class="n">ul</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNMP_IPADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octets_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">.</span><span class="n">uc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNMP_COUNTER</span>:
	<span class="k">case</span> <span class="n">SNMP_GAUGE</span>:
	<span class="k">case</span> <span class="n">SNMP_TIMETICKS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_ulong_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snmp_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax</span><span class="p">.</span><span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ul</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syntax_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id_len</span> <span class="o">=</span> <span class="n">idlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_eoc_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">eoc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>
		<span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snmp_request_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snmp_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cls</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_ulong_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_uint_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">error_status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_uint_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fast checksum update for possibly oddly-aligned UDP byte, from the</span>
<span class="cm"> * code example in the draft.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fast_csum</span><span class="p">(</span><span class="n">__sum16</span> <span class="o">*</span><span class="n">csum</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nptr</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~*</span><span class="n">optr</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">nptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~*</span><span class="n">optr</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">nptr</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_fold</span><span class="p">(</span><span class="n">csum_partial</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">~</span><span class="n">csum_unfold</span><span class="p">(</span><span class="o">*</span><span class="n">csum</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mangle IP address.</span>
<span class="cm"> * 	- begin points to the start of the snmp messgae</span>
<span class="cm"> *      - addr points to the start of the address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mangle_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">oct1_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
				  <span class="n">__sum16</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">==</span> <span class="n">NOCT1</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u_int32_t</span> <span class="n">old</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old</span><span class="p">));</span>

		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">;</span>

		<span class="cm">/* Update UDP checksum if being used */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fast_csum</span><span class="p">(</span><span class="n">check</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">,</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: mapped %pI4 to %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snmp_trap_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snmp_v1_trap</span> <span class="o">*</span><span class="n">trap</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">oct1_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
				      <span class="n">__sum16</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cls</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_OJI</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_oid_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">id_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_id_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">cls</span> <span class="o">==</span> <span class="n">ASN1_APL</span> <span class="o">&amp;&amp;</span> <span class="n">con</span> <span class="o">==</span> <span class="n">ASN1_PRI</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SNMP_IPA</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">cls</span> <span class="o">==</span> <span class="n">ASN1_UNI</span> <span class="o">&amp;&amp;</span> <span class="n">con</span> <span class="o">==</span> <span class="n">ASN1_PRI</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">ASN1_OTS</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_id_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octets_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">ip_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_id_free</span><span class="p">;</span>

	<span class="cm">/* IPv4 only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="n">mangle_address</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_uint_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">general</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_uint_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">specific</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">cls</span> <span class="o">==</span> <span class="n">ASN1_APL</span> <span class="o">&amp;&amp;</span> <span class="n">con</span> <span class="o">==</span> <span class="n">ASN1_PRI</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SNMP_TIT</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">cls</span> <span class="o">==</span> <span class="n">ASN1_UNI</span> <span class="o">&amp;&amp;</span> <span class="n">con</span> <span class="o">==</span> <span class="n">ASN1_PRI</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">ASN1_INT</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_ulong_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_addr_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">err_addr_free:</span>
	<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">ip_address</span><span class="p">);</span>

<span class="nl">err_id_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Misc. routines</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hex_dump</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse and mangle SNMP message according to mapping.</span>
<span class="cm"> * (And this is the fucking &#39;basic&#39; method).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snmp_parse_mangle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			     <span class="n">u_int16_t</span> <span class="n">len</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">oct1_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
			     <span class="n">__sum16</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eoc</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cls</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="n">pdutype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asn1_ctx</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asn1_octstr</span> <span class="n">comm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snmp_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hex_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">asn1_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start of SNMP message.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_CON</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_SEQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Version 1 or 2 handled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_INT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_uint_decode</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vers</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: snmp version: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Community.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_PRI</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_OTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_octets_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: community: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">comm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">comm</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * PDU type</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdutype</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_CTX</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_CON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">pdus</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">[</span><span class="n">SNMP_PDU_GET</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;get&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_NEXT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;get-next&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;response&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_SET</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;set&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_TRAP1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;trapv1&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_BULK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bulk&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_INFORM</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;inform&quot;</span><span class="p">,</span>
			<span class="p">[</span><span class="n">SNMP_PDU_TRAP2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;trapv2&quot;</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdutype</span> <span class="o">&gt;</span> <span class="n">SNMP_PDU_TRAP2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: bad pdu type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdutype</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: pdu: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdus</span><span class="p">[</span><span class="n">pdutype</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdutype</span> <span class="o">!=</span> <span class="n">SNMP_PDU_RESPONSE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdutype</span> <span class="o">!=</span> <span class="n">SNMP_PDU_TRAP1</span> <span class="o">&amp;&amp;</span> <span class="n">pdutype</span> <span class="o">!=</span> <span class="n">SNMP_PDU_TRAP2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Request header or v1 trap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdutype</span> <span class="o">==</span> <span class="n">SNMP_PDU_TRAP1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snmp_v1_trap</span> <span class="n">trap</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">snmp_trap_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trap</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">trap</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">trap</span><span class="p">.</span><span class="n">ip_address</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snmp_request</span> <span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snmp_request_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: request: id=0x%lx error_status=%u &quot;</span>
			<span class="s">&quot;error_index=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">error_status</span><span class="p">,</span>
			<span class="n">req</span><span class="p">.</span><span class="n">error_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through objects, look for IP addresses to mangle.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_header_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eoc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">ASN1_UNI</span> <span class="o">||</span> <span class="n">con</span> <span class="o">!=</span> <span class="n">ASN1_CON</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">ASN1_SEQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_eoc_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">eoc</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snmp_object_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;bsalg: object: &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: type=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNMP_IPADDR</span><span class="p">)</span>
			<span class="n">mangle_address</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">pointer</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asn1_eoc_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">eoc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * NAT routines.</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * SNMP translation routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snmp_translate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span> <span class="o">+</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>
	<span class="n">u_int16_t</span> <span class="n">udplen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">u_int16_t</span> <span class="n">paylen</span> <span class="o">=</span> <span class="n">udplen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">oct1_map</span> <span class="n">map</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine mappping for application layer addresses based</span>
<span class="cm">	 * on NAT manipulations for the packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SNAT traps */</span>
		<span class="n">map</span><span class="p">.</span><span class="n">from</span> <span class="o">=</span> <span class="n">NOCT1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">.</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">map</span><span class="p">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">NOCT1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">.</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DNAT replies */</span>
		<span class="n">map</span><span class="p">.</span><span class="n">from</span> <span class="o">=</span> <span class="n">NOCT1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u3</span><span class="p">.</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">map</span><span class="p">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">NOCT1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">tuplehash</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">].</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">u3</span><span class="p">.</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">from</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">to</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snmp_parse_mangle</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">udph</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">),</span>
			       <span class="n">paylen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;bsalg: parser failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We don&#39;t actually set up expectations, just adjust internal IP</span>
<span class="cm"> * addresses if this is being NATted */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">help</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protoff</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nf_conn</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">ip_conntrack_info</span> <span class="n">ctinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">CTINFO2DIR</span><span class="p">(</span><span class="n">ctinfo</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span> <span class="o">+</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>

	<span class="cm">/* SNMP replies and originating SNMP traps get mangled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">SNMP_PORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">IP_CT_DIR_REPLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">SNMP_TRAP_PORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">IP_CT_DIR_ORIGINAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="cm">/* No NAT? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IPS_NAT_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NF_ACCEPT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the packet length is ok.  So far, we were only guaranteed</span>
<span class="cm">	 * to have a valid length IP header plus 8 bytes, which means we have</span>
<span class="cm">	 * enough room for a UDP header.  Just verify the UDP length field so we</span>
<span class="cm">	 * can mess around with the payload.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;SNMP: dropping malformed packet src=%pI4 dst=%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
		 <span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_make_writable</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NF_DROP</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snmp_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snmp_translate</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ctinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snmp_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_conntrack_expect_policy</span> <span class="n">snmp_exp_policy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">max_expected</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>	<span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">snmp_helper</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">snmp_exp_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;snmp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">udp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">SNMP_PORT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nf_conntrack_helper</span> <span class="n">snmp_trap_helper</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">me</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help</span>			<span class="o">=</span> <span class="n">help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">expect_policy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">snmp_exp_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;snmp_trap&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">l3num</span>	<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">udp</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">SNMP_TRAP_PORT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">protonum</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Module stuff.</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nf_nat_snmp_basic_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nf_nat_snmp_hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">nf_nat_snmp_hook</span><span class="p">,</span> <span class="n">help</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nf_conntrack_helper_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snmp_trap_helper</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snmp_helper</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nf_nat_snmp_basic_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">nf_nat_snmp_hook</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">nf_conntrack_helper_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snmp_trap_helper</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nf_nat_snmp_basic_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nf_nat_snmp_basic_fini</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
