<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › tcp_ipv4.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tcp_ipv4.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * INET		An implementation of the TCP/IP protocol suite for the LINUX</span>
<span class="cm"> *		operating system.  INET is implemented using the  BSD Socket</span>
<span class="cm"> *		interface as the means of communication with the user level.</span>
<span class="cm"> *</span>
<span class="cm"> *		Implementation of the Transmission Control Protocol(TCP).</span>
<span class="cm"> *</span>
<span class="cm"> *		IPv4 specific functions</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *		code split from:</span>
<span class="cm"> *		linux/ipv4/tcp.c</span>
<span class="cm"> *		linux/ipv4/tcp_input.c</span>
<span class="cm"> *		linux/ipv4/tcp_output.c</span>
<span class="cm"> *</span>
<span class="cm"> *		See tcp.c for author information</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *		David S. Miller	:	New socket lookup architecture.</span>
<span class="cm"> *					This code is dedicated to John Dyson.</span>
<span class="cm"> *		David S. Miller :	Change semantics of established hash,</span>
<span class="cm"> *					half is devoted to TIME_WAIT sockets</span>
<span class="cm"> *					and the rest go in the other half.</span>
<span class="cm"> *		Andi Kleen :		Add support for syncookies and fixed</span>
<span class="cm"> *					some bugs: ip options weren&#39;t passed to</span>
<span class="cm"> *					the TCP layer, missed a check for an</span>
<span class="cm"> *					ACK bit.</span>
<span class="cm"> *		Andi Kleen :		Implemented fast path mtu discovery.</span>
<span class="cm"> *	     				Fixed many serious bugs in the</span>
<span class="cm"> *					request_sock handling and moved</span>
<span class="cm"> *					most of it into the af independent code.</span>
<span class="cm"> *					Added tail drop and some other bugfixes.</span>
<span class="cm"> *					Added new listen semantics.</span>
<span class="cm"> *		Mike McLagan	:	Routing by source</span>
<span class="cm"> *	Juan Jose Ciarlante:		ip_dynaddr bits</span>
<span class="cm"> *		Andi Kleen:		various fixes.</span>
<span class="cm"> *	Vitaly E. Lavrov	:	Transparent proxy revived after year</span>
<span class="cm"> *					coma.</span>
<span class="cm"> *	Andi Kleen		:	Fix new listen.</span>
<span class="cm"> *	Andi Kleen		:	Fix accept error reporting.</span>
<span class="cm"> *	YOSHIFUJI Hideaki @USAGI and:	Support IPV6_V6ONLY socket option, which</span>
<span class="cm"> *	Alexey Kuznetsov		allow both IPv4 and IPv6 sockets to bind</span>
<span class="cm"> *					a single port at the same time.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;TCP: &quot; fmt</span>

<span class="cp">#include &lt;linux/bottom_half.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/cache.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/icmp.h&gt;</span>
<span class="cp">#include &lt;net/inet_hashtables.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/transp_v6.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/inet_common.h&gt;</span>
<span class="cp">#include &lt;net/timewait_sock.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>
<span class="cp">#include &lt;net/netdma.h&gt;</span>
<span class="cp">#include &lt;net/secure_seq.h&gt;</span>
<span class="cp">#include &lt;net/tcp_memcontrol.h&gt;</span>

<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="kt">int</span> <span class="n">sysctl_tcp_tw_reuse</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_tcp_low_latency</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sysctl_tcp_low_latency</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tcp_v4_md5_hash_hdr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">md5_hash</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">inet_hashinfo</span> <span class="n">tcp_hashinfo</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_hashinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">tcp_v4_init_sequence</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">secure_tcp_sequence_number</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					  <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
					  <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span>
					  <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp_twsk_unique</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sktw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">twp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_timewait_sock</span> <span class="o">*</span><span class="n">tcptw</span> <span class="o">=</span> <span class="n">tcp_twsk</span><span class="p">(</span><span class="n">sktw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* With PAWS, it is safe from the viewpoint</span>
<span class="cm">	   of data integrity. Even without PAWS it is safe provided sequence</span>
<span class="cm">	   spaces do not overlap i.e. at data rates &lt;= 80Mbit/sec.</span>

<span class="cm">	   Actually, the idea is close to VJ&#39;s one, only timestamp cache is</span>
<span class="cm">	   held not per host, but per port pair and TW bucket is used as state</span>
<span class="cm">	   holder.</span>

<span class="cm">	   If TW bucket has been already destroyed we fall back to VJ&#39;s scheme</span>
<span class="cm">	   and use initial timestamp retrieved from peer table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent_stamp</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">twp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">sysctl_tcp_tw_reuse</span> <span class="o">&amp;&amp;</span>
			     <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent_stamp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">=</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_snd_nxt</span> <span class="o">+</span> <span class="mi">65535</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent</span>	   <span class="o">=</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span> <span class="o">=</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent_stamp</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">sktw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tcp_twsk_unique</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_repair_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcp_connect_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">tcp_finish_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This will initiate an outgoing connection. */</span>
<span class="kt">int</span> <span class="nf">tcp_v4_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">usin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__be16</span> <span class="n">orig_sport</span><span class="p">,</span> <span class="n">orig_dport</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">nexthop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">inet_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="n">nexthop</span> <span class="o">=</span> <span class="n">daddr</span> <span class="o">=</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">inet_opt</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">,</span>
					     <span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_opt</span> <span class="o">&amp;&amp;</span> <span class="n">inet_opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">srr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daddr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">nexthop</span> <span class="o">=</span> <span class="n">inet_opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">faddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">orig_sport</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">;</span>
	<span class="n">orig_dport</span> <span class="o">=</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">fl4</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">cork</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ip4</span><span class="p">;</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_connect</span><span class="p">(</span><span class="n">fl4</span><span class="p">,</span> <span class="n">nexthop</span><span class="p">,</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">,</span>
			      <span class="n">RT_CONN_FLAGS</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">,</span>
			      <span class="n">IPPROTO_TCP</span><span class="p">,</span>
			      <span class="n">orig_sport</span><span class="p">,</span> <span class="n">orig_dport</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">)</span>
			<span class="n">IP_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">IPSTATS_MIB_OUTNOROUTES</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_MULTICAST</span> <span class="o">|</span> <span class="n">RTCF_BROADCAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inet_opt</span> <span class="o">||</span> <span class="o">!</span><span class="n">inet_opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">srr</span><span class="p">)</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">)</span>
		<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_rcv_saddr</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span> <span class="o">&amp;&amp;</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span> <span class="o">!=</span> <span class="n">daddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset inherited state */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">repair</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_death_row</span><span class="p">.</span><span class="n">sysctl_tw_recycle</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span> <span class="o">&amp;&amp;</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">daddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="n">rt_get_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * VJ&#39;s idea. We save last timestamp seen from</span>
<span class="cm">		 * the destination in peer table, when entering state</span>
<span class="cm">		 * TIME-WAIT * and initialize rx_opt.ts_recent from it,</span>
<span class="cm">		 * when trying new connection.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inet_peer_refcheck</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span> <span class="o">&lt;=</span> <span class="n">TCP_PAWS_MSL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span><span class="p">;</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span> <span class="o">=</span> <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>

	<span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_opt</span><span class="p">)</span>
		<span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">=</span> <span class="n">inet_opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">mss_clamp</span> <span class="o">=</span> <span class="n">TCP_MSS_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Socket identity is still unknown (sport may be zero).</span>
<span class="cm">	 * However we set state to SYN-SENT and not releasing socket</span>
<span class="cm">	 * lock select source port, enter ourselves into the hash tables and</span>
<span class="cm">	 * complete initialization after this.</span>
<span class="cm">	 */</span>
	<span class="n">tcp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TCP_SYN_SENT</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">inet_hash_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_death_row</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_newports</span><span class="p">(</span><span class="n">fl4</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">orig_sport</span><span class="p">,</span> <span class="n">orig_dport</span><span class="p">,</span>
			       <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">,</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* OK, now commit destination to socket.  */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_TCPV4</span><span class="p">;</span>
	<span class="n">sk_setup_caps</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">repair</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">=</span> <span class="n">secure_tcp_sequence_number</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">,</span>
							   <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">,</span>
							   <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">,</span>
							   <span class="n">usin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>

	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">^</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">repair</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tcp_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tcp_repair_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failure:</span>
	<span class="cm">/*</span>
<span class="cm">	 * This unhashes the socket and releases the local port,</span>
<span class="cm">	 * if necessary.</span>
<span class="cm">	 */</span>
	<span class="n">tcp_set_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">TCP_CLOSE</span><span class="p">);</span>
	<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_route_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_connect</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This routine does path mtu discovery as defined in RFC1191.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_pmtu_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* We are not interested in TCP_LISTEN and open_requests (SYN-ACKs</span>
<span class="cm">	 * send out by Linux are always &lt;576bytes so they should go through</span>
<span class="cm">	 * unfragmented).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t check in the destentry if pmtu discovery is forbidden</span>
<span class="cm">	 * on this route. We just assume that no packet_to_big packets</span>
<span class="cm">	 * are send back when pmtu discovery is not active.</span>
<span class="cm">	 * There is a small race when the user changes this flag in the</span>
<span class="cm">	 * route, but I think that&#39;s acceptable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dst</span> <span class="o">=</span> <span class="n">__sk_dst_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">update_pmtu</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

	<span class="cm">/* Something is about to be wrong... Remember soft error</span>
<span class="cm">	 * for the case, if this connection will not able to recover.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip_dont_fragment</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err_soft</span> <span class="o">=</span> <span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">pmtudisc</span> <span class="o">!=</span> <span class="n">IP_PMTUDISC_DONT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_pmtu_cookie</span> <span class="o">&gt;</span> <span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcp_sync_mss</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

		<span class="cm">/* Resend the TCP packet because it&#39;s</span>
<span class="cm">		 * clear that the old packet has been</span>
<span class="cm">		 * dropped. This is the new &quot;fast&quot; path mtu</span>
<span class="cm">		 * discovery.</span>
<span class="cm">		 */</span>
		<span class="n">tcp_simple_retransmit</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* else let the usual retransmit timer handle it */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by the ICMP module when it gets some</span>
<span class="cm"> * sort of error condition.  If err &lt; 0 then the socket should</span>
<span class="cm"> * be closed and the error returned to the user.  If err &gt; 0</span>
<span class="cm"> * it&#39;s just the icmp type &lt;&lt; 8 | icmp code.  After adjustment</span>
<span class="cm"> * header points to the first 8 bytes of the tcp header.  We need</span>
<span class="cm"> * to find the appropriate port.</span>
<span class="cm"> *</span>
<span class="cm"> * The locking strategy used here is very &quot;optimistic&quot;. When</span>
<span class="cm"> * someone else accesses the socket the ICMP is just dropped</span>
<span class="cm"> * and for some paths there is no check at all.</span>
<span class="cm"> * A more general error queue to queue errors for later handling</span>
<span class="cm"> * is probably better.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tcp_v4_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">icmp_skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">icmp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">icmp_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">icmp_hdr</span><span class="p">(</span><span class="n">icmp_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">icmp_hdr</span><span class="p">(</span><span class="n">icmp_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">icmp_skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icmp_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ICMP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ICMP_MIB_INERRORS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">inet_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span>
			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">inet_iif</span><span class="p">(</span><span class="n">icmp_skb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ICMP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ICMP_MIB_INERRORS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_TIME_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="cm">/* If too many ICMPs get dropped on busy</span>
<span class="cm">	 * servers this needs to be solved differently.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_LOCKDROPPEDICMPS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">&lt;</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min_ttl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMINTTLDROP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">between</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_OUTOFWINDOWICMPS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ICMP_SOURCE_QUENCH</span>:
		<span class="cm">/* Just silently ignore these. */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ICMP_PARAMETERPROB</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ICMP_DEST_UNREACH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;</span> <span class="n">NR_ICMP_UNREACH</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">ICMP_FRAG_NEEDED</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* PMTU discovery (RFC1191) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
				<span class="n">do_pmtu_discovery</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">iph</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">icmp_err_convert</span><span class="p">[</span><span class="n">code</span><span class="p">].</span><span class="n">errno</span><span class="p">;</span>
		<span class="cm">/* check if icmp_skb allows revert of backoff</span>
<span class="cm">		 * (see draft-zimmermann-tcp-lcd) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">ICMP_NET_UNREACH</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">ICMP_HOST_UNREACH</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_una</span>  <span class="o">||</span> <span class="o">!</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_retransmits</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_backoff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_backoff</span><span class="o">--</span><span class="p">;</span>
		<span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_rto</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">srtt</span> <span class="o">?</span> <span class="n">__tcp_set_rto</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">TCP_TIMEOUT_INIT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_backoff</span><span class="p">;</span>
		<span class="n">tcp_bound_rto</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">tcp_write_queue_head</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">remaining</span> <span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_rto</span> <span class="o">-</span> <span class="n">min</span><span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_rto</span><span class="p">,</span>
				<span class="n">tcp_time_stamp</span> <span class="o">-</span> <span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">when</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inet_csk_reset_xmit_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">ICSK_TIME_RETRANS</span><span class="p">,</span>
						  <span class="n">remaining</span><span class="p">,</span> <span class="n">TCP_RTO_MAX</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* RTO revert clocked out retransmission.</span>
<span class="cm">			 * Will retransmit now */</span>
			<span class="n">tcp_retransmit_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ICMP_TIME_EXCEEDED</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">EHOSTUNREACH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">**</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_LISTEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">inet_csk_search_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span>
					  <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* ICMPs are not backlogged, hence we cannot get</span>
<span class="cm">		   an established socket here.</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">!=</span> <span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_isn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_OUTOFWINDOWICMPS</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Still in SYN_RECV, just remove it silently.</span>
<span class="cm">		 * There is no good way to pass the error to the newly</span>
<span class="cm">		 * created socket, and POSIX does not want network</span>
<span class="cm">		 * errors returned from accept().</span>
<span class="cm">		 */</span>
		<span class="n">inet_csk_reqsk_queue_drop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TCP_SYN_SENT</span>:
	<span class="k">case</span> <span class="n">TCP_SYN_RECV</span>:  <span class="cm">/* Cannot happen.</span>
<span class="cm">			       It can f.e. if SYNs crossed.</span>
<span class="cm">			     */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

			<span class="n">tcp_done</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err_soft</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;ve already connected we will keep trying</span>
<span class="cm">	 * until we time out, or the user gives up.</span>
<span class="cm">	 *</span>
<span class="cm">	 * rfc1122 4.2.3.9 allows to consider as hard errors</span>
<span class="cm">	 * only PROTO_UNREACH and PORT_UNREACH (well, FRAG_FAILED too,</span>
<span class="cm">	 * but it is obsoleted by pmtu discovery).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note, that in modern internet, where routing is unreliable</span>
<span class="cm">	 * and in each dark corner broken firewalls sit, sending random</span>
<span class="cm">	 * errors ordered by their masters even this two messages finally lose</span>
<span class="cm">	 * their original sense (even Linux sends invalid PORT_UNREACHs)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Now we are in compliance with RFCs.</span>
<span class="cm">	 *							--ANK (980905)</span>
<span class="cm">	 */</span>

	<span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">recverr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span> <span class="cm">/* Only an error on timeout */</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err_soft</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tcp_v4_send_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">th</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">tcp_v4_check</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">=</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">th</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="n">tcp_v4_check</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span>
					 <span class="n">csum_partial</span><span class="p">(</span><span class="n">th</span><span class="p">,</span>
						      <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
						      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This routine computes an IPv4 TCP checksum. */</span>
<span class="kt">void</span> <span class="nf">tcp_v4_send_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">__tcp_v4_send_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">,</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_send_check</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tcp_v4_gso_send_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">th</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">th</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">;</span>
	<span class="n">__tcp_v4_send_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	This routine will send an RST to the other tcp.</span>
<span class="cm"> *</span>
<span class="cm"> *	Someone asks: why I NEVER use socket parameters (TOS, TTL etc.)</span>
<span class="cm"> *		      for reset.</span>
<span class="cm"> *	Answer: if a packet caused RST, it is not for a socket</span>
<span class="cm"> *		existing in our system, if it is matched to a socket,</span>
<span class="cm"> *		it is just duplicate segment or bug in other side&#39;s TCP.</span>
<span class="cm"> *		So that we build reply only basing on parameters</span>
<span class="cm"> *		arrived with segment.</span>
<span class="cm"> *	Exception: precedence violation. We do not implement it in any case.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_v4_send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">th</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
		<span class="n">__be32</span> <span class="n">opt</span><span class="p">[(</span><span class="n">TCPOLEN_MD5SIG_ALIGNED</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)];</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="n">rep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_reply_arg</span> <span class="n">arg</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">hash_location</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newhash</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">genhash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="cm">/* Never send a reset in response to a reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rt_type</span> <span class="o">!=</span> <span class="n">RTN_LOCAL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Swap the send and the receive. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rep</span><span class="p">));</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">dest</span>   <span class="o">=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">doff</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">rst</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">+</span>
				       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rep</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="n">hash_location</span> <span class="o">=</span> <span class="n">tcp_parse_md5sig_option</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span> <span class="o">&amp;&amp;</span> <span class="n">hash_location</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * active side is lost. Try to find listening socket through</span>
<span class="cm">		 * source port, and then find md5 key through listening socket.</span>
<span class="cm">		 * we are not loose security here:</span>
<span class="cm">		 * Incoming packet is checked with md5 hash with finding key,</span>
<span class="cm">		 * no RST generated if md5 hash doesn&#39;t match.</span>
<span class="cm">		 */</span>
		<span class="n">sk1</span> <span class="o">=</span> <span class="n">__inet_lookup_listener</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					     <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					     <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">),</span> <span class="n">inet_iif</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="cm">/* don&#39;t send rst if it can&#39;t find key */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk1</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk1</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release_sk1</span><span class="p">;</span>

		<span class="n">genhash</span> <span class="o">=</span> <span class="n">tcp_v4_md5_hash_skb</span><span class="p">(</span><span class="n">newhash</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">genhash</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">hash_location</span><span class="p">,</span> <span class="n">newhash</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release_sk1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">sk</span> <span class="o">?</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span>
					     <span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
					     <span class="n">AF_INET</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">TCPOPT_MD5SIG</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">TCPOLEN_MD5SIG</span><span class="p">);</span>
		<span class="cm">/* Update length and the length the header thinks exists */</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">TCPOLEN_MD5SIG_ALIGNED</span><span class="p">;</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">doff</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">tcp_v4_md5_hash_hdr</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">key</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				     <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_tcpudp_nofold</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				      <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="cm">/* XXX */</span>
				      <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">csumoffset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sk</span> <span class="o">&amp;&amp;</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">)</span> <span class="o">?</span> <span class="n">IP_REPLY_ARG_NOSRCCHECK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* When socket is gone, all binding information is lost.</span>
<span class="cm">	 * routing might fail in this case. using iif for oif to</span>
<span class="cm">	 * make sure we can deliver it</span>
<span class="cm">	 */</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">bound_dev_if</span> <span class="o">=</span> <span class="n">sk</span> <span class="o">?</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span> <span class="o">:</span> <span class="n">inet_iif</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">tos</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">;</span>
	<span class="n">ip_send_reply</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_sock</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_OUTSEGS</span><span class="p">);</span>
	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_OUTRSTS</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
<span class="nl">release_sk1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* The code following below sending ACKs in SYN-RECV and TIME-WAIT states</span>
<span class="cm">   outside socket context is ugly, certainly. What can I do?</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_v4_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ack</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">win</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reply_flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tcphdr</span> <span class="n">th</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">opt</span><span class="p">[(</span><span class="n">TCPOLEN_TSTAMP_ALIGNED</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
			   <span class="o">+</span> <span class="p">(</span><span class="n">TCPOLEN_MD5SIG_ALIGNED</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">];</span>
	<span class="p">}</span> <span class="n">rep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_reply_arg</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>

	<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rep</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">TCPOPT_TIMESTAMP</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">TCPOLEN_TIMESTAMP</span><span class="p">);</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">tcp_time_stamp</span><span class="p">);</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">TCPOLEN_TSTAMP_ALIGNED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Swap the send and the receive. */</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">dest</span>    <span class="o">=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">source</span>  <span class="o">=</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">doff</span>    <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">seq</span>     <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ack</span><span class="p">);</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">ack</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">window</span>  <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">win</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="n">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">TCPOPT_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">TCPOPT_MD5SIG</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">TCPOLEN_MD5SIG</span><span class="p">);</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">TCPOLEN_MD5SIG_ALIGNED</span><span class="p">;</span>
		<span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">.</span><span class="n">doff</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

		<span class="n">tcp_v4_md5_hash_hdr</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rep</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
				    <span class="n">key</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				    <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rep</span><span class="p">.</span><span class="n">th</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">reply_flags</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_tcpudp_nofold</span><span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				      <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="cm">/* XXX */</span>
				      <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">csumoffset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oif</span><span class="p">)</span>
		<span class="n">arg</span><span class="p">.</span><span class="n">bound_dev_if</span> <span class="o">=</span> <span class="n">oif</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">tos</span> <span class="o">=</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">ip_send_reply</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_sock</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_OUTSEGS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_v4_timewait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span> <span class="o">=</span> <span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_timewait_sock</span> <span class="o">*</span><span class="n">tcptw</span> <span class="o">=</span> <span class="n">tcp_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">tcp_v4_send_ack</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_snd_nxt</span><span class="p">,</span> <span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_rcv_nxt</span><span class="p">,</span>
			<span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_rcv_wnd</span> <span class="o">&gt;&gt;</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_rcv_wscale</span><span class="p">,</span>
			<span class="n">tcptw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent</span><span class="p">,</span>
			<span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_bound_dev_if</span><span class="p">,</span>
			<span class="n">tcp_twsk_md5_key</span><span class="p">(</span><span class="n">tcptw</span><span class="p">),</span>
			<span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_transparent</span> <span class="o">?</span> <span class="n">IP_REPLY_ARG_NOSRCCHECK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_tos</span>
			<span class="p">);</span>

	<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">tw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_v4_reqsk_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcp_v4_send_ack</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_isn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_isn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">ts_recent</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					  <span class="n">AF_INET</span><span class="p">),</span>
			<span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">no_srccheck</span> <span class="o">?</span> <span class="n">IP_REPLY_ARG_NOSRCCHECK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Send a SYN-ACK after having received a SYN.</span>
<span class="cm"> *	This still operates on a request_sock only, not on a big</span>
<span class="cm"> *	socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_send_synack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">request_values</span> <span class="o">*</span><span class="n">rvp</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">queue_mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* First, grab a route. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dst</span> <span class="o">=</span> <span class="n">inet_csk_route_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">tcp_make_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rvp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__tcp_v4_send_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">);</span>

		<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue_mapping</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip_build_and_send_pkt</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span>
					    <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">,</span>
					    <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">net_xmit_eval</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_rtx_synack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">request_values</span> <span class="o">*</span><span class="n">rvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">TCP_MIB_RETRANSSEGS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tcp_v4_send_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rvp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	IPv4 request_sock destructor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_v4_reqsk_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return true if a syncookie should be sent</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">tcp_syn_flood_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Dropping request&quot;</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">want_cookie</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">listen_sock</span> <span class="o">*</span><span class="n">lopt</span><span class="p">;</span>



<span class="cp">#ifdef CONFIG_SYN_COOKIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysctl_tcp_syncookies</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Sending cookies&quot;</span><span class="p">;</span>
		<span class="n">want_cookie</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_TCPREQQFULLDOCOOKIES</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_TCPREQQFULLDROP</span><span class="p">);</span>

	<span class="n">lopt</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">listen_opt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lopt</span><span class="o">-&gt;</span><span class="n">synflood_warned</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lopt</span><span class="o">-&gt;</span><span class="n">synflood_warned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Possible SYN flooding on port %d. %s.  Check SNMP counters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">proto</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">),</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">want_cookie</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_syn_flood_action</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Save and compile IPv4 options into the request_sock if needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="nf">tcp_v4_save_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ip_options</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">IPCB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">dopt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;&amp;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">opt_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dopt</span><span class="p">)</span> <span class="o">+</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">optlen</span><span class="p">;</span>

		<span class="n">dopt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">opt_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dopt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip_options_echo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dopt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dopt</span><span class="p">);</span>
				<span class="n">dopt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dopt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
<span class="cm">/*</span>
<span class="cm"> * RFC2385 MD5 checksumming requires a mapping of</span>
<span class="cm"> * IP address-&gt;MD5 Key.</span>
<span class="cm"> * We need to maintain these in the sk structure.</span>
<span class="cm"> */</span>

<span class="cm">/* Find the Key structure for an address.  */</span>
<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="nf">tcp_md5_do_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_info</span> <span class="o">*</span><span class="n">md5sig</span><span class="p">;</span>

	<span class="cm">/* caller either holds rcu_read_lock() or socket lock */</span>
	<span class="n">md5sig</span> <span class="o">=</span> <span class="n">rcu_dereference_check</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span>
				       <span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">||</span>
				       <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_lock</span><span class="p">.</span><span class="n">slock</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md5sig</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if IS_ENABLED(CONFIG_IPV6)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">family</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">key</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_md5_do_lookup</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="nf">tcp_v4_md5_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">addr_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">inet_sk</span><span class="p">(</span><span class="n">addr_sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_md5_lookup</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="nf">tcp_v4_reqsk_md5_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This can be called on a newly created socket, from other files */</span>
<span class="kt">int</span> <span class="nf">tcp_md5_do_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">newkey</span><span class="p">,</span> <span class="n">u8</span> <span class="n">newkeylen</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Add Key to the list */</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_info</span> <span class="o">*</span><span class="n">md5sig</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Pre-existing entry - just update that one. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">newkey</span><span class="p">,</span> <span class="n">newkeylen</span><span class="p">);</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">newkeylen</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md5sig</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span>
					   <span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md5sig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md5sig</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">md5sig</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md5sig</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sk_nocaps_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">NETIF_F_GSO_MASK</span><span class="p">);</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span> <span class="n">md5sig</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tcp_alloc_md5sig_pool</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">newkey</span><span class="p">,</span> <span class="n">newkeylen</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">newkeylen</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">)</span> <span class="o">:</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">));</span>
	<span class="n">hlist_add_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_md5_do_add</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tcp_md5_do_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_info</span> <span class="o">*</span><span class="n">md5sig</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">hlist_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
	<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="n">md5sig</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span>
					   <span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span>
		<span class="n">tcp_free_md5sig_pool</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_md5_do_del</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tcp_clear_md5_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_info</span> <span class="o">*</span><span class="n">md5sig</span><span class="p">;</span>

	<span class="n">md5sig</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span>
		<span class="n">tcp_free_md5sig_pool</span><span class="p">();</span>
	<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md5sig</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_parse_md5_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_key</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_keylen</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tcp_md5_do_del</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
				      <span class="n">AF_INET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_keylen</span> <span class="o">&gt;</span> <span class="n">TCP_MD5SIG_MAXKEYLEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tcp_md5_do_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			      <span class="n">AF_INET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_key</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">tcpm_keylen</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_md5_hash_pseudoheader</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_md5sig_pool</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
					<span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp4_pseudohdr</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">md5_blk</span><span class="p">.</span><span class="n">ip4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 1. the TCP pseudo-header (in the order: source IP address,</span>
<span class="cm">	 * destination IP address, zero-padded protocol number, and</span>
<span class="cm">	 * segment length)</span>
<span class="cm">	 */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">nbytes</span><span class="p">);</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">crypto_hash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">md5_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_md5_hash_hdr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">md5_hash</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_pool</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">tcp_get_md5sig_pool</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clear_hash_noput</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">md5_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_hash_init</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_v4_md5_hash_pseudoheader</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_md5_hash_header</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">th</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_md5_hash_key</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_hash_final</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>

	<span class="n">tcp_put_md5sig_pool</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">clear_hash:</span>
	<span class="n">tcp_put_md5sig_pool</span><span class="p">();</span>
<span class="nl">clear_hash_noput:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">md5_hash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp_v4_md5_hash_skb</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">md5_hash</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_pool</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_saddr</span><span class="p">;</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">tcp_get_md5sig_pool</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clear_hash_noput</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">md5_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_hash_init</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_v4_md5_hash_pseudoheader</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_md5_hash_header</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">th</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_md5_hash_skb_data</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_md5_hash_key</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_hash_final</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clear_hash</span><span class="p">;</span>

	<span class="n">tcp_put_md5sig_pool</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">clear_hash:</span>
	<span class="n">tcp_put_md5sig_pool</span><span class="p">();</span>
<span class="nl">clear_hash_noput:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">md5_hash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_md5_hash_skb</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tcp_v4_inbound_md5_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This gets called for each TCP segment that arrives</span>
<span class="cm">	 * so we want to be efficient.</span>
<span class="cm">	 * We have 3 drop cases:</span>
<span class="cm">	 * o No MD5 hash and one expected.</span>
<span class="cm">	 * o MD5 hash and we&#39;re not expecting one.</span>
<span class="cm">	 * o MD5 hash and its wrong.</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">hash_location</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">hash_expected</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">genhash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newhash</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">hash_expected</span> <span class="o">=</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
					  <span class="n">AF_INET</span><span class="p">);</span>
	<span class="n">hash_location</span> <span class="o">=</span> <span class="n">tcp_parse_md5sig_option</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>

	<span class="cm">/* We&#39;ve parsed the options - do we have a hash? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hash_expected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hash_location</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hash_expected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hash_location</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_TCPMD5NOTFOUND</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hash_expected</span> <span class="o">&amp;&amp;</span> <span class="n">hash_location</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_TCPMD5UNEXPECTED</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Okay, so this is hash_expected and hash_location -</span>
<span class="cm">	 * so we need to calculate the checksum.</span>
<span class="cm">	 */</span>
	<span class="n">genhash</span> <span class="o">=</span> <span class="n">tcp_v4_md5_hash_skb</span><span class="p">(</span><span class="n">newhash</span><span class="p">,</span>
				      <span class="n">hash_expected</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">genhash</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">hash_location</span><span class="p">,</span> <span class="n">newhash</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;MD5 Hash failed for (%pI4, %d)-&gt;(%pI4, %d)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">),</span>
				     <span class="n">genhash</span> <span class="o">?</span> <span class="s">&quot; tcp_v4_calc_md5_hash failed&quot;</span>
				     <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">request_sock_ops</span> <span class="n">tcp_request_sock_ops</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span>	<span class="n">PF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span>	<span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_request_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rtx_syn_ack</span>	<span class="o">=</span>	<span class="n">tcp_v4_rtx_synack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_ack</span>	<span class="o">=</span>	<span class="n">tcp_v4_reqsk_send_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span>	<span class="n">tcp_v4_reqsk_destructor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_reset</span>	<span class="o">=</span>	<span class="n">tcp_v4_send_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">syn_ack_timeout</span> <span class="o">=</span> 	<span class="n">tcp_syn_ack_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_request_sock_ops</span> <span class="n">tcp_request_sock_ipv4_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">md5_lookup</span>	<span class="o">=</span>	<span class="n">tcp_v4_reqsk_md5_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_md5_hash</span>	<span class="o">=</span>	<span class="n">tcp_v4_md5_hash_skb</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">tcp_v4_conn_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_extend_values</span> <span class="n">tmp_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_options_received</span> <span class="n">tmp_opt</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hash_location</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">saddr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">daddr</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">isn</span> <span class="o">=</span> <span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">when</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">want_cookie</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Never answer to SYNs send to broadcast or multicast */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_BROADCAST</span> <span class="o">|</span> <span class="n">RTCF_MULTICAST</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* TW buckets are converted to open requests without</span>
<span class="cm">	 * limitations, they conserve resources and peer is</span>
<span class="cm">	 * evidently real one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_csk_reqsk_queue_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">want_cookie</span> <span class="o">=</span> <span class="n">tcp_syn_flood_action</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;TCP&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Accept backlog is full. If we have already queued enough</span>
<span class="cm">	 * of warm entries in syn queue, drop request. It is better than</span>
<span class="cm">	 * clogging syn queue with openreqs with exponentially increasing</span>
<span class="cm">	 * timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">inet_csk_reqsk_queue_young</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">inet_reqsk_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_request_sock_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">af_specific</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_request_sock_ipv4_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">tcp_clear_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">);</span>
	<span class="n">tmp_opt</span><span class="p">.</span><span class="n">mss_clamp</span> <span class="o">=</span> <span class="n">TCP_MSS_DEFAULT</span><span class="p">;</span>
	<span class="n">tmp_opt</span><span class="p">.</span><span class="n">user_mss</span>  <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">user_mss</span><span class="p">;</span>
	<span class="n">tcp_parse_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hash_location</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_opt</span><span class="p">.</span><span class="n">cookie_plus</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tmp_opt</span><span class="p">.</span><span class="n">saw_tstamp</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">cookie_out_never</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sysctl_tcp_cookie_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cookie_values</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cookie_values</span><span class="o">-&gt;</span><span class="n">cookie_desired</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">mess</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_bakery</span><span class="p">[</span><span class="n">COOKIE_DIGEST_WORDS</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">tmp_opt</span><span class="p">.</span><span class="n">cookie_plus</span> <span class="o">-</span> <span class="n">TCPOLEN_COOKIE_BASE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcp_cookie_generator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_bakery</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop_and_release</span><span class="p">;</span>

		<span class="cm">/* Secret recipe starts with IP addresses */</span>
		<span class="o">*</span><span class="n">mess</span><span class="o">++</span> <span class="o">^=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">daddr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mess</span><span class="o">++</span> <span class="o">^=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">saddr</span><span class="p">;</span>

		<span class="cm">/* plus variable length Initiator Cookie */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mess</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">^=</span> <span class="o">*</span><span class="n">hash_location</span><span class="o">++</span><span class="p">;</span>

		<span class="n">want_cookie</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* not our kind of cookie */</span>
		<span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_out_never</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* false */</span>
		<span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_plus</span> <span class="o">=</span> <span class="n">tmp_opt</span><span class="p">.</span><span class="n">cookie_plus</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">cookie_in_always</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* redundant indications, but ensure initialization. */</span>
		<span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_out_never</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* true */</span>
		<span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_plus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">drop_and_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp_ext</span><span class="p">.</span><span class="n">cookie_in_always</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">cookie_in_always</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">want_cookie</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tmp_opt</span><span class="p">.</span><span class="n">saw_tstamp</span><span class="p">)</span>
		<span class="n">tcp_clear_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">);</span>

	<span class="n">tmp_opt</span><span class="p">.</span><span class="n">tstamp_ok</span> <span class="o">=</span> <span class="n">tmp_opt</span><span class="p">.</span><span class="n">saw_tstamp</span><span class="p">;</span>
	<span class="n">tcp_openreq_init</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ireq</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_addr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">no_srccheck</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">opt</span> <span class="o">=</span> <span class="n">tcp_v4_save_options</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">security_inet_conn_request</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_and_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span> <span class="o">||</span> <span class="n">tmp_opt</span><span class="p">.</span><span class="n">tstamp_ok</span><span class="p">)</span>
		<span class="n">TCP_ECN_create_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">want_cookie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isn</span> <span class="o">=</span> <span class="n">cookie_v4_init_sequence</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cookie_ts</span> <span class="o">=</span> <span class="n">tmp_opt</span><span class="p">.</span><span class="n">tstamp_ok</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>

		<span class="cm">/* VJ&#39;s idea. We save last timestamp seen</span>
<span class="cm">		 * from the destination in peer table, when entering</span>
<span class="cm">		 * state TIME-WAIT, and check against it before</span>
<span class="cm">		 * accepting new connection request.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If &quot;isn&quot; is not zero, this request hit alive</span>
<span class="cm">		 * timewait bucket, so that all the necessary checks</span>
<span class="cm">		 * are made in the function processing timewait state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_opt</span><span class="p">.</span><span class="n">saw_tstamp</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tcp_death_row</span><span class="p">.</span><span class="n">sysctl_tw_recycle</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dst</span> <span class="o">=</span> <span class="n">inet_csk_route_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">saddr</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">peer</span> <span class="o">=</span> <span class="n">rt_get_peer</span><span class="p">((</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inet_peer_refcheck</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span> <span class="o">&lt;</span> <span class="n">TCP_PAWS_MSL</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ts_recent</span><span class="p">)</span> <span class="o">&gt;</span>
							<span class="n">TCP_PAWS_WINDOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_PAWSPASSIVEREJECTED</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop_and_release</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Kill the following clause, if you dislike this way. */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysctl_tcp_syncookies</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">sysctl_max_syn_backlog</span> <span class="o">-</span> <span class="n">inet_csk_reqsk_queue_len</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&lt;</span>
			  <span class="p">(</span><span class="n">sysctl_max_syn_backlog</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="o">!</span><span class="n">peer</span> <span class="o">||</span> <span class="o">!</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="o">!</span><span class="n">dst</span> <span class="o">||</span> <span class="o">!</span><span class="n">dst_metric</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_RTT</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Without syncookies last quarter of</span>
<span class="cm">			 * backlog is filled with destinations,</span>
<span class="cm">			 * proven to be alive.</span>
<span class="cm">			 * It means that we continue to communicate</span>
<span class="cm">			 * to destinations, already remembered</span>
<span class="cm">			 * to the moment of synflood.</span>
<span class="cm">			 */</span>
			<span class="n">LIMIT_NETDEBUG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;drop open request from %pI4/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">drop_and_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">isn</span> <span class="o">=</span> <span class="n">tcp_v4_init_sequence</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_isn</span> <span class="o">=</span> <span class="n">isn</span><span class="p">;</span>
	<span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_synack</span> <span class="o">=</span> <span class="n">tcp_time_stamp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_v4_send_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			       <span class="p">(</span><span class="k">struct</span> <span class="n">request_values</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_ext</span><span class="p">,</span>
			       <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">want_cookie</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_and_free</span><span class="p">;</span>

	<span class="n">inet_csk_reqsk_queue_hash_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">TCP_TIMEOUT_INIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_and_release:</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="nl">drop_and_free:</span>
	<span class="n">reqsk_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_conn_request</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * The three way handshake has completed - we got a valid synack -</span>
<span class="cm"> * now create the new socket.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">tcp_v4_syn_recv_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">newinet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">newtp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">newsk</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="k">struct</span> <span class="n">tcp_md5sig_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">ip_options_rcu</span> <span class="o">*</span><span class="n">inet_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_overflow</span><span class="p">;</span>

	<span class="n">newsk</span> <span class="o">=</span> <span class="n">tcp_create_openreq_child</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newsk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_nonewsk</span><span class="p">;</span>

	<span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_TCPV4</span><span class="p">;</span>

	<span class="n">newtp</span>		      <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">newinet</span>		      <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">ireq</span>		      <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span>   <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">;</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_rcv_saddr</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_saddr</span>	      <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">;</span>
	<span class="n">inet_opt</span>	      <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_opt</span><span class="p">,</span> <span class="n">inet_opt</span><span class="p">);</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">opt</span>	      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">mc_index</span>     <span class="o">=</span> <span class="n">inet_iif</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">mc_ttl</span>	      <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">;</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">rcv_tos</span>      <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">;</span>
	<span class="n">inet_csk</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_opt</span><span class="p">)</span>
		<span class="n">inet_csk</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ext_hdr_len</span> <span class="o">=</span> <span class="n">inet_opt</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="n">optlen</span><span class="p">;</span>
	<span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_id</span> <span class="o">=</span> <span class="n">newtp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">^</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">inet_csk_route_child_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">newsk</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">put_and_exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* syncookie case : see end of cookie_v4_check() */</span>
	<span class="p">}</span>
	<span class="n">sk_setup_caps</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="n">tcp_mtup_init</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">tcp_sync_mss</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">newtp</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">dst_metric_advmss</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">user_mss</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">user_mss</span> <span class="o">&lt;</span> <span class="n">newtp</span><span class="o">-&gt;</span><span class="n">advmss</span><span class="p">)</span>
		<span class="n">newtp</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">user_mss</span><span class="p">;</span>

	<span class="n">tcp_initialize_rcv_mss</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_synack</span><span class="p">)</span>
		<span class="n">tcp_valid_rtt_meas</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span>
		    <span class="n">tcp_time_stamp</span> <span class="o">-</span> <span class="n">tcp_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">snt_synack</span><span class="p">);</span>
	<span class="n">newtp</span><span class="o">-&gt;</span><span class="n">total_retrans</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="cm">/* Copy over the MD5 key from the original socket */</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">tcp_md5_do_lookup</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">,</span>
				<span class="n">AF_INET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re using one, so create a matching key</span>
<span class="cm">		 * on the newsk structure. If we fail to get</span>
<span class="cm">		 * memory, then we end up not copying the key</span>
<span class="cm">		 * across. Shucks.</span>
<span class="cm">		 */</span>
		<span class="n">tcp_md5_do_add</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">tcp_md5_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">newinet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">,</span>
			       <span class="n">AF_INET</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">sk_nocaps_add</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="n">NETIF_F_GSO_MASK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__inet_inherit_port</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">newsk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_and_exit</span><span class="p">;</span>
	<span class="n">__inet_hash_nolisten</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">newsk</span><span class="p">;</span>

<span class="nl">exit_overflow:</span>
	<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_LISTENOVERFLOWS</span><span class="p">);</span>
<span class="nl">exit_nonewsk:</span>
	<span class="n">dst_release</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_LISTENDROPS</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">put_and_exit:</span>
	<span class="n">tcp_clear_xmit_timers</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">tcp_cleanup_congestion_control</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_syn_recv_sock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">tcp_v4_hnd_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">nsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">**</span><span class="n">prev</span><span class="p">;</span>
	<span class="cm">/* Find possible connection requests. */</span>
	<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">inet_csk_search_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span>
						       <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tcp_check_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>

	<span class="n">nsk</span> <span class="o">=</span> <span class="n">inet_lookup_established</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
			<span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span> <span class="n">inet_iif</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nsk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_TIME_WAIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bh_lock_sock</span><span class="p">(</span><span class="n">nsk</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nsk</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">nsk</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYN_COOKIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">cookie_v4_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">IPCB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__sum16</span> <span class="nf">tcp_v4_checksum_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_v4_check</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				  <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_tcpudp_nofold</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">76</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">__skb_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* The socket must have it&#39;s spinlock held when we get</span>
<span class="cm"> * here.</span>
<span class="cm"> *</span>
<span class="cm"> * We have a potential double-lock case here, so even when</span>
<span class="cm"> * doing backlog processing we use the BH locking scheme.</span>
<span class="cm"> * This is because we cannot sleep with the original spinlock</span>
<span class="cm"> * held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tcp_v4_do_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">rsk</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="cm">/*</span>
<span class="cm">	 * We really want to reject the packet as early as possible</span>
<span class="cm">	 * if:</span>
<span class="cm">	 *  o We&#39;re expecting an MD5&#39;d packet and this is no MD5 tcp option</span>
<span class="cm">	 *  o There is an MD5 option and we&#39;re not expecting one</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_v4_inbound_md5_hash</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Fast path */</span>
		<span class="n">sock_rps_save_rxhash</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcp_rcv_established</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rsk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">||</span> <span class="n">tcp_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">csum_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">nsk</span> <span class="o">=</span> <span class="n">tcp_v4_hnd_req</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsk</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nsk</span> <span class="o">!=</span> <span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_rps_save_rxhash</span><span class="p">(</span><span class="n">nsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcp_child_process</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">nsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rsk</span> <span class="o">=</span> <span class="n">nsk</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sock_rps_save_rxhash</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_rcv_state_process</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rsk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">reset:</span>
	<span class="n">tcp_v4_send_reset</span><span class="p">(</span><span class="n">rsk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">discard:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="cm">/* Be careful here. If this function gets more complicated and</span>
<span class="cm">	 * gcc suffers from register pressure on the x86, sk (in %ebx)</span>
<span class="cm">	 * might be destroyed here. This current version compiles correctly,</span>
<span class="cm">	 * but you have been warned.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">csum_err:</span>
	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">TCP_MIB_INERRS</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_do_rcv</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	From tcp_input.c</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tcp_v4_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">!=</span> <span class="n">PACKET_HOST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

	<span class="cm">/* Count it even if it&#39;s bad */</span>
	<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_INSEGS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

	<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_packet</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

	<span class="cm">/* An explanation is required here, I think.</span>
<span class="cm">	 * Packet length and doff are validated by header prediction,</span>
<span class="cm">	 * provided case of th-&gt;doff==0 is eliminated.</span>
<span class="cm">	 * So, we defer the checks. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_csum_unnecessary</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tcp_v4_checksum_init</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad_packet</span><span class="p">;</span>

	<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">+</span>
				    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">when</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ip_dsfield</span> <span class="o">=</span> <span class="n">ipv4_get_dsfield</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>
	<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sacked</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">__inet_lookup_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_tcp_socket</span><span class="p">;</span>

<span class="nl">process:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_TIME_WAIT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_time_wait</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">&lt;</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min_ttl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMINTTLDROP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">discard_and_relse</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfrm4_policy_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">XFRM_POLICY_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">discard_and_relse</span><span class="p">;</span>
	<span class="n">nf_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk_filter</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">discard_and_relse</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bh_lock_sock_nested</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NET_DMA</span>
		<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ucopy</span><span class="p">.</span><span class="n">dma_chan</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ucopy</span><span class="p">.</span><span class="n">pinned_list</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ucopy</span><span class="p">.</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="n">net_dma_find_channel</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ucopy</span><span class="p">.</span><span class="n">dma_chan</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tcp_v4_do_rcv</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_prequeue</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">tcp_v4_do_rcv</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sk_add_backlog</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					   <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">+</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPBACKLOGDROP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">discard_and_relse</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bh_unlock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_tcp_socket:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfrm4_policy_check</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">XFRM_POLICY_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="n">tcp_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">bad_packet:</span>
		<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_INERRS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tcp_v4_send_reset</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">discard_it:</span>
	<span class="cm">/* Discard frame. */</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">discard_and_relse:</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

<span class="nl">do_time_wait:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfrm4_policy_check</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">XFRM_POLICY_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="n">tcp_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TCP_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">TCP_MIB_INERRS</span><span class="p">);</span>
		<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tcp_timewait_state_process</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_TW_SYN</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk2</span> <span class="o">=</span> <span class="n">inet_lookup_listener</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
							<span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span>
							<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span>
							<span class="n">inet_iif</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inet_twsk_deschedule</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tcp_death_row</span><span class="p">);</span>
			<span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
			<span class="n">sk</span> <span class="o">=</span> <span class="n">sk2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">process</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall through to ACK */</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TCP_TW_ACK</span>:
		<span class="n">tcp_v4_timewait_ack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_TW_RST</span>:
		<span class="k">goto</span> <span class="n">no_tcp_socket</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_TW_SUCCESS</span>:<span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="nf">tcp_v4_get_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">release_it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">__sk_dst_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span> <span class="o">||</span>
	    <span class="n">inet</span><span class="o">-&gt;</span><span class="n">cork</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ip4</span><span class="p">.</span><span class="n">daddr</span> <span class="o">!=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">inet_getpeer_v4</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">release_it</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
			<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
		<span class="o">*</span><span class="n">release_it</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">peer</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_get_peer</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">tcp_v4_tw_get_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span> <span class="o">=</span> <span class="n">inet_twsk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">inet_getpeer_v4</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_daddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_tw_get_peer</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timewait_sock_ops</span> <span class="n">tcp_timewait_sock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">twsk_obj_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_timewait_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">twsk_unique</span>	<span class="o">=</span> <span class="n">tcp_twsk_unique</span><span class="p">,</span>
	<span class="p">.</span><span class="n">twsk_destructor</span><span class="o">=</span> <span class="n">tcp_twsk_destructor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">twsk_getpeer</span>	<span class="o">=</span> <span class="n">tcp_v4_tw_get_peer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_connection_sock_af_ops</span> <span class="n">ipv4_specific</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue_xmit</span>	   <span class="o">=</span> <span class="n">ip_queue_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_check</span>	   <span class="o">=</span> <span class="n">tcp_v4_send_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild_header</span>	   <span class="o">=</span> <span class="n">inet_sk_rebuild_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_request</span>	   <span class="o">=</span> <span class="n">tcp_v4_conn_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">syn_recv_sock</span>	   <span class="o">=</span> <span class="n">tcp_v4_syn_recv_sock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_peer</span>	   <span class="o">=</span> <span class="n">tcp_v4_get_peer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">net_header_len</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">),</span>
	<span class="p">.</span><span class="n">setsockopt</span>	   <span class="o">=</span> <span class="n">ip_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	   <span class="o">=</span> <span class="n">ip_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr2sockaddr</span>	   <span class="o">=</span> <span class="n">inet_csk_addr2sockaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sockaddr_len</span>	   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bind_conflict</span>	   <span class="o">=</span> <span class="n">inet_csk_bind_conflict</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_setsockopt</span> <span class="o">=</span> <span class="n">compat_ip_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_getsockopt</span> <span class="o">=</span> <span class="n">compat_ip_getsockopt</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ipv4_specific</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_sock_af_ops</span> <span class="n">tcp_sock_ipv4_specific</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">md5_lookup</span>		<span class="o">=</span> <span class="n">tcp_v4_md5_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_md5_hash</span>		<span class="o">=</span> <span class="n">tcp_v4_md5_hash_skb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">md5_parse</span>		<span class="o">=</span> <span class="n">tcp_v4_parse_md5_keys</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* NOTE: A lot of things set to zero explicitly by call to</span>
<span class="cm"> *       sk_alloc() so need not be done here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp_v4_init_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">tcp_init_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_af_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_specific</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">af_specific</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sock_ipv4_specific</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tcp_v4_destroy_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">tcp_clear_xmit_timers</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">tcp_cleanup_congestion_control</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Cleanup up the write buffer. */</span>
	<span class="n">tcp_write_queue_purge</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* Cleans up our, hopefully empty, out_of_order_queue. */</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">out_of_order_queue</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TCP_MD5SIG</span>
	<span class="cm">/* Clean up the MD5 key list, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcp_clear_md5_list</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">md5sig_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_NET_DMA</span>
	<span class="cm">/* Cleans up our sk_async_wait_queue */</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_async_wait_queue</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Clean prequeue, it must be empty really */</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ucopy</span><span class="p">.</span><span class="n">prequeue</span><span class="p">);</span>

	<span class="cm">/* Clean up a referenced TCP bind bucket. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_bind_hash</span><span class="p">)</span>
		<span class="n">inet_put_port</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If sendmsg cached page exists, toss it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndmsg_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndmsg_page</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndmsg_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TCP Cookie Transactions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cookie_values</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cookie_values</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span>
			 <span class="n">tcp_cookie_values_release</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cookie_values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sk_sockets_allocated_dec</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_release_memcg</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_v4_destroy_sock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/* Proc filesystem TCP sock list dumping. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="nf">tw_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">hlist_nulls_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hlist_nulls_empty</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span>
		<span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span><span class="p">,</span> <span class="n">tw_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="nf">tw_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">is_a_nulls</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_node</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">hlist_nulls_entry</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">tw</span><span class="p">),</span> <span class="n">tw_node</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get next listener socket follow cur.  If cur is NULL, get first socket</span>
<span class="cm"> * starting from bucket given in st-&gt;bucket; when st-&gt;bucket is zero the</span>
<span class="cm"> * very first socket in the hash table is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">listening_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_nulls_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_listen_hashbucket</span> <span class="o">*</span><span class="n">ilb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ilb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">listening_hash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">];</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_nulls_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_sk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ilb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">listening_hash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">];</span>
	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>

		<span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">syn_wait_sk</span><span class="p">);</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dl_next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rsk_ops</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cur</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dl_next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">sbucket</span> <span class="o">&gt;=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">listen_opt</span><span class="o">-&gt;</span><span class="n">nr_table_entries</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
<span class="nl">get_req:</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">listen_opt</span><span class="o">-&gt;</span><span class="n">syn_table</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">sbucket</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">sk</span>	  <span class="o">=</span> <span class="n">sk_nulls_next</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">syn_wait_sk</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_LISTENING</span><span class="p">;</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reqsk_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">start_req</span><span class="p">;</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_nulls_next</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">get_sk:</span>
	<span class="n">sk_nulls_for_each_from</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reqsk_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">start_req:</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">uid</span>		<span class="o">=</span> <span class="n">sock_i_uid</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">syn_wait_sk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span>	<span class="o">=</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">sbucket</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">get_req</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&lt;</span> <span class="n">INET_LHTABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ilb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">listening_hash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">];</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_nulls_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_sk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">listening_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">listening_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">listening_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="o">--*</span><span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">empty_bucket</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hlist_nulls_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">hlist_nulls_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">twchain</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get first established socket starting from bucket given in st-&gt;bucket.</span>
<span class="cm"> * If st-&gt;bucket is zero, the very first socket in the hash is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">established_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&lt;=</span> <span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span><span class="p">;</span> <span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hlist_nulls_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span><span class="p">;</span>
		<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="n">inet_ehash_lockp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">);</span>

		<span class="cm">/* Lockless fast path for the common case of empty buckets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">empty_bucket</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">sk_nulls_for_each</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">!=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span><span class="p">;</span>
		<span class="n">inet_twsk_for_each</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">twchain</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_family</span> <span class="o">!=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">twsk_net</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">tw</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">established_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_nulls_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
		<span class="n">tw</span> <span class="o">=</span> <span class="n">tw_next</span><span class="p">(</span><span class="n">tw</span><span class="p">);</span>
<span class="nl">get_tw:</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tw</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_family</span> <span class="o">!=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">||</span> <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">twsk_net</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">net</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tw</span> <span class="o">=</span> <span class="n">tw_next</span><span class="p">(</span><span class="n">tw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">tw</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">inet_ehash_lockp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">));</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span><span class="p">;</span>

		<span class="cm">/* Look for next non empty bucket */</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&lt;=</span> <span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span> <span class="o">&amp;&amp;</span>
				<span class="n">empty_bucket</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&gt;</span> <span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">inet_ehash_lockp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">));</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_nulls_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_nulls_next</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sk_nulls_for_each_from</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&amp;&amp;</span> <span class="n">net_eq</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span><span class="p">;</span>
	<span class="n">tw</span> <span class="o">=</span> <span class="n">tw_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">twchain</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">get_tw</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cur</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">established_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">established_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">established_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tcp_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_LISTENING</span><span class="p">;</span>
	<span class="n">rc</span>	  <span class="o">=</span> <span class="n">listening_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span><span class="p">;</span>
		<span class="n">rc</span>	  <span class="o">=</span> <span class="n">established_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tcp_seek_last_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_num</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_LISTENING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&gt;=</span> <span class="n">INET_LHTABLE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_LISTENING</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">listening_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">listening_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Fallthrough */</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&gt;</span> <span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">ehash_mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">established_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">established_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">orig_num</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tcp_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tcp_seek_last_pos</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_LISTENING</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">tcp_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tcp_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tcp_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_LISTENING</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">listening_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rc</span>	  <span class="o">=</span> <span class="n">established_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">established_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">syn_wait_sk</span><span class="p">);</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">.</span><span class="n">syn_wait_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_LISTENING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">.</span><span class="n">listening_hash</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">inet_ehash_lockp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_seq_afinfo</span> <span class="o">*</span><span class="n">afinfo</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">seq_ops</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_iter_state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">)</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">family</span>		<span class="o">=</span> <span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">last_pos</span> 		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_seq_open</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tcp_proc_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_seq_afinfo</span> <span class="o">*</span><span class="n">afinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">seq_ops</span><span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">tcp_seq_start</span><span class="p">;</span>
	<span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">seq_ops</span><span class="p">.</span><span class="n">next</span>		<span class="o">=</span> <span class="n">tcp_seq_next</span><span class="p">;</span>
	<span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">seq_ops</span><span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">tcp_seq_stop</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">,</span>
			     <span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">seq_fops</span><span class="p">,</span> <span class="n">afinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_proc_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tcp_proc_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcp_seq_afinfo</span> <span class="o">*</span><span class="n">afinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_proc_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_openreq4</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_request_sock</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">inet_rsk</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ttd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%4d: %08X:%04X %08X:%04X&quot;</span>
		<span class="s">&quot; %02X %08X:%08X %02X:%08lX %08X %5d %8d %u %d %pK%n&quot;</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">loc_addr</span><span class="p">,</span>
		<span class="n">ntohs</span><span class="p">(</span><span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">),</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_addr</span><span class="p">,</span>
		<span class="n">ntohs</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">rmt_port</span><span class="p">),</span>
		<span class="n">TCP_SYN_RECV</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* could print option size, but that is af dependent. */</span>
		<span class="mi">1</span><span class="p">,</span>    <span class="cm">/* timers active (only the expire timer) */</span>
		<span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">ttd</span><span class="p">),</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">,</span>
		<span class="n">uid</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* non standard timer */</span>
		<span class="mi">0</span><span class="p">,</span> <span class="cm">/* open_requests have no inode */</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">),</span>
		<span class="n">req</span><span class="p">,</span>
		<span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_tcp4_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer_active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_expires</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_daddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">src</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_rcv_saddr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">destp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">);</span>
	<span class="n">__u16</span> <span class="n">srcp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rx_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_pending</span> <span class="o">==</span> <span class="n">ICSK_TIME_RETRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timer_active</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">timer_expires</span>	<span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_pending</span> <span class="o">==</span> <span class="n">ICSK_TIME_PROBE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timer_active</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">timer_expires</span>	<span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">timer_active</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timer_expires</span>	<span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timer_active</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">timer_expires</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
		<span class="n">rx_queue</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * because we dont lock socket, we might find a transient negative value</span>
<span class="cm">		 */</span>
		<span class="n">rx_queue</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%4d: %08X:%04X %08X:%04X %02X %08X:%08X %02X:%08lX &quot;</span>
			<span class="s">&quot;%08X %5d %8d %lu %d %pK %lu %lu %u %u %d%n&quot;</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcp</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">destp</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">,</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">,</span>
		<span class="n">rx_queue</span><span class="p">,</span>
		<span class="n">timer_active</span><span class="p">,</span>
		<span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">timer_expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">),</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_retransmits</span><span class="p">,</span>
		<span class="n">sock_i_uid</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_probes_out</span><span class="p">,</span>
		<span class="n">sock_i_ino</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">),</span> <span class="n">sk</span><span class="p">,</span>
		<span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_rto</span><span class="p">),</span>
		<span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">ato</span><span class="p">),</span>
		<span class="p">(</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">quick</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">pingpong</span><span class="p">,</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd</span><span class="p">,</span>
		<span class="n">tcp_in_initial_slowstart</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_ssthresh</span><span class="p">,</span>
		<span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_timewait4_sock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">inet_timewait_sock</span> <span class="o">*</span><span class="n">tw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">destp</span><span class="p">,</span> <span class="n">srcp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ttd</span> <span class="o">=</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_ttd</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ttd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ttd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dest</span>  <span class="o">=</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_daddr</span><span class="p">;</span>
	<span class="n">src</span>   <span class="o">=</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_rcv_saddr</span><span class="p">;</span>
	<span class="n">destp</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_dport</span><span class="p">);</span>
	<span class="n">srcp</span>  <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_sport</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%4d: %08X:%04X %08X:%04X&quot;</span>
		<span class="s">&quot; %02X %08X:%08X %02X:%08lX %08X %5d %8d %d %d %pK%n&quot;</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcp</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">destp</span><span class="p">,</span> <span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_substate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">3</span><span class="p">,</span> <span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">ttd</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_refcnt</span><span class="p">),</span> <span class="n">tw</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TMPSZ 150</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcp4_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcp_iter_state</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%-*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TMPSZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			   <span class="s">&quot;  sl  local_address rem_address   st tx_queue &quot;</span>
			   <span class="s">&quot;rx_queue tr tm-&gt;when retrnsmt   uid  timeout &quot;</span>
			   <span class="s">&quot;inode&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_LISTENING</span>:
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_ESTABLISHED</span>:
		<span class="n">get_tcp4_sock</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_OPENREQ</span>:
		<span class="n">get_openreq4</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">syn_wait_sk</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_SEQ_STATE_TIME_WAIT</span>:
		<span class="n">get_timewait4_sock</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TMPSZ</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">tcp_afinfo_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">tcp_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_net</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tcp_seq_afinfo</span> <span class="n">tcp4_seq_afinfo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seq_fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_afinfo_seq_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seq_ops</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">show</span>		<span class="o">=</span> <span class="n">tcp4_seq_show</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">tcp4_proc_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tcp_proc_register</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp4_seq_afinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">tcp4_proc_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcp_proc_unregister</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp4_seq_afinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">tcp4_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">tcp4_proc_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">tcp4_proc_exit_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">tcp4_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp4_net_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tcp4_proc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp4_net_ops</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="nf">tcp4_gro_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">skb_gro_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHECKSUM_COMPLETE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_v4_check</span><span class="p">(</span><span class="n">skb_gro_len</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">CHECKSUM_NONE</span>:
		<span class="n">NAPI_GRO_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tcp_gro_receive</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp4_gro_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">th</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">tcp_v4_check</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				  <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_TCPV4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tcp_gro_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">proto</span> <span class="n">tcp_prot</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;TCP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">tcp_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>		<span class="o">=</span> <span class="n">tcp_v4_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>		<span class="o">=</span> <span class="n">tcp_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>			<span class="o">=</span> <span class="n">inet_csk_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">tcp_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">tcp_v4_init_sock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>		<span class="o">=</span> <span class="n">tcp_v4_destroy_sock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>		<span class="o">=</span> <span class="n">tcp_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>		<span class="o">=</span> <span class="n">tcp_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>		<span class="o">=</span> <span class="n">tcp_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>		<span class="o">=</span> <span class="n">tcp_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>		<span class="o">=</span> <span class="n">tcp_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span>		<span class="o">=</span> <span class="n">tcp_sendpage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">backlog_rcv</span>		<span class="o">=</span> <span class="n">tcp_v4_do_rcv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hash</span>			<span class="o">=</span> <span class="n">inet_hash</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unhash</span>			<span class="o">=</span> <span class="n">inet_unhash</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_port</span>		<span class="o">=</span> <span class="n">inet_csk_get_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enter_memory_pressure</span>	<span class="o">=</span> <span class="n">tcp_enter_memory_pressure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sockets_allocated</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_sockets_allocated</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orphan_count</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_orphan_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">memory_allocated</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_memory_allocated</span><span class="p">,</span>
	<span class="p">.</span><span class="n">memory_pressure</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_memory_pressure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysctl_wmem</span>		<span class="o">=</span> <span class="n">sysctl_tcp_wmem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysctl_rmem</span>		<span class="o">=</span> <span class="n">sysctl_tcp_rmem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_header</span>		<span class="o">=</span> <span class="n">MAX_TCP_HEADER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">slab_flags</span>		<span class="o">=</span> <span class="n">SLAB_DESTROY_BY_RCU</span><span class="p">,</span>
	<span class="p">.</span><span class="n">twsk_prot</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_timewait_sock_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsk_prot</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_request_sock_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">hashinfo</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_autobind</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_setsockopt</span>	<span class="o">=</span> <span class="n">compat_tcp_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_getsockopt</span>	<span class="o">=</span> <span class="n">compat_tcp_getsockopt</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_CGROUP_MEM_RES_CTLR_KMEM</span>
	<span class="p">.</span><span class="n">init_cgroup</span>		<span class="o">=</span> <span class="n">tcp_init_cgroup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_cgroup</span>		<span class="o">=</span> <span class="n">tcp_destroy_cgroup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proto_cgroup</span>		<span class="o">=</span> <span class="n">tcp_proto_cgroup</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_prot</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">tcp_sk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inet_ctl_sock_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_sock</span><span class="p">,</span>
				    <span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">tcp_sk_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_ctl_sock_destroy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_sock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">tcp_sk_exit_batch</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">net_exit_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_twsk_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp_death_row</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">__net_initdata</span> <span class="n">tcp_sk_ops</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">.</span><span class="n">init</span>	   <span class="o">=</span> <span class="n">tcp_sk_init</span><span class="p">,</span>
       <span class="p">.</span><span class="n">exit</span>	   <span class="o">=</span> <span class="n">tcp_sk_exit</span><span class="p">,</span>
       <span class="p">.</span><span class="n">exit_batch</span> <span class="o">=</span> <span class="n">tcp_sk_exit_batch</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">tcp_v4_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_hashinfo_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_sk_ops</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to create the TCP control socket.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
