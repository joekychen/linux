<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › igmp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>igmp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Linux NET3:	Internet Group Management Protocol  [IGMP]</span>
<span class="cm"> *</span>
<span class="cm"> *	This code implements the IGMP protocol as defined in RFC1112. There has</span>
<span class="cm"> *	been a further revision of this protocol since which is now supported.</span>
<span class="cm"> *</span>
<span class="cm"> *	If you have trouble with this module be careful what gcc you have used,</span>
<span class="cm"> *	the older version didn&#39;t come out right using gcc 2.5.8, the newer one</span>
<span class="cm"> *	seems to fall out with gcc 2.6.2.</span>
<span class="cm"> *</span>
<span class="cm"> *	Authors:</span>
<span class="cm"> *		Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Fixes:</span>
<span class="cm"> *</span>
<span class="cm"> *		Alan Cox	:	Added lots of __inline__ to optimise</span>
<span class="cm"> *					the memory usage of all the tiny little</span>
<span class="cm"> *					functions.</span>
<span class="cm"> *		Alan Cox	:	Dumped the header building experiment.</span>
<span class="cm"> *		Alan Cox	:	Minor tweaks ready for multicast routing</span>
<span class="cm"> *					and extended IGMP protocol.</span>
<span class="cm"> *		Alan Cox	:	Removed a load of inline directives. Gcc 2.5.8</span>
<span class="cm"> *					writes utterly bogus code otherwise (sigh)</span>
<span class="cm"> *					fixed IGMP loopback to behave in the manner</span>
<span class="cm"> *					desired by mrouted, fixed the fact it has been</span>
<span class="cm"> *					broken since 1.3.6 and cleaned up a few minor</span>
<span class="cm"> *					points.</span>
<span class="cm"> *</span>
<span class="cm"> *		Chih-Jen Chang	:	Tried to revise IGMP to Version 2</span>
<span class="cm"> *		Tsu-Sheng Tsao		E-mail: chihjenc@scf.usc.edu and tsusheng@scf.usc.edu</span>
<span class="cm"> *					The enhancements are mainly based on Steve Deering&#39;s</span>
<span class="cm"> * 					ipmulti-3.5 source code.</span>
<span class="cm"> *		Chih-Jen Chang	:	Added the igmp_get_mrouter_info and</span>
<span class="cm"> *		Tsu-Sheng Tsao		igmp_set_mrouter_info to keep track of</span>
<span class="cm"> *					the mrouted version on that device.</span>
<span class="cm"> *		Chih-Jen Chang	:	Added the max_resp_time parameter to</span>
<span class="cm"> *		Tsu-Sheng Tsao		igmp_heard_query(). Using this parameter</span>
<span class="cm"> *					to identify the multicast router version</span>
<span class="cm"> *					and do what the IGMP version 2 specified.</span>
<span class="cm"> *		Chih-Jen Chang	:	Added a timer to revert to IGMP V2 router</span>
<span class="cm"> *		Tsu-Sheng Tsao		if the specified time expired.</span>
<span class="cm"> *		Alan Cox	:	Stop IGMP from 0.0.0.0 being accepted.</span>
<span class="cm"> *		Alan Cox	:	Use GFP_ATOMIC in the right places.</span>
<span class="cm"> *		Christian Daudt :	igmp timer wasn&#39;t set for local group</span>
<span class="cm"> *					memberships but was being deleted,</span>
<span class="cm"> *					which caused a &quot;del_timer() called</span>
<span class="cm"> *					from %p with timer not initialized\n&quot;</span>
<span class="cm"> *					message (960131).</span>
<span class="cm"> *		Christian Daudt :	removed del_timer from</span>
<span class="cm"> *					igmp_timer_expire function (960205).</span>
<span class="cm"> *             Christian Daudt :       igmp_heard_report now only calls</span>
<span class="cm"> *                                     igmp_timer_expire if tm-&gt;running is</span>
<span class="cm"> *                                     true (960216).</span>
<span class="cm"> *		Malcolm Beattie :	ttl comparison wrong in igmp_rcv made</span>
<span class="cm"> *					igmp_heard_query never trigger. Expiry</span>
<span class="cm"> *					miscalculation fixed in igmp_heard_query</span>
<span class="cm"> *					and random() made to return unsigned to</span>
<span class="cm"> *					prevent negative expiry times.</span>
<span class="cm"> *		Alexey Kuznetsov:	Wrong group leaving behaviour, backport</span>
<span class="cm"> *					fix from pending 2.1.x patches.</span>
<span class="cm"> *		Alan Cox:		Forget to enable FDDI support earlier.</span>
<span class="cm"> *		Alexey Kuznetsov:	Fixed leaving groups on device down.</span>
<span class="cm"> *		Alexey Kuznetsov:	Accordance to igmp-v2-06 draft.</span>
<span class="cm"> *		David L Stevens:	IGMPv3 support, with help from</span>
<span class="cm"> *					Vinay Kulkarni</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/igmp.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4.h&gt;</span>
<span class="cp">#ifdef CONFIG_IP_MROUTE</span>
<span class="cp">#include &lt;linux/mroute.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define IP_MAX_MEMBERSHIPS	20</span>
<span class="cp">#define IP_MAX_MSF		10</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
<span class="cm">/* Parameter names and values are taken from igmp-v2-06 draft */</span>

<span class="cp">#define IGMP_V1_Router_Present_Timeout		(400*HZ)</span>
<span class="cp">#define IGMP_V2_Router_Present_Timeout		(400*HZ)</span>
<span class="cp">#define IGMP_Unsolicited_Report_Interval	(10*HZ)</span>
<span class="cp">#define IGMP_Query_Response_Interval		(10*HZ)</span>
<span class="cp">#define IGMP_Unsolicited_Report_Count		2</span>


<span class="cp">#define IGMP_Initial_Report_Delay		(1)</span>

<span class="cm">/* IGMP_Initial_Report_Delay is not from IGMP specs!</span>
<span class="cm"> * IGMP specs require to report membership immediately after</span>
<span class="cm"> * joining a group, but we delay the first report by a</span>
<span class="cm"> * small interval. It seems more natural and still does not</span>
<span class="cm"> * contradict to specs provided this delay is small enough.</span>
<span class="cm"> */</span>

<span class="cp">#define IGMP_V1_SEEN(in_dev) \</span>
<span class="cp">	(IPV4_DEVCONF_ALL(dev_net(in_dev-&gt;dev), FORCE_IGMP_VERSION) == 1 || \</span>
<span class="cp">	 IN_DEV_CONF_GET((in_dev), FORCE_IGMP_VERSION) == 1 || \</span>
<span class="cp">	 ((in_dev)-&gt;mr_v1_seen &amp;&amp; \</span>
<span class="cp">	  time_before(jiffies, (in_dev)-&gt;mr_v1_seen)))</span>
<span class="cp">#define IGMP_V2_SEEN(in_dev) \</span>
<span class="cp">	(IPV4_DEVCONF_ALL(dev_net(in_dev-&gt;dev), FORCE_IGMP_VERSION) == 2 || \</span>
<span class="cp">	 IN_DEV_CONF_GET((in_dev), FORCE_IGMP_VERSION) == 2 || \</span>
<span class="cp">	 ((in_dev)-&gt;mr_v2_seen &amp;&amp; \</span>
<span class="cp">	  time_before(jiffies, (in_dev)-&gt;mr_v2_seen)))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">igmpv3_add_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">igmpv3_del_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">multiaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">igmpv3_clear_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sf_setstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sf_markstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ip_mc_clear_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_mc_add_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_ma_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">in_dev_put</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define for_each_pmc_rcu(in_dev, pmc)				\</span>
<span class="cp">	for (pmc = rcu_dereference(in_dev-&gt;mc_list);		\</span>
<span class="cp">	     pmc != NULL;					\</span>
<span class="cp">	     pmc = rcu_dereference(pmc-&gt;next_rcu))</span>

<span class="cp">#define for_each_pmc_rtnl(in_dev, pmc)				\</span>
<span class="cp">	for (pmc = rtnl_dereference(in_dev-&gt;mc_list);		\</span>
<span class="cp">	     pmc != NULL;					\</span>
<span class="cp">	     pmc = rtnl_dereference(pmc-&gt;next_rcu))</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>

<span class="cm">/*</span>
<span class="cm"> *	Timer management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_stop_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">reporter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">unsolicit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* It must be called with locked im-&gt;lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">max_delay</span><span class="p">;</span>

	<span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">tv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_gq_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_maxdelay</span><span class="p">;</span>

	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">tv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_ifc_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">tv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_mod_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">unsolicit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">igmp_start_timer</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Send an IGMP report.</span>
<span class="cm"> */</span>

<span class="cp">#define IGMP_SIZE (sizeof(struct igmphdr)+sizeof(struct iphdr)+4)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IGMPV3_MODE_IS_INCLUDE</span>:
	<span class="k">case</span> <span class="n">IGMPV3_MODE_IS_EXCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* don&#39;t include if this source is excluded</span>
<span class="cm">			 * in all filters</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_MODE_IS_INCLUDE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IGMPV3_CHANGE_TO_INCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IGMPV3_CHANGE_TO_EXCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">IGMPV3_ALLOW_NEW_SOURCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="o">^</span> <span class="n">sdeleted</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">gdeleted</span> <span class="o">||</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">&amp;&amp;</span> <span class="n">sdeleted</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gdeleted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdeleted</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">igmp_scount</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">scount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define igmp_skb_size(skb) (*(unsigned int *)((skb)-&gt;cb))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">igmpv3_newpack</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">pip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmpv3_report</span> <span class="o">*</span><span class="n">pig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">igmp_skb_size</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_ports</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IGMPV3_ALL_MCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">IPPROTO_IGMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">version</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">ihl</span>      <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">tos</span>      <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">IP_DF</span><span class="p">);</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">ttl</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">daddr</span>    <span class="o">=</span> <span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">saddr</span>    <span class="o">=</span> <span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_IGMP</span><span class="p">;</span>
	<span class="n">pip</span><span class="o">-&gt;</span><span class="n">tot_len</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* filled in later */</span>
	<span class="n">ip_select_ident</span><span class="p">(</span><span class="n">pip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pip</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPOPT_RA</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pip</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pip</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pip</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pig</span><span class="p">));</span>
	<span class="n">pig</span> <span class="o">=</span> <span class="n">igmpv3_report_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_HOST_MEMBERSHIP_REPORT</span><span class="p">;</span>
	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">resv1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">resv2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">ngrec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmpv3_sendpack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmphdr</span> <span class="o">*</span><span class="n">pig</span> <span class="o">=</span> <span class="n">igmp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">igmplen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span><span class="p">;</span>

	<span class="n">pig</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">ip_compute_csum</span><span class="p">(</span><span class="n">igmp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">igmplen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ip_local_out</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grec_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_grec</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">igmp_scount</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdel</span><span class="p">,</span> <span class="n">sdel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">add_grhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">igmpv3_grec</span> <span class="o">**</span><span class="n">ppgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmpv3_report</span> <span class="o">*</span><span class="n">pih</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmpv3_grec</span> <span class="o">*</span><span class="n">pgr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">igmpv3_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pgr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_grec</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_grec</span><span class="p">));</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_auxwords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_mca</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">;</span>
	<span class="n">pih</span> <span class="o">=</span> <span class="n">igmpv3_report_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pih</span><span class="o">-&gt;</span><span class="n">ngrec</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pih</span><span class="o">-&gt;</span><span class="n">ngrec</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ppgr</span> <span class="o">=</span> <span class="n">pgr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AVAILABLE(skb) ((skb) ? ((skb)-&gt;dev ? igmp_skb_size(skb) - (skb)-&gt;len : \</span>
<span class="cp">	skb_tailroom(skb)) : 0)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">add_grec</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmpv3_report</span> <span class="o">*</span><span class="n">pih</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmpv3_grec</span> <span class="o">*</span><span class="n">pgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">,</span> <span class="o">**</span><span class="n">psf_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scount</span><span class="p">,</span> <span class="n">stotal</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">isquery</span><span class="p">,</span> <span class="n">truncate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">isquery</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_MODE_IS_INCLUDE</span> <span class="o">||</span>
		  <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_MODE_IS_EXCLUDE</span><span class="p">;</span>
	<span class="n">truncate</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_MODE_IS_EXCLUDE</span> <span class="o">||</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_CHANGE_TO_EXCLUDE</span><span class="p">;</span>

	<span class="n">stotal</span> <span class="o">=</span> <span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psf_list</span> <span class="o">=</span> <span class="n">sdeleted</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">psf_list</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">empty_source</span><span class="p">;</span>

	<span class="n">pih</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">?</span> <span class="n">igmpv3_report_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* EX and TO_EX get a fresh packet, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pih</span> <span class="o">&amp;&amp;</span> <span class="n">pih</span><span class="o">-&gt;</span><span class="n">ngrec</span> <span class="o">&amp;&amp;</span>
		    <span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">grec_size</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">igmpv3_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">igmpv3_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=*</span><span class="n">psf_list</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">psrc</span><span class="p">;</span>

		<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear marks on query responses */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isquery</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">first</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_grec</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">first</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	 <span class="cm">/* truncate these */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgr</span><span class="p">)</span>
				<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">scount</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">igmpv3_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">igmpv3_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grhead</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgr</span><span class="p">);</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">psrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
		<span class="o">*</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">;</span>
		<span class="n">scount</span><span class="o">++</span><span class="p">;</span> <span class="n">stotal</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_ALLOW_NEW_SOURCES</span> <span class="o">||</span>
		     <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sdeleted</span> <span class="o">||</span> <span class="n">gdeleted</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
					<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">psf_list</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">empty_source:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stotal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_ALLOW_NEW_SOURCES</span> <span class="o">||</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">||</span> <span class="n">isquery</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* make sure we have room for group header */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_grec</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">igmpv3_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* add_grhead will get a new one */</span>
			<span class="p">}</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grhead</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pgr</span><span class="p">)</span>
		<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">scount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isquery</span><span class="p">)</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* clear query state on report */</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmpv3_send_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_MODE_IS_EXCLUDE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_MODE_IS_INCLUDE</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_MODE_IS_EXCLUDE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_MODE_IS_INCLUDE</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">igmpv3_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove zero-count source records from a source filter list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmpv3_clear_zeros</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">**</span><span class="n">ppsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">,</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=*</span><span class="n">ppsf</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
				<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">ppsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmpv3_send_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">dtype</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>

	<span class="cm">/* deleted MCA&#39;s */</span>
	<span class="n">pmc_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmc_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_CHANGE_TO_INCLUDE</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">igmpv3_clear_zeros</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">);</span>
				<span class="n">igmpv3_clear_zeros</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc_prev</span><span class="p">)</span>
				<span class="n">pmc_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pmc_next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc_next</span><span class="p">;</span>
			<span class="n">in_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pmc_prev</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>

	<span class="cm">/* change recs */</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">IGMPV3_ALLOW_NEW_SOURCES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_ALLOW_NEW_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">IGMPV3_BLOCK_OLD_SOURCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* deleted sources */</span>

		<span class="cm">/* filter mode changes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_CHANGE_TO_EXCLUDE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_CHANGE_TO_INCLUDE</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">igmpv3_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_send_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmphdr</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__be32</span>	<span class="n">group</span> <span class="o">=</span> <span class="n">pmc</span> <span class="o">?</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">tlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IGMPV3_HOST_MEMBERSHIP_REPORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">igmpv3_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IGMP_HOST_LEAVE_MESSAGE</span><span class="p">)</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">IGMP_ALL_ROUTER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_ports</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">IPPROTO_IGMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">IGMP_SIZE</span> <span class="o">+</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span>      <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span>      <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">IP_DF</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span>    <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span>    <span class="o">=</span> <span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_IGMP</span><span class="p">;</span>
	<span class="n">ip_select_ident</span><span class="p">(</span><span class="n">iph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iph</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPOPT_RA</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iph</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iph</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iph</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ih</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">igmphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmphdr</span><span class="p">));</span>
	<span class="n">ih</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">ih</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ih</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ih</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">ih</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">ip_compute_csum</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ih</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmphdr</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ip_local_out</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_gq_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">igmpv3_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_ifc_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">igmpv3_send_cr</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">igmp_ifc_start_timer</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">IGMP_Unsolicited_Report_Interval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_ifc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
		<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
	<span class="n">igmp_ifc_start_timer</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">unsolicit_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">unsolicit_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">igmp_start_timer</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">IGMP_Unsolicited_Report_Interval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">reporter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="n">igmp_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">IGMP_HOST_MEMBERSHIP_REPORT</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="n">igmp_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">IGMPV2_HOST_MEMBERSHIP_REPORT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">igmp_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">IGMPV3_HOST_MEMBERSHIP_REPORT</span><span class="p">);</span>

	<span class="n">ip_ma_put</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mark EXCLUDE-mode sources */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_xmarksources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsrcs</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">srcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">scount</span><span class="p">;</span>

	<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nsrcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip inactive filters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span>
			    <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>	<span class="cm">/* all sources excluded */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_marksources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsrcs</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">srcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">scount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">igmp_xmarksources</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">nsrcs</span><span class="p">,</span> <span class="n">srcs</span><span class="p">);</span>

	<span class="cm">/* mark INCLUDE-mode sources */</span>
	<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nsrcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_heard_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>

	<span class="cm">/* Timers are only set for non-local groups */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">group</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">igmp_stop_timer</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_heard_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmphdr</span> 		<span class="o">*</span><span class="n">ih</span> <span class="o">=</span> <span class="n">igmp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">igmpv3_query</span> <span class="o">*</span><span class="n">ih3</span> <span class="o">=</span> <span class="n">igmpv3_query_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span>	<span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">group</span> <span class="o">=</span> <span class="n">ih</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">max_delay</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Alas, old v1 router presents here. */</span>

			<span class="n">max_delay</span> <span class="o">=</span> <span class="n">IGMP_Query_Response_Interval</span><span class="p">;</span>
			<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_v1_seen</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">IGMP_V1_Router_Present_Timeout</span><span class="p">;</span>
			<span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* v2 router present */</span>
			<span class="n">max_delay</span> <span class="o">=</span> <span class="n">ih</span><span class="o">-&gt;</span><span class="n">code</span><span class="o">*</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="n">IGMP_TIMER_SCALE</span><span class="p">);</span>
			<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_v2_seen</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">IGMP_V2_Router_Present_Timeout</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* cancel the interface change timer */</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_timer</span><span class="p">))</span>
			<span class="n">__in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
		<span class="cm">/* clear deleted report items */</span>
		<span class="n">igmpv3_clear_delrec</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* ignore bogus packet; freed by caller */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This is a v3 query with v1 queriers present */</span>
		<span class="n">max_delay</span> <span class="o">=</span> <span class="n">IGMP_Query_Response_Interval</span><span class="p">;</span>
		<span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this is a v3 query with v2 queriers present;</span>
<span class="cm">		 * Interpretation of the max_delay code is problematic here.</span>
<span class="cm">		 * A real v2 host would use ih_code directly, while v3 has a</span>
<span class="cm">		 * different encoding. We use the v3 encoding as more likely</span>
<span class="cm">		 * to be intended in a v3 query.</span>
<span class="cm">		 */</span>
		<span class="n">max_delay</span> <span class="o">=</span> <span class="n">IGMPV3_MRC</span><span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="n">IGMP_TIMER_SCALE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_delay</span><span class="p">)</span>
			<span class="n">max_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* can&#39;t mod w/ 0 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* v3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_query</span><span class="p">)))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ih3</span> <span class="o">=</span> <span class="n">igmpv3_query_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">nsrcs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmpv3_query</span><span class="p">)</span>
					   <span class="o">+</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">nsrcs</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">)))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">ih3</span> <span class="o">=</span> <span class="n">igmpv3_query_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">max_delay</span> <span class="o">=</span> <span class="n">IGMPV3_MRC</span><span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="n">IGMP_TIMER_SCALE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_delay</span><span class="p">)</span>
			<span class="n">max_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* can&#39;t mod w/ 0 */</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_maxdelay</span> <span class="o">=</span> <span class="n">max_delay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">qrv</span><span class="p">)</span>
			<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">=</span> <span class="n">ih3</span><span class="o">-&gt;</span><span class="n">qrv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* general query */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">nsrcs</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>	<span class="cm">/* no sources allowed */</span>
			<span class="n">igmp_gq_start_timer</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* mark sources to include, if group &amp; source-specific */</span>
		<span class="n">mark</span> <span class="o">=</span> <span class="n">ih3</span><span class="o">-&gt;</span><span class="n">nsrcs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * - Start the timers in all of our membership records</span>
<span class="cm">	 *   that the query applies to for the interface on</span>
<span class="cm">	 *   which the query arrived excl. those that belong</span>
<span class="cm">	 *   to a &quot;local&quot; group (224.0.0.X)</span>
<span class="cm">	 * - For timers already running check if they need to</span>
<span class="cm">	 *   be reset.</span>
<span class="cm">	 * - Use the igmp-&gt;igmp_code field as the maximum</span>
<span class="cm">	 *   delay possible</span>
<span class="cm">	 */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">!=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span><span class="p">)</span>
			<span class="n">im</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">&amp;&amp;</span> <span class="n">mark</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">im</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">=</span> <span class="n">mark</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="o">!</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">gsquery</span> <span class="o">||</span>
			<span class="n">igmp_marksources</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ih3</span><span class="o">-&gt;</span><span class="n">nsrcs</span><span class="p">),</span> <span class="n">ih3</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">igmp_mod_timer</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* called in rcu_read_lock() section */</span>
<span class="kt">int</span> <span class="nf">igmp_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This basically follows the spec line by line -- see RFC1112 */</span>
	<span class="k">struct</span> <span class="n">igmphdr</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmphdr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHECKSUM_COMPLETE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csum_fold</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">CHECKSUM_NONE</span>:
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__skb_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ih</span> <span class="o">=</span> <span class="n">igmp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IGMP_HOST_MEMBERSHIP_QUERY</span>:
		<span class="n">igmp_heard_query</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IGMP_HOST_MEMBERSHIP_REPORT</span>:
	<span class="k">case</span> <span class="n">IGMPV2_HOST_MEMBERSHIP_REPORT</span>:
		<span class="cm">/* Is it our report looped back? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* don&#39;t rely on MC router hearing unicast reports */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_MULTICAST</span> <span class="o">||</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_BROADCAST</span><span class="p">)</span>
			<span class="n">igmp_heard_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">ih</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IGMP_PIM</span>:
<span class="cp">#ifdef CONFIG_IP_PIMSM_V1</span>
		<span class="k">return</span> <span class="n">pim_rcv_v1</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">IGMPV3_HOST_MEMBERSHIP_REPORT</span>:
	<span class="k">case</span> <span class="n">IGMP_DVMRP</span>:
	<span class="k">case</span> <span class="n">IGMP_TRACE</span>:
	<span class="k">case</span> <span class="n">IGMP_HOST_LEAVE_MESSAGE</span>:
	<span class="k">case</span> <span class="n">IGMP_MTRACE</span>:
	<span class="k">case</span> <span class="n">IGMP_MTRACE_RESP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> *	Add a filter to a device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_mc_filter_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Checking for IFF_MULTICAST here is WRONG-WRONG-WRONG.</span>
<span class="cm">	   We will get multicast token leakage, when IFF_MULTICAST</span>
<span class="cm">	   is changed. This check should be done in ndo_set_rx_mode</span>
<span class="cm">	   routine. Something sort of:</span>
<span class="cm">	   if (dev-&gt;mc_list &amp;&amp; dev-&gt;flags&amp;IFF_MULTICAST) { do it; }</span>
<span class="cm">	   --ANK</span>
<span class="cm">	   */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arp_mc_map</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_mc_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Remove a filter from a device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_mc_filter_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arp_mc_map</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_mc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
<span class="cm">/*</span>
<span class="cm"> * deleted ip_mc_list manipulation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmpv3_add_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="cm">/* this is an &quot;ip_mc_list&quot; for convenience; only the fields below</span>
<span class="cm">	 * are actually used. In particular, the refcnt and users are not</span>
<span class="cm">	 * used for management of the delete list. Using the same structure</span>
<span class="cm">	 * for deleted items allows change reports to use common code with</span>
<span class="cm">	 * non-deleted or query-response MCA&#39;s.</span>
<span class="cm">	 */</span>
	<span class="n">pmc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
		<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmpv3_del_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">multiaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
	<span class="n">pmc_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">multiaddr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pmc_prev</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc_prev</span><span class="p">)</span>
			<span class="n">pmc_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">in_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmpv3_clear_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">nextpmc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
	<span class="n">pmc</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span> <span class="o">=</span> <span class="n">nextpmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpmc</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">ip_mc_clear_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
		<span class="n">in_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* clear dead sources, too */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_group_dropped</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="kt">int</span> <span class="n">reporter</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ip_mc_filter_del</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reporter</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">reporter</span><span class="p">;</span>
	<span class="n">igmp_stop_timer</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reporter</span><span class="p">)</span>
				<span class="n">igmp_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">IGMP_HOST_LEAVE_MESSAGE</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* IGMPv3 */</span>
		<span class="n">igmpv3_add_delrec</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">);</span>

		<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_group_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ip_mc_filter_add</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">igmp_start_timer</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">IGMP_Initial_Report_Delay</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else, v3 */</span>

	<span class="n">im</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
		<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
	<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Multicast list managers</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> *	A socket has joined a multicast group on device dev.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_mc_inc_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">im</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ip_mc_add_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">MCAST_EXCLUDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">im</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">im</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">im</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">im</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">in_dev</span><span class="p">;</span>
	<span class="n">in_dev_hold</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="cm">/* initial mode is (EX, empty) */</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp_timer_expire</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">im</span><span class="p">);</span>
	<span class="n">im</span><span class="o">-&gt;</span><span class="n">unsolicit_count</span> <span class="o">=</span> <span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">im</span><span class="o">-&gt;</span><span class="n">next_rcu</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">,</span> <span class="n">im</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">igmpv3_del_delrec</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">igmp_group_added</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="n">ip_rt_multicast_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_mc_inc_group</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Resend IGMP JOIN report; used for bonding.</span>
<span class="cm"> *	Called with rcu_read_lock()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ip_mc_rejoin_groups</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* a failover is happening and switches</span>
<span class="cm">		 * must be notified immediately</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMP_HOST_MEMBERSHIP_REPORT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV2_HOST_MEMBERSHIP_REPORT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IGMPV3_HOST_MEMBERSHIP_REPORT</span><span class="p">;</span>
		<span class="n">igmp_send_report</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_mc_rejoin_groups</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	A socket has left a multicast group on device dev</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_mc_dec_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">ip</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">;</span>
				<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">igmp_group_dropped</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
				<span class="n">ip_mc_clear_src</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
					<span class="n">ip_rt_multicast_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

				<span class="n">ip_ma_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_mc_dec_group</span><span class="p">);</span>

<span class="cm">/* Device changing type */</span>

<span class="kt">void</span> <span class="nf">ip_mc_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span>
		<span class="n">igmp_group_dropped</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ip_mc_remap</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span>
		<span class="n">igmp_group_added</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Device going down */</span>

<span class="kt">void</span> <span class="nf">ip_mc_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span>
		<span class="n">igmp_group_dropped</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_timer</span><span class="p">))</span>
		<span class="n">__in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_timer</span><span class="p">))</span>
		<span class="n">__in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">igmpv3_clear_delrec</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ip_mc_dec_group</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ip_mc_init_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_gq_timer</span><span class="p">,</span> <span class="n">igmp_gq_timer_expire</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_count</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_timer</span><span class="p">,</span> <span class="n">igmp_ifc_timer_expire</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">=</span> <span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_tomb_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Device going up */</span>

<span class="kt">void</span> <span class="nf">ip_mc_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">ip_mc_inc_group</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">IGMP_ALL_HOSTS</span><span class="p">);</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span>
		<span class="n">igmp_group_added</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Device is about to be destroyed: clean up.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_mc_destroy_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="cm">/* Deactivate timers */</span>
	<span class="n">ip_mc_down</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">;</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_count</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* We&#39;ve dropped the groups in ip_mc_down already */</span>
		<span class="n">ip_mc_clear_src</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">ip_ma_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* RTNL is locked */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="nf">ip_mc_find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mreqn</span> <span class="o">*</span><span class="n">imr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_ifindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idev</span> <span class="o">=</span> <span class="n">inetdev_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_ifindex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">idev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">__ip_dev_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output</span><span class="p">(</span><span class="n">net</span><span class="p">,</span>
						    <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">idev</span> <span class="o">=</span> <span class="n">__in_dev_get_rtnl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">idev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Join a socket to a group</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">sysctl_igmp_max_memberships</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">IP_MAX_MEMBERSHIPS</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_igmp_max_msf</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">IP_MAX_MSF</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mc_del1_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">==</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span> <span class="o">||</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* source filter not found, or count wrong =&gt;  bug */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip_rt_multicast_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* no more filters for this source */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
			<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
				<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_IP_MULTICAST</span>
<span class="cp">#define igmp_ifc_event(x)	do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mc_del_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">changerec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pmca</span> <span class="o">==</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MCA not found?? bug */</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">sf_markstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sfcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">ip_mc_del1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">changerec</span> <span class="o">|=</span> <span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* filter mode change */</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_INCLUDE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
			<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sf_setstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="o">||</span> <span class="n">changerec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add multicast single-source filter to the interface list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mc_add1_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">==</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip_rt_multicast_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sf_markstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mca_xcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">=</span> <span class="n">mca_xcount</span> <span class="o">==</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf_setstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">dpsf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mca_xcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">qrv</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">mr_qrv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_in</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_in</span> <span class="o">=</span> <span class="n">mca_xcount</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">new_in</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span> <span class="n">dpsf</span><span class="p">;</span> <span class="n">dpsf</span><span class="o">=</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">prev</span> <span class="o">=</span> <span class="n">dpsf</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dpsf</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
						<span class="n">prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">dpsf</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">qrv</span><span class="p">;</span>
				<span class="n">rv</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * add or update &quot;delete&quot; records if an active filter</span>
<span class="cm">			 * is now inactive</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span> <span class="n">dpsf</span><span class="p">;</span> <span class="n">dpsf</span><span class="o">=</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpsf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dpsf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dpsf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpsf</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dpsf</span> <span class="o">=</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
				<span class="cm">/* pmc-&gt;lock held by callers */</span>
				<span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span>
				<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="n">dpsf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">qrv</span><span class="p">;</span>
			<span class="n">rv</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Add multicast source filter list to the interface list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mc_add_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">isexclude</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pmca</span> <span class="o">==</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MCA not found?? bug */</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">sf_markstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">isexclude</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sfcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip_mc_add1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_del1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isexclude</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* filter mode change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_INCLUDE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="cm">/* else no filters; keep old mode for reports */</span>

		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">?</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_qrv</span> <span class="o">:</span>
			<span class="n">IGMP_Unsolicited_Report_Count</span><span class="p">;</span>
		<span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mr_ifc_count</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">crcount</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sf_setstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">igmp_ifc_event</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_mc_clear_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">nextpsf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">nextpsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">nextpsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Join a multicast group</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ip_mc_join_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mreqn</span> <span class="o">*</span><span class="n">imr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">iml</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">ip_mc_find_dev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">imr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iml</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="n">ifindex</span> <span class="o">=</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_ifindex</span><span class="p">;</span>
	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">ifindex</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">sysctl_igmp_max_memberships</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">iml</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iml</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">,</span> <span class="n">imr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">imr</span><span class="p">));</span>
	<span class="n">iml</span><span class="o">-&gt;</span><span class="n">next_rcu</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">,</span> <span class="n">iml</span><span class="p">);</span>
	<span class="n">ip_mc_inc_group</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_mc_join_group</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mc_leave_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">iml</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* any-source empty exclude case */</span>
		<span class="k">return</span> <span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* decrease mem now to avoid the memleak warning */</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
	<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Ask a socket to leave a group.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ip_mc_leave_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mreqn</span> <span class="o">*</span><span class="n">imr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">iml</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">imlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">group</span> <span class="o">=</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">ip_mc_find_dev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">imr</span><span class="p">);</span>
	<span class="n">ifindex</span> <span class="o">=</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_ifindex</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">imlp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">iml</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="o">*</span><span class="n">imlp</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">imlp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">group</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">!=</span> <span class="n">ifindex</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">&amp;&amp;</span> <span class="n">imr</span><span class="o">-&gt;</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span>
				<span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">iml</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>

		<span class="o">*</span><span class="n">imlp</span> <span class="o">=</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="n">ip_mc_dec_group</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="cm">/* decrease mem now to avoid the memleak warning */</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">iml</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_mc_source</span><span class="p">(</span><span class="kt">int</span> <span class="n">add</span><span class="p">,</span> <span class="kt">int</span> <span class="n">omode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span>
	<span class="n">ip_mreq_source</span> <span class="o">*</span><span class="n">mreqs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mreqn</span> <span class="n">imr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">imr</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_interface</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">=</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">ip_mc_find_dev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span>
		     <span class="n">imr</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* must have a prior join */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if a source filter was set, must be the same mode as before */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">!=</span> <span class="n">omode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">!=</span> <span class="n">omode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allow mode switches for empty-set filters */</span>
		<span class="n">ip_mc_add_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">omode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psl</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* err = -EADDRNOTAVAIL */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_sourceaddr</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>		<span class="cm">/* source not found */</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* err = -EADDRNOTAVAIL */</span>

		<span class="cm">/* special case - (INCLUDE, empty) == LEAVE_GROUP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">omode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update the interface filter */</span>
		<span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_sourceaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else, add a new source to the filter */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psl</span> <span class="o">&amp;&amp;</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">&gt;=</span> <span class="n">sysctl_igmp_max_msf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span> <span class="o">||</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">==</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">newpsl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">IP_SFBLOCK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">;</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpsl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">IP_SFBLOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* decrease mem now to avoid the memleak warning */</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
			<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">psl</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">,</span> <span class="n">newpsl</span><span class="p">);</span>
		<span class="n">psl</span> <span class="o">=</span> <span class="n">newpsl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* &gt; 0 for insert logic below if sl_count is 0 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_sourceaddr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* address already there is an error */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_sourceaddr</span><span class="p">;</span>
	<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* update the interface list */</span>
	<span class="n">ip_mc_add_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_multiaddr</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mreqs</span><span class="o">-&gt;</span><span class="n">imr_sourceaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leavegroup</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ip_mc_leave_group</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_mc_msfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_msfilter</span> <span class="o">*</span><span class="n">msf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mreqn</span>	<span class="n">imr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">newpsl</span><span class="p">,</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span> <span class="o">!=</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span> <span class="o">!=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">imr</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_interface</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">=</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">ip_mc_find_dev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* special case - (INCLUDE, empty) == LEAVE_GROUP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* must have a prior join */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span><span class="p">),</span>
							   <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpsl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span> <span class="o">=</span> <span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_slist</span><span class="p">,</span>
			<span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_slist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip_mc_add_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">,</span>
			<span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span><span class="p">,</span> <span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">newpsl</span><span class="p">,</span> <span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_add_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">,</span>
				     <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span>
			<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* decrease mem now to avoid the memleak warning */</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">IP_SFLSIZE</span><span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">psl</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_del_src</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">,</span> <span class="n">newpsl</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leavegroup</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip_mc_leave_group</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_mc_msfget</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_msfilter</span> <span class="o">*</span><span class="n">msf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ip_msfilter</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">copycount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mreqn</span>	<span class="n">imr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">imr</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_address</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_interface</span><span class="p">;</span>
	<span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">ip_mc_find_dev</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_multiaddr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">imr</span><span class="p">.</span><span class="n">imr_ifindex</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>		<span class="cm">/* must have a prior join */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_fmode</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">;</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">copycount</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">copycount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">msf</span><span class="o">-&gt;</span><span class="n">imsf_numsrc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">IP_MSFILTER_SIZE</span><span class="p">(</span><span class="n">copycount</span><span class="p">),</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">msf</span><span class="p">,</span> <span class="n">IP_MSFILTER_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">optval</span><span class="o">-&gt;</span><span class="n">imsf_slist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_mc_gsfget</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">group_filter</span> <span class="o">*</span><span class="n">gsf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">group_filter</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">copycount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">psin</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>

	<span class="n">psin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_group</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">psin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">for_each_pmc_rtnl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>		<span class="cm">/* must have a prior join */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">;</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">psl</span> <span class="o">?</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">copycount</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span><span class="p">;</span>
	<span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">GROUP_FILTER_SIZE</span><span class="p">(</span><span class="n">copycount</span><span class="p">),</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">gsf</span><span class="p">,</span> <span class="n">GROUP_FILTER_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">copycount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">ss</span><span class="p">;</span>

		<span class="n">psin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">));</span>
		<span class="n">psin</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="n">psin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">optval</span><span class="o">-&gt;</span><span class="n">gf_slist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check if a multicast source filter allows delivery for a given &lt;src,dst,intf&gt;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ip_mc_sf_allow</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">loc_addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">rmt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">loc_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">loc_addr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span> <span class="o">==</span> <span class="n">dif</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_all</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rmt_addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	A socket is closing.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_mc_drop_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_sock</span> <span class="o">*</span><span class="n">inet</span> <span class="o">=</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_mc_socklist</span> <span class="o">*</span><span class="n">iml</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">iml</span> <span class="o">=</span> <span class="n">rtnl_dereference</span><span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

		<span class="n">inet</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">=</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">;</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">inetdev_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_ifindex</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">iml</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ip_mc_dec_group</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">multi</span><span class="p">.</span><span class="n">imr_multiaddr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
		<span class="cm">/* decrease mem now to avoid the memleak warning */</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">iml</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* called with rcu_read_lock() */</span>
<span class="kt">int</span> <span class="nf">ip_check_mc_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">mc_addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span> <span class="o">==</span> <span class="n">mc_addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">im</span> <span class="o">&amp;&amp;</span> <span class="n">proto</span> <span class="o">==</span> <span class="n">IPPROTO_IGMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span> <span class="o">==</span> <span class="n">src_addr</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">||</span>
					<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span>
					<span class="n">im</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* unspecified source; tentatively allow */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PROC_FS)</span>
<span class="k">struct</span> <span class="n">igmp_mc_iter_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	igmp_mc_seq_private(seq)	((struct igmp_mc_iter_state *)(seq)-&gt;private)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="nf">igmp_mc_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">in_dev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="nf">igmp_mc_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">im</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">next_net_device_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="nf">igmp_mc_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="n">igmp_mc_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">im</span> <span class="o">=</span> <span class="n">igmp_mc_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">im</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp_mc_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">igmp_mc_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp_mc_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">igmp_mc_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">igmp_mc_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_mc_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_mc_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			 <span class="s">&quot;Idx</span><span class="se">\t</span><span class="s">Device    : Count Querier</span><span class="se">\t</span><span class="s">Group    Users Timer</span><span class="se">\t</span><span class="s">Reporter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">igmp_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
		<span class="kt">char</span>   <span class="o">*</span><span class="n">querier</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
		<span class="n">querier</span> <span class="o">=</span> <span class="n">IGMP_V1_SEEN</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;V1&quot;</span> <span class="o">:</span>
			  <span class="n">IGMP_V2_SEEN</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;V2&quot;</span> <span class="o">:</span>
			  <span class="s">&quot;V3&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">querier</span> <span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">im</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\t</span><span class="s">%-10s: %5d %7s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">mc_count</span><span class="p">,</span> <span class="n">querier</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;</span><span class="se">\t\t\t\t</span><span class="s">%08X %5d %d:%08lX</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">,</span>
			   <span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">tm_running</span> <span class="o">?</span>
			   <span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">im</span><span class="o">-&gt;</span><span class="n">reporter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">igmp_mc_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span>	<span class="n">igmp_mc_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span>	<span class="n">igmp_mc_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span>	<span class="n">igmp_mc_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span>	<span class="n">igmp_mc_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_mc_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp_mc_seq_ops</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmp_mc_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">igmp_mc_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">igmp_mc_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span>	<span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span>	<span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span>	<span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define igmp_mcf_seq_private(seq)	((struct igmp_mcf_iter_state *)(seq)-&gt;private)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="nf">igmp_mcf_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
		<span class="n">idev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">im</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">psf</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">psf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="nf">igmp_mcf_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">next_net_device_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">sources</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="nf">igmp_mcf_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="n">igmp_mcf_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psf</span> <span class="o">=</span> <span class="n">igmp_mcf_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">psf</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp_mcf_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">igmp_mcf_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp_mcf_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">igmp_mcf_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">igmp_mcf_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp_mcf_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">rcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_mcf_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip_sf_list</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;%3s %6s &quot;</span>
			   <span class="s">&quot;%10s %10s %6s %6s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Idx&quot;</span><span class="p">,</span>
			   <span class="s">&quot;Device&quot;</span><span class="p">,</span> <span class="s">&quot;MCA&quot;</span><span class="p">,</span>
			   <span class="s">&quot;SRC&quot;</span><span class="p">,</span> <span class="s">&quot;INC&quot;</span><span class="p">,</span> <span class="s">&quot;EXC&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;%3d %6.6s 0x%08x &quot;</span>
			   <span class="s">&quot;0x%08x %6lu %6lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">ntohl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">),</span>
			   <span class="n">ntohl</span><span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_inaddr</span><span class="p">),</span>
			   <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">],</span>
			   <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">igmp_mcf_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span>	<span class="n">igmp_mcf_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span>	<span class="n">igmp_mcf_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span>	<span class="n">igmp_mcf_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span>	<span class="n">igmp_mcf_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp_mcf_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp_mcf_seq_ops</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmp_mcf_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">igmp_mcf_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">igmp_mcf_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span>	<span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span>	<span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span>	<span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">igmp_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>

	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp_mc_seq_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_igmp</span><span class="p">;</span>
	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;mcfilter&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp_mcf_seq_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mcfilter</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_mcfilter:</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp&quot;</span><span class="p">);</span>
<span class="nl">out_igmp:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">igmp_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;mcfilter&quot;</span><span class="p">);</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">igmp_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">igmp_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">igmp_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">igmp_mc_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">igmp_net_ops</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
