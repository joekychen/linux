<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * INET		An implementation of the TCP/IP protocol suite for the LINUX</span>
<span class="cm"> *		operating system.  INET is implemented using the  BSD Socket</span>
<span class="cm"> *		interface as the means of communication with the user level.</span>
<span class="cm"> *</span>
<span class="cm"> *		This file implements the various access functions for the</span>
<span class="cm"> *		PROC file system.  It is mainly used for debugging and</span>
<span class="cm"> *		statistics.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;</span>
<span class="cm"> *		Gerald J. Heim, &lt;heim@peanuts.informatik.uni-tuebingen.de&gt;</span>
<span class="cm"> *		Fred Baumgarten, &lt;dc6iq@insu1.etec.uni-karlsruhe.de&gt;</span>
<span class="cm"> *		Erik Schoenfelder, &lt;schoenfr@ibr.cs.tu-bs.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes:</span>
<span class="cm"> *		Alan Cox	:	UDP sockets show the rxqueue/txqueue</span>
<span class="cm"> *					using hint flag for the netinfo.</span>
<span class="cm"> *	Pauline Middelink	:	identd support</span>
<span class="cm"> *		Alan Cox	:	Make /proc safer.</span>
<span class="cm"> *	Erik Schoenfelder	:	/proc/net/snmp</span>
<span class="cm"> *		Alan Cox	:	Handle dead sockets properly.</span>
<span class="cm"> *	Gerhard Koerting	:	Show both timers</span>
<span class="cm"> *		Alan Cox	:	Allow inode to be NULL (kernel socket)</span>
<span class="cm"> *	Andi Kleen		:	Add support for open_requests and</span>
<span class="cm"> *					split functions for more readibility.</span>
<span class="cm"> *	Andi Kleen		:	Add support for /proc/net/netstat</span>
<span class="cm"> *	Arnaldo C. Melo		:	Convert to seq_file</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/icmp.h&gt;</span>
<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/udp.h&gt;</span>
<span class="cp">#include &lt;net/udplite.h&gt;</span>
<span class="cp">#include &lt;linux/bottom_half.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/raw.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> *	Report socket allocation statistics [mea@utu.fi]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sockstat_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orphans</span><span class="p">,</span> <span class="n">sockets</span><span class="p">;</span>

	<span class="n">local_bh_disable</span><span class="p">();</span>
	<span class="n">orphans</span> <span class="o">=</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_orphan_count</span><span class="p">);</span>
	<span class="n">sockets</span> <span class="o">=</span> <span class="n">proto_sockets_allocated_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_prot</span><span class="p">);</span>
	<span class="n">local_bh_enable</span><span class="p">();</span>

	<span class="n">socket_seq_show</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;TCP: inuse %d orphan %d tw %d alloc %d mem %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sock_prot_inuse_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp_prot</span><span class="p">),</span> <span class="n">orphans</span><span class="p">,</span>
		   <span class="n">tcp_death_row</span><span class="p">.</span><span class="n">tw_count</span><span class="p">,</span> <span class="n">sockets</span><span class="p">,</span>
		   <span class="n">proto_memory_allocated</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_prot</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;UDP: inuse %d mem %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sock_prot_inuse_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udp_prot</span><span class="p">),</span>
		   <span class="n">proto_memory_allocated</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udp_prot</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;UDPLITE: inuse %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sock_prot_inuse_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udplite_prot</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RAW: inuse %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sock_prot_inuse_get</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw_prot</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>  <span class="s">&quot;FRAG: inuse %d memory %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ip_frag_nqueues</span><span class="p">(</span><span class="n">net</span><span class="p">),</span> <span class="n">ip_frag_mem</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sockstat_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">sockstat_seq_show</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sockstat_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">sockstat_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* snmp items */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_mib</span> <span class="n">snmp4_ipstats_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InReceives&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InHdrErrors&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INHDRERRORS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InAddrErrors&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INADDRERRORS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ForwDatagrams&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTFORWDATAGRAMS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InUnknownProtos&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INUNKNOWNPROTOS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InDiscards&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDISCARDS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InDelivers&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDELIVERS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutRequests&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutDiscards&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTDISCARDS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutNoRoutes&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTNOROUTES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ReasmTimeout&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_REASMTIMEOUT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ReasmReqds&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_REASMREQDS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ReasmOKs&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_REASMOKS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ReasmFails&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_REASMFAILS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;FragOKs&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_FRAGOKS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;FragFails&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_FRAGFAILS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;FragCreates&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_FRAGCREATES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_SENTINEL</span>
<span class="p">};</span>

<span class="cm">/* Following RFC4293 items are displayed in /proc/net/netstat */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_mib</span> <span class="n">snmp4_ipextstats_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InNoRoutes&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INNOROUTES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InTruncatedPkts&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INTRUNCATEDPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InMcastPkts&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INMCASTPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutMcastPkts&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTMCASTPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InBcastPkts&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INBCASTPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutBcastPkts&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTBCASTPKTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InMcastOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INMCASTOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutMcastOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTMCASTOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InBcastOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INBCASTOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutBcastOctets&quot;</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTBCASTOCTETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_SENTINEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span> <span class="n">icmpmibmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DestUnreachs&quot;</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TimeExcds&quot;</span><span class="p">,</span> <span class="n">ICMP_TIME_EXCEEDED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ParmProbs&quot;</span><span class="p">,</span> <span class="n">ICMP_PARAMETERPROB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SrcQuenchs&quot;</span><span class="p">,</span> <span class="n">ICMP_SOURCE_QUENCH</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Redirects&quot;</span><span class="p">,</span> <span class="n">ICMP_REDIRECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Echos&quot;</span><span class="p">,</span> <span class="n">ICMP_ECHO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;EchoReps&quot;</span><span class="p">,</span> <span class="n">ICMP_ECHOREPLY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Timestamps&quot;</span><span class="p">,</span> <span class="n">ICMP_TIMESTAMP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TimestampReps&quot;</span><span class="p">,</span> <span class="n">ICMP_TIMESTAMPREPLY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AddrMasks&quot;</span><span class="p">,</span> <span class="n">ICMP_ADDRESS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;AddrMaskReps&quot;</span><span class="p">,</span> <span class="n">ICMP_ADDRESSREPLY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_mib</span> <span class="n">snmp4_tcp_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RtoAlgorithm&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_RTOALGORITHM</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RtoMin&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_RTOMIN</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RtoMax&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_RTOMAX</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;MaxConn&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_MAXCONN</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ActiveOpens&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_ACTIVEOPENS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;PassiveOpens&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_PASSIVEOPENS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;AttemptFails&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_ATTEMPTFAILS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;EstabResets&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_ESTABRESETS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;CurrEstab&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_CURRESTAB</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InSegs&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_INSEGS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutSegs&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_OUTSEGS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RetransSegs&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_RETRANSSEGS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InErrs&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_INERRS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutRsts&quot;</span><span class="p">,</span> <span class="n">TCP_MIB_OUTRSTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_SENTINEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_mib</span> <span class="n">snmp4_udp_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InDatagrams&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_INDATAGRAMS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;NoPorts&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_NOPORTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;InErrors&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_INERRORS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutDatagrams&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_OUTDATAGRAMS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RcvbufErrors&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_RCVBUFERRORS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;SndbufErrors&quot;</span><span class="p">,</span> <span class="n">UDP_MIB_SNDBUFERRORS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_SENTINEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snmp_mib</span> <span class="n">snmp4_net_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;SyncookiesSent&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SYNCOOKIESSENT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;SyncookiesRecv&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SYNCOOKIESRECV</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;SyncookiesFailed&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SYNCOOKIESFAILED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;EmbryonicRsts&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_EMBRYONICRSTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;PruneCalled&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_PRUNECALLED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;RcvPruned&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_RCVPRUNED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OfoPruned&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_OFOPRUNED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;OutOfWindowIcmps&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_OUTOFWINDOWICMPS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;LockDroppedIcmps&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_LOCKDROPPEDICMPS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ArpFilter&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_ARPFILTER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TW&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TIMEWAITED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TWRecycled&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TIMEWAITRECYCLED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TWKilled&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TIMEWAITKILLED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;PAWSPassive&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_PAWSPASSIVEREJECTED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;PAWSActive&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_PAWSACTIVEREJECTED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;PAWSEstab&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_PAWSESTABREJECTED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;DelayedACKs&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_DELAYEDACKS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;DelayedACKLocked&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_DELAYEDACKLOCKED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;DelayedACKLost&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_DELAYEDACKLOST</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ListenOverflows&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_LISTENOVERFLOWS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;ListenDrops&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_LISTENDROPS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPPrequeued&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPPREQUEUED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDirectCopyFromBacklog&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDIRECTCOPYFROMBACKLOG</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDirectCopyFromPrequeue&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDIRECTCOPYFROMPREQUEUE</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPPrequeueDropped&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPPREQUEUEDROPPED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPHPHits&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPHPHITS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPHPHitsToUser&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPHPHITSTOUSER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPPureAcks&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPPUREACKS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPHPAcks&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPHPACKS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRenoRecovery&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRENORECOVERY</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackRecovery&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKRECOVERY</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSACKReneging&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKRENEGING</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPFACKReorder&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPFACKREORDER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSACKReorder&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKREORDER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRenoReorder&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRENOREORDER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPTSReorder&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPTSREORDER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPFullUndo&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPFULLUNDO</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPPartialUndo&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPPARTIALUNDO</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKUndo&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKUNDO</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPLossUndo&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPLOSSUNDO</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPLostRetransmit&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPLOSTRETRANSMIT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRenoFailures&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRENOFAILURES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackFailures&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKFAILURES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPLossFailures&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPLOSSFAILURES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPFastRetrans&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPFASTRETRANS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPForwardRetrans&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPFORWARDRETRANS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSlowStartRetrans&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSLOWSTARTRETRANS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPTimeouts&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPTIMEOUTS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRenoRecoveryFail&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRENORECOVERYFAIL</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackRecoveryFail&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKRECOVERYFAIL</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSchedulerFailed&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSCHEDULERFAILED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRcvCollapsed&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRCVCOLLAPSED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKOldSent&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKOLDSENT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKOfoSent&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKOFOSENT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKRecv&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKRECV</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKOfoRecv&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKOFORECV</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnSyn&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONSYN</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnData&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONDATA</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnClose&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONCLOSE</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnMemory&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONMEMORY</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnTimeout&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONTIMEOUT</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortOnLinger&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTONLINGER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPAbortFailed&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPABORTFAILED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPMemoryPressures&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMEMORYPRESSURES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSACKDiscard&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSACKDISCARD</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKIgnoredOld&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKIGNOREDOLD</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDSACKIgnoredNoUndo&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDSACKIGNOREDNOUNDO</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSpuriousRTOs&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPSPURIOUSRTOS</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPMD5NotFound&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMD5NOTFOUND</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPMD5Unexpected&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMD5UNEXPECTED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackShifted&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SACKSHIFTED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackMerged&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SACKMERGED</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPSackShiftFallback&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_SACKSHIFTFALLBACK</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPBacklogDrop&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPBACKLOGDROP</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPMinTTLDrop&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPMINTTLDROP</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPDeferAcceptDrop&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPDEFERACCEPTDROP</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;IPReversePathFilter&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_IPRPFILTER</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPTimeWaitOverflow&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPTIMEWAITOVERFLOW</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPReqQFullDoCookies&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPREQQFULLDOCOOKIES</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPReqQFullDrop&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPREQQFULLDROP</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRetransFail&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRETRANSFAIL</span><span class="p">),</span>
	<span class="n">SNMP_MIB_ITEM</span><span class="p">(</span><span class="s">&quot;TCPRcvCoalesce&quot;</span><span class="p">,</span> <span class="n">LINUX_MIB_TCPRCVCOALESCE</span><span class="p">),</span>
	<span class="n">SNMP_MIB_SENTINEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">icmpmsg_put_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IcmpMsg:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %sType%u&quot;</span><span class="p">,</span>
				<span class="n">type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x100</span> <span class="o">?</span> <span class="s">&quot;Out&quot;</span> <span class="o">:</span> <span class="s">&quot;In&quot;</span><span class="p">,</span>
				<span class="n">type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IcmpMsg:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">icmpmsg_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define PERLINE	16</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">[</span><span class="n">PERLINE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vals</span><span class="p">[</span><span class="n">PERLINE</span><span class="p">],</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ICMPMSG_MIB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">atomic_long_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmpmsg_statistics</span><span class="o">-&gt;</span><span class="n">mibs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">vals</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">PERLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icmpmsg_put_line</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">icmpmsg_put_line</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="cp">#undef PERLINE</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">icmp_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">atomic_long_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmpmsg_statistics</span><span class="o">-&gt;</span><span class="n">mibs</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Icmp: InMsgs InErrors&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; In%s&quot;</span><span class="p">,</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; OutMsgs OutErrors&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; Out%s&quot;</span><span class="p">,</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Icmp: %lu %lu&quot;</span><span class="p">,</span>
		<span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmp_statistics</span><span class="p">,</span> <span class="n">ICMP_MIB_INMSGS</span><span class="p">),</span>
		<span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmp_statistics</span><span class="p">,</span> <span class="n">ICMP_MIB_INERRORS</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
			   <span class="n">atomic_long_read</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu %lu&quot;</span><span class="p">,</span>
		<span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmp_statistics</span><span class="p">,</span> <span class="n">ICMP_MIB_OUTMSGS</span><span class="p">),</span>
		<span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">icmp_statistics</span><span class="p">,</span> <span class="n">ICMP_MIB_OUTERRORS</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
			   <span class="n">atomic_long_read</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">icmpmibmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called from the PROCfs module. This outputs /proc/net/snmp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snmp_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Ip: Forwarding DefaultTTL&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_ipstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_ipstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Ip: %d %d&quot;</span><span class="p">,</span>
		   <span class="n">IPV4_DEVCONF_ALL</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">FORWARDING</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
		   <span class="n">sysctl_ip_default_ttl</span><span class="p">);</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipstats_mib</span><span class="p">,</span> <span class="n">mibs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_ipstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %llu&quot;</span><span class="p">,</span>
			   <span class="n">snmp_fold_field64</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">ip_statistics</span><span class="p">,</span>
					     <span class="n">snmp4_ipstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">,</span>
					     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipstats_mib</span><span class="p">,</span> <span class="n">syncp</span><span class="p">)));</span>

	<span class="n">icmp_put</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>	<span class="cm">/* RFC 2011 compatibility */</span>
	<span class="n">icmpmsg_put</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Tcp:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Tcp:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MaxConn field is signed, RFC 2012 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">==</span> <span class="n">TCP_MIB_MAXCONN</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %ld&quot;</span><span class="p">,</span>
				   <span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">tcp_statistics</span><span class="p">,</span>
						   <span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
				   <span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">tcp_statistics</span><span class="p">,</span>
						   <span class="n">snmp4_tcp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Udp:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Udp:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
			   <span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">udp_statistics</span><span class="p">,</span>
					   <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">));</span>

	<span class="cm">/* the UDP and UDP-Lite MIBs are the same */</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">UdpLite:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">UdpLite:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
			   <span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">udplite_statistics</span><span class="p">,</span>
					   <span class="n">snmp4_udp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">));</span>

	<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snmp_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">snmp_seq_show</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">snmp_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">snmp_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release_net</span><span class="p">,</span>
<span class="p">};</span>



<span class="cm">/*</span>
<span class="cm"> *	Output /proc/net/netstat</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netstat_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;TcpExt:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_net_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_net_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">TcpExt:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_net_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %lu&quot;</span><span class="p">,</span>
			   <span class="n">snmp_fold_field</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">net_statistics</span><span class="p">,</span>
					   <span class="n">snmp4_net_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">));</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IpExt:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_ipextstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">snmp4_ipextstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IpExt:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">snmp4_ipextstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %llu&quot;</span><span class="p">,</span>
			   <span class="n">snmp_fold_field64</span><span class="p">((</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">**</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">ip_statistics</span><span class="p">,</span>
					     <span class="n">snmp4_ipextstats_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">,</span>
					     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipstats_mib</span><span class="p">,</span> <span class="n">syncp</span><span class="p">)));</span>

	<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netstat_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">netstat_seq_show</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">netstat_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">netstat_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">ip_proc_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;sockstat&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sockstat_seq_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_sockstat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;netstat&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netstat_seq_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_netstat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;snmp&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snmp_seq_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_snmp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_snmp:</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;netstat&quot;</span><span class="p">);</span>
<span class="nl">out_netstat:</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;sockstat&quot;</span><span class="p">);</span>
<span class="nl">out_sockstat:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_exit</span> <span class="kt">void</span> <span class="nf">ip_proc_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;snmp&quot;</span><span class="p">);</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;netstat&quot;</span><span class="p">);</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;sockstat&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_initdata</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">ip_proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ip_proc_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">ip_proc_exit_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ip_misc_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_proc_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
