<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv4 › route.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>route.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * INET		An implementation of the TCP/IP protocol suite for the LINUX</span>
<span class="cm"> *		operating system.  INET is implemented using the  BSD Socket</span>
<span class="cm"> *		interface as the means of communication with the user level.</span>
<span class="cm"> *</span>
<span class="cm"> *		ROUTE - implementation of the IP router.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Ross Biro</span>
<span class="cm"> *		Fred N. van Kempen, &lt;waltje@uWalt.NL.Mugnet.ORG&gt;</span>
<span class="cm"> *		Alan Cox, &lt;gw4pts@gw4pts.ampr.org&gt;</span>
<span class="cm"> *		Linus Torvalds, &lt;Linus.Torvalds@helsinki.fi&gt;</span>
<span class="cm"> *		Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes:</span>
<span class="cm"> *		Alan Cox	:	Verify area fixes.</span>
<span class="cm"> *		Alan Cox	:	cli() protects routing changes</span>
<span class="cm"> *		Rui Oliveira	:	ICMP routing table updates</span>
<span class="cm"> *		(rco@di.uminho.pt)	Routing table insertion and update</span>
<span class="cm"> *		Linus Torvalds	:	Rewrote bits to be sensible</span>
<span class="cm"> *		Alan Cox	:	Added BSD route gw semantics</span>
<span class="cm"> *		Alan Cox	:	Super /proc &gt;4K</span>
<span class="cm"> *		Alan Cox	:	MTU in route table</span>
<span class="cm"> *		Alan Cox	: 	MSS actually. Also added the window</span>
<span class="cm"> *					clamper.</span>
<span class="cm"> *		Sam Lantinga	:	Fixed route matching in rt_del()</span>
<span class="cm"> *		Alan Cox	:	Routing cache support.</span>
<span class="cm"> *		Alan Cox	:	Removed compatibility cruft.</span>
<span class="cm"> *		Alan Cox	:	RTF_REJECT support.</span>
<span class="cm"> *		Alan Cox	:	TCP irtt support.</span>
<span class="cm"> *		Jonathan Naylor	:	Added Metric support.</span>
<span class="cm"> *	Miquel van Smoorenburg	:	BSD API fixes.</span>
<span class="cm"> *	Miquel van Smoorenburg	:	Metrics.</span>
<span class="cm"> *		Alan Cox	:	Use __u32 properly</span>
<span class="cm"> *		Alan Cox	:	Aligned routing errors more closely with BSD</span>
<span class="cm"> *					our system is still very different.</span>
<span class="cm"> *		Alan Cox	:	Faster /proc handling</span>
<span class="cm"> *	Alexey Kuznetsov	:	Massive rework to support tree based routing,</span>
<span class="cm"> *					routing caches and better behaviour.</span>
<span class="cm"> *</span>
<span class="cm"> *		Olaf Erb	:	irtt wasn&#39;t being copied right.</span>
<span class="cm"> *		Bjorn Ekwall	:	Kerneld route support.</span>
<span class="cm"> *		Alan Cox	:	Multicast fixed (I hope)</span>
<span class="cm"> * 		Pavel Krauz	:	Limited broadcast fixed</span>
<span class="cm"> *		Mike McLagan	:	Routing by source</span>
<span class="cm"> *	Alexey Kuznetsov	:	End of old history. Split to fib.c and</span>
<span class="cm"> *					route.c and rewritten from scratch.</span>
<span class="cm"> *		Andi Kleen	:	Load-limit warning messages.</span>
<span class="cm"> *	Vitaly E. Lavrov	:	Transparent proxy revived after year coma.</span>
<span class="cm"> *	Vitaly E. Lavrov	:	Race condition in ip_route_input_slow.</span>
<span class="cm"> *	Tobias Ringstrom	:	Uninitialized res.type in ip_route_output_slow.</span>
<span class="cm"> *	Vladimir V. Ivanov	:	IP rule info (flowid) is really useful.</span>
<span class="cm"> *		Marc Boucher	:	routing by fwmark</span>
<span class="cm"> *	Robert Olsson		:	Added rt_cache statistics</span>
<span class="cm"> *	Arnaldo C. Melo		:	Convert proc stuff to seq_file</span>
<span class="cm"> *	Eric Dumazet		:	hashed spinlocks and rt_check_expire() fixes.</span>
<span class="cm"> * 	Ilia Sotnikov		:	Ignore TOS on PMTUD and Redirect</span>
<span class="cm"> * 	Ilia Sotnikov		:	Removed TOS from hash calculations</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;IPv4: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/igmp.h&gt;</span>
<span class="cp">#include &lt;linux/pkt_sched.h&gt;</span>
<span class="cp">#include &lt;linux/mroute.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv4.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/jhash.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/inetpeer.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/ip_fib.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/icmp.h&gt;</span>
<span class="cp">#include &lt;net/xfrm.h&gt;</span>
<span class="cp">#include &lt;net/netevent.h&gt;</span>
<span class="cp">#include &lt;net/rtnetlink.h&gt;</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/kmemleak.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;net/secure_seq.h&gt;</span>

<span class="cp">#define RT_FL_TOS(oldflp4) \</span>
<span class="cp">	((oldflp4)-&gt;flowi4_tos &amp; (IPTOS_RT_MASK | RTO_ONLINK))</span>

<span class="cp">#define IP_MAX_MTU	0xFFF0</span>

<span class="cp">#define RT_GC_TIMEOUT (300*HZ)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_max_size</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_gc_timeout</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="n">RT_GC_TIMEOUT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_gc_interval</span> <span class="n">__read_mostly</span>  <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_gc_min_interval</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_redirect_number</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_redirect_load</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_redirect_silence</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_error_cost</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_error_burst</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_gc_elasticity</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_mtu_expires</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_min_pmtu</span> <span class="n">__read_mostly</span>		<span class="o">=</span> <span class="mi">512</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_rt_min_advmss</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rt_chain_length_max</span> <span class="n">__read_mostly</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">expires_work</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires_ljiffies</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *	Interface to generic destination cache.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">ipv4_dst_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cookie</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	 <span class="n">ipv4_default_advmss</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	 <span class="n">ipv4_mtu</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		 <span class="n">ipv4_dst_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">ipv4_negative_advice</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		 <span class="n">ipv4_link_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		 <span class="n">ip_rt_update_pmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mtu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rt_garbage_collect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipv4_dst_ifdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">ipv4_cow_metrics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">old_p</span> <span class="o">=</span> <span class="n">__DST_METRICS_PTR</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prev</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">metrics</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_metrics_new</span><span class="p">(</span><span class="n">peer</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">old_p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">RTAX_MAX</span><span class="p">);</span>

		<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">_metrics</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">__DST_METRICS_PTR</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="n">DST_METRICS_READ_ONLY</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fib_info_put</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">);</span>
				<span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">ipv4_neigh_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_ops</span> <span class="n">ipv4_dst_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span> <span class="o">=</span>		<span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span> <span class="o">=</span>		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">),</span>
	<span class="p">.</span><span class="n">gc</span> <span class="o">=</span>			<span class="n">rt_garbage_collect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check</span> <span class="o">=</span>		<span class="n">ipv4_dst_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_advmss</span> <span class="o">=</span>	<span class="n">ipv4_default_advmss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtu</span> <span class="o">=</span>			<span class="n">ipv4_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cow_metrics</span> <span class="o">=</span>		<span class="n">ipv4_cow_metrics</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span>		<span class="n">ipv4_dst_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ifdown</span> <span class="o">=</span>		<span class="n">ipv4_dst_ifdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">negative_advice</span> <span class="o">=</span>	<span class="n">ipv4_negative_advice</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_failure</span> <span class="o">=</span>		<span class="n">ipv4_link_failure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_pmtu</span> <span class="o">=</span>		<span class="n">ip_rt_update_pmtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">local_out</span> <span class="o">=</span>		<span class="n">__ip_local_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">neigh_lookup</span> <span class="o">=</span>		<span class="n">ipv4_neigh_lookup</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ECN_OR_COST(class)	TC_PRIO_##class</span>

<span class="k">const</span> <span class="n">__u8</span> <span class="n">ip_tos2prio</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TC_PRIO_BESTEFFORT</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">BESTEFFORT</span><span class="p">),</span>
	<span class="n">TC_PRIO_BESTEFFORT</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">BESTEFFORT</span><span class="p">),</span>
	<span class="n">TC_PRIO_BULK</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">BULK</span><span class="p">),</span>
	<span class="n">TC_PRIO_BULK</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">BULK</span><span class="p">),</span>
	<span class="n">TC_PRIO_INTERACTIVE</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">INTERACTIVE</span><span class="p">),</span>
	<span class="n">TC_PRIO_INTERACTIVE</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">INTERACTIVE</span><span class="p">),</span>
	<span class="n">TC_PRIO_INTERACTIVE_BULK</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">INTERACTIVE_BULK</span><span class="p">),</span>
	<span class="n">TC_PRIO_INTERACTIVE_BULK</span><span class="p">,</span>
	<span class="n">ECN_OR_COST</span><span class="p">(</span><span class="n">INTERACTIVE_BULK</span><span class="p">)</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_tos2prio</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Route cache.</span>
<span class="cm"> */</span>

<span class="cm">/* The locking scheme is rather straight forward:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Read-Copy Update protects the buckets of the central route hash.</span>
<span class="cm"> * 2) Only writers remove entries, and they hold the lock</span>
<span class="cm"> *    as they look at rtable reference counts.</span>
<span class="cm"> * 3) Only readers acquire references to rtable entries,</span>
<span class="cm"> *    they do so with atomic increments and with the</span>
<span class="cm"> *    lock held.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">rt_hash_bucket</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span>	<span class="o">*</span><span class="n">chain</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_SMP) || defined(CONFIG_DEBUG_SPINLOCK) || \</span>
<span class="cp">	defined(CONFIG_PROVE_LOCKING)</span>
<span class="cm">/*</span>
<span class="cm"> * Instead of using one spinlock for each rt_hash_bucket, we use a table of spinlocks</span>
<span class="cm"> * The size of this table is a power of two and depends on the number of CPUS.</span>
<span class="cm"> * (on lockdep we have a quite big spinlock_t, so keep the size down there)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_LOCKDEP</span>
<span class="cp"># define RT_HASH_LOCK_SZ	256</span>
<span class="cp">#else</span>
<span class="cp"># if NR_CPUS &gt;= 32</span>
<span class="cp">#  define RT_HASH_LOCK_SZ	4096</span>
<span class="cp"># elif NR_CPUS &gt;= 16</span>
<span class="cp">#  define RT_HASH_LOCK_SZ	2048</span>
<span class="cp"># elif NR_CPUS &gt;= 8</span>
<span class="cp">#  define RT_HASH_LOCK_SZ	1024</span>
<span class="cp"># elif NR_CPUS &gt;= 4</span>
<span class="cp">#  define RT_HASH_LOCK_SZ	512</span>
<span class="cp"># else</span>
<span class="cp">#  define RT_HASH_LOCK_SZ	256</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">spinlock_t</span>	<span class="o">*</span><span class="n">rt_hash_locks</span><span class="p">;</span>
<span class="cp"># define rt_hash_lock_addr(slot) &amp;rt_hash_locks[(slot) &amp; (RT_HASH_LOCK_SZ - 1)]</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">rt_hash_lock_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rt_hash_locks</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">spinlock_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">RT_HASH_LOCK_SZ</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_hash_locks</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IP: failed to allocate rt_hash_locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RT_HASH_LOCK_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt_hash_locks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define rt_hash_lock_addr(slot) NULL</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rt_hash_lock_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rt_hash_bucket</span> 	<span class="o">*</span><span class="n">rt_hash_table</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rt_hash_mask</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rt_hash_log</span>  <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_cache_stat</span><span class="p">,</span> <span class="n">rt_cache_stat</span><span class="p">);</span>
<span class="cp">#define RT_CACHE_STAT_INC(field) __this_cpu_inc(rt_cache_stat.field)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rt_hash</span><span class="p">(</span><span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">genid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jhash_3words</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">daddr</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">saddr</span><span class="p">,</span>
			    <span class="n">idx</span><span class="p">,</span> <span class="n">genid</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">rt_hash_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rt_genid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">rt_genid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">struct</span> <span class="n">rt_cache_iter_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bucket</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">genid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">rt_cache_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_cache_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">rt_hash_mask</span><span class="p">;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcu_access_pointer</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">genid</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">__rt_cache_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_cache_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rcu_access_pointer</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">));</span>
		<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">rt_cache_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_cache_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">__rt_cache_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">genid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">rt_cache_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">rt_cache_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">rt_cache_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">r</span><span class="p">)))</span>
			<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rt_cache_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_cache_iter_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rt_cache_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">genid</span> <span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rt_cache_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">rt_cache_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">rt_cache_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_cache_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_cache_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%-127s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;Iface</span><span class="se">\t</span><span class="s">Destination</span><span class="se">\t</span><span class="s">Gateway </span><span class="se">\t</span><span class="s">Flags</span><span class="se">\t\t</span><span class="s">RefCnt</span><span class="se">\t</span><span class="s">Use</span><span class="se">\t</span><span class="s">&quot;</span>
			   <span class="s">&quot;Metric</span><span class="se">\t</span><span class="s">Source</span><span class="se">\t\t</span><span class="s">MTU</span><span class="se">\t</span><span class="s">Window</span><span class="se">\t</span><span class="s">IRTT</span><span class="se">\t</span><span class="s">TOS</span><span class="se">\t</span><span class="s">HHRef</span><span class="se">\t</span><span class="s">&quot;</span>
			   <span class="s">&quot;HHUptod</span><span class="se">\t</span><span class="s">SpecDst&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">HHUptod</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dst_get_neighbour_noref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">HHUptod</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">nud_state</span> <span class="o">&amp;</span> <span class="n">NUD_CONNECTED</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">%08X</span><span class="se">\t</span><span class="s">%08X</span><span class="se">\t</span><span class="s">%8X</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%u</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;%08X</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%u</span><span class="se">\t</span><span class="s">%u</span><span class="se">\t</span><span class="s">%02X</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%1d</span><span class="se">\t</span><span class="s">%08X%n&quot;</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span>
			<span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_flags</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">__refcnt</span><span class="p">),</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">__use</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">,</span>
			<span class="n">dst_metric_advmss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span>
			<span class="n">dst_metric</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_WINDOW</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">dst_metric</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_RTT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
			      <span class="n">dst_metric</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_RTTVAR</span><span class="p">)),</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span><span class="p">,</span>
			<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">HHUptod</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">rt_cache_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">rt_cache_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">rt_cache_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">rt_cache_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">rt_cache_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_cache_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt_cache_seq_ops</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_cache_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rt_cache_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">rt_cache_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rt_cpu_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">;</span> <span class="o">++</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_possible</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">rt_cache_stat</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rt_cpu_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">;</span> <span class="o">++</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_possible</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">rt_cache_stat</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_cpu_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_cpu_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_cache_stat</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;entries  in_hit in_slow_tot in_slow_mc in_no_route in_brd in_martian_dst in_martian_src  out_hit out_slow_tot out_slow_mc  gc_total gc_ignored gc_goal_miss gc_dst_overflow in_hlist_search out_hlist_search</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span><span class="s">&quot;%08x  %08x %08x %08x %08x %08x %08x %08x &quot;</span>
		   <span class="s">&quot; %08x %08x %08x %08x %08x %08x %08x %08x %08x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dst_entries_get_slow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">),</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_hit</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_slow_tot</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_slow_mc</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_no_route</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_brd</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_martian_dst</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_martian_src</span><span class="p">,</span>

		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">out_hit</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">out_slow_tot</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">out_slow_mc</span><span class="p">,</span>

		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">gc_total</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">gc_ignored</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">gc_goal_miss</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">gc_dst_overflow</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">in_hlist_search</span><span class="p">,</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">out_hlist_search</span>
		<span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">rt_cpu_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">rt_cpu_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">rt_cpu_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">rt_cpu_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">rt_cpu_seq_show</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_cpu_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt_cpu_seq_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rt_cpu_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">rt_cpu_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_acct_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_rt_acct</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_rt_acct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip_rt_acct</span> <span class="o">*</span><span class="p">)</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">ip_rt_acct</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">o_bytes</span>   <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">o_bytes</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">o_packets</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">o_packets</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">i_bytes</span>   <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">i_bytes</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">i_packets</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">i_packets</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_write</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_rt_acct</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_acct_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">rt_acct_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rt_acct_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">rt_acct_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">ip_rt_do_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>

	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rt_cache_seq_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt_cpu_seq_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;rt_acct&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt_acct_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
<span class="nl">err3:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net_stat</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">err2:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">ip_rt_do_proc_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net_stat</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rt_cache&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rt_acct&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">proc_net</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">ip_rt_proc_ops</span> <span class="n">__net_initdata</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ip_rt_do_proc_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">ip_rt_do_proc_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ip_rt_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_rt_proc_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ip_rt_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rt_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rcu_head</span><span class="p">,</span> <span class="n">dst_rcu_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rt_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="n">call_rcu_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rcu_head</span><span class="p">,</span> <span class="n">dst_rcu_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rt_fast_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Kill broadcast/multicast entries very aggresively, if they</span>
<span class="cm">	   collide in hash table with more useful entries */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_BROADCAST</span> <span class="o">|</span> <span class="n">RTCF_MULTICAST</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">rt_is_input_route</span><span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rt_valuable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_REDIRECTED</span> <span class="o">|</span> <span class="n">RTCF_NOTIFY</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_may_expire</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">age</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">__refcnt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">age</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">lastuse</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="n">tmo1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rt_fast_clean</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="n">tmo2</span> <span class="o">&amp;&amp;</span> <span class="n">rt_valuable</span><span class="p">(</span><span class="n">rth</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Bits of score are:</span>
<span class="cm"> * 31: very valuable</span>
<span class="cm"> * 30: not quite useless</span>
<span class="cm"> * 29..0: usage counter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rt_score</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">score</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">lastuse</span><span class="p">;</span>

	<span class="n">score</span> <span class="o">=</span> <span class="o">~</span><span class="n">score</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt_valuable</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="n">score</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_BROADCAST</span><span class="o">|</span><span class="n">RTCF_MULTICAST</span><span class="o">|</span><span class="n">RTCF_LOCAL</span><span class="p">)))</span>
		<span class="n">score</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">score</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">rt_caching</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">current_rt_cache_rebuild_count</span> <span class="o">&lt;=</span>
		<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">sysctl_rt_cache_rebuild_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">compare_hash_inputs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt1</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">^</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">compare_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_mark</span> <span class="o">^</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_mark</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span> <span class="o">^</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">^</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">rt_oif</span> <span class="o">^</span> <span class="n">rt2</span><span class="o">-&gt;</span><span class="n">rt_oif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">compare_netns</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt1</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">rt2</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rt_is_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">!=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform a full scan of hash table and free all entries.</span>
<span class="cm"> * Can be called by a softirq or a process.</span>
<span class="cm"> * In the later case, we want to be reschedule if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_do_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">process_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">rt_hash_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">pprev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">process_context</span> <span class="o">&amp;&amp;</span> <span class="n">need_resched</span><span class="p">())</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_access_pointer</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rth</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pprev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">pprev</span><span class="p">,</span>
			<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span>
				<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span> <span class="o">||</span>
			    <span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">pprev</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
				<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">list</span> <span class="o">=</span> <span class="n">rth</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pprev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rth</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">list</span><span class="p">;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt_free</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * While freeing expired entries, we compute average chain length</span>
<span class="cm"> * and standard deviation, using fixed-point arithmetic.</span>
<span class="cm"> * This to have an estimation of rt_chain_length_max</span>
<span class="cm"> *  rt_chain_length_max = max(elasticity, AVG + 4*SD)</span>
<span class="cm"> * We use 3 bits for frational part, and 29 (or 61) for magnitude.</span>
<span class="cm"> */</span>

<span class="cp">#define FRACT_BITS 3</span>
<span class="cp">#define ONE (1UL &lt;&lt; FRACT_BITS)</span>

<span class="cm">/*</span>
<span class="cm"> * Given a hash chain and an item in this hash chain,</span>
<span class="cm"> * find if a previous entry has the same hash_inputs</span>
<span class="cm"> * (but differs on tos, mark or oif)</span>
<span class="cm"> * Returns 0 if an alias is found.</span>
<span class="cm"> * Returns ONE if rth has no alias before itself.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">has_noalias</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">aux</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">aux</span> <span class="o">!=</span> <span class="n">rth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compare_hash_inputs</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="n">rth</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">aux</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_check_expire</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rover</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rover</span><span class="p">,</span> <span class="n">goal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">rthp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mult</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">expires_ljiffies</span><span class="p">;</span>
	<span class="n">expires_ljiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">mult</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">rt_hash_log</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip_rt_gc_timeout</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">mult</span><span class="p">,</span> <span class="n">ip_rt_gc_timeout</span><span class="p">);</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mult</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&gt;</span> <span class="n">rt_hash_mask</span><span class="p">)</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">goal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">goal</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo</span> <span class="o">=</span> <span class="n">ip_rt_gc_timeout</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rt_hash_mask</span><span class="p">;</span>
		<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">samples</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rcu_dereference_raw</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">,</span>
					<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
				<span class="n">rt_free</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Entry is expired even if it is in use */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">expires</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">nofree:</span>
					<span class="n">tmo</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * We only count entries on</span>
<span class="cm">					 * a chain with equal hash inputs once</span>
<span class="cm">					 * so that entries for different QOS</span>
<span class="cm">					 * levels, and other non-hash input</span>
<span class="cm">					 * attributes don&#39;t unfairly skew</span>
<span class="cm">					 * the length computation</span>
<span class="cm">					 */</span>
					<span class="n">length</span> <span class="o">+=</span> <span class="n">has_noalias</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain</span><span class="p">,</span> <span class="n">rth</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_may_expire</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="n">tmo</span><span class="p">,</span> <span class="n">ip_rt_gc_timeout</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nofree</span><span class="p">;</span>

			<span class="cm">/* Cleanup aged off entries. */</span>
			<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="n">rt_free</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">sum2</span> <span class="o">+=</span> <span class="n">length</span><span class="o">*</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">/</span> <span class="n">samples</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">int_sqrt</span><span class="p">(</span><span class="n">sum2</span> <span class="o">/</span> <span class="n">samples</span> <span class="o">-</span> <span class="n">avg</span><span class="o">*</span><span class="n">avg</span><span class="p">);</span>
		<span class="n">rt_chain_length_max</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
					<span class="n">ip_rt_gc_elasticity</span><span class="p">,</span>
					<span class="p">(</span><span class="n">avg</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">sd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FRACT_BITS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rover</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rt_worker_func() is run in process context.</span>
<span class="cm"> * we call rt_check_expire() to scan part of the hash table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_worker_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt_check_expire</span><span class="p">();</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expires_work</span><span class="p">,</span> <span class="n">ip_rt_gc_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perturbation of rt_genid by a small quantity [1..256]</span>
<span class="cm"> * Using 8 bits of shuffling ensure we can call rt_cache_invalidate()</span>
<span class="cm"> * many times (2^24) without giving recent rt_genid.</span>
<span class="cm"> * Jenkins hash is strong enough that litle changes of rt_genid are OK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_cache_invalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shuffle</span><span class="p">;</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shuffle</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shuffle</span><span class="p">));</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">shuffle</span> <span class="o">+</span> <span class="mi">1U</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">rt_genid</span><span class="p">);</span>
	<span class="n">inetpeer_invalidate_tree</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * delay &lt; 0  : invalidate cache (fast : entries will be deleted later)</span>
<span class="cm"> * delay &gt;= 0 : invalidate &amp; flush cache (can be long)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rt_cache_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt_cache_invalidate</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rt_do_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">!</span><span class="n">in_softirq</span><span class="p">());</span>
<span class="p">}</span>

<span class="cm">/* Flush previous cache invalidated entries from the cache */</span>
<span class="kt">void</span> <span class="nf">rt_cache_flush_batch</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt_do_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">!</span><span class="n">in_softirq</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_emergency_hash_rebuild</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;Route hash chain too long!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rt_cache_invalidate</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   Short description of GC goals.</span>

<span class="cm">   We want to build algorithm, which will keep routing cache</span>
<span class="cm">   at some equilibrium point, when number of aged off entries</span>
<span class="cm">   is kept approximately equal to newly generated ones.</span>

<span class="cm">   Current expiration strength is variable &quot;expire&quot;.</span>
<span class="cm">   We try to adjust it dynamically, so that if networking</span>
<span class="cm">   is idle expires is large enough to keep enough of warm entries,</span>
<span class="cm">   and when load increases it reduces to limit cache size.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_garbage_collect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">RT_GC_TIMEOUT</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_gc</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">rover</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">equilibrium</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">rthp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">goal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">dst_entries_get_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Garbage collection is pretty expensive,</span>
<span class="cm">	 * do not make it too frequently.</span>
<span class="cm">	 */</span>

	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">gc_total</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_gc</span> <span class="o">&lt;</span> <span class="n">ip_rt_gc_min_interval</span> <span class="o">&amp;&amp;</span>
	    <span class="n">entries</span> <span class="o">&lt;</span> <span class="n">ip_rt_max_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">gc_ignored</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">dst_entries_get_slow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">);</span>
	<span class="cm">/* Calculate number of entries, which we want to expire now. */</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="p">(</span><span class="n">ip_rt_gc_elasticity</span> <span class="o">&lt;&lt;</span> <span class="n">rt_hash_log</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">equilibrium</span> <span class="o">&lt;</span> <span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span><span class="p">)</span>
			<span class="n">equilibrium</span> <span class="o">=</span> <span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span><span class="p">;</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="n">equilibrium</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">equilibrium</span> <span class="o">+=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">goal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">goal</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="n">equilibrium</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We are in dangerous area. Try to reduce cache really</span>
<span class="cm">		 * aggressively.</span>
<span class="cm">		 */</span>
		<span class="n">goal</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">goal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">equilibrium</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">-</span> <span class="n">goal</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_gc</span> <span class="o">&gt;=</span> <span class="n">ip_rt_gc_min_interval</span><span class="p">)</span>
		<span class="n">last_gc</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">equilibrium</span> <span class="o">+=</span> <span class="n">goal</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">work_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rt_hash_mask</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">rover</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo</span> <span class="o">=</span> <span class="n">expire</span><span class="p">;</span>

			<span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rt_hash_mask</span><span class="p">;</span>
			<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">,</span>
					<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">rt_may_expire</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="n">tmo</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tmo</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
				<span class="n">rt_free</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
				<span class="n">goal</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rover</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">work_done</span><span class="p">;</span>

		<span class="cm">/* Goal is not achieved. We stop process if:</span>

<span class="cm">		   - if expire reduced to zero. Otherwise, expire is halfed.</span>
<span class="cm">		   - if table is not full.</span>
<span class="cm">		   - if we are called from interrupt.</span>
<span class="cm">		   - jiffies check is just fallback/debug loop breaker.</span>
<span class="cm">		     We will not spin here for long time in any case.</span>
<span class="cm">		 */</span>

		<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">gc_goal_miss</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">expire</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">expire</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst_entries_get_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ip_rt_max_size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">in_softirq</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">now</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_entries_get_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ip_rt_max_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_entries_get_slow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ip_rt_max_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;dst cache overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">gc_dst_overflow</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">work_done:</span>
	<span class="n">expire</span> <span class="o">+=</span> <span class="n">ip_rt_gc_min_interval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expire</span> <span class="o">&gt;</span> <span class="n">ip_rt_gc_timeout</span> <span class="o">||</span>
	    <span class="n">dst_entries_get_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span> <span class="o">||</span>
	    <span class="n">dst_entries_get_slow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span><span class="p">)</span>
		<span class="n">expire</span> <span class="o">=</span> <span class="n">ip_rt_gc_timeout</span><span class="p">;</span>
<span class="nl">out:</span>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns number of entries in a hash chain that have different hash_inputs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slow_chain_length</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">+=</span> <span class="n">has_noalias</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">rth</span><span class="p">);</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="n">FRACT_BITS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="nf">ipv4_neigh_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">__be32</span> <span class="n">inaddr_any</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">pkey</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_LOOPBACK</span> <span class="o">|</span> <span class="n">IFF_POINTOPOINT</span><span class="p">))</span>
		<span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inaddr_any</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">)</span>
		<span class="n">pkey</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">__ipv4_neigh_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">__force</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pkey</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">neigh_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arp_tbl</span><span class="p">,</span> <span class="n">pkey</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_bind_neighbour</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">ipv4_neigh_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="n">dst_set_neighbour</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">rt_intern_hash</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span>	<span class="o">*</span><span class="n">rth</span><span class="p">,</span> <span class="o">*</span><span class="n">cand</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">rthp</span><span class="p">,</span> <span class="o">**</span><span class="n">candp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">now</span><span class="p">;</span>
	<span class="n">u32</span> 		<span class="n">min_score</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">chain_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="o">!</span><span class="n">in_softirq</span><span class="p">();</span>

<span class="nl">restart:</span>
	<span class="n">chain_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">min_score</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">cand</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">candp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_caching</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re not caching, just tell the caller we</span>
<span class="cm">		 * were successful and don&#39;t touch the route.  The</span>
<span class="cm">		 * caller hold the sole reference to the cache entry, and</span>
<span class="cm">		 * it will be released when the caller is done with it.</span>
<span class="cm">		 * If we drop it here, the callers have no way to resolve routes</span>
<span class="cm">		 * when we&#39;re not caching.  Instead, just point *rp at rt, so</span>
<span class="cm">		 * the caller gets a single use out of the route</span>
<span class="cm">		 * Note that we do rt_free on this new route entry, so that</span>
<span class="cm">		 * once its refcount hits zero, we are still able to reap it</span>
<span class="cm">		 * (Thanks Alexey)</span>
<span class="cm">		 * Note: To avoid expensive rcu stuff for this uncached dst,</span>
<span class="cm">		 * we set DST_NOCACHE so that dst_release() can free dst without</span>
<span class="cm">		 * waiting a grace period.</span>
<span class="cm">		 */</span>

		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DST_NOCACHE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_type</span> <span class="o">==</span> <span class="n">RTN_UNICAST</span> <span class="o">||</span> <span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rt_bind_neighbour</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;Neighbour table failure &amp; not caching routes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">skip_hashing</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">,</span>
			<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">))))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="n">rt_free</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compare_keys</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">compare_netns</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Put it first */</span>
			<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Since lookup is lockfree, the deletion</span>
<span class="cm">			 * must be visible to another weakly ordered CPU before</span>
<span class="cm">			 * the insertion at the start of the hash chain.</span>
<span class="cm">			 */</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">,</span>
					   <span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Since lookup is lockfree, the update writes</span>
<span class="cm">			 * must be ordered for consistency on SMP.</span>
<span class="cm">			 */</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">,</span> <span class="n">rth</span><span class="p">);</span>

			<span class="n">dst_use</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

			<span class="n">rt_drop</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rth</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">__refcnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">score</span> <span class="o">=</span> <span class="n">rt_score</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">score</span> <span class="o">&lt;=</span> <span class="n">min_score</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cand</span> <span class="o">=</span> <span class="n">rth</span><span class="p">;</span>
				<span class="n">candp</span> <span class="o">=</span> <span class="n">rthp</span><span class="p">;</span>
				<span class="n">min_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">chain_length</span><span class="o">++</span><span class="p">;</span>

		<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cand</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ip_rt_gc_elasticity used to be average length of chain</span>
<span class="cm">		 * length, when exceeded gc becomes really aggressive.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The second limit is less certain. At the moment it allows</span>
<span class="cm">		 * only 2 entries per bucket. We will see.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain_length</span> <span class="o">&gt;</span> <span class="n">ip_rt_gc_elasticity</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">candp</span> <span class="o">=</span> <span class="n">cand</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="n">rt_free</span><span class="p">(</span><span class="n">cand</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain_length</span> <span class="o">&gt;</span> <span class="n">rt_chain_length_max</span> <span class="o">&amp;&amp;</span>
		    <span class="n">slow_chain_length</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rt_chain_length_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="o">++</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">current_rt_cache_rebuild_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_caching</span><span class="p">(</span><span class="n">net</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: %d rebuilds is over limit, route caching disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rt_emergency_hash_rebuild</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

			<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">,</span>
					<span class="n">ifindex</span><span class="p">,</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Try to bind route to arp only if it is output</span>
<span class="cm">	   route or unicast forwarding path.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_type</span> <span class="o">==</span> <span class="n">RTN_UNICAST</span> <span class="o">||</span> <span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rt_bind_neighbour</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rt_drop</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Neighbour tables are full and nothing</span>
<span class="cm">			   can be released. Try to shrink route cache,</span>
<span class="cm">			   it is most likely it holds some neighbour records.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attempts</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">saved_elasticity</span> <span class="o">=</span> <span class="n">ip_rt_gc_elasticity</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">saved_int</span> <span class="o">=</span> <span class="n">ip_rt_gc_min_interval</span><span class="p">;</span>
				<span class="n">ip_rt_gc_elasticity</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ip_rt_gc_min_interval</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rt_garbage_collect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">);</span>
				<span class="n">ip_rt_gc_min_interval</span>	<span class="o">=</span> <span class="n">saved_int</span><span class="p">;</span>
				<span class="n">ip_rt_gc_elasticity</span>	<span class="o">=</span> <span class="n">saved_elasticity</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;Neighbour table overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rt_drop</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span> <span class="o">=</span> <span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since lookup is lockfree, we must make sure</span>
<span class="cm">	 * previous writes to rt are committed to memory</span>
<span class="cm">	 * before making rt visible to other CPUS.</span>
<span class="cm">	 */</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>

<span class="nl">skip_hashing:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">__rt_peer_genid</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rt_peer_genid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__rt_peer_genid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt_bind_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">inet_getpeer_v4</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">inet_putpeer</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="n">rt_peer_genid</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Peer allocation may fail only in serious out-of-memory conditions.  However</span>
<span class="cm"> * we still can generate some output.</span>
<span class="cm"> * Random ID selection looks a bit dangerous because we have no chances to</span>
<span class="cm"> * select ID being unique in a reasonable period of time.</span>
<span class="cm"> * But broken packet identifier may be better than no packet at all.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_select_fb_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ip_fb_id_lock</span><span class="p">);</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">ip_fallback_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">salt</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_fb_id_lock</span><span class="p">);</span>
	<span class="n">salt</span> <span class="o">=</span> <span class="n">secure_ip_id</span><span class="p">((</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span><span class="n">ip_fallback_id</span> <span class="o">^</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">salt</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">ip_fallback_id</span> <span class="o">=</span> <span class="n">salt</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_fb_id_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__ip_select_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DST_NOPEER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* If peer is attached to destination, it is never detached,</span>
<span class="cm">		   so that we need not to grab a lock to dereference it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">inet_getid</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">more</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rt_bind_peer(0) @%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">ip_select_fb_ident</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__ip_select_ident</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_del</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">rthp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>

	<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>
	<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">aux</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">,</span>
			<span class="n">lockdep_is_held</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">))))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">==</span> <span class="n">rt</span> <span class="o">||</span> <span class="n">rt_is_expired</span><span class="p">(</span><span class="n">aux</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rthp</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
			<span class="n">rt_free</span><span class="p">(</span><span class="n">aux</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">rt_hash_lock_addr</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_peer_redir</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">orig_gw</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">old_n</span><span class="p">;</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ipv4_neigh_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">orig_gw</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">old_n</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">_neighbour</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_n</span><span class="p">)</span>
		<span class="n">neigh_release</span><span class="p">(</span><span class="n">old_n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">nud_state</span> <span class="o">&amp;</span> <span class="n">NUD_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">neigh_event_send</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">RTCF_REDIRECTED</span><span class="p">;</span>
		<span class="n">call_netevent_notifiers</span><span class="p">(</span><span class="n">NETEVENT_NEIGH_UPDATE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called in rcu_read_lock() section */</span>
<span class="kt">void</span> <span class="nf">ip_rt_redirect</span><span class="p">(</span><span class="n">__be32</span> <span class="n">old_gw</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">new_gw</span><span class="p">,</span>
		    <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="n">skeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span>    <span class="n">ikeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_gw</span> <span class="o">==</span> <span class="n">old_gw</span> <span class="o">||</span> <span class="o">!</span><span class="n">IN_DEV_RX_REDIRECTS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">new_gw</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">new_gw</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">new_gw</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">reject_redirect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IN_DEV_SHARED_MEDIA</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inet_addr_onlink</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">new_gw</span><span class="p">,</span> <span class="n">old_gw</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reject_redirect</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IN_DEV_SEC_REDIRECTS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip_fib_check_default</span><span class="p">(</span><span class="n">new_gw</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reject_redirect</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_addr_type</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">new_gw</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTN_UNICAST</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">reject_redirect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">rthp</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

			<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">skeys</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">ikeys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>

			<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">rt</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="o">*</span><span class="n">rthp</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rthp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">!=</span> <span class="n">daddr</span> <span class="o">||</span>
				    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">!=</span> <span class="n">skeys</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">||</span>
				    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_oif</span> <span class="o">!=</span> <span class="n">ikeys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span>
				    <span class="n">rt_is_input_route</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span>
				    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span> <span class="o">||</span>
				    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">!=</span> <span class="n">old_gw</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
					<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">!=</span> <span class="n">new_gw</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">=</span> <span class="n">new_gw</span><span class="p">;</span>
						<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__rt_peer_genid</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">check_peer_redir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">reject_redirect:</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_VERBOSE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IN_DEV_LOG_MARTIANS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="n">net_info_ratelimited</span><span class="p">(</span><span class="s">&quot;Redirect from %pI4 on %s about %pI4 ignored</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;  Advised path = %pI4 -&gt; %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">old_gw</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_gw</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">peer_pmtu_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">orig</span> <span class="o">&amp;&amp;</span>
	       <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">orig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">peer_pmtu_cleaned</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">orig</span> <span class="o">&amp;&amp;</span>
	       <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">orig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">ipv4_negative_advice</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">obsolete</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="n">RTCF_REDIRECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">,</span>
						<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_oif</span><span class="p">,</span>
						<span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)));</span>
			<span class="n">rt_del</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">peer_pmtu_expired</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_orig</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Algorithm:</span>
<span class="cm"> *	1. The first ip_rt_redirect_number redirects are sent</span>
<span class="cm"> *	   with exponential backoff, then we stop sending them at all,</span>
<span class="cm"> *	   assuming that the host ignores our redirects.</span>
<span class="cm"> *	2. If we did not see packets requiring redirects</span>
<span class="cm"> *	   during ip_rt_redirect_silence, we assume that the host</span>
<span class="cm"> *	   forgot redirected route and start to send redirects again.</span>
<span class="cm"> *</span>
<span class="cm"> * This algorithm is much cheaper and more intelligent than dumb load limiting</span>
<span class="cm"> * in icmp.c.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE. Do not forget to inhibit load limiting for redirects (redundant)</span>
<span class="cm"> * and &quot;frag. need&quot; (breaks PMTU discovery) in icmp.c.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_rt_send_redirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_martians</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">IN_DEV_TX_REDIRECTS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_martians</span> <span class="o">=</span> <span class="n">IN_DEV_LOG_MARTIANS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_REDIRECT</span><span class="p">,</span> <span class="n">ICMP_REDIR_HOST</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No redirected packets during ip_rt_redirect_silence;</span>
<span class="cm">	 * reset the algorithm.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span> <span class="o">+</span> <span class="n">ip_rt_redirect_silence</span><span class="p">))</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Too many ignored redirects; do not send anything</span>
<span class="cm">	 * set dst.rate_last to the last seen redirected packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">&gt;=</span> <span class="n">ip_rt_redirect_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for load limit; set rate_last to the latest sent</span>
<span class="cm">	 * redirect.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ip_rt_redirect_load</span> <span class="o">&lt;&lt;</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_REDIRECT</span><span class="p">,</span> <span class="n">ICMP_REDIR_HOST</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">);</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="o">++</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_VERBOSE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log_martians</span> <span class="o">&amp;&amp;</span>
		    <span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">==</span> <span class="n">ip_rt_redirect_number</span><span class="p">)</span>
			<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;host %pI4/if%d ignores redirects for %pI4 to %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_iif</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">send</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EINVAL</span>:
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHOSTUNREACH</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="n">ICMP_HOST_UNREACH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENETUNREACH</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="n">ICMP_NET_UNREACH</span><span class="p">;</span>
		<span class="n">IP_INC_STATS_BH</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span>
				<span class="n">IPSTATS_MIB_INNOROUTES</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EACCES</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="n">ICMP_PKT_FILTERED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>

	<span class="n">send</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">+=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">&gt;</span> <span class="n">ip_rt_error_burst</span><span class="p">)</span>
			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">=</span> <span class="n">ip_rt_error_burst</span><span class="p">;</span>
		<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_last</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">&gt;=</span> <span class="n">ip_rt_error_cost</span><span class="p">)</span>
			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">rate_tokens</span> <span class="o">-=</span> <span class="n">ip_rt_error_cost</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">send</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">)</span>
		<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	The last two values are not from the RFC but</span>
<span class="cm"> *	are needed for AMPRnet AX.25 paths.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu_plateau</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">32000</span><span class="p">,</span> <span class="mi">17914</span><span class="p">,</span> <span class="mi">8166</span><span class="p">,</span> <span class="mi">4352</span><span class="p">,</span> <span class="mi">2002</span><span class="p">,</span> <span class="mi">1492</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">296</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">128</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">guess_mtu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mtu_plateau</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_mtu</span> <span class="o">&gt;</span> <span class="n">mtu_plateau</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">mtu_plateau</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">68</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">ip_rt_frag_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">new_mtu</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old_mtu</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">est_mtu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">inet_getpeer_v4</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;=</span> <span class="n">old_mtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BSD 4.2 derived systems incorrectly adjust</span>
<span class="cm">			 * tot_len by the IP header length, and report</span>
<span class="cm">			 * a zero MTU in the ICMP message.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">old_mtu</span> <span class="o">&gt;=</span> <span class="mi">68</span> <span class="o">+</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">old_mtu</span> <span class="o">-=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">mtu</span> <span class="o">=</span> <span class="n">guess_mtu</span><span class="p">(</span><span class="n">old_mtu</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">ip_rt_min_pmtu</span><span class="p">)</span>
			<span class="n">mtu</span> <span class="o">=</span> <span class="n">ip_rt_min_pmtu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span> <span class="o">||</span> <span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmtu_expires</span><span class="p">;</span>

			<span class="n">pmtu_expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ip_rt_mtu_expires</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmtu_expires</span><span class="p">)</span>
				<span class="n">pmtu_expires</span> <span class="o">=</span> <span class="mi">1UL</span><span class="p">;</span>

			<span class="n">est_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span> <span class="o">=</span> <span class="n">pmtu_expires</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__rt_peer_genid</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">inet_putpeer</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">est_mtu</span> <span class="o">?</span> <span class="o">:</span> <span class="n">new_mtu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_peer_pmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expires</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expires</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">orig_dst_mtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span> <span class="o">&lt;</span> <span class="n">orig_dst_mtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_orig</span><span class="p">)</span>
				<span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_orig</span> <span class="o">=</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">);</span>
			<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">expires</span><span class="p">)</span>
		<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_orig</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_rt_update_pmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmtu_expires</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">ip_rt_min_pmtu</span><span class="p">)</span>
			<span class="n">mtu</span> <span class="o">=</span> <span class="n">ip_rt_min_pmtu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmtu_expires</span> <span class="o">||</span> <span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">pmtu_expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ip_rt_mtu_expires</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmtu_expires</span><span class="p">)</span>
				<span class="n">pmtu_expires</span> <span class="o">=</span> <span class="mi">1UL</span><span class="p">;</span>

			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_learned</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
			<span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span> <span class="o">=</span> <span class="n">pmtu_expires</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__rt_peer_genid</span><span class="p">);</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="n">rt_peer_genid</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">check_peer_pmtu</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipv4_validate_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">!=</span> <span class="n">rt_peer_genid</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
			<span class="n">rt_bind_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_peer_pmtu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">&amp;&amp;</span>
			    <span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">!=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">)</span>
				<span class="n">check_peer_redir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="n">rt_peer_genid</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">ipv4_dst_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ipv4_validate_peer</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipv4_dst_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fib_info_put</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">);</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">inet_putpeer</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipv4_link_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

	<span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span><span class="p">,</span> <span class="n">ICMP_HOST_UNREACH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">peer_pmtu_cleaned</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">))</span>
		<span class="n">dst_metric_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_orig</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_rt_bug</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %pI4 -&gt; %pI4, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
		 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;?&quot;</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   We do not cache source address of outgoing interface,</span>
<span class="cm">   because it is used only by IP RR, TS and SRR options,</span>
<span class="cm">   so that it out of fast path.</span>

<span class="cm">   BTW remember: &quot;addr&quot; is allowed to be not aligned</span>
<span class="cm">   in IP options!</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ip_rt_get_source</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib_result</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>

		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fl4</span><span class="p">));</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_tos</span> <span class="o">=</span> <span class="n">RT_TOS</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">);</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_iif</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_mark</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fib_lookup</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">FIB_RES_PREFSRC</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">,</span>
					<span class="n">RT_SCOPE_UNIVERSE</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_class_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">))</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">|=</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">))</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">|=</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ipv4_default_advmss</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">advmss</span> <span class="o">=</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_ADVMSS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">advmss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">advmss</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span> <span class="mi">40</span><span class="p">,</span>
			       <span class="n">ip_rt_min_advmss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">advmss</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span>
			<span class="n">advmss</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">advmss</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ipv4_mtu</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&amp;&amp;</span> <span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="n">mtu</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dst_metric_locked</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">!=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span> <span class="o">&amp;&amp;</span> <span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">576</span><span class="p">)</span>
			<span class="n">mtu</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">IP_MAX_MTU</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">IP_MAX_MTU</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mtu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_init_metrics</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fib_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">create</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If a peer entry exists for this destination, we must hook</span>
<span class="cm">	 * it up in order to get at cached metrics.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_flags</span> <span class="o">&amp;</span> <span class="n">FLOWI_FLAG_PRECOW_METRICS</span><span class="p">))</span>
		<span class="n">create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="n">peer</span> <span class="o">=</span> <span class="n">inet_getpeer_v4</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="n">rt_peer_genid</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inet_metrics_new</span><span class="p">(</span><span class="n">peer</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">metrics</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_metrics</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">RTAX_MAX</span><span class="p">);</span>
		<span class="n">dst_init_metrics</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">check_peer_pmtu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">&amp;&amp;</span>
		    <span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span> <span class="o">!=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">redirect_learned</span><span class="p">.</span><span class="n">a4</span><span class="p">;</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">RTCF_REDIRECTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_metrics</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_default_metrics</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="n">fi</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_clntref</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dst_init_metrics</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_metrics</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt_set_nexthop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fib_result</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fib_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">itag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FIB_RES_GW</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">FIB_RES_NH</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">).</span><span class="n">nh_scope</span> <span class="o">==</span> <span class="n">RT_SCOPE_LINK</span><span class="p">)</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">FIB_RES_GW</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">);</span>
		<span class="n">rt_init_metrics</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">fl4</span><span class="p">,</span> <span class="n">fi</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">tclassid</span> <span class="o">=</span> <span class="n">FIB_RES_NH</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">).</span><span class="n">nh_tclassid</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IP_MAX_MTU</span><span class="p">)</span>
		<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">,</span> <span class="n">IP_MAX_MTU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_ADVMSS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_ADVMSS</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">-</span> <span class="mi">40</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
<span class="cp">#ifdef CONFIG_IP_MULTIPLE_TABLES</span>
	<span class="n">set_class_tag</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">fib_rules_tclass</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">set_class_tag</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">itag</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">rt_dst_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">nopolicy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">noxfrm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			 <span class="n">DST_HOST</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">nopolicy</span> <span class="o">?</span> <span class="n">DST_NOPOLICY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">noxfrm</span> <span class="o">?</span> <span class="n">DST_NOXFRM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* called in rcu_read_lock() section */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_route_input_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">tos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">our</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">spec_dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">itag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Primary sanity checks. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">e_inval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">daddr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">e_inval</span><span class="p">;</span>
		<span class="n">spec_dst</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RT_SCOPE_LINK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fib_validate_source</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec_dst</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">itag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">e_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_dst_alloc</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="p">,</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOPOLICY</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rth</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">e_nobufs</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">=</span> <span class="n">itag</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">ip_rt_bug</span><span class="p">;</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_genid</span>	<span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span>	<span class="o">=</span> <span class="n">RTCF_MULTICAST</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_type</span>	<span class="o">=</span> <span class="n">RTN_MULTICAST</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span>	<span class="o">=</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_iif</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_oif</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span>    <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_gateway</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="o">=</span> <span class="n">spec_dst</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span><span class="o">=</span> <span class="n">ip_local_deliver</span><span class="p">;</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MROUTE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">daddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IN_DEV_MFORWARD</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ip_mr_input</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_slow_mc</span><span class="p">);</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">)));</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_intern_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">e_nobufs:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="nl">e_inval:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">e_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip_handle_martian_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span>
				     <span class="n">__be32</span> <span class="n">saddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_martian_src</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_VERBOSE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IN_DEV_LOG_MARTIANS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	RFC1812 recommendation, if source is martian,</span>
<span class="cm">		 *	the only hint is MAC header.</span>
<span class="cm">		 */</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;martian source %pI4 from %pI4, on dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">&amp;&amp;</span> <span class="n">skb_mac_header_was_set</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;ll header: &quot;</span><span class="p">,</span>
				       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* called in rcu_read_lock() section */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mkroute_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fib_result</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span>
			   <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tos</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">rtable</span> <span class="o">**</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">out_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">spec_dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">itag</span><span class="p">;</span>

	<span class="cm">/* get a working reference to the output device */</span>
	<span class="n">out_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">FIB_RES_DEV</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_crit_ratelimited</span><span class="p">(</span><span class="s">&quot;Bug in ip_route_input_slow(). Please report.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">fib_validate_source</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="n">FIB_RES_OIF</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">),</span>
				  <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec_dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip_handle_martian_source</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span>
					 <span class="n">saddr</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_DIRECTSRC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_dev</span> <span class="o">==</span> <span class="n">in_dev</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">IN_DEV_SHARED_MEDIA</span><span class="p">(</span><span class="n">out_dev</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">inet_addr_onlink</span><span class="p">(</span><span class="n">out_dev</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">FIB_RES_GW</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">))))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_DOREDIRECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not IP (i.e. ARP). Do not create route, if it is</span>
<span class="cm">		 * invalid for proxy arp. DNAT routes are always valid.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Proxy arp feature have been extended to allow, ARP</span>
<span class="cm">		 * replies back to the same interface, to support</span>
<span class="cm">		 * Private VLAN switch technologies. See arp.c.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out_dev</span> <span class="o">==</span> <span class="n">in_dev</span> <span class="o">&amp;&amp;</span>
		    <span class="n">IN_DEV_PROXY_ARP_PVLAN</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_dst_alloc</span><span class="p">(</span><span class="n">out_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOPOLICY</span><span class="p">),</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">out_dev</span><span class="p">,</span> <span class="n">NOXFRM</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_type</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span>	<span class="o">=</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_iif</span> 	<span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_oif</span> 	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span>    <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_gateway</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="o">=</span> <span class="n">spec_dst</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ip_forward</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">ip_output</span><span class="p">;</span>

	<span class="n">rt_set_nexthop</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">itag</span><span class="p">);</span>

	<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">rth</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">cleanup:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_mkroute_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fib_result</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">,</span>
			    <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_MULTIPATH</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_nhs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fib_select_multipath</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* create a routing cache entry */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__mkroute_input</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* put it into the cache */</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_iif</span><span class="p">,</span>
		       <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">)));</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_intern_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_iif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	NOTE. We drop all the packets that has local source</span>
<span class="cm"> *	addresses, because every properly looped back packet</span>
<span class="cm"> *	must have correct destination already attached by output routine.</span>
<span class="cm"> *</span>
<span class="cm"> *	Such approach solves two big problems:</span>
<span class="cm"> *	1. Not simplex devices are handled properly.</span>
<span class="cm"> *	2. IP spoofing attempts are filtered with 100% of guarantee.</span>
<span class="cm"> *	called with rcu_read_lock()</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip_route_input_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">tos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib_result</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">flowi4</span>	<span class="n">fl4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">itag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span>	<span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">hash</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">spec_dst</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span>    <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* IP on this device is disabled. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check for the most weird martians, which can be not detected</span>
<span class="cm">	   by fib_lookup.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">martian_source</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">saddr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">daddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">brd_input</span><span class="p">;</span>

	<span class="cm">/* Accept zero addresses only to limited broadcast;</span>
<span class="cm">	 * I even do not know to fix it or not. Waiting for complains :-)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">martian_source</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">daddr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">martian_destination</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now we are ready to route packet.</span>
<span class="cm">	 */</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_iif</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_mark</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_tos</span> <span class="o">=</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_scope</span> <span class="o">=</span> <span class="n">RT_SCOPE_UNIVERSE</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fib_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IN_DEV_FORWARD</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">e_hostunreach</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_route</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_slow_tot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">brd_input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fib_validate_source</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span>
					  <span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span>
					  <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec_dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">martian_source_keep_err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_DIRECTSRC</span><span class="p">;</span>
		<span class="n">spec_dst</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">local_input</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IN_DEV_FORWARD</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">e_hostunreach</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">RTN_UNICAST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">martian_destination</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ip_mkroute_input</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">tos</span><span class="p">);</span>
<span class="nl">out:</span>	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">brd_input:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">e_inval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span>
		<span class="n">spec_dst</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RT_SCOPE_LINK</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fib_validate_source</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec_dst</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">itag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">martian_source_keep_err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_DIRECTSRC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_BROADCAST</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTN_BROADCAST</span><span class="p">;</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_brd</span><span class="p">);</span>

<span class="nl">local_input:</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_dst_alloc</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="p">,</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOPOLICY</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rth</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">e_nobufs</span><span class="p">;</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span><span class="o">=</span> <span class="n">ip_local_deliver</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span><span class="o">=</span> <span class="n">ip_rt_bug</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">=</span> <span class="n">itag</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> 	<span class="o">=</span> <span class="n">flags</span><span class="o">|</span><span class="n">RTCF_LOCAL</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_type</span>	<span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span>	<span class="o">=</span> <span class="n">tos</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_dst</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_src</span>	<span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">=</span> <span class="n">itag</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_iif</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_oif</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span>    <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_gateway</span>	<span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="o">=</span> <span class="n">spec_dst</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_UNREACHABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span><span class="o">=</span> <span class="n">ip_error</span><span class="p">;</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span><span class="o">=</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span> 	<span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTCF_LOCAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_iif</span><span class="p">,</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_intern_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_iif</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">no_route:</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_no_route</span><span class="p">);</span>
	<span class="n">spec_dst</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RT_SCOPE_UNIVERSE</span><span class="p">);</span>
	<span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTN_UNREACHABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">local_input</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Do not cache martian addresses: they should be logged (RFC1812)</span>
<span class="cm">	 */</span>
<span class="nl">martian_destination:</span>
	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_martian_dst</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_VERBOSE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IN_DEV_LOG_MARTIANS</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
		<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;martian destination %pI4 from %pI4, dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">daddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="nl">e_hostunreach:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">e_inval:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">e_nobufs:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">martian_source:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">martian_source_keep_err:</span>
	<span class="n">ip_handle_martian_source</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_route_input_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">tos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">noref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span>	<span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">hash</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iif</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_caching</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_cache</span><span class="p">;</span>

	<span class="n">tos</span> <span class="o">&amp;=</span> <span class="n">IPTOS_RT_MASK</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">iif</span><span class="p">,</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span> <span class="n">rth</span><span class="p">;</span>
	     <span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">daddr</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">^</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">saddr</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">^</span> <span class="n">iif</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span> <span class="o">^</span> <span class="n">tos</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span> <span class="o">==</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span> <span class="o">&amp;&amp;</span>
		    <span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipv4_validate_peer</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">noref</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst_use_noref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
				<span class="n">skb_dst_set_noref</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dst_use</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
				<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_hit</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">in_hlist_search</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">skip_cache:</span>
	<span class="cm">/* Multicast recognition logic is moved from route cache to here.</span>
<span class="cm">	   The problem was that too many Ethernet cards have broken/missing</span>
<span class="cm">	   hardware multicast filters :-( As result the host on multicasting</span>
<span class="cm">	   network acquires a lot of useless route cache entries, sort of</span>
<span class="cm">	   SDR messages from all the world. Now we try to get rid of them.</span>
<span class="cm">	   Really, provided software IP multicast filter is organized</span>
<span class="cm">	   reasonably (at least, hashed), it does not result in a slowdown</span>
<span class="cm">	   comparing with route cache reject entries.</span>
<span class="cm">	   Note, that multicast routers are not affected, because</span>
<span class="cm">	   route cache entry is created eventually.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">daddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">our</span> <span class="o">=</span> <span class="n">ip_check_mc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span>
						  <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">our</span>
<span class="cp">#ifdef CONFIG_IP_MROUTE</span>
				<span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">daddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">IN_DEV_MFORWARD</span><span class="p">(</span><span class="n">in_dev</span><span class="p">))</span>
<span class="cp">#endif</span>
			   <span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ip_route_input_mc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span>
							    <span class="n">tos</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">our</span><span class="p">);</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ip_route_input_slow</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ip_route_input_common</span><span class="p">);</span>

<span class="cm">/* called with rcu_read_lock() */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">__mkroute_output</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fib_result</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
				       <span class="n">__be32</span> <span class="n">orig_daddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">orig_saddr</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">orig_oif</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">orig_rtos</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_out</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">RTN_BROADCAST</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">RTN_MULTICAST</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>

	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_BROADCAST</span> <span class="o">|</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_MULTICAST</span> <span class="o">|</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_check_mc_rcu</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				     <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_proto</span><span class="p">))</span>
			<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTCF_LOCAL</span><span class="p">;</span>
		<span class="cm">/* If multicast route do not exist use</span>
<span class="cm">		 * default one, but do not gateway in this case.</span>
<span class="cm">		 * Yes, it is hack.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fi</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">prefixlen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_dst_alloc</span><span class="p">(</span><span class="n">dev_out</span><span class="p">,</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOPOLICY</span><span class="p">),</span>
			   <span class="n">IN_DEV_CONF_GET</span><span class="p">(</span><span class="n">in_dev</span><span class="p">,</span> <span class="n">NOXFRM</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rth</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">ip_output</span><span class="p">;</span>

	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span>	<span class="o">=</span> <span class="n">orig_daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span>	<span class="o">=</span> <span class="n">orig_saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev_out</span><span class="p">));</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_flags</span>	<span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_type</span>	<span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span>	<span class="o">=</span> <span class="n">orig_rtos</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_dst</span>	<span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_src</span>	<span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_iif</span>	<span class="o">=</span> <span class="n">orig_oif</span> <span class="o">?</span> <span class="o">:</span> <span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_oif</span>	<span class="o">=</span> <span class="n">orig_oif</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span>    <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_mark</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_peer_genid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rth</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">out_slow_tot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RTCF_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ip_local_deliver</span><span class="p">;</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_BROADCAST</span> <span class="o">|</span> <span class="n">RTCF_MULTICAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RTCF_LOCAL</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">ip_mc_output</span><span class="p">;</span>
			<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">out_slow_mc</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IP_MROUTE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IN_DEV_MFORWARD</span><span class="p">(</span><span class="n">in_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ip_mr_input</span><span class="p">;</span>
				<span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">ip_mc_output</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">rt_set_nexthop</span><span class="p">(</span><span class="n">rth</span><span class="p">,</span> <span class="n">fl4</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Major route resolver routine.</span>
<span class="cm"> * called with rcu_read_lock();</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">ip_route_output_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tos</span> <span class="o">=</span> <span class="n">RT_FL_TOS</span><span class="p">(</span><span class="n">fl4</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib_result</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">orig_daddr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">orig_saddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_oif</span><span class="p">;</span>

	<span class="n">res</span><span class="p">.</span><span class="n">fi</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_MULTIPLE_TABLES</span>
	<span class="n">res</span><span class="p">.</span><span class="n">r</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">orig_daddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">orig_saddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
	<span class="n">orig_oif</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">;</span>

	<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_iif</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_tos</span> <span class="o">=</span> <span class="n">tos</span> <span class="o">&amp;</span> <span class="n">IPTOS_RT_MASK</span><span class="p">;</span>
	<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_scope</span> <span class="o">=</span> <span class="p">((</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">RTO_ONLINK</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">RT_SCOPE_LINK</span> <span class="o">:</span> <span class="n">RT_SCOPE_UNIVERSE</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ipv4_is_zeronet</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* I removed check for oif == dev_out-&gt;oif here.</span>
<span class="cm">		   It was wrong for two reasons:</span>
<span class="cm">		   1. ip_dev_find(net, saddr) can return wrong iface, if saddr</span>
<span class="cm">		      is assigned to multiple interfaces.</span>
<span class="cm">		   2. Moreover, we are allowed to send packets with saddr</span>
<span class="cm">		      of another iface. --ANK</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* It is equivalent to inet_addr_type(saddr) == RTN_LOCAL */</span>
			<span class="n">dev_out</span> <span class="o">=</span> <span class="n">__ip_dev_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/* Special hack: user can direct multicasts</span>
<span class="cm">			   and limited broadcast via necessary interface</span>
<span class="cm">			   without fiddling with IP_MULTICAST_IF or IP_PKTINFO.</span>
<span class="cm">			   This hack is not just for fun, it allows</span>
<span class="cm">			   vic,vat and friends to work.</span>
<span class="cm">			   They bind socket to loopback, set ttl to zero</span>
<span class="cm">			   and expect that it will work.</span>
<span class="cm">			   From the viewpoint of routing cache they are broken,</span>
<span class="cm">			   because we are not allowed to build multicast path</span>
<span class="cm">			   with loopback source addr (look, routing cache</span>
<span class="cm">			   cannot know, that ttl is zero, so that packet</span>
<span class="cm">			   will not leave this host and route is valid).</span>
<span class="cm">			   Luckily, this hack is good workaround.</span>
<span class="cm">			 */</span>

			<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">make_route</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_flags</span> <span class="o">&amp;</span> <span class="n">FLOWI_FLAG_ANYSRC</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* It is equivalent to inet_addr_type(saddr) == RTN_LOCAL */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ip_dev_find</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_out</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">);</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* RACE: Check return value of inet_select_addr instead. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev_out</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rth</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ipv4_is_lbcast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							      <span class="n">RT_SCOPE_LINK</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">make_route</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							      <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_scope</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							      <span class="n">RT_SCOPE_HOST</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span>
			<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_LOOPBACK</span><span class="p">);</span>
		<span class="n">dev_out</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="p">;</span>
		<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTN_LOCAL</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">make_route</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fib_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fl4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span><span class="p">.</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Apparently, routing tables are wrong. Assume,</span>
<span class="cm">			   that the destination is on link.</span>

<span class="cm">			   WHY? DW.</span>
<span class="cm">			   Because we are allowed to send to iface</span>
<span class="cm">			   even if it has NO routes and NO assigned</span>
<span class="cm">			   addresses. When oif is specified, routing</span>
<span class="cm">			   tables are looked up with only one purpose:</span>
<span class="cm">			   to catch if destination is gatewayed, rather than</span>
<span class="cm">			   direct. Moreover, if MSG_DONTROUTE is set,</span>
<span class="cm">			   we send packet, ignoring both routing tables</span>
<span class="cm">			   and ifaddr state. --ANK</span>


<span class="cm">			   We could make it even if oif is unknown,</span>
<span class="cm">			   likely IPv6, but we do not.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">inet_select_addr</span><span class="p">(</span><span class="n">dev_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							      <span class="n">RT_SCOPE_LINK</span><span class="p">);</span>
			<span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTN_UNICAST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">make_route</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_prefsrc</span><span class="p">)</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_prefsrc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_out</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">loopback_dev</span><span class="p">;</span>
		<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
		<span class="n">res</span><span class="p">.</span><span class="n">fi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">RTCF_LOCAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">make_route</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_MULTIPATH</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_nhs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fib_select_multipath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">prefixlen</span> <span class="o">&amp;&amp;</span>
	    <span class="n">res</span><span class="p">.</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb_num_default</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">res</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTN_UNICAST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">)</span>
		<span class="n">fib_select_default</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span>
		<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">FIB_RES_PREFSRC</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="n">dev_out</span> <span class="o">=</span> <span class="n">FIB_RES_DEV</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">fl4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">dev_out</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>


<span class="nl">make_route:</span>
	<span class="n">rth</span> <span class="o">=</span> <span class="n">__mkroute_output</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">fl4</span><span class="p">,</span> <span class="n">orig_daddr</span><span class="p">,</span> <span class="n">orig_saddr</span><span class="p">,</span> <span class="n">orig_oif</span><span class="p">,</span>
			       <span class="n">tos</span><span class="p">,</span> <span class="n">dev_out</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

		<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">orig_daddr</span><span class="p">,</span> <span class="n">orig_saddr</span><span class="p">,</span> <span class="n">orig_oif</span><span class="p">,</span>
			       <span class="n">rt_genid</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev_out</span><span class="p">)));</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">rt_intern_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">orig_oif</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">__ip_route_output_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">flp4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_caching</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">slow_output</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">rt_hash</span><span class="p">(</span><span class="n">flp4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span><span class="p">,</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>

	<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">hash</span><span class="p">].</span><span class="n">chain</span><span class="p">);</span> <span class="n">rth</span><span class="p">;</span>
		<span class="n">rth</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">==</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">==</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rt_is_output_route</span><span class="p">(</span><span class="n">rth</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_oif</span> <span class="o">==</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">flowi4_oif</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_mark</span> <span class="o">==</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">flowi4_mark</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span> <span class="o">^</span> <span class="n">flp4</span><span class="o">-&gt;</span><span class="n">flowi4_tos</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">IPTOS_RT_MASK</span> <span class="o">|</span> <span class="n">RTO_ONLINK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipv4_validate_peer</span><span class="p">(</span><span class="n">rth</span><span class="p">);</span>
			<span class="n">dst_use</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">out_hit</span><span class="p">);</span>
			<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp4</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span>
				<span class="n">flp4</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp4</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span>
				<span class="n">flp4</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">rth</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rth</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RT_CACHE_STAT_INC</span><span class="p">(</span><span class="n">out_hlist_search</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>

<span class="nl">slow_output:</span>
	<span class="k">return</span> <span class="n">ip_route_output_slow</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">flp4</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__ip_route_output_key</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">ipv4_blackhole_dst_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ipv4_blackhole_mtu</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_MTU</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mtu</span> <span class="o">?</span> <span class="o">:</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipv4_rt_blackhole_update_pmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">ipv4_rt_blackhole_cow_metrics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_ops</span> <span class="n">ipv4_dst_blackhole_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>			<span class="o">=</span>	<span class="n">AF_INET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span>		<span class="o">=</span>	<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">),</span>
	<span class="p">.</span><span class="n">destroy</span>		<span class="o">=</span>	<span class="n">ipv4_dst_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check</span>			<span class="o">=</span>	<span class="n">ipv4_blackhole_dst_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtu</span>			<span class="o">=</span>	<span class="n">ipv4_blackhole_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_advmss</span>		<span class="o">=</span>	<span class="n">ipv4_default_advmss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_pmtu</span>		<span class="o">=</span>	<span class="n">ipv4_rt_blackhole_update_pmtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cow_metrics</span>		<span class="o">=</span>	<span class="n">ipv4_rt_blackhole_cow_metrics</span><span class="p">,</span>
	<span class="p">.</span><span class="n">neigh_lookup</span>		<span class="o">=</span>	<span class="n">ipv4_neigh_lookup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">ipv4_blackhole_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst_orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">dst_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_blackhole_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">ort</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_orig</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

		<span class="n">new</span><span class="o">-&gt;</span><span class="n">__use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">dst_discard</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">dst_discard</span><span class="p">;</span>
		<span class="n">dst_copy_metrics</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ort</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

		<span class="n">new</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">dev_hold</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_key_dst</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_route_iif</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_iif</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_iif</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_oif</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_oif</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_mark</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_mark</span><span class="p">;</span>

		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_genid</span> <span class="o">=</span> <span class="n">rt_genid</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_flags</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_type</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_type</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_src</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span> <span class="o">=</span> <span class="n">ort</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">fib_clntref</span><span class="p">);</span>

		<span class="n">dst_free</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dst_release</span><span class="p">(</span><span class="n">dst_orig</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rt</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">:</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">ip_route_output_flow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">flp4</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">__ip_route_output_key</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">flp4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp4</span><span class="o">-&gt;</span><span class="n">flowi4_proto</span><span class="p">)</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">xfrm_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
						   <span class="n">flowi4_to_flowi</span><span class="p">(</span><span class="n">flp4</span><span class="p">),</span>
						   <span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ip_route_output_flow</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nowait</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtmsg</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tsage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">nlh</span> <span class="o">=</span> <span class="n">nlmsg_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_family</span>	 <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_dst_len</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_src_len</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_tos</span>	<span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_tos</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_table</span>	<span class="o">=</span> <span class="n">RT_TABLE_MAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_TABLE</span><span class="p">,</span> <span class="n">RT_TABLE_MAIN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_type</span>	<span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_type</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_scope</span>	<span class="o">=</span> <span class="n">RT_SCOPE_UNIVERSE</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_protocol</span> <span class="o">=</span> <span class="n">RTPROT_UNSPEC</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_flags</span>	<span class="o">=</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">RTM_F_CLONED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="n">RTCF_NOTIFY</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_flags</span> <span class="o">|=</span> <span class="n">RTM_F_NOTIFY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_DST</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rtm_src_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_SRC</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_OIF</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_FLOW</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">tclassid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_input_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_PREFSRC</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_spec_dst</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_src</span> <span class="o">!=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_key_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_PREFSRC</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span> <span class="o">!=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_GATEWAY</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtnetlink_put_metrics</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dst_metrics_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_mark</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put_be32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_MARK</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inet_peer_refcheck</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ip_id_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts</span><span class="p">;</span>
			<span class="n">tsage</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">tcp_ts_stamp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expires</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pmtu_expires</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expires</span><span class="p">))</span>
				<span class="n">expires</span> <span class="o">-=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_input_route</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MROUTE</span>
		<span class="n">__be32</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_multicast</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipv4_is_local_multicast</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">IPV4_DEVCONF_ALL</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">MC_FORWARDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">ipmr_get_route</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
						 <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">,</span>
						 <span class="n">r</span><span class="p">,</span> <span class="n">nowait</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowait</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RTA_IIF</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_iif</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtnl_put_cacheinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tsage</span><span class="p">,</span>
			       <span class="n">expires</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nlmsg_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nlh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_rtm_getroute</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">in_skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">nlh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">in_skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtmsg</span> <span class="o">*</span><span class="n">rtm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mark</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nlmsg_parse</span><span class="p">(</span><span class="n">nlh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtm</span><span class="p">),</span> <span class="n">tb</span><span class="p">,</span> <span class="n">RTA_MAX</span><span class="p">,</span> <span class="n">rtm_ipv4_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">rtm</span> <span class="o">=</span> <span class="n">nlmsg_data</span><span class="p">(</span><span class="n">nlh</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">NLMSG_GOODSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reserve room for dummy headers, this skb can pass</span>
<span class="cm">	   through good chunk of routing engine.</span>
<span class="cm">	 */</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Bugfix: need to give ip_route_input enough of an IP header to not gag. */</span>
	<span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_ICMP</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">MAX_HEADER</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">));</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">RTA_SRC</span><span class="p">]</span> <span class="o">?</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_SRC</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">RTA_DST</span><span class="p">]</span> <span class="o">?</span> <span class="n">nla_get_be32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_DST</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iif</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">RTA_IIF</span><span class="p">]</span> <span class="o">?</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_IIF</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">RTA_MARK</span><span class="p">]</span> <span class="o">?</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_MARK</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">iif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">errout_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span>	<span class="o">=</span> <span class="n">mark</span><span class="p">;</span>
		<span class="n">local_bh_disable</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip_route_input</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">rtm</span><span class="o">-&gt;</span><span class="n">rtm_tos</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">local_bh_enable</span><span class="p">();</span>

		<span class="n">rt</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dst</span><span class="p">,</span>
			<span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">src</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flowi4_tos</span> <span class="o">=</span> <span class="n">rtm</span><span class="o">-&gt;</span><span class="n">rtm_tos</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flowi4_oif</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="n">RTA_OIF</span><span class="p">]</span> <span class="o">?</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">RTA_OIF</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flowi4_mark</span> <span class="o">=</span> <span class="n">mark</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_key</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl4</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_free</span><span class="p">;</span>

	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtm</span><span class="o">-&gt;</span><span class="n">rtm_flags</span> <span class="o">&amp;</span> <span class="n">RTM_F_NOTIFY</span><span class="p">)</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">|=</span> <span class="n">RTCF_NOTIFY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rt_fill_info</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">in_skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span>
			   <span class="n">RTM_NEWROUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtnl_unicast</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">in_skb</span><span class="p">).</span><span class="n">pid</span><span class="p">);</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">errout_free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_rt_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="n">s_h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

	<span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">s_h</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s_h</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">s_h</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="n">rt_hash_mask</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">,</span> <span class="n">s_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">h</span><span class="p">].</span><span class="n">chain</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rt</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">[</span><span class="n">h</span><span class="p">].</span><span class="n">chain</span><span class="p">),</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rt</span><span class="p">;</span>
		     <span class="n">rt</span> <span class="o">=</span> <span class="n">rcu_dereference_bh</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt_next</span><span class="p">),</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">net</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s_idx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt_is_expired</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">skb_dst_set_noref</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt_fill_info</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">NETLINK_CB</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span>
					 <span class="n">cb</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span><span class="p">,</span> <span class="n">RTM_NEWROUTE</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">,</span> <span class="n">NLM_F_MULTI</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ip_rt_multicast_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt_cache_flush</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipv4_sysctl_rtcache_flush</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">__ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flush_delay</span><span class="p">;</span>
		<span class="n">ctl_table</span> <span class="n">ctl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">__ctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctl</span><span class="p">));</span>
		<span class="n">ctl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flush_delay</span><span class="p">;</span>
		<span class="n">proc_dointvec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>

		<span class="n">net</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">)</span><span class="n">__ctl</span><span class="o">-&gt;</span><span class="n">extra1</span><span class="p">;</span>
		<span class="n">rt_cache_flush</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">flush_delay</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">ipv4_route_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_thresh&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;max_size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_max_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/*  Deprecated. Use gc_min_interval_ms */</span>

		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_min_interval&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_gc_min_interval</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_min_interval_ms&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_gc_min_interval</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_ms_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_timeout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_gc_timeout</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_interval&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_gc_interval</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;redirect_load&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_redirect_load</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;redirect_number&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_redirect_number</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;redirect_silence&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_redirect_silence</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;error_cost&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_error_cost</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;error_burst&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_error_burst</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;gc_elasticity&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_gc_elasticity</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;mtu_expires&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_mtu_expires</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_jiffies</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;min_pmtu&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_min_pmtu</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;min_adv_mss&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_rt_min_advmss</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">ipv4_route_flush_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;flush&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">ipv4_sysctl_rtcache_flush</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">sysctl_route_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctl_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">ipv4_route_flush_table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ipv4_route_flush_table</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_dup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extra1</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">route_hdr</span> <span class="o">=</span> <span class="n">register_net_sysctl</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;net/ipv4/route&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">route_hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_reg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">!=</span> <span class="n">ipv4_route_flush_table</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
<span class="nl">err_dup:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_exit</span> <span class="kt">void</span> <span class="nf">sysctl_route_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctl_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">route_hdr</span><span class="o">-&gt;</span><span class="n">ctl_table_arg</span><span class="p">;</span>
	<span class="n">unregister_net_sysctl_table</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">route_hdr</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tbl</span> <span class="o">==</span> <span class="n">ipv4_route_flush_table</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_initdata</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">sysctl_route_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">sysctl_route_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">sysctl_route_net_exit</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">rt_genid_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">rt_genid</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">rt_genid</span><span class="p">));</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">dev_addr_genid</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">dev_addr_genid</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_initdata</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">rt_genid_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">rt_genid_init</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
<span class="k">struct</span> <span class="n">ip_rt_acct</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">ip_rt_acct</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IP_ROUTE_CLASSID */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rhash_entries</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_rhash_entries</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rhash_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;rhash_entries=&quot;</span><span class="p">,</span> <span class="n">set_rhash_entries</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ip_rt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">ip_rt_acct</span> <span class="o">=</span> <span class="n">__alloc_percpu</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_rt_acct</span><span class="p">),</span> <span class="n">__alignof__</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_rt_acct</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_rt_acct</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IP: failed to allocate ip_rt_acct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">kmem_cachep</span> <span class="o">=</span>
		<span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ip_dst_cache&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">SLAB_HWCACHE_ALIGN</span><span class="o">|</span><span class="n">SLAB_PANIC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ipv4_dst_blackhole_ops</span><span class="p">.</span><span class="n">kmem_cachep</span> <span class="o">=</span> <span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">kmem_cachep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_entries_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IP: failed to allocate ipv4_dst_ops counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_entries_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv4_dst_blackhole_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IP: failed to allocate ipv4_dst_blackhole_ops counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rt_hash_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_hash_bucket</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">alloc_large_system_hash</span><span class="p">(</span><span class="s">&quot;IP route cache&quot;</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_hash_bucket</span><span class="p">),</span>
					<span class="n">rhash_entries</span><span class="p">,</span>
					<span class="p">(</span><span class="n">totalram_pages</span> <span class="o">&gt;=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">?</span>
					<span class="mi">15</span> <span class="o">:</span> <span class="mi">17</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rt_hash_log</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rt_hash_mask</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="n">rhash_entries</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rt_hash_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_hash_bucket</span><span class="p">));</span>
	<span class="n">rt_hash_lock_init</span><span class="p">();</span>

	<span class="n">ipv4_dst_ops</span><span class="p">.</span><span class="n">gc_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ip_rt_max_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt_hash_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">devinet_init</span><span class="p">();</span>
	<span class="n">ip_fib_init</span><span class="p">();</span>

	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expires_work</span><span class="p">,</span> <span class="n">rt_worker_func</span><span class="p">);</span>
	<span class="n">expires_ljiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expires_work</span><span class="p">,</span>
		<span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">ip_rt_gc_interval</span> <span class="o">+</span> <span class="n">ip_rt_gc_interval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip_rt_proc_init</span><span class="p">())</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to create route proc files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="n">xfrm_init</span><span class="p">();</span>
	<span class="n">xfrm4_init</span><span class="p">(</span><span class="n">ip_rt_max_size</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">rtnl_register</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">RTM_GETROUTE</span><span class="p">,</span> <span class="n">inet_rtm_getroute</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysctl_route_ops</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt_genid_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="cm">/*</span>
<span class="cm"> * We really need to sanitize the damn ipv4 init order, then all</span>
<span class="cm"> * this nonsense will go away.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ip_static_sysctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_net_sysctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;net/ipv4/route&quot;</span><span class="p">,</span> <span class="n">ipv4_route_table</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
