<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › svcsock.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>svcsock.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/net/sunrpc/svcsock.c</span>
<span class="cm"> *</span>
<span class="cm"> * These are the RPC server socket internals.</span>
<span class="cm"> *</span>
<span class="cm"> * The server scheduling algorithm does not always distribute the load</span>
<span class="cm"> * evenly when servicing a single client. May need to modify the</span>
<span class="cm"> * svc_xprt_enqueue procedure...</span>
<span class="cm"> *</span>
<span class="cm"> * TCP support is largely untested and may be a little slow. The problem</span>
<span class="cm"> * is that we currently do two separate recvfrom&#39;s, one for the 4-byte</span>
<span class="cm"> * record length, and the second for the actual record. This could possibly</span>
<span class="cm"> * be improved by always reading a minimum size of around 100 bytes and</span>
<span class="cm"> * tucking any superfluous bytes away in a temporary store. Still, that</span>
<span class="cm"> * leaves write requests out in the rain. An alternative may be to peek at</span>
<span class="cm"> * the first skb in the queue, and if it matches the next TCP sequence</span>
<span class="cm"> * number, to extract the record marker. Yuck.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/tcp_states.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/ioctls.h&gt;</span>

<span class="cp">#include &lt;linux/sunrpc/types.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xdr.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/msg_prot.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svcsock.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/stats.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprt.h&gt;</span>

<span class="cp">#include &quot;sunrpc.h&quot;</span>

<span class="cp">#define RPCDBG_FACILITY	RPCDBG_SVCXPRT</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svc_setup_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">svc_udp_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">svc_udp_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">svc_udp_sendto</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">svc_sock_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">svc_tcp_sock_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">svc_sock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">svc_create_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">,</span>
					  <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">svc_bc_create_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">,</span>
					     <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">svc_bc_sock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_DEBUG_LOCK_ALLOC</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">svc_key</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">svc_slock_key</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_reclassify_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">sock_lock_init_class_and_name</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;slock-AF_INET-NFSD&quot;</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">svc_slock_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="s">&quot;sk_xprt.xpt_lock-AF_INET-NFSD&quot;</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">svc_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">sock_lock_init_class_and_name</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;slock-AF_INET6-NFSD&quot;</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">svc_slock_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="s">&quot;sk_xprt.xpt_lock-AF_INET6-NFSD&quot;</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">svc_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_reclassify_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Release an skbuff after use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_release_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_ctxt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_ctxt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: service %p, releasing skb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_free_datagram_locked</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">svc_pktinfo_u</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_pktinfo</span> <span class="n">pkti</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_pktinfo</span> <span class="n">pkti6</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define SVC_PKTINFO_SPACE \</span>
<span class="cp">	CMSG_SPACE(sizeof(union svc_pktinfo_u))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_set_cmsg_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">in_pktinfo</span> <span class="o">*</span><span class="n">pki</span> <span class="o">=</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmh</span><span class="p">);</span>

			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_IP</span><span class="p">;</span>
			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">IP_PKTINFO</span><span class="p">;</span>
			<span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi_ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi_spec_dst</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span>
				 <span class="n">svc_daddr_in</span><span class="p">(</span><span class="n">rqstp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pki</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">in6_pktinfo</span> <span class="o">*</span><span class="n">pki</span> <span class="o">=</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmh</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">svc_daddr_in6</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>

			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_IPV6</span><span class="p">;</span>
			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">IPV6_PKTINFO</span><span class="p">;</span>
			<span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi6_ifindex</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span><span class="p">;</span>
			<span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi6_addr</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
			<span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pki</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send routine intended to be shared by the fore- and back-channel</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">svc_send_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_buf</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">headpage</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">headoffset</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tailpage</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tailoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>	<span class="o">**</span><span class="n">ppage</span> <span class="o">=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">size_t</span>		<span class="n">base</span> <span class="o">=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">page_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">pglen</span> <span class="o">=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span> <span class="o">=</span> <span class="n">MSG_MORE</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">slen</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">slen</span> <span class="o">=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* send head */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">kernel_sendpage</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">headpage</span><span class="p">,</span> <span class="n">headoffset</span><span class="p">,</span>
				  <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">slen</span> <span class="o">-=</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* send page data */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="n">pglen</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">base</span> <span class="o">:</span> <span class="n">pglen</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pglen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">kernel_sendpage</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">ppage</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">slen</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">pglen</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;</span> <span class="n">pglen</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">pglen</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ppage</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send tail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xdr</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">kernel_sendpage</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">tailpage</span><span class="p">,</span> <span class="n">tailoffset</span><span class="p">,</span>
				   <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Generic sendto routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_sendto</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_buf</span> <span class="o">*</span><span class="n">xdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">socket</span>	<span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmsghdr</span>	<span class="n">hdr</span><span class="p">;</span>
		<span class="kt">long</span>		<span class="n">all</span><span class="p">[</span><span class="n">SVC_PKTINFO_SPACE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
	<span class="p">}</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tailoff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">headoff</span><span class="p">;</span>
	<span class="n">RPC_IFDEBUG</span><span class="p">(</span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">RPC_MAX_ADDRBUFLEN</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_prot</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">msg_name</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">msg_namelen</span>	<span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_addrlen</span><span class="p">,</span>
			<span class="p">.</span><span class="n">msg_control</span>	<span class="o">=</span> <span class="n">cmh</span><span class="p">,</span>
			<span class="p">.</span><span class="n">msg_controllen</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
			<span class="p">.</span><span class="n">msg_flags</span>	<span class="o">=</span> <span class="n">MSG_MORE</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="n">svc_set_cmsg_data</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cmh</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sock_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tailoff</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xdr</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">headoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svc_send_common</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">xdr</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">headoff</span><span class="p">,</span>
			       <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tailoff</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p sendto([%p %Zu... ], %d) = %d (addr %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">svsk</span><span class="p">,</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">xdr</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span>
		<span class="n">xdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">svc_print_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Report socket names for nfsdfs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_one_sock_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remaining</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proto_name</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span> <span class="o">?</span>
							<span class="s">&quot;udp&quot;</span> <span class="o">:</span> <span class="s">&quot;tcp&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PF_INET</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="s">&quot;ipv4 %s %pI4 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proto_name</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_rcv_saddr</span><span class="p">,</span>
				<span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PF_INET6</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="s">&quot;ipv6 %s %pI6 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">proto_name</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rcv_saddr</span><span class="p">,</span>
				<span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="s">&quot;*unknown-%d*</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * svc_sock_names - construct a list of listener names in a string</span>
<span class="cm"> * @serv: pointer to RPC service</span>
<span class="cm"> * @buf: pointer to a buffer to fill in with socket names</span>
<span class="cm"> * @buflen: size of the buffer to be filled</span>
<span class="cm"> * @toclose: pointer to &#39;\0&#39;-terminated C string containing the name</span>
<span class="cm"> *		of a listener to be closed</span>
<span class="cm"> *</span>
<span class="cm"> * Fills in @buf with a &#39;\n&#39;-separated list of names of listener</span>
<span class="cm"> * sockets.  If @toclose is not NULL, the socket named by @toclose</span>
<span class="cm"> * is closed, and is not included in the output list.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns positive length of the socket name string, or a negative</span>
<span class="cm"> * errno value on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">svc_sock_names</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toclose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="o">*</span><span class="n">closesk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_permsocks</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">onelen</span> <span class="o">=</span> <span class="n">svc_one_sock_name</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buflen</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onelen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">onelen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toclose</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">toclose</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">closesk</span> <span class="o">=</span> <span class="n">svsk</span><span class="p">;</span>
			<span class="n">svc_xprt_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">closesk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">onelen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">closesk</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Should unregister with portmap, but you cannot</span>
<span class="cm">		 * unregister just one protocol...</span>
<span class="cm">		 */</span>
		<span class="n">svc_close_xprt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">closesk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
		<span class="n">svc_xprt_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">closesk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">toclose</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">svc_sock_names</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Check input queue length</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_recv_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span>	<span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">avail</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_sock_ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">TIOCINQ</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="n">avail</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic recvfrom routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">msg_flags</span>	<span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_hlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">kernel_recvmsg</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
				<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p recvfrom(%p, %Zu) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">svsk</span><span class="p">,</span> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_partial_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">save_iovlen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">save_iovbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">svc_recvfrom</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">&gt;</span> <span class="n">base</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">-=</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">save_iovlen</span> <span class="o">=</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">save_iovbase</span> <span class="o">=</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">-=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">svc_recvfrom</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nr</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">save_iovlen</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">save_iovbase</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set socket snd and rcv buffer lengths</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_sock_setbufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	mm_segment_t	oldfs;</span>
<span class="c">	oldfs = get_fs(); set_fs(KERNEL_DS);</span>
<span class="c">	sock_setsockopt(sock, SOL_SOCKET, SO_SNDBUF,</span>
<span class="c">			(char*)&amp;snd, sizeof(snd));</span>
<span class="c">	sock_setsockopt(sock, SOL_SOCKET, SO_RCVBUF,</span>
<span class="c">			(char*)&amp;rcv, sizeof(rcv));</span>
<span class="cp">#else</span>
	<span class="cm">/* sock_setsockopt limits use to sysctl_?mem_max,</span>
<span class="cm">	 * which isn&#39;t acceptable.  Until that is made conditional</span>
<span class="cm">	 * on not having CAP_SYS_RESOURCE or similar, we go direct...</span>
<span class="cm">	 * DaveM said I could!</span>
<span class="cm">	 */</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="n">snd</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">=</span> <span class="n">rcv</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * INET callback when data has been received on the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_udp_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p(inet %p), count=%d, busy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">svsk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">));</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * INET callback when space is newly available on the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="p">)(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">);</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p(inet %p), write_space busy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">svsk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">));</span>
		<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC svc_write_space: someone sleeping on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">svsk</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sk_stream_min_wspace</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">svc_write_space</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See net/ipv6/ip_sockglue.c : ip_cmsg_recv_pktinfo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_udp_get_dest_address4</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_pktinfo</span> <span class="o">*</span><span class="n">pki</span> <span class="o">=</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">svc_daddr_in</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">!=</span> <span class="n">IP_PKTINFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi_spec_dst</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See net/ipv6/datagram.c : datagram_recv_ctl</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_udp_get_dest_address6</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in6_pktinfo</span> <span class="o">*</span><span class="n">pki</span> <span class="o">=</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">svc_daddr_in6</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">!=</span> <span class="n">IPV6_PKTINFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi6_addr</span><span class="p">;</span>
	<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">=</span> <span class="n">pki</span><span class="o">-&gt;</span><span class="n">ipi6_ifindex</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy the UDP datagram&#39;s destination address to the rqstp structure.</span>
<span class="cm"> * The &#39;destination&#39; address in this case is the address to which the</span>
<span class="cm"> * peer sent the datagram, i.e. our local address. For multihomed</span>
<span class="cm"> * hosts, this can change from msg to msg. Note that only the IP</span>
<span class="cm"> * address changes, the port number should remain the same.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_udp_get_dest_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOL_IP</span>:
		<span class="k">return</span> <span class="n">svc_udp_get_dest_address4</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cmh</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SOL_IPV6</span>:
		<span class="k">return</span> <span class="n">svc_udp_get_dest_address6</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cmh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive a datagram from a UDP socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_udp_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>	<span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmsghdr</span>	<span class="n">hdr</span><span class="p">;</span>
		<span class="kt">long</span>		<span class="n">all</span><span class="p">[</span><span class="n">SVC_PKTINFO_SPACE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
	<span class="p">}</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">),</span>
		<span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">cmh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
		<span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">XPT_CHNGBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">))</span>
	    <span class="cm">/* udp sockets need large rcvbuf as all pending</span>
<span class="cm">	     * requests are still in that buffer.  sndbuf must</span>
<span class="cm">	     * also be large enough that there is enough space</span>
<span class="cm">	     * for one reply per thread.  We count all threads</span>
<span class="cm">	     * rather than threads in a particular pool, which</span>
<span class="cm">	     * provides an upper bound on the number of threads</span>
<span class="cm">	     * which will access the socket.</span>
<span class="cm">	     */</span>
	    <span class="n">svc_sock_setbufsize</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span>
				<span class="p">(</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_nrthreads</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">,</span>
				<span class="p">(</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_nrthreads</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_recvmsg</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSG_PEEK</span> <span class="o">|</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* possibly an icmp error */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: recvfrom returned error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svc_addr_len</span><span class="p">(</span><span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_addrlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">.</span><span class="n">tv64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>
		<span class="cm">/* Don&#39;t enable netstamp, sunrpc doesn&#39;t</span>
<span class="cm">		   need that much accuracy */</span>
	<span class="p">}</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="o">-&gt;</span><span class="n">sk_stamp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span> <span class="cm">/* there may be more data... */</span>

	<span class="n">len</span>  <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_prot</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svc_udp_get_dest_address</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">cmh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;svc: received unknown control message %d/%d; dropping RPC reply datagram</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmh</span><span class="o">-&gt;</span><span class="n">cmsg_type</span><span class="p">);</span>
		<span class="n">skb_free_datagram_locked</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_daddrlen</span> <span class="o">=</span> <span class="n">svc_addr_len</span><span class="p">(</span><span class="n">svc_daddr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we have to copy */</span>
		<span class="n">local_bh_disable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csum_partial_copy_to_xdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">local_bh_enable</span><span class="p">();</span>
			<span class="cm">/* checksum error */</span>
			<span class="n">skb_free_datagram_locked</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local_bh_enable</span><span class="p">();</span>
		<span class="n">skb_free_datagram_locked</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* we can use it in-place */</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_checksum_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_free_datagram_locked</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_ctxt</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="p">)</span>
		<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="o">-&gt;</span><span class="n">netudpcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">svc_udp_sendto</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">svc_sendto</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">)</span>
		<span class="cm">/* ICMP error on earlier request. */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">svc_sendto</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_udp_prep_reply_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_udp_has_wspace</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>	<span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">required</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the SOCK_NOSPACE flag before checking the available</span>
<span class="cm">	 * sock space.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">required</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_reserved</span><span class="p">)</span> <span class="o">+</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="o">*</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">sock_wspace</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_udp_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_udp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">salen</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">svc_create_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">salen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_ops</span> <span class="n">svc_udp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xpo_create</span> <span class="o">=</span> <span class="n">svc_udp_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_recvfrom</span> <span class="o">=</span> <span class="n">svc_udp_recvfrom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_sendto</span> <span class="o">=</span> <span class="n">svc_udp_sendto</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_release_rqst</span> <span class="o">=</span> <span class="n">svc_release_skb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_detach</span> <span class="o">=</span> <span class="n">svc_sock_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_free</span> <span class="o">=</span> <span class="n">svc_sock_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_prep_reply_hdr</span> <span class="o">=</span> <span class="n">svc_udp_prep_reply_hdr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_has_wspace</span> <span class="o">=</span> <span class="n">svc_udp_has_wspace</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_accept</span> <span class="o">=</span> <span class="n">svc_udp_accept</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_class</span> <span class="n">svc_udp_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xcl_name</span> <span class="o">=</span> <span class="s">&quot;udp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svc_udp_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_max_payload</span> <span class="o">=</span> <span class="n">RPCSVC_MAXPAYLOAD_UDP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_udp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">svc_xprt_init</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">svc_udp_class</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_CACHE_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span> <span class="o">=</span> <span class="n">svc_udp_data_ready</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span> <span class="o">=</span> <span class="n">svc_write_space</span><span class="p">;</span>

	<span class="cm">/* initialise setting must have enough space to</span>
<span class="cm">	 * receive and respond to one request.</span>
<span class="cm">	 * svc_udp_recvfrom will re-adjust if necessary</span>
<span class="cm">	 */</span>
	<span class="n">svc_sock_setbufsize</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span>
			    <span class="mi">3</span> <span class="o">*</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">,</span>
			    <span class="mi">3</span> <span class="o">*</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">);</span>

	<span class="cm">/* data might have come in before data_ready set up */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CHNGBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>

	<span class="cm">/* make sure we get destination address info */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">SOL_IP</span><span class="p">;</span>
		<span class="n">optname</span> <span class="o">=</span> <span class="n">IP_PKTINFO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">SOL_IPV6</span><span class="p">;</span>
		<span class="n">optname</span> <span class="o">=</span> <span class="n">IPV6_RECVPKTINFO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_setsockopt</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">one</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: kernel_setsockopt returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A data_ready event on a listening socket means there&#39;s a connection</span>
<span class="cm"> * pending. Do not use state_change as a substitute for it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_listen_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count_unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p TCP (listen) state change %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This callback may called twice when a new connection</span>
<span class="cm">	 * is established as a child socket inherits everything</span>
<span class="cm">	 * from a parent LISTEN socket.</span>
<span class="cm">	 * 1) data_ready method of the parent socket will be called</span>
<span class="cm">	 *    when one of child sockets become ESTABLISHED.</span>
<span class="cm">	 * 2) data_ready method of the child socket may be called</span>
<span class="cm">	 *    when it receives data before the socket is accepted.</span>
<span class="cm">	 * In case of 2, we should ignore it silently.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
			<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;svc: socket %p: no user data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A state change on a connected socket means it&#39;s dying or dead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p TCP (connected) state change %d (svsk %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svsk</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;svc: socket %p: no user data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: socket %p TCP data ready (svsk %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sk</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_user_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Accept a TCP connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_tcp_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span>	<span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>	<span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span>	<span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span>	<span class="o">*</span><span class="n">newsock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">newsvsk</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">err</span><span class="p">,</span> <span class="n">slen</span><span class="p">;</span>
	<span class="n">RPC_IFDEBUG</span><span class="p">(</span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">RPC_MAX_ADDRBUFLEN</span><span class="p">]);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: tcp_accept %p sock %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">svsk</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newsock</span><span class="p">,</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: no more sockets!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: accept failed (err %d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_getpeername</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;%s: peername failed (err %d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>		<span class="cm">/* aborted connection or whatever */</span>
	<span class="p">}</span>

	<span class="cm">/* Ideally, we would want to reject connections from unauthorized</span>
<span class="cm">	 * hosts here, but when we get encryption, the IP of the host won&#39;t</span>
<span class="cm">	 * tell us anything.  For now just warn about unpriv connections.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svc_port_is_privileged</span><span class="p">(</span><span class="n">sin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;%s: connect from unprivileged port: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span>
			<span class="n">__svc_print_addr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: connect from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span>
		<span class="n">__svc_print_addr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>

	<span class="cm">/* make sure that a write doesn&#39;t block forever when</span>
<span class="cm">	 * low on memory</span>
<span class="cm">	 */</span>
	<span class="n">newsock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">newsvsk</span> <span class="o">=</span> <span class="n">svc_setup_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">newsock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">SVC_SOCK_ANONYMOUS</span> <span class="o">|</span> <span class="n">SVC_SOCK_TEMPORARY</span><span class="p">))))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">svc_xprt_set_remote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newsvsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kernel_getsockname</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc_tcp_accept: kernel_getsockname error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="n">slen</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">,</span> <span class="n">sa_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">svc_xprt_set_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newsvsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="p">)</span>
		<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="o">-&gt;</span><span class="n">nettcpconn</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">newsvsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">sock_release</span><span class="p">(</span><span class="n">newsock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">svc_tcp_restore_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_save_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_clear_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive data.</span>
<span class="cm"> * If we haven&#39;t gotten the record length yet, get the next four bytes.</span>
<span class="cm"> * Otherwise try to gobble up as much as possible up to the complete</span>
<span class="cm"> * record length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_tcp_recv_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>	<span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">want</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvec</span>	<span class="n">iov</span><span class="p">;</span>

		<span class="n">want</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">)</span> <span class="o">-</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">)</span> <span class="o">+</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="n">want</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">svc_recvfrom</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">want</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: short recvfrom while reading record &quot;</span>
				<span class="s">&quot;length (%d of %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">&amp;</span> <span class="n">RPC_LAST_STREAM_FRAGMENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FIXME: technically, a record can be fragmented,</span>
<span class="cm">			 *  and non-terminal fragments will not have the top</span>
<span class="cm">			 *  bit set in the fragment length header.</span>
<span class="cm">			 *  But apparently no known nfs clients send fragmented</span>
<span class="cm">			 *  records. */</span>
			<span class="n">net_notice_ratelimited</span><span class="p">(</span><span class="s">&quot;RPC: multiple fragments per record not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_delete</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">&amp;=</span> <span class="n">RPC_FRAGMENT_SIZE_MASK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: TCP record, %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">&gt;</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">net_notice_ratelimited</span><span class="p">(</span><span class="s">&quot;RPC: fragment too large: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_delete</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_delete</span><span class="p">;</span> <span class="cm">/* client is nuts. */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: TCP recv_record got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">err_delete:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_cb_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">bc_xprt</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_bc_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">xid</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">calldir</span><span class="p">;</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">calldir</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc_xprt</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">xprt_lookup_rqst</span><span class="p">(</span><span class="n">bc_xprt</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;%s: Got unrecognized reply: &quot;</span>
			<span class="s">&quot;calldir 0x%x xpt_bc_xprt %p xid %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">calldir</span><span class="p">),</span>
			<span class="n">bc_xprt</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_private_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdr_buf</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX!: cheating for now!  Only copying HEAD.</span>
<span class="cm">	 * But we know this is good enough for now (in fact, for any</span>
<span class="cm">	 * callback reply in the forseeable future).</span>
<span class="cm">	 */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_private_buf</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span> <span class="cm">/* whatever; just giving up. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">xprt_complete_rqst</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="p">,</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_pages_to_kvecs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Receive data from a TCP socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_tcp_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>	<span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">vec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">want</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">calldir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pnum</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: tcp_recv %p data %d conn %d close %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">svsk</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">),</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">),</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">svc_tcp_recv_record</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">svc_tcp_restore_pages</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
	<span class="n">want</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">vec</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_vec</span><span class="p">;</span>

	<span class="n">pnum</span> <span class="o">=</span> <span class="n">copy_pages_to_kvecs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">pnum</span><span class="p">];</span>

	<span class="cm">/* Now receive data */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svc_partial_recvfrom</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_other</span><span class="p">;</span>
		<span class="n">svc_tcp_save_pages</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: incomplete TCP record (%d of %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span><span class="p">,</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_noclose</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_ctxt</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_prot</span>	      <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">calldir</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calldir</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">receive_cb_reply</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>

	<span class="cm">/* Reset TCP read info */</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* If we have more data, signal svc_xprt_enqueue() to try again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svc_recv_available</span><span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_fraghdr</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">svc_xprt_copy_addrs</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="p">)</span>
		<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_stats</span><span class="o">-&gt;</span><span class="n">nettcpcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: TCP complete record (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_other</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: TCP recvfrom got EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="nl">err_other:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: recvfrom returned errno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span> <span class="o">-</span><span class="n">len</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
<span class="nl">err_noclose:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>	<span class="cm">/* record not complete */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send out data on TCP socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_tcp_sendto</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="o">*</span><span class="n">xbufp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sent</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">reclen</span><span class="p">;</span>

	<span class="cm">/* Set up the first element of the reply kvec.</span>
<span class="cm">	 * Any other kvecs that may be in use have been taken</span>
<span class="cm">	 * care of by the server implementation itself.</span>
<span class="cm">	 */</span>
	<span class="n">reclen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0x80000000</span><span class="o">|</span><span class="p">((</span><span class="n">xbufp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">xbufp</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclen</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">svc_sendto</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">!=</span> <span class="n">xbufp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;rpc-srv/tcp: %s: %s %d when sending %d bytes &quot;</span>
		       <span class="s">&quot;- shutting down socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="o">-&gt;</span><span class="n">xpt_server</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">sent</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;got error&quot;</span><span class="o">:</span><span class="s">&quot;sent only&quot;</span><span class="p">,</span>
		       <span class="n">sent</span><span class="p">,</span> <span class="n">xbufp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">svc_xprt_enqueue</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">);</span>
		<span class="n">sent</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup response header. TCP has a 4B record length field.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_prep_reply_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">resv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_res</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* tcp needs a space for the record length... */</span>
	<span class="n">svc_putnl</span><span class="p">(</span><span class="n">resv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_tcp_has_wspace</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span>	<span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">required</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_LISTENER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">required</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_reserved</span><span class="p">)</span> <span class="o">+</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_wspace</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">required</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_tcp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">salen</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">svc_create_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">salen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">svc_bc_create_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">,</span>
					     <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">svc_bc_sock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_bc_tcp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">salen</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">svc_bc_create_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">salen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_bc_tcp_sock_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_ops</span> <span class="n">svc_tcp_bc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xpo_create</span> <span class="o">=</span> <span class="n">svc_bc_tcp_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_detach</span> <span class="o">=</span> <span class="n">svc_bc_tcp_sock_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_free</span> <span class="o">=</span> <span class="n">svc_bc_sock_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_prep_reply_hdr</span> <span class="o">=</span> <span class="n">svc_tcp_prep_reply_hdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_class</span> <span class="n">svc_tcp_bc_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xcl_name</span> <span class="o">=</span> <span class="s">&quot;tcp-bc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svc_tcp_bc_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_max_payload</span> <span class="o">=</span> <span class="n">RPCSVC_MAXPAYLOAD_TCP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_init_bc_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svc_reg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_tcp_bc_class</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_cleanup_bc_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svc_unreg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_tcp_bc_class</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_init_bc_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_cleanup_bc_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_ops</span> <span class="n">svc_tcp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xpo_create</span> <span class="o">=</span> <span class="n">svc_tcp_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_recvfrom</span> <span class="o">=</span> <span class="n">svc_tcp_recvfrom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_sendto</span> <span class="o">=</span> <span class="n">svc_tcp_sendto</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_release_rqst</span> <span class="o">=</span> <span class="n">svc_release_skb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_detach</span> <span class="o">=</span> <span class="n">svc_tcp_sock_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_free</span> <span class="o">=</span> <span class="n">svc_sock_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_prep_reply_hdr</span> <span class="o">=</span> <span class="n">svc_tcp_prep_reply_hdr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_has_wspace</span> <span class="o">=</span> <span class="n">svc_tcp_has_wspace</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpo_accept</span> <span class="o">=</span> <span class="n">svc_tcp_accept</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt_class</span> <span class="n">svc_tcp_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xcl_name</span> <span class="o">=</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svc_tcp_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xcl_max_payload</span> <span class="o">=</span> <span class="n">RPCSVC_MAXPAYLOAD_TCP</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">svc_init_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svc_reg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_tcp_class</span><span class="p">);</span>
	<span class="n">svc_reg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_udp_class</span><span class="p">);</span>
	<span class="n">svc_init_bc_xprt_sock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">svc_cleanup_xprt_sock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svc_unreg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_tcp_class</span><span class="p">);</span>
	<span class="n">svc_unreg_xprt_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svc_udp_class</span><span class="p">);</span>
	<span class="n">svc_cleanup_bc_xprt_sock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span>	<span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">;</span>

	<span class="n">svc_xprt_init</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">svc_tcp_class</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CACHE_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting up TCP socket for listening</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_LISTENER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span> <span class="o">=</span> <span class="n">svc_tcp_listen_data_ready</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CONN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting up TCP socket for reading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span> <span class="o">=</span> <span class="n">svc_tcp_state_change</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span> <span class="o">=</span> <span class="n">svc_tcp_data_ready</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span> <span class="o">=</span> <span class="n">svc_tcp_write_space</span><span class="p">;</span>

		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_reclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_tcplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_pages</span><span class="p">));</span>

		<span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nonagle</span> <span class="o">|=</span> <span class="n">TCP_NAGLE_OFF</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">svc_sock_update_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The number of server threads has changed. Update</span>
<span class="cm">	 * rcvbuf and sndbuf accordingly on all sockets</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_permsocks</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_list</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CHNGBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">svc_sock_update_bufs</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize socket for RPC use and create svc_sock struct</span>
<span class="cm"> * XXX: May want to setsockopt SO_SNDBUF and SO_RCVBUF.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="nf">svc_setup_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
						<span class="kt">int</span> <span class="o">*</span><span class="n">errp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span>	<span class="o">*</span><span class="n">inet</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pmap_register</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SVC_SOCK_ANONYMOUS</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_setup_socket %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">svsk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inet</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="cm">/* Register socket with portmapper */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pmap_register</span><span class="p">)</span>
		<span class="o">*</span><span class="n">errp</span> <span class="o">=</span> <span class="n">svc_register</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">,</span>
				     <span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">,</span>
				     <span class="n">ntohs</span><span class="p">(</span><span class="n">inet_sk</span><span class="p">(</span><span class="n">inet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">svsk</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_user_data</span> <span class="o">=</span> <span class="n">svsk</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span> <span class="o">=</span> <span class="n">inet</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_ostate</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_odata</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">;</span>
	<span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_owspace</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">sk_write_space</span><span class="p">;</span>

	<span class="cm">/* Initialize the socket */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span>
		<span class="n">svc_udp_init</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* initialise setting must have enough space to</span>
<span class="cm">		 * receive and respond to one request.</span>
<span class="cm">		 */</span>
		<span class="n">svc_sock_setbufsize</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">,</span>
					<span class="mi">4</span> <span class="o">*</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_max_mesg</span><span class="p">);</span>
		<span class="n">svc_tcp_init</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_setup_socket created %p (inet %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">svsk</span><span class="p">,</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">svsk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * svc_addsock - add a listener socket to an RPC service</span>
<span class="cm"> * @serv: pointer to RPC service to which to add a new listener</span>
<span class="cm"> * @fd: file descriptor of the new listener</span>
<span class="cm"> * @name_return: pointer to buffer to fill in with name of listener</span>
<span class="cm"> * @len: size of the buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Fills in socket name and returns positive length of name if successful.</span>
<span class="cm"> * Name is terminated with &#39;\n&#39;.  On error, returns a negative errno</span>
<span class="cm"> * value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">svc_addsock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_return</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span> <span class="o">=</span> <span class="n">sockfd_lookup</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">so</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">!=</span> <span class="n">PF_INET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span> <span class="o">!=</span> <span class="n">PF_INET6</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">so</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">SS_UNCONNECTED</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">svsk</span> <span class="o">=</span> <span class="n">svc_setup_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">so</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
						<span class="n">SVC_SOCK_DEFAULTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">salen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kernel_getsockname</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">salen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">svc_xprt_set_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">salen</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_TEMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">.</span><span class="n">xpt_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_permsocks</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_lock</span><span class="p">);</span>
			<span class="n">svc_xprt_received</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sockfd_put</span><span class="p">(</span><span class="n">so</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">svc_one_sock_name</span><span class="p">(</span><span class="n">svsk</span><span class="p">,</span> <span class="n">name_return</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">svc_addsock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Create socket for RPC service.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_create_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span>	<span class="o">*</span><span class="n">svsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span>	<span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">newsin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">newlen</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">family</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">val</span><span class="p">;</span>
	<span class="n">RPC_IFDEBUG</span><span class="p">(</span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">RPC_MAX_ADDRBUFLEN</span><span class="p">]);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_create_socket(%s, %d, %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_program</span><span class="o">-&gt;</span><span class="n">pg_name</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span>
			<span class="n">__svc_print_addr</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_UDP</span> <span class="o">&amp;&amp;</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;svc: only UDP and TCP &quot;</span>
				<span class="s">&quot;sockets supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span><span class="o">?</span> <span class="n">SOCK_DGRAM</span> <span class="o">:</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">family</span> <span class="o">=</span> <span class="n">PF_INET6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">__sock_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

	<span class="n">svc_reclassify_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is an PF_INET6 listener, we want to avoid</span>
<span class="cm">	 * getting requests from IPv4 remotes.  Those should</span>
<span class="cm">	 * be shunted to a PF_INET listener via rpcbind.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">PF_INET6</span><span class="p">)</span>
		<span class="n">kernel_setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_IPV6</span><span class="p">,</span> <span class="n">IPV6_V6ONLY</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuse</span> <span class="o">=</span> <span class="n">SK_CAN_REUSE</span><span class="p">;</span> <span class="cm">/* allow address reuse */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kernel_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bummer</span><span class="p">;</span>

	<span class="n">newlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kernel_getsockname</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bummer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">kernel_listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bummer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">svc_setup_socket</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svc_xprt_set_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">,</span> <span class="n">newsin</span><span class="p">,</span> <span class="n">newlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="p">)</span><span class="n">svsk</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">bummer:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_create_socket error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
	<span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detach the svc_sock from the socket so that no</span>
<span class="cm"> * more callbacks occur.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_sock_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sk</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_sock_detach(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">svsk</span><span class="p">);</span>

	<span class="cm">/* put back the old socket callbacks */</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_ostate</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_odata</span><span class="p">;</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span> <span class="o">=</span> <span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_owspace</span><span class="p">;</span>

	<span class="n">wq</span> <span class="o">=</span> <span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disconnect the socket, and reset the callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_tcp_sock_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_tcp_sock_detach(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">svsk</span><span class="p">);</span>

	<span class="n">svc_sock_detach</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_LISTENER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">svc_tcp_clear_pages</span><span class="p">(</span><span class="n">svsk</span><span class="p">);</span>
		<span class="n">kernel_sock_shutdown</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">,</span> <span class="n">SHUT_RDWR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the svc_sock&#39;s socket resources and the svc_sock itself.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_sock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svc: svc_sock_free(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">svsk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span>
		<span class="n">sockfd_put</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_sock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">svsk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
<span class="cm">/*</span>
<span class="cm"> * Create a back channel svc_xprt which shares the fore channel socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="nf">svc_bc_create_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_sock</span> <span class="o">*</span><span class="n">svsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;svc: only TCP sockets&quot;</span>
			<span class="s">&quot; supported on shared back channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">svsk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">svsk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svsk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">xprt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svsk</span><span class="o">-&gt;</span><span class="n">sk_xprt</span><span class="p">;</span>
	<span class="n">svc_xprt_init</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svc_tcp_bc_class</span><span class="p">,</span> <span class="n">xprt</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>

	<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_bc_xprt</span> <span class="o">=</span> <span class="n">xprt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xprt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free a back channel svc_sock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">svc_bc_sock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svc_sock</span><span class="p">,</span> <span class="n">sk_xprt</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
