<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › auth_gss › auth_gss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>auth_gss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/net/sunrpc/auth_gss/auth_gss.c</span>
<span class="cm"> *</span>
<span class="cm"> * RPCSEC_GSS client authentication.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2000 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Dug Song       &lt;dugsong@monkey.org&gt;</span>
<span class="cm"> *  Andy Adamson   &lt;andros@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that the following conditions</span>
<span class="cm"> *  are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the University nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/auth.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/auth_gss.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svcauth_gss.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/gss_err.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/rpc_pipe_fs.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/gss_api.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_authops</span> <span class="n">authgss_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_credops</span> <span class="n">gss_credops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_credops</span> <span class="n">gss_nullops</span><span class="p">;</span>

<span class="cp">#define GSS_RETRY_EXPIRED 5</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gss_expired_cred_retry_delay</span> <span class="o">=</span> <span class="n">GSS_RETRY_EXPIRED</span><span class="p">;</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="cp"># define RPCDBG_FACILITY	RPCDBG_AUTH</span>
<span class="cp">#endif</span>

<span class="cp">#define GSS_CRED_SLACK		(RPC_MAX_AUTH_SIZE * 2)</span>
<span class="cm">/* length of a krb5 verifier (48), plus data added before arguments when</span>
<span class="cm"> * using integrity (two 4-byte integers): */</span>
<span class="cp">#define GSS_VERF_SLACK		100</span>

<span class="k">struct</span> <span class="n">gss_auth</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="n">rpc_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_api_mech</span> <span class="o">*</span><span class="n">mech</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rpc_gss_svc</span> <span class="n">service</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * There are two upcall pipes; dentry[1], named &quot;gssd&quot;, is used</span>
<span class="cm">	 * for the new text-based upcall; dentry[0] is named after the</span>
<span class="cm">	 * mechanism (for example, &quot;krb5&quot;) and exists for</span>
<span class="cm">	 * backwards-compatibility with older gssd&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* pipe_version &gt;= 0 if and only if someone has a pipe open. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pipe_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">pipe_users</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pipe_version_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_wait_queue</span> <span class="n">pipe_version_rpc_waitqueue</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">pipe_version_waitqueue</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gss_free_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_pipe_ops</span> <span class="n">gss_upcall_ops_v0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_pipe_ops</span> <span class="n">gss_upcall_ops_v1</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span>
<span class="nf">gss_get_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">gss_put_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="n">gss_free_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gss_cred_set_ctx:</span>
<span class="cm"> * called by gss_upcall_callback and gss_create_upcall in order</span>
<span class="cm"> * to set the gss context. The actual exchange of an old context</span>
<span class="cm"> * and a new one is protected by the pipe-&gt;lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_cred_set_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gss_get_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">simple_get_bytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">simple_get_netobj</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">dest</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span>
<span class="nf">gss_cred_get_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="p">)</span>
		<span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_get_ctx</span><span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span>
<span class="nf">gss_alloc_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_proc</span> <span class="o">=</span> <span class="n">RPC_GSS_PROC_DATA</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* NetApp 6.4R1 doesn&#39;t accept seq. no. 0 */</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_seq_lock</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define GSSD_MIN_TIMEOUT (60 * 60)</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">gss_fill_context</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_api_mech</span> <span class="o">*</span><span class="n">gm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seclen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">window_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* First unsigned int gives the lifetime (in seconds) of the cred */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">GSSD_MIN_TIMEOUT</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_expiry</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* Sequence number window. Determines the maximum number of simultaneous requests */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">window_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">window_size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_win</span> <span class="o">=</span> <span class="n">window_size</span><span class="p">;</span>
	<span class="cm">/* gssd signals an error by passing ctx-&gt;gc_win = 0: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_win</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * in which case, p points to an error code. Anything other</span>
<span class="cm">		 * than -EKEYEXPIRED gets converted to -EACCES.</span>
<span class="cm">		 */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span><span class="p">)</span> <span class="o">?</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EKEYEXPIRED</span><span class="p">)</span> <span class="o">:</span>
						    <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* copy the opaque wire context */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_netobj</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_wire_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* import the opaque security context */</span>
	<span class="n">p</span>  <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seclen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seclen</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+</span> <span class="n">seclen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="o">||</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gss_import_sec_context</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">seclen</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_fill_context returning %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define UPCALL_BUF_LEN 128</span>

<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="p">{</span>
	<span class="n">atomic_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">uid_t</span>	<span class="n">uid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_pipe_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_wait_queue</span> <span class="n">rpc_waitqueue</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">waitqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">databuf</span><span class="p">[</span><span class="n">UPCALL_BUF_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_pipe_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_version</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_users</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pipe_version</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_pipe_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_users</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_release_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">put_pipe_version</span><span class="p">();</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span>
<span class="nf">__gss_find_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">in_downcall</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_find_upcall found msg %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_find_upcall found nothing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try to add an upcall to the pipefs queue.</span>
<span class="cm"> * If an upcall owned by our uid already exists, then we return a reference</span>
<span class="cm"> * to that upcall instead of adding the new upcall.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span>
<span class="nf">gss_add_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">__gss_find_upcall</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">in_downcall</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gss_msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__gss_unhash_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">rpc_wake_up_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_unhash_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="n">__gss_unhash_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_handle_downcall_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">.</span><span class="n">cr_flags</span><span class="p">);</span>
		<span class="n">gss_cred_set_ctx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">.</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rpc_wake_up_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_upcall_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span> <span class="o">=</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gss_handle_downcall_result</span><span class="p">(</span><span class="n">gss_cred</span><span class="p">,</span> <span class="n">gss_msg</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">;</span>
	<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_encode_v0_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_encode_v1_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_api_mech</span> <span class="o">*</span><span class="n">mech</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">,</span> <span class="s">&quot;mech=%s uid=%d &quot;</span><span class="p">,</span>
				   <span class="n">mech</span><span class="o">-&gt;</span><span class="n">gm_name</span><span class="p">,</span>
				   <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_principal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;target=%s &quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_principal</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">service_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;service=%s &quot;</span><span class="p">,</span> <span class="n">service_name</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mech</span><span class="o">-&gt;</span><span class="n">gm_upcall_enctypes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;enctypes=%s &quot;</span><span class="p">,</span> <span class="n">mech</span><span class="o">-&gt;</span><span class="n">gm_upcall_enctypes</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">databuf</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">UPCALL_BUF_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_encode_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gss_encode_v0_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* pipe_version == 1 */</span>
		<span class="n">gss_encode_v1_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">,</span> <span class="n">clnt</span><span class="p">,</span> <span class="n">service_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span>
<span class="nf">gss_alloc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
		<span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vers</span><span class="p">;</span>

	<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gss_msg</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">vers</span> <span class="o">=</span> <span class="n">get_pipe_version</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vers</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">vers</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">vers</span><span class="p">];</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">,</span> <span class="s">&quot;RPCSEC_GSS upcall waitq&quot;</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">auth</span> <span class="o">=</span> <span class="n">gss_auth</span><span class="p">;</span>
	<span class="n">gss_encode_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">,</span> <span class="n">clnt</span><span class="p">,</span> <span class="n">service_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gss_msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span>
<span class="nf">gss_setup_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_new</span><span class="p">,</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">;</span>

	<span class="n">gss_new</span> <span class="o">=</span> <span class="n">gss_alloc_msg</span><span class="p">(</span><span class="n">gss_auth</span><span class="p">,</span> <span class="n">clnt</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_new</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gss_new</span><span class="p">;</span>
	<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">gss_add_msg</span><span class="p">(</span><span class="n">gss_new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span> <span class="o">==</span> <span class="n">gss_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">rpc_queue_upcall</span><span class="p">(</span><span class="n">gss_new</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gss_new</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gss_unhash_msg</span><span class="p">(</span><span class="n">gss_new</span><span class="p">);</span>
			<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gss_msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">warn_gssd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ratelimit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ratelimit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;RPC: AUTH_GSS upcall timed out.</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;Please check user daemon is running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ratelimit</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_refresh_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_refresh_upcall for uid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
								<span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">);</span>
	<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">gss_setup_upcall</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="p">,</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX: warning on the first, under the assumption we</span>
<span class="cm">		 * shouldn&#39;t normally hit this case on a refresh. */</span>
		<span class="n">warn_gssd</span><span class="p">();</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="mi">15</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_rpc_waitqueue</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="p">;</span>
		<span class="cm">/* gss_upcall_callback will release the reference to gss_upcall_msg */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">rpc_waitqueue</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">gss_upcall_callback</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gss_handle_downcall_result</span><span class="p">(</span><span class="n">gss_cred</span><span class="p">,</span> <span class="n">gss_msg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_refresh_upcall for uid %u result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_create_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_upcall for uid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">gss_setup_upcall</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">pipe_version_waitqueue</span><span class="p">,</span>
				<span class="n">pipe_version</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_version</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn_gssd</span><span class="p">();</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_KILLABLE</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fatal_signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_intr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">)</span>
		<span class="n">gss_cred_set_ctx</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out_intr:</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_create_upcall for uid %u result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MSG_BUF_MAXSIZE 1024</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">gss_pipe_downcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">mlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">RPC_I</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlen</span> <span class="o">&gt;</span> <span class="n">MSG_BUF_MAXSIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">mlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">mlen</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">simple_get_bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_alloc_context</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="cm">/* Find a matching upcall */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gss_msg</span> <span class="o">=</span> <span class="n">__gss_find_upcall</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_put_ctx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">gss_fill_context</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EACCES</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
			<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mlen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOSYS</span>:
			<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: bad return from &quot;</span>
				<span class="s">&quot;gss_fill_context: %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err_release_msg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_get_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mlen</span><span class="p">;</span>

<span class="nl">err_release_msg:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__gss_unhash_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
<span class="nl">err_put_ctx:</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_pipe_downcall returning %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_pipe_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_version</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First open of any gss pipe determines the version: */</span>
		<span class="n">pipe_version</span> <span class="o">=</span> <span class="n">new_version</span><span class="p">;</span>
		<span class="n">rpc_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_rpc_waitqueue</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_waitqueue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pipe_version</span> <span class="o">!=</span> <span class="n">new_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Trying to open a pipe of a different version */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_users</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_pipe_open_v0</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gss_pipe_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_pipe_open_v1</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gss_pipe_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_pipe_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">RPC_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">in_downcall</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">list</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">__gss_unhash_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">put_pipe_version</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_pipe_destroy_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_pipe_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_upcall_msg</span> <span class="o">*</span><span class="n">gss_msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_upcall_msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_pipe_destroy_msg releasing msg %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gss_msg</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_msg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">gss_unhash_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="n">warn_gssd</span><span class="p">();</span>
		<span class="n">gss_release_msg</span><span class="p">(</span><span class="n">gss_msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_pipes_dentries_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">;</span>

	<span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span>
		<span class="n">rpc_unlink</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span>
		<span class="n">rpc_unlink</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_pipes_dentries_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">rpc_mkpipe_dentry</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_dentry</span><span class="p">,</span>
						      <span class="s">&quot;gssd&quot;</span><span class="p">,</span>
						      <span class="n">clnt</span><span class="p">,</span> <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">rpc_mkpipe_dentry</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_dentry</span><span class="p">,</span>
						      <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="o">-&gt;</span><span class="n">gm_name</span><span class="p">,</span>
						      <span class="n">clnt</span><span class="p">,</span> <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlink_pipe_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unlink_pipe_1:</span>
	<span class="n">rpc_unlink</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_pipes_dentries_destroy_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">rpc_net_ns</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">rpc_get_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_dentry</span><span class="p">)</span>
			<span class="n">gss_pipes_dentries_destroy</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
		<span class="n">rpc_put_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_pipes_dentries_create_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">rpc_net_ns</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">rpc_get_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_dentry</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">gss_pipes_dentries_create</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
		<span class="n">rpc_put_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: we have the opportunity to use different</span>
<span class="cm"> * parameters based on the input flavor (which must be a pseudoflavor)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span>
<span class="nf">gss_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="n">rpc_authflavor_t</span> <span class="n">flavor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span> <span class="n">auth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span> <span class="cm">/* XXX? */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       creating GSS authenticator for client %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gss_auth</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_dec</span><span class="p">;</span>
	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span> <span class="o">=</span> <span class="n">gss_mech_get_by_pseudoflavor</span><span class="p">(</span><span class="n">flavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Pseudoflavor %d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">flavor</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">gss_pseudoflavor_to_service</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">,</span> <span class="n">flavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_mech</span><span class="p">;</span>
	<span class="n">auth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">rpc_auth</span><span class="p">;</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_cslack</span> <span class="o">=</span> <span class="n">GSS_CRED_SLACK</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_rslack</span> <span class="o">=</span> <span class="n">GSS_VERF_SLACK</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">authgss_ops</span><span class="p">;</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span> <span class="o">=</span> <span class="n">flavor</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: if we created the old pipe first, then someone who</span>
<span class="cm">	 * examined the directory at the right moment might conclude</span>
<span class="cm">	 * that we supported only the old pipe.  So we instead create</span>
<span class="cm">	 * the new pipe first.</span>
<span class="cm">	 */</span>
	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_mkpipe_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_upcall_ops_v1</span><span class="p">,</span>
					    <span class="n">RPC_PIPE_WAIT_FOR_OPEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">err_put_mech</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_mkpipe_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_upcall_ops_v0</span><span class="p">,</span>
					    <span class="n">RPC_PIPE_WAIT_FOR_OPEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">err_destroy_pipe_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gss_pipes_dentries_create_net</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">auth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_destroy_pipe_0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rpcauth_init_credcache</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlink_pipes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">auth</span><span class="p">;</span>
<span class="nl">err_unlink_pipes:</span>
	<span class="n">gss_pipes_dentries_destroy_net</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">auth</span><span class="p">);</span>
<span class="nl">err_destroy_pipe_0:</span>
	<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">err_destroy_pipe_1:</span>
	<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">err_put_mech:</span>
	<span class="n">gss_mech_put</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gss_auth</span><span class="p">);</span>
<span class="nl">out_dec:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gss_pipes_dentries_destroy_net</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">rpc_auth</span><span class="p">);</span>
	<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">gss_mech_put</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">mech</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">gss_auth</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">gss_free</span><span class="p">(</span><span class="n">gss_auth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       destroying GSS authenticator %p flavor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">auth</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>

	<span class="n">rpcauth_destroy_credcache</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>

	<span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">gss_free_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gss_destroying_context will cause the RPCSEC_GSS to send a NULL RPC call</span>
<span class="cm"> * to the server with the GSS control procedure field set to</span>
<span class="cm"> * RPC_GSS_PROC_DESTROY. This should normally cause the server to release</span>
<span class="cm"> * all RPCSEC_GSS state associated with that context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_destroying_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="o">-&gt;</span><span class="n">gc_proc</span> <span class="o">=</span> <span class="n">RPC_GSS_PROC_DESTROY</span><span class="p">;</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gss_nullops</span><span class="p">;</span>

	<span class="cm">/* Take a reference to ensure the cred will be destroyed either</span>
<span class="cm">	 * by the RPC call or by the put_rpccred() below */</span>
	<span class="n">get_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_call_null</span><span class="p">(</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">RPC_TASK_ASYNC</span><span class="o">|</span><span class="n">RPC_TASK_SOFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gss_destroy_cred (and gss_free_ctx) are used to clean up after failure</span>
<span class="cm"> * to create a new cred or context, so they check that things have been</span>
<span class="cm"> * allocated before freeing them. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_do_free_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_free_ctx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">gss_delete_sec_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_wire_ctx</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free_ctx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span><span class="p">,</span> <span class="n">gc_rcu</span><span class="p">);</span>
	<span class="n">gss_do_free_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_rcu</span><span class="p">,</span> <span class="n">gss_free_ctx_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_free_cred %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gss_cred</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gss_cred</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_free_cred_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">.</span><span class="n">cr_rcu</span><span class="p">);</span>
	<span class="n">gss_free_cred</span><span class="p">(</span><span class="n">gss_cred</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_destroy_nullcred</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="p">;</span>

	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_rcu</span><span class="p">,</span> <span class="n">gss_free_cred_callback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
		<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">gss_free_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gss_destroy_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gss_destroying_context</span><span class="p">(</span><span class="n">cred</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gss_destroy_nullcred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lookup RPCSEC_GSS cred for the current process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span>
<span class="nf">gss_lookup_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">auth_cred</span> <span class="o">*</span><span class="n">acred</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rpcauth_lookup_credcache</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">acred</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span>
<span class="nf">gss_create_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">auth_cred</span> <span class="o">*</span><span class="n">acred</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cred</span>	<span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_create_cred for uid %d, flavor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">acred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cred</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cred</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">rpcauth_init_cred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">,</span> <span class="n">acred</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gss_credops</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: in order to force a call to call_refresh(), we deliberately</span>
<span class="cm">	 * fail to flag the credential as RPCAUTH_CRED_UPTODATE.</span>
<span class="cm">	 */</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">.</span><span class="n">cr_flags</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">RPCAUTH_CRED_NEW</span><span class="p">;</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_service</span> <span class="o">=</span> <span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">;</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acred</span><span class="o">-&gt;</span><span class="n">machine_cred</span><span class="p">)</span>
		<span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span> <span class="o">=</span> <span class="n">acred</span><span class="o">-&gt;</span><span class="n">principal</span><span class="p">;</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gss_auth</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gc_base</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       gss_create_cred failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_cred_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_auth</span> <span class="o">*</span><span class="n">gss_auth</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_auth</span><span class="p">,</span> <span class="n">rpc_auth</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span><span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gss_create_upcall</span><span class="p">(</span><span class="n">gss_auth</span><span class="p">,</span> <span class="n">gss_cred</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">auth_cred</span> <span class="o">*</span><span class="n">acred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Don&#39;t match with creds that have expired. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_ctx</span><span class="o">-&gt;</span><span class="n">gc_expiry</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acred</span><span class="o">-&gt;</span><span class="n">principal</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">acred</span><span class="o">-&gt;</span><span class="n">principal</span><span class="p">,</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">cr_uid</span> <span class="o">==</span> <span class="n">acred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Marshal credentials.</span>
<span class="cm">* Maybe we should keep a cached credential for performance reasons.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="o">*</span>
<span class="nf">gss_marshal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cred</span>	<span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span>
						 <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span>	<span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_cred_get_ctx</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">__be32</span>		<span class="o">*</span><span class="n">cred_len</span><span class="p">;</span>
	<span class="n">u32</span>             <span class="n">maj_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">mic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>	<span class="n">iov</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="n">verf_buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_marshal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">RPC_AUTH_GSS</span><span class="p">);</span>
	<span class="n">cred_len</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_seq_lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_seqno</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_seq_lock</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">RPC_GSS_VERSION</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_proc</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_service</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_netobj</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_wire_ctx</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cred_len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">cred_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* We compute the checksum for the verifier over the xdr-encoded bytes</span>
<span class="cm">	 * starting with the xid and ending at the end of the credential: */</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">xprt_skip_transport_header</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">xdr_buf_from_iov</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verf_buf</span><span class="p">);</span>

	<span class="cm">/* set verifier flavor*/</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">RPC_AUTH_GSS</span><span class="p">);</span>

	<span class="n">mic</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_get_mic</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verf_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;gss_marshal: gss_get_mic FAILED (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maj_stat</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_ctx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_opaque</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mic</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="nl">out_put_ctx:</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_renew_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">oldcred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">oldcred</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span>
						 <span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="n">oldcred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auth_cred</span> <span class="n">acred</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">oldcred</span><span class="o">-&gt;</span><span class="n">cr_uid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">principal</span> <span class="o">=</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span><span class="p">,</span>
		<span class="p">.</span><span class="n">machine_cred</span> <span class="o">=</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_principal</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">gss_lookup_cred</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acred</span><span class="p">,</span> <span class="n">RPCAUTH_LOOKUP_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">oldcred</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gss_cred_is_negative_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEGATIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">begin</span><span class="p">,</span> <span class="n">expire</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span><span class="p">;</span> 

		<span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span> <span class="n">gc_base</span><span class="p">);</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_upcall_timestamp</span><span class="p">;</span>
		<span class="n">expire</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">gss_expired_cred_retry_delay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_in_range_open</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* Refresh credentials. XXX - finish</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gss_cred_is_negative_entry</span><span class="p">(</span><span class="n">cred</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gss_renew_cred</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_NEW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gss_refresh_upcall</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Dummy refresh routine: used only when destroying the context */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_refresh_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="o">*</span>
<span class="nf">gss_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_cred_get_ctx</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">__be32</span>		<span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>	<span class="n">iov</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="n">verf_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">mic</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">flav</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">maj_stat</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_validate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>

	<span class="n">flav</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">RPC_MAX_AUTH_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flav</span> <span class="o">!=</span> <span class="n">RPC_AUTH_GSS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">xdr_buf_from_iov</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verf_buf</span><span class="p">);</span>
	<span class="n">mic</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">mic</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_verify_mic</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verf_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_validate: gss_verify_mic returned &quot;</span>
				<span class="s">&quot;error 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">maj_stat</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We leave it to unwrap to calculate au_rslack. For now we just</span>
<span class="cm">	 * calculate the length of the verifier: */</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="o">-&gt;</span><span class="n">au_verfsize</span> <span class="o">=</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_validate: gss_verify_mic succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">+</span> <span class="n">XDR_QUADLEN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="nl">out_bad:</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_validate failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gss_wrap_req_encode</span><span class="p">(</span><span class="n">kxdreproc_t</span> <span class="n">encode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_stream</span> <span class="n">xdr</span><span class="p">;</span>

	<span class="n">xdr_init_encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">encode</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xdr</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_wrap_req_integ</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		   <span class="n">kxdreproc_t</span> <span class="n">encode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		   <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="o">*</span><span class="n">snd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="n">integ_buf</span><span class="p">;</span>
	<span class="n">__be32</span>          <span class="o">*</span><span class="n">integ_len</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">mic</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">offset</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>	<span class="o">*</span><span class="n">iov</span><span class="p">;</span>
	<span class="n">u32</span>             <span class="n">maj_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">integ_len</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">);</span>

	<span class="n">gss_wrap_req_encode</span><span class="p">(</span><span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xdr_buf_subsegment</span><span class="p">(</span><span class="n">snd_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">integ_buf</span><span class="p">,</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">integ_len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">integ_buf</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* guess whether we&#39;re in the head or the tail: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">||</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">mic</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_get_mic</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">integ_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* XXX? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">xdr_encode_opaque</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mic</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">priv_release_snd_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">alloc_enc_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span> <span class="o">*</span><span class="n">snd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_base</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_base</span> <span class="o">+</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span>
		<span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span>
				<span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_release_snd_buf</span> <span class="o">=</span> <span class="n">priv_release_snd_buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">priv_release_snd_buf</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_wrap_req_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		  <span class="n">kxdreproc_t</span> <span class="n">encode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		  <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="o">*</span><span class="n">snd_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span>             <span class="n">maj_stat</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="o">*</span><span class="n">opaque_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>	<span class="o">**</span><span class="n">inpages</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">first</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>	<span class="o">*</span><span class="n">iov</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">opaque_len</span> <span class="o">=</span> <span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">);</span>

	<span class="n">gss_wrap_req_encode</span><span class="p">(</span><span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">alloc_enc_pages</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_base</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">inpages</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">first</span><span class="p">;</span>
	<span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">;</span>
	<span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_base</span> <span class="o">-=</span> <span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Give the tail its own page, in case we need extra space in the</span>
<span class="cm">	 * head when wrapping:</span>
<span class="cm">	 *</span>
<span class="cm">	 * call_allocate() allocates twice the slack space required</span>
<span class="cm">	 * by the authentication flavor to rq_callsize.</span>
<span class="cm">	 * For GSS, slack is GSS_CRED_SLACK.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">||</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages</span><span class="p">[</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_enc_pages_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_wrap</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">snd_buf</span><span class="p">,</span> <span class="n">inpages</span><span class="p">);</span>
	<span class="cm">/* slack space should prevent this ever happening: */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="cm">/* We&#39;re assuming that when GSS_S_CONTEXT_EXPIRED, the encryption was</span>
<span class="cm">	 * done anyway, so it&#39;s safe to put the request on the wire: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="o">*</span><span class="n">opaque_len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* guess whether we&#39;re in the head or the tail: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">||</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="p">((</span><span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">snd_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_wrap_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
	     <span class="n">kxdreproc_t</span> <span class="n">encode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cred</span>	<span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span>
			<span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_cred_get_ctx</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="kt">int</span>             <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_wrap_req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_proc</span> <span class="o">!=</span> <span class="n">RPC_GSS_PROC_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The spec seems a little ambiguous here, but I think that not</span>
<span class="cm">		 * wrapping context destruction requests makes the most sense.</span>
<span class="cm">		 */</span>
		<span class="n">gss_wrap_req_encode</span><span class="p">(</span><span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_service</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_NONE</span>:
		<span class="n">gss_wrap_req_encode</span><span class="p">(</span><span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_INTEGRITY</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">gss_wrap_req_integ</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_PRIVACY</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">gss_wrap_req_priv</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">encode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_wrap_req returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_unwrap_resp_integ</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>	<span class="o">*</span><span class="n">rcv_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span> <span class="n">integ_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdr_netobj</span> <span class="n">mic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">mic_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">integ_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maj_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">integ_len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">integ_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rcv_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">mic_offset</span> <span class="o">=</span> <span class="n">integ_len</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mic_offset</span> <span class="o">&gt;</span> <span class="n">rcv_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xdr_buf_subsegment</span><span class="p">(</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">integ_buf</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">,</span>
				<span class="n">mic_offset</span> <span class="o">-</span> <span class="n">data_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xdr_buf_read_netobj</span><span class="p">(</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">,</span> <span class="n">mic_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_verify_mic</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">integ_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">!=</span> <span class="n">GSS_S_COMPLETE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">gss_unwrap_resp_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>  <span class="o">*</span><span class="n">rcv_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opaque_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maj_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">opaque_len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rcv_buf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">opaque_len</span> <span class="o">&gt;</span> <span class="n">rcv_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* remove padding: */</span>
	<span class="n">rcv_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">opaque_len</span><span class="p">;</span>

	<span class="n">maj_stat</span> <span class="o">=</span> <span class="n">gss_unwrap</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_gss_ctx</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rcv_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">==</span> <span class="n">GSS_S_CONTEXT_EXPIRED</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RPCAUTH_CRED_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maj_stat</span> <span class="o">!=</span> <span class="n">GSS_S_COMPLETE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_seqno</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_unwrap_req_decode</span><span class="p">(</span><span class="n">kxdrdproc_t</span> <span class="n">decode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
		      <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xdr_stream</span> <span class="n">xdr</span><span class="p">;</span>

	<span class="n">xdr_init_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">decode</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xdr</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gss_unwrap_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="n">kxdrdproc_t</span> <span class="n">decode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gss_cred</span> <span class="o">*</span><span class="n">gss_cred</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gss_cred</span><span class="p">,</span>
			<span class="n">gc_base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gss_cl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">gss_cred_get_ctx</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">__be32</span>		<span class="o">*</span><span class="n">savedp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span>	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="p">)</span><span class="n">rqstp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">savedlen</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">gc_proc</span> <span class="o">!=</span> <span class="n">RPC_GSS_PROC_DATA</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_decode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gss_cred</span><span class="o">-&gt;</span><span class="n">gc_service</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_INTEGRITY</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">gss_unwrap_resp_integ</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPC_GSS_SVC_PRIVACY</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">gss_unwrap_resp_priv</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* take into account extra slack for integrity and privacy cases: */</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="o">-&gt;</span><span class="n">au_rslack</span> <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">cr_auth</span><span class="o">-&gt;</span><span class="n">au_verfsize</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">savedp</span><span class="p">)</span>
						<span class="o">+</span> <span class="p">(</span><span class="n">savedlen</span> <span class="o">-</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
<span class="nl">out_decode:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">gss_unwrap_req_decode</span><span class="p">(</span><span class="n">decode</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">gss_put_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u gss_unwrap_resp returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_authops</span> <span class="n">authgss_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">au_flavor</span>	<span class="o">=</span> <span class="n">RPC_AUTH_GSS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">au_name</span>	<span class="o">=</span> <span class="s">&quot;RPCSEC_GSS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">gss_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span> <span class="n">gss_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lookup_cred</span>	<span class="o">=</span> <span class="n">gss_lookup_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crcreate</span>	<span class="o">=</span> <span class="n">gss_create_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipes_create</span>	<span class="o">=</span> <span class="n">gss_pipes_dentries_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipes_destroy</span>	<span class="o">=</span> <span class="n">gss_pipes_dentries_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_credops</span> <span class="n">gss_credops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cr_name</span>	<span class="o">=</span> <span class="s">&quot;AUTH_GSS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crdestroy</span>	<span class="o">=</span> <span class="n">gss_destroy_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cr_init</span>	<span class="o">=</span> <span class="n">gss_cred_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crbind</span>		<span class="o">=</span> <span class="n">rpcauth_generic_bind_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crmatch</span>	<span class="o">=</span> <span class="n">gss_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crmarshal</span>	<span class="o">=</span> <span class="n">gss_marshal</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crrefresh</span>	<span class="o">=</span> <span class="n">gss_refresh</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crvalidate</span>	<span class="o">=</span> <span class="n">gss_validate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crwrap_req</span>	<span class="o">=</span> <span class="n">gss_wrap_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crunwrap_resp</span>	<span class="o">=</span> <span class="n">gss_unwrap_resp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_credops</span> <span class="n">gss_nullops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cr_name</span>	<span class="o">=</span> <span class="s">&quot;AUTH_GSS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crdestroy</span>	<span class="o">=</span> <span class="n">gss_destroy_nullcred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crbind</span>		<span class="o">=</span> <span class="n">rpcauth_generic_bind_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crmatch</span>	<span class="o">=</span> <span class="n">gss_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crmarshal</span>	<span class="o">=</span> <span class="n">gss_marshal</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crrefresh</span>	<span class="o">=</span> <span class="n">gss_refresh_null</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crvalidate</span>	<span class="o">=</span> <span class="n">gss_validate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crwrap_req</span>	<span class="o">=</span> <span class="n">gss_wrap_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crunwrap_resp</span>	<span class="o">=</span> <span class="n">gss_unwrap_resp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_pipe_ops</span> <span class="n">gss_upcall_ops_v0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">upcall</span>		<span class="o">=</span> <span class="n">rpc_pipe_generic_upcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">downcall</span>	<span class="o">=</span> <span class="n">gss_pipe_downcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_msg</span>	<span class="o">=</span> <span class="n">gss_pipe_destroy_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open_pipe</span>	<span class="o">=</span> <span class="n">gss_pipe_open_v0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_pipe</span>	<span class="o">=</span> <span class="n">gss_pipe_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_pipe_ops</span> <span class="n">gss_upcall_ops_v1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">upcall</span>		<span class="o">=</span> <span class="n">rpc_pipe_generic_upcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">downcall</span>	<span class="o">=</span> <span class="n">gss_pipe_downcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_msg</span>	<span class="o">=</span> <span class="n">gss_pipe_destroy_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open_pipe</span>	<span class="o">=</span> <span class="n">gss_pipe_open_v1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_pipe</span>	<span class="o">=</span> <span class="n">gss_pipe_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__net_init</span> <span class="kt">int</span> <span class="nf">rpcsec_gss_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gss_svc_init_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__net_exit</span> <span class="kt">void</span> <span class="nf">rpcsec_gss_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gss_svc_shutdown_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">rpcsec_gss_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">rpcsec_gss_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">rpcsec_gss_exit_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize RPCSEC_GSS module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_rpcsec_gss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rpcauth_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">authgss_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gss_svc_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcsec_gss_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_svc_exit</span><span class="p">;</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe_version_rpc_waitqueue</span><span class="p">,</span> <span class="s">&quot;gss pipe version&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_svc_exit:</span>
	<span class="n">gss_svc_shutdown</span><span class="p">();</span>
<span class="nl">out_unregister:</span>
	<span class="n">rpcauth_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">authgss_ops</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_rpcsec_gss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcsec_gss_net_ops</span><span class="p">);</span>
	<span class="n">gss_svc_shutdown</span><span class="p">();</span>
	<span class="n">rpcauth_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">authgss_ops</span><span class="p">);</span>
	<span class="n">rcu_barrier</span><span class="p">();</span> <span class="cm">/* Wait for completion of call_rcu()&#39;s */</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">expired_cred_retry_delay</span><span class="p">,</span>
		   <span class="n">gss_expired_cred_retry_delay</span><span class="p">,</span>
		   <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">expired_cred_retry_delay</span><span class="p">,</span> <span class="s">&quot;Timeout (in seconds) until &quot;</span>
		<span class="s">&quot;the RPC engine retries an expired credential&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_rpcsec_gss</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_rpcsec_gss</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
