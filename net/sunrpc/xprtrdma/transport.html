<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › xprtrdma › transport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>transport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2007 Network Appliance, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the BSD-type</span>
<span class="cm"> * license below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions of source code must retain the above copyright</span>
<span class="cm"> *      notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions in binary form must reproduce the above</span>
<span class="cm"> *      copyright notice, this list of conditions and the following</span>
<span class="cm"> *      disclaimer in the documentation and/or other materials provided</span>
<span class="cm"> *      with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> *      Neither the name of the Network Appliance, Inc. nor the names of</span>
<span class="cm"> *      its contributors may be used to endorse or promote products</span>
<span class="cm"> *      derived from this software without specific prior written</span>
<span class="cm"> *      permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * transport.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains the top-level implementation of an RPC RDMA</span>
<span class="cm"> * transport.</span>
<span class="cm"> *</span>
<span class="cm"> * Naming convention: functions beginning with xprt_ are part of the</span>
<span class="cm"> * transport switch. All others are RPC RDMA internal.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &quot;xprt_rdma.h&quot;</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="cp"># define RPCDBG_FACILITY	RPCDBG_TRANS</span>
<span class="cp">#endif</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RPC/RDMA Transport for Linux kernel NFS&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Network Appliance, Inc.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tunables</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xprt_rdma_slot_table_entries</span> <span class="o">=</span> <span class="n">RPCRDMA_DEF_SLOT_TABLE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xprt_rdma_max_inline_read</span> <span class="o">=</span> <span class="n">RPCRDMA_DEF_INLINE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xprt_rdma_max_inline_write</span> <span class="o">=</span> <span class="n">RPCRDMA_DEF_INLINE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xprt_rdma_inline_write_padding</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xprt_rdma_memreg_strategy</span> <span class="o">=</span> <span class="n">RPCRDMA_FRMR</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">xprt_rdma_pad_optimize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef RPC_DEBUG</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_slot_table_size</span> <span class="o">=</span> <span class="n">RPCRDMA_MIN_SLOT_TABLE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_slot_table_size</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_SLOT_TABLE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">zero</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_padding</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_BOUNCEBUFFERS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_LAST</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">sunrpc_table_header</span><span class="p">;</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">xr_tunables_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_slot_table_entries&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_slot_table_entries</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">min_slot_table_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">max_slot_table_size</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_max_inline_read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_max_inline_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_max_inline_write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_max_inline_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_inline_write_padding&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_inline_write_padding</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">max_padding</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_memreg_strategy&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_memreg_strategy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">min_memreg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">max_memreg</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;rdma_pad_optimize&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_pad_optimize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">sunrpc_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;sunrpc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">xr_tunables_table</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_xprt_ops</span> <span class="n">xprt_rdma_procs</span><span class="p">;</span>	<span class="cm">/* forward reference */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_format_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">rpcx_to_rdmad</span><span class="p">(</span><span class="n">xprt</span><span class="p">).</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sap</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">rpc_ntop</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_ADDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">rpc_get_port</span><span class="p">(</span><span class="n">sap</span><span class="p">));</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_PORT</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_PROTO</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;rdma&quot;</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_HEX_ADDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%4hx&quot;</span><span class="p">,</span> <span class="n">rpc_get_port</span><span class="p">(</span><span class="n">sap</span><span class="p">));</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_HEX_PORT</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* netid */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_NETID</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;rdma&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_free_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RPC_DISPLAY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RPC_DISPLAY_PROTO</span>:
		<span class="k">case</span> <span class="n">RPC_DISPLAY_NETID</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_connect_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_xprt</span><span class="p">,</span> <span class="n">rdma_connect</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">xprt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt_clear_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %sconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">.</span><span class="n">rep_connected</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;re&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">out_clear</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">xprt_wake_pending_tasks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

<span class="nl">out_clear:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">xprt_clear_connecting</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * xprt_rdma_destroy</span>
<span class="cm"> *</span>
<span class="cm"> * Destroy the xprt.</span>
<span class="cm"> * Free all memory associated with the object, including its own.</span>
<span class="cm"> * NOTE: none of the *destroy methods free memory for their top-level</span>
<span class="cm"> * objects, even though they may have allocated it (they do free</span>
<span class="cm"> * private memory). It&#39;s up to the caller to handle it. In this</span>
<span class="cm"> * case (RDMA transport), all structure memory is inlined with the</span>
<span class="cm"> * struct rpcrdma_xprt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rdma_connect</span><span class="p">);</span>

	<span class="n">xprt_clear_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">rpcrdma_buffer_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rpcrdma_ep_destroy returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">rpcrdma_ia_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>

	<span class="n">xprt_rdma_free_addresses</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">xprt_free</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="n">xprt_rdma_default_timeout</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">to_initval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">to_maxval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_setup_rdma - Set up transport to use RDMA</span>
<span class="cm"> *</span>
<span class="cm"> * @args: rpc transport arguments</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>
<span class="nf">xprt_setup_rdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_create</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_create_data_internal</span> <span class="n">cdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">new_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">new_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">addrlen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: address too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBADF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xprt</span> <span class="o">=</span> <span class="n">xprt_alloc</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_xprt</span><span class="p">),</span>
			<span class="n">xprt_rdma_slot_table_entries</span><span class="p">,</span>
			<span class="n">xprt_rdma_slot_table_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: couldn&#39;t allocate rpcrdma_xprt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 60 second timeout, no retries */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_default_timeout</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">60U</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5U</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">idle_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5U</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">resvport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* privileged port not needed */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">tsh_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* RPC-RDMA handles framing */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_payload</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt_rdma_procs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up RDMA-specific connect data.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Put server RDMA address in local cdata */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdata</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">);</span>

	<span class="cm">/* Ensure xprt-&gt;addr holds valid server TCP (not RDMA)</span>
<span class="cm">	 * address, for any side protocols which peek at it */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">prot</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdata</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">);</span>

	<span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cdata</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xprt_set_bound</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %pI4:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="cm">/* Set max requests */</span>
	<span class="n">cdata</span><span class="p">.</span><span class="n">max_requests</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_reqs</span><span class="p">;</span>

	<span class="cm">/* Set some length limits */</span>
	<span class="n">cdata</span><span class="p">.</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="cm">/* RDMA write max */</span>
	<span class="n">cdata</span><span class="p">.</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="cm">/* RDMA read max */</span>

	<span class="n">cdata</span><span class="p">.</span><span class="n">inline_wsize</span> <span class="o">=</span> <span class="n">xprt_rdma_max_inline_write</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="p">.</span><span class="n">inline_wsize</span> <span class="o">&gt;</span> <span class="n">cdata</span><span class="p">.</span><span class="n">wsize</span><span class="p">)</span>
		<span class="n">cdata</span><span class="p">.</span><span class="n">inline_wsize</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">.</span><span class="n">wsize</span><span class="p">;</span>

	<span class="n">cdata</span><span class="p">.</span><span class="n">inline_rsize</span> <span class="o">=</span> <span class="n">xprt_rdma_max_inline_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="p">.</span><span class="n">inline_rsize</span> <span class="o">&gt;</span> <span class="n">cdata</span><span class="p">.</span><span class="n">rsize</span><span class="p">)</span>
		<span class="n">cdata</span><span class="p">.</span><span class="n">inline_rsize</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">.</span><span class="n">rsize</span><span class="p">;</span>

	<span class="n">cdata</span><span class="p">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">xprt_rdma_inline_write_padding</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create new transport instance, which includes initialized</span>
<span class="cm">	 *  o ia</span>
<span class="cm">	 *  o endpoint</span>
<span class="cm">	 *  o buffers</span>
<span class="cm">	 */</span>

	<span class="n">new_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ia_open</span><span class="p">(</span><span class="n">new_xprt</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cdata</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">xprt_rdma_memreg_strategy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize and create ep</span>
<span class="cm">	 */</span>
	<span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_data</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">;</span>
	<span class="n">new_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">;</span>
	<span class="n">new_ep</span><span class="o">-&gt;</span><span class="n">rep_remote_addr</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate pre-registered send and receive buffers for headers and</span>
<span class="cm">	 * any inline data. Also specify any padding which will be provided</span>
<span class="cm">	 * from a preregistered zero buffer.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_buffer_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">new_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register a callback for connection events. This is necessary because</span>
<span class="cm">	 * connection loss notification is async. We also catch connection loss</span>
<span class="cm">	 * when reaping receives.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rdma_connect</span><span class="p">,</span> <span class="n">xprt_rdma_connect_worker</span><span class="p">);</span>
	<span class="n">new_ep</span><span class="o">-&gt;</span><span class="n">rep_func</span> <span class="o">=</span> <span class="n">rpcrdma_conn_func</span><span class="p">;</span>
	<span class="n">new_ep</span><span class="o">-&gt;</span><span class="n">rep_xprt</span> <span class="o">=</span> <span class="n">xprt</span><span class="p">;</span>

	<span class="n">xprt_rdma_format_addresses</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xprt</span><span class="p">;</span>

<span class="nl">out4:</span>
	<span class="n">xprt_rdma_free_addresses</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">out3:</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rpcrdma_ep_destroy</span><span class="p">(</span><span class="n">new_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">rpcrdma_ia_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="n">xprt_free</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close a connection, during shutdown or timeout/reconnect</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: closing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">.</span><span class="n">rep_connected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xprt_disconnect_done</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rpcrdma_ep_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_set_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sap</span><span class="p">;</span>

	<span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">sap</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rpcx_to_rdmad</span><span class="p">(</span><span class="n">xprt</span><span class="p">).</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">sap</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">.</span><span class="n">rep_connected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reconnect */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rdma_connect</span><span class="p">,</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span><span class="p">);</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reestablish_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rdma_connect</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RPC_IS_ASYNC</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
			<span class="n">flush_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rdma_connect</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xprt_rdma_reserve_xprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_credits</span><span class="p">);</span>

	<span class="cm">/* == RPC_CWNDSCALE @ init, but *after* setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_cwndscale</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_cwndscale</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: cwndscale %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_cwndscale</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_cwndscale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">credits</span> <span class="o">*</span> <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_cwndscale</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xprt_reserve_xprt_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The RDMA allocate/free functions need the task structure as a place</span>
<span class="cm"> * to hide the struct rpcrdma_req, which is necessary for the actual send/recv</span>
<span class="cm"> * sequence. For this reason, the recv buffers are attached to send</span>
<span class="cm"> * buffers for portions of the RPC. Note that the RPC layer allocates</span>
<span class="cm"> * both send and receive buffers in the same call. We may register</span>
<span class="cm"> * the receive buffer portion when using reply chunks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">xprt_rdma_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">nreq</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">rpcrdma_buffer_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: size %zd too large for buffer[%zd]: &quot;</span>
			<span class="s">&quot;prog %d vers %d proc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_size</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_prog</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_vers</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_proc</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Outgoing length shortage. Our inline write max must have</span>
<span class="cm">		 * been configured to perform direct i/o.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is therefore a large metadata operation, and the</span>
<span class="cm">		 * allocate call was made on the maximum possible message,</span>
<span class="cm">		 * e.g. containing long filename(s) or symlink data. In</span>
<span class="cm">		 * fact, while these metadata operations *might* carry</span>
<span class="cm">		 * large outgoing payloads, they rarely *do*. However, we</span>
<span class="cm">		 * have to commit to the request here, so reallocate and</span>
<span class="cm">		 * register it now. The data path will never require this</span>
<span class="cm">		 * reallocation.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the allocation or registration fails, the RPC framework</span>
<span class="cm">		 * will (doggedly) retry.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">.</span><span class="n">ri_memreg_strategy</span> <span class="o">==</span>
				<span class="n">RPCRDMA_BOUNCEBUFFERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* forced to &quot;pure inline&quot; */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: too much data (%zd) for inline &quot;</span>
					<span class="s">&quot;(r/w max %d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">rpcx_to_rdmad</span><span class="p">(</span><span class="n">xprt</span><span class="p">).</span><span class="n">inline_rsize</span><span class="p">,</span>
					<span class="n">rpcx_to_rdmad</span><span class="p">(</span><span class="n">xprt</span><span class="p">).</span><span class="n">inline_wsize</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_size</span><span class="p">;</span>
			<span class="n">rpc_exit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>		<span class="cm">/* fail the operation */</span>
			<span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">failed_marshal_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_flags</span> <span class="o">&amp;</span> <span class="n">RPC_TASK_SWAPPER</span><span class="p">)</span>
			<span class="n">nreq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nreq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nreq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">outfail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rpcrdma_register_internal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">,</span>
				<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_base</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">)</span>
				<span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">,</span> <span class="n">rl_base</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">nreq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">outfail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">hardway_register_count</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_niovs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_nchunks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">;</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">);</span>
		<span class="cm">/* flag the swap with an unused field */</span>
		<span class="n">nreq</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nreq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: size %zd, request 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_connect_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* our reserved value */</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_xdr_buf</span><span class="p">;</span>

<span class="nl">outfail:</span>
	<span class="n">rpcrdma_buffer_put</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">failed_marshal_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function returns all RDMA resources to the pool.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_rdma_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">,</span> <span class="n">rl_xdr_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* see allocate above */</span>
		<span class="n">r_xprt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(((</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">rpcrdma_xprt</span><span class="p">,</span> <span class="n">rx_buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r_xprt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_xprt</span><span class="p">,</span> <span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">rep</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: called on 0x%p%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="p">(</span><span class="n">rep</span> <span class="o">&amp;&amp;</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (with waiter)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finish the deregistration. When using mw bind, this was</span>
<span class="cm">	 * begun in rpcrdma_reply_handler(). In all other modes, we</span>
<span class="cm">	 * do it here, in thread context. The process is considered</span>
<span class="cm">	 * complete when the rr_func vector becomes NULL - this</span>
<span class="cm">	 * was put in place during rpcrdma_reply_handler() - the wait</span>
<span class="cm">	 * call below will not block if the dereg is &quot;done&quot;. If</span>
<span class="cm">	 * interrupted, our framework will clean up.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_nchunks</span><span class="p">;)</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_nchunks</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">rpcrdma_deregister_external</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r_xprt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span> <span class="o">&amp;&amp;</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_unbind</span><span class="p">,</span> <span class="o">!</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* abandon the callback */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* see allocate above */</span>
		<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">oreq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">;</span>
		<span class="n">oreq</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rpcrdma_deregister_internal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">,</span>
						   <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_handle</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">oreq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Put back request+reply buffers */</span>
	<span class="n">rpcrdma_buffer_put</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send_request invokes the meat of RPC RDMA. It must do the following:</span>
<span class="cm"> *  1.  Marshal the RPC request into an RPC RDMA request, which means</span>
<span class="cm"> *	putting a header in front of data, and creating IOVs for RDMA</span>
<span class="cm"> *	from those in the request.</span>
<span class="cm"> *  2.  In marshaling, detect opportunities for RDMA, and use them.</span>
<span class="cm"> *  3.  Post a recv message to set up asynch completion, then send</span>
<span class="cm"> *	the request (rpcrdma_ep_post).</span>
<span class="cm"> *  4.  No partial sends are possible in the RPC-RDMA protocol (as in UDP).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xprt_rdma_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">rqst</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">rpcr_to_rdmar</span><span class="p">(</span><span class="n">rqst</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="cm">/* marshal the send itself */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_niovs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rpcrdma_marshal_req</span><span class="p">(</span><span class="n">rqst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">failed_marshal_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rpcrdma_marshal_req failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 		<span class="cm">/* e.g. reconnection */</span>
		<span class="n">rpcrdma_recv_buffer_get</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="n">rpcrdma_reply_handler</span><span class="p">;</span>
		<span class="cm">/* this need only be done once, but... */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="o">-&gt;</span><span class="n">rr_xprt</span> <span class="o">=</span> <span class="n">xprt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Must suppress retransmit to maintain credits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_connect_cookie</span> <span class="o">==</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">connect_cookie</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_connection</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_connect_cookie</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">connect_cookie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcrdma_ep_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_connection</span><span class="p">;</span>

	<span class="n">rqst</span><span class="o">-&gt;</span><span class="n">rq_xmit_bytes_sent</span> <span class="o">+=</span> <span class="n">rqst</span><span class="o">-&gt;</span><span class="n">rq_snd_buf</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rqst</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_connection:</span>
	<span class="n">xprt_disconnect_done</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>	<span class="cm">/* implies disconnect */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_rdma_print_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">idle_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xprt_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="n">idle_time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
	  <span class="s">&quot;</span><span class="se">\t</span><span class="s">xprt:</span><span class="se">\t</span><span class="s">rdma %u %lu %lu %lu %ld %lu %lu %lu %Lu %Lu &quot;</span>
	  <span class="s">&quot;%lu %lu %lu %Lu %Lu %Lu %Lu %lu %lu %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>

	   <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* need a local port? */</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bind_count</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_count</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_time</span><span class="p">,</span>
	   <span class="n">idle_time</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sends</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">recvs</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bad_xids</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">req_u</span><span class="p">,</span>
	   <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bklog_u</span><span class="p">,</span>

	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">read_chunk_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">write_chunk_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">reply_chunk_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">total_rdma_request</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">total_rdma_reply</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">pullup_copy_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">fixup_copy_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">hardway_register_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">failed_marshal_count</span><span class="p">,</span>
	   <span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bad_reply_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Plumbing for rpc transport switch and kernel module</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_xprt_ops</span> <span class="n">xprt_rdma_procs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reserve_xprt</span>		<span class="o">=</span> <span class="n">xprt_rdma_reserve_xprt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_xprt</span>		<span class="o">=</span> <span class="n">xprt_release_xprt_cong</span><span class="p">,</span> <span class="cm">/* sunrpc/xprt.c */</span>
	<span class="p">.</span><span class="n">release_request</span>	<span class="o">=</span> <span class="n">xprt_release_rqst_cong</span><span class="p">,</span>       <span class="cm">/* ditto */</span>
	<span class="p">.</span><span class="n">set_retrans_timeout</span>	<span class="o">=</span> <span class="n">xprt_set_retrans_timeout_def</span><span class="p">,</span> <span class="cm">/* ditto */</span>
	<span class="p">.</span><span class="n">rpcbind</span>		<span class="o">=</span> <span class="n">rpcb_getport_async</span><span class="p">,</span>	<span class="cm">/* sunrpc/rpcb_clnt.c */</span>
	<span class="p">.</span><span class="n">set_port</span>		<span class="o">=</span> <span class="n">xprt_rdma_set_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>		<span class="o">=</span> <span class="n">xprt_rdma_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_alloc</span>		<span class="o">=</span> <span class="n">xprt_rdma_allocate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_free</span>		<span class="o">=</span> <span class="n">xprt_rdma_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_request</span>		<span class="o">=</span> <span class="n">xprt_rdma_send_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">xprt_rdma_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>		<span class="o">=</span> <span class="n">xprt_rdma_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_stats</span>		<span class="o">=</span> <span class="n">xprt_rdma_print_stats</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xprt_class</span> <span class="n">xprt_rdma</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">list</span>			<span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">xprt_rdma</span><span class="p">.</span><span class="n">list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;rdma&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ident</span>			<span class="o">=</span> <span class="n">XPRT_TRANSPORT_RDMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>			<span class="o">=</span> <span class="n">xprt_setup_rdma</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xprt_rdma_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RPCRDMA Module Removed, deregister RPC RDMA transport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef RPC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sunrpc_table_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">sunrpc_table_header</span><span class="p">);</span>
		<span class="n">sunrpc_table_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">xprt_unregister_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_rdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: xprt_unregister returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xprt_rdma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">xprt_register_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_rdma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RPCRDMA Module Init, register RPC RDMA transport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Defaults:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Slots %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">MaxInlineRead %d</span><span class="se">\n\t</span><span class="s">MaxInlineWrite %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">xprt_rdma_slot_table_entries</span><span class="p">,</span>
		<span class="n">xprt_rdma_max_inline_read</span><span class="p">,</span> <span class="n">xprt_rdma_max_inline_write</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Padding %d</span><span class="se">\n\t</span><span class="s">Memreg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">xprt_rdma_inline_write_padding</span><span class="p">,</span> <span class="n">xprt_rdma_memreg_strategy</span><span class="p">);</span>

<span class="cp">#ifdef RPC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sunrpc_table_header</span><span class="p">)</span>
		<span class="n">sunrpc_table_header</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">sunrpc_table</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">xprt_rdma_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xprt_rdma_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
