<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › xprtrdma › svc_rdma_recvfrom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>svc_rdma_recvfrom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2006 Network Appliance, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the BSD-type</span>
<span class="cm"> * license below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions of source code must retain the above copyright</span>
<span class="cm"> *      notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions in binary form must reproduce the above</span>
<span class="cm"> *      copyright notice, this list of conditions and the following</span>
<span class="cm"> *      disclaimer in the documentation and/or other materials provided</span>
<span class="cm"> *      with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> *      Neither the name of the Network Appliance, Inc. nor the names of</span>
<span class="cm"> *      its contributors may be used to endorse or promote products</span>
<span class="cm"> *      derived from this software without specific prior written</span>
<span class="cm"> *      permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Tom Tucker &lt;tom@opengridcomputing.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sunrpc/debug.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/rpc_rdma.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/rdma_cm.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svc_rdma.h&gt;</span>

<span class="cp">#define RPCDBG_FACILITY	RPCDBG_SVCXPRT</span>

<span class="cm">/*</span>
<span class="cm"> * Replace the pages in the rq_argpages array with the pages from the SGE in</span>
<span class="cm"> * the RDMA_RECV completion. The SGL should contain full pages up until the</span>
<span class="cm"> * last one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdma_build_arg_xdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">byte_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sge_no</span><span class="p">;</span>

	<span class="cm">/* Swap the page in the SGE with the page in argpages */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Set up the XDR head */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">byte_count</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="cm">/* Compute bytes past head in the SGL */</span>
	<span class="n">bc</span> <span class="o">=</span> <span class="n">byte_count</span> <span class="o">-</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="cm">/* If data remains, store it in the pagelist */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sge_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;&amp;</span> <span class="n">sge_no</span> <span class="o">&lt;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">sge_no</span><span class="p">];</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">sge_no</span><span class="p">]);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">sge_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">bc</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sge_no</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">+=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sge_no</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">sge_no</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">sge_no</span><span class="p">];</span>

	<span class="cm">/* We should never run out of SGE because the limit is defined to</span>
<span class="cm">	 * support the max allowed RPC data length</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sge_no</span> <span class="o">==</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span><span class="p">)</span>
	       <span class="o">!=</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="cm">/* If not all pages were used from the SGL, free the remaining ones */</span>
	<span class="n">bc</span> <span class="o">=</span> <span class="n">sge_no</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sge_no</span> <span class="o">&lt;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">sge_no</span><span class="o">++</span><span class="p">];</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>

	<span class="cm">/* Set up tail */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encode a read-chunk-list as an array of IB SGE</span>
<span class="cm"> *</span>
<span class="cm"> * Assumptions:</span>
<span class="cm"> * - chunk[0]-&gt;position points to pages[0] at an offset of 0</span>
<span class="cm"> * - pages[] is not physically or virtually contiguous and consists of</span>
<span class="cm"> *   PAGE_SIZE elements.</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> * - sge array pointing into pages[] array.</span>
<span class="cm"> * - chunk_sge array specifying sge index and count for each</span>
<span class="cm"> *   chunk in the read list</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_read_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="n">rmsgp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">rpl_map</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">chl_map</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">ch_count</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">byte_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sge_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sge_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_no</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">sge_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">page_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">page_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rmsgp</span><span class="o">-&gt;</span><span class="n">rm_body</span><span class="p">.</span><span class="n">rm_chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ch_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_bytes</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_target</span><span class="p">.</span><span class="n">rs_length</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">hdr_count</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="cm">/* save count of hdr pages */</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">ch_bytes</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">ch_bytes</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">+</span> <span class="n">ch_bytes</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">byte_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpl_map</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sge_no</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span>
			<span class="n">page_address</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">])</span> <span class="o">+</span> <span class="n">page_off</span><span class="p">;</span>
		<span class="n">sge_bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">page_off</span><span class="p">,</span> <span class="n">ch_bytes</span><span class="p">);</span>
		<span class="n">rpl_map</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sge_no</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">sge_bytes</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t bump head-&gt;count here because the same page</span>
<span class="cm">		 * may be used by multiple SGE.</span>
<span class="cm">		 */</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">];</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">byte_count</span> <span class="o">-=</span> <span class="n">sge_bytes</span><span class="p">;</span>
		<span class="n">ch_bytes</span> <span class="o">-=</span> <span class="n">sge_bytes</span><span class="p">;</span>
		<span class="n">sge_no</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If all bytes for this chunk have been mapped to an</span>
<span class="cm">		 * SGE, move to the next SGE</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span>
				<span class="n">sge_no</span> <span class="o">-</span> <span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
			<span class="n">ch_no</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">sge_no</span><span class="p">;</span>
			<span class="n">ch_bytes</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_target</span><span class="p">.</span><span class="n">rs_length</span><span class="p">);</span>
			<span class="cm">/* If bytes remaining account for next chunk */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">+=</span> <span class="n">ch_bytes</span><span class="p">;</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">ch_bytes</span><span class="p">;</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">+=</span> <span class="n">ch_bytes</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this SGE consumed all of the page, move to the</span>
<span class="cm">		 * next page</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sge_bytes</span> <span class="o">+</span> <span class="n">page_off</span><span class="p">)</span> <span class="o">==</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page_no</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there are still bytes left to map, bump</span>
<span class="cm">			 * the page count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span><span class="p">)</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">page_off</span> <span class="o">+=</span> <span class="n">sge_bytes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">byte_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sge_no</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Map a read-chunk-list to an XDR and fast register the page-list.</span>
<span class="cm"> *</span>
<span class="cm"> * Assumptions:</span>
<span class="cm"> * - chunk[0]	position points to pages[0] at an offset of 0</span>
<span class="cm"> * - pages[]	will be made physically contiguous by creating a one-off memory</span>
<span class="cm"> *		region using the fastreg verb.</span>
<span class="cm"> * - byte_count is # of bytes in read-chunk-list</span>
<span class="cm"> * - ch_count	is # of chunks in read-chunk-list</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> * - sge array pointing into pages[] array.</span>
<span class="cm"> * - chunk_sge array specifying sge index and count for each</span>
<span class="cm"> *   chunk in the read list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fast_reg_read_chunks</span><span class="p">(</span><span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="n">rmsgp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">rpl_map</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">chl_map</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">ch_count</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">byte_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_no</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_rdma_fastreg_mr</span> <span class="o">*</span><span class="n">frmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">frmr</span> <span class="o">=</span> <span class="n">svc_rdma_get_frmr</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">frmr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">head</span><span class="o">-&gt;</span><span class="n">frmr</span> <span class="o">=</span> <span class="n">frmr</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">];</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">hdr_count</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="cm">/* save count of hdr pages */</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">+</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="cm">/* Fast register the page list */</span>
	<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">kva</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">access_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="o">|</span><span class="n">IB_ACCESS_REMOTE_WRITE</span><span class="p">);</span>
	<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">map_len</span> <span class="o">=</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">page_list_len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">byte_count</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_no</span> <span class="o">&lt;</span> <span class="n">frmr</span><span class="o">-&gt;</span><span class="n">page_list_len</span><span class="p">;</span> <span class="n">page_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">page_no</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ib_dma_map_page</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					 <span class="n">frmr</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="o">-&gt;</span><span class="n">page_list</span><span class="p">[</span><span class="n">page_no</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">fatal_err</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_dma_used</span><span class="p">);</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">page_no</span><span class="p">;</span>

	<span class="cm">/* rq_respages points one past arg pages */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">];</span>

	<span class="cm">/* Create the reply and chunk maps */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rmsgp</span><span class="o">-&gt;</span><span class="n">rm_body</span><span class="p">.</span><span class="n">rm_chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_no</span> <span class="o">&lt;</span> <span class="n">ch_count</span><span class="p">;</span> <span class="n">ch_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_target</span><span class="p">.</span><span class="n">rs_length</span><span class="p">);</span>
		<span class="n">rpl_map</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">frmr</span><span class="o">-&gt;</span><span class="n">kva</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">rpl_map</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">ch_no</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">svc_rdma_fastreg</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">frmr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fatal_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ch_no</span><span class="p">;</span>

 <span class="nl">fatal_err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;svcrdma: error fast registering xdr for xprt %p&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">svc_rdma_put_frmr</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">frmr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_set_ctxt_sge</span><span class="p">(</span><span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">svc_rdma_fastreg_mr</span> <span class="o">*</span><span class="n">frmr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">vec</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="o">*</span><span class="n">sgl_offset</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* in case map fails */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frmr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">));</span>
			<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span>
				<span class="n">ib_dma_map_page</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						<span class="n">virt_to_page</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">),</span>
						<span class="n">off</span><span class="p">,</span>
						<span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span>
						<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						 <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_dma_lkey</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_dma_used</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">frmr</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sgl_offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">sgl_offset</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_read_max_sge</span><span class="p">(</span><span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sge_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdma_node_get_transport</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">)</span> <span class="o">==</span>
	     <span class="n">RDMA_TRANSPORT_IWARP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sge_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">sge_count</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_max_sge</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use RDMA_READ to read data from the advertised client buffer into the</span>
<span class="cm"> * XDR stream starting at rq_arg.head[0].iov_base.</span>
<span class="cm"> * Each chunk in the array</span>
<span class="cm"> * contains the following fields:</span>
<span class="cm"> * discrim      - &#39;1&#39;, This isn&#39;t used for data placement</span>
<span class="cm"> * position     - The xdr stream offset (the same for every chunk)</span>
<span class="cm"> * handle       - RMR for client memory region</span>
<span class="cm"> * length       - data transfer length</span>
<span class="cm"> * offset       - 64 bit tagged offset in remote memory region</span>
<span class="cm"> *</span>
<span class="cm"> * On our side, we need to read into a pagelist. The first page immediately</span>
<span class="cm"> * follows the RPC header.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns:</span>
<span class="cm"> * 0 - No error and no read-list found.</span>
<span class="cm"> *</span>
<span class="cm"> * 1 - Successful read-list processing. The data is not yet in</span>
<span class="cm"> * the pagelist and therefore the RPC request must be deferred. The</span>
<span class="cm"> * I/O completion will enqueue the transport again and</span>
<span class="cm"> * svc_rdma_recvfrom will complete the request.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;0 - Error processing/posting read-list.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: The ctxt must not be touched after the last WR has been posted</span>
<span class="cm"> * because the I/O completion processing may occur on another</span>
<span class="cm"> * processor and free / modify the context. Ne touche pas!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_read_xdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="n">rmsgp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">hdr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">read_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">inv_wr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sge_count</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sgl_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">ctxt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">rpl_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_rdma_req_map</span> <span class="o">*</span><span class="n">chl_map</span><span class="p">;</span>

	<span class="cm">/* If no read list is present, return 0 */</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">svc_rdma_get_read_chunk</span><span class="p">(</span><span class="n">rmsgp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">svc_rdma_rcl_chunk_counts</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_count</span> <span class="o">&gt;</span> <span class="n">RPCSVC_MAXPAGES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Allocate temporary reply and chunk maps */</span>
	<span class="n">rpl_map</span> <span class="o">=</span> <span class="n">svc_rdma_get_req_map</span><span class="p">();</span>
	<span class="n">chl_map</span> <span class="o">=</span> <span class="n">svc_rdma_get_req_map</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_frmr_pg_list_len</span><span class="p">)</span>
		<span class="n">sge_count</span> <span class="o">=</span> <span class="n">map_read_chunks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">hdr_ctxt</span><span class="p">,</span> <span class="n">rmsgp</span><span class="p">,</span>
					    <span class="n">rpl_map</span><span class="p">,</span> <span class="n">chl_map</span><span class="p">,</span> <span class="n">ch_count</span><span class="p">,</span>
					    <span class="n">byte_count</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sge_count</span> <span class="o">=</span> <span class="n">fast_reg_read_chunks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">hdr_ctxt</span><span class="p">,</span> <span class="n">rmsgp</span><span class="p">,</span>
						 <span class="n">rpl_map</span><span class="p">,</span> <span class="n">chl_map</span><span class="p">,</span> <span class="n">ch_count</span><span class="p">,</span>
						 <span class="n">byte_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sge_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sgl_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_read_chunk</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rmsgp</span><span class="o">-&gt;</span><span class="n">rm_body</span><span class="p">.</span><span class="n">rm_chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_discrim</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">,</span> <span class="n">ch_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">rs_offset</span><span class="p">;</span>
<span class="nl">next_sge:</span>
		<span class="n">ctxt</span> <span class="o">=</span> <span class="n">svc_rdma_get_context</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span> <span class="o">=</span> <span class="n">hdr_ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">read_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RDMACTXT_F_LAST_CTXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RDMACTXT_F_FAST_UNREG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Prepare READ WR */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">read_wr</span><span class="p">);</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctxt</span><span class="p">;</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_RDMA_READ</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">wr_op</span> <span class="o">=</span> <span class="n">read_wr</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_target</span><span class="p">.</span><span class="n">rs_handle</span><span class="p">);</span>
		<span class="n">xdr_decode_hyper</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rc_target</span><span class="p">.</span><span class="n">rs_offset</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rs_offset</span><span class="p">);</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">rdma</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">rs_offset</span> <span class="o">+</span> <span class="n">sgl_offset</span><span class="p">;</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">;</span>
		<span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span>
			<span class="n">rdma_read_max_sge</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdma_set_ctxt_sge</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">hdr_ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rpl_map</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">start</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">sgl_offset</span><span class="p">,</span>
					<span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">svc_rdma_unmap_dma</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
			<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rc_discrim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">==</span> <span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Mark the last RDMA_READ with a bit to</span>
<span class="cm">			 * indicate all RPC data has been fetched from</span>
<span class="cm">			 * the client and the RPC needs to be enqueued.</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RDMACTXT_F_LAST_CTXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdr_ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">RDMACTXT_F_FAST_UNREG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Invalidate the local MR used to map the data</span>
<span class="cm">				 * sink.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_dev_caps</span> <span class="o">&amp;</span>
				    <span class="n">SVCRDMA_DEVCAP_READ_W_INV</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">read_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span>
						<span class="n">IB_WR_RDMA_READ_WITH_INV</span><span class="p">;</span>
					<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">wr_op</span> <span class="o">=</span> <span class="n">read_wr</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
					<span class="n">read_wr</span><span class="p">.</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span>
						<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Prepare INVALIDATE WR */</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inv_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">inv_wr</span><span class="p">);</span>
					<span class="n">inv_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_LOCAL_INV</span><span class="p">;</span>
					<span class="n">inv_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
					<span class="n">inv_wr</span><span class="p">.</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span>
						<span class="n">hdr_ctxt</span><span class="o">-&gt;</span><span class="n">frmr</span><span class="o">-&gt;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
					<span class="n">read_wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inv_wr</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">read_hdr</span> <span class="o">=</span> <span class="n">hdr_ctxt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Post the read */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">svc_rdma_send</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_wr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;svcrdma: Error %d posting RDMA_READ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sc_xprt</span><span class="p">.</span><span class="n">xpt_flags</span><span class="p">);</span>
			<span class="n">svc_rdma_unmap_dma</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
			<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_stat_read</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">&lt;</span> <span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">count</span> <span class="o">-=</span> <span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span><span class="p">;</span>
			<span class="n">chl_map</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">ch_no</span><span class="p">].</span><span class="n">start</span> <span class="o">+=</span> <span class="n">read_wr</span><span class="p">.</span><span class="n">num_sge</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_sge</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sgl_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">svc_rdma_put_req_map</span><span class="p">(</span><span class="n">rpl_map</span><span class="p">);</span>
	<span class="n">svc_rdma_put_req_map</span><span class="p">(</span><span class="n">chl_map</span><span class="p">);</span>

	<span class="cm">/* Detach arg pages. svc_recv will replenish them */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">ch_no</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">;</span> <span class="n">ch_no</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">ch_no</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detach res pages. svc_release must see a resused count of</span>
<span class="cm">	 * zero or it will attempt to put them.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="p">)</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span><span class="p">[</span><span class="o">--</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_read_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">);</span>

	<span class="cm">/* Copy RPC pages */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_no</span> <span class="o">&lt;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">page_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">]);</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* Point rq_arg.pages past header */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_pages</span><span class="p">[</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">hdr_count</span><span class="p">];</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_len</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_base</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">page_base</span><span class="p">;</span>

	<span class="cm">/* rq_respages starts after the last arg page */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_respages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_no</span><span class="p">];</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_resused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Rebuild rq_arg head and tail. */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">buflen</span><span class="p">;</span>

	<span class="cm">/* Free the context */</span>
	<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* XXX: What should this be? */</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_prot</span> <span class="o">=</span> <span class="n">IPPROTO_MAX</span><span class="p">;</span>
	<span class="n">svc_xprt_copy_addrs</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span>
		<span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span>
		<span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svcrdma: deferred read ret=%d, rq_arg.len =%d, &quot;</span>
		<span class="s">&quot;rq_arg.head[0].iov_base=%p, rq_arg.head[0].iov_len = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up the rqstp thread context to point to the RQ buffer. If</span>
<span class="cm"> * necessary, pull additional data from the client with an RDMA_READ</span>
<span class="cm"> * request.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">svc_rdma_recvfrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svcxprt_rdma</span> <span class="o">*</span><span class="n">rdma_xprt</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svcxprt_rdma</span><span class="p">,</span> <span class="n">sc_xprt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span> <span class="o">*</span><span class="n">ctxt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="n">rmsgp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svcrdma: rqstp=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_rq_dto_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_read_complete_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctxt</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_read_complete_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span><span class="p">,</span>
				  <span class="n">dto_q</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dto_q</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_rq_dto_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rdma_read_complete</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_rq_dto_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctxt</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_rq_dto_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">svc_rdma_op_ctxt</span><span class="p">,</span>
				  <span class="n">dto_q</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dto_q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_stat_rq_starve</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPT_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">);</span>
		<span class="n">ctxt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_xprt</span><span class="o">-&gt;</span><span class="n">sc_rq_dto_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctxt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the EAGAIN path. The svc_recv routine will</span>
<span class="cm">		 * return -EAGAIN, the nfsd thread will go to call into</span>
<span class="cm">		 * svc_recv again and we shouldn&#39;t be on the active</span>
<span class="cm">		 * transport list</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">close_out</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svcrdma: processing ctxt=%p on xprt=%p, rqstp=%p, status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ctxt</span><span class="p">,</span> <span class="n">rdma_xprt</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">wc_status</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">wc_status</span> <span class="o">!=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma_stat_recv</span><span class="p">);</span>

	<span class="cm">/* Build up the XDR from the receive buffers. */</span>
	<span class="n">rdma_build_arg_xdr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">);</span>

	<span class="cm">/* Decode the RDMA header. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">svc_rdma_xdr_decode_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmsgp</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt_hlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* If the request is invalid, reply with an error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span>
			<span class="n">svc_rdma_send_error</span><span class="p">(</span><span class="n">rdma_xprt</span><span class="p">,</span> <span class="n">rmsgp</span><span class="p">,</span> <span class="n">ERR_VERS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">close_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read read-list data. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdma_read_xdr</span><span class="p">(</span><span class="n">rdma_xprt</span><span class="p">,</span> <span class="n">rmsgp</span><span class="p">,</span> <span class="n">rqstp</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read-list posted, defer until data received from client. */</span>
		<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Post of read-list failed, free context. */</span>
		<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span>
		<span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">page_len</span>
		<span class="o">+</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svcrdma: ret = %d, rq_arg.len =%d, &quot;</span>
		<span class="s">&quot;rq_arg.head[0].iov_base=%p, rq_arg.head[0].iov_len = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span> <span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_arg</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_prot</span> <span class="o">=</span> <span class="n">IPPROTO_MAX</span><span class="p">;</span>
	<span class="n">svc_xprt_copy_addrs</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">close_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="p">)</span>
		<span class="n">svc_rdma_put_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;svcrdma: transport %p is closing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the close bit and enqueue it. svc_recv will see the</span>
<span class="cm">	 * close bit and call svc_xprt_delete</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPT_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xpt_flags</span><span class="p">);</span>
<span class="nl">defer:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
