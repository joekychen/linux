<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › xprtrdma › verbs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>verbs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2003-2007 Network Appliance, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the BSD-type</span>
<span class="cm"> * license below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions of source code must retain the above copyright</span>
<span class="cm"> *      notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      Redistributions in binary form must reproduce the above</span>
<span class="cm"> *      copyright notice, this list of conditions and the following</span>
<span class="cm"> *      disclaimer in the documentation and/or other materials provided</span>
<span class="cm"> *      with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> *      Neither the name of the Network Appliance, Inc. nor the names of</span>
<span class="cm"> *      its contributors may be used to endorse or promote products</span>
<span class="cm"> *      derived from this software without specific prior written</span>
<span class="cm"> *      permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * verbs.c</span>
<span class="cm"> *</span>
<span class="cm"> * Encapsulates the major functions managing:</span>
<span class="cm"> *  o adapters</span>
<span class="cm"> *  o endpoints</span>
<span class="cm"> *  o connections</span>
<span class="cm"> *  o buffer memory</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;	</span><span class="cm">/* for Tavor hack below */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;xprt_rdma.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Globals/Macros</span>
<span class="cm"> */</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="cp"># define RPCDBG_FACILITY	RPCDBG_TRANS</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * internal functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * handle replies in tasklet context, using a single, global list</span>
<span class="cm"> * rdma tasklet function -- just turn around and call the func</span>
<span class="cm"> * for all replies on the list</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rpcrdma_tasklets_g</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_run_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tasklets_g</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rep</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">rpcrdma_tasklets_g</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rpcrdma_rep</span><span class="p">,</span> <span class="n">rr_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_list</span><span class="p">);</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span><span class="p">;</span>
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span>
			<span class="n">func</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rpcrdma_recv_buffer_put</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">rpcrdma_tasklet_g</span><span class="p">,</span> <span class="n">rpcrdma_run_tasklet</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">rpcrdma_schedule_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpcrdma_tasklets_g</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tk_lock_g</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcrdma_tasklet_g</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_qp_async_error_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: QP error %X on device %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_func</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_cq_async_error_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: CQ error %X on device %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_func</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">rpcrdma_event_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="n">frmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: event rep %p status %X opcode %X length %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rep</span><span class="p">)</span> <span class="cm">/* send or bind completion that we don&#39;t care about */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IB_WC_SUCCESS</span> <span class="o">!=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: WC opcode %d status %X, connection lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_len</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">IB_WC_FAST_REG_MR</span> <span class="o">&amp;&amp;</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">IB_WC_LOCAL_INV</span><span class="p">)</span>
			<span class="n">rpcrdma_schedule_tasklet</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IB_WC_FAST_REG_MR</span>:
		<span class="n">frmr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">FRMR_IS_VALID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WC_LOCAL_INV</span>:
		<span class="n">frmr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wr_id</span><span class="p">;</span>
		<span class="n">frmr</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">FRMR_IS_INVALID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IB_WC_RECV</span>:
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_len</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">byte_len</span><span class="p">;</span>
		<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span>
			<span class="n">rdmab_to_ia</span><span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="cm">/* Keep (only) the most recent credits, after check validity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_len</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_base</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rm_credit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: server&quot;</span>
					<span class="s">&quot; dropped credits to 0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="cm">/* don&#39;t deadlock */</span>
				<span class="n">credits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&gt;</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: server&quot;</span>
					<span class="s">&quot; over-crediting: %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span>
					<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">);</span>
				<span class="n">credits</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="o">-&gt;</span><span class="n">rb_credits</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IB_WC_BIND_MW</span>:
		<span class="n">rpcrdma_schedule_tasklet</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: unexpected WC event %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rpcrdma_cq_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_poll_cq failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rpcrdma_event_process</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rpcrdma_cq_event_upcall</span>
<span class="cm"> *</span>
<span class="cm"> * This upcall handles recv, send, bind and unbind events.</span>
<span class="cm"> * It is reentrant but processes single events in order to maintain</span>
<span class="cm"> * ordering of receives to keep server credits.</span>
<span class="cm"> *</span>
<span class="cm"> * It is the responsibility of the scheduled tasklet to return</span>
<span class="cm"> * recv buffers to the pool. NOTE: this affects synchronization of</span>
<span class="cm"> * connection shutdown. That is, the structures required for</span>
<span class="cm"> * the completion of the reply handler must remain intact until</span>
<span class="cm"> * all memory has been reclaimed.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that send events are suppressed and do not result in an upcall.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_cq_event_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_cq_poll</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_req_notify_cq failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpcrdma_cq_poll</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">conn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;address resolved&quot;</span><span class="p">,</span>
	<span class="s">&quot;address error&quot;</span><span class="p">,</span>
	<span class="s">&quot;route resolved&quot;</span><span class="p">,</span>
	<span class="s">&quot;route error&quot;</span><span class="p">,</span>
	<span class="s">&quot;connect request&quot;</span><span class="p">,</span>
	<span class="s">&quot;connect response&quot;</span><span class="p">,</span>
	<span class="s">&quot;connect error&quot;</span><span class="p">,</span>
	<span class="s">&quot;unreachable&quot;</span><span class="p">,</span>
	<span class="s">&quot;rejected&quot;</span><span class="p">,</span>
	<span class="s">&quot;established&quot;</span><span class="p">,</span>
	<span class="s">&quot;disconnected&quot;</span><span class="p">,</span>
	<span class="s">&quot;device removal&quot;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_conn_upcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdma_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">;</span>
<span class="cp">#ifdef RPC_DEBUG</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_addr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="n">iattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ADDR_RESOLVED</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ROUTE_RESOLVED</span>:
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ADDR_ERROR</span>:
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: CM address resolution error, ep 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ROUTE_ERROR</span>:
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: CM route resolution error, ep 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ESTABLISHED</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ib_query_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span>
			<span class="n">IB_QP_MAX_QP_RD_ATOMIC</span> <span class="o">|</span> <span class="n">IB_QP_MAX_DEST_RD_ATOMIC</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">iattr</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %d responder resources&quot;</span>
			<span class="s">&quot; (%d initiator)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">max_dest_rd_atomic</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">max_rd_atomic</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">connected</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_CONNECT_ERROR</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">connected</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_UNREACHABLE</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">connected</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_REJECTED</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">connected</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_DISCONNECTED</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">connected</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_DEVICE_REMOVAL</span>:
		<span class="n">connstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">connected:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %s: %pI4:%u (ep 0x%p event 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">?</span> <span class="n">conn</span><span class="p">[</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">]</span> <span class="o">:</span>
						<span class="s">&quot;unknown connection error&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">),</span>
			<span class="n">ep</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcx_to_rdmax</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_xprt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_credits</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %sconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">connstate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="n">connstate</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_func</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: unexpected CM event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef RPC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connstate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ird</span> <span class="o">=</span> <span class="n">attr</span><span class="p">.</span><span class="n">max_dest_rd_atomic</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tird</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rpcrdma: connection to %pI4:%u &quot;</span>
			<span class="s">&quot;on %s, memreg %d slots %d ird %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">),</span>
			<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">,</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">.</span><span class="n">rb_max_requests</span><span class="p">,</span>
			<span class="n">ird</span><span class="p">,</span> <span class="n">ird</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">ird</span> <span class="o">&lt;</span> <span class="n">tird</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot; (low!)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">connstate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rpcrdma: connection to %pI4:%u closed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">),</span>
			<span class="n">connstate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span>
<span class="nf">rpcrdma_create_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">rdma_create_id</span><span class="p">(</span><span class="n">rpcrdma_conn_upcall</span><span class="p">,</span> <span class="n">xprt</span><span class="p">,</span> <span class="n">RDMA_PS_TCP</span><span class="p">,</span> <span class="n">IB_QPT_RC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_create_id() failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdma_resolve_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">RDMA_RESOLVE_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_resolve_addr() failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RDMA_RESOLVE_TIMEOUT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdma_resolve_route</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">RDMA_RESOLVE_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_resolve_route() failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_done</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">RDMA_RESOLVE_TIMEOUT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_async_rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Drain any cq, prior to teardown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_clean_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">))</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: flushed %d events (last 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Exported functions.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Open and initialize an Interface Adapter.</span>
<span class="cm"> *  o initializes fields of struct rpcrdma_ia, including</span>
<span class="cm"> *    interface and provider attributes and protection zone.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ia_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">memreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">mem_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="n">devattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">;</span>

	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span> <span class="o">=</span> <span class="n">rpcrdma_create_id</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span> <span class="o">=</span> <span class="n">ib_alloc_pd</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_alloc_pd() failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Query the device to determine if the requested memory</span>
<span class="cm">	 * registration strategy is supported. If it isn&#39;t, set the</span>
<span class="cm">	 * strategy to a globally supported model.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_query_device</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_query_device failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devattr</span><span class="p">.</span><span class="n">device_cap_flags</span> <span class="o">&amp;</span> <span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_have_dma_lkey</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_dma_lkey</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">local_dma_lkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">memreg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devattr</span><span class="p">.</span><span class="n">device_cap_flags</span> <span class="o">&amp;</span> <span class="n">IB_DEVICE_MEM_WINDOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: MEMWINDOWS registration &quot;</span>
				<span class="s">&quot;specified but not supported by adapter, &quot;</span>
				<span class="s">&quot;using slower RPCRDMA_REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_REGISTER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">alloc_fmr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if RPCRDMA_PERSISTENT_REGISTRATION</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: MTHCAFMR registration &quot;</span>
				<span class="s">&quot;specified but not supported by adapter, &quot;</span>
				<span class="s">&quot;using riskier RPCRDMA_ALLPHYSICAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_ALLPHYSICAL</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: MTHCAFMR registration &quot;</span>
				<span class="s">&quot;specified but not supported by adapter, &quot;</span>
				<span class="s">&quot;using slower RPCRDMA_REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_REGISTER</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="cm">/* Requires both frmr reg and local dma lkey */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devattr</span><span class="p">.</span><span class="n">device_cap_flags</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">IB_DEVICE_MEM_MGT_EXTENSIONS</span><span class="o">|</span><span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span><span class="p">))</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">IB_DEVICE_MEM_MGT_EXTENSIONS</span><span class="o">|</span><span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if RPCRDMA_PERSISTENT_REGISTRATION</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: FRMR registration &quot;</span>
				<span class="s">&quot;specified but not supported by adapter, &quot;</span>
				<span class="s">&quot;using riskier RPCRDMA_ALLPHYSICAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_ALLPHYSICAL</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: FRMR registration &quot;</span>
				<span class="s">&quot;specified but not supported by adapter, &quot;</span>
				<span class="s">&quot;using slower RPCRDMA_REGISTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_REGISTER</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Optionally obtain an underlying physical identity mapping in</span>
<span class="cm">	 * order to do a memory window-based bind. This base registration</span>
<span class="cm">	 * is protected from remote access - that is enabled only by binding</span>
<span class="cm">	 * for the specific bytes targeted during each RPC operation, and</span>
<span class="cm">	 * revoked after the corresponding completion similar to a storage</span>
<span class="cm">	 * adapter.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">memreg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_BOUNCEBUFFERS</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_REGISTER</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if RPCRDMA_PERSISTENT_REGISTRATION</span>
	<span class="k">case</span> <span class="n">RPCRDMA_ALLPHYSICAL</span>:
		<span class="n">mem_priv</span> <span class="o">=</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">|</span>
				<span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">|</span>
				<span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">register_setup</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="n">mem_priv</span> <span class="o">=</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">|</span>
				<span class="n">IB_ACCESS_MW_BIND</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">register_setup</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_have_dma_lkey</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mem_priv</span> <span class="o">=</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">;</span>
	<span class="nl">register_setup:</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span> <span class="o">=</span> <span class="n">ib_get_dma_mr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span> <span class="n">mem_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: ib_get_dma_mr for &quot;</span>
				<span class="s">&quot;phys register failed with %lX</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;Will continue with degraded performance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="p">));</span>
			<span class="n">memreg</span> <span class="o">=</span> <span class="n">RPCRDMA_REGISTER</span><span class="p">;</span>
			<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid memory registration mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">memreg</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: memory registration strategy is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">memreg</span><span class="p">);</span>

	<span class="cm">/* Else will do memory reg/dereg for each chunk */</span>
	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span> <span class="o">=</span> <span class="n">memreg</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
	<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clean up/close an IA.</span>
<span class="cm"> *   o if event handles and PD have been initialized, free them.</span>
<span class="cm"> *   o close the IA</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rpcrdma_ia_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_dereg_mr returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">)</span>
			<span class="n">rdma_destroy_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dealloc_pd</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_dealloc_pd returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create unconnected endpoint.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rpcrdma_create_data_internal</span> <span class="o">*</span><span class="n">cdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="n">devattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_query_device</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_query_device failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check provider&#39;s send/recv wr limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span> <span class="o">&gt;</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_wr</span><span class="p">)</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span> <span class="o">=</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_wr</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">event_handler</span> <span class="o">=</span> <span class="n">rpcrdma_qp_async_error_upcall</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">qp_context</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="cm">/* send_cq and recv_cq initialized below */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">srq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="cm">/* Add room for frmr register and invalidate WRs.</span>
<span class="cm">		 * 1. FRMR reg WR for head</span>
<span class="cm">		 * 2. FRMR invalidate WR for head</span>
<span class="cm">		 * 3. FRMR reg WR for pagelist</span>
<span class="cm">		 * 4. FRMR invalidate WR for pagelist</span>
<span class="cm">		 * 5. FRMR reg WR for tail</span>
<span class="cm">		 * 6. FRMR invalidate WR for tail</span>
<span class="cm">		 * 7. The RDMA_SEND WR</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">*=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">&gt;</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_wr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span> <span class="o">=</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_wr</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span> <span class="o">*</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="cm">/* Add room for mw_binds+unbinds - overkill! */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">&gt;</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_wr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">padding</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_inline_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">sq_sig_type</span> <span class="o">=</span> <span class="n">IB_SIGNAL_REQ_WR</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">qp_type</span> <span class="o">=</span> <span class="n">IB_QPT_RC</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">port_num</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: requested max: dtos: send %d recv %d; &quot;</span>
		<span class="s">&quot;iovs: send %d recv %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span><span class="p">);</span>

	<span class="cm">/* set trigger for requesting send completion */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cqinit</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span><span class="o">/</span><span class="mi">2</span> <span class="cm">/*  - 1*/</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cqinit</span> <span class="o">-=</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cqinit</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cqinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_CQCOUNT</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_ia</span> <span class="o">=</span> <span class="n">ia</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create a single cq for receive dto and mw_bind (only ever</span>
<span class="cm">	 * care about unbind, really). Send completions are suppressed.</span>
<span class="cm">	 * Use single threaded tasklet upcalls to maintain ordering.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span> <span class="o">=</span> <span class="n">ib_create_cq</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">rpcrdma_cq_event_upcall</span><span class="p">,</span>
				  <span class="n">rpcrdma_cq_async_error_upcall</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">+</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_create_cq failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_req_notify_cq failed: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">.</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">;</span>

	<span class="cm">/* Initialize cma parameters */</span>

	<span class="cm">/* RPC/RDMA does not use private data */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Client offers RDMA Read but does not initiate */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">initiator_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span> <span class="o">==</span> <span class="n">RPCRDMA_BOUNCEBUFFERS</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_rd_atom</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>	<span class="cm">/* arbitrary but &lt;= 255 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">=</span> <span class="n">devattr</span><span class="p">.</span><span class="n">max_qp_rd_atom</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">flow_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">rnr_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out2:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_destroy_cq returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rpcrdma_ep_destroy</span>
<span class="cm"> *</span>
<span class="cm"> * Disconnect and destroy endpoint. After this, the only</span>
<span class="cm"> * valid operations on the ep are to free it (if dynamically</span>
<span class="cm"> * allocated) or re-create it.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller&#39;s error handling must be sure to not leak the endpoint</span>
<span class="cm"> * if this function fails.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: entering, connected is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rpcrdma_ep_disconnect&quot;</span>
				<span class="s">&quot; returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rdma_destroy_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* padding - could be done in rpcrdma_buffer_destroy... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad_mr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpcrdma_deregister_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad_mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad_mr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpcrdma_clean_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_destroy_cq returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Connect unconnected endpoint.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
<span class="nl">retry:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_disconnect</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rpcrdma_ep_disconnect&quot;</span>
				<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rpcrdma_clean_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>

		<span class="n">xprt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_xprt</span><span class="p">,</span> <span class="n">rx_ia</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">rpcrdma_create_id</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* TEMP TEMP TEMP - fail if new device:</span>
<span class="cm">		 * Deregister/remarshal *all* requests!</span>
<span class="cm">		 * Close and recreate adapter, pd, etc!</span>
<span class="cm">		 * Re-determine all attributes still sane!</span>
<span class="cm">		 * More stuff I haven&#39;t thought of!</span>
<span class="cm">		 * Rrrgh!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: can&#39;t reconnect on &quot;</span>
				<span class="s">&quot;different device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* END TEMP */</span>
		<span class="n">rdma_destroy_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
		<span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdma_create_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_create_qp failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* XXX Tavor device performs badly with 2K MTU! */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcid</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcid</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_MELLANOX_TAVOR</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pcid</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_MELLANOX</span> <span class="o">||</span>
	     <span class="n">pcid</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_TOPSPIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ib_qp_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">path_mtu</span> <span class="o">=</span> <span class="n">IB_MTU_1024</span>
		<span class="p">};</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_modify_qp</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">IB_QP_PATH_MTU</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdma_connect</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_connect() failed with %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check state. A non-peer reject indicates no listener</span>
<span class="cm">	 * (ECONNREFUSED), which may be a transient state. All</span>
<span class="cm">	 * others indicate a transport condition which has already</span>
<span class="cm">	 * undergone a best-effort.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNREFUSED</span> <span class="o">&amp;&amp;</span>
	    <span class="o">++</span><span class="n">retry_count</span> <span class="o">&lt;=</span> <span class="n">RDMA_CONNECT_RETRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: non-peer_reject, retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sometimes, the only way to reliably connect to remote</span>
<span class="cm">		 * CMs is to use same nonzero values for ORD and IRD. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="n">RDMA_CONNECT_RETRY_MAX</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">initiator_depth</span> <span class="o">!=</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">initiator_depth</span> <span class="o">=</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_remote_cma</span><span class="p">.</span><span class="n">responder_resources</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rpcrdma_ep_disconnect</span>
<span class="cm"> *</span>
<span class="cm"> * This is separate from destroy to facilitate the ability</span>
<span class="cm"> * to reconnect without recreating the endpoint.</span>
<span class="cm"> *</span>
<span class="cm"> * This call is not reentrant, and must not be made in parallel</span>
<span class="cm"> * on the same endpoint.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rpcrdma_clean_cq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_cq</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rdma_disconnect</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* returns without wait if not connected */</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connect_wait</span><span class="p">,</span>
							<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: after wait, %sconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;still &quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: rdma_disconnect %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_connected</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize buffer memory</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_buffer_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_create_data_internal</span> <span class="o">*</span><span class="n">cdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">max_requests</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_credits</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Need to allocate:</span>
<span class="cm">	 *   1.  arrays for send and recv pointers</span>
<span class="cm">	 *   2.  arrays of struct rpcrdma_req to fill in pointers</span>
<span class="cm">	 *   3.  array of struct rpcrdma_rep for replies</span>
<span class="cm">	 *   4.  padding, if any</span>
<span class="cm">	 *   5.  mw&#39;s, fmr&#39;s or frmr&#39;s, if any</span>
<span class="cm">	 * Send/recv buffers in req/rep need to be registered</span>
<span class="cm">	 */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">*</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="cm">/* TBD we are perhaps overallocating here */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate 1, 4 and 5 in one shot */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: req_t/rep_t/pad kzalloc(%zd) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_pool</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>	<span class="cm">/* for freeing it later */</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">**</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">];</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">**</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the zeroed pad buffer, if any.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad_mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rep_pad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the fmr&#39;s, or mw&#39;s for mw_bind chunk registration.</span>
<span class="cm">	 * We &quot;cycle&quot; the mw&#39;s in order to minimize rkey reuse,</span>
<span class="cm">	 * and also reduce unbind-to-bind collision.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span> <span class="o">=</span> <span class="n">ib_alloc_fast_reg_mr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span>
							 <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_alloc_fast_reg_mr&quot;</span>
					<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span> <span class="o">=</span>
				<span class="n">ib_alloc_fast_reg_page_list</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							    <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: &quot;</span>
					<span class="s">&quot;ib_alloc_fast_reg_page_list &quot;</span>
					<span class="s">&quot;failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
			<span class="o">++</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="cm">/* TBD we are perhaps overallocating here */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">struct</span> <span class="n">ib_fmr_attr</span> <span class="n">fa</span> <span class="o">=</span>
				<span class="p">{</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span> <span class="p">};</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span> <span class="o">=</span> <span class="n">ib_alloc_fmr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span>
				<span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">|</span> <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fa</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_alloc_fmr&quot;</span>
					<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
			<span class="o">++</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="cm">/* Allocate one extra request&#39;s worth, for full cycling */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span> <span class="o">=</span> <span class="n">ib_alloc_mw</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_alloc_mw&quot;</span>
					<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
			<span class="o">++</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate/init the request/reply buffers. Doing this</span>
<span class="cm">	 * using kmalloc for now -- one for each buf.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">inline_wsize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">);</span>
		<span class="cm">/* RPC layer requests *double* size + 1K RPC_SLACK_SPACE! */</span>
		<span class="cm">/* Typical ~2400b, so rounding up saves work later */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: request buffer %d alloc&quot;</span>
				<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_base</span><span class="p">,</span>
				<span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">,</span> <span class="n">rl_base</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_handle</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_size</span> <span class="o">=</span> <span class="n">len</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">inline_rsize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span><span class="p">);</span>
		<span class="n">rep</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: reply buffer %d alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rr_buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_unbind</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_base</span><span class="p">,</span>
				<span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span><span class="p">,</span> <span class="n">rr_base</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rr_handle</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: max_requests %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">);</span>
	<span class="cm">/* done */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">rpcrdma_buffer_destroy</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unregister and destroy buffer memory. Need to deal with</span>
<span class="cm"> * partial initialization, so it&#39;s callable from failed create.</span>
<span class="cm"> * Must be called before destroying endpoint, as registrations</span>
<span class="cm"> * reference it.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rpcrdma_buffer_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="n">rdmab_to_ia</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="cm">/* clean up in reverse order from create</span>
<span class="cm">	 *   1.  recv mr memory (mr free, then kfree)</span>
<span class="cm">	 *   1a. bind mw memory</span>
<span class="cm">	 *   2.  send mr memory (mr free, then kfree)</span>
<span class="cm">	 *   3.  padding (if any) [moved to rpcrdma_ep_destroy]</span>
<span class="cm">	 *   4.  arrays</span>
<span class="cm">	 */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rpcrdma_deregister_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span>
					<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rr_handle</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rpcrdma_mw</span><span class="p">,</span> <span class="n">mw_list</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
					<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s:&quot;</span>
							<span class="s">&quot; ib_dereg_mr&quot;</span>
							<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
					<span class="n">ib_free_fast_reg_page_list</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
					<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dealloc_fmr</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s:&quot;</span>
							<span class="s">&quot; ib_dealloc_fmr&quot;</span>
							<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
				<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
					<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dealloc_mw</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s:&quot;</span>
							<span class="s">&quot; ib_dealloc_mw&quot;</span>
							<span class="s">&quot; failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rpcrdma_deregister_internal</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span>
					<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_handle</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a set of request/reply buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * Reply buffer (if needed) is attached to send buffer upon return.</span>
<span class="cm"> * Rule:</span>
<span class="cm"> *    rb_send_index and rb_recv_index MUST always be pointing to the</span>
<span class="cm"> *    *next* available buffer (non-NULL). They are incremented after</span>
<span class="cm"> *    removing buffers, and decremented *before* returning them.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span>
<span class="nf">rpcrdma_buffer_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buffers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span> <span class="o">==</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: out of request buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span> <span class="o">&lt;</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: %d extra receives outstanding (ok)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span> <span class="o">-</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="p">];</span>
		<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_SEGS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rpcrdma_mw</span><span class="p">,</span> <span class="n">mw_list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put request/reply buffers back into pool.</span>
<span class="cm"> * Pre-decrement counter/array index.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rpcrdma_buffer_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="n">rdmab_to_ia</span><span class="p">(</span><span class="n">buffers</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_nchunks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_bufs</span><span class="p">[</span><span class="o">--</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_send_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_niovs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="o">--</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="o">-&gt;</span><span class="n">rr_unbind</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Cycle mw&#39;s back in reverse order, and &quot;spin&quot; them.</span>
<span class="cm">		 * This delays and scrambles reuse as much as possible.</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rpcrdma_mw</span> <span class="o">**</span><span class="n">mw</span><span class="p">;</span>
			<span class="n">mw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">mw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
			<span class="o">*</span><span class="n">mw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">RPCRDMA_MAX_SEGS</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">mw_list</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_mws</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Recover reply buffers from pool.</span>
<span class="cm"> * This happens when recovering from error conditions.</span>
<span class="cm"> * Post-increment counter/array index.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rpcrdma_recv_buffer_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_iov</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* special case xprt_rdma_allocate() */</span>
		<span class="n">buffers</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffers</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rl_buffer</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span> <span class="o">&lt;</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_max_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="p">];</span>
		<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put reply buffers back into pool when not attached to</span>
<span class="cm"> * request. This happens in error conditions, and when</span>
<span class="cm"> * aborting unbinds. Pre-decrement counter/array index.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rpcrdma_recv_buffer_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_buffer</span> <span class="o">*</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_bufs</span><span class="p">[</span><span class="o">--</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_recv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffers</span><span class="o">-&gt;</span><span class="n">rb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrappers for internal-use kmalloc memory registration, used by buffer code.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">rpcrdma_register_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">**</span><span class="n">mrp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">iov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="n">ipb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * All memory passed here was kmalloc&#39;ed, therefore phys-contiguous.</span>
<span class="cm">	 */</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="n">va</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_have_dma_lkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iov</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_dma_lkey</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iov</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipb</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">ipb</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">mr</span> <span class="o">=</span> <span class="n">ib_reg_phys_mr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: phys convert: 0x%llx &quot;</span>
			<span class="s">&quot;registered 0x%llx length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ipb</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mr</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed with %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mrp</span> <span class="o">=</span> <span class="n">mr</span><span class="p">;</span>
		<span class="n">iov</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">rpcrdma_deregister_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ib_sge</span> <span class="o">*</span><span class="n">iov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="n">iov</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">mr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_dereg_mr failed %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrappers for chunk registration, shared by read/write chunk code.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_map_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dir</span> <span class="o">=</span> <span class="n">writing</span> <span class="o">?</span> <span class="n">DMA_FROM_DEVICE</span> <span class="o">:</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_page</span><span class="p">)</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span> <span class="o">=</span> <span class="n">ib_dma_map_page</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_page</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">),</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">,</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: mr_dma %llx mr_offset %p mr_dma_len %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span>
			<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rpcrdma_unmap_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_page</span><span class="p">)</span>
		<span class="n">ib_dma_unmap_page</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dmalen</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_register_frmr_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">invalidate_wr</span><span class="p">,</span> <span class="n">frmr_wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">,</span> <span class="o">*</span><span class="n">post_wr</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">pageoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_no</span><span class="p">;</span>

	<span class="n">pageoff</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">);</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_offset</span> <span class="o">-=</span> <span class="n">pageoff</span><span class="p">;</span>	<span class="cm">/* start of page */</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_len</span> <span class="o">+=</span> <span class="n">pageoff</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">pageoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nsegs</span> <span class="o">&gt;</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page_no</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">rpcrdma_map_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">writing</span><span class="p">);</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">seg_len</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span> <span class="n">seg_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">seg_len</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span><span class="o">-&gt;</span>
				<span class="n">page_list</span><span class="p">[</span><span class="n">page_no</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
			<span class="n">pa</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
		<span class="o">++</span><span class="n">seg</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Check for holes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span> <span class="o">&amp;&amp;</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">offset_in_page</span><span class="p">((</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: Using frmr %p to map %d segments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">FRMR_IS_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: frmr %x left valid, posting invalidate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">);</span>
		<span class="cm">/* Invalidate before using. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">invalidate_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">invalidate_wr</span><span class="p">);</span>
		<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="p">;</span>
		<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frmr_wr</span><span class="p">;</span>
		<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_LOCAL_INV</span><span class="p">;</span>
		<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
		<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span>
			<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>
		<span class="n">post_wr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">invalidate_wr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">post_wr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frmr_wr</span><span class="p">;</span>

	<span class="cm">/* Bump the key */</span>
	<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">ib_update_fast_reg_key</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="p">,</span> <span class="o">++</span><span class="n">key</span><span class="p">);</span>

	<span class="cm">/* Prepare FRMR WR */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frmr_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">frmr_wr</span><span class="p">);</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_FAST_REG_MR</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">iova_start</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_pgl</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_list_len</span> <span class="o">=</span> <span class="n">page_no</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">page_shift</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">page_no</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">access_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">writing</span> <span class="o">?</span>
				<span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">|</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span> <span class="o">:</span>
				<span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">);</span>
	<span class="n">frmr_wr</span><span class="p">.</span><span class="n">wr</span><span class="p">.</span><span class="n">fast_reg</span><span class="p">.</span><span class="n">rkey</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
	<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">post_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_post_send for register,&quot;</span>
			<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="o">--</span><span class="n">seg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_rkey</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_base</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span> <span class="o">+</span> <span class="n">pageoff</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_deregister_frmr_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">invalidate_wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span><span class="o">--</span><span class="p">)</span>
		<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="o">++</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">invalidate_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">invalidate_wr</span><span class="p">);</span>
	<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="p">;</span>
	<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_LOCAL_INV</span><span class="p">;</span>
	<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
	<span class="n">invalidate_wr</span><span class="p">.</span><span class="n">ex</span><span class="p">.</span><span class="n">invalidate_rkey</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">frmr</span><span class="p">.</span><span class="n">fr_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
	<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">invalidate_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_post_send for invalidate,&quot;</span>
			<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_register_fmr_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">physaddrs</span><span class="p">[</span><span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">pageoff</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pageoff</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">);</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_offset</span> <span class="o">-=</span> <span class="n">pageoff</span><span class="p">;</span>	<span class="cm">/* start of page */</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_len</span> <span class="o">+=</span> <span class="n">pageoff</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">pageoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nsegs</span> <span class="o">&gt;</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">rpcrdma_map_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">writing</span><span class="p">);</span>
		<span class="n">physaddrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
		<span class="o">++</span><span class="n">seg</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Check for holes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span> <span class="o">&amp;&amp;</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">offset_in_page</span><span class="p">((</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_map_phys_fmr</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="p">,</span>
				<span class="n">physaddrs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_map_phys_fmr &quot;</span>
			<span class="s">&quot;%u@0x%llx+%i (%d)... status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span>
			<span class="n">pageoff</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="o">--</span><span class="n">seg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_rkey</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_base</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span> <span class="o">+</span> <span class="n">pageoff</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_deregister_fmr_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">fmr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_unmap_fmr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span><span class="o">--</span><span class="p">)</span>
		<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_unmap_fmr,&quot;</span>
			<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_register_memwin_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mem_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">writing</span> <span class="o">?</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">:</span>
				  <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rpcrdma_map_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">writing</span><span class="p">);</span>
	<span class="n">param</span><span class="p">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>	<span class="cm">/* no send cookie */</span>
	<span class="n">param</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">mw_access_flags</span> <span class="o">=</span> <span class="n">mem_priv</span><span class="p">;</span>

	<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_bind_mw</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_bind_mw &quot;</span>
			<span class="s">&quot;%u@0x%llx status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_rkey</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_base</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_deregister_memwin_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mw_bind</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">param</span><span class="p">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>	<span class="cm">/* unbind */</span>
	<span class="n">param</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">mw_access_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
		<span class="n">param</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
		<span class="n">INIT_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
		<span class="n">param</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_bind_mw</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mw</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">mw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_(un)bind_mw,&quot;</span>
			<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* will upcall on completion */</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_register_default_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mem_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">writing</span> <span class="o">?</span> <span class="n">IB_ACCESS_REMOTE_WRITE</span> <span class="o">:</span>
				  <span class="n">IB_ACCESS_REMOTE_READ</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_phys_buf</span> <span class="n">ipb</span><span class="p">[</span><span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nsegs</span> <span class="o">&gt;</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">RPCRDMA_MAX_DATA_SEGS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">rpcrdma_map_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">writing</span><span class="p">);</span>
		<span class="n">ipb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
		<span class="n">ipb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">;</span>
		<span class="o">++</span><span class="n">seg</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Check for holes */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nsegs</span> <span class="o">&amp;&amp;</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">offset_in_page</span><span class="p">((</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_offset</span><span class="o">+</span><span class="p">(</span><span class="n">seg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mr_len</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_base</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span> <span class="o">=</span> <span class="n">ib_reg_phys_mr</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_pd</span><span class="p">,</span>
				<span class="n">ipb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_reg_phys_mr &quot;</span>
			<span class="s">&quot;%u@0x%llx (%d)... status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="o">--</span><span class="n">seg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_rkey</span> <span class="o">=</span> <span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">nsegs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rpcrdma_deregister_default_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span><span class="p">);</span>
	<span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_chunk</span><span class="p">.</span><span class="n">rl_mr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">seg1</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span><span class="o">--</span><span class="p">)</span>
		<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: failed ib_dereg_mr,&quot;</span>
			<span class="s">&quot; status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">rpcrdma_register_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nsegs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if RPCRDMA_PERSISTENT_REGISTRATION</span>
	<span class="k">case</span> <span class="n">RPCRDMA_ALLPHYSICAL</span>:
		<span class="n">rpcrdma_map_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">writing</span><span class="p">);</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_rkey</span> <span class="o">=</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_bind_mem</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">;</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_base</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_dma</span><span class="p">;</span>
		<span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nsegs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Registration using frmr registration */</span>
	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_frmr_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">writing</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">r_xprt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Registration using fmr memory registration */</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_fmr_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">writing</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Registration using memory windows */</span>
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_memwin_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">writing</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">r_xprt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Default registration each time */</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_register_default_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsegs</span><span class="p">,</span> <span class="n">writing</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nsegs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">rpcrdma_deregister_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_mr_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpcrdma_xprt</span> <span class="o">*</span><span class="n">r_xprt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r_xprt</span><span class="o">-&gt;</span><span class="n">rx_ia</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsegs</span> <span class="o">=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">mr_nsegs</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_memreg_strategy</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if RPCRDMA_PERSISTENT_REGISTRATION</span>
	<span class="k">case</span> <span class="n">RPCRDMA_ALLPHYSICAL</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nsegs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rpcrdma_unmap_one</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">RPCRDMA_FRMR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_deregister_frmr_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">r_xprt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPCRDMA_MTHCAFMR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_deregister_fmr_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS_ASYNC</span>:
	<span class="k">case</span> <span class="n">RPCRDMA_MEMWINDOWS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_deregister_memwin_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">r_xprt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_deregister_default_external</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">ia</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span><span class="p">;</span>
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">func</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>	<span class="cm">/* dereg done, callback now */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nsegs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepost any receive buffer, then post send.</span>
<span class="cm"> *</span>
<span class="cm"> * Receive buffer is donated to hardware, reclaimed upon recv completion.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpcrdma_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">send_wr</span><span class="p">,</span> <span class="o">*</span><span class="n">send_wr_fail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpcrdma_ep_post_recv</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">rep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">send_wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">send_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>	<span class="cm">/* no send cookie */</span>
	<span class="n">send_wr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">;</span>
	<span class="n">send_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_niovs</span><span class="p">;</span>
	<span class="n">send_wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_SEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* no need to sync any pad (constant) */</span>
		<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
		<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">ib_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rl_send_iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
		<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">send_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* Provider must take a send completion every now and then */</span>
		<span class="n">INIT_CQCOUNT</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">send_wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_wr_fail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_post_send returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * (Re)post a receive buffer.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">rpcrdma_ep_post_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcrdma_ia</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">rpcrdma_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">rpcrdma_rep</span> <span class="o">*</span><span class="n">rep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="n">recv_wr</span><span class="p">,</span> <span class="o">*</span><span class="n">recv_wr_fail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">recv_wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">recv_wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rep</span><span class="p">;</span>
	<span class="n">recv_wr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">;</span>
	<span class="n">recv_wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ib_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">rr_iov</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">DECR_CQCOUNT</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ib_post_recv</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">ri_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_wr_fail</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %s: ib_post_recv returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
