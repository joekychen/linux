<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › rpcb_clnt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rpcb_clnt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * In-kernel rpcbind client supporting versions 2, 3, and 4 of the rpcbind</span>
<span class="cm"> * protocol</span>
<span class="cm"> *</span>
<span class="cm"> * Based on RFC 1833: &quot;Binding Protocols for ONC RPC Version 2&quot; and</span>
<span class="cm"> * RFC 3530: &quot;Network File System (NFS) version 4 Protocol&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * Original: Gilles Quillard, Bull Open Source, 2005 &lt;gilles.quillard@bull.net&gt;</span>
<span class="cm"> * Updated: Chuck Lever, Oracle Corporation, 2007 &lt;chuck.lever@oracle.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Descended from net/sunrpc/pmap_clnt.c,</span>
<span class="cm"> *  Copyright (C) 1996, Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/un.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>

<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/sched.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprtsock.h&gt;</span>

<span class="cp">#include &quot;netns.h&quot;</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="cp"># define RPCDBG_FACILITY	RPCDBG_BIND</span>
<span class="cp">#endif</span>

<span class="cp">#define RPCBIND_SOCK_PATHNAME	&quot;/var/run/rpcbind.sock&quot;</span>

<span class="cp">#define RPCBIND_PROGRAM		(100000u)</span>
<span class="cp">#define RPCBIND_PORT		(111u)</span>

<span class="cp">#define RPCBVERS_2		(2u)</span>
<span class="cp">#define RPCBVERS_3		(3u)</span>
<span class="cp">#define RPCBVERS_4		(4u)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">RPCBPROC_NULL</span><span class="p">,</span>
	<span class="n">RPCBPROC_SET</span><span class="p">,</span>
	<span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
	<span class="n">RPCBPROC_GETPORT</span><span class="p">,</span>
	<span class="n">RPCBPROC_GETADDR</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>		<span class="cm">/* alias for GETPORT */</span>
	<span class="n">RPCBPROC_DUMP</span><span class="p">,</span>
	<span class="n">RPCBPROC_CALLIT</span><span class="p">,</span>
	<span class="n">RPCBPROC_BCAST</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>		<span class="cm">/* alias for CALLIT */</span>
	<span class="n">RPCBPROC_GETTIME</span><span class="p">,</span>
	<span class="n">RPCBPROC_UADDR2TADDR</span><span class="p">,</span>
	<span class="n">RPCBPROC_TADDR2UADDR</span><span class="p">,</span>
	<span class="n">RPCBPROC_GETVERSADDR</span><span class="p">,</span>
	<span class="n">RPCBPROC_INDIRECT</span><span class="p">,</span>
	<span class="n">RPCBPROC_GETADDRLIST</span><span class="p">,</span>
	<span class="n">RPCBPROC_GETSTAT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * r_owner</span>
<span class="cm"> *</span>
<span class="cm"> * The &quot;owner&quot; is allowed to unset a service in the rpcbind database.</span>
<span class="cm"> *</span>
<span class="cm"> * For AF_LOCAL SET/UNSET requests, rpcbind treats this string as a</span>
<span class="cm"> * UID which it maps to a local user name via a password lookup.</span>
<span class="cm"> * In all other cases it is ignored.</span>
<span class="cm"> *</span>
<span class="cm"> * For SET/UNSET requests, user space provides a value, even for</span>
<span class="cm"> * network requests, and GETADDR uses an empty string.  We follow</span>
<span class="cm"> * those precedents here.</span>
<span class="cm"> */</span>
<span class="cp">#define RPCB_OWNER_STRING	&quot;0&quot;</span>
<span class="cp">#define RPCB_MAXOWNERLEN	sizeof(RPCB_OWNER_STRING)</span>

<span class="cm">/*</span>
<span class="cm"> * XDR data type sizes</span>
<span class="cm"> */</span>
<span class="cp">#define RPCB_program_sz		(1)</span>
<span class="cp">#define RPCB_version_sz		(1)</span>
<span class="cp">#define RPCB_protocol_sz	(1)</span>
<span class="cp">#define RPCB_port_sz		(1)</span>
<span class="cp">#define RPCB_boolean_sz		(1)</span>

<span class="cp">#define RPCB_netid_sz		(1 + XDR_QUADLEN(RPCBIND_MAXNETIDLEN))</span>
<span class="cp">#define RPCB_addr_sz		(1 + XDR_QUADLEN(RPCBIND_MAXUADDRLEN))</span>
<span class="cp">#define RPCB_ownerstring_sz	(1 + XDR_QUADLEN(RPCB_MAXOWNERLEN))</span>

<span class="cm">/*</span>
<span class="cm"> * XDR argument and result sizes</span>
<span class="cm"> */</span>
<span class="cp">#define RPCB_mappingargs_sz	(RPCB_program_sz + RPCB_version_sz + \</span>
<span class="cp">				RPCB_protocol_sz + RPCB_port_sz)</span>
<span class="cp">#define RPCB_getaddrargs_sz	(RPCB_program_sz + RPCB_version_sz + \</span>
<span class="cp">				RPCB_netid_sz + RPCB_addr_sz + \</span>
<span class="cp">				RPCB_ownerstring_sz)</span>

<span class="cp">#define RPCB_getportres_sz	RPCB_port_sz</span>
<span class="cp">#define RPCB_setres_sz		RPCB_boolean_sz</span>

<span class="cm">/*</span>
<span class="cm"> * Note that RFC 1833 does not put any size restrictions on the</span>
<span class="cm"> * address string returned by the remote rpcbind database.</span>
<span class="cm"> */</span>
<span class="cp">#define RPCB_getaddrres_sz	RPCB_addr_sz</span>

<span class="k">static</span> <span class="kt">void</span>			<span class="n">rpcb_getport_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>			<span class="n">rpcb_map_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_program</span>	<span class="n">rpcb_program</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>	<span class="n">r_xprt</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">r_prog</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">r_vers</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">r_prot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">r_port</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>		<span class="n">r_netid</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>		<span class="n">r_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>		<span class="n">r_owner</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">r_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures2</span><span class="p">[];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures3</span><span class="p">[];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures4</span><span class="p">[];</span>

<span class="k">struct</span> <span class="n">rpcb_info</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">rpc_vers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="o">*</span>	<span class="n">rpc_proc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcb_info</span> <span class="n">rpcb_next_version</span><span class="p">[];</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcb_info</span> <span class="n">rpcb_next_version6</span><span class="p">[];</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">rpcb_getport_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span>		<span class="o">=</span> <span class="n">rpcb_getport_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span>		<span class="o">=</span> <span class="n">rpcb_map_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_wake_rpcbind_waiters</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xprt_clear_binding</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">rpc_wake_up_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">binding</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_map_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rpcb_wake_rpcbind_waiters</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_xprt</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_status</span><span class="p">);</span>
	<span class="n">xprt_put</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_xprt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_get_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunrpc_net_id</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_clnt_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span><span class="p">)</span>
		<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_clnt_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rpcb_put_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunrpc_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt4</span> <span class="o">=</span> <span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shutdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_clnt_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">shutdown</span> <span class="o">=</span> <span class="o">!</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_clnt_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * cleanup_rpcb_clnt - remove xprtsock&#39;s sysctls, unregister</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clnt4</span><span class="p">)</span>
			<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">clnt4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="p">)</span>
			<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_set_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunrpc_net_id</span><span class="p">);</span>

	<span class="cm">/* Protected by rpcb_create_local_mutex */</span>
	<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">;</span>
	<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span> <span class="o">=</span> <span class="n">clnt4</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span> 
	<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       created new rpcb local clients (rpcb_local_clnt: &quot;</span>
			<span class="s">&quot;%p, rpcb_local_clnt4: %p) for net %p%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt</span><span class="p">,</span> <span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span><span class="p">,</span>
			<span class="n">net</span><span class="p">,</span> <span class="p">(</span><span class="n">net</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (init_net)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns zero on success, otherwise a negative errno value</span>
<span class="cm"> * is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_create_local_unix</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">rpcb_localaddr_rpcbind</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sun_family</span>		<span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sun_path</span>		<span class="o">=</span> <span class="n">RPCBIND_SOCK_PATHNAME</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_create_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">net</span><span class="p">,</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">XPRT_TRANSPORT_LOCAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rpcb_localaddr_rpcbind</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrsize</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpcb_localaddr_rpcbind</span><span class="p">),</span>
		<span class="p">.</span><span class="n">servername</span>	<span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">program</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">RPCBVERS_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">authflavor</span>	<span class="o">=</span> <span class="n">RPC_AUTH_NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="o">*</span><span class="n">clnt4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because we requested an RPC PING at transport creation time,</span>
<span class="cm">	 * this works only if the user space portmapper is rpcbind, and</span>
<span class="cm">	 * it&#39;s listening on AF_LOCAL on the named socket.</span>
<span class="cm">	 */</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">rpc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       failed to create AF_LOCAL rpcbind &quot;</span>
				<span class="s">&quot;client (errno %ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clnt4</span> <span class="o">=</span> <span class="n">rpc_bind_new_program</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpcb_program</span><span class="p">,</span> <span class="n">RPCBVERS_4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       failed to bind second program to &quot;</span>
				<span class="s">&quot;rpcbind v4 client (errno %ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt4</span><span class="p">));</span>
		<span class="n">clnt4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpcb_set_local</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">clnt</span><span class="p">,</span> <span class="n">clnt4</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns zero on success, otherwise a negative errno value</span>
<span class="cm"> * is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_create_local_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">rpcb_inaddr_loopback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sin_family</span>		<span class="o">=</span> <span class="n">AF_INET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span>	<span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_LOOPBACK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">sin_port</span>		<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RPCBIND_PORT</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_create_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">net</span><span class="p">,</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rpcb_inaddr_loopback</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrsize</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpcb_inaddr_loopback</span><span class="p">),</span>
		<span class="p">.</span><span class="n">servername</span>	<span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">program</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">RPCBVERS_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">authflavor</span>	<span class="o">=</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">RPC_CLNT_CREATE_NOPING</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="o">*</span><span class="n">clnt4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clnt</span> <span class="o">=</span> <span class="n">rpc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       failed to create local rpcbind &quot;</span>
				<span class="s">&quot;client (errno %ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This results in an RPC ping.  On systems running portmapper,</span>
<span class="cm">	 * the v4 ping will fail.  Proceed anyway, but disallow rpcb</span>
<span class="cm">	 * v4 upcalls.</span>
<span class="cm">	 */</span>
	<span class="n">clnt4</span> <span class="o">=</span> <span class="n">rpc_bind_new_program</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpcb_program</span><span class="p">,</span> <span class="n">RPCBVERS_4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       failed to bind second program to &quot;</span>
				<span class="s">&quot;rpcbind v4 client (errno %ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt4</span><span class="p">));</span>
		<span class="n">clnt4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpcb_set_local</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">clnt</span><span class="p">,</span> <span class="n">clnt4</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns zero on success, otherwise a negative errno value</span>
<span class="cm"> * is returned.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rpcb_create_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">rpcb_create_local_mutex</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcb_get_local</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcb_create_local_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpcb_get_local</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcb_create_local_unix</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">rpcb_create_local_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpcb_create_local_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="nf">rpcb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">srvaddr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">salen</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span> <span class="n">u32</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_create_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">net</span><span class="p">,</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">proto</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="n">srvaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addrsize</span>	<span class="o">=</span> <span class="n">salen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">servername</span>	<span class="o">=</span> <span class="n">hostname</span><span class="p">,</span>
		<span class="p">.</span><span class="n">program</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">version</span><span class="p">,</span>
		<span class="p">.</span><span class="n">authflavor</span>	<span class="o">=</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">RPC_CLNT_CREATE_NOPING</span> <span class="o">|</span>
					<span class="n">RPC_CLNT_CREATE_NONPRIVPORT</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srvaddr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">srvaddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RPCBIND_PORT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">srvaddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RPCBIND_PORT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rpc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_register_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_SOFTCONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       failed to contact local rpcbind &quot;</span>
				<span class="s">&quot;server (errno %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpcb_register - set or unset a port registration with the local rpcbind svc</span>
<span class="cm"> * @net: target network namespace</span>
<span class="cm"> * @prog: RPC program number to bind</span>
<span class="cm"> * @vers: RPC version number to bind</span>
<span class="cm"> * @prot: transport protocol to register</span>
<span class="cm"> * @port: port value to register</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if the registration request was dispatched successfully</span>
<span class="cm"> * and the rpcbind daemon returned success.  Otherwise, returns an errno</span>
<span class="cm"> * value that reflects the nature of the error (request could not be</span>
<span class="cm"> * dispatched, timed out, or rpcbind returned an error).</span>
<span class="cm"> *</span>
<span class="cm"> * RPC services invoke this function to advertise their contact</span>
<span class="cm"> * information via the system&#39;s rpcbind daemon.  RPC services</span>
<span class="cm"> * invoke this function once for each [program, version, transport]</span>
<span class="cm"> * tuple they wish to advertise.</span>
<span class="cm"> *</span>
<span class="cm"> * Callers may also unregister RPC services that are no longer</span>
<span class="cm"> * available by setting the passed-in port to zero.  This removes</span>
<span class="cm"> * all registered transports for [program, version] from the local</span>
<span class="cm"> * rpcbind database.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses rpcbind protocol version 2 to contact the</span>
<span class="cm"> * local rpcbind daemon.</span>
<span class="cm"> *</span>
<span class="cm"> * Registration works over both AF_INET and AF_INET6, and services</span>
<span class="cm"> * registered via this function are advertised as available for any</span>
<span class="cm"> * address.  If the local rpcbind daemon is listening on AF_INET6,</span>
<span class="cm"> * services registered via this function will be advertised on</span>
<span class="cm"> * IN6ADDR_ANY (ie available for all AF_INET and AF_INET6</span>
<span class="cm"> * addresses).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rpcb_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">prog</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vers</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">r_prog</span>		<span class="o">=</span> <span class="n">prog</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_vers</span>		<span class="o">=</span> <span class="n">vers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_prot</span>		<span class="o">=</span> <span class="n">prot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_port</span>		<span class="o">=</span> <span class="n">port</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunrpc_net_id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %sregistering (%u, %u, %d, %u) with local &quot;</span>
			<span class="s">&quot;rpcbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">),</span>
			<span class="n">prog</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures2</span><span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures2</span><span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">rpcb_register_call</span><span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in AF_INET family-specific arguments to register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_register_inet4</span><span class="p">(</span><span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_argp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span> <span class="o">=</span> <span class="n">rpc_sockaddr2uaddr</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %sregistering [%u, %u, %s, &#39;%s&#39;] with &quot;</span>
		<span class="s">&quot;local rpcbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">),</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">,</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_netid</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">rpcb_register_call</span><span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in AF_INET6 family-specific arguments to register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_register_inet6</span><span class="p">(</span><span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_argp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span> <span class="o">=</span> <span class="n">rpc_sockaddr2uaddr</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       %sregistering [%u, %u, %s, &#39;%s&#39;] with &quot;</span>
		<span class="s">&quot;local rpcbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">),</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">,</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_netid</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">rpcb_register_call</span><span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_unregister_all_protofamilies</span><span class="p">(</span><span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_argp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       unregistering [%u, %u, &#39;%s&#39;] with &quot;</span>
		<span class="s">&quot;local rpcbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_netid</span><span class="p">);</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">rpcb_register_call</span><span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpcb_v4_register - set or unset a port registration with the local rpcbind</span>
<span class="cm"> * @net: target network namespace</span>
<span class="cm"> * @program: RPC program number of service to (un)register</span>
<span class="cm"> * @version: RPC version number of service to (un)register</span>
<span class="cm"> * @address: address family, IP address, and port to (un)register</span>
<span class="cm"> * @netid: netid of transport protocol to (un)register</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if the registration request was dispatched successfully</span>
<span class="cm"> * and the rpcbind daemon returned success.  Otherwise, returns an errno</span>
<span class="cm"> * value that reflects the nature of the error (request could not be</span>
<span class="cm"> * dispatched, timed out, or rpcbind returned an error).</span>
<span class="cm"> *</span>
<span class="cm"> * RPC services invoke this function to advertise their contact</span>
<span class="cm"> * information via the system&#39;s rpcbind daemon.  RPC services</span>
<span class="cm"> * invoke this function once for each [program, version, address,</span>
<span class="cm"> * netid] tuple they wish to advertise.</span>
<span class="cm"> *</span>
<span class="cm"> * Callers may also unregister RPC services that are registered at a</span>
<span class="cm"> * specific address by setting the port number in @address to zero.</span>
<span class="cm"> * They may unregister all registered protocol families at once for</span>
<span class="cm"> * a service by passing a NULL @address argument.  If @netid is &quot;&quot;</span>
<span class="cm"> * then all netids for [program, version, address] are unregistered.</span>
<span class="cm"> *</span>
<span class="cm"> * This function uses rpcbind protocol version 4 to contact the</span>
<span class="cm"> * local rpcbind daemon.  The local rpcbind daemon must support</span>
<span class="cm"> * version 4 of the rpcbind protocol in order for these functions</span>
<span class="cm"> * to register a service successfully.</span>
<span class="cm"> *</span>
<span class="cm"> * Supported netids include &quot;udp&quot; and &quot;tcp&quot; for UDP and TCP over</span>
<span class="cm"> * IPv4, and &quot;udp6&quot; and &quot;tcp6&quot; for UDP and TCP over IPv6,</span>
<span class="cm"> * respectively.</span>
<span class="cm"> *</span>
<span class="cm"> * The contents of @address determine the address family and the</span>
<span class="cm"> * port to be registered.  The usual practice is to pass INADDR_ANY</span>
<span class="cm"> * as the raw address, but specifying a non-zero address is also</span>
<span class="cm"> * supported by this API if the caller wishes to advertise an RPC</span>
<span class="cm"> * service on a specific network interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that passing in INADDR_ANY does not create the same service</span>
<span class="cm"> * registration as IN6ADDR_ANY.  The former advertises an RPC</span>
<span class="cm"> * service on any IPv4 address, but not on IPv6.  The latter</span>
<span class="cm"> * advertises the service on all IPv4 and IPv6 addresses.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rpcb_v4_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">program</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">version</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">netid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">r_prog</span>		<span class="o">=</span> <span class="n">program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_vers</span>		<span class="o">=</span> <span class="n">version</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_netid</span>	<span class="o">=</span> <span class="n">netid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r_owner</span>	<span class="o">=</span> <span class="n">RPCB_OWNER_STRING</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">sunrpc_net</span> <span class="o">*</span><span class="n">sn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunrpc_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sn</span><span class="o">-&gt;</span><span class="n">rpcb_local_clnt4</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rpcb_unregister_all_protofamilies</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">return</span> <span class="n">rpcb_register_inet4</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">return</span> <span class="n">rpcb_register_inet6</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="nf">rpcb_call_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">rpcb_clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="o">*</span><span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">map</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="n">map</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">rpcb_clnt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_getport_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">map</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span> <span class="o">|</span> <span class="n">RPC_TASK_SOFTCONN</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In the case where rpc clients have been cloned, we want to make</span>
<span class="cm"> * sure that we use the program number/version etc of the actual</span>
<span class="cm"> * owner of the xprt. To do so, we walk back up the tree of parents</span>
<span class="cm"> * to find whoever created the transport and/or whoever has the</span>
<span class="cm"> * autobind flag set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="nf">rpcb_find_transport_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_xprt</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">clnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">cl_xprt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xprt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_autobind</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">clnt</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">cl_parent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">clnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpcb_getport_async - obtain the port for a given RPC service on a given host</span>
<span class="cm"> * @task: task that is waiting for portmapper request</span>
<span class="cm"> *</span>
<span class="cm"> * This one can be called for an ongoing RPC request, and can be used in</span>
<span class="cm"> * an async (rpciod) context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rpcb_getport_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bind_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span>	<span class="o">*</span><span class="n">rpcb_clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span>	<span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">salen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">clnt</span> <span class="o">=</span> <span class="n">rpcb_find_transport_owner</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="p">);</span>
		<span class="n">xprt</span> <span class="o">=</span> <span class="n">xprt_get</span><span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_xprt</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">xprt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s(%s, %u, %u, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_prog</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_vers</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">);</span>

	<span class="cm">/* Put self on the wait queue to ensure we get notified if</span>
<span class="cm">	 * some other task is already attempting to bind the port */</span>
	<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">binding</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xprt_test_and_set_binding</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: waiting for another binder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">xprt_put</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Someone else may have bound if we slept */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt_bound</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: already bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bailout_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parent transport&#39;s destination address */</span>
	<span class="n">salen</span> <span class="o">=</span> <span class="n">rpc_peeraddr</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">sap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>

	<span class="cm">/* Don&#39;t ever use rpcbind v2 for AF_INET6 requests */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sap</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">proc</span> <span class="o">=</span> <span class="n">rpcb_next_version</span><span class="p">[</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span><span class="p">].</span><span class="n">rpc_proc</span><span class="p">;</span>
		<span class="n">bind_version</span> <span class="o">=</span> <span class="n">rpcb_next_version</span><span class="p">[</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span><span class="p">].</span><span class="n">rpc_vers</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">proc</span> <span class="o">=</span> <span class="n">rpcb_next_version6</span><span class="p">[</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span><span class="p">].</span><span class="n">rpc_proc</span><span class="p">;</span>
		<span class="n">bind_version</span> <span class="o">=</span> <span class="n">rpcb_next_version6</span><span class="p">[</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span><span class="p">].</span><span class="n">rpc_vers</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: bad address family</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bailout_nofree</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPFNOSUPPORT</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: no more getport versions available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bailout_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: trying rpcbind version %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bind_version</span><span class="p">);</span>

	<span class="n">rpcb_clnt</span> <span class="o">=</span> <span class="n">rpcb_create</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xprt_net</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">,</span> <span class="n">sap</span><span class="p">,</span> <span class="n">salen</span><span class="p">,</span>
				<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">,</span> <span class="n">bind_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: rpcb_create failed, error %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">bailout_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpcbind_args</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: no memory available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bailout_release_client</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_prog</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_prog</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_vers</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_vers</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_prot</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_xprt</span> <span class="o">=</span> <span class="n">xprt</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bind_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPCBVERS_4</span>:
	<span class="k">case</span> <span class="n">RPCBVERS_3</span>:
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_netid</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_NETID</span><span class="p">];</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span> <span class="o">=</span> <span class="n">rpc_sockaddr2uaddr</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_owner</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPCBVERS_2</span>:
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">child</span> <span class="o">=</span> <span class="n">rpcb_call_async</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">proc</span><span class="p">);</span>
	<span class="n">rpc_release_client</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* rpcb_map_release() has freed the arguments */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u %s: rpc_run_task failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bind_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bailout_release_client:</span>
	<span class="n">rpc_release_client</span><span class="p">(</span><span class="n">rpcb_clnt</span><span class="p">);</span>
<span class="nl">bailout_nofree:</span>
	<span class="n">rpcb_wake_rpcbind_waiters</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">xprt_put</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rpcb_getport_async</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Rpcbind child task calls this callback via tk_exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_getport_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_xprt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>

	<span class="cm">/* Garbage reply: retry with a lesser rpcbind version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>

	<span class="cm">/* rpcbind server doesn&#39;t support this rpcbind protocol version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rpcbind server not available on remote host? */</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_port</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Requested RPC service wasn&#39;t registered on remote host */</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_port</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Succeeded */</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_port</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_port</span><span class="p">);</span>
		<span class="n">xprt_set_bound</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u rpcb_getport_done(status %d, port %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">r_port</span><span class="p">);</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">r_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XDR functions for rpcbind</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_enc_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">rpcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u encoding PMAP_%s call (%u, %u, %d, %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">,</span>
			<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prot</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_reserve_space</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="n">RPCB_mappingargs_sz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prot</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_dec_getport</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">rpcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_inline_decode</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u PMAP_%s result: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_dec_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">boolp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_inline_decode</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">boolp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="n">xdr_zero</span><span class="p">)</span>
		<span class="o">*</span><span class="n">boolp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u RPCB_%s call %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">,</span>
			<span class="p">(</span><span class="o">*</span><span class="n">boolp</span> <span class="o">?</span> <span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">encode_rpcb_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u32</span> <span class="n">maxstrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">maxstrlen</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_reserve_space</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">xdr_encode_opaque</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rpcb_enc_getaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">rpcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u encoding RPCB_%s call (%u, %u, &#39;%s&#39;, &#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">,</span>
			<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">,</span>
			<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_netid</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_reserve_space</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="p">(</span><span class="n">RPCB_program_sz</span> <span class="o">+</span> <span class="n">RPCB_version_sz</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_prog</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_vers</span><span class="p">);</span>

	<span class="n">encode_rpcb_string</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_netid</span><span class="p">,</span> <span class="n">RPCBIND_MAXNETIDLEN</span><span class="p">);</span>
	<span class="n">encode_rpcb_string</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_addr</span><span class="p">,</span> <span class="n">RPCBIND_MAXUADDRLEN</span><span class="p">);</span>
	<span class="n">encode_rpcb_string</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_owner</span><span class="p">,</span> <span class="n">RPCB_MAXOWNERLEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpcb_dec_getaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rpcbind_args</span> <span class="o">*</span><span class="n">rpcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_inline_decode</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the returned universal address is a null string,</span>
<span class="cm">	 * the requested RPC service was not registered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u RPCB reply: program not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RPCBIND_MAXUADDRLEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_inline_decode</span><span class="p">(</span><span class="n">xdr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u RPCB_%s reply: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpc_uaddr2sockaddr</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="o">-&gt;</span><span class="n">xprt_net</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">sap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="n">rpcb</span><span class="o">-&gt;</span><span class="n">r_port</span> <span class="o">=</span> <span class="n">rpc_get_port</span><span class="p">(</span><span class="n">sap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fail:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u malformed RPCB_%s reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Not all rpcbind procedures described in RFC 1833 are implemented</span>
<span class="cm"> * since the Linux kernel RPC code requires only these.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_mapping</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_mappingargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;SET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_mapping</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_mappingargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;UNSET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_GETPORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_GETPORT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_mapping</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_getport</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_mappingargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_getportres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_GETPORT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;GETPORT&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;SET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;UNSET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_GETADDR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_GETADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_GETADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;GETADDR&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_procinfo</span> <span class="n">rpcb_procedures4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RPCBPROC_SET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_SET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;SET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_UNSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_setres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_UNSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;UNSET&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RPCBPROC_GETADDR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">p_proc</span>		<span class="o">=</span> <span class="n">RPCBPROC_GETADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_encode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdreproc_t</span><span class="p">)</span><span class="n">rpcb_enc_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_decode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kxdrdproc_t</span><span class="p">)</span><span class="n">rpcb_dec_getaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_arglen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrargs_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_replen</span>	<span class="o">=</span> <span class="n">RPCB_getaddrres_sz</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_statidx</span>	<span class="o">=</span> <span class="n">RPCBPROC_GETADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_timer</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p_name</span>		<span class="o">=</span> <span class="s">&quot;GETADDR&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcb_info</span> <span class="n">rpcb_next_version</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_vers</span>	<span class="o">=</span> <span class="n">RPCBVERS_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures2</span><span class="p">[</span><span class="n">RPCBPROC_GETPORT</span><span class="p">],</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpcb_info</span> <span class="n">rpcb_next_version6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_vers</span>	<span class="o">=</span> <span class="n">RPCBVERS_4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures4</span><span class="p">[</span><span class="n">RPCBPROC_GETADDR</span><span class="p">],</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_vers</span>	<span class="o">=</span> <span class="n">RPCBVERS_3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_procedures3</span><span class="p">[</span><span class="n">RPCBPROC_GETADDR</span><span class="p">],</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="n">rpcb_version2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">number</span>		<span class="o">=</span> <span class="n">RPCBVERS_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrprocs</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rpcb_procedures2</span><span class="p">),</span>
	<span class="p">.</span><span class="n">procs</span>		<span class="o">=</span> <span class="n">rpcb_procedures2</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="n">rpcb_version3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">number</span>		<span class="o">=</span> <span class="n">RPCBVERS_3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrprocs</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rpcb_procedures3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">procs</span>		<span class="o">=</span> <span class="n">rpcb_procedures3</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="n">rpcb_version4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">number</span>		<span class="o">=</span> <span class="n">RPCBVERS_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrprocs</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rpcb_procedures4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">procs</span>		<span class="o">=</span> <span class="n">rpcb_procedures4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_version</span> <span class="o">*</span><span class="n">rpcb_version</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rpcb_version2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rpcb_version3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rpcb_version4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_stat</span> <span class="n">rpcb_stats</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_program</span> <span class="n">rpcb_program</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rpcbind&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">number</span>		<span class="o">=</span> <span class="n">RPCBIND_PROGRAM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrvers</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rpcb_version</span><span class="p">),</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">rpcb_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stats</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">rpcb_stats</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
