<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sunrpc › xprt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xprt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/net/sunrpc/xprt.c</span>
<span class="cm"> *</span>
<span class="cm"> *  This is a generic RPC call interface supporting congestion avoidance,</span>
<span class="cm"> *  and asynchronous calls.</span>
<span class="cm"> *</span>
<span class="cm"> *  The interface works like this:</span>
<span class="cm"> *</span>
<span class="cm"> *  -	When a process places a call, it allocates a request slot if</span>
<span class="cm"> *	one is available. Otherwise, it sleeps on the backlog queue</span>
<span class="cm"> *	(xprt_reserve).</span>
<span class="cm"> *  -	Next, the caller puts together the RPC message, stuffs it into</span>
<span class="cm"> *	the request struct, and calls xprt_transmit().</span>
<span class="cm"> *  -	xprt_transmit sends the message and installs the caller on the</span>
<span class="cm"> *	transport&#39;s wait list. At the same time, if a reply is expected,</span>
<span class="cm"> *	it installs a timer that is run after the packet&#39;s timeout has</span>
<span class="cm"> *	expired.</span>
<span class="cm"> *  -	When a packet arrives, the data_ready handler walks the list of</span>
<span class="cm"> *	pending requests for that transport. If a matching XID is found, the</span>
<span class="cm"> *	caller is woken up, and the timer removed.</span>
<span class="cm"> *  -	When no reply arrives within the timeout interval, the timer is</span>
<span class="cm"> *	fired by the kernel and runs xprt_timer(). It either adjusts the</span>
<span class="cm"> *	timeout values (minor timeout) or wakes up the caller with a status</span>
<span class="cm"> *	of -ETIMEDOUT.</span>
<span class="cm"> *  -	When the caller receives a notification from RPC that a reply arrived,</span>
<span class="cm"> *	it should release the RPC slot, and process the reply.</span>
<span class="cm"> *	If the call timed out, it may choose to retry the operation by</span>
<span class="cm"> *	adjusting the initial timeout value, and simply calling rpc_call</span>
<span class="cm"> *	again.</span>
<span class="cm"> *</span>
<span class="cm"> *  Support for async RPC is done through a set of RPC-specific scheduling</span>
<span class="cm"> *  primitives that `transparently&#39; work for processes as well as async</span>
<span class="cm"> *  tasks that rely on callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995-1997, Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Transport switch API copyright (C) 2005, Chuck Lever &lt;cel@netapp.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>

<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/metrics.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/bc_xprt.h&gt;</span>

<span class="cp">#include &quot;sunrpc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables</span>
<span class="cm"> */</span>

<span class="cp">#ifdef RPC_DEBUG</span>
<span class="cp"># define RPCDBG_FACILITY	RPCDBG_XPRT</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Local functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>	 <span class="n">xprt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">xprt_request_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">xprt_connect_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">__xprt_get_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	 <span class="n">xprt_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">xprt_list_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">xprt_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The transport code maintains an estimate on the maximum number of out-</span>
<span class="cm"> * standing RPC requests, using a smoothed version of the congestion</span>
<span class="cm"> * avoidance implemented in 44BSD. This is basically the Van Jacobson</span>
<span class="cm"> * congestion algorithm: If a retransmit occurs, the congestion window is</span>
<span class="cm"> * halved; otherwise, it is incremented by 1/cwnd when</span>
<span class="cm"> *</span>
<span class="cm"> *	-	a reply is received and</span>
<span class="cm"> *	-	a full number of requests are outstanding and</span>
<span class="cm"> *	-	the congestion window hasn&#39;t been updated recently.</span>
<span class="cm"> */</span>
<span class="cp">#define RPC_CWNDSHIFT		(8U)</span>
<span class="cp">#define RPC_CWNDSCALE		(1U &lt;&lt; RPC_CWNDSHIFT)</span>
<span class="cp">#define RPC_INITCWND		RPC_CWNDSCALE</span>
<span class="cp">#define RPC_MAXCWND(xprt)	((xprt)-&gt;max_reqs &lt;&lt; RPC_CWNDSHIFT)</span>

<span class="cp">#define RPCXPRT_CONGESTED(xprt) ((xprt)-&gt;cong &gt;= (xprt)-&gt;cwnd)</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_register_transport - register a transport implementation</span>
<span class="cm"> * @transport: transport to register</span>
<span class="cm"> *</span>
<span class="cm"> * If a transport implementation is loaded as a kernel module, it can</span>
<span class="cm"> * call this interface to make itself known to the RPC client.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * 0:		transport successfully registered</span>
<span class="cm"> * -EEXIST:	transport already registered</span>
<span class="cm"> * -EINVAL:	transport module being unloaded</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_register_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">transport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t register the same transport class twice */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">transport</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt_list</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RPC: Registered %s transport module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_register_transport</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_unregister_transport - unregister a transport implementation</span>
<span class="cm"> * @transport: transport to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * 0:		transport successfully unregistered</span>
<span class="cm"> * -ENOENT:	transport never registered</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_unregister_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">transport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">transport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;RPC: Unregistered %s transport module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_unregister_transport</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_load_transport - load a transport implementation</span>
<span class="cm"> * @transport_name: transport to load</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * 0:		transport successfully loaded</span>
<span class="cm"> * -ENOENT:	transport module not available</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_load_transport</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">transport_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">transport_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="s">&quot;xprt%s&quot;</span><span class="p">,</span> <span class="n">transport_name</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_load_transport</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_reserve_xprt - serialize write access to transports</span>
<span class="cm"> * @task: task that is requesting access to the transport</span>
<span class="cm"> * @xprt: pointer to the target transport</span>
<span class="cm"> *</span>
<span class="cm"> * This prevents mixing the payload of separate requests, and prevents</span>
<span class="cm"> * transport connects from colliding with writes.  No congestion control</span>
<span class="cm"> * is provided.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_reserve_xprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u failed to lock transport %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_LOW</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_NORMAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_HIGH</span><span class="p">;</span>
	<span class="n">rpc_sleep_on_priority</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_reserve_xprt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_clear_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_CLOSE_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rpciod_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * xprt_reserve_xprt_cong - serialize write access to transports</span>
<span class="cm"> * @task: task that is requesting access to the transport</span>
<span class="cm"> *</span>
<span class="cm"> * Same as xprt_reserve_xprt, but Van Jacobson congestion control is</span>
<span class="cm"> * integrated into the decision of whether a request is allowed to be</span>
<span class="cm"> * woken up and given access to the transport.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_reserve_xprt_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__xprt_get_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xprt_clear_locked</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="nl">out_sleep:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u failed to lock transport %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_LOW</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_NORMAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">RPC_PRIORITY_HIGH</span><span class="p">;</span>
	<span class="n">rpc_sleep_on_priority</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_reserve_xprt_cong</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_lock_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reserve_xprt</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__xprt_lock_write_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__xprt_lock_write_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpc_wake_up_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">,</span> <span class="n">__xprt_lock_write_func</span><span class="p">,</span> <span class="n">xprt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">xprt_clear_locked</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__xprt_lock_write_cong_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__xprt_get_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__xprt_lock_write_next_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RPCXPRT_CONGESTED</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpc_wake_up_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">,</span> <span class="n">__xprt_lock_write_cong_func</span><span class="p">,</span> <span class="n">xprt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="n">xprt_clear_locked</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_release_xprt - allow other requests to use a transport</span>
<span class="cm"> * @xprt: transport with other tasks potentially waiting</span>
<span class="cm"> * @task: task that is releasing access to the transport</span>
<span class="cm"> *</span>
<span class="cm"> * Note that &quot;task&quot; can be NULL.  No congestion control is provided.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_release_xprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt_clear_locked</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="n">__xprt_lock_write_next</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_release_xprt</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_release_xprt_cong - allow other requests to use a transport</span>
<span class="cm"> * @xprt: transport with other tasks potentially waiting</span>
<span class="cm"> * @task: task that is releasing access to the transport</span>
<span class="cm"> *</span>
<span class="cm"> * Note that &quot;task&quot; can be NULL.  Another task is awoken to use the</span>
<span class="cm"> * transport if the transport&#39;s congestion window allows it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_release_xprt_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt_clear_locked</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="n">__xprt_lock_write_next_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_release_xprt_cong</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_release_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">release_xprt</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Van Jacobson congestion avoidance. Check if the congestion window</span>
<span class="cm"> * overflowed. Put the task to sleep if this is the case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__xprt_get_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cong</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_cwnd_limited cong = %lu cwnd = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cong</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RPCXPRT_CONGESTED</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cong</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cong</span> <span class="o">+=</span> <span class="n">RPC_CWNDSCALE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adjust the congestion window, and wake up the next task</span>
<span class="cm"> * that has been sleeping due to congestion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__xprt_put_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cong</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cong</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cong</span> <span class="o">-=</span> <span class="n">RPC_CWNDSCALE</span><span class="p">;</span>
	<span class="n">__xprt_lock_write_next_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_release_rqst_cong - housekeeping when request is complete</span>
<span class="cm"> * @task: RPC request that recently completed</span>
<span class="cm"> *</span>
<span class="cm"> * Useful for transports that require congestion control.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_release_rqst_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__xprt_put_cong</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_release_rqst_cong</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_adjust_cwnd - adjust transport congestion window</span>
<span class="cm"> * @task: recently completed RPC request used to adjust window</span>
<span class="cm"> * @result: result code of completed RPC request</span>
<span class="cm"> *</span>
<span class="cm"> * We use a time-smoothed congestion estimator to avoid heavy oscillation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_adjust_cwnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cwnd</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cwnd</span> <span class="o">&lt;=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cong</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The (cwnd &gt;&gt; 1) term makes sure</span>
<span class="cm">		 * the result gets rounded properly. */</span>
		<span class="n">cwnd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RPC_CWNDSCALE</span> <span class="o">*</span> <span class="n">RPC_CWNDSCALE</span> <span class="o">+</span> <span class="p">(</span><span class="n">cwnd</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">cwnd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cwnd</span> <span class="o">&gt;</span> <span class="n">RPC_MAXCWND</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
			<span class="n">cwnd</span> <span class="o">=</span> <span class="n">RPC_MAXCWND</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="n">__xprt_lock_write_next_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cwnd</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cwnd</span> <span class="o">&lt;</span> <span class="n">RPC_CWNDSCALE</span><span class="p">)</span>
			<span class="n">cwnd</span> <span class="o">=</span> <span class="n">RPC_CWNDSCALE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       cong %ld, cwnd was %ld, now %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cong</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">,</span> <span class="n">cwnd</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">cwnd</span><span class="p">;</span>
	<span class="n">__xprt_put_cong</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_adjust_cwnd</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_wake_pending_tasks - wake all tasks on a transport&#39;s pending queue</span>
<span class="cm"> * @xprt: transport with waiting tasks</span>
<span class="cm"> * @status: result code to plant in each task before waking it</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_wake_pending_tasks</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rpc_wake_up_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rpc_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_wake_pending_tasks</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_wait_for_buffer_space - wait for transport output buffer to clear</span>
<span class="cm"> * @task: task to be put to sleep</span>
<span class="cm"> * @action: function pointer to be executed after wait</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_wait_for_buffer_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">rpc_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
	<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_wait_for_buffer_space</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_write_space - wake the task waiting for transport output buffer space</span>
<span class="cm"> * @xprt: transport with waiting tasks</span>
<span class="cm"> *</span>
<span class="cm"> * Can be called in a soft IRQ context, so xprt_write_space never sleeps.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       write space: waking waiting task on &quot;</span>
				<span class="s">&quot;xprt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
		<span class="n">rpc_wake_up_queued_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">snd_task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_write_space</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_set_retrans_timeout_def - set a request&#39;s retransmit timeout</span>
<span class="cm"> * @task: task whose timeout is to be set</span>
<span class="cm"> *</span>
<span class="cm"> * Set a request&#39;s retransmit timeout based on the transport&#39;s</span>
<span class="cm"> * default timeout parameters.  Used by transports that don&#39;t adjust</span>
<span class="cm"> * the retransmit timeout based on round-trip time estimation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_set_retrans_timeout_def</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_set_retrans_timeout_def</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * xprt_set_retrans_timeout_rtt - set a request&#39;s retransmit timeout</span>
<span class="cm"> * @task: task whose timeout is to be set</span>
<span class="cm"> *</span>
<span class="cm"> * Set a request&#39;s retransmit timeout using the RTT estimator.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_set_retrans_timeout_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rtt</span> <span class="o">*</span><span class="n">rtt</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_rtt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_timeout</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_maxval</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="n">rpc_calc_rto</span><span class="p">(</span><span class="n">rtt</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">&lt;&lt;=</span> <span class="n">rpc_ntimeo</span><span class="p">(</span><span class="n">rtt</span><span class="p">,</span> <span class="n">timer</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_retries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">&gt;</span> <span class="n">max_timeout</span> <span class="o">||</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="n">max_timeout</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_set_retrans_timeout_rtt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_reset_majortimeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_exponential</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">&lt;&lt;=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">+=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_increment</span> <span class="o">*</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_retries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">&gt;</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_adjust_timeout - adjust timeout values for next retransmit</span>
<span class="cm"> * @req: RPC request containing parameters to use for the adjustment</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_adjust_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_majortimeo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_exponential</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">+=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_increment</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">&gt;=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_maxval</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_retries</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xprt_reset_majortimeo</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="cm">/* Reset the RTT counters == &quot;slow start&quot; */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
		<span class="n">rpc_init_rtt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_rtt</span><span class="p">,</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;xprt_adjust_timeout: rq_timeout = 0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_autoclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_xprt</span><span class="p">,</span> <span class="n">task_cleanup</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_CLOSE_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">xprt_release_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_disconnect_done - mark a transport as disconnected</span>
<span class="cm"> * @xprt: transport to flag for disconnect</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_disconnect_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       disconnected transport %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">xprt_clear_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">xprt_wake_pending_tasks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_disconnect_done</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_force_disconnect - force a transport to disconnect</span>
<span class="cm"> * @xprt: transport to disconnect</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_force_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t race with the test_bit() in xprt_clear_locked() */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPRT_CLOSE_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* Try to schedule an autoclose RPC call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rpciod_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">);</span>
	<span class="n">xprt_wake_pending_tasks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_conditional_disconnect - force a transport to disconnect</span>
<span class="cm"> * @xprt: transport to disconnect</span>
<span class="cm"> * @cookie: &#39;connection cookie&#39;</span>
<span class="cm"> *</span>
<span class="cm"> * This attempts to break the connection if and only if &#39;cookie&#39; matches</span>
<span class="cm"> * the current transport &#39;connection cookie&#39;. It ensures that we don&#39;t</span>
<span class="cm"> * try to break the connection more than once when we need to retransmit</span>
<span class="cm"> * a batch of RPC requests.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_conditional_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t race with the test_bit() in xprt_clear_locked() */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">connect_cookie</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_CLOSING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">xprt_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPRT_CLOSE_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* Try to schedule an autoclose RPC call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rpciod_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">);</span>
	<span class="n">xprt_wake_pending_tasks</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xprt_init_autodisconnect</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">)</span> <span class="o">||</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_abort</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_abort</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTION_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">rpciod_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_abort:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_connect - schedule a transport connect operation</span>
<span class="cm"> * @task: RPC task that is requesting the connect</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_connect xprt %p %s connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">xprt</span><span class="p">,</span> <span class="p">(</span><span class="n">xprt_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;is&quot;</span> <span class="o">:</span> <span class="s">&quot;is not&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt_bound</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt_lock_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">XPRT_CLOSE_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xprt_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="n">xprt_release_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">xprt_connect_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_CLOSING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xprt_test_and_set_connecting</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_connect_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">connect_start</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_connect_status: connection established</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_connect_status: retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_connect_status: connect attempt timed &quot;</span>
				<span class="s">&quot;out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_connect_status: error %d connecting to &quot;</span>
				<span class="s">&quot;server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="o">-</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">,</span>
				<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">);</span>
		<span class="n">xprt_release_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_lookup_rqst - find an RPC request corresponding to an XID</span>
<span class="cm"> * @xprt: transport on which the original request was transmitted</span>
<span class="cm"> * @xid: RPC XID of incoming reply</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="nf">xprt_lookup_rqst</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">xid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">,</span> <span class="n">rq_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">rq_xid</span> <span class="o">==</span> <span class="n">xid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       xprt_lookup_rqst did not find xid %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">xid</span><span class="p">));</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bad_xids</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_lookup_rqst</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_update_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rtt</span> <span class="o">*</span><span class="n">rtt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_rtt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span><span class="o">-&gt;</span><span class="n">p_timer</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">m</span> <span class="o">=</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_rtt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rpc_update_rtt</span><span class="p">(</span><span class="n">rtt</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">rpc_set_timeo</span><span class="p">(</span><span class="n">rtt</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_ntrans</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_complete_rqst - called when reply processing is complete</span>
<span class="cm"> * @task: RPC request that recently completed</span>
<span class="cm"> * @copied: actual number of bytes received from the transport</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds transport lock.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_complete_rqst</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xid %08x complete (%d bytes received)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xid</span><span class="p">),</span> <span class="n">copied</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">recvs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_rtt</span> <span class="o">=</span> <span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">(),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xprt_update_rtt</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_private_buf</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>
	<span class="cm">/* Ensure all writes are done before we update */</span>
	<span class="cm">/* req-&gt;rq_reply_bytes_recvd */</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>
	<span class="n">rpc_wake_up_queued_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_complete_rqst</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_has_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">idle_timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_prepare_transmit - reserve the transport before sending a request</span>
<span class="cm"> * @task: RPC task about to send a request</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xprt_prepare_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_prepare_transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reserve_xprt</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xprt_end_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xprt_release_write</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_transmit - send an RPC request on a transport</span>
<span class="cm"> * @task: controlling RPC task</span>
<span class="cm"> *</span>
<span class="cm"> * We have to copy the iovec because sendmsg fiddles with its contents.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">numreqs</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xprt_transmit(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_slen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rpc_reply_expected</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Add to the list only if we&#39;re expecting a reply</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
			<span class="cm">/* Update the softirq receive buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_private_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_rcv_buf</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_private_buf</span><span class="p">));</span>
			<span class="cm">/* Add request to the receive list */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
			<span class="n">xprt_reset_majortimeo</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="cm">/* Turn off autodisconnect */</span>
			<span class="n">del_singleshot_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bytes_sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_connect_cookie</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">connect_cookie</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xtime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u xmit complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_flags</span> <span class="o">|=</span> <span class="n">RPC_TASK_SENT</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_retrans_timeout</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">numreqs</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">num_reqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numreqs</span> <span class="o">&gt;</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">max_slots</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">max_slots</span> <span class="o">=</span> <span class="n">numreqs</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sends</span><span class="o">++</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">req_u</span> <span class="o">+=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sends</span> <span class="o">-</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">recvs</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bklog_u</span> <span class="o">+=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sending_u</span> <span class="o">+=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">pending_u</span> <span class="o">+=</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t race with disconnect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt_connected</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_reply_bytes_recvd</span> <span class="o">&amp;&amp;</span> <span class="n">rpc_reply_expected</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Sleep on the pending queue since</span>
<span class="cm">		 * we&#39;re expecting a reply.</span>
<span class="cm">		 */</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">xprt_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="nf">xprt_dynamic_alloc_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">num_reqs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_reqs</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">num_reqs</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">xprt_dynamic_free_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">num_reqs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">min_reqs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_alloc_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span><span class="p">,</span> <span class="n">rq_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_init_req</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">xprt_dynamic_alloc_slot</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_init_req</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       dynamic allocation of request slot &quot;</span>
				<span class="s">&quot;failed! Retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       waiting for request slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_init_req:</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">xprt_request_init</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_free_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reserve_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt_dynamic_free_slot</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>	<span class="cm">/* mark unused */</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rpc_wake_up_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reserve_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_free_all_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_rqst</span><span class="p">,</span> <span class="n">rq_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="nf">xprt_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_prealloc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">xprt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">xprt_init</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_prealloc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_prealloc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_alloc</span> <span class="o">&gt;</span> <span class="n">num_prealloc</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="n">max_alloc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="n">num_prealloc</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">min_reqs</span> <span class="o">=</span> <span class="n">num_prealloc</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">num_reqs</span><span class="p">,</span> <span class="n">num_prealloc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">xprt</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">xprt_free</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_alloc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">xprt_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_net</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xprt_net</span><span class="p">);</span>
	<span class="n">xprt_free_all_slots</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xprt_free</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_reserve - allocate an RPC request slot</span>
<span class="cm"> * @task: RPC task requesting a slot allocation</span>
<span class="cm"> *</span>
<span class="cm"> * If no more slots are available, place the task on the transport&#39;s</span>
<span class="cm"> * backlog queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_xprt</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Note: grabbing the xprt_lock_write() here is not strictly needed,</span>
<span class="cm">	 * but ensures that we throttle new slot allocation if the transport</span>
<span class="cm">	 * is congested (e.g. if reconnecting or if we&#39;re out of socket</span>
<span class="cm">	 * write buffer space).</span>
<span class="cm">	 */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xprt_lock_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reserve_lock</span><span class="p">);</span>
	<span class="n">xprt_alloc_slot</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reserve_lock</span><span class="p">);</span>
	<span class="n">xprt_release_write</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span> <span class="nf">xprt_alloc_xid</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_init_xid</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_request_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_initval</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_task</span>	<span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span>    <span class="o">=</span> <span class="n">xprt</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_buffer</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xid</span>     <span class="o">=</span> <span class="n">xprt_alloc_xid</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_release_snd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xprt_reset_majortimeo</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u reserved req %p xid %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xid</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_release - release an RPC request slot</span>
<span class="cm"> * @task: task which is finished with the slot</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_rqst</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xprt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_xprt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_ops</span><span class="o">-&gt;</span><span class="n">rpc_count_stats</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_ops</span><span class="o">-&gt;</span><span class="n">rpc_count_stats</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_calldata</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="p">)</span>
		<span class="n">rpc_count_iostats</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_client</span><span class="o">-&gt;</span><span class="n">cl_metrics</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">release_xprt</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">release_request</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">release_request</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">))</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_list</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">xprt_has_timer</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">+</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">idle_timeout</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_buffer</span><span class="p">)</span>
		<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">buf_free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_cred</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_rqstp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_release_snd_buf</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_release_snd_buf</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC: %5u release request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bc_prealloc</span><span class="p">(</span><span class="n">req</span><span class="p">)))</span>
		<span class="n">xprt_free_slot</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">xprt_free_bc_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">transport_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">reserve_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bc_pa_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bc_pa_list</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">cwnd</span> <span class="o">=</span> <span class="n">RPC_INITCWND</span><span class="p">;</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">bind_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">binding</span><span class="p">,</span> <span class="s">&quot;xprt_binding&quot;</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="s">&quot;xprt_pending&quot;</span><span class="p">);</span>
	<span class="n">rpc_init_priority_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">,</span> <span class="s">&quot;xprt_sending&quot;</span><span class="p">);</span>
	<span class="n">rpc_init_priority_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">,</span> <span class="s">&quot;xprt_backlog&quot;</span><span class="p">);</span>

	<span class="n">xprt_init_xid</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>

	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">xprt_net</span> <span class="o">=</span> <span class="n">get_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_create_transport - create an RPC transport</span>
<span class="cm"> * @args: rpc transport creation arguments</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="nf">xprt_create_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_create</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span>	<span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt_list_lock</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RPC: transport (%d) not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

<span class="nl">found:</span>
	<span class="n">xprt</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       xprt_create_transport: failed, %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">-</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xprt</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">,</span> <span class="n">xprt_autoclose</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt_has_timer</span><span class="p">(</span><span class="n">xprt</span><span class="p">))</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">xprt_init_autodisconnect</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xprt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RPC_MAXNETNAMELEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt_destroy</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xprt_destroy</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       created transport %p with %u slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">,</span>
			<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">max_reqs</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">xprt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_destroy - destroy an RPC transport, killing off all requests.</span>
<span class="cm"> * @xprt: transport to destroy</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xprt_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RPC:       destroying transport %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">shutdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">binding</span><span class="p">);</span>
	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">sending</span><span class="p">);</span>
	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">task_cleanup</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">servername</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Tear down transport state and free the rpc_xprt</span>
<span class="cm">	 */</span>
	<span class="n">xprt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_put - release a reference to an RPC transport.</span>
<span class="cm"> * @xprt: pointer to the transport</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xprt_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="n">xprt_destroy</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xprt_get - return a reference to an RPC transport.</span>
<span class="cm"> * @xprt: pointer to the transport</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="nf">xprt_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">xprt</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
