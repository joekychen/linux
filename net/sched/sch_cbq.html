<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sched › sch_cbq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sch_cbq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/sched/sch_cbq.c	Class-Based Queueing discipline.</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;net/netlink.h&gt;</span>
<span class="cp">#include &lt;net/pkt_sched.h&gt;</span>


<span class="cm">/*	Class-Based Queueing (CBQ) algorithm.</span>
<span class="cm">	=======================================</span>

<span class="cm">	Sources: [1] Sally Floyd and Van Jacobson, &quot;Link-sharing and Resource</span>
<span class="cm">		 Management Models for Packet Networks&quot;,</span>
<span class="cm">		 IEEE/ACM Transactions on Networking, Vol.3, No.4, 1995</span>

<span class="cm">		 [2] Sally Floyd, &quot;Notes on CBQ and Guaranteed Service&quot;, 1995</span>

<span class="cm">		 [3] Sally Floyd, &quot;Notes on Class-Based Queueing: Setting</span>
<span class="cm">		 Parameters&quot;, 1996</span>

<span class="cm">		 [4] Sally Floyd and Michael Speer, &quot;Experimental Results</span>
<span class="cm">		 for Class-Based Queueing&quot;, 1998, not published.</span>

<span class="cm">	-----------------------------------------------------------------------</span>

<span class="cm">	Algorithm skeleton was taken from NS simulator cbq.cc.</span>
<span class="cm">	If someone wants to check this code against the LBL version,</span>
<span class="cm">	he should take into account that ONLY the skeleton was borrowed,</span>
<span class="cm">	the implementation is different. Particularly:</span>

<span class="cm">	--- The WRR algorithm is different. Our version looks more</span>
<span class="cm">	reasonable (I hope) and works when quanta are allowed to be</span>
<span class="cm">	less than MTU, which is always the case when real time classes</span>
<span class="cm">	have small rates. Note, that the statement of [3] is</span>
<span class="cm">	incomplete, delay may actually be estimated even if class</span>
<span class="cm">	per-round allotment is less than MTU. Namely, if per-round</span>
<span class="cm">	allotment is W*r_i, and r_1+...+r_k = r &lt; 1</span>

<span class="cm">	delay_i &lt;= ([MTU/(W*r_i)]*W*r + W*r + k*MTU)/B</span>

<span class="cm">	In the worst case we have IntServ estimate with D = W*r+k*MTU</span>
<span class="cm">	and C = MTU*r. The proof (if correct at all) is trivial.</span>


<span class="cm">	--- It seems that cbq-2.0 is not very accurate. At least, I cannot</span>
<span class="cm">	interpret some places, which look like wrong translations</span>
<span class="cm">	from NS. Anyone is advised to find these differences</span>
<span class="cm">	and explain to me, why I am wrong 8).</span>

<span class="cm">	--- Linux has no EOI event, so that we cannot estimate true class</span>
<span class="cm">	idle time. Workaround is to consider the next dequeue event</span>
<span class="cm">	as sign that previous packet is finished. This is wrong because of</span>
<span class="cm">	internal device queueing, but on a permanently loaded link it is true.</span>
<span class="cm">	Moreover, combined with clock integrator, this scheme looks</span>
<span class="cm">	very close to an ideal solution.  */</span>

<span class="k">struct</span> <span class="n">cbq_sched_data</span><span class="p">;</span>


<span class="k">struct</span> <span class="n">cbq_class</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">Qdisc_class_common</span> <span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">next_alive</span><span class="p">;</span>	<span class="cm">/* next class with backlog in this priority band */</span>

<span class="cm">/* Parameters */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">priority</span><span class="p">;</span>	<span class="cm">/* class priority */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">priority2</span><span class="p">;</span>	<span class="cm">/* priority to be used after overlimit */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ewma_log</span><span class="p">;</span>	<span class="cm">/* time constant for idle time calculation */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ovl_strategy</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">police</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">u32</span>			<span class="n">defmap</span><span class="p">;</span>

	<span class="cm">/* Link-sharing scheduler parameters */</span>
	<span class="kt">long</span>			<span class="n">maxidle</span><span class="p">;</span>	<span class="cm">/* Class parameters: see below. */</span>
	<span class="kt">long</span>			<span class="n">offtime</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">minidle</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">avpkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdisc_rate_table</span>	<span class="o">*</span><span class="n">R_tab</span><span class="p">;</span>

	<span class="cm">/* Overlimit strategy parameters */</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">overlimit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">);</span>
	<span class="n">psched_tdiff_t</span>		<span class="n">penalty</span><span class="p">;</span>

	<span class="cm">/* General scheduler (WRR) parameters */</span>
	<span class="kt">long</span>			<span class="n">allot</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">quantum</span><span class="p">;</span>	<span class="cm">/* Allotment per WRR round */</span>
	<span class="kt">long</span>			<span class="n">weight</span><span class="p">;</span>		<span class="cm">/* Relative allotment: see below */</span>

	<span class="k">struct</span> <span class="n">Qdisc</span>		<span class="o">*</span><span class="n">qdisc</span><span class="p">;</span>		<span class="cm">/* Ptr to CBQ discipline */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">split</span><span class="p">;</span>		<span class="cm">/* Ptr to split node */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">share</span><span class="p">;</span>		<span class="cm">/* Ptr to LS parent in the class tree */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">tparent</span><span class="p">;</span>	<span class="cm">/* Ptr to tree parent in the class tree */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">borrow</span><span class="p">;</span>	<span class="cm">/* NULL if class is bandwidth limited;</span>
<span class="cm">						   parent otherwise */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">sibling</span><span class="p">;</span>	<span class="cm">/* Sibling chain */</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">children</span><span class="p">;</span>	<span class="cm">/* Pointer to children chain */</span>

	<span class="k">struct</span> <span class="n">Qdisc</span>		<span class="o">*</span><span class="n">q</span><span class="p">;</span>		<span class="cm">/* Elementary queueing discipline */</span>


<span class="cm">/* Variables */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cpriority</span><span class="p">;</span>	<span class="cm">/* Effective priority */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">delayed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">level</span><span class="p">;</span>		<span class="cm">/* level of the class in hierarchy:</span>
<span class="cm">						   0 for leaf classes, and maximal</span>
<span class="cm">						   level of children + 1 for nodes.</span>
<span class="cm">						 */</span>

	<span class="n">psched_time_t</span>		<span class="n">last</span><span class="p">;</span>		<span class="cm">/* Last end of service */</span>
	<span class="n">psched_time_t</span>		<span class="n">undertime</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">avgidle</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">deficit</span><span class="p">;</span>	<span class="cm">/* Saved deficit for WRR */</span>
	<span class="n">psched_time_t</span>		<span class="n">penalized</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gnet_stats_basic_packed</span> <span class="n">bstats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gnet_stats_queue</span> <span class="n">qstats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gnet_stats_rate_est</span> <span class="n">rate_est</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc_cbq_xstats</span>	<span class="n">xstats</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tcf_proto</span>	<span class="o">*</span><span class="n">filter_list</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">refcnt</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">filters</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">defaults</span><span class="p">[</span><span class="n">TC_PRIO_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">Qdisc_class_hash</span>	<span class="n">clhash</span><span class="p">;</span>			<span class="cm">/* Hash table of all classes */</span>
	<span class="kt">int</span>			<span class="n">nclasses</span><span class="p">[</span><span class="n">TC_CBQ_MAXPRIO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">quanta</span><span class="p">[</span><span class="n">TC_CBQ_MAXPRIO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="n">link</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">activemask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">active</span><span class="p">[</span><span class="n">TC_CBQ_MAXPRIO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* List of all classes</span>
<span class="cm">								   with backlog */</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">rx_class</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">tx_class</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span>	<span class="o">*</span><span class="n">tx_borrowed</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tx_len</span><span class="p">;</span>
	<span class="n">psched_time_t</span>		<span class="n">now</span><span class="p">;</span>		<span class="cm">/* Cached timestamp */</span>
	<span class="n">psched_time_t</span>		<span class="n">now_rt</span><span class="p">;</span>		<span class="cm">/* Cached real time */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pmask</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hrtimer</span>		<span class="n">delay_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdisc_watchdog</span>	<span class="n">watchdog</span><span class="p">;</span>	<span class="cm">/* Watchdog timer,</span>
<span class="cm">						   started when CBQ has</span>
<span class="cm">						   backlog, but cannot</span>
<span class="cm">						   transmit just now */</span>
	<span class="n">psched_tdiff_t</span>		<span class="n">wd_expires</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">toplevel</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">hgenerator</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define L2T(cl, len)	qdisc_l2t((cl)-&gt;R_tab, len)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span>
<span class="nf">cbq_class_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="n">classid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Qdisc_class_common</span> <span class="o">*</span><span class="n">clc</span><span class="p">;</span>

	<span class="n">clc</span> <span class="o">=</span> <span class="n">qdisc_class_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">,</span> <span class="n">classid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">clc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span>
<span class="nf">cbq_reclassify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span> <span class="n">cl</span><span class="p">;</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">TC_PRIO_BESTEFFORT</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">this</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* Classify packet. The procedure is pretty complicated, but</span>
<span class="cm"> * it allows us to combine link sharing and priority scheduling</span>
<span class="cm"> * transparently.</span>
<span class="cm"> *</span>
<span class="cm"> * Namely, you can put link sharing rules (f.e. route based) at root of CBQ,</span>
<span class="cm"> * so that it resolves to split nodes. Then packets are classified</span>
<span class="cm"> * by logical priority, or a more specific classifier may be attached</span>
<span class="cm"> * to the split node.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span>
<span class="nf">cbq_classify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">qerr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">**</span><span class="n">defmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcf_result</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Step 1. If skb-&gt;priority points to one of our classes, use it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TC_H_MAJ</span><span class="p">(</span><span class="n">prio</span> <span class="o">^</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prio</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>

	<span class="o">*</span><span class="n">qerr</span> <span class="o">=</span> <span class="n">NET_XMIT_SUCCESS</span> <span class="o">|</span> <span class="n">__NET_XMIT_BYPASS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">defmap</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Step 2+n. Apply classifier.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">filter_list</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">tc_classify_compat</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">filter_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fallback</span><span class="p">;</span>

		<span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">class</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TC_H_MAJ</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">classid</span><span class="p">))</span>
				<span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">classid</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="n">defmap</span><span class="p">[</span><span class="n">res</span><span class="p">.</span><span class="n">classid</span> <span class="o">&amp;</span> <span class="n">TC_PRIO_MAX</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">cl</span> <span class="o">=</span> <span class="n">defmap</span><span class="p">[</span><span class="n">TC_PRIO_BESTEFFORT</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fallback</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TC_ACT_QUEUED</span>:
		<span class="k">case</span> <span class="n">TC_ACT_STOLEN</span>:
			<span class="o">*</span><span class="n">qerr</span> <span class="o">=</span> <span class="n">NET_XMIT_SUCCESS</span> <span class="o">|</span> <span class="n">__NET_XMIT_STOLEN</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TC_ACT_SHOT</span>:
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TC_ACT_RECLASSIFY</span>:
			<span class="k">return</span> <span class="n">cbq_reclassify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Step 3+n. If classifier selected a link sharing class,</span>
<span class="cm">		 *	   apply agency specific classifier.</span>
<span class="cm">		 *	   Repeat this procdure until we hit a leaf node.</span>
<span class="cm">		 */</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">fallback:</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 4. No success...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TC_H_MAJ</span><span class="p">(</span><span class="n">prio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">prio</span> <span class="o">&amp;</span> <span class="n">TC_PRIO_MAX</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">TC_PRIO_BESTEFFORT</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">head</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A packet has just been enqueued on the empty class.</span>
<span class="cm"> * cbq_activate_class adds it to the tail of active class list</span>
<span class="cm"> * of its priority band.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cbq_activate_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl_tail</span><span class="p">;</span>

	<span class="n">cl_tail</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl_tail</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl_tail</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
		<span class="n">cl_tail</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">activemask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unlink class from active chain.</span>
<span class="cm"> * Note that this same procedure is done directly in cbq_dequeue*</span>
<span class="cm"> * during round-robin procedure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_deactivate_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">cpriority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl_prev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">q</span><span class="o">-&gt;</span><span class="n">activemask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl_prev</span> <span class="o">=</span> <span class="n">cl</span><span class="p">)</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cbq_mark_toplevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">toplevel</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">toplevel</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">qdisc_is_throttled</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">psched_time_t</span> <span class="n">now</span><span class="p">;</span>
		<span class="n">psched_tdiff_t</span> <span class="n">incr</span><span class="p">;</span>

		<span class="n">now</span> <span class="o">=</span> <span class="n">psched_get_time</span><span class="p">();</span>
		<span class="n">incr</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now_rt</span><span class="p">;</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+</span> <span class="n">incr</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">toplevel</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cbq_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_classify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">__NET_XMIT_BYPASS</span><span class="p">)</span>
			<span class="n">sch</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">drops</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">__parent</span> <span class="o">=</span> <span class="n">sch</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qdisc_enqueue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">NET_XMIT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cbq_mark_toplevel</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">)</span>
			<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_xmit_drop_count</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">drops</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cbq_mark_toplevel</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">drops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Overlimit actions */</span>

<span class="cm">/* TC_CBQ_OVL_CLASSIC: (default) penalize leaf class by adding offtime */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_ovl_classic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="n">psched_tdiff_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delay</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Class goes to sleep, so that it will have no</span>
<span class="cm">		 * chance to work avgidle. Let&#39;s forgive it 8)</span>
<span class="cm">		 *</span>
<span class="cm">		 * BTW cbq-2.0 has a crap in this</span>
<span class="cm">		 * place, apparently they forgot to shift it by cl-&gt;ewma_log.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">-=</span> <span class="p">(</span><span class="o">-</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="o">-</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">)</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span><span class="p">;</span>

		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">overactions</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">&gt;</span> <span class="n">delay</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>

	<span class="cm">/* Dirty work! We must schedule wakeups based on</span>
<span class="cm">	 * real available rate, rather than leaf rate,</span>
<span class="cm">	 * which may be tiny (even zero).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">==</span> <span class="n">TC_CBQ_MAXLEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
		<span class="n">psched_tdiff_t</span> <span class="n">base_delay</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">;</span> <span class="n">b</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">base_delay</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">base_delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">=</span> <span class="n">base_delay</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* TC_CBQ_OVL_RCLASSIC: penalize by offtime classes in hierarchy, when</span>
<span class="cm"> * they go overlimit</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_ovl_rclassic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="n">cbq_ovl_classic</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TC_CBQ_OVL_DELAY: delay until it will go to underlimit */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_ovl_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="n">psched_tdiff_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QDISC_STATE_DEACTIVATED</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">qdisc_root_sleeping</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psched_time_t</span> <span class="n">sched</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
		<span class="n">ktime_t</span> <span class="n">expires</span><span class="p">;</span>

		<span class="n">delay</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">-=</span> <span class="p">(</span><span class="o">-</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="o">-</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">)</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sched</span> <span class="o">+=</span> <span class="n">delay</span> <span class="o">+</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalty</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalized</span> <span class="o">=</span> <span class="n">sched</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TC_CBQ_MAXPRIO</span><span class="p">);</span>

			<span class="n">expires</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">expires</span> <span class="o">=</span> <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">PSCHED_TICKS2NS</span><span class="p">(</span><span class="n">sched</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_try_to_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span>
					<span class="n">hrtimer_get_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">),</span>
					<span class="n">expires</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hrtimer_set_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
			<span class="n">hrtimer_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">);</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">overactions</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">&gt;</span> <span class="n">delay</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TC_CBQ_OVL_LOWPRIO: penalize class by lowering its priority band */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_ovl_lowprio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalized</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">!=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span><span class="p">);</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">overactions</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cbq_ovl_classic</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TC_CBQ_OVL_DROP: penalize class by dropping */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_ovl_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drop</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drop</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">))</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">overactions</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cbq_ovl_classic</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">psched_tdiff_t</span> <span class="nf">cbq_undelay_prio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
				       <span class="n">psched_time_t</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl_prev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
	<span class="n">psched_time_t</span> <span class="n">sched</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl_prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalized</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sched</span> <span class="o">-</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalized</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sched</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalized</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl_prev</span> <span class="o">=</span> <span class="n">cl</span><span class="p">)</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">sched</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">cbq_undelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_sched_data</span><span class="p">,</span>
						<span class="n">delay_timer</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">qdisc</span><span class="p">;</span>
	<span class="n">psched_time_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">psched_tdiff_t</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pmask</span><span class="p">;</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">psched_get_time</span><span class="p">();</span>

	<span class="n">pmask</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="o">~</span><span class="n">pmask</span><span class="p">);</span>
		<span class="n">psched_tdiff_t</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">pmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cbq_undelay_prio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">delay</span> <span class="o">||</span> <span class="n">delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ktime_t</span> <span class="n">time</span><span class="p">;</span>

		<span class="n">time</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">PSCHED_TICKS2NS</span><span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span><span class="p">));</span>
		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qdisc_unthrottled</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="n">__netif_schedule</span><span class="p">(</span><span class="n">qdisc_root</span><span class="p">(</span><span class="n">sch</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">HRTIMER_NORESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_reshape_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">__parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_reclassify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">cbq_mark_toplevel</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>

		<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">__parent</span> <span class="o">=</span> <span class="n">sch</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qdisc_enqueue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">NET_XMIT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">)</span>
				<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_xmit_drop_count</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="n">sch</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">drops</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">drops</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * It is mission critical procedure.</span>
<span class="cm"> *</span>
<span class="cm"> * We &quot;regenerate&quot; toplevel cutoff, if transmitting class</span>
<span class="cm"> * has backlog and it is not regulated. It is not part of</span>
<span class="cm"> * original CBQ description, but looks more reasonable.</span>
<span class="cm"> * Probably, it is wrong. This question needs further investigation.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cbq_update_toplevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">borrowed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">&gt;=</span> <span class="n">borrowed</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">borrowed</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">==</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">borrowed</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">borrowed</span> <span class="o">=</span> <span class="n">borrowed</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* It is not necessary now. Uncommenting it</span>
<span class="c">	   will save CPU cycles, but decrease fairness.</span>
<span class="c">	 */</span>
<span class="c">		q-&gt;toplevel = TC_CBQ_MAXLEVEL;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cbq_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">cl</span><span class="p">;</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">idle</span><span class="p">;</span>

		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * (now - last) is total time between packet right edges.</span>
<span class="cm">		 * (last_pktlen/rate) is &quot;virtual&quot; busy time, so that</span>
<span class="cm">		 *</span>
<span class="cm">		 *	idle = (now - last) - last_pktlen/rate</span>
<span class="cm">		 */</span>

		<span class="n">idle</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">-</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">idle</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">idle</span> <span class="o">-=</span> <span class="n">L2T</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* true_avgidle := (1-W)*true_avgidle + W*idle,</span>
<span class="cm">		 * where W=2^{-ewma_log}. But cl-&gt;avgidle is scaled:</span>
<span class="cm">		 * cl-&gt;avgidle == true_avgidle/W,</span>
<span class="cm">		 * hence:</span>
<span class="cm">		 */</span>
			<span class="n">avgidle</span> <span class="o">+=</span> <span class="n">idle</span> <span class="o">-</span> <span class="p">(</span><span class="n">avgidle</span><span class="o">&gt;&gt;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">avgidle</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Overlimit or at-limit */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">avgidle</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">)</span>
				<span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">;</span>

			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">avgidle</span><span class="p">;</span>

			<span class="cm">/* Calculate expected time, when this class</span>
<span class="cm">			 * will be allowed to send.</span>
<span class="cm">			 * It will occur, when:</span>
<span class="cm">			 * (1-W)*true_avgidle + W*delay = 0, i.e.</span>
<span class="cm">			 * idle = (1/W - 1)*(-true_avgidle)</span>
<span class="cm">			 * or</span>
<span class="cm">			 * idle = (1 - W)*(-cl-&gt;avgidle);</span>
<span class="cm">			 */</span>
			<span class="n">idle</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="o">-</span><span class="n">avgidle</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * That is not all.</span>
<span class="cm">			 * To maintain the rate allocated to the class,</span>
<span class="cm">			 * we add to undertime virtual clock,</span>
<span class="cm">			 * necessary to complete transmitted packet.</span>
<span class="cm">			 * (len/phys_bandwidth has been already passed</span>
<span class="cm">			 * to the moment of cbq_update)</span>
<span class="cm">			 */</span>

			<span class="n">idle</span> <span class="o">-=</span> <span class="n">L2T</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">idle</span> <span class="o">+=</span> <span class="n">L2T</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+</span> <span class="n">idle</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Underlimit */</span>

			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">avgidle</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">)</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">avgidle</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cbq_update_toplevel</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span>
<span class="nf">cbq_under_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this_cl</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">==</span> <span class="n">PSCHED_PASTPERFECT</span> <span class="o">||</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* It is very suspicious place. Now overlimit</span>
<span class="cm">		 * action is generated for not bounded classes</span>
<span class="cm">		 * only if link is completely congested.</span>
<span class="cm">		 * Though it is in agree with ancestor-only paradigm,</span>
<span class="cm">		 * it looks very stupid. Particularly,</span>
<span class="cm">		 * it means that this chunk of code will either</span>
<span class="cm">		 * never be called or result in strong amplification</span>
<span class="cm">		 * of burstiness. Dangerous, silly, and, however,</span>
<span class="cm">		 * no another solution exists.</span>
<span class="cm">		 */</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this_cl</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">overlimits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">this_cl</span><span class="o">-&gt;</span><span class="n">overlimit</span><span class="p">(</span><span class="n">this_cl</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">!=</span> <span class="n">PSCHED_PASTPERFECT</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span><span class="p">);</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">delayed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">cbq_dequeue_prio</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl_tail</span><span class="p">,</span> <span class="o">*</span><span class="n">cl_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">deficit</span><span class="p">;</span>

	<span class="n">cl_tail</span> <span class="o">=</span> <span class="n">cl_prev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">deficit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Start round */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">borrow</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">borrow</span> <span class="o">=</span> <span class="n">cbq_under_limit</span><span class="p">(</span><span class="n">cl</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip_class</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Class exhausted its allotment per</span>
<span class="cm">				 * this round. Switch to the next one.</span>
<span class="cm">				 */</span>
				<span class="n">deficit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">next_class</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dequeue</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>

			<span class="cm">/* Class did not give us any skb :-(</span>
<span class="cm">			 * It could occur even if cl-&gt;q-&gt;q.qlen != 0</span>
<span class="cm">			 * f.e. if cl-&gt;q == &quot;tbf&quot;</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip_class</span><span class="p">;</span>

			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">-=</span> <span class="n">qdisc_pkt_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span> <span class="o">=</span> <span class="n">borrow</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">borrow</span> <span class="o">!=</span> <span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CBQ_XSTATS_BORROWS_BYTES</span>
				<span class="n">borrow</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">borrows</span><span class="o">++</span><span class="p">;</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">borrows</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
				<span class="n">borrow</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">borrows</span> <span class="o">+=</span> <span class="n">qdisc_pkt_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">borrows</span> <span class="o">+=</span> <span class="n">qdisc_pkt_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">=</span> <span class="n">qdisc_pkt_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
				<span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">skip_class:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">!=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Class is empty or penalized.</span>
<span class="cm">				 * Unlink it from active chain.</span>
<span class="cm">				 */</span>
				<span class="n">cl_prev</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="cm">/* Did cl_tail point to it? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">cl_tail</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Repair it! */</span>
					<span class="n">cl_tail</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="p">;</span>

					<span class="cm">/* Was it the last class in this band? */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">cl_tail</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Kill the band! */</span>
						<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="n">q</span><span class="o">-&gt;</span><span class="n">activemask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
							<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_tail</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
					<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

				<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="p">;</span>
			<span class="p">}</span>

<span class="nl">next_class:</span>
			<span class="n">cl_prev</span> <span class="o">=</span> <span class="n">cl</span><span class="p">;</span>
			<span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cl_prev</span> <span class="o">!=</span> <span class="n">cl_tail</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">deficit</span><span class="p">);</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_prev</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">cbq_dequeue_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">activemask</span><span class="p">;</span>

	<span class="n">activemask</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">activemask</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">activemask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="o">~</span><span class="n">activemask</span><span class="p">);</span>
		<span class="n">activemask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prio</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">cbq_dequeue_prio</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">cbq_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="n">psched_time_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">psched_tdiff_t</span> <span class="n">incr</span><span class="p">;</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">psched_get_time</span><span class="p">();</span>
	<span class="n">incr</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now_rt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psched_tdiff_t</span> <span class="n">incr2</span><span class="p">;</span>
		<span class="cm">/* Time integrator. We calculate EOS time</span>
<span class="cm">		 * by adding expected packet transmission time.</span>
<span class="cm">		 * If real time is greater, we warp artificial clock,</span>
<span class="cm">		 * so that:</span>
<span class="cm">		 *</span>
<span class="cm">		 * cbq_time = max(real_time, work);</span>
<span class="cm">		 */</span>
		<span class="n">incr2</span> <span class="o">=</span> <span class="n">L2T</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+=</span> <span class="n">incr2</span><span class="p">;</span>
		<span class="n">cbq_update</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">incr</span> <span class="o">-=</span> <span class="n">incr2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">incr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">+=</span> <span class="n">incr</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now_rt</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">cbq_dequeue_1</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdisc_bstats_update</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
			<span class="n">qdisc_unthrottled</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* All the classes are overlimit.</span>
<span class="cm">		 *</span>
<span class="cm">		 * It is possible, if:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 1. Scheduler is empty.</span>
<span class="cm">		 * 2. Toplevel cutoff inhibited borrowing.</span>
<span class="cm">		 * 3. Root class is overlimit.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Reset 2d and 3d conditions and retry.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note, that NS and cbq-2.0 are buggy, peeking</span>
<span class="cm">		 * an arbitrary class is appropriate for ancestor-only</span>
<span class="cm">		 * sharing, but not for toplevel algorithm.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Our version is better, but slower, because it requires</span>
<span class="cm">		 * two passes, but it is unavoidable with top-level sharing.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">==</span> <span class="n">TC_CBQ_MAXLEVEL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">undertime</span> <span class="o">==</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXLEVEL</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No packets in scheduler or nobody wants to give them to us :-(</span>
<span class="cm">	 * Sigh... start watchdog timer in the last case.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">overlimits</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span><span class="p">)</span>
			<span class="n">qdisc_watchdog_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span>
						<span class="n">now</span> <span class="o">+</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">wd_expires</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CBQ class maintanance routines */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_adjust_levels</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>

		<span class="n">cl</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="o">!=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">this</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_normalize_quanta</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">quanta</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BUGGGG... Beware! This expression suffer of</span>
<span class="cm">			 * arithmetic overflows!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">==</span> <span class="n">prio</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span><span class="o">*</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">allot</span><span class="o">*</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nclasses</span><span class="p">[</span><span class="n">prio</span><span class="p">])</span><span class="o">/</span>
					<span class="n">q</span><span class="o">-&gt;</span><span class="n">quanta</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span><span class="o">&gt;</span><span class="mi">32</span><span class="o">*</span><span class="n">qdisc_dev</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;CBQ: class %08x has bad quantum==%ld, repaired.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">cl</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span><span class="p">);</span>
				<span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span> <span class="o">=</span> <span class="n">qdisc_dev</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_sync_defmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">split</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">split</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TC_PRIO_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cl</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)))</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TC_PRIO_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

			<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
					     <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">split</span> <span class="o">==</span> <span class="n">split</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">level</span> <span class="o">&amp;&amp;</span>
				    <span class="n">c</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">split</span><span class="o">-&gt;</span><span class="n">defaults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_change_defmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">splitid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">def</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">split</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">splitid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">split</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">splitid</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">split</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">!=</span> <span class="n">splitid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">split</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span> <span class="n">split</span><span class="p">;</span> <span class="n">split</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">==</span> <span class="n">splitid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">split</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span> <span class="o">!=</span> <span class="n">split</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cbq_sync_defmap</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span> <span class="o">=</span> <span class="n">split</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">=</span> <span class="n">def</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">def</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">cbq_sync_defmap</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_unlink_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="o">**</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>

	<span class="n">qdisc_class_hash_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">!=</span> <span class="n">this</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_link_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="n">qdisc_class_hash_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cbq_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="o">*</span><span class="n">cl_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">prio</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span><span class="p">;</span> <span class="n">prio</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prio</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl_head</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl_head</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cl</span> <span class="o">=</span> <span class="n">cl_head</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drop</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
					<span class="n">cbq_deactivate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cl_head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cbq_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">activemask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">pmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">qdisc_watchdog_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXLEVEL</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">=</span> <span class="n">psched_get_time</span><span class="p">();</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now_rt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prio</span> <span class="o">&lt;=</span> <span class="n">TC_CBQ_MAXPRIO</span><span class="p">;</span> <span class="n">prio</span><span class="o">++</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdisc_reset</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>

			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">deficit</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span><span class="p">;</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_set_lss</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc_cbq_lssopt</span> <span class="o">*</span><span class="n">lss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_FLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_ISOLATED</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span> <span class="o">=</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_BOUNDED</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_EWMA</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span> <span class="o">=</span> <span class="n">lss</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_AVPKT</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avpkt</span> <span class="o">=</span> <span class="n">lss</span><span class="o">-&gt;</span><span class="n">avpkt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_MINIDLE</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_MAXIDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span> <span class="o">=</span> <span class="n">lss</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">lss</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss</span><span class="o">-&gt;</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">TCF_CBQ_LSS_OFFTIME</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="n">lss</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_rmprio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">nclasses</span><span class="p">[</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">quanta</span><span class="p">[</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="n">cbq_normalize_quanta</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_addprio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">nclasses</span><span class="p">[</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">quanta</span><span class="p">[</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="n">cbq_normalize_quanta</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_set_wrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc_cbq_wrropt</span> <span class="o">*</span><span class="n">wrr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrr</span><span class="o">-&gt;</span><span class="n">allot</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">allot</span> <span class="o">=</span> <span class="n">wrr</span><span class="o">-&gt;</span><span class="n">allot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrr</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">=</span> <span class="n">wrr</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrr</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">wrr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span><span class="p">)</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cbq_addprio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_set_overlimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc_cbq_ovl</span> <span class="o">*</span><span class="n">ovl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">strategy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TC_CBQ_OVL_CLASSIC</span>:
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_classic</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TC_CBQ_OVL_DELAY</span>:
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_delay</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TC_CBQ_OVL_LOWPRIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">TC_CBQ_MAXPRIO</span> <span class="o">||</span>
		    <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_lowprio</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TC_CBQ_OVL_DROP</span>:
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_drop</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TC_CBQ_OVL_RCLASSIC</span>:
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_rclassic</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalty</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">penalty</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_set_police</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc_cbq_police</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">police</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">police</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">police</span> <span class="o">==</span> <span class="n">TC_POLICE_RECLASSIFY</span><span class="p">)</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">reshape_fail</span> <span class="o">=</span> <span class="n">cbq_reshape_fail</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">reshape_fail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_set_fopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc_cbq_fopt</span> <span class="o">*</span><span class="n">fopt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cbq_change_defmap</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">fopt</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">,</span> <span class="n">fopt</span><span class="o">-&gt;</span><span class="n">defmap</span><span class="p">,</span> <span class="n">fopt</span><span class="o">-&gt;</span><span class="n">defchange</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">cbq_policy</span><span class="p">[</span><span class="n">TCA_CBQ_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_cbq_lssopt</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_WRROPT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_cbq_wrropt</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_FOPT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_cbq_fopt</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_cbq_ovl</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_ratespec</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_RTAB</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NLA_BINARY</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">TC_RTAB_SIZE</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">TCA_CBQ_POLICE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc_cbq_police</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tc_ratespec</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">TCA_CBQ_MAX</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">cbq_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RTAB</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">R_tab</span> <span class="o">=</span> <span class="n">qdisc_get_rtab</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RTAB</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qdisc_class_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_rtab</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qdisc</span> <span class="o">=</span> <span class="n">sch</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_create_dflt</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfifo_qdisc_ops</span><span class="p">,</span>
				      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">q</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">priority2</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXPRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ovl_strategy</span> <span class="o">=</span> <span class="n">TC_CBQ_OVL_CLASSIC</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_classic</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">allot</span> <span class="o">=</span> <span class="n">psched_mtu</span><span class="p">(</span><span class="n">qdisc_dev</span><span class="p">(</span><span class="n">sch</span><span class="p">));</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">quantum</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">allot</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">R_tab</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ewma_log</span> <span class="o">=</span> <span class="n">TC_CBQ_DEF_EWMA</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">avpkt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">allot</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">minidle</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x7FFFFFFF</span><span class="p">;</span>

	<span class="n">qdisc_watchdog_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span> <span class="n">sch</span><span class="p">);</span>
	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">delay_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">cbq_undelay</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">TC_CBQ_MAXLEVEL</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">=</span> <span class="n">psched_get_time</span><span class="p">();</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">now_rt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="n">cbq_link_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">])</span>
		<span class="n">cbq_set_lss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">]));</span>

	<span class="n">cbq_addprio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">put_rtab:</span>
	<span class="n">qdisc_put_rtab</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">R_tab</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_RATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_lss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc_cbq_lssopt</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">opt</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCF_CBQ_LSS_BOUNDED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCF_CBQ_LSS_ISOLATED</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">ewma_log</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">avpkt</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">avpkt</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">maxidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">minidle</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">-</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span><span class="p">);</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">offtime</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">change</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_LSSOPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_wrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc_cbq_wrropt</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">opt</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">allot</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">allot</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">cpriority</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">cpriority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_WRROPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_ovl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc_cbq_ovl</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">opt</span><span class="p">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">ovl_strategy</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">priority2</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">priority2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opt</span><span class="p">.</span><span class="n">penalty</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">penalty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_fopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc_cbq_fopt</span> <span class="n">opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span> <span class="o">||</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">split</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span> <span class="o">?</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">defmap</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span><span class="p">;</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">defchange</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_FOPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_police</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc_cbq_police</span> <span class="n">opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">police</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">police</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">police</span><span class="p">;</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">__res1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">opt</span><span class="p">.</span><span class="n">__res2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_CBQ_POLICE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nlmsg_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbq_dump_lss</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">cbq_dump_rate</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">cbq_dump_wrr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">cbq_dump_ovl</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	    <span class="n">cbq_dump_police</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
<span class="cp">#endif</span>
	    <span class="n">cbq_dump_fopt</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_OPTIONS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbq_dump_attr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cbq_dump_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gnet_dump</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">xstats</span><span class="p">.</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">avgidle</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gnet_stats_copy_app</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">xstats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">xstats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cbq_dump_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcmsg</span> <span class="o">*</span><span class="n">tcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">)</span>
		<span class="n">tcm</span><span class="o">-&gt;</span><span class="n">tcm_parent</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tcm</span><span class="o">-&gt;</span><span class="n">tcm_parent</span> <span class="o">=</span> <span class="n">TC_H_ROOT</span><span class="p">;</span>
	<span class="n">tcm</span><span class="o">-&gt;</span><span class="n">tcm_handle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span><span class="p">;</span>
	<span class="n">tcm</span><span class="o">-&gt;</span><span class="n">tcm_info</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">nest</span> <span class="o">=</span> <span class="n">nla_nest_start</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_OPTIONS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbq_dump_attr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="n">nla_nest_end</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="n">nla_nest_cancel</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nest</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cbq_dump_class_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">gnet_dump</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">.</span><span class="n">qlen</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">avgidle</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">avgidle</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">undertime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">!=</span> <span class="n">PSCHED_PASTPERFECT</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">undertime</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">undertime</span> <span class="o">-</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gnet_stats_copy_basic</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">gnet_stats_copy_rate_est</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">rate_est</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">gnet_stats_copy_queue</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">qstats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gnet_stats_copy_app</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_graft</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">**</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">qdisc_create_dflt</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev_queue</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pfifo_qdisc_ops</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">police</span> <span class="o">==</span> <span class="n">TC_POLICE_RECLASSIFY</span><span class="p">)</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">reshape_fail</span> <span class="o">=</span> <span class="n">cbq_reshape_fail</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">sch_tree_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">qdisc_tree_decrease_qlen</span><span class="p">(</span><span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">old</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">);</span>
	<span class="n">qdisc_reset</span><span class="p">(</span><span class="o">*</span><span class="n">old</span><span class="p">);</span>
	<span class="n">sch_tree_unlock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="nf">cbq_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_qlen_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cbq_deactivate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cbq_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">classid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">classid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_destroy_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">);</span>

	<span class="n">tcf_destroy_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">filter_list</span><span class="p">);</span>
	<span class="n">qdisc_destroy</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">qdisc_put_rtab</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span><span class="p">);</span>
	<span class="n">gen_kill_estimator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">rate_est</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Filters must be destroyed first because we don&#39;t destroy the</span>
<span class="cm">	 * classes from root to leafs which means that filters can still</span>
<span class="cm">	 * be bound to classes which have been destroyed already. --TGR &#39;04</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span>
			<span class="n">tcf_destroy_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">filter_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
					  <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span>
			<span class="n">cbq_destroy_class</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qdisc_class_hash_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
		<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">root_lock</span> <span class="o">=</span> <span class="n">qdisc_root_sleeping_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="n">root_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">==</span> <span class="n">cl</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="n">root_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">cbq_destroy_class</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cbq_change_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">classid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">parentid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">**</span><span class="n">tca</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="n">tca</span><span class="p">[</span><span class="n">TCA_OPTIONS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdisc_rate_table</span> <span class="o">*</span><span class="n">rtab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse_nested</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">TCA_CBQ_MAX</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">cbq_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check parent */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parentid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">!=</span> <span class="n">parentid</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span> <span class="o">&amp;&amp;</span> <span class="n">parentid</span> <span class="o">!=</span> <span class="n">TC_H_ROOT</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rtab</span> <span class="o">=</span> <span class="n">qdisc_get_rtab</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]),</span>
					      <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RTAB</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="n">TCA_RATE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">gen_replace_estimator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">rate_est</span><span class="p">,</span>
						    <span class="n">qdisc_root_sleeping_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">),</span>
						    <span class="n">tca</span><span class="p">[</span><span class="n">TCA_RATE</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rtab</span><span class="p">)</span>
					<span class="n">qdisc_put_rtab</span><span class="p">(</span><span class="n">rtab</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Change class parameters */</span>
		<span class="n">sch_tree_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">cbq_deactivate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdisc_put_rtab</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span><span class="p">);</span>
			<span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span> <span class="o">=</span> <span class="n">rtab</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">])</span>
			<span class="n">cbq_set_lss</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_WRROPT</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cbq_rmprio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
			<span class="n">cbq_set_wrr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_WRROPT</span><span class="p">]));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">])</span>
			<span class="n">cbq_set_overlimit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">]));</span>

<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_POLICE</span><span class="p">])</span>
			<span class="n">cbq_set_police</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_POLICE</span><span class="p">]));</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_FOPT</span><span class="p">])</span>
			<span class="n">cbq_set_fopt</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_FOPT</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
			<span class="n">cbq_activate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

		<span class="n">sch_tree_unlock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parentid</span> <span class="o">==</span> <span class="n">TC_H_ROOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_WRROPT</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtab</span> <span class="o">=</span> <span class="n">qdisc_get_rtab</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RATE</span><span class="p">]),</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_RTAB</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">classid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TC_H_MAJ</span><span class="p">(</span><span class="n">classid</span> <span class="o">^</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">classid</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">classid</span> <span class="o">=</span> <span class="n">TC_H_MAKE</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">hgenerator</span> <span class="o">&gt;=</span> <span class="mh">0x8000</span><span class="p">)</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">hgenerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">classid</span><span class="o">|</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">hgenerator</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="n">classid</span> <span class="o">=</span> <span class="n">classid</span><span class="o">|</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">hgenerator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parentid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">parentid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="n">TCA_RATE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gen_new_estimator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">bstats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">rate_est</span><span class="p">,</span>
					<span class="n">qdisc_root_sleeping_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">),</span>
					<span class="n">tca</span><span class="p">[</span><span class="n">TCA_RATE</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span> <span class="o">=</span> <span class="n">rtab</span><span class="p">;</span>
	<span class="n">rtab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_create_dflt</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfifo_qdisc_ops</span><span class="p">,</span> <span class="n">classid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">noop_qdisc</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">classid</span> <span class="o">=</span> <span class="n">classid</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">qdisc</span> <span class="o">=</span> <span class="n">sch</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">allot</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">allot</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">quantum</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">allot</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">weight</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">R_tab</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>

	<span class="n">sch_tree_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="n">cbq_link_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">borrow</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">share</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">;</span>
	<span class="n">cbq_adjust_levels</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">minidle</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x7FFFFFFF</span><span class="p">;</span>
	<span class="n">cbq_set_lss</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_LSSOPT</span><span class="p">]));</span>
	<span class="n">cbq_set_wrr</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_WRROPT</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">ewma_log</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ewma_log</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">maxidle</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">maxidle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">avpkt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">avpkt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">avpkt</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">overlimit</span> <span class="o">=</span> <span class="n">cbq_ovl_classic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">])</span>
		<span class="n">cbq_set_overlimit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_OVL_STRATEGY</span><span class="p">]));</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_POLICE</span><span class="p">])</span>
		<span class="n">cbq_set_police</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_POLICE</span><span class="p">]));</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_FOPT</span><span class="p">])</span>
		<span class="n">cbq_set_fopt</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_CBQ_FOPT</span><span class="p">]));</span>
	<span class="n">sch_tree_unlock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">qdisc_class_hash_grow</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">);</span>

	<span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failure:</span>
	<span class="n">qdisc_put_rtab</span><span class="p">(</span><span class="n">rtab</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbq_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">filters</span> <span class="o">||</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">||</span> <span class="n">cl</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">sch_tree_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">qlen</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
	<span class="n">qdisc_reset</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">qdisc_tree_decrease_qlen</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">qlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">next_alive</span><span class="p">)</span>
		<span class="n">cbq_deactivate_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span> <span class="o">==</span> <span class="n">cl</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span> <span class="o">==</span> <span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">tx_borrowed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_NET_CLS_ACT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">==</span> <span class="n">cl</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">rx_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cbq_unlink_class</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
	<span class="n">cbq_adjust_levels</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">tparent</span><span class="p">);</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">defmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cbq_sync_defmap</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

	<span class="n">cbq_rmprio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
	<span class="n">sch_tree_unlock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">--</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This shouldn&#39;t happen: we &quot;hold&quot; one cops-&gt;get() when called</span>
<span class="cm">	 * from tc_ctl_tclass; the destroy method is done from cops-&gt;put().</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tcf_proto</span> <span class="o">**</span><span class="nf">cbq_find_tcf</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">filter_list</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cbq_bind_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">classid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">cbq_class_lookup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">classid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cl</span><span class="o">-&gt;</span><span class="n">filters</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_unbind_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">filters</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbq_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">Qdisc</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qdisc_walker</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbq_sched_data</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qdisc_priv</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbq_class</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hashsize</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">clhash</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">common</span><span class="p">.</span><span class="n">hnode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cl</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arg</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">Qdisc_class_ops</span> <span class="n">cbq_class_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">graft</span>		<span class="o">=</span>	<span class="n">cbq_graft</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leaf</span>		<span class="o">=</span>	<span class="n">cbq_leaf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qlen_notify</span>	<span class="o">=</span>	<span class="n">cbq_qlen_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span>	<span class="n">cbq_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>		<span class="o">=</span>	<span class="n">cbq_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change</span>		<span class="o">=</span>	<span class="n">cbq_change_class</span><span class="p">,</span>
	<span class="p">.</span><span class="n">delete</span>		<span class="o">=</span>	<span class="n">cbq_delete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">walk</span>		<span class="o">=</span>	<span class="n">cbq_walk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tcf_chain</span>	<span class="o">=</span>	<span class="n">cbq_find_tcf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_tcf</span>	<span class="o">=</span>	<span class="n">cbq_bind_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind_tcf</span>	<span class="o">=</span>	<span class="n">cbq_unbind_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump</span>		<span class="o">=</span>	<span class="n">cbq_dump_class</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_stats</span>	<span class="o">=</span>	<span class="n">cbq_dump_class_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Qdisc_ops</span> <span class="n">cbq_qdisc_ops</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">next</span>		<span class="o">=</span>	<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cl_ops</span>		<span class="o">=</span>	<span class="o">&amp;</span><span class="n">cbq_class_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span>	<span class="s">&quot;cbq&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priv_size</span>	<span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbq_sched_data</span><span class="p">),</span>
	<span class="p">.</span><span class="n">enqueue</span>	<span class="o">=</span>	<span class="n">cbq_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span>	<span class="n">cbq_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peek</span>		<span class="o">=</span>	<span class="n">qdisc_peek_dequeued</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop</span>		<span class="o">=</span>	<span class="n">cbq_drop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span>	<span class="n">cbq_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span>	<span class="n">cbq_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span>	<span class="n">cbq_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change</span>		<span class="o">=</span>	<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump</span>		<span class="o">=</span>	<span class="n">cbq_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_stats</span>	<span class="o">=</span>	<span class="n">cbq_dump_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cbq_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_qdisc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cbq_qdisc_ops</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cbq_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_qdisc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cbq_qdisc_ops</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">cbq_module_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cbq_module_exit</span><span class="p">)</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
