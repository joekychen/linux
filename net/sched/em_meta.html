<!DOCTYPE html>
<html><head><title>joekychen/linux » net › sched › em_meta.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>em_meta.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/sched/em_meta.c	Metadata ematch</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Thomas Graf &lt;tgraf@suug.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * ==========================================================================</span>
<span class="cm"> *</span>
<span class="cm"> * 	The metadata ematch compares two meta objects where each object</span>
<span class="cm"> * 	represents either a meta value stored in the kernel or a static</span>
<span class="cm"> * 	value provided by userspace. The objects are not provided by</span>
<span class="cm"> * 	userspace itself but rather a definition providing the information</span>
<span class="cm"> * 	to build them. Every object is of a certain type which must be</span>
<span class="cm"> * 	equal to the object it is being compared to.</span>
<span class="cm"> *</span>
<span class="cm"> * 	The definition of a objects conists of the type (meta type), a</span>
<span class="cm"> * 	identifier (meta id) and additional type specific information.</span>
<span class="cm"> * 	The meta id is either TCF_META_TYPE_VALUE for values provided by</span>
<span class="cm"> * 	userspace or a index to the meta operations table consisting of</span>
<span class="cm"> * 	function pointers to type specific meta data collectors returning</span>
<span class="cm"> * 	the value of the requested meta value.</span>
<span class="cm"> *</span>
<span class="cm"> * 	         lvalue                                   rvalue</span>
<span class="cm"> * 	      +-----------+                           +-----------+</span>
<span class="cm"> * 	      | type: INT |                           | type: INT |</span>
<span class="cm"> * 	 def  | id: DEV   |                           | id: VALUE |</span>
<span class="cm"> * 	      | data:     |                           | data: 3   |</span>
<span class="cm"> * 	      +-----------+                           +-----------+</span>
<span class="cm"> * 	            |                                       |</span>
<span class="cm"> * 	            ---&gt; meta_ops[INT][DEV](...)            |</span>
<span class="cm"> *	                      |                             |</span>
<span class="cm"> * 	            -----------                             |</span>
<span class="cm"> * 	            V                                       V</span>
<span class="cm"> * 	      +-----------+                           +-----------+</span>
<span class="cm"> * 	      | type: INT |                           | type: INT |</span>
<span class="cm"> * 	 obj  | id: DEV |                             | id: VALUE |</span>
<span class="cm"> * 	      | data: 2   |&lt;--data got filled out     | data: 3   |</span>
<span class="cm"> * 	      +-----------+                           +-----------+</span>
<span class="cm"> * 	            |                                         |</span>
<span class="cm"> * 	            --------------&gt; 2  equals 3 &lt;--------------</span>
<span class="cm"> *</span>
<span class="cm"> * 	This is a simplified schema, the complexity varies depending</span>
<span class="cm"> * 	on the meta type. Obviously, the length of the data must also</span>
<span class="cm"> * 	be provided for non-numeric types.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Additionally, type dependent modifiers such as shift operators</span>
<span class="cm"> * 	or mask may be applied to extend the functionaliy. As of now,</span>
<span class="cm"> * 	the variable length type supports shifting the byte string to</span>
<span class="cm"> * 	the right, eating up any number of octets and thus supporting</span>
<span class="cm"> * 	wildcard interface name comparisons such as &quot;ppp%&quot; matching</span>
<span class="cm"> * 	ppp0..9.</span>
<span class="cm"> *</span>
<span class="cm"> * 	NOTE: Certain meta values depend on other subsystems and are</span>
<span class="cm"> * 	      only available if that subsystem is enabled in the kernel.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/tc_ematch/tc_em_meta.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/pkt_cls.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="k">struct</span> <span class="n">meta_obj</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">meta_value</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tcf_meta_val</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">meta_match</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">meta_value</span>	<span class="n">lvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">meta_value</span>	<span class="n">rvalue</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">meta_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TCF_META_ID</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">kind</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">meta_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TCF_META_TYPE</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">kind</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define META_COLLECTOR(FUNC) static void meta_##FUNC(struct sk_buff *skb, \</span>
<span class="cp">	struct tcf_pkt_info *info, struct meta_value *v, \</span>
<span class="cp">	struct meta_obj *dst, int *err)</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * System status &amp; misc</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_random</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fixed_loadavg</span><span class="p">(</span><span class="kt">int</span> <span class="n">load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rnd_load</span> <span class="o">=</span> <span class="n">load</span> <span class="o">+</span> <span class="p">(</span><span class="n">FIXED_1</span><span class="o">/</span><span class="mi">200</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rnd_frac</span> <span class="o">=</span> <span class="p">((</span><span class="n">rnd_load</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIXED_1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FSHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">rnd_load</span> <span class="o">&gt;&gt;</span> <span class="n">FSHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="n">rnd_frac</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_loadavg_0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">fixed_loadavg</span><span class="p">(</span><span class="n">avenrun</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_loadavg_1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">fixed_loadavg</span><span class="p">(</span><span class="n">avenrun</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_loadavg_2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">fixed_loadavg</span><span class="p">(</span><span class="n">avenrun</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Device names &amp; indices</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">int_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">var_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">int_dev</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">var_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">var_dev</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * vlan tag</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_vlan_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span> <span class="o">&amp;&amp;</span> <span class="n">__vlan_get_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * skb attributes</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Let userspace take care of the byte ordering */</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_pkttype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_pktlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_maclen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_rxhash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb_get_rxhash</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Netfilter</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_mark</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Traffic Control</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_tcindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tc_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Routing</span>
<span class="cm"> **************************************************************************/</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_rtclassid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tclassid</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_rtiif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb_rtable</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rt_iif</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Socket Attributes</span>
<span class="cm"> **************************************************************************/</span>

<span class="cp">#define SKIP_NONLOCAL(skb)			\</span>
<span class="cp">	if (unlikely(skb-&gt;sk == NULL)) {	\</span>
<span class="cp">		*err = -1;			\</span>
<span class="cp">		return;				\</span>
<span class="cp">	}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_reuse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuse</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_bound_if</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="cm">/* No error if bound_dev_if is 0, legal userspace check */</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">var_sk_bound_if</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;any&quot;</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">),</span>
					   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_bound_dev_if</span><span class="p">);</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">var_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_refcnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_rcvbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_shutdown</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_rmem_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">sk_rmem_alloc_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_wmem_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_omem_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_rcv_qlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_snd_qlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_wmem_queued</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_queued</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_fwd_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_forward_alloc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_sndbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_lingertime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_lingertime</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_err_qlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_ack_bl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_max_ack_bl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_rcvlowat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvlowat</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_rcvtimeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_sndtimeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_sendmsg_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndmsg_off</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">META_COLLECTOR</span><span class="p">(</span><span class="n">int_sk_write_pend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SKIP_NONLOCAL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Meta value collectors assignment table</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">struct</span> <span class="n">meta_ops</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcf_pkt_info</span> <span class="o">*</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define META_ID(name) TCF_META_ID_##name</span>
<span class="cp">#define META_FUNC(name) { .get = meta_##name }</span>

<span class="cm">/* Meta value operations table listing all meta value collectors and</span>
<span class="cm"> * assigns them to a type and meta id. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">meta_ops</span> <span class="n">__meta_ops</span><span class="p">[</span><span class="n">TCF_META_TYPE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">TCF_META_ID_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TCF_META_TYPE_VAR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">DEV</span><span class="p">)]</span>			<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">var_dev</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_BOUND_IF</span><span class="p">)]</span> 		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">var_sk_bound_if</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">TCF_META_TYPE_INT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_random</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">LOADAVG_0</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_loadavg_0</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">LOADAVG_1</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_loadavg_1</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">LOADAVG_2</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_loadavg_2</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">DEV</span><span class="p">)]</span>			<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_dev</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">PRIORITY</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_priority</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">PROTOCOL</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_protocol</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">PKTTYPE</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_pkttype</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">PKTLEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_pktlen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">DATALEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_datalen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">MACLEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_maclen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">NFMARK</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_mark</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">TCINDEX</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_tcindex</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">RTCLASSID</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_rtclassid</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">RTIIF</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_rtiif</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_FAMILY</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_family</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_STATE</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_state</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_REUSE</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_reuse</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_BOUND_IF</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_bound_if</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_REFCNT</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_refcnt</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_RCVBUF</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_rcvbuf</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_SNDBUF</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_sndbuf</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_SHUTDOWN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_shutdown</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_PROTO</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_proto</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_TYPE</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_type</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_RMEM_ALLOC</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_rmem_alloc</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_WMEM_ALLOC</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_wmem_alloc</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_OMEM_ALLOC</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_omem_alloc</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_WMEM_QUEUED</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_wmem_queued</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_RCV_QLEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_rcv_qlen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_SND_QLEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_snd_qlen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_ERR_QLEN</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_err_qlen</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_FORWARD_ALLOCS</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_fwd_alloc</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_ALLOCS</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_alloc</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_HASH</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_hash</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_LINGERTIME</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_lingertime</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_ACK_BACKLOG</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_ack_bl</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_MAX_ACK_BACKLOG</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_max_ack_bl</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_PRIO</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_prio</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_RCVLOWAT</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_rcvlowat</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_RCVTIMEO</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_rcvtimeo</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_SNDTIMEO</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_sndtimeo</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_SENDMSG_OFF</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_sendmsg_off</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">SK_WRITE_PENDING</span><span class="p">)]</span>	<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_sk_write_pend</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">VLAN_TAG</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_vlan_tag</span><span class="p">),</span>
		<span class="p">[</span><span class="n">META_ID</span><span class="p">(</span><span class="n">RXHASH</span><span class="p">)]</span>		<span class="o">=</span> <span class="n">META_FUNC</span><span class="p">(</span><span class="n">int_rxhash</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">meta_ops</span> <span class="o">*</span><span class="nf">meta_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">__meta_ops</span><span class="p">[</span><span class="n">meta_type</span><span class="p">(</span><span class="n">val</span><span class="p">)][</span><span class="n">meta_id</span><span class="p">(</span><span class="n">val</span><span class="p">)];</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Type specific operations for TCF_META_TYPE_VAR</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_var_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_var_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">kmemdup</span><span class="p">(</span><span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meta_var_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meta_var_apply_extras</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&amp;&amp;</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_var_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlv</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Type specific operations for TCF_META_TYPE_INT</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_int_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Let gcc optimize it, the unlikely is not really based on</span>
<span class="cm">	 * some numbers but jump free code for mismatches seems</span>
<span class="cm">	 * more logical. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_int_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">nla_get_u32</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meta_int_apply_extras</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">shift</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_int_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_put_u32</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlv</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Type specific operations table</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">struct</span> <span class="n">meta_type_ops</span> <span class="p">{</span>
	<span class="kt">void</span>	<span class="p">(</span><span class="o">*</span><span class="n">destroy</span><span class="p">)(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">compare</span><span class="p">)(</span><span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">change</span><span class="p">)(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>	<span class="p">(</span><span class="o">*</span><span class="n">apply_extras</span><span class="p">)(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">dump</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">meta_type_ops</span> <span class="n">__meta_type_ops</span><span class="p">[</span><span class="n">TCF_META_TYPE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TCF_META_TYPE_VAR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">meta_var_destroy</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compare</span> <span class="o">=</span> <span class="n">meta_var_compare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">change</span> <span class="o">=</span> <span class="n">meta_var_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">apply_extras</span> <span class="o">=</span> <span class="n">meta_var_apply_extras</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">meta_var_dump</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">TCF_META_TYPE_INT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">compare</span> <span class="o">=</span> <span class="n">meta_int_compare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">change</span> <span class="o">=</span> <span class="n">meta_int_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">apply_extras</span> <span class="o">=</span> <span class="n">meta_int_apply_extras</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">meta_int_dump</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">meta_type_ops</span> <span class="o">*</span><span class="nf">meta_type_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">__meta_type_ops</span><span class="p">[</span><span class="n">meta_type</span><span class="p">(</span><span class="n">v</span><span class="p">)];</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Core</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meta_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcf_pkt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">meta_obj</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta_id</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">TCF_META_ID_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">meta_ops</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta_type_ops</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">apply_extras</span><span class="p">)</span>
		<span class="n">meta_type_ops</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">apply_extras</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_meta_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcf_ematch</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">tcf_pkt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">meta_obj</span> <span class="n">l_value</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta_get</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">meta_get</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">meta_type_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_value</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCF_EM_OPND_EQ</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">r</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCF_EM_OPND_LT</span>:
		<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCF_EM_OPND_GT</span>:
		<span class="k">return</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meta_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="n">meta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">meta_type_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">meta_type_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">);</span>
			<span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">meta_change_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla_len</span><span class="p">(</span><span class="n">nla</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">meta_type_ops</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">change</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">nla</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">meta_is_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">meta_value</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">meta_id</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="n">meta_ops</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nla_policy</span> <span class="n">meta_policy</span><span class="p">[</span><span class="n">TCA_EM_META_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TCA_EM_META_HDR</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcf_meta_hdr</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_meta_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcf_proto</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">tcf_ematch</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_EM_META_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tcf_meta_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="n">meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nla_parse</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">TCA_EM_META_MAX</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">meta_policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_EM_META_HDR</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">TCA_EM_META_HDR</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TCF_META_TYPE</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TCF_META_TYPE</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">TCF_META_TYPE</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TCF_META_TYPE_MAX</span> <span class="o">||</span>
	    <span class="n">TCF_META_ID</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TCF_META_ID_MAX</span> <span class="o">||</span>
	    <span class="n">TCF_META_ID</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TCF_META_ID_MAX</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">meta</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meta_is_supported</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">meta_is_supported</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta_change_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_EM_META_LVALUE</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">meta_change_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">TCA_EM_META_RVALUE</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">meta</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">errout:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="p">)</span>
		<span class="n">meta_delete</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">em_meta_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcf_proto</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcf_ematch</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>
		<span class="n">meta_delete</span><span class="p">((</span><span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_meta_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcf_ematch</span> <span class="o">*</span><span class="n">em</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">meta_match</span> <span class="o">*</span><span class="p">)</span> <span class="n">em</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcf_meta_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">meta_type_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">left</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">right</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nla_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TCA_EM_META_HDR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">meta_type_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">TCA_EM_META_LVALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">rvalue</span><span class="p">,</span> <span class="n">TCA_EM_META_RVALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">nla_put_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tcf_ematch_ops</span> <span class="n">em_meta_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">kind</span>	  <span class="o">=</span> <span class="n">TCF_EM_META</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change</span>	  <span class="o">=</span> <span class="n">em_meta_change</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>	  <span class="o">=</span> <span class="n">em_meta_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>  <span class="o">=</span> <span class="n">em_meta_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump</span>	  <span class="o">=</span> <span class="n">em_meta_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link</span>	  <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">em_meta_ops</span><span class="p">.</span><span class="n">link</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_em_meta</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tcf_em_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_meta_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_em_meta</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcf_em_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em_meta_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_em_meta</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_em_meta</span><span class="p">);</span>

<span class="n">MODULE_ALIAS_TCF_EMATCH</span><span class="p">(</span><span class="n">TCF_EM_META</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
