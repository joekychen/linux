<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv6 › ip6_fib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ip6_fib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Linux INET6 implementation</span>
<span class="cm"> *	Forwarding Information Database</span>
<span class="cm"> *</span>
<span class="cm"> *	Authors:</span>
<span class="cm"> *	Pedro Roque		&lt;roque@di.fc.ul.pt&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 	Changes:</span>
<span class="cm"> * 	Yuji SEKIYA @USAGI:	Support default route on router node;</span>
<span class="cm"> * 				remove ip6_null_entry from the top of</span>
<span class="cm"> * 				routing table.</span>
<span class="cm"> * 	Ville Nuorvala:		Fixed routing subtrees.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;IPv6: &quot; fmt</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/ndisc.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>

<span class="cp">#include &lt;net/ip6_fib.h&gt;</span>
<span class="cp">#include &lt;net/ip6_route.h&gt;</span>

<span class="cp">#define RT6_DEBUG 2</span>

<span class="cp">#if RT6_DEBUG &gt;= 3</span>
<span class="cp">#define RT6_TRACE(x...) pr_debug(x)</span>
<span class="cp">#else</span>
<span class="cp">#define RT6_TRACE(x...) do { ; } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span> <span class="n">fib6_node_kmem</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">fib_walk_state_t</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
	<span class="n">FWS_S</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="n">FWS_L</span><span class="p">,</span>
	<span class="n">FWS_R</span><span class="p">,</span>
	<span class="n">FWS_C</span><span class="p">,</span>
	<span class="n">FWS_U</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fib6_cleaner_t</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">fib6_walker_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
<span class="cp">#define FWS_INIT FWS_S</span>
<span class="cp">#else</span>
<span class="cp">#define FWS_INIT FWS_L</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fib6_prune_clones</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">fib6_find_prefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fib6_repair_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fib6_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fib6_walk_continue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	A routing update causes an increase of the serial number on the</span>
<span class="cm"> *	affected subtree. This allows for cached routes to be asynchronously</span>
<span class="cm"> *	tested when modifications are made to the destination cache as a</span>
<span class="cm"> *	result of redirects, path MTU changes, etc.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__u32</span> <span class="n">rt_sernum</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fib6_gc_timer_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fib6_walkers</span><span class="p">);</span>
<span class="cp">#define FOR_WALKERS(w) list_for_each_entry(w, &amp;fib6_walkers, lh)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fib6_walker_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fib6_walkers</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fib6_walker_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">lh</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="n">u32</span> <span class="nf">fib6_new_sernum</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">n</span> <span class="o">=</span> <span class="o">++</span><span class="n">rt_sernum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">__s32</span><span class="p">)</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rt_sernum</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Auxiliary address test functions for the radix tree.</span>
<span class="cm"> *</span>
<span class="cm"> *	These assume a 32bit processor (although it will work on</span>
<span class="cm"> *	64bit processors)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	test bit</span>
<span class="cm"> */</span>
<span class="cp">#if defined(__LITTLE_ENDIAN)</span>
<span class="cp"># define BITOP_BE32_SWIZZLE	(0x1F &amp; ~7)</span>
<span class="cp">#else</span>
<span class="cp"># define BITOP_BE32_SWIZZLE	0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="n">__be32</span> <span class="nf">addr_bit_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fn_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Here,</span>
<span class="cm">	 * 	1 &lt;&lt; ((~fn_bit ^ BITOP_BE32_SWIZZLE) &amp; 0x1f)</span>
<span class="cm">	 * is optimized version of</span>
<span class="cm">	 *	htonl(1 &lt;&lt; ((~fn_bit)&amp;0x1F))</span>
<span class="cm">	 * See include/asm-generic/bitops/le.h.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be32</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="o">~</span><span class="n">fn_bit</span> <span class="o">^</span> <span class="n">BITOP_BE32_SWIZZLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span> <span class="o">&amp;</span>
	       <span class="n">addr</span><span class="p">[</span><span class="n">fn_bit</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">node_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">fib6_node_kmem</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">node_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">fib6_node_kmem</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">rt6_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">))</span>
		<span class="n">dst_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_link_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize table lock at a single place to give lockdep a key,</span>
<span class="cm">	 * tables aren&#39;t visible prior to being linked to the list.</span>
<span class="cm">	 */</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb6_id</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIB6_TABLE_HASHSZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No protection necessary, this is the only list mutatation</span>
<span class="cm">	 * operation, tables never disappear once they exist.</span>
<span class="cm">	 */</span>
	<span class="n">hlist_add_head_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb6_hlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">[</span><span class="n">h</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPV6_MULTIPLE_TABLES</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="nf">fib6_alloc_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
		<span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">fn_flags</span> <span class="o">=</span> <span class="n">RTN_ROOT</span> <span class="o">|</span> <span class="n">RTN_TL_ROOT</span> <span class="o">|</span> <span class="n">RTN_RTINFO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="nf">fib6_new_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">RT6_TABLE_MAIN</span><span class="p">;</span>
	<span class="n">tb</span> <span class="o">=</span> <span class="n">fib6_get_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">fib6_alloc_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="p">)</span>
		<span class="n">fib6_link_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">tb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="nf">fib6_get_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">RT6_TABLE_MAIN</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIB6_TABLE_HASHSZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
	<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tb6_hlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb6_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_init</span> <span class="nf">fib6_tables_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fib6_link_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">);</span>
	<span class="n">fib6_link_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="nf">fib6_new_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fib6_get_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="nf">fib6_get_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	  <span class="k">return</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">fib6_rule_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">flowi6</span> <span class="o">*</span><span class="n">fl6</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pol_lookup_t</span> <span class="n">lookup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">,</span> <span class="n">fl6</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_init</span> <span class="nf">fib6_tables_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fib6_link_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_dump_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rt</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span> <span class="n">rt</span><span class="p">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">rt6_dump_route</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Frame is full, suspend walking */</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_dump_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fib6_walker_unlink</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_dump_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fib6_dump_end</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">?</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_dump_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">fib6_walk</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fn_sernum</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fn_sernum</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Begin at the root if the tree changed */</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">fn_sernum</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_INIT</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">skip</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">fib6_walk_continue</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fib6_walker_unlink</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet6_dump_fib</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="n">s_h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s_e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_rtnl_dump_arg</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s_h</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">s_e</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* New dump:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 1. hook callback destructor.</span>
<span class="cm">		 */</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">fib6_dump_done</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * 2. allocate and initialize walker.</span>
<span class="cm">		 */</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">fib6_dump_node</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">w</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arg</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">s_h</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">FIB6_TABLE_HASHSZ</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">,</span> <span class="n">s_e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
		<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tb6_hlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">s_e</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">fib6_dump_table</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">next:</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fib6_dump_end</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Routing Table</span>
<span class="cm"> *</span>
<span class="cm"> *	return the appropriate node for a routing tree &quot;add&quot; operation</span>
<span class="cm"> *	by either creating and inserting or by returning an existing</span>
<span class="cm"> *	node.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">fib6_add_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allow_create</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">replace_required</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">bit</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">sernum</span> <span class="o">=</span> <span class="n">fib6_new_sernum</span><span class="p">();</span>

	<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;fib6_add_1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* insert node in tree */</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Prefix match</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ipv6_prefix_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_create</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">replace_required</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Can&#39;t replace route, no match found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NLM_F_CREATE should be set when creating new route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">insert_above</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Exact match ?</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">==</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clean up an intermediate node */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rt6_release</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">);</span>
				<span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	We have more bits to go</span>
<span class="cm">		 */</span>

		<span class="cm">/* Try to walk down on tree. */</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">addr_bit_set</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">);</span>
		<span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">:</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">fn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_create</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We should not create new node because</span>
<span class="cm">		 * NLM_F_REPLACE was specified without NLM_F_CREATE</span>
<span class="cm">		 * I assume it is safe to require NLM_F_CREATE when</span>
<span class="cm">		 * REPLACE flag is used! Later we may want to remove the</span>
<span class="cm">		 * check for replace_required, because according</span>
<span class="cm">		 * to netlink specification, NLM_F_CREATE</span>
<span class="cm">		 * MUST be specified if new route is created.</span>
<span class="cm">		 * That would keep IPv6 consistent with IPv4</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">replace_required</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Can&#39;t replace route, no match found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NLM_F_CREATE should be set when creating new route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *	We walked to the bottom of tree.</span>
<span class="cm">	 *	Create new leaf node without children.</span>
<span class="cm">	 */</span>

	<span class="n">ln</span> <span class="o">=</span> <span class="n">node_alloc</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ln</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">ln</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
	<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ln</span><span class="p">;</span>


<span class="nl">insert_above:</span>
	<span class="cm">/*</span>
<span class="cm">	 * split since we don&#39;t have a common prefix anymore or</span>
<span class="cm">	 * we have a less significant route.</span>
<span class="cm">	 * we&#39;ve to insert an intermediate node on the list</span>
<span class="cm">	 * this new node will point to the one we need to create</span>
<span class="cm">	 * and the current</span>
<span class="cm">	 */</span>

	<span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* find 1st bit in difference between the 2 addrs.</span>

<span class="cm">	   See comment in __ipv6_addr_diff: bit may be an invalid value,</span>
<span class="cm">	   but if it is &gt;= plen, the value is ignored in any case.</span>
<span class="cm">	 */</span>

	<span class="n">bit</span> <span class="o">=</span> <span class="n">__ipv6_addr_diff</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *		(intermediate)[in]</span>
<span class="cm">	 *	          /	   \</span>
<span class="cm">	 *	(new leaf node)[ln] (old node)[fn]</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in</span> <span class="o">=</span> <span class="n">node_alloc</span><span class="p">();</span>
		<span class="n">ln</span> <span class="o">=</span> <span class="n">node_alloc</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span> <span class="o">||</span> <span class="o">!</span><span class="n">ln</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span>
				<span class="n">node_free</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ln</span><span class="p">)</span>
				<span class="n">node_free</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * new intermediate node.</span>
<span class="cm">		 * RTN_RTINFO will</span>
<span class="cm">		 * be off since that an address that chooses one of</span>
<span class="cm">		 * the branches would not match less specific routes</span>
<span class="cm">		 * in the other branch</span>
<span class="cm">		 */</span>

		<span class="n">in</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>

		<span class="n">in</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
		<span class="n">in</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>

		<span class="n">in</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>

		<span class="cm">/* update parent pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">in</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr_bit_set</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">in</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>
			<span class="n">in</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">in</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>
			<span class="n">in</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* plen &lt;= bit */</span>

		<span class="cm">/*</span>
<span class="cm">		 *		(new leaf node)[ln]</span>
<span class="cm">		 *	          /	   \</span>
<span class="cm">		 *	     (old node)[fn] NULL</span>
<span class="cm">		 */</span>

		<span class="n">ln</span> <span class="o">=</span> <span class="n">node_alloc</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ln</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>

		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">sernum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr_bit_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">plen</span><span class="p">))</span>
			<span class="n">ln</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ln</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>

		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ln</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ln</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Insert routing information in a node.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_add_rt2node</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">**</span><span class="n">ins</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">replace</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_REPLACE</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">add</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_CREATE</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span> <span class="n">iter</span><span class="p">;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Search for duplicates</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">rt6i_metric</span> <span class="o">==</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_metric</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *	Same priority level</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_EXCL</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">replace</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">rt6i_idev</span> <span class="o">==</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_idev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_EXPIRES</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_EXPIRES</span><span class="p">))</span>
					<span class="n">rt6_clean_expires</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">rt6_set_expires</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">expires</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">rt6i_metric</span> <span class="o">&gt;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_metric</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset round-robin state, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ins</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">rr_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	insert node</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">replace</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NLM_F_CREATE should be set when creating new route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">add:</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_node</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
		<span class="n">inet6_rt_notify</span><span class="p">(</span><span class="n">RTM_NEWROUTE</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_rt_entries</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_route_nodes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">|=</span> <span class="n">RTN_RTINFO</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">add</span><span class="p">;</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;NLM_F_REPLACE set, but no existing node found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_node</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
		<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
		<span class="n">inet6_rt_notify</span><span class="p">(</span><span class="n">RTM_NEWROUTE</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">rt6_release</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_route_nodes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">|=</span> <span class="n">RTN_RTINFO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">fib6_start_gc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTF_EXPIRES</span> <span class="o">|</span> <span class="n">RTF_CACHE</span><span class="p">)))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">sysctl</span><span class="p">.</span><span class="n">ip6_rt_gc_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fib6_force_start_gc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">sysctl</span><span class="p">.</span><span class="n">ip6_rt_gc_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Add routing information to the routing tree.</span>
<span class="cm"> *	&lt;destination addr&gt;/&lt;source addr&gt;</span>
<span class="cm"> *	with source addr info in sub-trees</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">fib6_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allow_create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">replace_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_CREATE</span><span class="p">))</span>
			<span class="n">allow_create</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nlh</span><span class="o">-&gt;</span><span class="n">nlmsg_flags</span> <span class="o">&amp;</span> <span class="n">NLM_F_REPLACE</span><span class="p">)</span>
			<span class="n">replace_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_create</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">replace_required</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;RTM_NEWROUTE with no NLM_F_CREATE or NLM_F_REPLACE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_add_1</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_dst</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">),</span>
			<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_dst</span><span class="p">.</span><span class="n">plen</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_dst</span><span class="p">),</span>
			<span class="n">allow_create</span><span class="p">,</span> <span class="n">replace_required</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">plen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">sn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">sfn</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Create subtree.</span>
<span class="cm">			 *</span>
<span class="cm">			 *		fn[main tree]</span>
<span class="cm">			 *		|</span>
<span class="cm">			 *		sfn[subtree root]</span>
<span class="cm">			 *		   \</span>
<span class="cm">			 *		    sn[new leaf node]</span>
<span class="cm">			 */</span>

			<span class="cm">/* Create subtree root node */</span>
			<span class="n">sfn</span> <span class="o">=</span> <span class="n">node_alloc</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfn</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">st_failure</span><span class="p">;</span>

			<span class="n">sfn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
			<span class="n">sfn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">=</span> <span class="n">RTN_ROOT</span><span class="p">;</span>
			<span class="n">sfn</span><span class="o">-&gt;</span><span class="n">fn_sernum</span> <span class="o">=</span> <span class="n">fib6_new_sernum</span><span class="p">();</span>

			<span class="cm">/* Now add the first leaf node to new subtree */</span>

			<span class="n">sn</span> <span class="o">=</span> <span class="n">fib6_add_1</span><span class="p">(</span><span class="n">sfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">),</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">plen</span><span class="p">,</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_src</span><span class="p">),</span>
					<span class="n">allow_create</span><span class="p">,</span> <span class="n">replace_required</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sn</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* If it is failed, discard just allocated</span>
<span class="cm">				   root, and then (in st_failure) stale node</span>
<span class="cm">				   in main tree.</span>
<span class="cm">				 */</span>
				<span class="n">node_free</span><span class="p">(</span><span class="n">sfn</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">st_failure</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Now link new subtree to main tree */</span>
			<span class="n">sfn</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span> <span class="o">=</span> <span class="n">sfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sn</span> <span class="o">=</span> <span class="n">fib6_add_1</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">),</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">plen</span><span class="p">,</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_src</span><span class="p">),</span>
					<span class="n">allow_create</span><span class="p">,</span> <span class="n">replace_required</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sn</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sn</span><span class="p">);</span>
				<span class="n">sn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sn</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">st_failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">sn</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fib6_add_rt2node</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fib6_start_gc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_CACHE</span><span class="p">))</span>
			<span class="n">fib6_prune_clones</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="cm">/*</span>
<span class="cm">		 * If fib6_add_1 has cleared the old leaf pointer in the</span>
<span class="cm">		 * super-tree leaf node we have to find a new one for it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pn</span> <span class="o">!=</span> <span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">==</span> <span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pn</span> <span class="o">!=</span> <span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fib6_find_prefix</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">,</span> <span class="n">pn</span><span class="p">);</span>
<span class="cp">#if RT6_DEBUG &gt;= 2</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">dst_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
	<span class="cm">/* Subtree creation failed, probably main tree node</span>
<span class="cm">	   is orphan. If it is, shoot it.</span>
<span class="cm">	 */</span>
<span class="nl">st_failure:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTN_RTINFO</span><span class="o">|</span><span class="n">RTN_ROOT</span><span class="p">)))</span>
		<span class="n">fib6_repair_tree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="n">dst_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Routing tree lookup</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">lookup_args</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">offset</span><span class="p">;</span>		<span class="cm">/* key offset on rt6_info	*/</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span>	<span class="o">*</span><span class="n">addr</span><span class="p">;</span>		<span class="cm">/* search key			*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">fib6_lookup_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">lookup_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Descend on a tree</span>
<span class="cm">	 */</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">dir</span> <span class="o">=</span> <span class="n">addr_bit_set</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">);</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">:</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">||</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

			<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">+</span>
						 <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_prefix_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span>
					<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_lookup_1</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span> <span class="n">args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span> <span class="o">||</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">fib6_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lookup_args</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_dst</span><span class="p">),</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">,</span>
		<span class="p">},</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_src</span><span class="p">),</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">,</span>
		<span class="p">},</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* sentinel */</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_lookup_1</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">daddr</span> <span class="o">?</span> <span class="n">args</span> <span class="o">:</span> <span class="n">args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span> <span class="o">||</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_TL_ROOT</span><span class="p">)</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Get node with specified destination prefix (and source prefix,</span>
<span class="cm"> *	if subtrees are used)</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">fib6_locate_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">plen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fn</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span> <span class="n">fn</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt6key</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Prefix match</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ipv6_prefix_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">==</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *	We have more bits to go</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_bit_set</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">))</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span> <span class="nf">fib6_locate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_len</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_locate_1</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">dst_len</span><span class="p">,</span>
			   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_dst</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">saddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_locate_1</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">src_len</span><span class="p">,</span>
					   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span><span class="p">,</span> <span class="n">rt6i_src</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fn</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Deletion</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="nf">fib6_find_prefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>

		<span class="n">fn</span> <span class="o">=</span> <span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called to trim the tree of intermediate nodes when possible. &quot;fn&quot;</span>
<span class="cm"> *	is the node we want to try and remove.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="nf">fib6_repair_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">children</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nstate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="o">*</span><span class="n">pn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;fixing tree: plen=%d iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_bit</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">++</span><span class="p">;</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_TL_ROOT</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">children</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span> <span class="n">child</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span> <span class="n">children</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span> <span class="n">child</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">children</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">children</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		    <span class="cm">/* Subtree root (i.e. fn) may have one child */</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">children</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">)</span>
<span class="cp">#endif</span>
		    <span class="p">)</span> <span class="p">{</span>
			<span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fib6_find_prefix</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
<span class="cp">#if RT6_DEBUG &gt;= 2</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">);</span>
				<span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">));</span>
			<span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">nstate</span> <span class="o">=</span> <span class="n">FWS_L</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
<span class="cp">#if RT6_DEBUG &gt;= 2</span>
			<span class="k">else</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span>
				<span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
			<span class="n">nstate</span> <span class="o">=</span> <span class="n">FWS_R</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
		<span class="n">FOR_WALKERS</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;W %p adjusted by delroot 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;W %p adjusted by delnode 1, s=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">nstate</span><span class="p">);</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">nstate</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
					<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;W %p adjusted by delroot 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">children</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;W %p adjusted by delnode 2, s=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
						<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">&gt;=</span><span class="n">FWS_R</span> <span class="o">?</span> <span class="n">FWS_U</span> <span class="o">:</span> <span class="n">FWS_INIT</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;W %p adjusted by delnode 2, s=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
						<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">&gt;=</span><span class="n">FWS_C</span> <span class="o">?</span> <span class="n">FWS_U</span> <span class="o">:</span> <span class="n">FWS_INIT</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>

		<span class="n">node_free</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span> <span class="o">||</span> <span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">pn</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">pn</span><span class="p">;</span>

		<span class="n">rt6_release</span><span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">);</span>
		<span class="n">pn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_del_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">**</span><span class="n">rtp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="o">*</span><span class="n">rtp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">;</span>

	<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;fib6_del_route</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Unlink it */</span>
	<span class="o">*</span><span class="n">rtp</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">;</span>
	<span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_rt_entries</span><span class="o">--</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_discarded_routes</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Reset round-robin state, if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">rr_ptr</span> <span class="o">==</span> <span class="n">rt</span><span class="p">)</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">rr_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Adjust walkers */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>
	<span class="n">FOR_WALKERS</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FWS_C</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">==</span> <span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;walker %p adjusted by delroute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_U</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_walker_lock</span><span class="p">);</span>

	<span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If it was last route, expunge its radix tree node */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTN_RTINFO</span><span class="p">;</span>
		<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="o">-&gt;</span><span class="n">fib_route_nodes</span><span class="o">--</span><span class="p">;</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">fib6_repair_tree</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This route is used as dummy address holder in some split</span>
<span class="cm">		 * nodes. It is not leaked, but it still holds other resources,</span>
<span class="cm">		 * which must be released in time. So, scan ascendant nodes</span>
<span class="cm">		 * and replace dummy references to this route with references</span>
<span class="cm">		 * to still alive ones.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">==</span> <span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fib6_find_prefix</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">);</span>
				<span class="n">rt6_release</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* No more references are possible at this point. */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_ref</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">inet6_rt_notify</span><span class="p">(</span><span class="n">RTM_DELROUTE</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">rt6_release</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fib6_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">**</span><span class="n">rtp</span><span class="p">;</span>

<span class="cp">#if RT6_DEBUG &gt;= 2</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">obsolete</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span> <span class="o">||</span> <span class="n">rt</span> <span class="o">==</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_CACHE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="cm">/* clones of this route might be in another subtree */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_src</span><span class="p">.</span><span class="n">plen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">))</span>
				<span class="n">pn</span> <span class="o">=</span> <span class="n">pn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
			<span class="n">pn</span> <span class="o">=</span> <span class="n">pn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">fib6_prune_clones</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nl_net</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Walk the leaf entries looking for ourself</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span> <span class="o">*</span><span class="n">rtp</span><span class="p">;</span> <span class="n">rtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">rtp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rtp</span> <span class="o">==</span> <span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fib6_del_route</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rtp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Tree traversal function.</span>
<span class="cm"> *</span>
<span class="cm"> *	Certainly, it is not interrupt safe.</span>
<span class="cm"> *	However, it is internally reenterable wrt itself and fib6_add/fib6_del.</span>
<span class="cm"> *	It means, that we can modify tree during walking</span>
<span class="cm"> *	and use this function for garbage collection, clone pruning,</span>
<span class="cm"> *	cleaning tree when a device goes down etc. etc.</span>
<span class="cm"> *</span>
<span class="cm"> *	It guarantees that every node will be traversed,</span>
<span class="cm"> *	and that it will be traversed only once.</span>
<span class="cm"> *</span>
<span class="cm"> *	Callback function w-&gt;func may return:</span>
<span class="cm"> *	0 -&gt; continue walking.</span>
<span class="cm"> *	positive value -&gt; walking is suspended (used by tree dumps,</span>
<span class="cm"> *	and probably by gc, if it will be split to several slices)</span>
<span class="cm"> *	negative value -&gt; terminate walking.</span>
<span class="cm"> *</span>
<span class="cm"> *	The function itself returns:</span>
<span class="cm"> *	0   -&gt; walk is complete.</span>
<span class="cm"> *	&gt;0  -&gt; walk is incomplete (i.e. suspended)</span>
<span class="cm"> *	&lt;0  -&gt; walk is terminated by an error.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_walk_continue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">pn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">prune</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span> <span class="o">!=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">FWS_C</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_C</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
		<span class="k">case</span> <span class="n">FWS_S</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_L</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">FWS_L</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_INIT</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_R</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FWS_R</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_INIT</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_C</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FWS_C</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">&amp;&amp;</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_RTINFO</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">w</span><span class="o">-&gt;</span><span class="n">skip</span><span class="o">--</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

				<span class="n">w</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_U</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FWS_U</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">==</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">pn</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPV6_SUBTREES</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FIB6_SUBTREE</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">fn_flags</span> <span class="o">&amp;</span> <span class="n">RTN_ROOT</span><span class="p">));</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_L</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_R</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pn</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">==</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_C</span><span class="p">;</span>
				<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#if RT6_DEBUG &gt;= 2</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FWS_INIT</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">;</span>

	<span class="n">fib6_walker_link</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">fib6_walk_continue</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fib6_walker_unlink</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_clean_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_walker_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib6_cleaner_t</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_cleaner_t</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nl_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nl_net</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rt</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">;</span> <span class="n">rt</span><span class="p">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">rt6_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">fib6_del</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if RT6_DEBUG &gt;= 2</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: del failed: rt=%p@%p err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_node</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Convenient frontend to tree walker.</span>
<span class="cm"> *</span>
<span class="cm"> *	func is called on each route.</span>
<span class="cm"> *		It may return -1 -&gt; delete this route.</span>
<span class="cm"> *		              0  -&gt; continue walking</span>
<span class="cm"> *</span>
<span class="cm"> *	prune==1 -&gt; only immediate children of node (certainly,</span>
<span class="cm"> *	ignoring pure split nodes) will be scanned.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_clean_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">),</span>
			    <span class="kt">int</span> <span class="n">prune</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_cleaner_t</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">fib6_clean_node</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">prune</span> <span class="o">=</span> <span class="n">prune</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>

	<span class="n">fib6_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fib6_clean_all_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">),</span>
		    <span class="kt">int</span> <span class="n">prune</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">FIB6_TABLE_HASHSZ</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
		<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tb6_hlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
			<span class="n">fib6_clean_tree</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">,</span>
					<span class="n">func</span><span class="p">,</span> <span class="n">prune</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">fib6_clean_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">),</span>
		    <span class="kt">int</span> <span class="n">prune</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib6_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">FIB6_TABLE_HASHSZ</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
		<span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tb6_hlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
			<span class="n">fib6_clean_tree</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">,</span>
					<span class="n">func</span><span class="p">,</span> <span class="n">prune</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">tb6_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_prune_clone</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_CACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;pruning clone %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_prune_clones</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib6_node</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fib6_clean_tree</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fib6_prune_clone</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Garbage collection</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fib6_gc_args</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">more</span><span class="p">;</span>
<span class="p">}</span> <span class="n">gc_args</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fib6_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	check addrconf expiration here.</span>
<span class="cm">	 *	Routes are expired even if they are in use.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Also age clones. Note, that clones are aged out</span>
<span class="cm">	 *	only if they are not in use now.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_EXPIRES</span> <span class="o">&amp;&amp;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">expires</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;expiring %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gc_args</span><span class="p">.</span><span class="n">more</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_CACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">__refcnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after_eq</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">lastuse</span> <span class="o">+</span> <span class="n">gc_args</span><span class="p">.</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;aging clone %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_flags</span> <span class="o">&amp;</span> <span class="n">RTF_GATEWAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">neigh</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">neigh_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">neigh</span> <span class="o">=</span> <span class="n">dst_neigh_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">neigh</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">neigh_flags</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
				<span class="n">neigh_release</span><span class="p">(</span><span class="n">neigh</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">neigh_flags</span> <span class="o">&amp;</span> <span class="n">NTF_ROUTER</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RT6_TRACE</span><span class="p">(</span><span class="s">&quot;purging route %p via non-router but gateway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">rt</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">gc_args</span><span class="p">.</span><span class="n">more</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">fib6_gc_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">fib6_run_gc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_gc_lock</span><span class="p">);</span>
		<span class="n">gc_args</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">expires</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">expires</span> <span class="o">:</span>
			<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">sysctl</span><span class="p">.</span><span class="n">ip6_rt_gc_interval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_gc_lock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gc_args</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">sysctl</span><span class="p">.</span><span class="n">ip6_rt_gc_interval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gc_args</span><span class="p">.</span><span class="n">more</span> <span class="o">=</span> <span class="n">icmp6_dst_gc</span><span class="p">();</span>

	<span class="n">fib6_clean_all</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fib6_age</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gc_args</span><span class="p">.</span><span class="n">more</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">,</span>
			  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">sysctl</span><span class="p">.</span><span class="n">ip6_rt_gc_interval</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_gc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_gc_timer_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fib6_run_gc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">fib6_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hlist_head</span><span class="p">)</span> <span class="o">*</span> <span class="n">FIB6_TABLE_HASHSZ</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">,</span> <span class="n">fib6_gc_timer_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">net</span><span class="p">);</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_timer</span><span class="p">;</span>

	<span class="cm">/* Avoid false sharing : Use at least a full cache line */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rt6_stats</span><span class="p">;</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fib_table_hash</span><span class="p">;</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="o">-&gt;</span><span class="n">tb6_id</span> <span class="o">=</span> <span class="n">RT6_TABLE_MAIN</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">fn_flags</span> <span class="o">=</span>
		<span class="n">RTN_ROOT</span> <span class="o">|</span> <span class="n">RTN_TL_ROOT</span> <span class="o">|</span> <span class="n">RTN_RTINFO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPV6_MULTIPLE_TABLES</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="p">),</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fib6_main_tbl</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="o">-&gt;</span><span class="n">tb6_id</span> <span class="o">=</span> <span class="n">RT6_TABLE_LOCAL</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">leaf</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_null_entry</span><span class="p">;</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="o">-&gt;</span><span class="n">tb6_root</span><span class="p">.</span><span class="n">fn_flags</span> <span class="o">=</span>
		<span class="n">RTN_ROOT</span> <span class="o">|</span> <span class="n">RTN_TL_ROOT</span> <span class="o">|</span> <span class="n">RTN_RTINFO</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">fib6_tables_init</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPV6_MULTIPLE_TABLES</span>
<span class="nl">out_fib6_main_tbl:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out_fib_table_hash:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">);</span>
<span class="nl">out_rt6_stats:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="p">);</span>
<span class="nl">out_timer:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
 <span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fib6_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt6_ifdown</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip6_fib_timer</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPV6_MULTIPLE_TABLES</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_local_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib6_main_tbl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">fib_table_hash</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">rt6_stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">fib6_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">fib6_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">fib6_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">fib6_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fib6_node_kmem</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;fib6_nodes&quot;</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib6_node</span><span class="p">),</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fib6_node_kmem</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kmem_cache_create</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__rtnl_register</span><span class="p">(</span><span class="n">PF_INET6</span><span class="p">,</span> <span class="n">RTM_GETROUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">inet6_dump_fib</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_subsys</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out_unregister_subsys:</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_net_ops</span><span class="p">);</span>
<span class="nl">out_kmem_cache_create:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fib6_node_kmem</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fib6_gc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fib6_net_ops</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fib6_node_kmem</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
