<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipv6 › mcast.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mcast.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Multicast support for IPv6</span>
<span class="cm"> *	Linux INET6 implementation</span>
<span class="cm"> *</span>
<span class="cm"> *	Authors:</span>
<span class="cm"> *	Pedro Roque		&lt;roque@di.fc.ul.pt&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Based on linux/ipv4/igmp.c and linux/ipv4/ip_sockglue.c</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/* Changes:</span>
<span class="cm"> *</span>
<span class="cm"> *	yoshfuji	: fix format of router-alert option</span>
<span class="cm"> *	YOSHIFUJI Hideaki @USAGI:</span>
<span class="cm"> *		Fixed source address for MLD message based on</span>
<span class="cm"> *		&lt;draft-ietf-magma-mld-source-05.txt&gt;.</span>
<span class="cm"> *	YOSHIFUJI Hideaki @USAGI:</span>
<span class="cm"> *		- Ignore Queries for invalid addresses.</span>
<span class="cm"> *		- MLD for link-local addresses.</span>
<span class="cm"> *	David L Stevens &lt;dlstevens@us.ibm.com&gt;:</span>
<span class="cm"> *		- MLDv2 support</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/mld.h&gt;</span>

<span class="cp">#include &lt;linux/netfilter.h&gt;</span>
<span class="cp">#include &lt;linux/netfilter_ipv6.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/snmp.h&gt;</span>

<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/protocol.h&gt;</span>
<span class="cp">#include &lt;net/if_inet6.h&gt;</span>
<span class="cp">#include &lt;net/ndisc.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>
<span class="cp">#include &lt;net/ip6_route.h&gt;</span>
<span class="cp">#include &lt;net/inet_common.h&gt;</span>

<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>

<span class="cm">/* Set to 3 to get tracing... */</span>
<span class="cp">#define MCAST_DEBUG 2</span>

<span class="cp">#if MCAST_DEBUG &gt;= 3</span>
<span class="cp">#define MDBG(x) printk x</span>
<span class="cp">#else</span>
<span class="cp">#define MDBG(x)</span>
<span class="cp">#endif</span>

<span class="cm">/* Ensure that we have struct in6_addr aligned on 32bit word. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__mld2_query_bugs</span><span class="p">[]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">__unused__</span><span class="p">))</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BUILD_BUG_ON_NULL</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_query</span><span class="p">,</span> <span class="n">mld2q_srcs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">BUILD_BUG_ON_NULL</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_report</span><span class="p">,</span> <span class="n">mld2r_grec</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">BUILD_BUG_ON_NULL</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span><span class="p">,</span> <span class="n">grec_mca</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">mld2_all_mcr</span> <span class="o">=</span> <span class="n">MLD2_ALL_MCR_INIT</span><span class="p">;</span>

<span class="cm">/* Big mc list lock for all the sockets */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">igmp6_join_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">igmp6_leave_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">igmp6_timer_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_gq_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_ifc_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_ifc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_add_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_del_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mld_clear_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sf_setstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sf_markstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ip6_mc_clear_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">delta</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">delta</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ip6_mc_leave_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">iml</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">);</span>


<span class="cp">#define IGMP6_UNSOLICITED_IVAL	(10*HZ)</span>
<span class="cp">#define MLD_QRV_DEFAULT		2</span>

<span class="cp">#define MLD_V1_SEEN(idev) (dev_net((idev)-&gt;dev)-&gt;ipv6.devconf_all-&gt;force_mld_version == 1 || \</span>
<span class="cp">		(idev)-&gt;cnf.force_mld_version == 1 || \</span>
<span class="cp">		((idev)-&gt;mc_v1_seen &amp;&amp; \</span>
<span class="cp">		time_before(jiffies, (idev)-&gt;mc_v1_seen)))</span>

<span class="cp">#define IPV6_MLD_MAX_MSF	64</span>

<span class="kt">int</span> <span class="n">sysctl_mld_max_msf</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">IPV6_MLD_MAX_MSF</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *	socket join on multicast group</span>
<span class="cm"> */</span>

<span class="cp">#define for_each_pmc_rcu(np, pmc)				\</span>
<span class="cp">	for (pmc = rcu_dereference(np-&gt;ipv6_mc_list);		\</span>
<span class="cp">	     pmc != NULL;					\</span>
<span class="cp">	     pmc = rcu_dereference(pmc-&gt;next))</span>

<span class="kt">int</span> <span class="nf">ipv6_sock_mc_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">mc_lst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_is_multicast</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ifindex</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">ifindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">mc_lst</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6_mc_socklist</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_lst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">rt6_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mc_lst</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>
	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">sflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	now add/increase the group membership on the device</span>
<span class="cm">	 */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ipv6_dev_mc_inc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mc_lst</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>
	<span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">ipv6_mc_list</span><span class="p">;</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ipv6_mc_list</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	socket leave on multicast group</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ipv6_sock_mc_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">mc_lst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">lnk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lnk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ipv6_mc_list</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">mc_lst</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="o">*</span><span class="n">lnk</span><span class="p">,</span>
			<span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">)))</span> <span class="o">!=</span><span class="nb">NULL</span> <span class="p">;</span>
	      <span class="n">lnk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ifindex</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">==</span> <span class="n">ifindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

			<span class="o">*</span><span class="n">lnk</span> <span class="o">=</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>

			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="n">idev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span>
					<span class="n">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mc_lst</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
			<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">mc_lst</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called with rcu_read_lock() */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="nf">ip6_mc_find_dev_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">ifindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">rt6_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">dst_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">idev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipv6_sock_mc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">mc_lst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">mc_lst</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ipv6_mc_list</span><span class="p">,</span>
				<span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">)))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">ipv6_mc_list</span> <span class="o">=</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="n">idev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span>
				<span class="n">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_lst</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_leave_src</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mc_lst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">atomic_sub</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mc_lst</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_omem_alloc</span><span class="p">);</span>
		<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">mc_lst</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_sk_mc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip6_mc_source</span><span class="p">(</span><span class="kt">int</span> <span class="n">add</span><span class="p">,</span> <span class="kt">int</span> <span class="n">omode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">group_source_req</span> <span class="o">*</span><span class="n">pgsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">inet6</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip6_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmclocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_source</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
	<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_group</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_is_multicast</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">ip6_mc_find_dev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">inet6</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_interface</span> <span class="o">&amp;&amp;</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">!=</span> <span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_interface</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* must have a prior join */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if a source filter was set, must be the same mode as before */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">!=</span> <span class="n">omode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">!=</span> <span class="n">omode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allow mode switches for empty-set filters */</span>
		<span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">omode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">pmclocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">psl</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* err = -EADDRNOTAVAIL */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">source</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>		<span class="cm">/* source not found */</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* err = -EADDRNOTAVAIL */</span>

		<span class="cm">/* special case - (INCLUDE, empty) == LEAVE_GROUP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">omode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update the interface filter */</span>
		<span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else, add a new source to the filter */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psl</span> <span class="o">&amp;&amp;</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">&gt;=</span> <span class="n">sysctl_mld_max_msf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span> <span class="o">||</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">==</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip6_sf_socklist</span> <span class="o">*</span><span class="n">newpsl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">IP6_SFBLOCK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">;</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpsl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">IP6_SFBLOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">psl</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span> <span class="o">=</span> <span class="n">psl</span> <span class="o">=</span> <span class="n">newpsl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* &gt; 0 for insert logic below if sl_count is 0 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">source</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* address already there is an error */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
	<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* update the interface list */</span>
	<span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">omode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmclocked</span><span class="p">)</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leavegroup</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ipv6_sock_mc_drop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">pgsr</span><span class="o">-&gt;</span><span class="n">gsr_interface</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip6_mc_msfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">group_filter</span> <span class="o">*</span><span class="n">gsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">inet6</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip6_sf_socklist</span> <span class="o">*</span><span class="n">newpsl</span><span class="p">,</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_group</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_is_multicast</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span> <span class="o">!=</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span> <span class="o">!=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">ip6_mc_find_dev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leavegroup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">inet6</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">!=</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* must have a prior join */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="n">sock_kmalloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span><span class="p">),</span>
							  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpsl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span> <span class="o">=</span> <span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">=</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">psin6</span><span class="p">;</span>

			<span class="n">psin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_slist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span><span class="p">,</span>
			<span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">newpsl</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">newpsl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">newpsl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span>
			<span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">psl</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span> <span class="o">=</span> <span class="n">newpsl</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">=</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leavegroup</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ipv6_sock_mc_drop</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip6_mc_msfget</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">group_filter</span> <span class="o">*</span><span class="n">gsf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">group_filter</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">copycount</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">inet6</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ip6_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_group</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_is_multicast</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">ip6_mc_find_dev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * changes to the ipv6_mc_list require the socket lock and</span>
<span class="cm">	 * a read lock on ip6_sk_mc_lock. We have the socket lock,</span>
<span class="cm">	 * so reading the list is safe.</span>
<span class="cm">	 */</span>

	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">inet6</span><span class="p">,</span> <span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">!=</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_interface</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>		<span class="cm">/* must have a prior join */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_fmode</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">;</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">psl</span> <span class="o">?</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">copycount</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span><span class="p">;</span>
	<span class="n">gsf</span><span class="o">-&gt;</span><span class="n">gf_numsrc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">GROUP_FILTER_SIZE</span><span class="p">(</span><span class="n">copycount</span><span class="p">),</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">gsf</span><span class="p">,</span> <span class="n">GROUP_FILTER_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* changes to psl require the socket lock, a read lock on</span>
<span class="cm">	 * on ipv6_sk_mc_lock and a write lock on pmc-&gt;sflock. We</span>
<span class="cm">	 * have the socket lock, so reading here is safe.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">copycount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">psin6</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">ss</span><span class="p">;</span>

		<span class="n">psin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">));</span>
		<span class="n">psin6</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">psin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span> <span class="o">=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">optval</span><span class="o">-&gt;</span><span class="n">gf_slist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">inet6_mc_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">mc_addr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipv6_pinfo</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">inet6_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip6_sf_socklist</span> <span class="o">*</span><span class="n">psl</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_pmc_rcu</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">mc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mc_addr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">src_addr</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psl</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">sflock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ma_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_group_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span><span class="o">&amp;</span><span class="n">MAF_LOADED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_LOADED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndisc_mc_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_mc_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MLD_V1_SEEN</span><span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">igmp6_join_group</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else v2 */</span>

	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
	<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_group_dropped</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span><span class="o">&amp;</span><span class="n">MAF_LOADED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_LOADED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndisc_mc_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_mc_del</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span>
		<span class="n">igmp6_leave_group</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">))</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">ip6_mc_clear_src</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deleted ifmcaddr6 manipulation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_add_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>

	<span class="cm">/* this is an &quot;ifmcaddr6&quot; for convenience; only the fields below</span>
<span class="cm">	 * are actually used. In particular, the refcnt and users are not</span>
<span class="cm">	 * used for management of the delete list. Using the same structure</span>
<span class="cm">	 * for deleted items allows change reports to use common code with</span>
<span class="cm">	 * non-deleted or query-response MCA&#39;s.</span>
<span class="cm">	 */</span>
	<span class="n">pmc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">;</span>
	<span class="n">in6_dev_hold</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_addr</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span>
		<span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_sources</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_del_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pmca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>
	<span class="n">pmc_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">pmca</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pmc_prev</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc_prev</span><span class="p">)</span>
			<span class="n">pmc_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_clear_delrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">nextpmc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>
	<span class="n">pmc</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span> <span class="o">=</span> <span class="n">nextpmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpmc</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">ip6_mc_clear_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear dead sources, too */</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	device multicast group inc (add if not found)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ipv6_dev_mc_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>

	<span class="cm">/* we need to take a reference on idev */</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mc</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">mc</span><span class="p">;</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_users</span><span class="o">++</span><span class="p">;</span>
			<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ip6_mc_add_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">MCAST_EXCLUDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	not found: create a new one.</span>
<span class="cm">	 */</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">,</span> <span class="n">igmp6_timer_handler</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mc</span><span class="p">);</span>

	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span> <span class="cm">/* (reference taken) */</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* mca_stamp should be updated upon changes */</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_cstamp</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_tstamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>

	<span class="cm">/* initial mode is (EX, empty) */</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_is_ll_all_nodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">IPV6_ADDR_MC_SCOPE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IPV6_ADDR_SCOPE_LINKLOCAL</span><span class="p">)</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_NOREPORT</span><span class="p">;</span>

	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">=</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mld_del_delrec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">);</span>
	<span class="n">igmp6_group_added</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>
	<span class="n">ma_put</span><span class="p">(</span><span class="n">mc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	device multicast group del</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">,</span> <span class="o">**</span><span class="n">map</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="p">(</span><span class="n">ma</span><span class="o">=*</span><span class="n">map</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

				<span class="n">igmp6_group_dropped</span><span class="p">(</span><span class="n">ma</span><span class="p">);</span>

				<span class="n">ma_put</span><span class="p">(</span><span class="n">ma</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipv6_dev_mc_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * identify MLD packets for MLD filter exceptions</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">ipv6_is_mld</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nexthdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">icmp6hdr</span> <span class="o">*</span><span class="n">pic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nexthdr</span> <span class="o">!=</span> <span class="n">IPPROTO_ICMPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmp6hdr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pic</span> <span class="o">=</span> <span class="n">icmp6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pic</span><span class="o">-&gt;</span><span class="n">icmp6_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ICMPV6_MGM_QUERY</span>:
	<span class="k">case</span> <span class="n">ICMPV6_MGM_REPORT</span>:
	<span class="k">case</span> <span class="n">ICMPV6_MGM_REDUCTION</span>:
	<span class="k">case</span> <span class="n">ICMPV6_MLD2_REPORT</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	check if the interface/address pair is valid</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">ipv6_chk_mcast_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mc</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">mc</span><span class="p">;</span> <span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_addr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipv6_addr_any</span><span class="p">(</span><span class="n">src_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span><span class="n">psf</span><span class="p">;</span><span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="p">)</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">||</span>
						<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span>
						<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* don&#39;t filter unspecified source */</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_gq_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_maxdelay</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">tv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">in6_dev_hold</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_ifc_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">tv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">in6_dev_hold</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	IGMP handling (alias multicast ICMPv6 messages)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_group_queried</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resptime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">resptime</span><span class="p">;</span>

	<span class="cm">/* Do not start timer for these addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_is_ll_all_nodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">IPV6_ADDR_MC_SCOPE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IPV6_ADDR_SCOPE_LINKLOCAL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="n">resptime</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resptime</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">resptime</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">delay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
	<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_TIMER_RUNNING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* mark EXCLUDE-mode sources */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">mld_xmarksources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsrcs</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">srcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">scount</span><span class="p">;</span>

	<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nsrcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip inactive filters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span>
			    <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_GSQUERY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>	<span class="cm">/* all sources excluded */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">mld_marksources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsrcs</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">srcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">scount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mld_xmarksources</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">nsrcs</span><span class="p">,</span> <span class="n">srcs</span><span class="p">);</span>

	<span class="cm">/* mark INCLUDE-mode sources */</span>

	<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scount</span> <span class="o">==</span> <span class="n">nsrcs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nsrcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_GSQUERY</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_GSQUERY</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called with rcu_read_lock() */</span>
<span class="kt">int</span> <span class="nf">igmp6_event_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mld2_query</span> <span class="o">*</span><span class="n">mlh2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_delay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="n">mld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">group_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* compute payload length excluding extension headers */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">payload_len</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">skb_network_header_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Drop queries with not link local source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mld</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">icmp6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mld</span><span class="o">-&gt;</span><span class="n">mld_mca</span><span class="p">;</span>
	<span class="n">group_type</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group_type</span> <span class="o">!=</span> <span class="n">IPV6_ADDR_ANY</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">group_type</span><span class="o">&amp;</span><span class="n">IPV6_ADDR_MULTICAST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">switchback</span><span class="p">;</span>
		<span class="cm">/* MLDv1 router present */</span>

		<span class="cm">/* Translate milliseconds to jiffies */</span>
		<span class="n">max_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mld</span><span class="o">-&gt;</span><span class="n">mld_maxdelay</span><span class="p">)</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>

		<span class="n">switchback</span> <span class="o">=</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_delay</span><span class="p">;</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_v1_seen</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">switchback</span><span class="p">;</span>

		<span class="cm">/* cancel the interface change timer */</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_timer</span><span class="p">))</span>
			<span class="n">__in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="cm">/* clear deleted report items */</span>
		<span class="n">mld_clear_delrec</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">srcs_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_query</span><span class="p">)</span> <span class="o">-</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmp6hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">srcs_offset</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">mlh2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_query</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">max_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">MLDV2_MRC</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_mrc</span><span class="p">))</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_delay</span><span class="p">)</span>
			<span class="n">max_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_maxdelay</span> <span class="o">=</span> <span class="n">max_delay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_qrv</span><span class="p">)</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span> <span class="o">=</span> <span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_qrv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group_type</span> <span class="o">==</span> <span class="n">IPV6_ADDR_ANY</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* general query */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_nsrcs</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* no sources allowed */</span>

			<span class="n">mld_gq_start_timer</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* mark sources to include, if group &amp; source-specific */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_nsrcs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">srcs_offset</span> <span class="o">+</span>
			    <span class="n">ntohs</span><span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_nsrcs</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">mlh2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_query</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group_type</span> <span class="o">==</span> <span class="n">IPV6_ADDR_ANY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ma</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">ma</span><span class="p">;</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="n">igmp6_group_queried</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ma</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">ma</span><span class="p">;</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_TIMER_RUNNING</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* gsquery &lt;- gsquery &amp;&amp; mark */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="p">)</span>
					<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_GSQUERY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* gsquery &lt;- mark */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="p">)</span>
					<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_GSQUERY</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_GSQUERY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_GSQUERY</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">mld_marksources</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_nsrcs</span><span class="p">),</span> <span class="n">mlh2</span><span class="o">-&gt;</span><span class="n">mld2q_srcs</span><span class="p">))</span>
				<span class="n">igmp6_group_queried</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called with rcu_read_lock() */</span>
<span class="kt">int</span> <span class="nf">igmp6_event_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="n">mld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_type</span><span class="p">;</span>

	<span class="cm">/* Our own report looped back. Ignore it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_LOOPBACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send our report if the MC router may not have heard this report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">!=</span> <span class="n">PACKET_MULTICAST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">!=</span> <span class="n">PACKET_BROADCAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mld</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmp6hdr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mld</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">icmp6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Drop reports with not link local source */</span>
	<span class="n">addr_type</span> <span class="o">=</span> <span class="n">ipv6_addr_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_type</span> <span class="o">!=</span> <span class="n">IPV6_ADDR_ANY</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">addr_type</span><span class="o">&amp;</span><span class="n">IPV6_ADDR_LINKLOCAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Cancel the timer for this group</span>
<span class="cm">	 */</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ma</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">ma</span><span class="p">;</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mld</span><span class="o">-&gt;</span><span class="n">mld_mca</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">))</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
			<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAF_LAST_REPORTER</span><span class="o">|</span><span class="n">MAF_TIMER_RUNNING</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MLD2_MODE_IS_INCLUDE</span>:
	<span class="k">case</span> <span class="n">MLD2_MODE_IS_EXCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_GSQUERY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* don&#39;t include if this source is excluded</span>
<span class="cm">			 * in all filters</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_MODE_IS_INCLUDE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLD2_CHANGE_TO_INCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLD2_CHANGE_TO_EXCLUDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="n">sdeleted</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
	<span class="k">case</span> <span class="n">MLD2_ALLOW_NEW_SOURCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gdeleted</span> <span class="o">||</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="o">^</span> <span class="n">sdeleted</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">gdeleted</span> <span class="o">||</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">&amp;&amp;</span> <span class="n">sdeleted</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gdeleted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sdeleted</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mld_scount</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">scount</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">mld_newpack</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="n">pmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">addr_buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ra</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">IPPROTO_ICMPV6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">IPV6_TLV_ROUTERALERT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">IPV6_TLV_PADN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* we assume size &gt; sizeof(ra) here */</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="cm">/* limit our allocations to order-0 page */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">SKB_MAX_ORDER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_get_lladdr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_buf</span><span class="p">,</span> <span class="n">IFA_F_TENTATIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* &lt;draft-ietf-magma-mld-source-05.txt&gt;:</span>
<span class="cm">		 * use unspecified address as the source address</span>
<span class="cm">		 * when a valid link-local address is not available.</span>
<span class="cm">		 */</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in6addr_any</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr_buf</span><span class="p">;</span>

	<span class="n">ip6_nd_hdr</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mld2_all_mcr</span><span class="p">,</span> <span class="n">NEXTHDR_HOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ra</span><span class="p">)),</span> <span class="n">ra</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ra</span><span class="p">));</span>

	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmr</span><span class="p">));</span>
	<span class="n">pmr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_type</span> <span class="o">=</span> <span class="n">ICMPV6_MLD2_REPORT</span><span class="p">;</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_resv1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_cksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_resv2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_ngrec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_sendpack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipv6hdr</span> <span class="o">*</span><span class="n">pip6</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="n">pmr</span> <span class="o">=</span>
			      <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">mldlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi6</span> <span class="n">fl6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IP6_UPD_PO_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUT</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pip6</span><span class="p">);</span>
	<span class="n">mldlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span><span class="p">;</span>
	<span class="n">pip6</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">payload_len</span><span class="p">);</span>

	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_cksum</span> <span class="o">=</span> <span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pip6</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pip6</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">mldlen</span><span class="p">,</span>
					   <span class="n">IPPROTO_ICMPV6</span><span class="p">,</span>
					   <span class="n">csum_partial</span><span class="p">(</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
							<span class="n">mldlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">icmpv6_flow_init</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">,</span> <span class="n">ICMPV6_MLD2_REPORT</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
			 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">icmp6_dst_alloc</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV6</span><span class="p">,</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">dst_output</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ICMP6MSGOUT_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ICMPV6_MLD2_REPORT</span><span class="p">);</span>
		<span class="n">ICMP6_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ICMP6_MIB_OUTMSGS</span><span class="p">);</span>
		<span class="n">IP6_UPD_PO_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTMCAST</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IP6_INC_STATS_BH</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTDISCARDS</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grec_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">mld_scount</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="n">gdel</span><span class="p">,</span><span class="n">sdel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">add_grhead</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mld2_grec</span> <span class="o">**</span><span class="n">ppgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="n">pmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld2_grec</span> <span class="o">*</span><span class="n">pgr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">mld_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pgr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span><span class="p">));</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_auxwords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_mca</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">;</span>	<span class="cm">/* structure copy */</span>
	<span class="n">pmr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_ngrec</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_ngrec</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ppgr</span> <span class="o">=</span> <span class="n">pgr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AVAILABLE(skb) ((skb) ? ((skb)-&gt;dev ? (skb)-&gt;dev-&gt;mtu - (skb)-&gt;len : \</span>
<span class="cp">	skb_tailroom(skb)) : 0)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">add_grec</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdeleted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="n">pmr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld2_grec</span> <span class="o">*</span><span class="n">pgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">,</span> <span class="o">**</span><span class="n">psf_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scount</span><span class="p">,</span> <span class="n">stotal</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">isquery</span><span class="p">,</span> <span class="n">truncate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">isquery</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_MODE_IS_INCLUDE</span> <span class="o">||</span>
		  <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_MODE_IS_EXCLUDE</span><span class="p">;</span>
	<span class="n">truncate</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_MODE_IS_EXCLUDE</span> <span class="o">||</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_CHANGE_TO_EXCLUDE</span><span class="p">;</span>

	<span class="n">stotal</span> <span class="o">=</span> <span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psf_list</span> <span class="o">=</span> <span class="n">sdeleted</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">psf_list</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">empty_source</span><span class="p">;</span>

	<span class="n">pmr</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld2_report</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* EX and TO_EX get a fresh packet, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmr</span> <span class="o">&amp;&amp;</span> <span class="n">pmr</span><span class="o">-&gt;</span><span class="n">mld2r_ngrec</span> <span class="o">&amp;&amp;</span>
		    <span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">grec_size</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">mld_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">mld_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=*</span><span class="n">psf_list</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psrc</span><span class="p">;</span>

		<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">gdeleted</span><span class="p">,</span> <span class="n">sdeleted</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear marks on query responses */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isquery</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_gsresp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psrc</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">first</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">first</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	 <span class="cm">/* truncate these */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgr</span><span class="p">)</span>
				<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">scount</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">mld_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">mld_newpack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grhead</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgr</span><span class="p">);</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">psrc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psrc</span><span class="p">));</span>
		<span class="o">*</span><span class="n">psrc</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">;</span>
		<span class="n">scount</span><span class="o">++</span><span class="p">;</span> <span class="n">stotal</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_ALLOW_NEW_SOURCES</span> <span class="o">||</span>
		     <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sdeleted</span> <span class="o">||</span> <span class="n">gdeleted</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
					<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">psf_list</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">empty_source:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stotal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_ALLOW_NEW_SOURCES</span> <span class="o">||</span>
		    <span class="n">type</span> <span class="o">==</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">||</span> <span class="n">isquery</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* make sure we have room for group header */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="n">AVAILABLE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld2_grec</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mld_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* add_grhead will get a new one */</span>
			<span class="p">}</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grhead</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pgr</span><span class="p">)</span>
		<span class="n">pgr</span><span class="o">-&gt;</span><span class="n">grec_nsrcs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">scount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isquery</span><span class="p">)</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_GSQUERY</span><span class="p">;</span>	<span class="cm">/* clear query state */</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_send_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_MODE_IS_EXCLUDE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_MODE_IS_INCLUDE</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_MODE_IS_EXCLUDE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_MODE_IS_INCLUDE</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">mld_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove zero-count source records from a source filter list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_clear_zeros</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">**</span><span class="n">ppsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_next</span><span class="p">,</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=*</span><span class="n">ppsf</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
				<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">ppsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_send_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_prev</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">dtype</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>

	<span class="cm">/* deleted MCA&#39;s */</span>
	<span class="n">pmc_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmc_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_INCLUDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_CHANGE_TO_INCLUDE</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mld_clear_zeros</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">);</span>
				<span class="n">mld_clear_zeros</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc_prev</span><span class="p">)</span>
				<span class="n">pmc_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pmc_next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="n">pmc_next</span><span class="p">;</span>
			<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pmc_prev</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>

	<span class="cm">/* change recs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">MLD2_ALLOW_NEW_SOURCES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_ALLOW_NEW_SOURCES</span><span class="p">;</span>
			<span class="n">dtype</span> <span class="o">=</span> <span class="n">MLD2_BLOCK_OLD_SOURCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* deleted sources */</span>

		<span class="cm">/* filter mode changes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">)</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_CHANGE_TO_EXCLUDE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">MLD2_CHANGE_TO_INCLUDE</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">add_grec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pmc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mld_sendpack</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">snd_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">saddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">addr_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_tailroom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">full_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ra</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">IPPROTO_ICMPV6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">IPV6_TLV_ROUTERALERT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">IPV6_TLV_PADN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">flowi6</span> <span class="n">fl6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ICMPV6_MGM_REDUCTION</span><span class="p">)</span>
		<span class="n">snd_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in6addr_linklocal_allrouters</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">snd_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmp6hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">);</span>
	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ra</span><span class="p">);</span>
	<span class="n">full_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipv6hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">payload_len</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">IP6_UPD_PO_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		      <span class="n">IPSTATS_MIB_OUT</span><span class="p">,</span> <span class="n">full_len</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hlen</span> <span class="o">+</span> <span class="n">tlen</span> <span class="o">+</span> <span class="n">full_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">IP6_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
			      <span class="n">IPSTATS_MIB_OUTDISCARDS</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_get_lladdr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_buf</span><span class="p">,</span> <span class="n">IFA_F_TENTATIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* &lt;draft-ietf-magma-mld-source-05.txt&gt;:</span>
<span class="cm">		 * use unspecified address as the source address</span>
<span class="cm">		 * when a valid link-local address is not available.</span>
<span class="cm">		 */</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in6addr_any</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">saddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr_buf</span><span class="p">;</span>

	<span class="n">ip6_nd_hdr</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">snd_addr</span><span class="p">,</span> <span class="n">NEXTHDR_HOP</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ra</span><span class="p">)),</span> <span class="n">ra</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ra</span><span class="p">));</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mld_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld_msg</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mld_msg</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">mld_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">mld_mca</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">mld_cksum</span> <span class="o">=</span> <span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="n">saddr</span><span class="p">,</span> <span class="n">snd_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					 <span class="n">IPPROTO_ICMPV6</span><span class="p">,</span>
					 <span class="n">csum_partial</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">icmpv6_flow_init</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
			 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">icmp6_dst_alloc</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_dst_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV6</span><span class="p">,</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">dst_output</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ICMP6MSGOUT_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">ICMP6_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ICMP6_MIB_OUTMSGS</span><span class="p">);</span>
		<span class="n">IP6_UPD_PO_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTMCAST</span><span class="p">,</span> <span class="n">full_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IP6_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">IPSTATS_MIB_OUTDISCARDS</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip6_mc_del1_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span> <span class="n">psfsrc</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span> <span class="o">||</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* source filter not found, or count wrong =&gt;  bug */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">;</span>

		<span class="cm">/* no more filters for this source */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span>
			<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">MLD_V1_SEEN</span><span class="p">(</span><span class="n">idev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip6_mc_del_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">changerec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="n">pmca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MCA not found?? bug */</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">sf_markstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sfcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">ip6_mc_del1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">changerec</span> <span class="o">|=</span> <span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

		<span class="cm">/* filter mode change */</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">MCAST_INCLUDE</span><span class="p">;</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sf_setstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">)</span> <span class="o">||</span> <span class="n">changerec</span><span class="p">)</span>
		<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add multicast single-source filter to the interface list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip6_mc_add1_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_prev</span><span class="p">;</span>

	<span class="n">psf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span> <span class="n">psfsrc</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">psf_prev</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

		<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psf_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf_prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sf_markstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mca_xcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">=</span> <span class="n">mca_xcount</span> <span class="o">==</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sf_setstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">dpsf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mca_xcount</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">qrv</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_in</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">new_in</span> <span class="o">=</span> <span class="n">mca_xcount</span> <span class="o">==</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">new_in</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span> <span class="n">dpsf</span><span class="p">;</span>
				     <span class="n">dpsf</span><span class="o">=</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">prev</span> <span class="o">=</span> <span class="n">dpsf</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dpsf</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
						<span class="n">prev</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">dpsf</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">qrv</span><span class="p">;</span>
				<span class="n">rv</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_oldin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * add or update &quot;delete&quot; records if an active filter</span>
<span class="cm">			 * is now inactive</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">dpsf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span> <span class="n">dpsf</span><span class="p">;</span> <span class="n">dpsf</span><span class="o">=</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpsf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dpsf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dpsf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpsf</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dpsf</span> <span class="o">=</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
				<span class="cm">/* pmc-&gt;mca_lock held by callers */</span>
				<span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_next</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span>
				<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="n">dpsf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dpsf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="n">qrv</span><span class="p">;</span>
			<span class="n">rv</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add multicast source filter list to the interface list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip6_mc_add_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pmca</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">sfmode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sfcount</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">psfsrc</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">isexclude</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pmc</span><span class="o">=</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">pmc</span><span class="p">;</span> <span class="n">pmc</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="n">pmca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MCA not found?? bug */</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>

	<span class="n">sf_markstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">);</span>
	<span class="n">isexclude</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">==</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span>
		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sfcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ip6_mc_add1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta</span><span class="p">)</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">sfmode</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ip6_mc_del1_src</span><span class="p">(</span><span class="n">pmc</span><span class="p">,</span> <span class="n">sfmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psfsrc</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isexclude</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>

		<span class="cm">/* filter mode change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">])</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">])</span>
			<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">MCAST_INCLUDE</span><span class="p">;</span>
		<span class="cm">/* else no filters; keep old mode for reports */</span>

		<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_crcount</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">)</span>
			<span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_crcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sf_setstate</span><span class="p">(</span><span class="n">pmc</span><span class="p">))</span>
		<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip6_mc_clear_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">pmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">,</span> <span class="o">*</span><span class="n">nextpsf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">nextpsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">psf</span><span class="o">=</span><span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span> <span class="n">psf</span><span class="p">;</span> <span class="n">psf</span><span class="o">=</span><span class="n">nextpsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextpsf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sources</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfmode</span> <span class="o">=</span> <span class="n">MCAST_EXCLUDE</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmc</span><span class="o">-&gt;</span><span class="n">mca_sfcount</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_join_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_NOREPORT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">igmp6_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ICMPV6_MGM_REPORT</span><span class="p">);</span>

	<span class="n">delay</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">IGMP6_UNSOLICITED_IVAL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_refcnt</span><span class="p">);</span>
	<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span> <span class="n">MAF_TIMER_RUNNING</span> <span class="o">|</span> <span class="n">MAF_LAST_REPORTER</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ip6_mc_leave_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipv6_mc_socklist</span> <span class="o">*</span><span class="n">iml</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* callers have the socket lock and a write lock on ipv6_sk_mc_lock,</span>
<span class="cm">	 * so no other readers or writers of iml or its sflist</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* any-source empty exclude case */</span>
		<span class="k">return</span> <span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ip6_mc_del_src</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">sfmode</span><span class="p">,</span>
		<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sl_count</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sl_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sock_kfree_s</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="p">,</span> <span class="n">IP6_SFLSIZE</span><span class="p">(</span><span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sl_max</span><span class="p">));</span>
	<span class="n">iml</span><span class="o">-&gt;</span><span class="n">sflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_leave_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MLD_V1_SEEN</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;</span> <span class="n">MAF_LAST_REPORTER</span><span class="p">)</span>
			<span class="n">igmp6_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">ICMPV6_MGM_REDUCTION</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mld_add_delrec</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">ma</span><span class="p">);</span>
		<span class="n">mld_ifc_event</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_gq_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mld_send_report</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_ifc_timer_expire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">mld_send_cr</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span><span class="p">)</span>
			<span class="n">mld_ifc_start_timer</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_maxdelay</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mld_ifc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MLD_V1_SEEN</span><span class="p">(</span><span class="n">idev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span><span class="p">;</span>
	<span class="n">mld_ifc_start_timer</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_timer_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">ma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MLD_V1_SEEN</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">))</span>
		<span class="n">igmp6_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ICMPV6_MGM_REPORT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mld_send_report</span><span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">ma</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">|=</span>  <span class="n">MAF_LAST_REPORTER</span><span class="p">;</span>
	<span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAF_TIMER_RUNNING</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
	<span class="n">ma_put</span><span class="p">(</span><span class="n">ma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Device changing type */</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Install multicast list, except for all-nodes (already installed) */</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">igmp6_group_dropped</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_remap</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipv6_mc_up</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Device going down */</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Withdraw multicast list */</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_timer</span><span class="p">))</span>
		<span class="n">__in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_timer</span><span class="p">))</span>
		<span class="n">__in6_dev_put</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">igmp6_group_dropped</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mld_clear_delrec</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Device going up */</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Install multicast list, except for all-nodes (already installed) */</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">igmp6_group_added</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* IPv6 device initialization. */</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_init_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_lock</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_gq_timer</span><span class="p">,</span> <span class="n">mld_gq_timer_expire</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_tomb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_ifc_timer</span><span class="p">,</span> <span class="n">mld_ifc_timer_expire</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_qrv</span> <span class="o">=</span> <span class="n">MLD_QRV_DEFAULT</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_maxdelay</span> <span class="o">=</span> <span class="n">IGMP6_UNSOLICITED_IVAL</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_v1_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Device is about to be destroyed: clean up.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ipv6_mc_destroy_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Deactivate timers */</span>
	<span class="n">ipv6_mc_down</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="cm">/* Delete all-nodes address. */</span>
	<span class="cm">/* We cannot call ipv6_dev_mc_dec() directly, our caller in</span>
<span class="cm">	 * addrconf.c has NULL&#39;d out dev-&gt;ip6_ptr so in6_dev_get() will</span>
<span class="cm">	 * fail.</span>
<span class="cm">	 */</span>
	<span class="n">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6addr_linklocal_allnodes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">cnf</span><span class="p">.</span><span class="n">forwarding</span><span class="p">)</span>
		<span class="n">__ipv6_dev_mc_dec</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6addr_linklocal_allrouters</span><span class="p">);</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">igmp6_group_dropped</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">ma_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define igmp6_mc_seq_private(seq)	((struct igmp6_mc_iter_state *)(seq)-&gt;private)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="nf">igmp6_mc_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
		<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="nf">igmp6_mc_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">next_net_device_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="nf">igmp6_mc_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="n">igmp6_mc_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">im</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">im</span> <span class="o">=</span> <span class="n">igmp6_mc_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">im</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp6_mc_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">igmp6_mc_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp6_mc_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="n">igmp6_mc_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">im</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_mc_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp6_mc_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mc_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;%-4d %-15s %pi6 %5d %08X %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span>
		   <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_users</span><span class="p">,</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_flags</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_flags</span><span class="o">&amp;</span><span class="n">MAF_TIMER_RUNNING</span><span class="p">)</span> <span class="o">?</span>
		   <span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_timer</span><span class="p">.</span><span class="n">expires</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">igmp6_mc_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span>	<span class="n">igmp6_mc_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span>	<span class="n">igmp6_mc_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span>	<span class="n">igmp6_mc_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span>	<span class="n">igmp6_mc_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp6_mc_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp6_mc_seq_ops</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmp6_mc_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">igmp6_mc_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">igmp6_mc_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span>	<span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span>	<span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span>	<span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_net_private</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define igmp6_mcf_seq_private(seq)	((struct igmp6_mcf_iter_state *)(seq)-&gt;private)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="nf">igmp6_mcf_get_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">seq_file_net</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
		<span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">im</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
			<span class="n">psf</span> <span class="o">=</span> <span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">psf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="nf">igmp6_mcf_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">psf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">next_net_device_rcu</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">__in6_dev_get</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_sources</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="nf">igmp6_mcf_get_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="n">igmp6_mcf_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psf</span> <span class="o">=</span> <span class="n">igmp6_mcf_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">psf</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">--</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp6_mcf_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">igmp6_mcf_get_idx</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">igmp6_mcf_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">igmp6_mcf_get_first</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="n">igmp6_mcf_get_next</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">psf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">igmp6_mcf_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">RCU</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp6_mcf_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip6_sf_list</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">igmp6_mcf_seq_private</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;%3s %6s &quot;</span>
			   <span class="s">&quot;%32s %32s %6s %6s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Idx&quot;</span><span class="p">,</span>
			   <span class="s">&quot;Device&quot;</span><span class="p">,</span> <span class="s">&quot;Multicast Address&quot;</span><span class="p">,</span>
			   <span class="s">&quot;Source Address&quot;</span><span class="p">,</span> <span class="s">&quot;INC&quot;</span><span class="p">,</span> <span class="s">&quot;EXC&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;%3d %6.6s %pi6 %pi6 %6lu %6lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_addr</span><span class="p">,</span>
			   <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_INCLUDE</span><span class="p">],</span>
			   <span class="n">psf</span><span class="o">-&gt;</span><span class="n">sf_count</span><span class="p">[</span><span class="n">MCAST_EXCLUDE</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">igmp6_mcf_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span>	<span class="n">igmp6_mcf_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span>	<span class="n">igmp6_mcf_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span>	<span class="n">igmp6_mcf_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span>	<span class="n">igmp6_mcf_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">igmp6_mcf_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open_net</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp6_mcf_seq_ops</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">igmp6_mcf_iter_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">igmp6_mcf_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">igmp6_mcf_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span>	<span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span>	<span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span>	<span class="n">seq_release_net</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">igmp6_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp6&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igmp6_mc_seq_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_net_fops_create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;mcfilter6&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">igmp6_mcf_seq_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_proc_net_igmp6</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_proc_net_igmp6:</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp6&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">igmp6_proc_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;mcfilter6&quot;</span><span class="p">);</span>
	<span class="n">proc_net_remove</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;igmp6&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">igmp6_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">igmp6_proc_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">igmp6_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">inet_ctl_sock_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">,</span> <span class="n">PF_INET6</span><span class="p">,</span>
				   <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">IPPROTO_ICMPV6</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to initialize the IGMP6 control socket (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inet6_sk</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hop_limit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">igmp6_proc_init</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sock_create</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_sock_create:</span>
	<span class="n">inet_ctl_sock_destroy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__net_exit</span> <span class="nf">igmp6_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_ctl_sock_destroy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv6</span><span class="p">.</span><span class="n">igmp_sk</span><span class="p">);</span>
	<span class="n">igmp6_proc_exit</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">igmp6_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">igmp6_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">igmp6_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">igmp6_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">igmp6_net_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">igmp6_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">igmp6_net_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
