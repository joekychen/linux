<!DOCTYPE html>
<html><head><title>joekychen/linux » net › can › raw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>raw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * raw.c - Raw sockets for protocol family CAN</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2002-2007 Volkswagen Group Electronic Research</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. Neither the name of Volkswagen nor the names of its contributors</span>
<span class="cm"> *    may be used to endorse or promote products derived from this software</span>
<span class="cm"> *    without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, provided that this notice is retained in full, this</span>
<span class="cm"> * software may be distributed under the terms of the GNU General</span>
<span class="cm"> * Public License (&quot;GPL&quot;) version 2, in which case the provisions of the</span>
<span class="cm"> * GPL apply INSTEAD OF those given above.</span>
<span class="cm"> *</span>
<span class="cm"> * The provided data structures and external interfaces from this code</span>
<span class="cm"> * are not restricted to be used by modules with a GPL compatible license.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<span class="cm"> * DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/can.h&gt;</span>
<span class="cp">#include &lt;linux/can/core.h&gt;</span>
<span class="cp">#include &lt;linux/can/raw.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="cp">#define CAN_RAW_VERSION CAN_VERSION</span>
<span class="k">static</span> <span class="n">__initdata</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">banner</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">KERN_INFO</span> <span class="s">&quot;can: raw protocol (rev &quot;</span> <span class="n">CAN_RAW_VERSION</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PF_CAN raw protocol&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Urs Thuermann &lt;urs.thuermann@volkswagen.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;can-proto-1&quot;</span><span class="p">);</span>

<span class="cp">#define MASK_ALL 0</span>

<span class="cm">/*</span>
<span class="cm"> * A raw socket has a list of can_filters attached to it, each receiving</span>
<span class="cm"> * the CAN frames matching that filter.  If the filter list is empty,</span>
<span class="cm"> * no CAN frames will be received by the socket.  The default after</span>
<span class="cm"> * opening the socket, is to have one filter which receives all frames.</span>
<span class="cm"> * The filter list is allocated dynamically with the exception of the</span>
<span class="cm"> * list containing only one item.  This common case is optimized by</span>
<span class="cm"> * storing the single filter in dfilter, to avoid using dynamic memory.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">raw_sock</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bound</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">notifier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopback</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recv_own_msgs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>                 <span class="cm">/* number of active filters */</span>
	<span class="k">struct</span> <span class="n">can_filter</span> <span class="n">dfilter</span><span class="p">;</span> <span class="cm">/* default/single filter */</span>
	<span class="k">struct</span> <span class="n">can_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span> <span class="cm">/* pointer to filter(s) */</span>
	<span class="n">can_err_mask_t</span> <span class="n">err_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Return pointer to store the extra msg flags for raw_recvmsg().</span>
<span class="cm"> * We use the space of one unsigned int beyond the &#39;struct sockaddr_can&#39;</span>
<span class="cm"> * in skb-&gt;cb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="nf">raw_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span><span class="p">)</span> <span class="o">+</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)));</span>

	<span class="cm">/* return pointer after struct sockaddr_can */</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="nf">raw_sk</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raw_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">oskb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pflags</span><span class="p">;</span>

	<span class="cm">/* check the received tx sock reference */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">recv_own_msgs</span> <span class="o">&amp;&amp;</span> <span class="n">oskb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* clone the given skb to be able to enqueue it into the rcv queue */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">oskb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Put the datagram to the queue so that raw_recvmsg() can</span>
<span class="cm">	 *  get it from there.  We need to pass the interface index to</span>
<span class="cm">	 *  raw_recvmsg().  We pass a whole struct sockaddr_can in skb-&gt;cb</span>
<span class="cm">	 *  containing the interface index.</span>
<span class="cm">	 */</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span><span class="p">));</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_family</span>  <span class="o">=</span> <span class="n">AF_CAN</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="cm">/* add CAN specific message flags for raw_recvmsg() */</span>
	<span class="n">pflags</span> <span class="o">=</span> <span class="n">raw_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oskb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">MSG_DONTROUTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oskb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="n">sk</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">MSG_CONFIRM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock_queue_rcv_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_enable_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">can_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">can_rx_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_id</span><span class="p">,</span>
				      <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_mask</span><span class="p">,</span>
				      <span class="n">raw_rcv</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clean up successfully registered filters */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">can_rx_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_id</span><span class="p">,</span>
						  <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_mask</span><span class="p">,</span>
						  <span class="n">raw_rcv</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_enable_errfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="n">can_err_mask_t</span> <span class="n">err_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">can_rx_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err_mask</span> <span class="o">|</span> <span class="n">CAN_ERR_FLAG</span><span class="p">,</span>
				      <span class="n">raw_rcv</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raw_disable_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">can_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">can_rx_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_id</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">can_mask</span><span class="p">,</span>
				  <span class="n">raw_rcv</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">raw_disable_errfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					 <span class="n">can_err_mask_t</span> <span class="n">err_mask</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="n">can_rx_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err_mask</span> <span class="o">|</span> <span class="n">CAN_ERR_FLAG</span><span class="p">,</span>
				  <span class="n">raw_rcv</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">raw_disable_allfilters</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">raw_disable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">raw_disable_errfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_enable_allfilters</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_errfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">raw_disable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raw_sock</span><span class="p">,</span> <span class="n">notifier</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_CAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="cm">/* remove current filters &amp; unregister */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span><span class="p">)</span>
			<span class="n">raw_disable_allfilters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>

		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span>            <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set default filter to single entry dfilter */</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">dfilter</span><span class="p">.</span><span class="n">can_id</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">dfilter</span><span class="p">.</span><span class="n">can_mask</span> <span class="o">=</span> <span class="n">MASK_ALL</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">dfilter</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set default loopback behaviour */</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">loopback</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">recv_own_msgs</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set notifier */</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">raw_notifier</span><span class="p">;</span>

	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="cm">/* remove current filters &amp; unregister */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">raw_disable_allfilters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
				<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">raw_disable_allfilters</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>

	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sock_orphan</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">notify_enetdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span> <span class="o">==</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_CAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
			<span class="n">notify_enetdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ifindex</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

		<span class="cm">/* filters set by default/setsockopt */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_allfilters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* filters set by default/setsockopt */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_allfilters</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unregister old filters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

				<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">raw_disable_allfilters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
					<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">raw_disable_allfilters</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">ifindex</span><span class="p">;</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_enetdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_family</span>  <span class="o">=</span> <span class="n">AF_CAN</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span> <span class="o">=</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">can_filter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* dyn. alloc&#39;ed filters */</span>
	<span class="k">struct</span> <span class="n">can_filter</span> <span class="n">sfilter</span><span class="p">;</span>         <span class="cm">/* single filter */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">can_err_mask_t</span> <span class="n">err_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_CAN_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">CAN_RAW_FILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">can_filter</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">optlen</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">can_filter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* filter does not fit into dfilter =&gt; alloc space */</span>
			<span class="n">filter</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">filter</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfilter</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sfilter</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* (try to) register the new filters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfilter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span>
							 <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_fil</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* remove old filter registrations */</span>
			<span class="n">raw_disable_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* remove old filter space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>

		<span class="cm">/* link new filters to the socket */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy filter data for single filter */</span>
			<span class="n">ro</span><span class="o">-&gt;</span><span class="n">dfilter</span> <span class="o">=</span> <span class="n">sfilter</span><span class="p">;</span>
			<span class="n">filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">dfilter</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

 <span class="nl">out_fil:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_ERR_FILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">err_mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err_mask</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="n">CAN_ERR_MASK</span><span class="p">;</span>

		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">);</span>

		<span class="cm">/* remove current error mask */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">bound</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* (try to) register the new err_mask */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">raw_enable_errfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

			<span class="cm">/* remove old err_mask registration */</span>
			<span class="n">raw_disable_errfilter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* link new err_mask to the socket */</span>
		<span class="n">ro</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">=</span> <span class="n">err_mask</span><span class="p">;</span>

 <span class="nl">out_err:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_LOOPBACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_RECV_OWN_MSGS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">recv_own_msgs</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">recv_own_msgs</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">SOL_CAN_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">optname</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">CAN_RAW_FILTER</span>:
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">fsize</span> <span class="o">=</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">can_filter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">fsize</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">fsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_ERR_FILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">can_err_mask_t</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">can_err_mask_t</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_LOOPBACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAN_RAW_RECV_OWN_MSGS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">recv_own_msgs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_sock</span> <span class="o">*</span><span class="n">ro</span> <span class="o">=</span> <span class="n">raw_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_family</span> <span class="o">!=</span> <span class="n">AF_CAN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ifindex</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">can_ifindex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ifindex</span> <span class="o">=</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">ifindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">can_frame</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ifindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sock_alloc_send_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_tx_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_skb</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span>  <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">can_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ro</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">);</span>

	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">send_failed</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>

<span class="nl">free_skb:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">put_dev:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">send_failed:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noblock</span><span class="p">;</span>

	<span class="n">noblock</span> <span class="o">=</span>  <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
	<span class="n">flags</span>   <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_DONTWAIT</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">noblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">memcpy_toiovec</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock_recv_ts_and_drops</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_can</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* assign the flags that have been recorded in raw_rcv() */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">raw_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">raw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>        <span class="o">=</span> <span class="n">PF_CAN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>       <span class="o">=</span> <span class="n">raw_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>          <span class="o">=</span> <span class="n">raw_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>       <span class="o">=</span> <span class="n">sock_no_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>    <span class="o">=</span> <span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>        <span class="o">=</span> <span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>       <span class="o">=</span> <span class="n">raw_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>          <span class="o">=</span> <span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>         <span class="o">=</span> <span class="n">can_ioctl</span><span class="p">,</span>	<span class="cm">/* use can_ioctl() from af_can.c */</span>
	<span class="p">.</span><span class="n">listen</span>        <span class="o">=</span> <span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>      <span class="o">=</span> <span class="n">sock_no_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>    <span class="o">=</span> <span class="n">raw_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>    <span class="o">=</span> <span class="n">raw_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>       <span class="o">=</span> <span class="n">raw_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>       <span class="o">=</span> <span class="n">raw_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>          <span class="o">=</span> <span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span>      <span class="o">=</span> <span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">raw_proto</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;CAN_RAW&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>      <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw_sock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="n">raw_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">can_proto</span> <span class="n">raw_can_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>       <span class="o">=</span> <span class="n">SOCK_RAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">protocol</span>   <span class="o">=</span> <span class="n">CAN_RAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">raw_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prot</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">raw_proto</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">raw_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">banner</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">can_proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_can_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;can: registration of raw protocol failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">raw_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">can_proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_can_proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">raw_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">raw_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
