<!DOCTYPE html>
<html><head><title>joekychen/linux » net › bluetooth › hci_event.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hci_event.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (c) 2000-2001, 2010, Code Aurora Forum. All rights reserved.</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cm">/* Bluetooth HCI event handling. */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci_core.h&gt;</span>

<span class="cm">/* Handle HCI Event packets */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_inquiry_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">mgmt_stop_discovery_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY_CANCEL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_periodic_inq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_exit_periodic_inq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_remote_name_req_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_role_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_role_discovery</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCI_LM_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_link_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_link_policy</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_link_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_write_link_policy</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LINK_POLICY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">sent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_def_link_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_def_link_policy</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_def_link_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_DEF_LINK_POLICY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">sent</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_DEF_LINK_POLICY</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_RESET</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Reset all non-persistent flags */</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">HCI_LE_SCAN</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">BIT</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">));</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_local_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LOCAL_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_set_local_name_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="n">HCI_MAX_NAME_LENGTH</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LOCAL_NAME</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_name</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">HCI_MAX_NAME_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_auth_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">param</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="n">AUTH_ENABLED</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_auth_enable_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_encrypt_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_ENCRYPT_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">param</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_ENCRYPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_ENCRYPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_ENCRYPT_MODE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_scan_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">param</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">old_pscan</span><span class="p">,</span> <span class="n">old_iscan</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sent</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_write_scan_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_pscan</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_PSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">old_iscan</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_ISCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">&amp;</span> <span class="n">SCAN_INQUIRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_ISCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_iscan</span><span class="p">)</span>
			<span class="n">mgmt_discoverable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">,</span>
									<span class="n">to</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_iscan</span><span class="p">)</span>
		<span class="n">mgmt_discoverable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">&amp;</span> <span class="n">SCAN_PAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_pscan</span><span class="p">)</span>
			<span class="n">mgmt_connectable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_pscan</span><span class="p">)</span>
		<span class="n">mgmt_connectable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_class_of_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_class_of_dev</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s class 0x%.2x%.2x%.2x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_class_of_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_CLASS_OF_DEV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_set_class_of_dev_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_voice_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_voice_setting</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">setting</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">setting</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">voice_setting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span> <span class="o">==</span> <span class="n">setting</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s voice setting 0x%04x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_NOTIFY_VOICE_SETTING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_voice_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">__u16</span> <span class="n">setting</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_VOICE_SETTING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">setting</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">sent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span> <span class="o">==</span> <span class="n">setting</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s voice setting 0x%04x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_NOTIFY_VOICE_SETTING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_host_buffer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_HOST_BUFFER_SIZE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_ssp_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SSP_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_ssp_enable_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sent</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sent</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hci_get_inquiry_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EXT_INQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_RSSI_INQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
						<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">==</span> <span class="mh">0x0757</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">==</span> <span class="mh">0x6963</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">==</span> <span class="mh">0x09</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">==</span> <span class="mh">0x6963</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">==</span> <span class="mh">0x6965</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">==</span> <span class="mh">0x2005</span> <span class="o">&amp;&amp;</span>
						<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">==</span> <span class="mh">0x1805</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_setup_inquiry_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">hci_get_inquiry_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_INQUIRY_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_setup_event_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The second byte is 0xff instead of 0x9f (two reserved bits</span>
<span class="cm">	 * disabled) since a Broadcom 1.2 dongle doesn&#39;t respond to the</span>
<span class="cm">	 * command otherwise */</span>
	<span class="n">u8</span> <span class="n">events</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="cm">/* CSR 1.1 dongles does not accept any bitfield so don&#39;t try to set</span>
<span class="cm">	 * any event mask for pre 1.2 devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span> <span class="o">&lt;</span> <span class="n">BLUETOOTH_VER_1_2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">events</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* Flow Specification Complete */</span>
	<span class="n">events</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Inquiry Result with RSSI */</span>
	<span class="n">events</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Read Remote Extended Features Complete */</span>
	<span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* Synchronous Connection Complete */</span>
	<span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* Synchronous Connection Changed */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_RSSI_INQ</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Inquiry Result with RSSI */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SNIFF_SUBR</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* Sniff Subrating */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_PAUSE_ENC</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Encryption Key Refresh Complete */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EXT_INQ</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* Extended Inquiry Result */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_NO_FLUSH</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* Enhanced Flush Complete */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_LSTO</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Link Supervision Timeout Changed */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMPLE_PAIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* IO Capability Request */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* IO Capability Response */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* User Confirmation Request */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* User Passkey Request */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* Remote OOB Data Request */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* Simple Pairing Complete */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* User Passkey Notification */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* Keypress Notification */</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* Remote Host Supported</span>
<span class="cm">					 * Features Notification */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_LE</span><span class="p">)</span>
		<span class="n">events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* LE Meta-Event */</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_EVENT_MASK</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">events</span><span class="p">),</span> <span class="n">events</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">HCI_BREDR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_setup_event_mask</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span> <span class="o">&gt;</span> <span class="n">BLUETOOTH_VER_1_1</span><span class="p">)</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_COMMANDS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMPLE_PAIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SSP_MODE</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_write_eir</span> <span class="n">cp</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_EIR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_RSSI_INQ</span><span class="p">)</span>
		<span class="n">hci_setup_inquiry_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_INQ_TX_PWR</span><span class="p">)</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_INQ_RSP_TX_POWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EXTFEATURES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_read_local_ext_features</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">cp</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_EXT_FEATURES</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">enable</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_version</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">hci_ver</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">hci_rev</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_ver</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">lmp_ver</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lmp_subver</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">lmp_subver</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s manufacturer %d hci ver %d:%d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_rev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">hci_setup</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_VERSION</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_setup_link_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_def_link_policy</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_policy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_RSWITCH</span><span class="p">)</span>
		<span class="n">link_policy</span> <span class="o">|=</span> <span class="n">HCI_LP_RSWITCH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOLD</span><span class="p">)</span>
		<span class="n">link_policy</span> <span class="o">|=</span> <span class="n">HCI_LP_HOLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SNIFF</span><span class="p">)</span>
		<span class="n">link_policy</span> <span class="o">|=</span> <span class="n">HCI_LP_SNIFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_PARK</span><span class="p">)</span>
		<span class="n">link_policy</span> <span class="o">|=</span> <span class="n">HCI_LP_PARK</span><span class="p">;</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">link_policy</span><span class="p">);</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_DEF_LINK_POLICY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_commands</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span>
		<span class="n">hci_setup_link_policy</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_COMMANDS</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_features</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Adjust default settings according to features</span>
<span class="cm">	 * supported by device. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_3SLOT</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HCI_DM3</span> <span class="o">|</span> <span class="n">HCI_DH3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_5SLOT</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HCI_DM5</span> <span class="o">|</span> <span class="n">HCI_DH5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HV2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span>  <span class="o">|=</span> <span class="p">(</span><span class="n">HCI_HV2</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_HV2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HV3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span>  <span class="o">|=</span> <span class="p">(</span><span class="n">HCI_HV3</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_HV3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_ESCO</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_EV3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EV4</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_EV4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EV5</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_EV5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EDR_ESCO_2M</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_2EV3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EDR_ESCO_3M</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_3EV3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EDR_3S_ESCO</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESCO_2EV5</span> <span class="o">|</span> <span class="n">ESCO_3EV5</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s features 0x%.2x%.2x%.2x%.2x%.2x%.2x%.2x%.2x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_set_le_support</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_le_host_supported</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">le</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">simul</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMUL_LE_BR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">le</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">host_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOST_LE</span><span class="p">))</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LE_HOST_SUPPORTED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_ext_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_ext_features</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">host_features</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_LE</span><span class="p">)</span>
		<span class="n">hci_set_le_support</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_EXT_FEATURES</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_flow_control_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_flow_control_mode</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_FLOW_CONTROL_MODE</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_buffer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_buffer_size</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_mtu</span>  <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">acl_mtu</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_mtu</span>  <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">sco_mtu</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">acl_max_pkt</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">sco_max_pkt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_QUIRK_FIXUP_BUFFER_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_mtu</span>  <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s acl mtu %d:%d sco mtu %d:%d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_mtu</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_mtu</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_bd_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_bd_addr</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_BD_ADDR</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_data_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_data_block_size</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_mtu</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_acl_len</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">num_blocks</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num_blocks</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s blk mtu %d cnt %d len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_mtu</span><span class="p">,</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_DATA_BLOCK_SIZE</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_ca_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_CA_TIMEOUT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_amp_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_amp_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_status</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">amp_status</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_total_bw</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">total_bw</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_max_bw</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_bw</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_min_latency</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">min_latency</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_max_pdu</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_pdu</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_type</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">amp_type</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_pal_cap</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">pal_cap</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_assoc_size</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_assoc_size</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_be_flush_to</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">be_flush_to</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">amp_max_flush_to</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">max_flush_to</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_AMP_INFO</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_delete_stored_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DELETE_STORED_LINK_KEY</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_set_event_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_EVENT_MASK</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_write_inquiry_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_INQUIRY_MODE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_inq_rsp_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_inq_rsp_tx_power</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">inq_tx_power</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">;</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_INQ_RSP_TX_POWER</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_set_event_flt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_EVENT_FLT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_pin_code_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_pin_code_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_pin_code_reply</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_pin_code_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_PIN_CODE_REPLY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pin_length</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">pin_len</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_pin_code_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_pin_code_neg_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_pin_code_neg_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span>
								<span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_le_read_buffer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_le_read_buffer_size</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">le_mtu</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">le_max_pkt</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s le mtu %d:%d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_READ_BUFFER_SIZE</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_user_confirm_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_user_confirm_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_user_confirm_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						 <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_user_confirm_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_user_confirm_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_user_confirm_neg_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span>
						     <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_user_passkey_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_user_confirm_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_user_passkey_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_user_passkey_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_user_confirm_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_user_passkey_neg_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span>
						     <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_read_local_oob_data_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_read_local_oob_data</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">mgmt_read_local_oob_data_reply_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span>
						<span class="n">rp</span><span class="o">-&gt;</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_le_set_scan_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_PARAM</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">mgmt_start_discovery_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_le_set_scan_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_set_scan_enable</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LE_SCANNING_ENABLED</span>:
		<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="n">mgmt_start_discovery_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_LE_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_FINDING</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LE_SCANNING_DISABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="n">mgmt_stop_discovery_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_LE_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DISCOV_TYPE_INTERLEAVED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">DISCOVERY_FINDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mgmt_interleaved_discovery</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
			<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Used reserved LE_Scan_Enable param %d&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_le_ltk_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_le_ltk_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_LTK_REPLY</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cc_le_ltk_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_rp_le_ltk_neg_reply</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_LTK_NEG_REPLY</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_cc_write_le_host_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_le_host_supported</span> <span class="o">*</span><span class="n">sent</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LE_HOST_SUPPORTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sent</span><span class="o">-&gt;</span><span class="n">le</span><span class="p">)</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">host_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LMP_HOST_LE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">host_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LMP_HOST_LE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mgmt_le_enable_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">le</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LE_HOST_SUPPORTED</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_cs_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">mgmt_start_discovery_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_FINDING</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_cs_create_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_create_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_CREATE_CONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s bdaddr %s conn %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">),</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mh">0x0c</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
				<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;No memory for new connection&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_add_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_add_sco</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">acl</span><span class="p">,</span> <span class="o">*</span><span class="n">sco</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_ADD_SCO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s handle %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">acl</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sco</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sco</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>

			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">sco</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_auth_requested</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_auth_requested</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_AUTH_REQUESTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_set_conn_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_set_conn_encrypt</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_CONN_ENCRYPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_outgoing_auth_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span> <span class="o">||</span> <span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_SDP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only request authentication for SSP connections or non-SSP</span>
<span class="cm">	 * devices with sec_level HIGH or if MITM protection is requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_ssp_enabled</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">!=</span> <span class="n">BT_SECURITY_HIGH</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hci_resolve_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_remote_name_req</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">pscan_mode</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">clock_offset</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_NAME_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hci_resolve_next_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">discov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">,</span> <span class="n">NAME_NEEDED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hci_resolve_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_PENDING</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_check_pending_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">discov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mgmt_device_connected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				      <span class="n">name_len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DISCOVERY_STOPPING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">discov_complete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DISCOVERY_RESOLVING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">NAME_PENDING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_KNOWN</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="n">mgmt_remote_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
					 <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rssi</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hci_resolve_next_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">discov_complete:</span>
	<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_remote_name_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_remote_name_req</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* If successful wait for the name req complete event before</span>
<span class="cm">	 * checking for the need to do authentication */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_NAME_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">hci_check_pending_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_outgoing_auth_needed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_auth_requested</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_AUTH_REQUESTED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_read_remote_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_read_remote_features</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_REMOTE_FEATURES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_read_remote_ext_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_read_remote_ext_features</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_REMOTE_EXT_FEATURES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_setup_sync_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_setup_sync_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">acl</span><span class="p">,</span> <span class="o">*</span><span class="n">sco</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SETUP_SYNC_CONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s handle %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">acl</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sco</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sco</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>

			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">sco</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_sniff_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_sniff_mode</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SNIFF_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_SCO_SETUP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">hci_sco_setup</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_exit_sniff_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_exit_sniff_mode</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_EXIT_SNIFF_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_SCO_SETUP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">hci_sco_setup</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_disconnect</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DISCONNECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">mgmt_disconnect_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_le_create_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_create_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_CREATE_CONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s bdaddr %s conn %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">),</span>
		<span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
			<span class="n">mgmt_connect_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">peer_addr_type</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;No memory for new connection&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cs_le_start_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_inquiry_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">discov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_req_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DISCOVERY_FINDING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">,</span> <span class="n">NAME_NEEDED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="n">hci_resolve_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_PENDING</span><span class="p">;</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_RESOLVING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_inquiry_result_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_rsp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s num_rsp %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_rsp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">num_rsp</span><span class="p">;</span> <span class="n">num_rsp</span><span class="o">--</span><span class="p">,</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_period_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_mode</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">rssi</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">name_known</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_update</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">);</span>
		<span class="n">mgmt_device_found</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">!</span><span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_conn_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span> <span class="o">!=</span> <span class="n">SCO_LINK</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ESCO_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCO_LINK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONFIG</span><span class="p">;</span>
			<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_DISCONN_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>

		<span class="n">hci_conn_hold_device</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">hci_conn_add_sysfs</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_AUTH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_ENCRYPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">;</span>

		<span class="cm">/* Get remote features */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_read_remote_features</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_REMOTE_FEATURES</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Set packet type for incoming connection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span> <span class="o">&lt;</span> <span class="n">BLUETOOTH_VER_2_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_change_conn_ptype</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_CHANGE_CONN_PTYPE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span>
			<span class="n">mgmt_connect_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span>
		<span class="n">hci_sco_setup</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span> <span class="o">!=</span> <span class="n">ACL_LINK</span><span class="p">)</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_conn_request</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_mode</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s bdaddr %s type 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">),</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">|=</span> <span class="n">hci_proto_connect_ind</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCI_LM_ACCEPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">hci_blacklist_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Connection accepted */</span>
		<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;No memory for new connection&quot;</span><span class="p">);</span>
				<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT</span><span class="p">;</span>

		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span> <span class="o">==</span> <span class="n">ACL_LINK</span> <span class="o">||</span> <span class="o">!</span><span class="n">lmp_esco_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_accept_conn_req</span> <span class="n">cp</span><span class="p">;</span>

			<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lmp_rswitch_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCI_LM_MASTER</span><span class="p">))</span>
				<span class="n">cp</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Become master */</span>
			<span class="k">else</span>
				<span class="n">cp</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* Remain slave */</span>

			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_ACCEPT_CONN_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_accept_sync_conn_req</span> <span class="n">cp</span><span class="p">;</span>

			<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>

			<span class="n">cp</span><span class="p">.</span><span class="n">tx_bandwidth</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00001f40</span><span class="p">);</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">rx_bandwidth</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00001f40</span><span class="p">);</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">max_latency</span>    <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">content_format</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span><span class="p">);</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">retrans_effort</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_ACCEPT_SYNC_CONN_REQ</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Connection rejected */</span>
		<span class="k">struct</span> <span class="n">hci_cp_reject_conn_req</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">HCI_ERROR_REJ_BAD_ADDR</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REJECT_CONN_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_disconn_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_disconn_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mgmt_disconnect_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mgmt_device_disconnected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						 <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">flush_key</span><span class="p">)</span>
			<span class="n">hci_remove_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">hci_proto_disconn_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_auth_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_auth_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_ssp_enabled</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_REAUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BT_INFO</span><span class="p">(</span><span class="s">&quot;re-auth of legacy device is not possible.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_AUTH</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mgmt_auth_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span>
				 <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_REAUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">hci_conn_ssp_enabled</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_set_conn_encrypt</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>  <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_CONN_ENCRYPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
									<span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>
			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hci_auth_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_DISCONN_TIMEOUT</span><span class="p">;</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hci_cp_set_conn_encrypt</span> <span class="n">cp</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>  <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_CONN_ENCRYPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
									<span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">hci_encrypt_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_name_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_remote_name</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">check_auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hci_check_pending_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">strnlen</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">HCI_MAX_NAME_LENGTH</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">hci_check_pending_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">check_auth:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_outgoing_auth_needed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_auth_requested</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_AUTH_REQUESTED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_encrypt_change_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_encrypt_change</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">encrypt</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Encryption implies authentication */</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_AUTH</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCI_LM_ENCRYPT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_acl_disconn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">HCI_ERROR_AUTH_FAILURE</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>

			<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hci_encrypt_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">encrypt</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_change_link_key_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_change_link_key_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_SECURE</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">hci_key_change_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_features_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_remote_features</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">lmp_ssp_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lmp_ssp_capable</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_read_remote_ext_features</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_REMOTE_EXT_FEATURES</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_remote_name_req</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_NAME_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mgmt_device_connected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_outgoing_auth_needed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_version_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_qos_setup_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_cmd_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_cmd_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">opcode</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_OP_INQUIRY_CANCEL</span>:
		<span class="n">hci_cc_inquiry_cancel</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_PERIODIC_INQ</span>:
		<span class="n">hci_cc_periodic_inq</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_EXIT_PERIODIC_INQ</span>:
		<span class="n">hci_cc_exit_periodic_inq</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_REMOTE_NAME_REQ_CANCEL</span>:
		<span class="n">hci_cc_remote_name_req_cancel</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_ROLE_DISCOVERY</span>:
		<span class="n">hci_cc_role_discovery</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LINK_POLICY</span>:
		<span class="n">hci_cc_read_link_policy</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_LINK_POLICY</span>:
		<span class="n">hci_cc_write_link_policy</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_DEF_LINK_POLICY</span>:
		<span class="n">hci_cc_read_def_link_policy</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_DEF_LINK_POLICY</span>:
		<span class="n">hci_cc_write_def_link_policy</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_RESET</span>:
		<span class="n">hci_cc_reset</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_LOCAL_NAME</span>:
		<span class="n">hci_cc_write_local_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_NAME</span>:
		<span class="n">hci_cc_read_local_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span>:
		<span class="n">hci_cc_write_auth_enable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_ENCRYPT_MODE</span>:
		<span class="n">hci_cc_write_encrypt_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span>:
		<span class="n">hci_cc_write_scan_enable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_CLASS_OF_DEV</span>:
		<span class="n">hci_cc_read_class_of_dev</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_CLASS_OF_DEV</span>:
		<span class="n">hci_cc_write_class_of_dev</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_VOICE_SETTING</span>:
		<span class="n">hci_cc_read_voice_setting</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_VOICE_SETTING</span>:
		<span class="n">hci_cc_write_voice_setting</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_HOST_BUFFER_SIZE</span>:
		<span class="n">hci_cc_host_buffer_size</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_SSP_MODE</span>:
		<span class="n">hci_cc_write_ssp_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_VERSION</span>:
		<span class="n">hci_cc_read_local_version</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_COMMANDS</span>:
		<span class="n">hci_cc_read_local_commands</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_FEATURES</span>:
		<span class="n">hci_cc_read_local_features</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_EXT_FEATURES</span>:
		<span class="n">hci_cc_read_local_ext_features</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_BUFFER_SIZE</span>:
		<span class="n">hci_cc_read_buffer_size</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_BD_ADDR</span>:
		<span class="n">hci_cc_read_bd_addr</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_DATA_BLOCK_SIZE</span>:
		<span class="n">hci_cc_read_data_block_size</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_CA_TIMEOUT</span>:
		<span class="n">hci_cc_write_ca_timeout</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_FLOW_CONTROL_MODE</span>:
		<span class="n">hci_cc_read_flow_control_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_AMP_INFO</span>:
		<span class="n">hci_cc_read_local_amp_info</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_DELETE_STORED_LINK_KEY</span>:
		<span class="n">hci_cc_delete_stored_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_SET_EVENT_MASK</span>:
		<span class="n">hci_cc_set_event_mask</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_INQUIRY_MODE</span>:
		<span class="n">hci_cc_write_inquiry_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_INQ_RSP_TX_POWER</span>:
		<span class="n">hci_cc_read_inq_rsp_tx_power</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_SET_EVENT_FLT</span>:
		<span class="n">hci_cc_set_event_flt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_PIN_CODE_REPLY</span>:
		<span class="n">hci_cc_pin_code_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_PIN_CODE_NEG_REPLY</span>:
		<span class="n">hci_cc_pin_code_neg_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_LOCAL_OOB_DATA</span>:
		<span class="n">hci_cc_read_local_oob_data_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_READ_BUFFER_SIZE</span>:
		<span class="n">hci_cc_le_read_buffer_size</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_USER_CONFIRM_REPLY</span>:
		<span class="n">hci_cc_user_confirm_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_USER_CONFIRM_NEG_REPLY</span>:
		<span class="n">hci_cc_user_confirm_neg_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_USER_PASSKEY_REPLY</span>:
		<span class="n">hci_cc_user_passkey_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_USER_PASSKEY_NEG_REPLY</span>:
		<span class="n">hci_cc_user_passkey_neg_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_SET_SCAN_PARAM</span>:
		<span class="n">hci_cc_le_set_scan_param</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span>:
		<span class="n">hci_cc_le_set_scan_enable</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_LTK_REPLY</span>:
		<span class="n">hci_cc_le_ltk_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_LTK_NEG_REPLY</span>:
		<span class="n">hci_cc_le_ltk_neg_reply</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_WRITE_LE_HOST_SUPPORTED</span>:
		<span class="n">hci_cc_write_le_host_supported</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">HCI_OP_NOP</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ncmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">))</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_cmd_status_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_cmd_status</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">opcode</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_OP_INQUIRY</span>:
		<span class="n">hci_cs_inquiry</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_CREATE_CONN</span>:
		<span class="n">hci_cs_create_conn</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_ADD_SCO</span>:
		<span class="n">hci_cs_add_sco</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_AUTH_REQUESTED</span>:
		<span class="n">hci_cs_auth_requested</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_SET_CONN_ENCRYPT</span>:
		<span class="n">hci_cs_set_conn_encrypt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_REMOTE_NAME_REQ</span>:
		<span class="n">hci_cs_remote_name_req</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_REMOTE_FEATURES</span>:
		<span class="n">hci_cs_read_remote_features</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_READ_REMOTE_EXT_FEATURES</span>:
		<span class="n">hci_cs_read_remote_ext_features</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_SETUP_SYNC_CONN</span>:
		<span class="n">hci_cs_setup_sync_conn</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_SNIFF_MODE</span>:
		<span class="n">hci_cs_sniff_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_EXIT_SNIFF_MODE</span>:
		<span class="n">hci_cs_exit_sniff_mode</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_DISCONNECT</span>:
		<span class="n">hci_cs_disconnect</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_CREATE_CONN</span>:
		<span class="n">hci_cs_le_create_conn</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_OP_LE_START_ENC</span>:
		<span class="n">hci_cs_le_start_enc</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">HCI_OP_NOP</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ncmd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">))</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_role_change_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_role_change</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCI_LM_MASTER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_RSWITCH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">hci_role_switch_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_num_comp_pkts_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_num_comp_pkts</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span> <span class="o">!=</span> <span class="n">HCI_FLOW_CTL_MODE_PACKET_BASED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Wrong event for mode %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_comp_pkts_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s bad parameters&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s num_hndl %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_comp_pkts_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
		<span class="n">__u16</span>  <span class="n">handle</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">count</span>  <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACL_LINK</span>:
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">)</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LE_LINK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">)</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">)</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SCO_LINK</span>:
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span><span class="p">)</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown type %d conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_num_comp_blocks_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_num_comp_blocks</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span> <span class="o">!=</span> <span class="n">HCI_FLOW_CTL_MODE_BLOCK_BASED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Wrong event for mode %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_comp_blocks_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s bad parameters&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s num_blocks %d num_hndl %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_blocks</span><span class="p">,</span>
								<span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">num_hndl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_comp_blocks_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
		<span class="n">__u16</span>  <span class="n">handle</span><span class="p">,</span> <span class="n">block_count</span><span class="p">;</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">block_count</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">-=</span> <span class="n">block_count</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACL_LINK</span>:
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">+=</span> <span class="n">block_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num_blocks</span><span class="p">)</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num_blocks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown type %d conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_mode_change_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_mode_change</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HCI_CM_ACTIVE</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_SCO_SETUP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">hci_sco_setup</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_pin_code_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_pin_code_req</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_PAIRING_TIMEOUT</span><span class="p">;</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">secure</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span>
			<span class="n">secure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">secure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mgmt_pin_code_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">secure</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_link_key_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_link_key_req</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_link_key_reply</span> <span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LINK_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">hci_find_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s link key not found for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
							<span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s found key type %u for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
							<span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_DEBUG_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_LK_DEBUG_COMBINATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s ignoring debug key&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_LK_UNAUTH_COMBINATION</span> <span class="o">&amp;&amp;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s ignoring unauthenticated key&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_LK_COMBINATION</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">pin_len</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s ignoring key unauthenticated for high \</span>
<span class="s">							security&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pin_length</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">pin_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">link_key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LINK_KEY_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">not_found:</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LINK_KEY_NEG_REPLY</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_link_key_notify_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_link_key_notify</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pin_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_DISCONN_TIMEOUT</span><span class="p">;</span>
		<span class="n">pin_len</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pin_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">!=</span> <span class="n">HCI_LK_CHANGED_COMBINATION</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">key_type</span><span class="p">;</span>

		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LINK_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">hci_add_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_key</span><span class="p">,</span>
							<span class="n">ev</span><span class="o">-&gt;</span><span class="n">key_type</span><span class="p">,</span> <span class="n">pin_len</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_clock_offset_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_clock_offset</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

		<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>
			<span class="n">ie</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_pkt_type_change_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_pkt_type_change</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_pscan_rep_mode_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_pscan_rep_mode</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_inquiry_result_with_rssi_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rsp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s num_rsp %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_rsp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_rsp</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_info_with_rssi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_info_with_rssi_and_pscan_mode</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">num_rsp</span><span class="p">;</span> <span class="n">num_rsp</span><span class="o">--</span><span class="p">,</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_period_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_mode</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">rssi</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

			<span class="n">name_known</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_update</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
							      <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">);</span>
			<span class="n">mgmt_device_found</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span>
					  <span class="o">!</span><span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_info_with_rssi</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">num_rsp</span><span class="p">;</span> <span class="n">num_rsp</span><span class="o">--</span><span class="p">,</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_period_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">rssi</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">name_known</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_update</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
							      <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">);</span>
			<span class="n">mgmt_device_found</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span>
					  <span class="o">!</span><span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_ext_features_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_remote_ext_features</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

		<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span>
			<span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOST_SSP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOST_SSP</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_remote_name_req</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_NAME_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mgmt_device_connected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_outgoing_auth_needed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sync_conn_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_sync_conn_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">link_type</span> <span class="o">==</span> <span class="n">ESCO_LINK</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ESCO_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCO_LINK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span>  <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>

		<span class="n">hci_conn_hold_device</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">hci_conn_add_sysfs</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x11</span>:	<span class="cm">/* Unsupported Feature or Parameter Value */</span>
	<span class="k">case</span> <span class="mh">0x1c</span>:	<span class="cm">/* SCO interval rejected */</span>
	<span class="k">case</span> <span class="mh">0x1a</span>:	<span class="cm">/* Unsupported Remote Feature */</span>
	<span class="k">case</span> <span class="mh">0x1f</span>:	<span class="cm">/* Unspecified error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">&amp;</span> <span class="n">SCO_ESCO_MASK</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">&amp;</span> <span class="n">EDR_ESCO_MASK</span><span class="p">);</span>
			<span class="n">hci_setup_sync</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>

	<span class="nl">default:</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sync_conn_changed_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sniff_subrate_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_sniff_subrate</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_extended_inquiry_result_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extended_inquiry_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_rsp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">eir_len</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s num_rsp %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_rsp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">num_rsp</span><span class="p">;</span> <span class="n">num_rsp</span><span class="o">--</span><span class="p">,</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">name_known</span><span class="p">,</span> <span class="n">ssp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_period_mode</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">rssi</span>		<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">name_known</span> <span class="o">=</span> <span class="n">eir_has_data_type</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						       <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
						       <span class="n">EIR_NAME_COMPLETE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">name_known</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">name_known</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_update</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">name_known</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ssp</span><span class="p">);</span>
		<span class="n">eir_len</span> <span class="o">=</span> <span class="n">eir_get_length</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">mgmt_device_found</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span> <span class="o">!</span><span class="n">name_known</span><span class="p">,</span>
				  <span class="n">ssp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">eir_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_key_refresh_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_key_refresh_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %u handle %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
	       <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_acl_disconn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">HCI_ERROR_AUTH_FAILURE</span><span class="p">);</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>

		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hci_auth_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_DISCONN_TIMEOUT</span><span class="p">;</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">hci_get_auth_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If remote requests dedicated bonding follow that lead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If both remote and local IO capabilities allow MITM</span>
<span class="cm">		 * protection then require it, otherwise don&#39;t */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_cap</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If remote requests no-bonding follow that lead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">|</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_io_capa_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_io_capa_request</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="n">HCI_AT_NO_BONDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_io_capability_reply</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="cm">/* Change the IO capability from KeyboardDisplay</span>
<span class="cm">		 * to DisplayYesNo as it is not supported by BT spec. */</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span>
						<span class="mh">0x01</span> <span class="o">:</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">hci_get_auth_req</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">authentication</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_REMOTE_OOB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="n">hci_find_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">oob_data</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">oob_data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_IO_CAPABILITY_REPLY</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_io_capability_neg_reply</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">HCI_ERROR_PAIRING_NOT_ALLOWED</span><span class="p">;</span>

		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_IO_CAPABILITY_NEG_REPLY</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_io_capa_reply_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_io_capa_reply</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_cap</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">authentication</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">oob_data</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_REMOTE_OOB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_user_confirm_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_user_confirm_req</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loc_mitm</span><span class="p">,</span> <span class="n">rem_mitm</span><span class="p">,</span> <span class="n">confirm_hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">loc_mitm</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">rem_mitm</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="cm">/* If we require MITM but the remote device can&#39;t provide that</span>
<span class="cm">	 * (it has NoInputNoOutput) then reject the confirmation</span>
<span class="cm">	 * request. The only exception is when we&#39;re dedicated bonding</span>
<span class="cm">	 * initiators (connect_cfm_cb set) since then we always have the MITM</span>
<span class="cm">	 * bit set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span> <span class="o">&amp;&amp;</span> <span class="n">loc_mitm</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_cap</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Rejecting request: remote device can&#39;t provide MITM&quot;</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_USER_CONFIRM_NEG_REPLY</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If no side requires MITM protection; auto-accept */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">loc_mitm</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_cap</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">rem_mitm</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* If we&#39;re not the initiators request authorization to</span>
<span class="cm">		 * proceed from user space (mgmt_user_confirm with</span>
<span class="cm">		 * confirm_hint set to 1). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Confirming auto-accept as acceptor&quot;</span><span class="p">);</span>
			<span class="n">confirm_hint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">confirm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Auto-accept of user confirmation with %ums delay&quot;</span><span class="p">,</span>
						<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">auto_accept_delay</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">auto_accept_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">auto_accept_delay</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auto_accept_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">delay</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_USER_CONFIRM_REPLY</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">confirm:</span>
	<span class="n">mgmt_user_confirm_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">passkey</span><span class="p">,</span>
				  <span class="n">confirm_hint</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_user_passkey_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_user_passkey_req</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_user_passkey_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_simple_pair_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_simple_pair_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="cm">/* To avoid duplicate auth_failed events to user space we check</span>
<span class="cm">	 * the HCI_CONN_AUTH_PEND flag which will be set if we</span>
<span class="cm">	 * initiated the authentication. A traditional auth_complete</span>
<span class="cm">	 * event gets always produced as initiator and is also mapped to</span>
<span class="cm">	 * the mgmt_auth_failed event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_auth_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span>
				 <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_host_features_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_remote_host_features</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOST_SSP</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_remote_oob_data_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_remote_oob_data_request</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hci_find_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_remote_oob_data_reply</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">hash</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">randomizer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">randomizer</span><span class="p">));</span>

		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_OOB_DATA_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
									<span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_remote_oob_data_neg_reply</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_OOB_DATA_NEG_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
									<span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_le_conn_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_le_conn_complete</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;No memory for new connection&quot;</span><span class="p">);</span>
			<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_connect_failed</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mgmt_device_connected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_LOW</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECTED</span><span class="p">;</span>

	<span class="n">hci_conn_hold_device</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">hci_conn_add_sysfs</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_le_adv_report_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">num_reports</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">rssi</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num_reports</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_ev_le_advertising_info</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">];</span>
		<span class="n">mgmt_device_found</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">bdaddr_type</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_le_ltk_request_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_le_ltk_req</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_ltk_reply</span> <span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_ltk_neg_reply</span> <span class="n">neg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">ltk</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s handle %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

	<span class="n">ltk</span> <span class="o">=</span> <span class="n">hci_find_ltk</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ediv</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">random</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ltk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">ltk</span><span class="p">,</span> <span class="n">ltk</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ltk</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ltk</span><span class="o">-&gt;</span><span class="n">authenticated</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">;</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_LTK_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ltk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HCI_SMP_STK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ltk</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ltk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">not_found:</span>
	<span class="n">neg</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_LTK_NEG_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">neg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">neg</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_le_meta_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_ev_le_meta</span> <span class="o">*</span><span class="n">le_ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">le_ev</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le_ev</span><span class="o">-&gt;</span><span class="n">subevent</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_EV_LE_CONN_COMPLETE</span>:
		<span class="n">hci_le_conn_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_LE_ADVERTISING_REPORT</span>:
		<span class="n">hci_le_adv_report_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_LE_LTK_REQ</span>:
		<span class="n">hci_le_ltk_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_event_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_event_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">event</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">evt</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_EVENT_HDR_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_EV_INQUIRY_COMPLETE</span>:
		<span class="n">hci_inquiry_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_INQUIRY_RESULT</span>:
		<span class="n">hci_inquiry_result_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CONN_COMPLETE</span>:
		<span class="n">hci_conn_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CONN_REQUEST</span>:
		<span class="n">hci_conn_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_DISCONN_COMPLETE</span>:
		<span class="n">hci_disconn_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_AUTH_COMPLETE</span>:
		<span class="n">hci_auth_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_NAME</span>:
		<span class="n">hci_remote_name_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_ENCRYPT_CHANGE</span>:
		<span class="n">hci_encrypt_change_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CHANGE_LINK_KEY_COMPLETE</span>:
		<span class="n">hci_change_link_key_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_FEATURES</span>:
		<span class="n">hci_remote_features_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_VERSION</span>:
		<span class="n">hci_remote_version_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_QOS_SETUP_COMPLETE</span>:
		<span class="n">hci_qos_setup_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CMD_COMPLETE</span>:
		<span class="n">hci_cmd_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CMD_STATUS</span>:
		<span class="n">hci_cmd_status_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_ROLE_CHANGE</span>:
		<span class="n">hci_role_change_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_NUM_COMP_PKTS</span>:
		<span class="n">hci_num_comp_pkts_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_MODE_CHANGE</span>:
		<span class="n">hci_mode_change_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_PIN_CODE_REQ</span>:
		<span class="n">hci_pin_code_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_LINK_KEY_REQ</span>:
		<span class="n">hci_link_key_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_LINK_KEY_NOTIFY</span>:
		<span class="n">hci_link_key_notify_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_CLOCK_OFFSET</span>:
		<span class="n">hci_clock_offset_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_PKT_TYPE_CHANGE</span>:
		<span class="n">hci_pkt_type_change_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_PSCAN_REP_MODE</span>:
		<span class="n">hci_pscan_rep_mode_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_INQUIRY_RESULT_WITH_RSSI</span>:
		<span class="n">hci_inquiry_result_with_rssi_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_EXT_FEATURES</span>:
		<span class="n">hci_remote_ext_features_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_SYNC_CONN_COMPLETE</span>:
		<span class="n">hci_sync_conn_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_SYNC_CONN_CHANGED</span>:
		<span class="n">hci_sync_conn_changed_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_SNIFF_SUBRATE</span>:
		<span class="n">hci_sniff_subrate_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_EXTENDED_INQUIRY_RESULT</span>:
		<span class="n">hci_extended_inquiry_result_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_KEY_REFRESH_COMPLETE</span>:
		<span class="n">hci_key_refresh_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_IO_CAPA_REQUEST</span>:
		<span class="n">hci_io_capa_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_IO_CAPA_REPLY</span>:
		<span class="n">hci_io_capa_reply_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_USER_CONFIRM_REQUEST</span>:
		<span class="n">hci_user_confirm_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_USER_PASSKEY_REQUEST</span>:
		<span class="n">hci_user_passkey_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_SIMPLE_PAIR_COMPLETE</span>:
		<span class="n">hci_simple_pair_complete_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_HOST_FEATURES</span>:
		<span class="n">hci_remote_host_features_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_LE_META</span>:
		<span class="n">hci_le_meta_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_REMOTE_OOB_DATA_REQUEST</span>:
		<span class="n">hci_remote_oob_data_request_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_EV_NUM_COMP_BLOCKS</span>:
		<span class="n">hci_num_comp_blocks_evt</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s event 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">evt_rx</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
