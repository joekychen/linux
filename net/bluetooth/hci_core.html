<!DOCTYPE html>
<html><head><title>joekychen/linux » net › bluetooth › hci_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hci_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (C) 2000-2001 Qualcomm Incorporated</span>
<span class="cm">   Copyright (C) 2011 ProFUSION Embedded Systems</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cm">/* Bluetooth HCI core. */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci_core.h&gt;</span>

<span class="cp">#define AUTO_OFF_TIMEOUT 2000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hci_rx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hci_cmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hci_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cm">/* HCI device list */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hci_dev_list</span><span class="p">);</span>
<span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

<span class="cm">/* HCI callback list */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hci_cb_list</span><span class="p">);</span>
<span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>

<span class="cm">/* ---- HCI notifications ---- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hci_sock_dev_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---- HCI requests ---- */</span>

<span class="kt">void</span> <span class="nf">hci_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s command 0x%04x result 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="cm">/* If this is the init phase check if the completed command matches</span>
<span class="cm">	 * the last init command, and if not just return.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">init_last_cmd</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_command_hdr</span> <span class="o">*</span><span class="n">sent</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">sent</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* Some CSR based controllers generate a spontaneous</span>
<span class="cm">		 * reset complete event during init and any pending</span>
<span class="cm">		 * command will never be completed. In such a case we</span>
<span class="cm">		 * need to resend whatever was the last sent</span>
<span class="cm">		 * command.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">HCI_OP_RESET</span> <span class="o">||</span> <span class="n">opcode</span> <span class="o">==</span> <span class="n">HCI_OP_RESET</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">==</span> <span class="n">HCI_REQ_PEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="n">HCI_REQ_DONE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_wait_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_req_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s err 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">==</span> <span class="n">HCI_REQ_PEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="n">HCI_REQ_CANCELED</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_wait_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Execute request and wait for completion. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hci_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">),</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s start&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="n">HCI_REQ_PEND</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

	<span class="n">req</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_REQ_DONE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">bt_to_errno</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_REQ_CANCELED</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_result</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s end: err %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hci_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">),</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="cm">/* Serialize all requests */</span>
	<span class="n">hci_req_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_reset_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %ld&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>

	<span class="cm">/* Reset device */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bredr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_delete_stored_link_key</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">flt_type</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span> <span class="o">=</span> <span class="n">HCI_FLOW_CTL_MODE_PACKET_BASED</span><span class="p">;</span>

	<span class="cm">/* Mandatory initialization */</span>

	<span class="cm">/* Reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_QUIRK_NO_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Read Local Supported Features */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_FEATURES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Local Version */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Buffer Size (ACL mtu, max pkt, etc.) */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read BD Address */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_BD_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Class of Device */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_CLASS_OF_DEV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Local Name */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Voice Setting */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_VOICE_SETTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Optional initialization */</span>

	<span class="cm">/* Clear Event Filters */</span>
	<span class="n">flt_type</span> <span class="o">=</span> <span class="n">HCI_FLT_CLEAR_ALL</span><span class="p">;</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_EVENT_FLT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flt_type</span><span class="p">);</span>

	<span class="cm">/* Connection accept timeout ~20 secs */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x7d00</span><span class="p">);</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_CA_TIMEOUT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">delete_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DELETE_STORED_LINK_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span> <span class="o">=</span> <span class="n">HCI_FLOW_CTL_MODE_BLOCK_BASED</span><span class="p">;</span>

	<span class="cm">/* Reset */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Local Version */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Read Local AMP Info */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_AMP_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_init_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %ld&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>

	<span class="cm">/* Driver initialization */</span>

	<span class="cm">/* Special commands */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">driver_init</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">HCI_COMMAND_PKT</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">driver_init</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_BREDR</span>:
		<span class="n">bredr_init</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_AMP</span>:
		<span class="n">amp_init</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown device type %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_le_init_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Read LE buffer size */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_READ_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_scan_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">scan</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scan</span><span class="p">);</span>

	<span class="cm">/* Inquiry and Page scans */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_auth_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">auth</span><span class="p">);</span>

	<span class="cm">/* Authentication */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_encrypt_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">encrypt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>

	<span class="cm">/* Encryption */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_ENCRYPT_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_linkpol_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

	<span class="cm">/* Default link policy */</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_DEF_LINK_POLICY</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get HCI device by index.</span>
<span class="cm"> * Device is held on return. */</span>
<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="nf">hci_dev_get</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_hold</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---- Inquiry support ---- */</span>

<span class="n">bool</span> <span class="nf">hci_discovery_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">discov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">discov</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISCOVERY_FINDING</span>:
	<span class="k">case</span> <span class="n">DISCOVERY_RESOLVING</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_discovery_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s state %u -&gt; %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISCOVERY_STOPPED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DISCOVERY_STARTING</span><span class="p">)</span>
			<span class="n">mgmt_discovering</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISCOVERY_STARTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISCOVERY_FINDING</span>:
		<span class="n">mgmt_discovering</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISCOVERY_RESOLVING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISCOVERY_STOPPING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inquiry_cache_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">,</span> <span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">unknown</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="nf">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;cache %p, %s&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">,</span> <span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="nf">hci_inquiry_cache_lookup_unknown</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;cache %p, %s&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">unknown</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="nf">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
						       <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;cache %p bdaddr %s state %d&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">),</span> <span class="n">state</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_inquiry_cache_update_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">!=</span> <span class="n">NAME_PENDING</span> <span class="o">&amp;&amp;</span>
				<span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rssi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">abs</span><span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rssi</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">hci_inquiry_cache_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inquiry_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">name_known</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;cache %p, %s&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ssp_mode</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span> <span class="o">&amp;&amp;</span> <span class="n">ssp</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ssp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">==</span> <span class="n">NAME_NEEDED</span> <span class="o">&amp;&amp;</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">!=</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
			<span class="n">hci_inquiry_cache_update_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">update</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Entry not in the cache. Add new one. */</span>
	<span class="n">ie</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_known</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_KNOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_NOT_KNOWN</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">unknown</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">update:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name_known</span> <span class="o">&amp;&amp;</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">!=</span> <span class="n">NAME_KNOWN</span> <span class="o">&amp;&amp;</span>
					<span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">!=</span> <span class="n">NAME_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_KNOWN</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
	<span class="n">ie</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">cache</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">==</span> <span class="n">NAME_NOT_KNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_cache_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">,</span> <span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pscan_period_mode</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pscan_mode</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pscan_mode</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">clock_offset</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">clock_offset</span><span class="p">;</span>

		<span class="n">info</span><span class="o">++</span><span class="p">;</span>
		<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;cache %p, copied %d&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_inq_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_inquiry_req</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hci_inquiry_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_inquiry</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Start Inquiry */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">lap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">lap</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">num_rsp</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_rsp</span><span class="p">;</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_inquiry</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_inquiry_req</span> <span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">do_inquiry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_rsp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inquiry_cache_age</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">INQUIRY_CACHE_AGE_MAX</span> <span class="o">||</span>
				<span class="n">inquiry_cache_empty</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">ir</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IREQ_CACHE_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inquiry_cache_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">do_inquiry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">timeo</span> <span class="o">=</span> <span class="n">ir</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_inquiry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_inq_req</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ir</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for unlimited number of responses we will use buffer with 255 entries */</span>
	<span class="n">max_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="n">num_rsp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">ir</span><span class="p">.</span><span class="n">num_rsp</span><span class="p">;</span>

	<span class="cm">/* cache_dump can&#39;t sleep. Therefore we allocate temp buffer and then</span>
<span class="cm">	 * copy it to the user space.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_rsp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">ir</span><span class="p">.</span><span class="n">num_rsp</span> <span class="o">=</span> <span class="n">inquiry_cache_dump</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">max_rsp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;num_rsp %d&quot;</span><span class="p">,</span> <span class="n">ir</span><span class="p">.</span><span class="n">num_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_info</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">ir</span><span class="p">.</span><span class="n">num_rsp</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---- HCI ioctl helpers ---- */</span>

<span class="kt">int</span> <span class="nf">hci_dev_open</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_req_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UNREGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">&amp;&amp;</span> <span class="n">rfkill_blocked</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERFKILL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_QUIRK_RAW_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Treat all non BR/EDR controllers as raw devices if</span>
<span class="cm">	   enable_hs is not set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">HCI_BREDR</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enable_hs</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">init_last_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_init_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_host_le_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_le_init_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_dev_hold</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_UP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
			<span class="n">mgmt_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Init failed, cleanup */</span>
		<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
		<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
		<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>

		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">)</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_dev_do_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan</span><span class="p">);</span>

	<span class="n">hci_req_cancel</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">hci_req_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>
		<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Flush RX and TX works */</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">service_cache</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_disable</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">inquiry_cache_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_conn_hash_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_DOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="cm">/* Reset device */</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_QUIRK_NO_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_reset_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">));</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* flush cmd  work */</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>

	<span class="cm">/* Drop queues */</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">raw_q</span><span class="p">);</span>

	<span class="cm">/* Drop last sent command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* After this point our queues are empty</span>
<span class="cm">	 * and no tasks are scheduled. */</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">mgmt_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear flags */</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">));</span>

	<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_dev_close</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_dev_do_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_dev_reset</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hci_req_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Drop queues */</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">inquiry_cache_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_conn_hash_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_reset_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>

<span class="nl">done:</span>
	<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_dev_reset_stat</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev_stats</span><span class="p">));</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_dev_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev_req</span> <span class="n">dr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">dr</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCISETAUTH</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_auth_req</span><span class="p">,</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETENCRYPT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lmp_encrypt_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Auth must be enabled first */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_auth_req</span><span class="p">,</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_encrypt_req</span><span class="p">,</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETSCAN</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_scan_req</span><span class="p">,</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETLINKPOL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_linkpol_req</span><span class="p">,</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_INIT_TIMEOUT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETLINKMODE</span>:
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">=</span> <span class="p">((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">HCI_LM_MASTER</span> <span class="o">|</span> <span class="n">HCI_LM_ACCEPT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETPTYPE</span>:
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETACLMTU</span>:
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_mtu</span>  <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCISETSCOMTU</span>:
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_mtu</span>  <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dr</span><span class="p">.</span><span class="n">dev_opt</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_get_dev_list</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev_list_req</span> <span class="o">*</span><span class="n">dl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev_req</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">dev_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev_num</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_num</span> <span class="o">||</span> <span class="n">dev_num</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dl</span><span class="p">)</span> <span class="o">+</span> <span class="n">dev_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dr</span><span class="p">);</span>

	<span class="n">dl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dr</span> <span class="o">=</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">dev_req</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

		<span class="p">(</span><span class="n">dr</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev_id</span>  <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="p">(</span><span class="n">dr</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev_opt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">dev_num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">dl</span><span class="o">-&gt;</span><span class="n">dev_num</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dl</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_get_dev_info</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev_info</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">di</span><span class="p">.</span><span class="n">bdaddr</span>   <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">type</span>     <span class="o">=</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">di</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">acl_mtu</span>  <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_mtu</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">acl_pkts</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_pkts</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">sco_mtu</span>  <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_mtu</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">sco_pkts</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_pkts</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_policy</span><span class="p">;</span>
	<span class="n">di</span><span class="p">.</span><span class="n">link_mode</span>   <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_mode</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">.</span><span class="n">stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">stat</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">.</span><span class="n">features</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">features</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---- Interface to HCI drivers ---- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_rfkill_set_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p name %s blocked %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">blocked</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hci_dev_do_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">hci_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">hci_rfkill_set_block</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">power_on</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hci_dev_open</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">AUTO_OFF_TIMEOUT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">mgmt_index_added</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span>
							<span class="n">power_off</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_do_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_discov_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan</span> <span class="o">=</span> <span class="n">SCAN_PAGE</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">discov_off</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_uuids_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>

		<span class="n">uuid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bt_uuid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">uuid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_link_keys_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_keys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

		<span class="n">key</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_key</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_smp_ltks_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="nf">hci_find_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_keys</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hci_persistent_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
						<span class="n">u8</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">old_key_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Legacy key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">&lt;</span> <span class="mh">0x03</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Debug keys are insecure so don&#39;t store them persistently */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">HCI_LK_DEBUG_COMBINATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Changed combination key and there&#39;s no previous one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">HCI_LK_CHANGED_COMBINATION</span> <span class="o">&amp;&amp;</span> <span class="n">old_key_type</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Security mode 3 case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Neither local nor remote side had no-bonding as requirement */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&gt;</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">&gt;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Local side had dedicated bonding as requirement */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Remote side had dedicated bonding as requirement */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* If none of the above criteria match, then don&#39;t store the key</span>
<span class="cm">	 * persistently */</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="nf">hci_find_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">ediv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">ediv</span> <span class="o">!=</span> <span class="n">ediv</span> <span class="o">||</span>
				<span class="n">memcmp</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_find_ltk</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="nf">hci_find_ltk_by_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_type</span> <span class="o">==</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">bdaddr_type</span> <span class="o">&amp;&amp;</span>
					<span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_find_ltk_by_addr</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hci_add_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_key</span><span class="p">,</span>
		     <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pin_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">old_key</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_key_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">persistent</span><span class="p">;</span>

	<span class="n">old_key</span> <span class="o">=</span> <span class="n">hci_find_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_key_type</span> <span class="o">=</span> <span class="n">old_key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">old_key</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">old_key_type</span> <span class="o">=</span> <span class="n">conn</span> <span class="o">?</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_keys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s key for %s type %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">),</span> <span class="n">type</span><span class="p">);</span>

	<span class="cm">/* Some buggy controller combinations generate a changed</span>
<span class="cm">	 * combination key for legacy pairing even when there&#39;s no</span>
<span class="cm">	 * previous key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_LK_CHANGED_COMBINATION</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="o">!</span><span class="n">conn</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">old_key_type</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">HCI_LK_COMBINATION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">pin_len</span> <span class="o">=</span> <span class="n">pin_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_LK_CHANGED_COMBINATION</span><span class="p">)</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">old_key_type</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">persistent</span> <span class="o">=</span> <span class="n">hci_persistent_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">old_key_type</span><span class="p">);</span>

	<span class="n">mgmt_new_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">persistent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">flush_key</span> <span class="o">=</span> <span class="o">!</span><span class="n">persistent</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_add_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">authenticated</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tk</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">u8</span> <span class="n">enc_size</span><span class="p">,</span> <span class="n">__le16</span>
		<span class="n">ediv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">old_key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HCI_SMP_STK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HCI_SMP_LTK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">old_key</span> <span class="o">=</span> <span class="n">hci_find_ltk_by_addr</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_key</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">old_key</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr_type</span> <span class="o">=</span> <span class="n">addr_type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">tk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">));</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">authenticated</span> <span class="o">=</span> <span class="n">authenticated</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">ediv</span> <span class="o">=</span> <span class="n">ediv</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">enc_size</span> <span class="o">=</span> <span class="n">enc_size</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">,</span> <span class="n">rand</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">HCI_SMP_LTK</span><span class="p">)</span>
		<span class="n">mgmt_new_ltk</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_remove_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">hci_find_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s removing %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_remove_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s removing %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* HCI command timer function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cmd_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s command tx timeout&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="nf">hci_find_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
					  <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">remote_oob_data</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_remove_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hci_find_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s removing %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_remote_oob_data_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">remote_oob_data</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_add_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hash</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">randomizer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hci_find_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">remote_oob_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">randomizer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">randomizer</span><span class="p">));</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="nf">hci_blacklist_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_blacklist_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">blacklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bdaddr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_blacklist_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hci_blacklist_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bdaddr_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">blacklist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_device_blocked</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_blacklist_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hci_blacklist_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">hci_blacklist_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_device_unblocked</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_scan_param_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">le_scan_params</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">le_scan_params</span> <span class="o">*</span><span class="p">)</span> <span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_set_scan_param</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_PARAM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_scan_enable_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_set_scan_enable</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_do_le_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">interval</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">le_scan_params</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LE_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">param</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>

	<span class="n">hci_req_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">le_scan_param_req</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span>
			    <span class="n">timeo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__hci_request</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">le_scan_enable_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>

	<span class="n">hci_req_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_disable</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_cancel_le_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LE_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_disable</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_le_set_scan_enable</span> <span class="n">cp</span><span class="p">;</span>

		<span class="cm">/* Send HCI command to disable LE Scan */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_scan_disable_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span>
					    <span class="n">le_scan_disable</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_set_scan_enable</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_SET_SCAN_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_scan_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">le_scan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">le_scan_params</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_params</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_do_le_scan</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_le_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">interval</span><span class="p">,</span> <span class="n">u16</span> <span class="n">window</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">le_scan_params</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_params</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">system_long_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Alloc HCI device */</span>
<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="nf">hci_alloc_dev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span>  <span class="o">=</span> <span class="p">(</span><span class="n">HCI_DM1</span> <span class="o">|</span> <span class="n">HCI_DH1</span> <span class="o">|</span> <span class="n">HCI_HV1</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESCO_HV1</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">HCI_LM_ACCEPT</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* No Input No Output */</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sniff_max_interval</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sniff_min_interval</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">blacklist</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_keys</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">long_term_keys</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">remote_oob_data</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">,</span> <span class="n">hci_rx_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">,</span> <span class="n">hci_cmd_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">hci_tx_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_on</span><span class="p">,</span> <span class="n">hci_power_on</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan</span><span class="p">,</span> <span class="n">le_scan_work</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">,</span> <span class="n">hci_power_off</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">,</span> <span class="n">hci_discov_off</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_scan_disable</span><span class="p">,</span> <span class="n">le_scan_disable_work</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">driver_init</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">raw_q</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">req_wait_q</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">,</span> <span class="n">hci_cmd_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_init_sysfs</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">discovery_init</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_conn_hash_init</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_alloc_dev</span><span class="p">);</span>

<span class="cm">/* Free HCI device */</span>
<span class="kt">void</span> <span class="nf">hci_free_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">driver_init</span><span class="p">);</span>

	<span class="cm">/* will free via device release */</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_free_dev</span><span class="p">);</span>

<span class="cm">/* Register HCI device */</span>
<span class="kt">int</span> <span class="nf">hci_register_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">||</span> <span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="cm">/* Do not allow HCI_AMP devices to register at index 0,</span>
<span class="cm">	 * so the index can be used as the AMP controller ID.</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">HCI_BREDR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">;</span>

	<span class="cm">/* Find first available device id */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nid</span> <span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nid</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="n">id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;hci%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p name %s bus %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>

	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">WQ_HIGHPRI</span> <span class="o">|</span> <span class="n">WQ_UNBOUND</span> <span class="o">|</span>
							<span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">hci_add_sysfs</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wqueue</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_rfkill_ops</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfkill_register</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_on</span><span class="p">);</span>

	<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_REG</span><span class="p">);</span>
	<span class="n">hci_dev_hold</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

<span class="nl">err_wqueue:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_register_dev</span><span class="p">);</span>

<span class="cm">/* Unregister HCI device */</span>
<span class="kt">void</span> <span class="nf">hci_unregister_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p name %s bus %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_UNREGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">hci_dev_do_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_REASSEMBLY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">mgmt_index_removed</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* mgmt_index_removed should take care of emptying the</span>
<span class="cm">	 * pending list */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">));</span>

	<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_UNREG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_del_sysfs</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_blacklist_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_uuids_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_link_keys_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_smp_ltks_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_remote_oob_data_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_unregister_dev</span><span class="p">);</span>

<span class="cm">/* Suspend HCI device */</span>
<span class="kt">int</span> <span class="nf">hci_suspend_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_SUSPEND</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_suspend_dev</span><span class="p">);</span>

<span class="cm">/* Resume HCI device */</span>
<span class="kt">int</span> <span class="nf">hci_resume_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hci_notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_DEV_RESUME</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_resume_dev</span><span class="p">);</span>

<span class="cm">/* Receive frame from HCI drivers */</span>
<span class="kt">int</span> <span class="nf">hci_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Incomming skb */</span>
	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">incoming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Time stamp */</span>
	<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_recv_frame</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_reassembly</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bt_skb_cb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">HCI_ACLDATA_PKT</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">HCI_EVENT_PKT</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">index</span> <span class="o">&gt;=</span> <span class="n">NUM_REASSEMBLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HCI_ACLDATA_PKT</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">HCI_MAX_FRAME_SIZE</span><span class="p">;</span>
			<span class="n">hlen</span> <span class="o">=</span> <span class="n">HCI_ACL_HDR_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HCI_EVENT_PKT</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">HCI_MAX_EVENT_SIZE</span><span class="p">;</span>
			<span class="n">hlen</span> <span class="o">=</span> <span class="n">HCI_EVENT_HDR_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HCI_SCODATA_PKT</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">HCI_MAX_SCO_SIZE</span><span class="p">;</span>
			<span class="n">hlen</span> <span class="o">=</span> <span class="n">HCI_SCO_HDR_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">=</span> <span class="n">hlen</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">uint</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">remain</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HCI_EVENT_PKT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">HCI_EVENT_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">hci_event_hdr</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">hci_event_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">plen</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HCI_ACLDATA_PKT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">==</span> <span class="n">HCI_ACL_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">hci_acl_hdr</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">hci_acl_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HCI_SCODATA_PKT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">HCI_SCO_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">hci_sco_hdr</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">hci_sco_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">expect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Complete frame */</span>

			<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
			<span class="n">hci_recv_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">remain</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">remain</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_recv_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">HCI_ACLDATA_PKT</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">HCI_EVENT_PKT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">hci_reassembly</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">rem</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_recv_fragment</span><span class="p">);</span>

<span class="cp">#define STREAM_REASSEMBLY 0</span>

<span class="kt">int</span> <span class="nf">hci_recv_stream_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">reassembly</span><span class="p">[</span><span class="n">STREAM_REASSEMBLY</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span> <span class="p">}</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

			<span class="cm">/* Start of the frame */</span>
			<span class="n">pkt</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

			<span class="n">data</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">;</span>

		<span class="n">rem</span> <span class="o">=</span> <span class="n">hci_reassembly</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							<span class="n">STREAM_REASSEMBLY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">rem</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_recv_stream_fragment</span><span class="p">);</span>

<span class="cm">/* ---- Interface to upper protocols ---- */</span>

<span class="kt">int</span> <span class="nf">hci_register_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p name %s&quot;</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_cb_list</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_register_cb</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hci_unregister_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p name %s&quot;</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_unregister_cb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s type %d len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Time stamp */</span>
	<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Send copy to monitor */</span>
	<span class="n">hci_send_to_monitor</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Send copy to the sockets */</span>
		<span class="n">hci_send_to_sock</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get rid of skb owner, prior to sending to the driver. */</span>
	<span class="n">skb_orphan</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send HCI command */</span>
<span class="kt">int</span> <span class="nf">hci_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">plen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">HCI_COMMAND_HDR_SIZE</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_command_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s opcode 0x%x plen %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s no memory for command&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hci_command_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_COMMAND_HDR_SIZE</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">plen</span>   <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">plen</span><span class="p">),</span> <span class="n">param</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;skb len %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">HCI_COMMAND_PKT</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">init_last_cmd</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get data from the previously sent command */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">hci_sent_cmd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_command_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">opcode</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">HCI_COMMAND_HDR_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send ACL data */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_add_acl_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_acl_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_ACL_HDR_SIZE</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hci_acl_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hci_handle_pack</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">flags</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlen</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_queue_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">HCI_ACLDATA_PKT</span><span class="p">;</span>
	<span class="n">hci_add_acl_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Non fragmented */</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s nonfrag skb %p len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Fragmented */</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s frag %p len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Queue all fragments atomically */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACL_START</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">ACL_CONT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>
			<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">HCI_ACLDATA_PKT</span><span class="p">;</span>
			<span class="n">hci_add_acl_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s frag %p len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">list</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_send_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s chan %p flags 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>

	<span class="n">hci_queue_acl</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_send_acl</span><span class="p">);</span>

<span class="cm">/* Send SCO data */</span>
<span class="kt">void</span> <span class="nf">hci_send_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_sco_hdr</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s len %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">dlen</span>   <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_SCO_HDR_SIZE</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">HCI_SCO_HDR_SIZE</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">HCI_SCODATA_PKT</span><span class="p">;</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_send_sco</span><span class="p">);</span>

<span class="cm">/* ---- HCI TX task (outgoing data) ---- */</span>

<span class="cm">/* HCI Connection scheduler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_low_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">quote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t have to lock device here. Connections are always</span>
<span class="cm">	 * added and removed with TX task disabled. */</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span> <span class="o">||</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">num</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min</span>  <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACL_LINK</span>:
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCO_LINK</span>:
		<span class="k">case</span> <span class="n">ESCO_LINK</span>:
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LE_LINK</span>:
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span> <span class="o">?</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">:</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown link type&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">/</span> <span class="n">num</span><span class="p">;</span>
		<span class="o">*</span><span class="n">quote</span> <span class="o">=</span> <span class="n">q</span> <span class="o">?</span> <span class="n">q</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">quote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p quote %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="o">*</span><span class="n">quote</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_link_tx_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s link tx timeout&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="cm">/* Kill stalled connections */</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s killing stalled connection %s&quot;</span><span class="p">,</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">));</span>
			<span class="n">hci_acl_disconn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="nf">hci_chan_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span>
						<span class="kt">int</span> <span class="o">*</span><span class="n">quote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">cur_prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">conn_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">conn_num</span><span class="o">++</span><span class="p">;</span>

		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">cur_prio</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="n">cur_prio</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">min</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">cur_prio</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">num</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">min</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
				<span class="n">chan</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="n">conn_num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span> <span class="o">?</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">:</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown link type&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">/</span> <span class="n">num</span><span class="p">;</span>
	<span class="o">*</span><span class="n">quote</span> <span class="o">=</span> <span class="n">q</span> <span class="o">?</span> <span class="n">q</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p quote %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">quote</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chan</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_prio_recalculate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">num</span><span class="o">++</span><span class="p">;</span>

		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">HCI_PRIO_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">HCI_PRIO_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p skb %p promoted to %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
								<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__get_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Calculate count of blocks used by this packet */</span>
	<span class="k">return</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">HCI_ACL_HDR_SIZE</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__check_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ACL tx timeout must be longer than maximum</span>
<span class="cm">		 * link supervision timeout (40.9 seconds) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_last_tx</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_ACL_TX_TIMEOUT</span><span class="p">)))</span>
			<span class="n">hci_link_tx_to</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_acl_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quote</span><span class="p">;</span>

	<span class="n">__check_timeout</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="n">hci_chan_sent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quote</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">quote</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p skb %p len %d priority %u&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>

			<span class="cm">/* Stop if priority has changed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">priority</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

			<span class="n">hci_conn_enter_active_mode</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
						   <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">force_active</span><span class="p">);</span>

			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">)</span>
		<span class="n">hci_prio_recalculate</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_acl_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quote</span><span class="p">;</span>

	<span class="n">__check_timeout</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="n">hci_chan_sent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quote</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">quote</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">blocks</span><span class="p">;</span>

			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p skb %p len %d priority %u&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>

			<span class="cm">/* Stop if priority has changed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">priority</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

			<span class="n">blocks</span> <span class="o">=</span> <span class="n">__get_blocks</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">hci_conn_enter_active_mode</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
						<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">force_active</span><span class="p">);</span>

			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span> <span class="o">-=</span> <span class="n">blocks</span><span class="p">;</span>
			<span class="n">quote</span> <span class="o">-=</span> <span class="n">blocks</span><span class="p">;</span>

			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">block_cnt</span><span class="p">)</span>
		<span class="n">hci_prio_recalculate</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flow_ctl_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCI_FLOW_CTL_MODE_PACKET_BASED</span>:
		<span class="n">hci_sched_acl_pkt</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HCI_FLOW_CTL_MODE_BLOCK_BASED</span>:
		<span class="n">hci_sched_acl_blk</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Schedule SCO */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quote</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">SCO_LINK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hci_low_sent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">SCO_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quote</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">quote</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;skb %p len %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_esco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quote</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ESCO_LINK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hci_low_sent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ESCO_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quote</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">quote</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;skb %p len %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_sched_le</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quote</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_num</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LE tx timeout must be longer than maximum</span>
<span class="cm">		 * link supervision timeout (40.9 seconds) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span> <span class="o">&amp;&amp;</span>
				<span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_last_tx</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">45</span><span class="p">))</span>
			<span class="n">hci_link_tx_to</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span> <span class="o">?</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">:</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="n">hci_chan_sent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quote</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">priority</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">quote</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p skb %p len %d priority %u&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>

			<span class="cm">/* Stop if priority has changed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">priority</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

			<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">hci_prio_recalculate</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s acl %d sco %d le %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span><span class="p">,</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sco_cnt</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span><span class="p">);</span>

	<span class="cm">/* Schedule queues and send stuff to HCI driver */</span>

	<span class="n">hci_sched_acl</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_sched_sco</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_sched_esco</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_sched_le</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="cm">/* Send next queued raw (unknown type) packet */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">raw_q</span><span class="p">)))</span>
		<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----- HCI RX task (incoming data processing) ----- */</span>

<span class="cm">/* ACL data packet */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_acldata_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_acl_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_ACL_HDR_SIZE</span><span class="p">);</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">flags</span>  <span class="o">=</span> <span class="n">hci_flags</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">hci_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s len %d handle 0x%x flags 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">acl_rx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_conn_enter_active_mode</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">BT_POWER_FORCE_ACTIVE_OFF</span><span class="p">);</span>

		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mgmt_device_connected</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">);</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="cm">/* Send to upper protocol */</span>
		<span class="n">l2cap_recv_acldata</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s ACL packet for unknown connection handle %d&quot;</span><span class="p">,</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SCO data packet */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_scodata_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_sco_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HCI_SCO_HDR_SIZE</span><span class="p">);</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s len %d handle 0x%x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sco_rx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send to upper protocol */</span>
		<span class="n">sco_recv_scodata</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%s SCO packet for unknown connection handle %d&quot;</span><span class="p">,</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_rx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">rx_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Send copy to monitor */</span>
		<span class="n">hci_send_to_monitor</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Send copy to the sockets */</span>
			<span class="n">hci_send_to_sock</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t process data packets in this states. */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HCI_ACLDATA_PKT</span>:
			<span class="k">case</span> <span class="n">HCI_SCODATA_PKT</span>:
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Process frame */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HCI_EVENT_PKT</span>:
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s Event packet&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hci_event_packet</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HCI_ACLDATA_PKT</span>:
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s ACL data packet&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hci_acldata_packet</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HCI_SCODATA_PKT</span>:
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s SCO data packet&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hci_scodata_packet</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_cmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span> <span class="n">cmd_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s cmd %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">));</span>

	<span class="cm">/* Send queued commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">);</span>

		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sent_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">);</span>
			<span class="n">hci_send_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">HCI_CMD_TIMEOUT</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_do_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* General inquiry access code (GIAC) */</span>
	<span class="n">u8</span> <span class="n">lap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x9e</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">hci_cp_inquiry</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">inquiry_cache_flush</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">lap</span><span class="p">,</span> <span class="n">lap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">lap</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_cancel_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_INQUIRY_CANCEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">bdaddr_to_le</span><span class="p">(</span><span class="n">u8</span> <span class="n">bdaddr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bdaddr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BDADDR_LE_PUBLIC</span>:
		<span class="k">return</span> <span class="n">ADDR_LE_DEV_PUBLIC</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Fallback to LE Random address type */</span>
		<span class="k">return</span> <span class="n">ADDR_LE_DEV_RANDOM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
