<!DOCTYPE html>
<html><head><title>joekychen/linux » net › bluetooth › mgmt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mgmt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>

<span class="cm">   Copyright (C) 2010  Nokia Corporation</span>
<span class="cm">   Copyright (C) 2011-2012 Intel Corporation</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cm">/* Bluetooth HCI Management interface */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci_core.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/mgmt.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/smp.h&gt;</span>

<span class="n">bool</span> <span class="n">enable_hs</span><span class="p">;</span>

<span class="cp">#define MGMT_VERSION	1</span>
<span class="cp">#define MGMT_REVISION	1</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">mgmt_commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGMT_OP_READ_INDEX_LIST</span><span class="p">,</span>
	<span class="n">MGMT_OP_READ_INFO</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_PAIRABLE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_HS</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_LE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span>
	<span class="n">MGMT_OP_ADD_UUID</span><span class="p">,</span>
	<span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span>
	<span class="n">MGMT_OP_LOAD_LINK_KEYS</span><span class="p">,</span>
	<span class="n">MGMT_OP_LOAD_LONG_TERM_KEYS</span><span class="p">,</span>
	<span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span>
	<span class="n">MGMT_OP_GET_CONNECTIONS</span><span class="p">,</span>
	<span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_IO_CAPABILITY</span><span class="p">,</span>
	<span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span>
	<span class="n">MGMT_OP_CANCEL_PAIR_DEVICE</span><span class="p">,</span>
	<span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span>
	<span class="n">MGMT_OP_USER_CONFIRM_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_USER_CONFIRM_NEG_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_USER_PASSKEY_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_USER_PASSKEY_NEG_REPLY</span><span class="p">,</span>
	<span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span>
	<span class="n">MGMT_OP_ADD_REMOTE_OOB_DATA</span><span class="p">,</span>
	<span class="n">MGMT_OP_REMOVE_REMOTE_OOB_DATA</span><span class="p">,</span>
	<span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span>
	<span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span>
	<span class="n">MGMT_OP_CONFIRM_NAME</span><span class="p">,</span>
	<span class="n">MGMT_OP_BLOCK_DEVICE</span><span class="p">,</span>
	<span class="n">MGMT_OP_UNBLOCK_DEVICE</span><span class="p">,</span>
	<span class="n">MGMT_OP_SET_DEVICE_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">mgmt_events</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGMT_EV_CONTROLLER_ERROR</span><span class="p">,</span>
	<span class="n">MGMT_EV_INDEX_ADDED</span><span class="p">,</span>
	<span class="n">MGMT_EV_INDEX_REMOVED</span><span class="p">,</span>
	<span class="n">MGMT_EV_NEW_SETTINGS</span><span class="p">,</span>
	<span class="n">MGMT_EV_CLASS_OF_DEV_CHANGED</span><span class="p">,</span>
	<span class="n">MGMT_EV_LOCAL_NAME_CHANGED</span><span class="p">,</span>
	<span class="n">MGMT_EV_NEW_LINK_KEY</span><span class="p">,</span>
	<span class="n">MGMT_EV_NEW_LONG_TERM_KEY</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_CONNECTED</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_DISCONNECTED</span><span class="p">,</span>
	<span class="n">MGMT_EV_CONNECT_FAILED</span><span class="p">,</span>
	<span class="n">MGMT_EV_PIN_CODE_REQUEST</span><span class="p">,</span>
	<span class="n">MGMT_EV_USER_CONFIRM_REQUEST</span><span class="p">,</span>
	<span class="n">MGMT_EV_USER_PASSKEY_REQUEST</span><span class="p">,</span>
	<span class="n">MGMT_EV_AUTH_FAILED</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_FOUND</span><span class="p">,</span>
	<span class="n">MGMT_EV_DISCOVERING</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_BLOCKED</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_UNBLOCKED</span><span class="p">,</span>
	<span class="n">MGMT_EV_DEVICE_UNPAIRED</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * These LE scan and inquiry parameters were chosen according to LE General</span>
<span class="cm"> * Discovery Procedure specification.</span>
<span class="cm"> */</span>
<span class="cp">#define LE_SCAN_TYPE			0x01</span>
<span class="cp">#define LE_SCAN_WIN			0x12</span>
<span class="cp">#define LE_SCAN_INT			0x12</span>
<span class="cp">#define LE_SCAN_TIMEOUT_LE_ONLY		10240	</span><span class="cm">/* TGAP(gen_disc_scan_min) */</span><span class="cp"></span>
<span class="cp">#define LE_SCAN_TIMEOUT_BREDR_LE	5120	</span><span class="cm">/* TGAP(100)/2 */</span><span class="cp"></span>

<span class="cp">#define INQUIRY_LEN_BREDR		0x08	</span><span class="cm">/* TGAP(100) */</span><span class="cp"></span>
<span class="cp">#define INQUIRY_LEN_BREDR_LE		0x04	</span><span class="cm">/* TGAP(100)/2 */</span><span class="cp"></span>

<span class="cp">#define CACHE_TIMEOUT	msecs_to_jiffies(2 * 1000)</span>

<span class="cp">#define hdev_is_powered(hdev) (test_bit(HCI_UP, &amp;hdev-&gt;flags) &amp;&amp; \</span>
<span class="cp">				!test_bit(HCI_AUTO_OFF, &amp;hdev-&gt;dev_flags))</span>

<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* HCI to MGMT error code conversion table */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mgmt_status_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGMT_STATUS_SUCCESS</span><span class="p">,</span>
	<span class="n">MGMT_STATUS_UNKNOWN_COMMAND</span><span class="p">,</span>	<span class="cm">/* Unknown Command */</span>
	<span class="n">MGMT_STATUS_NOT_CONNECTED</span><span class="p">,</span>	<span class="cm">/* No Connection */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Hardware Failure */</span>
	<span class="n">MGMT_STATUS_CONNECT_FAILED</span><span class="p">,</span>	<span class="cm">/* Page Timeout */</span>
	<span class="n">MGMT_STATUS_AUTH_FAILED</span><span class="p">,</span>	<span class="cm">/* Authentication Failed */</span>
	<span class="n">MGMT_STATUS_NOT_PAIRED</span><span class="p">,</span>		<span class="cm">/* PIN or Key Missing */</span>
	<span class="n">MGMT_STATUS_NO_RESOURCES</span><span class="p">,</span>	<span class="cm">/* Memory Full */</span>
	<span class="n">MGMT_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="cm">/* Connection Timeout */</span>
	<span class="n">MGMT_STATUS_NO_RESOURCES</span><span class="p">,</span>	<span class="cm">/* Max Number of Connections */</span>
	<span class="n">MGMT_STATUS_NO_RESOURCES</span><span class="p">,</span>	<span class="cm">/* Max Number of SCO Connections */</span>
	<span class="n">MGMT_STATUS_ALREADY_CONNECTED</span><span class="p">,</span>	<span class="cm">/* ACL Connection Exists */</span>
	<span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span>		<span class="cm">/* Command Disallowed */</span>
	<span class="n">MGMT_STATUS_NO_RESOURCES</span><span class="p">,</span>	<span class="cm">/* Rejected Limited Resources */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Rejected Security */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Rejected Personal */</span>
	<span class="n">MGMT_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="cm">/* Host Timeout */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Unsupported Feature */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* Invalid Parameters */</span>
	<span class="n">MGMT_STATUS_DISCONNECTED</span><span class="p">,</span>	<span class="cm">/* OE User Ended Connection */</span>
	<span class="n">MGMT_STATUS_NO_RESOURCES</span><span class="p">,</span>	<span class="cm">/* OE Low Resources */</span>
	<span class="n">MGMT_STATUS_DISCONNECTED</span><span class="p">,</span>	<span class="cm">/* OE Power Off */</span>
	<span class="n">MGMT_STATUS_DISCONNECTED</span><span class="p">,</span>	<span class="cm">/* Connection Terminated */</span>
	<span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span>		<span class="cm">/* Repeated Attempts */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Pairing Not Allowed */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Unknown LMP PDU */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Unsupported Remote Feature */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* SCO Offset Rejected */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* SCO Interval Rejected */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Air Mode Rejected */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* Invalid LMP Parameters */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Unspecified Error */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Unsupported LMP Parameter Value */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Role Change Not Allowed */</span>
	<span class="n">MGMT_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="cm">/* LMP Response Timeout */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* LMP Error Transaction Collision */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* LMP PDU Not Allowed */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Encryption Mode Not Accepted */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Unit Link Key Used */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* QoS Not Supported */</span>
	<span class="n">MGMT_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="cm">/* Instant Passed */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Pairing Not Supported */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Transaction Collision */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* Unacceptable Parameter */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* QoS Rejected */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Classification Not Supported */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Insufficient Security */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* Parameter Out Of Range */</span>
	<span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span>		<span class="cm">/* Role Switch Pending */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Slot Violation */</span>
	<span class="n">MGMT_STATUS_FAILED</span><span class="p">,</span>		<span class="cm">/* Role Switch Failed */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* EIR Too Large */</span>
	<span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">,</span>	<span class="cm">/* Simple Pairing Not Supported */</span>
	<span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span>		<span class="cm">/* Host Busy Pairing */</span>
	<span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span>		<span class="cm">/* Rejected, No Suitable Channel */</span>
	<span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span>		<span class="cm">/* Controller Busy */</span>
	<span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span>	<span class="cm">/* Unsuitable Connection Interval */</span>
	<span class="n">MGMT_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="cm">/* Directed Advertising Timeout */</span>
	<span class="n">MGMT_STATUS_AUTH_FAILED</span><span class="p">,</span>	<span class="cm">/* Terminated Due to MIC Failure */</span>
	<span class="n">MGMT_STATUS_CONNECT_FAILED</span><span class="p">,</span>	<span class="cm">/* Connection Establishment Failed */</span>
	<span class="n">MGMT_STATUS_CONNECT_FAILED</span><span class="p">,</span>	<span class="cm">/* MAC Connection Failed */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">mgmt_status</span><span class="p">(</span><span class="n">u8</span> <span class="n">hci_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hci_status</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mgmt_status_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">mgmt_status_table</span><span class="p">[</span><span class="n">hci_status</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">MGMT_STATUS_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_cmd_status</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p, index %u, cmd %u, status %u&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MGMT_EV_CMD_STATUS</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_queue_rcv_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">rp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_cmd_complete</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">rp_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MGMT_EV_CMD_COMPLETE</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">rp_len</span><span class="p">);</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">rp_len</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rp_len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_queue_rcv_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_read_version</span> <span class="n">rp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">rp</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">MGMT_VERSION</span><span class="p">;</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">MGMT_REVISION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_INDEX_NONE</span><span class="p">,</span> <span class="n">MGMT_OP_READ_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_read_commands</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">num_commands</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mgmt_commands</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">num_events</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mgmt_events</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">opcode</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rp_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">rp_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">num_commands</span> <span class="o">+</span> <span class="n">num_events</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rp_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">num_commands</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">num_commands</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">num_events</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">num_events</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">opcodes</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_commands</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">opcode</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">mgmt_commands</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">opcode</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">mgmt_events</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_INDEX_NONE</span><span class="p">,</span> <span class="n">MGMT_OP_READ_COMMANDS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span>
			   <span class="n">rp_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_index_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_read_index_list</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rp_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rp_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">num_controllers</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Added hci%u&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_INDEX_NONE</span><span class="p">,</span> <span class="n">MGMT_OP_READ_INDEX_LIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span>
			   <span class="n">rp_len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_supported_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">settings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_POWERED</span><span class="p">;</span>
	<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_CONNECTABLE</span><span class="p">;</span>
	<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_FAST_CONNECTABLE</span><span class="p">;</span>
	<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_DISCOVERABLE</span><span class="p">;</span>
	<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_PAIRABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMPLE_PAIR</span><span class="p">)</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_SSP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_NO_BREDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_BREDR</span><span class="p">;</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_LINK_SECURITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_hs</span><span class="p">)</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_HS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_LE</span><span class="p">)</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_LE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">settings</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_current_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">settings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_POWERED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_CONNECTABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_DISCOVERABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_PAIRABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_NO_BREDR</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_BREDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_LE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_LINK_SECURITY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_SSP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_HS_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">settings</span> <span class="o">|=</span> <span class="n">MGMT_SETTING_HS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">settings</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PNP_INFO_SVCLASS_ID		0x1200</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">bluetooth_base_uuid</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
			<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_uuid16</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">uuid128</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_base_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">uuid128</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid128</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_eir</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eir_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">uuid16_list</span><span class="p">[</span><span class="n">HCI_MAX_EIR_LENGTH</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">truncated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EIR Data type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name_len</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
			<span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIR_NAME_SHORT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIR_NAME_COMPLETE</span><span class="p">;</span>

		<span class="cm">/* EIR Data length */</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>

		<span class="n">eir_len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">inq_tx_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIR_TX_POWER</span><span class="p">;</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">inq_tx_power</span><span class="p">;</span>

		<span class="n">eir_len</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_source</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIR_DEVICE_ID</span><span class="p">;</span>

		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_source</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_vendor</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_product</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_version</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">eir_len</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">uuid16_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uuid16_list</span><span class="p">));</span>

	<span class="cm">/* Group all UUID16 types */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">uuid16</span><span class="p">;</span>

		<span class="n">uuid16</span> <span class="o">=</span> <span class="n">get_uuid16</span><span class="p">(</span><span class="n">uuid</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uuid16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uuid16</span> <span class="o">&lt;</span> <span class="mh">0x1100</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uuid16</span> <span class="o">==</span> <span class="n">PNP_INFO_SVCLASS_ID</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Stop if not enough space to put next UUID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eir_len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HCI_MAX_EIR_LENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">truncated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for duplicates */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">uuid16</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid16</span><span class="p">;</span>
			<span class="n">eir_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uuid16_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="cm">/* EIR Data type */</span>
		<span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncated</span> <span class="o">?</span> <span class="n">EIR_UUID16_SOME</span> <span class="o">:</span> <span class="n">EIR_UUID16_ALL</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">eir_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">uuid16_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* EIR Data length */</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_eir</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_eir</span> <span class="n">cp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EXT_INQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="n">create_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="n">cp</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_EIR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">get_service_classes</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">uuid</span><span class="o">-&gt;</span><span class="n">svc_hint</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cod</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">minor_class</span><span class="p">;</span>
	<span class="n">cod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">major_class</span><span class="p">;</span>
	<span class="n">cod</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_service_classes</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cod</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_CLASS_OF_DEV</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cod</span><span class="p">),</span> <span class="n">cod</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">service_cache_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span><span class="p">,</span>
					    <span class="n">service_cache</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">update_class</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgmt_init_hdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">service_cache</span><span class="p">,</span> <span class="n">service_cache_off</span><span class="p">);</span>

	<span class="cm">/* Non-mgmt controlled devices get this bit set</span>
<span class="cm">	 * implicitly so that pairing works for them, however</span>
<span class="cm">	 * for mgmt we require user-space to explicitly enable</span>
<span class="cm">	 * it</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_controller_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_read_info</span> <span class="n">rp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sock %p %s&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="n">rp</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span><span class="p">;</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>

	<span class="n">rp</span><span class="p">.</span><span class="n">supported_settings</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_supported_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">current_settings</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_current_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">));</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_READ_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgmt_pending_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="nf">mgmt_pending_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgmt_pending_foreach</span><span class="p">(</span><span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pending_cmd</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">opcode</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="nf">mgmt_pending_find</span><span class="p">(</span><span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgmt_pending_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mgmt_pending_free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_settings_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_current_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">settings</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_powered</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_AUTO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
			<span class="n">mgmt_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_on</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">power_off</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgmt_event</span><span class="p">(</span><span class="n">u16</span> <span class="n">event</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data_len</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">skip_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MGMT_INDEX_NONE</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data_len</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>

	<span class="cm">/* Time stamp */</span>
	<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">hci_send_to_control</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skip_sk</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">new_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_current_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_NEW_SETTINGS</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="n">skip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_discoverable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_discoverable</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_REJECTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">change_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan</span> <span class="o">=</span> <span class="n">SCAN_PAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">scan</span> <span class="o">|=</span> <span class="n">SCAN_INQUIRY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_connectable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan</span> <span class="o">=</span> <span class="n">SCAN_PAGE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_ISCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discov_off</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_pairable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_PAIRABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_PAIRABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_link_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">change_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_AUTH_ENABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ssp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMPLE_PAIR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">change_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SSP_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_hs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_hs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_HS</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_HS_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_HS_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_HS</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_le</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_le_host_supported</span> <span class="n">hci_cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_LE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">!!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">host_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_HOST_LE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">change_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_LE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hci_cp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_cp</span><span class="p">.</span><span class="n">le</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">hci_cp</span><span class="p">.</span><span class="n">simul</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMUL_LE_BR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LE_HOST_SUPPORTED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hci_cp</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">hci_cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_add_uuid</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_ADD_UUID</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uuid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uuid</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">uuid</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">uuid</span><span class="o">-&gt;</span><span class="n">svc_hint</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">svc_hint</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">update_class</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_ADD_UUID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_ADD_UUID</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">enable_service_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">service_cache</span><span class="p">,</span> <span class="n">CACHE_TIMEOUT</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
								<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_remove_uuid</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bt_uuid_any</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">bt_uuid_any</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_uuids_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable_service_cache</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">update_class</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uuids</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bt_uuid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">update_class:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">update_class</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_dev_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_dev_class</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;request for %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">major_class</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">minor_class</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SERVICE_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">service_cache</span><span class="p">);</span>
		<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">update_class</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_link_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
								<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_load_link_keys</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key_count</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">key_count</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">key_count</span><span class="p">);</span>

	<span class="n">expected_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_count</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_link_key_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expected_len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;load_link_keys: expected %u bytes, got %u bytes&quot;</span><span class="p">,</span>
							<span class="n">len</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_LOAD_LINK_KEYS</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s debug_keys %u key_count %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">debug_keys</span><span class="p">,</span>
								<span class="n">key_count</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_link_keys_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_LINK_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">debug_keys</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_DEBUG_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_DEBUG_KEYS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">key_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mgmt_link_key_info</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">hci_add_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
				 <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">pin_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_LOAD_LINK_KEYS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_unpaired</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">skip_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_unpaired</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">addr_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_UNPAIRED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="n">skip_sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unpair_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_unpair_device</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_unpair_device</span> <span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_disconnect</span> <span class="n">dc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_remove_link_key</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_remove_ltk</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_NOT_PAIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
		<span class="n">device_unpaired</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">dc</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="cm">/* Remote User Terminated Connection */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DISCONNECT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_disconnect</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_disconnect</span> <span class="n">dc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_OPEN</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CLOSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_CONNECTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">dc</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="cm">/* Remote User Terminated Connection */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DISCONNECT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">link_to_bdaddr</span><span class="p">(</span><span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">addr_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ADDR_LE_DEV_PUBLIC</span>:
			<span class="k">return</span> <span class="n">BDADDR_LE_PUBLIC</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* Fallback to LE Random address type */</span>
			<span class="k">return</span> <span class="n">BDADDR_LE_RANDOM</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="cm">/* Fallback to BR/EDR type */</span>
		<span class="k">return</span> <span class="n">BDADDR_BREDR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_connections</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_get_connections</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rp_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_GET_CONNECTIONS</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_addr_info</span><span class="p">));</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rp_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SCO_LINK</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ESCO_LINK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">conn_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Recalculate length in case of filtered SCO connections, etc */</span>
	<span class="n">rp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_addr_info</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_GET_CONNECTIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span>
			   <span class="n">rp_len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_pin_code_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mgmt_cp_pin_code_neg_reply</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pin_code_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_pin_code_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_pin_code_reply</span> <span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_CONNECTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">pin_len</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mgmt_cp_pin_code_neg_reply</span> <span class="n">ncp</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ncp</span><span class="p">.</span><span class="n">addr</span><span class="p">));</span>

		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;PIN code is not 16 bytes long&quot;</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">send_pin_code_neg_reply</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ncp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span>
					 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">reply</span><span class="p">.</span><span class="n">pin_len</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">pin_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">pin_code</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">pin_code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">pin_code</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_PIN_CODE_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pin_code_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_pin_code_neg_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">send_pin_code_neg_reply</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_io_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_io_capability</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">io_capability</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s IO capability set to 0x%02x&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
							<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">io_capability</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_IO_CAPABILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="nf">find_pairing</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">mgmt_pending</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">!=</span> <span class="n">conn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pairing_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_pair_device</span> <span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">);</span>

	<span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="cm">/* So we don&#39;t get further callbacks for this connection */</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disconn_cfm_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pairing_complete_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;status %u&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">find_pairing</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Unable to find a pending command&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pairing_complete</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">le_connect_complete_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;status %u&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">find_pairing</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Unable to find a pending command&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pairing_complete</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pair_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_pair_device</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_pair_device</span> <span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_MEDIUM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">io_cap</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
		<span class="n">auth_type</span> <span class="o">=</span> <span class="n">HCI_AT_DEDICATED_BONDING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">auth_type</span> <span class="o">=</span> <span class="n">HCI_AT_DEDICATED_BONDING_MITM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_connect</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span>
				   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_connect</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span>
				   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_CONNECT_FAILED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For LE, just connecting isn&#39;t a proof that the pairing finished */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span> <span class="o">=</span> <span class="n">pairing_complete_cb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span> <span class="o">=</span> <span class="n">le_connect_complete_cb</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span> <span class="o">=</span> <span class="n">pairing_complete_cb</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disconn_cfm_cb</span> <span class="o">=</span> <span class="n">pairing_complete_cb</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">io_cap</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span> <span class="o">&amp;&amp;</span>
				<span class="n">hci_conn_security</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">))</span>
		<span class="n">pairing_complete</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cancel_pair_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_addr_info</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CANCEL_PAIR_DEVICE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_PAIR_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CANCEL_PAIR_DEVICE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CANCEL_PAIR_DEVICE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pairing_complete</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">MGMT_STATUS_CANCELLED</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CANCEL_PAIR_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_pairing_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			     <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mgmt_op</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">hci_op</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">passkey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_BREDR</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_CONNECTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_LE_PUBLIC</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">BDADDR_LE_RANDOM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Continue with pairing via SMP */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">smp_user_confirm_reply</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span> <span class="n">passkey</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span>
					 <span class="n">MGMT_STATUS_SUCCESS</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span>
					 <span class="n">MGMT_STATUS_FAILED</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">mgmt_op</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bdaddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Continue with pairing via HCI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hci_op</span> <span class="o">==</span> <span class="n">HCI_OP_USER_PASSKEY_REPLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_user_passkey_reply</span> <span class="n">cp</span><span class="p">;</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">passkey</span> <span class="o">=</span> <span class="n">passkey</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hci_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bdaddr</span><span class="p">),</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_confirm_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_user_confirm_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_USER_CONFIRM_REPLY</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">user_pairing_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				 <span class="n">MGMT_OP_USER_CONFIRM_REPLY</span><span class="p">,</span>
				 <span class="n">HCI_OP_USER_CONFIRM_REPLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_confirm_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_user_confirm_neg_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">user_pairing_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				 <span class="n">MGMT_OP_USER_CONFIRM_NEG_REPLY</span><span class="p">,</span>
				 <span class="n">HCI_OP_USER_CONFIRM_NEG_REPLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_passkey_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_user_passkey_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">user_pairing_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				 <span class="n">MGMT_OP_USER_PASSKEY_REPLY</span><span class="p">,</span>
				 <span class="n">HCI_OP_USER_PASSKEY_REPLY</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">passkey</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_passkey_neg_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_user_passkey_neg_reply</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">user_pairing_resp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				 <span class="n">MGMT_OP_USER_PASSKEY_NEG_REPLY</span><span class="p">,</span>
				 <span class="n">HCI_OP_USER_PASSKEY_NEG_REPLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_local_name</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_LOCAL_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_local_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_local_name</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_LOCAL_NAME_CHANGED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				 <span class="n">sk</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">update_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_local_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_SIMPLE_PAIR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_SUPPORTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_add_remote_oob_data</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_ADD_REMOTE_OOB_DATA</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_add_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span>
				      <span class="n">cp</span><span class="o">-&gt;</span><span class="n">randomizer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_FAILED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_ADD_REMOTE_OOB_DATA</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_remove_remote_oob_data</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				   <span class="n">MGMT_OP_REMOVE_REMOTE_OOB_DATA</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_remove_remote_oob_data</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_REMOVE_REMOTE_OOB_DATA</span><span class="p">,</span>
			   <span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_interleaved_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_do_inquiry</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">INQUIRY_LEN_BREDR_LE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_start_discovery</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_PERIODIC_INQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_BUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISCOV_TYPE_BREDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_bredr_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_do_inquiry</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">INQUIRY_LEN_BREDR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISCOV_TYPE_LE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_host_le_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_le_scan</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_SCAN_TYPE</span><span class="p">,</span> <span class="n">LE_SCAN_INT</span><span class="p">,</span>
					  <span class="n">LE_SCAN_WIN</span><span class="p">,</span> <span class="n">LE_SCAN_TIMEOUT_LE_ONLY</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISCOV_TYPE_INTERLEAVED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_host_le_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lmp_bredr_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_le_scan</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_SCAN_TYPE</span><span class="p">,</span> <span class="n">LE_SCAN_INT</span><span class="p">,</span>
					  <span class="n">LE_SCAN_WIN</span><span class="p">,</span>
					  <span class="n">LE_SCAN_TIMEOUT_BREDR_LE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STARTING</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_stop_discovery</span> <span class="o">*</span><span class="n">mgmt_cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_remote_name_req_cancel</span> <span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_discovery_active</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_REJECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span>
				   <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISCOVERY_FINDING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_INQUIRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_cancel_inquiry</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hci_cancel_le_scan</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISCOVERY_RESOLVING</span>:
		<span class="n">e</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">,</span>
							<span class="n">NAME_PENDING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					   <span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt_cp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
			<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_REMOTE_NAME_REQ_CANCEL</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;unknown discovery state %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPING</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">confirm_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_confirm_name</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_discovery_active</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CONFIRM_NAME</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_FAILED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup_unknown</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_CONFIRM_NAME</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">name_known</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_KNOWN</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">name_state</span> <span class="o">=</span> <span class="n">NAME_NEEDED</span><span class="p">;</span>
		<span class="n">hci_inquiry_cache_update_resolve</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">block_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_block_device</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_blacklist_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_FAILED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_BLOCK_DEVICE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unblock_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_unblock_device</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_blacklist_del</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_UNBLOCK_DEVICE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_device_id</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">source</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;</span> <span class="mh">0x0002</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEVICE_ID</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_vendor</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_product</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">devid_version</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_DEVICE_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_fast_connectable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_mode</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_page_scan_activity</span> <span class="n">acp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_is_powered</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span>
				  <span class="n">MGMT_STATUS_REJECTED</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">PAGE_SCAN_TYPE_INTERLACED</span><span class="p">;</span>

		<span class="cm">/* 22.5 msec page scan interval */</span>
		<span class="n">acp</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x0024</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">PAGE_SCAN_TYPE_STANDARD</span><span class="p">;</span>	<span class="cm">/* default */</span>

		<span class="cm">/* default 1.28 sec page scan */</span>
		<span class="n">acp</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x0800</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* default 11.25 msec page scan window */</span>
	<span class="n">acp</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x0012</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_PAGE_SCAN_ACTIVITY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acp</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">acp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_FAILED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_PAGE_SCAN_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_FAILED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_FAST_CONNECTABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_long_term_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">cp_data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_load_long_term_keys</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cp_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key_count</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">key_count</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">key_count</span><span class="p">);</span>

	<span class="n">expected_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_count</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_ltk_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expected_len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;load_keys: expected %u bytes, got %u bytes&quot;</span><span class="p">,</span>
							<span class="n">len</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_LOAD_LONG_TERM_KEYS</span><span class="p">,</span>
				  <span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s key_count %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key_count</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_smp_ltks_clear</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">key_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mgmt_ltk_info</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">HCI_SMP_LTK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">HCI_SMP_LTK_SLAVE</span><span class="p">;</span>

		<span class="n">hci_add_ltk</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span>
			    <span class="n">bdaddr_to_le</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">),</span>
			    <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">authenticated</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
			    <span class="n">key</span><span class="o">-&gt;</span><span class="n">enc_size</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">ediv</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mgmt_handler</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">var_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mgmt_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* 0x0000 (no command) */</span>
	<span class="p">{</span> <span class="n">read_version</span><span class="p">,</span>           <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_READ_VERSION_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">read_commands</span><span class="p">,</span>          <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_READ_COMMANDS_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">read_index_list</span><span class="p">,</span>        <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_READ_INDEX_LIST_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">read_controller_info</span><span class="p">,</span>   <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_READ_INFO_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_powered</span><span class="p">,</span>            <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_discoverable</span><span class="p">,</span>       <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SET_DISCOVERABLE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_connectable</span><span class="p">,</span>        <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_fast_connectable</span><span class="p">,</span>   <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_pairable</span><span class="p">,</span>           <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_link_security</span><span class="p">,</span>      <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_ssp</span><span class="p">,</span>                <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_hs</span><span class="p">,</span>                 <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_le</span><span class="p">,</span>                 <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SETTING_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_dev_class</span><span class="p">,</span>          <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SET_DEV_CLASS_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_local_name</span><span class="p">,</span>         <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SET_LOCAL_NAME_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">add_uuid</span><span class="p">,</span>               <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_ADD_UUID_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">remove_uuid</span><span class="p">,</span>            <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_REMOVE_UUID_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">load_link_keys</span><span class="p">,</span>         <span class="nb">true</span><span class="p">,</span>  <span class="n">MGMT_LOAD_LINK_KEYS_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">load_long_term_keys</span><span class="p">,</span>    <span class="nb">true</span><span class="p">,</span>  <span class="n">MGMT_LOAD_LONG_TERM_KEYS_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">disconnect</span><span class="p">,</span>             <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_DISCONNECT_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">get_connections</span><span class="p">,</span>        <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_GET_CONNECTIONS_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">pin_code_reply</span><span class="p">,</span>         <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_PIN_CODE_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">pin_code_neg_reply</span><span class="p">,</span>     <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_PIN_CODE_NEG_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_io_capability</span><span class="p">,</span>      <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SET_IO_CAPABILITY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">pair_device</span><span class="p">,</span>            <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_PAIR_DEVICE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">cancel_pair_device</span><span class="p">,</span>     <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_CANCEL_PAIR_DEVICE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">unpair_device</span><span class="p">,</span>          <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_UNPAIR_DEVICE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">user_confirm_reply</span><span class="p">,</span>     <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_USER_CONFIRM_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">user_confirm_neg_reply</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_USER_CONFIRM_NEG_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">user_passkey_reply</span><span class="p">,</span>     <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_USER_PASSKEY_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">user_passkey_neg_reply</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_USER_PASSKEY_NEG_REPLY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">read_local_oob_data</span><span class="p">,</span>    <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_READ_LOCAL_OOB_DATA_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">add_remote_oob_data</span><span class="p">,</span>    <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_ADD_REMOTE_OOB_DATA_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">remove_remote_oob_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_REMOVE_REMOTE_OOB_DATA_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">start_discovery</span><span class="p">,</span>        <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_START_DISCOVERY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">stop_discovery</span><span class="p">,</span>         <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_STOP_DISCOVERY_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">confirm_name</span><span class="p">,</span>           <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_CONFIRM_NAME_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">block_device</span><span class="p">,</span>           <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_BLOCK_DEVICE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">unblock_device</span><span class="p">,</span>         <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_UNBLOCK_DEVICE_SIZE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">set_device_id</span><span class="p">,</span>          <span class="nb">false</span><span class="p">,</span> <span class="n">MGMT_SET_DEVICE_ID_SIZE</span> <span class="p">},</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">mgmt_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mgmt_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;got %zu bytes&quot;</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">msglen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">msglen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">msglen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">MGMT_INDEX_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
					 <span class="n">MGMT_STATUS_INVALID_INDEX</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mgmt_handlers</span><span class="p">)</span> <span class="o">||</span>
					<span class="n">mgmt_handlers</span><span class="p">[</span><span class="n">opcode</span><span class="p">].</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Unknown op %u&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_UNKNOWN_COMMAND</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hdev</span> <span class="o">&amp;&amp;</span> <span class="n">opcode</span> <span class="o">&lt;</span> <span class="n">MGMT_OP_READ_INFO</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="o">!</span><span class="n">hdev</span> <span class="o">&amp;&amp;</span> <span class="n">opcode</span> <span class="o">&gt;=</span> <span class="n">MGMT_OP_READ_INFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_INDEX</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgmt_handlers</span><span class="p">[</span><span class="n">opcode</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">var_len</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">var_len</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
				 <span class="n">MGMT_STATUS_INVALID_PARAMS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span>
		<span class="n">mgmt_init_hdev</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">msglen</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span>
		<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_status_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">cmd_status</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_index_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_INDEX_ADDED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_index_removed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_INVALID_INDEX</span><span class="p">;</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cmd_status_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_INDEX_REMOVED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mgmt_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">settings_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">send_settings_rsp</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_powered</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">powered</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_MGMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_POWERED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">powered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">scan</span> <span class="o">|=</span> <span class="n">SCAN_PAGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">scan</span> <span class="o">|=</span> <span class="n">SCAN_INQUIRY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="p">)</span>
			<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_SCAN_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">);</span>

		<span class="n">update_class</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">update_name</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MGMT_STATUS_NOT_POWERED</span><span class="p">;</span>
		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cmd_status_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_discoverable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">discoverable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discoverable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_DISCOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_connectable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">connectable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connectable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONNECTABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_write_scan_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">scan</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mgmt_err</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">&amp;</span> <span class="n">SCAN_PAGE</span><span class="p">)</span>
		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_CONNECTABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span>
				     <span class="n">cmd_status_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgmt_err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span> <span class="o">&amp;</span> <span class="n">SCAN_INQUIRY</span><span class="p">)</span>
		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_DISCOVERABLE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span>
				     <span class="n">cmd_status_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgmt_err</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_new_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">persistent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_new_link_key</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">store_hint</span> <span class="o">=</span> <span class="n">persistent</span><span class="p">;</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BDADDR_BREDR</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">pin_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">pin_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_NEW_LINK_KEY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_new_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">persistent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_new_long_term_key</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">store_hint</span> <span class="o">=</span> <span class="n">persistent</span><span class="p">;</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">LE_LINK</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">bdaddr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">authenticated</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">authenticated</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">enc_size</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">enc_size</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ediv</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">ediv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HCI_SMP_LTK</span><span class="p">)</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">rand</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_NEW_LONG_TERM_KEY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_device_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_connected</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eir_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">eir_len</span> <span class="o">=</span> <span class="n">eir_append_data</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EIR_NAME_COMPLETE</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_class</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">eir_len</span> <span class="o">=</span> <span class="n">eir_append_data</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="n">eir_len</span><span class="p">,</span>
					  <span class="n">EIR_CLASS_OF_DEV</span><span class="p">,</span> <span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eir_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_CONNECTED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">eir_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disconnect_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_disconnect</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">**</span><span class="n">sk</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_disconnect</span> <span class="n">rp</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">sock_hold</span><span class="p">(</span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unpair_device_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_unpair_device</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_unpair_device</span> <span class="n">rp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="n">device_unpaired</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_device_disconnected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_addr_info</span> <span class="n">ev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">disconnect_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_DISCONNECTED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			 <span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">unpair_device_rsp</span><span class="p">,</span>
			     <span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_disconnect_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_disconnect</span> <span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">MGMT_OP_DISCONNECT</span><span class="p">,</span>
			   <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_UNPAIR_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">unpair_device_rsp</span><span class="p">,</span>
									<span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_connect_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_connect_failed</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_CONNECT_FAILED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_pin_code_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">secure</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_pin_code_request</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BDADDR_BREDR</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_PIN_CODE_REQUEST</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_pin_code_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_pin_code_reply</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BDADDR_BREDR</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_REPLY</span><span class="p">,</span>
			   <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_pin_code_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_pin_code_reply</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BDADDR_BREDR</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_PIN_CODE_NEG_REPLY</span><span class="p">,</span>
			   <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_confirm_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">value</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">confirm_hint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_user_confirm_request</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">confirm_hint</span> <span class="o">=</span> <span class="n">confirm_hint</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_USER_CONFIRM_REQUEST</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_passkey_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
						<span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_user_passkey_request</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_USER_PASSKEY_REQUEST</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_pairing_resp_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_rp_user_confirm_reply</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">rp</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_confirm_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">user_pairing_resp_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">,</span>
					  <span class="n">status</span><span class="p">,</span> <span class="n">MGMT_OP_USER_CONFIRM_REPLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_confirm_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">user_pairing_resp_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">,</span>
					  <span class="n">status</span><span class="p">,</span> <span class="n">MGMT_OP_USER_CONFIRM_NEG_REPLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_passkey_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">user_pairing_resp_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">,</span>
					  <span class="n">status</span><span class="p">,</span> <span class="n">MGMT_OP_USER_PASSKEY_REPLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_user_passkey_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">user_pairing_resp_complete</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">,</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">,</span>
					  <span class="n">status</span><span class="p">,</span> <span class="n">MGMT_OP_USER_PASSKEY_NEG_REPLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_auth_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_auth_failed</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_AUTH_FAILED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_auth_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mgmt_err</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span>
				     <span class="n">cmd_status_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgmt_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_AUTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_LINK_SECURITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_LINK_SECURITY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_eir</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_write_eir</span> <span class="n">cp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LMP_EXT_INQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_WRITE_EIR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_ssp_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mgmt_err</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cmd_status_rsp</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mgmt_err</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_SSP</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
		<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">class_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">mgmt_status</span><span class="p">,</span>
		     <span class="n">match</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_set_class_of_dev_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCI_PENDING_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">);</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_DEV_CLASS</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">class_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>
	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_ADD_UUID</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">class_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>
	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_REMOVE_UUID</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">class_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_CLASS_OF_DEV_CHANGED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">dev_class</span><span class="p">,</span>
				 <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_set_local_name_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_cp_set_local_name</span> <span class="n">ev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">));</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">HCI_MAX_NAME_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">short_name</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">short_name</span><span class="p">,</span> <span class="n">HCI_MAX_SHORT_NAME_LENGTH</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">send_event</span><span class="p">;</span>

	<span class="cm">/* Always assume that either the short or the complete name has</span>
<span class="cm">	 * changed if there was a pending mgmt command */</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span>
				 <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_SET_LOCAL_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

<span class="nl">send_event:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_LOCAL_NAME_CHANGED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="n">cmd</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">update_eir</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_read_local_oob_data_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hash</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s status %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_status</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span>
				 <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mgmt_rp_read_local_oob_data</span> <span class="n">rp</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">hash</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">randomizer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">.</span><span class="n">randomizer</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				   <span class="n">MGMT_OP_READ_LOCAL_OOB_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_le_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_lookup</span> <span class="n">match</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdev</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">mgmt_err</span> <span class="o">=</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_LE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">cmd_status_rsp</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mgmt_err</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_LE_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">))</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgmt_pending_foreach</span><span class="p">(</span><span class="n">MGMT_OP_SET_LE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">settings_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_device_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">s8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfm_name</span><span class="p">,</span> <span class="n">u8</span>
		      <span class="n">ssp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">eir</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eir_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_found</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ev_size</span><span class="p">;</span>

	<span class="cm">/* Leave 5 bytes for a potential CoD field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">eir_len</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfm_name</span><span class="p">)</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MGMT_DEV_FOUND_CONFIRM_NAME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssp</span><span class="p">)</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MGMT_DEV_FOUND_LEGACY_PAIRING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eir_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="n">eir</span><span class="p">,</span> <span class="n">eir_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_class</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">eir_has_data_type</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="n">eir_len</span><span class="p">,</span> <span class="n">EIR_CLASS_OF_DEV</span><span class="p">))</span>
		<span class="n">eir_len</span> <span class="o">=</span> <span class="n">eir_append_data</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="n">eir_len</span><span class="p">,</span> <span class="n">EIR_CLASS_OF_DEV</span><span class="p">,</span>
					  <span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eir_len</span><span class="p">);</span>

	<span class="n">ev_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">eir_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_FOUND</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_remote_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">s8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_found</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">HCI_MAX_NAME_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">eir_len</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_ev_device_found</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">link_to_bdaddr</span><span class="p">(</span><span class="n">link_type</span><span class="p">,</span> <span class="n">addr_type</span><span class="p">);</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>

	<span class="n">eir_len</span> <span class="o">=</span> <span class="n">eir_append_data</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EIR_NAME_COMPLETE</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				  <span class="n">name_len</span><span class="p">);</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">eir_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eir_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_FOUND</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">)</span> <span class="o">+</span> <span class="n">eir_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_start_discovery_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_stop_discovery_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">mgmt_status</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
	<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_discovering</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">discovering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_discovering</span> <span class="n">ev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s discovering %u&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">discovering</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discovering</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_START_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_STOP_DISCOVERY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

		<span class="n">cmd_complete</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="n">mgmt_pending_remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">));</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">discovering</span> <span class="o">=</span> <span class="n">discovering</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DISCOVERING</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_device_blocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_blocked</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_BLOCK_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_BLOCKED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="n">cmd</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mgmt_device_unblocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_ev_device_unblocked</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mgmt_pending_find</span><span class="p">(</span><span class="n">MGMT_OP_UNBLOCK_DEVICE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgmt_event</span><span class="p">(</span><span class="n">MGMT_EV_DEVICE_UNBLOCKED</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span>
			  <span class="n">cmd</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">enable_hs</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable_hs</span><span class="p">,</span> <span class="s">&quot;Enable High Speed support&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
