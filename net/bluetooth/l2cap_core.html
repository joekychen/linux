<!DOCTYPE html>
<html><head><title>joekychen/linux » net › bluetooth › l2cap_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>l2cap_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (C) 2000-2001 Qualcomm Incorporated</span>
<span class="cm">   Copyright (C) 2009-2010 Gustavo F. Padovan &lt;gustavo@padovan.org&gt;</span>
<span class="cm">   Copyright (C) 2010 Google Inc.</span>
<span class="cm">   Copyright (C) 2011 ProFUSION Embedded Systems</span>
<span class="cm">   Copyright (c) 2012 Code Aurora Forum.  All rights reserved.</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cm">/* Bluetooth L2CAP core. */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/crc16.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci_core.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/l2cap.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/smp.h&gt;</span>

<span class="n">bool</span> <span class="n">disable_ertm</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">l2cap_feat_mask</span> <span class="o">=</span> <span class="n">L2CAP_FEAT_FIXED_CHAN</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">l2cap_fixed_chan</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">L2CAP_FC_L2CAP</span><span class="p">,</span> <span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">chan_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">chan_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">l2cap_build_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span>
								<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">);</span>

<span class="cm">/* ---- L2CAP channels ---- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">__l2cap_get_chan_by_dcid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">==</span> <span class="n">cid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">==</span> <span class="n">cid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find channel with given SCID.</span>
<span class="cm"> * Returns locked channel. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">l2cap_get_chan_by_scid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">__l2cap_get_chan_by_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">ident</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">__l2cap_global_chan_by_addr</span><span class="p">(</span><span class="n">__le16</span> <span class="n">psm</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">global_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sport</span> <span class="o">==</span> <span class="n">psm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_add_psm</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psm</span> <span class="o">&amp;&amp;</span> <span class="n">__l2cap_global_chan_by_addr</span><span class="p">(</span><span class="n">psm</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span> <span class="o">=</span> <span class="n">psm</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sport</span> <span class="o">=</span> <span class="n">psm</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x1001</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mh">0x1100</span><span class="p">;</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__l2cap_global_chan_by_addr</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sport</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_add_scid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>  <span class="n">__u16</span> <span class="n">scid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">=</span> <span class="n">scid</span><span class="p">;</span>

	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">l2cap_alloc_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">L2CAP_CID_DYN_START</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="n">L2CAP_CID_DYN_END</span><span class="p">;</span> <span class="n">cid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cid</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">cid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__l2cap_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p %s -&gt; %s&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">state_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
						<span class="n">state_to_string</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">state_change</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__l2cap_chan_set_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_chan_set_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__l2cap_chan_set_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---- L2CAP sequence number lists ---- */</span>

<span class="cm">/* For ERTM, ordered lists of sequence numbers must be tracked for</span>
<span class="cm"> * SREJ requests that are received and for frames that are to be</span>
<span class="cm"> * retransmitted. These seq_list functions implement a singly-linked</span>
<span class="cm"> * list in an array, where membership in the list can also be checked</span>
<span class="cm"> * in constant time. Items can also be added to the tail of the list</span>
<span class="cm"> * and removed from the head in constant time, without further memory</span>
<span class="cm"> * allocs or frees.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_seq_list_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Allocated size is a power of 2 to map sequence numbers</span>
<span class="cm">	 * (which may be up to 14 bits) in to a smaller array that is</span>
<span class="cm">	 * sized for the negotiated ERTM transmit windows.</span>
<span class="cm">	 */</span>
	<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">alloc_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">alloc_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alloc_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_seq_list_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">l2cap_seq_list_contains</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">,</span>
					   <span class="n">u16</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Constant-time check for list membership */</span>
	<span class="k">return</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">l2cap_seq_list_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In case someone tries to pop the head of an empty list */</span>
		<span class="k">return</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Head can be removed in constant time */</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">];</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">L2CAP_SEQ_LIST_TAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
			<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Walk the list to find the sequence number */</span>
		<span class="n">u16</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">L2CAP_SEQ_LIST_TAIL</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Unlink the number from the list and clear it */</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">];</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span>
			<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">seq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">l2cap_seq_list_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remove the head in constant time */</span>
	<span class="k">return</span> <span class="n">l2cap_seq_list_remove</span><span class="p">(</span><span class="n">seq_list</span><span class="p">,</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_seq_list_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>

	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_seq_list_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="o">*</span><span class="n">seq_list</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* All appends happen in constant time */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">L2CAP_SEQ_LIST_CLEAR</span><span class="p">)</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">seq_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2CAP_SEQ_LIST_TAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_chan_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span><span class="p">,</span>
							<span class="n">chan_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p state %s&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">state_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span> <span class="o">&amp;&amp;</span>
					<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">!=</span> <span class="n">BT_SECURITY_SDP</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">l2cap_chan_close</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">l2cap_chan_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">global_l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_timer</span><span class="p">,</span> <span class="n">l2cap_chan_timeout</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_OPEN</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chan</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">l2cap_chan_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">global_l</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">l2cap_chan_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span>  <span class="o">=</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">max_tx</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MAX_TX</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_LOW</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_FORCE_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__l2cap_chan_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p, psm 0x%2.2x, dcid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
	       <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">),</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_reason</span> <span class="o">=</span> <span class="n">HCI_ERROR_REMOTE_USER_TERM</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* LE connection */</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span> <span class="o">=</span> <span class="n">L2CAP_LE_DEFAULT_MTU</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">=</span> <span class="n">L2CAP_CID_LE_DATA</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">L2CAP_CID_LE_DATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Alloc CID for connection-oriented socket */</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">=</span> <span class="n">l2cap_alloc_cid</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MTU</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CHAN_CONN_LESS</span>:
		<span class="cm">/* Connectionless socket */</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">=</span> <span class="n">L2CAP_CID_CONN_LESS</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">L2CAP_CID_CONN_LESS</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MTU</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Raw socket can send/recv signalling messages only */</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">=</span> <span class="n">L2CAP_CID_SIGNALING</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">L2CAP_CID_SIGNALING</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MTU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_id</span>		<span class="o">=</span> <span class="n">L2CAP_BESTEFFORT_ID</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span>	<span class="o">=</span> <span class="n">L2CAP_SERV_BESTEFFORT</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_msdu</span>	<span class="o">=</span> <span class="n">L2CAP_DEFAULT_MAX_SDU_SIZE</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_sdu_itime</span>	<span class="o">=</span> <span class="n">L2CAP_DEFAULT_SDU_ITIME</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_acc_lat</span>	<span class="o">=</span> <span class="n">L2CAP_DEFAULT_ACC_LAT</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_flush_to</span>	<span class="o">=</span> <span class="n">L2CAP_DEFAULT_FLUSH_TO</span><span class="p">;</span>

	<span class="n">l2cap_chan_hold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_chan_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
	<span class="n">__l2cap_chan_add</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_chan_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, conn %p, err %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Delete from channel list */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CLOSED</span><span class="p">);</span>
	<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">__l2cap_chan_set_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bt_accept_unlink</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_INPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">__clear_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">__clear_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">__clear_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">);</span>

		<span class="n">l2cap_seq_list_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_list</span><span class="p">);</span>
		<span class="n">l2cap_seq_list_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">retrans_list</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_chan_cleanup_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;parent %p&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* Close not yet accepted channels */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">sk</span> <span class="o">=</span> <span class="n">bt_accept_dequeue</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_pi</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>

		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">l2cap_chan_close</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">l2cap_chan_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p state %s sk %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					<span class="n">state_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BT_LISTEN</span>:
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">l2cap_chan_cleanup_listen</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CLOSED</span><span class="p">);</span>
		<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_CONNECTED</span>:
	<span class="k">case</span> <span class="n">BT_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">==</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span> <span class="o">&amp;&amp;</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span><span class="p">);</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_CONNECT2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">==</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span> <span class="o">&amp;&amp;</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
			<span class="n">__u16</span> <span class="n">result</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BT_SK_DEFER_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_SEC_BLOCK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_BAD_PSM</span><span class="p">;</span>
			<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_DISCONN</span><span class="p">);</span>

			<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_NO_INFO</span><span class="p">);</span>
			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_RSP</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_CONNECT</span>:
	<span class="k">case</span> <span class="n">BT_DISCONN</span>:
		<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">l2cap_get_auth_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">==</span> <span class="n">L2CAP_CHAN_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SECURITY_HIGH</span>:
			<span class="k">return</span> <span class="n">HCI_AT_DEDICATED_BONDING_MITM</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_SECURITY_MEDIUM</span>:
			<span class="k">return</span> <span class="n">HCI_AT_DEDICATED_BONDING</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">HCI_AT_NO_BONDING</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_LOW</span><span class="p">)</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_SDP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HCI_AT_NO_BONDING_MITM</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">HCI_AT_NO_BONDING</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BT_SECURITY_HIGH</span>:
			<span class="k">return</span> <span class="n">HCI_AT_GENERAL_BONDING_MITM</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BT_SECURITY_MEDIUM</span>:
			<span class="k">return</span> <span class="n">HCI_AT_GENERAL_BONDING</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">HCI_AT_NO_BONDING</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Service level security */</span>
<span class="kt">int</span> <span class="nf">l2cap_chan_check_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">auth_type</span><span class="p">;</span>

	<span class="n">auth_type</span> <span class="o">=</span> <span class="n">l2cap_get_auth_type</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hci_conn_security</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">l2cap_get_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Get next available identificator.</span>
<span class="cm">	 *    1 - 128 are used by kernel.</span>
<span class="cm">	 *  129 - 199 are reserved.</span>
<span class="cm">	 *  200 - 254 are used by utilities like l2ping, etc.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_ident</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_ident</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_ident</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l2cap_build_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;code 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lmp_no_flush_capable</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ACL_START_NO_FLUSH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ACL_START</span><span class="p">;</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">force_active</span> <span class="o">=</span> <span class="n">BT_POWER_FORCE_ACTIVE_ON</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">HCI_PRIO_MAX</span><span class="p">;</span>

	<span class="n">hci_send_acl</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hchan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_do_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, skb %p len %d priority %u&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FLUSHABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">lmp_no_flush_capable</span><span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ACL_START_NO_FLUSH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ACL_START</span><span class="p">;</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">force_active</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FORCE_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">hci_send_acl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hchan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unpack_enhanced_control</span><span class="p">(</span><span class="n">u16</span> <span class="n">enh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_ctrl</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">reqseq</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_REQSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">final</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_FINAL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_FINAL_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_FRAME_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S-Frame */</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_POLL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_POLL_SHIFT</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_SUPERVISE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_SUPER_SHIFT</span><span class="p">;</span>

		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I-Frame */</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_SAR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_SAR_SHIFT</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">=</span> <span class="p">(</span><span class="n">enh</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_TXSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>

		<span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unpack_extended_control</span><span class="p">(</span><span class="n">u32</span> <span class="n">ext</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_ctrl</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">reqseq</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_REQSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">final</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_FINAL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_FINAL_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_FRAME_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S-Frame */</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_POLL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_POLL_SHIFT</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_SUPERVISE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_SUPER_SHIFT</span><span class="p">;</span>

		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I-Frame */</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_SAR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_SAR_SHIFT</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_TXSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>

		<span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__unpack_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__unpack_extended_control</span><span class="p">(</span><span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__unpack_enhanced_control</span><span class="p">(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__pack_extended_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_ctrl</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">packed</span><span class="p">;</span>

	<span class="n">packed</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">reqseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
	<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">final</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_FINAL_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_POLL_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_SUPER_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">L2CAP_EXT_CTRL_FRAME_TYPE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_SAR_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">packed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">__pack_enhanced_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_ctrl</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">packed</span><span class="p">;</span>

	<span class="n">packed</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">reqseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
	<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">final</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_FINAL_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">sframe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_POLL_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">super</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_SUPER_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">L2CAP_CTRL_FRAME_TYPE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_SAR_SHIFT</span><span class="p">;</span>
		<span class="n">packed</span> <span class="o">|=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">txseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">packed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__pack_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">l2cap_ctrl</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">__pack_extended_control</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
				   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">__pack_enhanced_control</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
				   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_send_sframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">hlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">L2CAP_EXT_HDR_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">L2CAP_ENH_HDR_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span>
		<span class="n">hlen</span> <span class="o">+=</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, control 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_SEND_PBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hlen</span> <span class="o">-</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>

	<span class="n">__put_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">__ctrl_size</span><span class="p">(</span><span class="n">chan</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fcs</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">lh</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">HCI_PRIO_MAX</span><span class="p">;</span>
	<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_send_rr_or_rnr</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RNR</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RR</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__l2cap_no_conn_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_conn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_req</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">req</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">psm</span>  <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_chan_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;sk %p, parent %p&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_do_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_chan_ready</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">__l2cap_no_conn_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
			<span class="n">l2cap_send_conn_req</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">req</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IT_FEAT_MASK</span><span class="p">);</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_SENT</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">,</span> <span class="n">L2CAP_INFO_TIMEOUT</span><span class="p">);</span>

		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_mode_supported</span><span class="p">(</span><span class="n">__u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">feat_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">local_feat_mask</span> <span class="o">=</span> <span class="n">l2cap_feat_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_ertm</span><span class="p">)</span>
		<span class="n">local_feat_mask</span> <span class="o">|=</span> <span class="n">L2CAP_FEAT_ERTM</span> <span class="o">|</span> <span class="n">L2CAP_FEAT_STREAMING</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="k">return</span> <span class="n">L2CAP_FEAT_ERTM</span> <span class="o">&amp;</span> <span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">local_feat_mask</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="k">return</span> <span class="n">L2CAP_FEAT_STREAMING</span> <span class="o">&amp;</span> <span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">local_feat_mask</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_disconn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_disconn_req</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__clear_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">__clear_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">__clear_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="p">.</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span>
			<span class="n">L2CAP_DISCONN_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_DISCONN</span><span class="p">);</span>
	<span class="n">__l2cap_chan_set_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---- L2CAP connections ---- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">||</span>
					<span class="o">!</span><span class="n">__l2cap_no_conn_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l2cap_mode_supported</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_STATE2_DEVICE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">l2cap_chan_close</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
				<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">l2cap_send_conn_req</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BT_SK_DEFER_SETUP</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
					<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CR_PEND</span><span class="p">);</span>
					<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_AUTHOR_PEND</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
						<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONFIG</span><span class="p">);</span>
					<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CR_SUCCESS</span><span class="p">);</span>
					<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_NO_INFO</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CR_PEND</span><span class="p">);</span>
				<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_AUTHEN_PEND</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_RSP</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)</span> <span class="o">||</span>
					<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">!=</span> <span class="n">L2CAP_CR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">L2CAP_CONF_REQ</span><span class="p">,</span>
						<span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find socket with cid and source/destination bdaddr.</span>
<span class="cm"> * Returns closest match, locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">l2cap_global_chan_by_scid</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">,</span>
						    <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
						    <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">c1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">global_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">==</span> <span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">src_match</span><span class="p">,</span> <span class="n">dst_match</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">src_any</span><span class="p">,</span> <span class="n">dst_any</span><span class="p">;</span>

			<span class="cm">/* Exact match. */</span>
			<span class="n">src_match</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="n">dst_match</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_match</span> <span class="o">&amp;&amp;</span> <span class="n">dst_match</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Closest match */</span>
			<span class="n">src_any</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
			<span class="n">dst_any</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">src_match</span> <span class="o">&amp;&amp;</span> <span class="n">dst_any</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">src_any</span> <span class="o">&amp;&amp;</span> <span class="n">dst_match</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">src_any</span> <span class="o">&amp;&amp;</span> <span class="n">dst_any</span><span class="p">))</span>
				<span class="n">c1</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_le_conn_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">pchan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* Check if we have socket listening on cid */</span>
	<span class="n">pchan</span> <span class="o">=</span> <span class="n">l2cap_global_chan_by_scid</span><span class="p">(</span><span class="n">BT_LISTEN</span><span class="p">,</span> <span class="n">L2CAP_CID_LE_DATA</span><span class="p">,</span>
					  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pchan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* Check for backlog size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;backlog full %d&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">new_connection</span><span class="p">(</span><span class="n">pchan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="n">bt_accept_enqueue</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">l2cap_chan_add</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span><span class="p">);</span>

	<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>
	<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">clean:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_conn_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="n">l2cap_le_conn_ready</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="n">smp_conn_security</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">smp_conn_security</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">))</span>
				<span class="n">l2cap_chan_ready</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
			<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span><span class="p">)</span>
			<span class="n">l2cap_do_start</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Notify sockets that we cannot guaranty reliability anymore */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_conn_unreliable</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FORCE_RELIABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">__l2cap_chan_set_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_info_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_conn</span><span class="p">,</span>
							<span class="n">info_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l2cap_conn_start</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_conn_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p conn %p, err %d&quot;</span><span class="p">,</span> <span class="n">hcon</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="cm">/* Kill channels */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_chan_hold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">hci_chan_del</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hchan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_SENT</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_LE_SMP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_timer</span><span class="p">);</span>
		<span class="n">smp_chan_destroy</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">security_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_conn</span><span class="p">,</span>
						<span class="n">security_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HCI_CONN_LE_SMP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smp_chan_destroy</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">l2cap_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">,</span> <span class="n">ETIMEDOUT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="nf">l2cap_conn_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">hchan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">||</span> <span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>

	<span class="n">hchan</span> <span class="o">=</span> <span class="n">hci_chan_create</span><span class="p">(</span><span class="n">hcon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hchan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_chan_del</span><span class="p">(</span><span class="n">hchan</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span> <span class="o">=</span> <span class="n">hcon</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hchan</span> <span class="o">=</span> <span class="n">hchan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p conn %p hchan %p&quot;</span><span class="p">,</span> <span class="n">hcon</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">hchan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span> <span class="o">&amp;&amp;</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_mtu</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_mtu</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_timer</span><span class="p">,</span> <span class="n">security_timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">,</span> <span class="n">l2cap_info_timeout</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_reason</span> <span class="o">=</span> <span class="n">HCI_ERROR_REMOTE_USER_TERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---- Socket interface ---- */</span>

<span class="cm">/* Find socket with psm and source / destination bdaddr.</span>
<span class="cm"> * Returns closest match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="nf">l2cap_global_chan_by_psm</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">,</span>
						   <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
						   <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">c1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">global_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">psm</span> <span class="o">==</span> <span class="n">psm</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">src_match</span><span class="p">,</span> <span class="n">dst_match</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">src_any</span><span class="p">,</span> <span class="n">dst_any</span><span class="p">;</span>

			<span class="cm">/* Exact match. */</span>
			<span class="n">src_match</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="n">dst_match</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_match</span> <span class="o">&amp;&amp;</span> <span class="n">dst_match</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Closest match */</span>
			<span class="n">src_any</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
			<span class="n">dst_any</span> <span class="o">=</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">src_match</span> <span class="o">&amp;&amp;</span> <span class="n">dst_any</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">src_any</span> <span class="o">&amp;&amp;</span> <span class="n">dst_match</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">src_any</span> <span class="o">&amp;&amp;</span> <span class="n">dst_any</span><span class="p">))</span>
				<span class="n">c1</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_chan_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">,</span>
		       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dst_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">auth_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s -&gt; %s (type %u) psm 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">batostr</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span>
	       <span class="n">dst_type</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">));</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_get_route</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* PSM must be odd and lsb of upper byte must be 0 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">psm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0101</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0001</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cid</span> <span class="o">&amp;&amp;</span>
					<span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">==</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">psm</span> <span class="o">||</span> <span class="n">cid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_BASIC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_ertm</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BT_CONNECT</span>:
	<span class="k">case</span> <span class="n">BT_CONNECT2</span>:
	<span class="k">case</span> <span class="n">BT_CONFIG</span>:
		<span class="cm">/* Already connecting */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_CONNECTED</span>:
		<span class="cm">/* Already connected */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BT_OPEN</span>:
	<span class="k">case</span> <span class="n">BT_BOUND</span>:
		<span class="cm">/* Can connect */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set destination address and psm */</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span> <span class="o">=</span> <span class="n">psm</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">auth_type</span> <span class="o">=</span> <span class="n">l2cap_get_auth_type</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">==</span> <span class="n">L2CAP_CID_LE_DATA</span><span class="p">)</span>
		<span class="n">hcon</span> <span class="o">=</span> <span class="n">hci_connect</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span>
				   <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hcon</span> <span class="o">=</span> <span class="n">hci_connect</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span>
				   <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hcon</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">l2cap_conn_add</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">hcon</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">hcon</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update source addr of the socket */</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_add</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECT</span><span class="p">);</span>
	<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
				<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">l2cap_do_start</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__l2cap_wait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_pi</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span>
			<span class="n">timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">timeo</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
		<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="n">sk_sleep</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_monitor_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span><span class="p">,</span>
							<span class="n">monitor_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNABORTED</span><span class="p">);</span>
		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">__set_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_send_rr_or_rnr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_CTRL_POLL</span><span class="p">);</span>
	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_retrans_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span><span class="p">,</span>
							<span class="n">retrans_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">__set_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

	<span class="n">l2cap_send_rr_or_rnr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_CTRL_POLL</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_drop_acked_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span><span class="p">)</span>
		<span class="n">__clear_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_streaming_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fcs</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">__get_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_txseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span><span class="p">);</span>
		<span class="n">__put_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcs</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
			<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_retransmit_one_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">!=</span> <span class="n">tx_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNABORTED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">__get_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="n">__get_sar_mask</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_txseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>

	<span class="n">__put_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcs</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span>
				<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_ertm_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">l2cap_tx_window_full</span><span class="p">(</span><span class="n">chan</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNABORTED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>

		<span class="n">control</span> <span class="o">=</span> <span class="n">__get_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="n">__get_sar_mask</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_txseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span><span class="p">);</span>

		<span class="n">__put_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcs</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
			<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
						<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>

		<span class="n">__set_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">;</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsent</span><span class="o">++</span><span class="p">)</span>
				<span class="n">__clear_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">frames_sent</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span> <span class="o">=</span> <span class="n">skb_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nsent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_retransmit_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">))</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__l2cap_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RNR</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RR</span><span class="p">);</span>
	<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__clear_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">__l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_srejtail</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_SREJ</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">((</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srej_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tail</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>

	<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_skbuff_fromiovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">sent</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">len</span>  <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Continuation fragments (no L2CAP header) */</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					   <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcpy_fromiovec</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>

		<span class="n">sent</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">l2cap_create_connless_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">L2CAP_HDR_SIZE</span> <span class="o">+</span> <span class="n">L2CAP_PSMLEN_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p len %d priority %u&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span> <span class="n">hlen</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="n">hlen</span><span class="p">,</span>
				   <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>

	<span class="cm">/* Create L2CAP header */</span>
	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">L2CAP_PSMLEN_SIZE</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_PSMLEN_SIZE</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_skbuff_fromiovec</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">l2cap_create_basic_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">,</span>
				   <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>

	<span class="cm">/* Create L2CAP header */</span>
	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_skbuff_fromiovec</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">l2cap_create_iframe_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">sdulen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">hlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOTCONN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">L2CAP_EXT_HDR_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">L2CAP_ENH_HDR_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdulen</span><span class="p">)</span>
		<span class="n">hlen</span> <span class="o">+=</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span>
		<span class="n">hlen</span> <span class="o">+=</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span> <span class="n">hlen</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="n">hlen</span><span class="p">,</span>
				   <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Create L2CAP header */</span>
	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">-</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">));</span>

	<span class="n">__put_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">__ctrl_size</span><span class="p">(</span><span class="n">chan</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdulen</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">sdulen</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_skbuff_fromiovec</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">));</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_segment_sdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">seg_queue</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sdu_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">pdu_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sar</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, msg %p, len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* It is critical that ERTM PDUs fit in a single HCI fragment,</span>
<span class="cm">	 * so fragmented skbs are not used.  The HCI layer&#39;s handling</span>
<span class="cm">	 * of fragmented skbs is not compatible with ERTM&#39;s queueing.</span>
<span class="cm">	 */</span>

	<span class="cm">/* PDU size is derived from the HCI MTU */</span>
	<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">pdu_len</span><span class="p">,</span> <span class="n">L2CAP_BREDR_MAX_PAYLOAD</span><span class="p">);</span>

	<span class="cm">/* Adjust for largest possible L2CAP overhead. */</span>
	<span class="n">pdu_len</span> <span class="o">-=</span> <span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">+</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">;</span>

	<span class="cm">/* Remote device may have requested smaller PDUs */</span>
	<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">pdu_len</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_mps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">pdu_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sar</span> <span class="o">=</span> <span class="n">L2CAP_SAR_UNSEGMENTED</span><span class="p">;</span>
		<span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sar</span> <span class="o">=</span> <span class="n">L2CAP_SAR_START</span><span class="p">;</span>
		<span class="n">sdu_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">pdu_len</span> <span class="o">-=</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">l2cap_create_iframe_pdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pdu_len</span><span class="p">,</span> <span class="n">sdu_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="n">seg_queue</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">sar</span><span class="p">;</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="n">seg_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">pdu_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdu_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pdu_len</span> <span class="o">+=</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">pdu_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sar</span> <span class="o">=</span> <span class="n">L2CAP_SAR_END</span><span class="p">;</span>
			<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sar</span> <span class="o">=</span> <span class="n">L2CAP_SAR_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_chan_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
								<span class="n">u32</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">seg_queue</span><span class="p">;</span>

	<span class="cm">/* Connectionless channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">==</span> <span class="n">L2CAP_CHAN_CONN_LESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">l2cap_create_connless_pdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_BASIC</span>:
		<span class="cm">/* Check outgoing MTU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

		<span class="cm">/* Create a basic PDU */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">l2cap_create_basic_pdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">l2cap_do_send</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="cm">/* Check outgoing MTU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_queue</span><span class="p">);</span>

		<span class="cm">/* Do segmentation before calling in to the state machine,</span>
<span class="cm">		 * since it&#39;s possible to block while waiting for memory</span>
<span class="cm">		 * allocation.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_segment_sdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg_queue</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* The channel could have been closed while segmenting,</span>
<span class="cm">		 * check that it is still connected.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_queue</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_send_head</span> <span class="o">=</span> <span class="n">seg_queue</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">skb_queue_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_streaming_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* If the skbs were not queued for sending, they&#39;ll still be in</span>
<span class="cm">		 * seg_queue and need to be purged.</span>
<span class="cm">		 */</span>
		<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_queue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;bad state %1.1x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copy frame to all raw sockets on that connection */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_raw_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_RAW</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t send frame to the socket it came from */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="n">sk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">nskb</span><span class="p">))</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---- L2CAP signalling commands ---- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">l2cap_build_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">**</span><span class="n">frag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p, code 0x%2.2x, ident 0x%2.2x, len %d&quot;</span><span class="p">,</span>
			<span class="n">conn</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">L2CAP_HDR_SIZE</span> <span class="o">+</span> <span class="n">L2CAP_CMD_HDR_SIZE</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CMD_HDR_SIZE</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CID_LE_SIGNALING</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CID_SIGNALING</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span>  <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">L2CAP_HDR_SIZE</span> <span class="o">+</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Continuation fragments (no L2CAP header) */</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">frag</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">len</span>  <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_get_conf_opt</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">olen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_opt</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">L2CAP_CONF_OPT_SIZE</span> <span class="o">+</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">olen</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;type 0x%2.2x len %d val 0x%lx&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_add_conf_opt</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_opt</span> <span class="o">*</span><span class="n">opt</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;type 0x%2.2x len %d val 0x%lx&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">opt</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>  <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">L2CAP_CONF_OPT_SIZE</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_add_opt_efs</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_efs</span> <span class="n">efs</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="n">efs</span><span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_id</span><span class="p">;</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">stype</span>	<span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span><span class="p">;</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">msdu</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_msdu</span><span class="p">);</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">sdu_itime</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_sdu_itime</span><span class="p">);</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">acc_lat</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_ACC_LAT</span><span class="p">);</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">flush_to</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_FLUSH_TO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="n">efs</span><span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">stype</span>	<span class="o">=</span> <span class="n">L2CAP_SERV_BESTEFFORT</span><span class="p">;</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">msdu</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_msdu</span><span class="p">);</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">sdu_itime</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_sdu_itime</span><span class="p">);</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">acc_lat</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">efs</span><span class="p">.</span><span class="n">flush_to</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EFS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">efs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_ack_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_chan</span><span class="p">,</span>
							<span class="n">ack_timer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">__l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_ertm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_acked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">frames_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_acked_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">L2CAP_RX_STATE_RECV</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">L2CAP_TX_STATE_XMIT</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">retrans_timer</span><span class="p">,</span> <span class="n">l2cap_retrans_timeout</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">monitor_timer</span><span class="p">,</span> <span class="n">l2cap_monitor_timeout</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ack_timer</span><span class="p">,</span> <span class="n">l2cap_ack_timeout</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_seq_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_list</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">l2cap_seq_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">retrans_list</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_tx_win</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="nf">l2cap_select_mode</span><span class="p">(</span><span class="n">__u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">remote_feat_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_mode_supported</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">remote_feat_mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">L2CAP_MODE_BASIC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__l2cap_ews_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enable_hs</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_EXT_WINDOW</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__l2cap_efs_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enable_hs</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_EXT_FLOW</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_txwin_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span> <span class="o">&gt;</span> <span class="n">L2CAP_DEFAULT_TX_WINDOW</span> <span class="o">&amp;&amp;</span>
						<span class="n">__l2cap_ews_supported</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* use extended control field */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_EXT_WINDOW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">,</span>
						<span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_build_conf_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rfc</span> <span class="n">rfc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="p">};</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_rsp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_STATE2_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__l2cap_efs_supported</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">l2cap_select_mode</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">!=</span> <span class="n">L2CAP_DEFAULT_MTU</span><span class="p">)</span>
		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_MTU</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_BASIC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_ERTM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_STREAMING</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="n">L2CAP_MODE_BASIC</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">txwin_size</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_transmit</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_transmit</span>    <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">max_tx</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">L2CAP_DEFAULT_MAX_PDU_SIZE</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span>
						<span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_SDULEN_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

		<span class="n">l2cap_txwin_setup</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">rfc</span><span class="p">.</span><span class="n">txwin_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">,</span>
						<span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">);</span>

		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">l2cap_add_opt_efs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_FCS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_NONE</span> <span class="o">||</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_NO_FCS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">L2CAP_FCS_NONE</span><span class="p">;</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_FCS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EWS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
								<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="n">L2CAP_MODE_STREAMING</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">txwin_size</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_transmit</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">L2CAP_DEFAULT_MAX_PDU_SIZE</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span>
						<span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_SDULEN_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">l2cap_add_opt_efs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_FCS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_NONE</span> <span class="o">||</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_NO_FCS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">L2CAP_FCS_NONE</span><span class="p">;</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_FCS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dcid</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_parse_conf_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rfc</span> <span class="n">rfc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L2CAP_MODE_BASIC</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_efs</span> <span class="n">efs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">remote_efs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_SUCCESS</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">L2CAP_CONF_OPT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l2cap_get_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">olen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="n">hint</span>  <span class="o">=</span> <span class="n">type</span> <span class="o">&amp;</span> <span class="n">L2CAP_CONF_HINT</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">&amp;=</span> <span class="n">L2CAP_CONF_MASK</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">L2CAP_CONF_MTU</span>:
			<span class="n">mtu</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_FLUSH_TO</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">flush_to</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_QOS</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_RFC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">olen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_FCS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">L2CAP_FCS_NONE</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_NO_FCS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_EFS</span>:
			<span class="n">remote_efs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">olen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efs</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_EWS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_hs</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_EWS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_EXT_WINDOW</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_tx_win</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hint</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNKNOWN</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_rsp</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_STATE2_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">l2cap_select_mode</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span>
					<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remote_efs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__l2cap_efs_supported</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNACCEPT</span><span class="p">;</span>
		<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_rsp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CONF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configure output options and let the other side know</span>
<span class="cm">		 * which ones we don&#39;t like. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">L2CAP_DEFAULT_MIN_MTU</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNACCEPT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_MTU_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_MTU</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">omtu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remote_efs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span> <span class="o">!=</span> <span class="n">L2CAP_SERV_NOTRAFIC</span> <span class="o">&amp;&amp;</span>
					<span class="n">efs</span><span class="p">.</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">L2CAP_SERV_NOTRAFIC</span> <span class="o">&amp;&amp;</span>
					<span class="n">efs</span><span class="p">.</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNACCEPT</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

				<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EFS</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">efs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Send PENDING Conf Rsp */</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_PENDING</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">L2CAP_MODE_BASIC</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">L2CAP_FCS_NONE</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_MODE_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_EWS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_tx_win</span> <span class="o">=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">txwin_size</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rfc</span><span class="p">.</span><span class="n">txwin_size</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_TX_WINDOW</span><span class="p">;</span>

			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_max_tx</span> <span class="o">=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">max_transmit</span><span class="p">;</span>

			<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">),</span>
						<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span>
						<span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_SDULEN_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
			<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_mps</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span> <span class="o">=</span>
				<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_RETRANS_TO</span><span class="p">);</span>
			<span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span> <span class="o">=</span>
				<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_MONITOR_TO</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_MODE_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_id</span> <span class="o">=</span> <span class="n">efs</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_stype</span> <span class="o">=</span> <span class="n">efs</span><span class="p">.</span><span class="n">stype</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_msdu</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">msdu</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_flush_to</span> <span class="o">=</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">flush_to</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_acc_lat</span> <span class="o">=</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">acc_lat</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_sdu_itime</span> <span class="o">=</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">sdu_itime</span><span class="p">);</span>
				<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EFS</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">efs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">),</span>
						<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">-</span>
						<span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_SDULEN_SIZE</span> <span class="o">-</span>
						<span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
			<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">remote_mps</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_MODE_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNACCEPT</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">));</span>
			<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CONF_SUCCESS</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_parse_conf_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rfc</span> <span class="n">rfc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L2CAP_MODE_BASIC</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_efs</span> <span class="n">efs</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, rsp %p, len %d, req %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">L2CAP_CONF_OPT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l2cap_get_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">olen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">L2CAP_CONF_MTU</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">L2CAP_DEFAULT_MIN_MTU</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_UNACCEPT</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">=</span> <span class="n">L2CAP_DEFAULT_MIN_MTU</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_MTU</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_FLUSH_TO</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">flush_to</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_FLUSH_TO</span><span class="p">,</span>
							<span class="mi">2</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">flush_to</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_RFC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">olen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_STATE2_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rfc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_EWS</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
						<span class="n">L2CAP_DEFAULT_EXT_WINDOW</span><span class="p">);</span>
			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EWS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
							<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_CONF_EFS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">olen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efs</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span> <span class="o">!=</span> <span class="n">L2CAP_SERV_NOTRAFIC</span> <span class="o">&amp;&amp;</span>
					<span class="n">efs</span><span class="p">.</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">L2CAP_SERV_NOTRAFIC</span> <span class="o">&amp;&amp;</span>
					<span class="n">efs</span><span class="p">.</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_stype</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

			<span class="n">l2cap_add_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">L2CAP_CONF_EFS</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">efs</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">efs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_BASIC</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CONF_SUCCESS</span> <span class="o">||</span> <span class="o">*</span><span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CONF_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span>    <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_msdu</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">msdu</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_sdu_itime</span> <span class="o">=</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">sdu_itime</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_acc_lat</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">acc_lat</span><span class="p">);</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_flush_to</span> <span class="o">=</span>
						<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">efs</span><span class="p">.</span><span class="n">flush_to</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span>    <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dcid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_build_conf_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">result</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__l2cap_connect_rsp_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CR_SUCCESS</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_NO_INFO</span><span class="p">);</span>
	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span>
				<span class="n">L2CAP_CONN_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">L2CAP_CONF_REQ</span><span class="p">,</span>
			<span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_conf_rfc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rfc</span> <span class="n">rfc</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, rsp %p, len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L2CAP_MODE_STREAMING</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">L2CAP_CONF_OPT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l2cap_get_conf_opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">olen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">L2CAP_CONF_RFC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">olen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use sane default values in case a misbehaving remote device</span>
<span class="cm">	 * did not send an RFC option.</span>
<span class="cm">	 */</span>
	<span class="n">rfc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_RETRANS_TO</span><span class="p">);</span>
	<span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_DEFAULT_MONITOR_TO</span><span class="p">);</span>
	<span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span><span class="p">);</span>

	<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Expected RFC option was not found, using defaults&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">retrans_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">retrans_timeout</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">monitor_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">monitor_timeout</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span>    <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span>    <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfc</span><span class="p">.</span><span class="n">max_pdu_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_command_rej</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_cmd_rej_unk</span> <span class="o">*</span><span class="n">rej</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_cmd_rej_unk</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rej</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">L2CAP_REJ_NOT_UNDERSTOOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_SENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">);</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">l2cap_conn_start</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_connect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">dcid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">psm</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;psm 0x%2.2x scid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">psm</span><span class="p">),</span> <span class="n">scid</span><span class="p">);</span>

	<span class="cm">/* Check if we have socket listening on psm */</span>
	<span class="n">pchan</span> <span class="o">=</span> <span class="n">l2cap_global_chan_by_psm</span><span class="p">(</span><span class="n">BT_LISTEN</span><span class="p">,</span> <span class="n">psm</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_BAD_PSM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">sendresp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
	<span class="n">lock_sock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* Check if the ACL is secure enough (if not SDP) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psm</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">hci_conn_check_link_mode</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_reason</span> <span class="o">=</span> <span class="n">HCI_ERROR_AUTH_FAILURE</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_SEC_BLOCK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">response</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_NO_MEM</span><span class="p">;</span>

	<span class="cm">/* Check for backlog size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;backlog full %d&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_ack_backlog</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">response</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">new_connection</span><span class="p">(</span><span class="n">pchan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="cm">/* Check if we already have channel with that dcid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__l2cap_get_chan_by_dcid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">scid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">response</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">);</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">psm</span>  <span class="o">=</span> <span class="n">psm</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">scid</span><span class="p">;</span>

	<span class="n">bt_accept_enqueue</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

	<span class="n">__l2cap_chan_add</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">dcid</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">;</span>

	<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BT_SK_DEFER_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECT2</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_PEND</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">L2CAP_CS_AUTHOR_PEND</span><span class="p">;</span>
				<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONFIG</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_SUCCESS</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECT2</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_PEND</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">L2CAP_CS_AUTHEN_PEND</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECT2</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CR_PEND</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">response:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

<span class="nl">sendresp:</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CR_PEND</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IT_FEAT_MASK</span><span class="p">);</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_SENT</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">,</span> <span class="n">L2CAP_INFO_TIMEOUT</span><span class="p">);</span>

		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">result</span> <span class="o">==</span> <span class="n">L2CAP_CR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">L2CAP_CONF_REQ</span><span class="p">,</span>
					<span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_connect_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scid</span><span class="p">,</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">scid</span>   <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">dcid</span>   <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;dcid 0x%4.4x scid 0x%4.4x result 0x%2.2x status 0x%2.2x&quot;</span><span class="p">,</span>
						<span class="n">dcid</span><span class="p">,</span> <span class="n">scid</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">scid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">__l2cap_get_chan_by_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_CR_SUCCESS</span>:
		<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONFIG</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">dcid</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONF_CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">L2CAP_CONF_REQ</span><span class="p">,</span>
					<span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">req</span><span class="p">),</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CR_PEND</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNREFUSED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_default_fcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FCS is enabled only in ERTM or streaming mode, if one or both</span>
<span class="cm">	 * sides request it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L2CAP_MODE_ERTM</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L2CAP_MODE_STREAMING</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">L2CAP_FCS_NONE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_NO_FCS_RECV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_config_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conf_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dcid</span>  <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;dcid 0x%4.4x flags 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">dcid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONFIG</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECT2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_cmd_rej_cid</span> <span class="n">rej</span><span class="p">;</span>

		<span class="n">rej</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_REJ_INVALID_CID</span><span class="p">);</span>
		<span class="n">rej</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
		<span class="n">rej</span><span class="p">.</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>

		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_COMMAND_REJ</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rej</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rej</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reject if config buffer is too small. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">cmd_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONF_RSP</span><span class="p">,</span>
				<span class="n">l2cap_build_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span>
					<span class="n">L2CAP_CONF_REJECT</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Store config. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_req</span> <span class="o">+</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_len</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Incomplete config. Send empty response. */</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONF_RSP</span><span class="p">,</span>
				<span class="n">l2cap_build_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span>
					<span class="n">L2CAP_CONF_SUCCESS</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Complete config. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">l2cap_parse_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONF_RSP</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_rsp</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Reset config buffer. */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_INPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_default_fcs</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span> <span class="o">||</span>
		    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_STREAMING</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_ertm_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_chan_ready</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CONF_REQ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">L2CAP_CONF_REQ</span><span class="p">,</span>
					<span class="n">l2cap_build_conf_req</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Got Conf Rsp PENDING from remote side and asume we sent</span>
<span class="cm">	   Conf Rsp PENDING in the code above */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_REM_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* check compatibility */</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONF_RSP</span><span class="p">,</span>
					<span class="n">l2cap_build_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span>
					<span class="n">L2CAP_CONF_SUCCESS</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_config_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conf_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conf_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scid</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scid</span>   <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">flags</span>  <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;scid 0x%4.4x flags 0x%2.2x result 0x%2.2x len %d&quot;</span><span class="p">,</span> <span class="n">scid</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
	       <span class="n">result</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">scid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_CONF_SUCCESS</span>:
		<span class="n">l2cap_conf_rfc_get</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONF_REM_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONF_PENDING</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_REM_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">l2cap_parse_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
								<span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* check compatibility */</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONF_RSP</span><span class="p">,</span>
						<span class="n">l2cap_build_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
						<span class="n">L2CAP_CONF_SUCCESS</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONF_UNACCEPT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_rsp</span> <span class="o">&lt;=</span> <span class="n">L2CAP_CONF_MAX_CONF_RSP</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">req</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conf_req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* throw out any old stored conf requests */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_CONF_SUCCESS</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">l2cap_parse_conf_rsp</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
								<span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span>
						<span class="n">L2CAP_CONF_REQ</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_conf_req</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">L2CAP_CONF_SUCCESS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">l2cap_chan_set_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>

		<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_DISC_REJ_TIMEOUT</span><span class="p">);</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONF_INPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_default_fcs</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONNECTED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span> <span class="o">||</span>
		    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_STREAMING</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_ertm_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_chan_ready</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_disconnect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_disconn_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_disconn_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_disconn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">scid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">scid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">dcid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;scid 0x%4.4x dcid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">scid</span><span class="p">,</span> <span class="n">dcid</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">dcid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_DISCONN_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">=</span> <span class="n">SHUTDOWN_MASK</span><span class="p">;</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">l2cap_chan_hold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_disconnect_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_disconn_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_disconn_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">scid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">scid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">dcid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;dcid 0x%4.4x scid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">dcid</span><span class="p">,</span> <span class="n">scid</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">__l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">scid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_chan_hold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">l2cap_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_information_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;type 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">L2CAP_IT_FEAT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">feat_mask</span> <span class="o">=</span> <span class="n">l2cap_feat_mask</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">type</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IT_FEAT_MASK</span><span class="p">);</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IR_SUCCESS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_ertm</span><span class="p">)</span>
			<span class="n">feat_mask</span> <span class="o">|=</span> <span class="n">L2CAP_FEAT_ERTM</span> <span class="o">|</span> <span class="n">L2CAP_FEAT_STREAMING</span>
							 <span class="o">|</span> <span class="n">L2CAP_FEAT_FCS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable_hs</span><span class="p">)</span>
			<span class="n">feat_mask</span> <span class="o">|=</span> <span class="n">L2CAP_FEAT_EXT_FLOW</span>
						<span class="o">|</span> <span class="n">L2CAP_FEAT_EXT_WINDOW</span><span class="p">;</span>

		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">feat_mask</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">L2CAP_IT_FIXED_CHAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable_hs</span><span class="p">)</span>
			<span class="n">l2cap_fixed_chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">L2CAP_FC_A2MP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">l2cap_fixed_chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">L2CAP_FC_A2MP</span><span class="p">;</span>

		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">type</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IT_FIXED_CHAN</span><span class="p">);</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IR_SUCCESS</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">l2cap_fixed_chan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">l2cap_fixed_chan</span><span class="p">));</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="n">rsp</span><span class="p">;</span>
		<span class="n">rsp</span><span class="p">.</span><span class="n">type</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
		<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IR_NOTSUPP</span><span class="p">);</span>
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_information_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">type</span>   <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;type 0x%4.4x result 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="cm">/* L2CAP Info req/rsp are unbound to channels, add extra checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">!=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">||</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">&amp;</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">L2CAP_IR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">l2cap_conn_start</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_IT_FEAT_MASK</span>:
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">feat_mask</span> <span class="o">&amp;</span> <span class="n">L2CAP_FEAT_FIXED_CHAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="n">req</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_IT_FIXED_CHAN</span><span class="p">);</span>

			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span><span class="p">,</span>
					<span class="n">L2CAP_INFO_REQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">l2cap_conn_start</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_IT_FIXED_CHAN</span>:
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">fixed_chan_mask</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_state</span> <span class="o">|=</span> <span class="n">L2CAP_INFO_FEAT_MASK_REQ_DONE</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">info_ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">l2cap_conn_start</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_create_channel_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_create_chan_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_create_chan_rsp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">psm</span><span class="p">,</span> <span class="n">scid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_hs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">psm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">);</span>
	<span class="n">scid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;psm %d, scid %d, amp_id %d&quot;</span><span class="p">,</span> <span class="n">psm</span><span class="p">,</span> <span class="n">scid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">amp_id</span><span class="p">);</span>

	<span class="cm">/* Placeholder: Always reject */</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CR_NO_MEM</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CS_NO_INFO</span><span class="p">);</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CREATE_CHAN_RSP</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_create_channel_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">l2cap_connect_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_move_chan_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span>
							<span class="n">u16</span> <span class="n">icid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_rsp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d, result %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">rsp</span><span class="p">.</span><span class="n">icid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">icid</span><span class="p">);</span>
	<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_MOVE_CHAN_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_move_chan_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">icid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm</span> <span class="n">cfm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ident</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d, result %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">ident</span> <span class="o">=</span> <span class="n">l2cap_get_ident</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>

	<span class="n">cfm</span><span class="p">.</span><span class="n">icid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">icid</span><span class="p">);</span>
	<span class="n">cfm</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_MOVE_CHAN_CFM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfm</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cfm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_send_move_chan_cfm_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ident</span><span class="p">,</span>
								<span class="n">u16</span> <span class="n">icid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm_rsp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">);</span>

	<span class="n">rsp</span><span class="p">.</span><span class="n">icid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">icid</span><span class="p">);</span>
	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_MOVE_CHAN_CFM_RSP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_move_channel_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">icid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">result</span> <span class="o">=</span> <span class="n">L2CAP_MR_NOT_ALLOWED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="n">icid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">icid</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d, dest_amp_id %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dest_amp_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_hs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Placeholder: Always refuse */</span>
	<span class="n">l2cap_send_move_chan_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_move_channel_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="n">icid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">icid</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d, result %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="cm">/* Placeholder: Always unconfirmed */</span>
	<span class="n">l2cap_send_move_chan_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">L2CAP_MC_UNCONFIRMED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_move_channel_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm</span> <span class="o">*</span><span class="n">cfm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="n">icid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cfm</span><span class="o">-&gt;</span><span class="n">icid</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cfm</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d, result %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">l2cap_send_move_chan_cfm_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">icid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_move_channel_confirm_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">icid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="n">icid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">icid</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;icid %d&quot;</span><span class="p">,</span> <span class="n">icid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_check_conn_param</span><span class="p">(</span><span class="n">u16</span> <span class="n">min</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max</span><span class="p">,</span> <span class="n">u16</span> <span class="n">latency</span><span class="p">,</span>
							<span class="n">u16</span> <span class="n">to_multiplier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">max_latency</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="o">||</span> <span class="n">min</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">max</span> <span class="o">&gt;</span> <span class="mi">3200</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_multiplier</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">to_multiplier</span> <span class="o">&gt;</span> <span class="mi">3200</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">to_multiplier</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">max_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_multiplier</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">max</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">latency</span> <span class="o">&gt;</span> <span class="mi">499</span> <span class="o">||</span> <span class="n">latency</span> <span class="o">&gt;</span> <span class="n">max_latency</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_conn_param_update_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_param_update_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_conn_param_update_rsp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">to_multiplier</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_MASTER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn_param_update_req</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn_param_update_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">min</span>		<span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">);</span>
	<span class="n">max</span>		<span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
	<span class="n">latency</span>		<span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>
	<span class="n">to_multiplier</span>	<span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">to_multiplier</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;min 0x%4.4x max 0x%4.4x latency: 0x%4.4x Timeout: 0x%4.4x&quot;</span><span class="p">,</span>
						<span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">to_multiplier</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_check_conn_param</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">to_multiplier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CONN_PARAM_REJECTED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_CONN_PARAM_ACCEPTED</span><span class="p">);</span>

	<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_PARAM_UPDATE_RSP</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">hci_le_conn_update</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">to_multiplier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_bredr_sig_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_COMMAND_REJ</span>:
		<span class="n">l2cap_command_rej</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONN_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_connect_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONN_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_connect_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONF_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_config_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONF_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_config_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_DISCONN_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_disconnect_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_DISCONN_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_disconnect_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_ECHO_REQ</span>:
		<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_ECHO_RSP</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_ECHO_RSP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_INFO_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_information_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_INFO_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_information_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CREATE_CHAN_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_create_channel_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CREATE_CHAN_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_create_channel_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MOVE_CHAN_REQ</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_move_channel_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MOVE_CHAN_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_move_channel_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MOVE_CHAN_CFM</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_move_channel_confirm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MOVE_CHAN_CFM_RSP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_move_channel_confirm_rsp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown BR/EDR signaling command 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_le_sig_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_COMMAND_REJ</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CONN_PARAM_UPDATE_REQ</span>:
		<span class="k">return</span> <span class="n">l2cap_conn_param_update_req</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">L2CAP_CONN_PARAM_UPDATE_RSP</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unknown LE signaling command 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_sig_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">l2cap_raw_recv</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">cmd_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">L2CAP_CMD_HDR_SIZE</span><span class="p">;</span>

		<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;code 0x%2.2x len %d id 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;corrupted command&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_le_sig_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_bredr_sig_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">l2cap_cmd_rej_unk</span> <span class="n">rej</span><span class="p">;</span>

			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Wrong link type (%d)&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="cm">/* FIXME: Map err to a valid reason */</span>
			<span class="n">rej</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">L2CAP_REJ_NOT_UNDERSTOOD</span><span class="p">);</span>
			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_COMMAND_REJ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rej</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rej</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">cmd_len</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_check_fcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">our_fcs</span><span class="p">,</span> <span class="n">rcv_fcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">hdr_size</span> <span class="o">=</span> <span class="n">L2CAP_EXT_HDR_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdr_size</span> <span class="o">=</span> <span class="n">L2CAP_ENH_HDR_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">);</span>
		<span class="n">rcv_fcs</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">our_fcs</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">hdr_size</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">our_fcs</span> <span class="o">!=</span> <span class="n">rcv_fcs</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_send_i_or_rr_or_rnr</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">frames_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RNR</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="n">l2cap_retransmit_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">frames_sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RR</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_add_to_srej_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_seq_offset</span><span class="p">,</span> <span class="n">next_tx_seq_offset</span><span class="p">;</span>

	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
	<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">sar</span><span class="p">;</span>

	<span class="n">next_skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">);</span>

	<span class="n">tx_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">next_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">next_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">==</span> <span class="n">tx_seq</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">next_tx_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
			<span class="n">bt_cb</span><span class="p">(</span><span class="n">next_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_tx_seq_offset</span> <span class="o">&gt;</span> <span class="n">tx_seq_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__skb_queue_before</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">,</span> <span class="n">next_skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">,</span> <span class="n">next_skb</span><span class="p">))</span>
			<span class="n">next_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">next_skb</span> <span class="o">=</span> <span class="n">skb_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">,</span> <span class="n">next_skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">append_skb_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_frag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">last_frag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* skb-&gt;len reflects data in skb as well as all fragments</span>
<span class="cm">	 * skb-&gt;data_len reflects only data in fragments</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_has_frag_list</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span> <span class="o">=</span> <span class="n">new_frag</span><span class="p">;</span>

	<span class="n">new_frag</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">last_frag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_frag</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">new_frag</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">new_frag</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">new_frag</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">new_frag</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_reassemble_sdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">__get_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_SAR_UNSEGMENTED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SAR_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SAR_CONTINUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">append_skb_frag</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SAR_END</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">append_skb_frag</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reassembly complete */</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_ertm_enter_local_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, Enter local busy&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="n">l2cap_seq_list_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_list</span><span class="p">);</span>

	<span class="n">__set_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_ertm_exit_local_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RR</span><span class="p">);</span>
	<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">__clear_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">__set_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, Exit local busy&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">l2cap_chan_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L2CAP_MODE_ERTM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busy</span><span class="p">)</span>
			<span class="n">l2cap_ertm_enter_local_busy</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_ertm_exit_local_busy</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_check_srej_gap</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">!=</span> <span class="n">tx_seq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">__set_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_reassemble_sdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq_srej</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq_srej</span><span class="p">);</span>
		<span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_resend_srejframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">==</span> <span class="n">tx_seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_SREJ</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_send_srejframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tx_seq</span> <span class="o">!=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_SREJ</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">__set_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">);</span>
		<span class="n">l2cap_seq_list_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_list</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

		<span class="n">new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">srej_list</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">new</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">;</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_data_channel_iframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__get_txseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">req_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">sar</span> <span class="o">=</span> <span class="n">__get_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tx_seq_offset</span><span class="p">,</span> <span class="n">expected_tx_seq_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_to_ack</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p len %d tx_seq %d rx_control 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
							<span class="n">tx_seq</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__clear_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">__set_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="n">req_seq</span><span class="p">;</span>
	<span class="n">l2cap_drop_acked_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">tx_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="cm">/* invalid tx_seq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_seq_offset</span> <span class="o">&gt;=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_RNR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_seq</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">expected</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>

		<span class="n">first</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">srej_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_seq</span> <span class="o">==</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_add_to_srej_queue</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">sar</span><span class="p">);</span>
			<span class="n">l2cap_check_srej_gap</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq_srej</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
				<span class="n">l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, Exit SREJ_SENT&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">srej_list</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

			<span class="cm">/* duplicated tx_seq */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_add_to_srej_queue</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">sar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">tx_seq</span> <span class="o">==</span> <span class="n">tx_seq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">l2cap_resend_srejframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_send_srejframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">expected_tx_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

		<span class="cm">/* duplicated tx_seq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_seq_offset</span> <span class="o">&lt;</span> <span class="n">expected_tx_seq_offset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, Enter SREJ&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_l</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq_srej</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">;</span>

		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">);</span>
		<span class="n">l2cap_add_to_srej_queue</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">sar</span><span class="p">);</span>

		<span class="cm">/* Set P-bit only if there are some I-frames to ack. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__clear_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SEND_PBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_send_srejframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">expected:</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">txseq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
		<span class="n">bt_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">sar</span><span class="p">;</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_reassemble_sdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">buffer_seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_REJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">l2cap_retransmit_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_acked</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_acked</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_to_ack</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">num_acked</span> <span class="o">==</span> <span class="n">num_to_ack</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__set_ack_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_data_channel_rrframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, req_seq %d ctrl 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
				<span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">),</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="n">l2cap_drop_acked_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">__set_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
			<span class="n">l2cap_send_srejtail</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l2cap_send_i_or_rr_or_rnr</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_REJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">l2cap_retransmit_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">__set_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">l2cap_send_ack</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_data_channel_rejframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, req_seq %d ctrl 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
	<span class="n">l2cap_drop_acked_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_REJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">l2cap_retransmit_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l2cap_retransmit_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_REJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_data_channel_srejframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, req_seq %d ctrl 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
		<span class="n">l2cap_drop_acked_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="n">l2cap_retransmit_one_frame</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>

		<span class="n">l2cap_ertm_send</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_save_reqseq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SREJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_save_reqseq</span> <span class="o">==</span> <span class="n">tx_seq</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_SREJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">l2cap_retransmit_one_frame</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l2cap_retransmit_one_frame</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">srej_save_reqseq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SREJ_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_data_channel_rnrframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, req_seq %d ctrl 0x%8.8x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span> <span class="o">=</span> <span class="n">tx_seq</span><span class="p">;</span>
	<span class="n">l2cap_drop_acked_frames</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_SEND_FBIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_SREJ_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__clear_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span>
			<span class="n">l2cap_send_rr_or_rnr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_CTRL_FINAL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_poll</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l2cap_send_srejtail</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_control</span> <span class="o">=</span> <span class="n">__set_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_SUPER_RR</span><span class="p">);</span>
		<span class="n">l2cap_send_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_data_channel_sframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_control</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p rx_control 0x%8.8x len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_ctrl_final</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__clear_monitor_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">unacked_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">__set_retrans_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_WAIT_F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">__get_ctrl_super</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_SUPER_RR</span>:
		<span class="n">l2cap_data_channel_rrframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SUPER_REJ</span>:
		<span class="n">l2cap_data_channel_rejframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SUPER_SREJ</span>:
		<span class="n">l2cap_data_channel_srejframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_SUPER_RNR</span>:
		<span class="n">l2cap_data_channel_rnrframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">rx_control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_ertm_data_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">req_seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">next_tx_seq_offset</span><span class="p">,</span> <span class="n">req_seq_offset</span><span class="p">;</span>

	<span class="n">__unpack_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">__get_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">__ctrl_size</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can just drop the corrupted I-frame here.</span>
<span class="cm">	 * Receiver will miss it and start proper recovery</span>
<span class="cm">	 * procedures and ask retransmission.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_check_fcs</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__is_sar_start</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">__is_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req_seq</span> <span class="o">=</span> <span class="n">__get_reqseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="n">req_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">req_seq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span><span class="p">);</span>

	<span class="n">next_tx_seq_offset</span> <span class="o">=</span> <span class="n">__seq_offset</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span><span class="p">,</span>
						<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span><span class="p">);</span>

	<span class="cm">/* check for invalid req-seq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_seq_offset</span> <span class="o">&gt;</span> <span class="n">next_tx_seq_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__is_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l2cap_data_channel_iframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l2cap_data_channel_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_data_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_get_chan_by_scid</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;unknown cid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="cm">/* Drop packet and return */</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_MODE_BASIC</span>:
		<span class="cm">/* If socket recv buffers overflows we drop data here</span>
<span class="cm">		 * which is *bad* because L2CAP has to be reliable.</span>
<span class="cm">		 * But we don&#39;t have any other choice. L2CAP doesn&#39;t</span>
<span class="cm">		 * provide flow control mechanism. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_ERTM</span>:
		<span class="n">l2cap_ertm_data_rcv</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_MODE_STREAMING</span>:
		<span class="n">control</span> <span class="o">=</span> <span class="n">__get_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">__ctrl_size</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_check_fcs</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__is_sar_start</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">L2CAP_SDULEN_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">==</span> <span class="n">L2CAP_FCS_CRC16</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">L2CAP_FCS_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mps</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">__is_sframe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="n">tx_seq</span> <span class="o">=</span> <span class="n">__get_txseq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">!=</span> <span class="n">tx_seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Frame(s) missing - must discard partial SDU */</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_last_frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* TODO: Notify userland of missing data */</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">expected_tx_seq</span> <span class="o">=</span> <span class="n">__next_seq</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx_seq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l2cap_reassemble_sdu</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">)</span>
			<span class="n">l2cap_send_disconn_req</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ECONNRESET</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p: bad mode 0x%2.2x&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_conless_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_global_chan_by_psm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">psm</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_BOUND</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_att_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">l2cap_global_chan_by_scid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p, len %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_BOUND</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">imtu</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2cap_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">lh</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cid</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">psm</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">);</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">lh</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">lh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;len %d, cid 0x%4.4x&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2CAP_CID_LE_SIGNALING</span>:
	<span class="k">case</span> <span class="n">L2CAP_CID_SIGNALING</span>:
		<span class="n">l2cap_sig_channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CID_CONN_LESS</span>:
		<span class="n">psm</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">l2cap_conless_channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">psm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CID_LE_DATA</span>:
		<span class="n">l2cap_att_channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">L2CAP_CID_SMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">smp_sig_channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="n">l2cap_conn_del</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hcon</span><span class="p">,</span> <span class="n">EACCES</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">l2cap_data_channel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ---- L2CAP interface with lower layer (HCI) ---- */</span>

<span class="kt">int</span> <span class="nf">l2cap_connect_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exact</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lm1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lm2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hdev %s, bdaddr %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">bdaddr</span><span class="p">));</span>

	<span class="cm">/* Find listening sockets and check their link_mode */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">global_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BT_LISTEN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lm1</span> <span class="o">|=</span> <span class="n">HCI_LM_ACCEPT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ROLE_SWITCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">lm1</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
			<span class="n">exact</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lm2</span> <span class="o">|=</span> <span class="n">HCI_LM_ACCEPT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ROLE_SWITCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">lm2</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">exact</span> <span class="o">?</span> <span class="n">lm1</span> <span class="o">:</span> <span class="n">lm2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_connect_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p bdaddr %s status %d&quot;</span><span class="p">,</span> <span class="n">hcon</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">l2cap_conn_add</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
			<span class="n">l2cap_conn_ready</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">l2cap_conn_del</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="n">bt_to_errno</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_disconn_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p&quot;</span><span class="p">,</span> <span class="n">hcon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HCI_ERROR_REMOTE_USER_TERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_reason</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_disconn_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p reason %d&quot;</span><span class="p">,</span> <span class="n">hcon</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="n">l2cap_conn_del</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="n">bt_to_errno</span><span class="p">(</span><span class="n">reason</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_check_encryption</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u8</span> <span class="n">encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_type</span> <span class="o">!=</span> <span class="n">L2CAP_CHAN_CONN_ORIENTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_MEDIUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_ENC_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span>
			<span class="n">l2cap_chan_close</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ECONNREFUSED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_MEDIUM</span><span class="p">)</span>
			<span class="n">__clear_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_security_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hcon</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">encrypt</span><span class="p">)</span>
			<span class="n">smp_distribute_keys</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_chan_lock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan-&gt;scid %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span> <span class="o">==</span> <span class="n">L2CAP_CID_LE_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">encrypt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">;</span>
				<span class="n">l2cap_chan_ready</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONF_CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">conf_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span> <span class="o">||</span>
						<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONFIG</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BT_SK_SUSPEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

			<span class="n">l2cap_check_encryption</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>
			<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">l2cap_send_conn_req</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_DISC_TIMEOUT</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECT2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="n">rsp</span><span class="p">;</span>
			<span class="n">__u16</span> <span class="n">res</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

			<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BT_SK_DEFER_SETUP</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">L2CAP_CR_PEND</span><span class="p">;</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="n">L2CAP_CS_AUTHOR_PEND</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
						<span class="n">parent</span><span class="o">-&gt;</span><span class="n">sk_data_ready</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_CONFIG</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">L2CAP_CR_SUCCESS</span><span class="p">;</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">__l2cap_state_change</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">BT_DISCONN</span><span class="p">);</span>
				<span class="n">__set_chan_timer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">L2CAP_DISC_TIMEOUT</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">L2CAP_CR_SEC_BLOCK</span><span class="p">;</span>
				<span class="n">stat</span> <span class="o">=</span> <span class="n">L2CAP_CS_NO_INFO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

			<span class="n">rsp</span><span class="p">.</span><span class="n">scid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">dcid</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">l2cap_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">L2CAP_CONN_RSP</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">l2cap_chan_unlock</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">l2cap_recv_acldata</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">hcon</span><span class="o">-&gt;</span><span class="n">l2cap_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">l2cap_conn_add</span><span class="p">(</span><span class="n">hcon</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p len %d flags 0x%x&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ACL_CONT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unexpected start frame (len %d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">l2cap_conn_unreliable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ECOMM</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Start fragment always begin with Basic L2CAP header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Frame is too short (len %d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">l2cap_conn_unreliable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ECOMM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Complete frame received */</span>
			<span class="n">l2cap_recv_frame</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Start: total len %d, frag len %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Frame is too long (len %d, expected len %d)&quot;</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">l2cap_conn_unreliable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ECOMM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate skb for the complete frame (with header) */</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">bt_skb_alloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
								<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;Cont: frag len %d (expecting %d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Unexpected continuation frame (len %d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">l2cap_conn_unreliable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ECOMM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Fragment is too long (len %d, expected %d)&quot;</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">l2cap_conn_unreliable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ECOMM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
								<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">-=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Complete frame received */</span>
			<span class="n">l2cap_recv_frame</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_debugfs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">global_l</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%s %s %d %d 0x%4.4x 0x%4.4x %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
					<span class="n">batostr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">),</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">),</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">scid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">dcid</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">imtu</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">omtu</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l2cap_debugfs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">l2cap_debugfs_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">l2cap_debugfs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">l2cap_debugfs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">l2cap_debugfs</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">l2cap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">l2cap_init_sockets</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt_debugfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2cap_debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;l2cap&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
					<span class="n">bt_debugfs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l2cap_debugfs_fops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l2cap_debugfs</span><span class="p">)</span>
			<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;Failed to create L2CAP debug file&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">l2cap_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">l2cap_debugfs</span><span class="p">);</span>
	<span class="n">l2cap_cleanup_sockets</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">disable_ertm</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_ertm</span><span class="p">,</span> <span class="s">&quot;Disable enhanced retransmission mode&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
