<!DOCTYPE html>
<html><head><title>joekychen/linux » net › bluetooth › hci_conn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hci_conn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (c) 2000-2001, 2010, Code Aurora Forum. All rights reserved.</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cm">/* Bluetooth HCI connection handling. */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci_core.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_le_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_create_conn</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">|=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_LOW</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">scan_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0060</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">scan_window</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0030</span><span class="p">);</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">peer_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">peer_addr_type</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst_type</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">conn_interval_min</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0028</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">conn_interval_max</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0038</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">supervision_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x002a</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">min_ce_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">max_ce_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_CREATE_CONN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_le_connect_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_CREATE_CONN_CANCEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_acl_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_create_conn</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hcon %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">=</span> <span class="n">HCI_LM_MASTER</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">attempt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_policy</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inquiry_entry_age</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">INQUIRY_ENTRY_AGE_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">pscan_rep_mode</span> <span class="o">=</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pscan_rep_mode</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">pscan_mode</span>     <span class="o">=</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pscan_mode</span><span class="p">;</span>
			<span class="n">cp</span><span class="p">.</span><span class="n">clock_offset</span>   <span class="o">=</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">clock_offset</span> <span class="o">|</span>
							<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">dev_class</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ssp_mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lmp_rswitch_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_MASTER</span><span class="p">))</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">role_switch</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">role_switch</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_CREATE_CONN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_acl_connect_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_create_conn_cancel</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">hci_ver</span> <span class="o">&lt;</span> <span class="n">BLUETOOTH_VER_1_2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_CREATE_CONN_CANCEL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_acl_disconn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_disconnect</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_DISCONN</span><span class="p">;</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_DISCONNECT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_add_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_add_sco</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">attempt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_ADD_SCO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_setup_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_setup_sync_conn</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CONNECT</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">attempt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>   <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">tx_bandwidth</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00001f40</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">rx_bandwidth</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00001f40</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">max_latency</span>    <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">voice_setting</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">voice_setting</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">retrans_effort</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SETUP_SYNC_CONN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_le_conn_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">min</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">latency</span><span class="p">,</span> <span class="n">u16</span> <span class="n">to_multiplier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_conn_update</span> <span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>		<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">conn_interval_min</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">min</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">conn_interval_max</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">max</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">conn_latency</span>		<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">supervision_timeout</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">to_multiplier</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">min_ce_len</span>		<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">max_ce_len</span>		<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_CONN_UPDATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_le_conn_update</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">hci_le_start_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">ediv</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
							<span class="n">__u8</span> <span class="n">ltk</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_cp_le_start_enc</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

	<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">ltk</span><span class="p">,</span> <span class="n">ltk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">ltk</span><span class="p">));</span>
	<span class="n">cp</span><span class="p">.</span><span class="n">ediv</span> <span class="o">=</span> <span class="n">ediv</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">rand</span><span class="p">,</span> <span class="n">rand</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">rand</span><span class="p">));</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_LE_START_ENC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_le_start_enc</span><span class="p">);</span>

<span class="cm">/* Device _must_ be locked */</span>
<span class="kt">void</span> <span class="nf">hci_sco_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">sco</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sco</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_esco_capable</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">hci_setup_sync</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hci_add_sco</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hci_proto_connect_cfm</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">sco</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_conn_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span><span class="p">,</span>
							<span class="n">disc_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p state %s&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">state_to_string</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BT_CONNECT</span>:
	<span class="k">case</span> <span class="n">BT_CONNECT2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span>
				<span class="n">hci_acl_connect_cancel</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span>
				<span class="n">hci_le_connect_cancel</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BT_CONFIG</span>:
	<span class="k">case</span> <span class="n">BT_CONNECTED</span>:
		<span class="n">reason</span> <span class="o">=</span> <span class="n">hci_proto_disconn_ind</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">hci_acl_disconn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enter sniff mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_conn_enter_sniff_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p mode %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lmp_sniff_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">lmp_sniff_capable</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">HCI_CM_ACTIVE</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_policy</span> <span class="o">&amp;</span> <span class="n">HCI_LP_SNIFF</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lmp_sniffsubr_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lmp_sniffsubr_capable</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_sniff_subrate</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>             <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">max_latency</span>        <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">min_remote_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">min_local_timeout</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SNIFF_SUBRATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_sniff_mode</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>       <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">max_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sniff_max_interval</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">min_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">sniff_min_interval</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">attempt</span>      <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">timeout</span>      <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SNIFF_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_conn_idle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p mode %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">hci_conn_enter_sniff_mode</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_conn_auto_accept</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_USER_CONFIRM_REPLY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">),</span>
								<span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_conn_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s dst %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span>  <span class="o">=</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span>  <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span>  <span class="o">=</span> <span class="n">HCI_CM_ACTIVE</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_OPEN</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">HCI_AT_GENERAL_BONDING</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">io_capability</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">io_capability</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">remote_auth</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span> <span class="o">=</span> <span class="n">HCI_DISCONN_TIMEOUT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">ACL_PTYPE_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCO_LINK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp_esco_capable</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">&amp;</span> <span class="n">SCO_ESCO_MASK</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">&amp;</span> <span class="n">EDR_ESCO_MASK</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">&amp;</span> <span class="n">SCO_PTYPE_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">esco_type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EDR_ESCO_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_work</span><span class="p">,</span> <span class="n">hci_conn_timeout</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">hci_conn_idle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auto_accept_timer</span><span class="p">,</span> <span class="n">hci_conn_auto_accept</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hci_dev_hold</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">hci_conn_hash_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_NOTIFY_CONN_ADD</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">devref</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hci_conn_init_sysfs</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_conn_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s conn %p handle %d&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_work</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auto_accept_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">sco</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sco</span><span class="p">)</span>
			<span class="n">sco</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Unacked frames */</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">+=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_pkts</span><span class="p">)</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">le_cnt</span> <span class="o">+=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">acl_cnt</span> <span class="o">+=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">hci_chan_list_flush</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">hci_conn_hash_del</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_NOTIFY_CONN_DEL</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

	<span class="n">hci_conn_put_device</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="nf">hci_get_route</span><span class="p">(</span><span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">use_src</span> <span class="o">=</span> <span class="n">bacmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">BDADDR_ANY</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s -&gt; %s&quot;</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">batostr</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Simple routing:</span>
<span class="cm">		 *   No source address - find interface with bdaddr != dst</span>
<span class="cm">		 *   Source address    - find interface with bdaddr == src</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hdev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hdev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span>
		<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_hold</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_dev_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_get_route</span><span class="p">);</span>

<span class="cm">/* Create SCO, ACL or LE connection.</span>
<span class="cm"> * Device _must_ be locked */</span>
<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			     <span class="n">__u8</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">sco</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">le</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s dst %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">batostr</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">le</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">le</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">LE_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

			<span class="n">le</span><span class="o">-&gt;</span><span class="n">dst_type</span> <span class="o">=</span> <span class="n">bdaddr_to_le</span><span class="p">(</span><span class="n">dst_type</span><span class="p">);</span>
			<span class="n">hci_le_connect</span><span class="p">(</span><span class="n">le</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">le</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">=</span> <span class="n">sec_level</span><span class="p">;</span>
		<span class="n">le</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span><span class="p">;</span>

		<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">le</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">le</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acl</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acl</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acl</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_OPEN</span> <span class="o">||</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CLOSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acl</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_LOW</span><span class="p">;</span>
		<span class="n">acl</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">=</span> <span class="n">sec_level</span><span class="p">;</span>
		<span class="n">acl</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span><span class="p">;</span>
		<span class="n">hci_acl_connect</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">acl</span><span class="p">;</span>

	<span class="n">sco</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sco</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sco</span> <span class="o">=</span> <span class="n">hci_conn_add</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hci_conn_put</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">sco</span><span class="p">;</span>
	<span class="n">sco</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>

	<span class="n">hci_conn_hold</span><span class="p">(</span><span class="n">sco</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sco</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_OPEN</span> <span class="o">||</span> <span class="n">sco</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CLOSED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hci_conn_enter_active_mode</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">BT_POWER_FORCE_ACTIVE_ON</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* defer SCO setup until mode change completed */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_SCO_SETUP_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sco</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hci_sco_setup</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sco</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_connect</span><span class="p">);</span>

<span class="cm">/* Check link security requirement */</span>
<span class="kt">int</span> <span class="nf">hci_conn_check_link_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hci_conn_ssp_enabled</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_check_link_mode</span><span class="p">);</span>

<span class="cm">/* Authenticate remote device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hci_conn_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">&gt;</span> <span class="n">sec_level</span><span class="p">)</span>
		<span class="n">sec_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec_level</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">=</span> <span class="n">sec_level</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_AUTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Make sure we preserve an existing MITM requirement*/</span>
	<span class="n">auth_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_auth_requested</span> <span class="n">cp</span><span class="p">;</span>

		<span class="cm">/* encrypt must be pending if auth is also pending */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_AUTH_REQUESTED</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">HCI_CONN_REAUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encrypt the the link */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hci_conn_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_set_conn_encrypt</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SET_CONN_ENCRYPT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
									<span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enable security */</span>
<span class="kt">int</span> <span class="nf">hci_conn_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="cm">/* For sdp we don&#39;t need the link key. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_SDP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* For non 2.1 devices and low security level we don&#39;t need the link</span>
<span class="cm">	   key. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_LOW</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hci_conn_ssp_enabled</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* For other security levels we need the link key. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_AUTH</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">auth</span><span class="p">;</span>

	<span class="cm">/* An authenticated combination key has sufficient security for any</span>
<span class="cm">	   security level. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">HCI_LK_AUTH_COMBINATION</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="cm">/* An unauthenticated combination key has sufficient security for</span>
<span class="cm">	   security level 1 and 2. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">HCI_LK_UNAUTH_COMBINATION</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_MEDIUM</span> <span class="o">||</span>
			<span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_LOW</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="cm">/* A combination key has always sufficient security for the security</span>
<span class="cm">	   levels 1 or 2. High security level requires the combination key</span>
<span class="cm">	   is generated using maximum PIN code length (16).</span>
<span class="cm">	   For pre 2.1 units. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">HCI_LK_COMBINATION</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sec_level</span> <span class="o">!=</span> <span class="n">BT_SECURITY_HIGH</span> <span class="o">||</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">pin_length</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">encrypt</span><span class="p">;</span>

<span class="nl">auth:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hci_conn_auth</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">encrypt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hci_conn_encrypt</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_security</span><span class="p">);</span>

<span class="cm">/* Check secure link requirement */</span>
<span class="kt">int</span> <span class="nf">hci_conn_check_secure</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec_level</span> <span class="o">!=</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Accept if non-secure is required */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reject not secure link */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_check_secure</span><span class="p">);</span>

<span class="cm">/* Change link key */</span>
<span class="kt">int</span> <span class="nf">hci_conn_change_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_change_conn_link_key</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_CHANGE_CONN_LINK_KEY</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_change_link_key</span><span class="p">);</span>

<span class="cm">/* Switch role */</span>
<span class="kt">int</span> <span class="nf">hci_conn_switch_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_MASTER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_RSWITCH_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_switch_role</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_SWITCH_ROLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_switch_role</span><span class="p">);</span>

<span class="cm">/* Enter active mode */</span>
<span class="kt">void</span> <span class="nf">hci_conn_enter_active_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">force_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p mode %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_RAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">HCI_CM_SNIFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_active</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cp_exit_sniff_mode</span> <span class="n">cp</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">hci_send_cmd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">HCI_OP_EXIT_SNIFF_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">timer:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">idle_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span>
			<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">idle_timeout</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Drop all connection on the device */</span>
<span class="kt">void</span> <span class="nf">hci_conn_hash_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hdev %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BT_CLOSED</span><span class="p">;</span>

		<span class="n">hci_proto_disconn_cfm</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">HCI_ERROR_LOCAL_HOST_TERM</span><span class="p">);</span>
		<span class="n">hci_conn_del</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Check pending connect attempts */</span>
<span class="kt">void</span> <span class="nf">hci_conn_check_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;hdev %s&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_state</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="n">BT_CONNECT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">hci_acl_connect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_conn_hold_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">devref</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_hold_device</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">hci_conn_put_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">devref</span><span class="p">))</span>
		<span class="n">hci_conn_del_sysfs</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hci_conn_put_device</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hci_get_conn_list</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn_list_req</span> <span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="n">conn_num</span> <span class="o">||</span> <span class="n">req</span><span class="p">.</span><span class="n">conn_num</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ci</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="p">.</span><span class="n">conn_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ci</span><span class="p">);</span>

	<span class="n">cl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hci_dev_get</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">conn_info</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span>  <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">out</span>   <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
		<span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="p">(</span><span class="n">ci</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">link_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="p">.</span><span class="n">conn_num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">conn_num</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ci</span><span class="p">);</span>

	<span class="n">hci_dev_put</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_get_conn_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_info_req</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn_info</span> <span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bacpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">ci</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">ci</span><span class="p">.</span><span class="n">type</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">ci</span><span class="p">.</span><span class="n">out</span>   <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
		<span class="n">ci</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">ci</span><span class="p">.</span><span class="n">link_mode</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ci</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_get_auth_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_auth_info_req</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">hci_dev_lock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">ACL_LINK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">bdaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">;</span>
	<span class="n">hci_dev_unlock</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="nf">hci_chan_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s conn %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_chan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>

	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chan</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hci_chan_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;%s conn %p chan %p&quot;</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">synchronize_rcu</span><span class="p">();</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">data_q</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hci_chan_list_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;conn %p&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">hci_chan_del</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
