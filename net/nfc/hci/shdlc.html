<!DOCTYPE html>
<html><head><title>joekychen/linux » net › nfc › hci › shdlc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>shdlc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2012  Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the</span>
<span class="cm"> * Free Software Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;shdlc: %s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/crc-ccitt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cp">#include &lt;net/nfc/hci.h&gt;</span>
<span class="cp">#include &lt;net/nfc/shdlc.h&gt;</span>

<span class="cp">#define SHDLC_LLC_HEAD_ROOM	2</span>
<span class="cp">#define SHDLC_LLC_TAIL_ROOM	2</span>

<span class="cp">#define SHDLC_MAX_WINDOW	4</span>
<span class="cp">#define SHDLC_SREJ_SUPPORT	false</span>

<span class="cp">#define SHDLC_CONTROL_HEAD_MASK	0xe0</span>
<span class="cp">#define SHDLC_CONTROL_HEAD_I	0x80</span>
<span class="cp">#define SHDLC_CONTROL_HEAD_I2	0xa0</span>
<span class="cp">#define SHDLC_CONTROL_HEAD_S	0xc0</span>
<span class="cp">#define SHDLC_CONTROL_HEAD_U	0xe0</span>

<span class="cp">#define SHDLC_CONTROL_NS_MASK	0x38</span>
<span class="cp">#define SHDLC_CONTROL_NR_MASK	0x07</span>
<span class="cp">#define SHDLC_CONTROL_TYPE_MASK	0x18</span>

<span class="cp">#define SHDLC_CONTROL_M_MASK	0x1f</span>

<span class="k">enum</span> <span class="n">sframe_type</span> <span class="p">{</span>
	<span class="n">S_FRAME_RR</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">S_FRAME_REJ</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">S_FRAME_RNR</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">S_FRAME_SREJ</span> <span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">uframe_modifier</span> <span class="p">{</span>
	<span class="n">U_FRAME_UA</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">U_FRAME_RSET</span> <span class="o">=</span> <span class="mh">0x19</span>
<span class="p">};</span>

<span class="cp">#define SHDLC_CONNECT_VALUE_MS	5</span>
<span class="cp">#define SHDLC_T1_VALUE_MS(w)	((5 * w) / 4)</span>
<span class="cp">#define SHDLC_T2_VALUE_MS	300</span>

<span class="cp">#define SHDLC_DUMP_SKB(info, skb)				  \</span>
<span class="cp">do {								  \</span>
<span class="cp">	pr_debug(&quot;%s:\n&quot;, info);				  \</span>
<span class="cp">	print_hex_dump(KERN_DEBUG, &quot;shdlc: &quot;, DUMP_PREFIX_OFFSET, \</span>
<span class="cp">		       16, 1, skb-&gt;data, skb-&gt;len, 0);		  \</span>
<span class="cp">} while (0)</span>

<span class="cm">/* checks x &lt; y &lt;= z modulo 8 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfc_shdlc_x_lt_y_lteq_z</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* checks x &lt;= y &lt; z modulo 8 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfc_shdlc_x_lteq_y_lt_z</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* x &gt; z -&gt; z+8 &gt; x */</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">nfc_shdlc_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">client_headroom</span> <span class="o">+</span> <span class="n">SHDLC_LLC_HEAD_ROOM</span> <span class="o">+</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">client_tailroom</span> <span class="o">+</span> <span class="n">SHDLC_LLC_TAIL_ROOM</span> <span class="o">+</span>
			<span class="n">payload_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">client_headroom</span> <span class="o">+</span> <span class="n">SHDLC_LLC_HEAD_ROOM</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_add_len_crc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">crc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc_ccitt</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* immediately sends an S frame. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_send_s_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">sframe_type</span> <span class="n">sframe_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sframe_type=%d nr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sframe_type</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nfc_shdlc_alloc_skb</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SHDLC_CONTROL_HEAD_S</span> <span class="o">|</span> <span class="p">(</span><span class="n">sframe_type</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">nfc_shdlc_add_len_crc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* immediately sends an U frame. skb may contain optional payload */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_send_u_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">uframe_modifier</span> <span class="n">uframe_modifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;uframe_modifier=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uframe_modifier</span><span class="p">);</span>

	<span class="o">*</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SHDLC_CONTROL_HEAD_U</span> <span class="o">|</span> <span class="n">uframe_modifier</span><span class="p">;</span>

	<span class="n">nfc_shdlc_add_len_crc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free ack_pending frames until y_nr - 1, and reset t2 according to</span>
<span class="cm"> * the remaining oldest ack_pending frame sent time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_reset_t2</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dnr</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">;</span>	<span class="cm">/* MUST initially be &lt; y_nr */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;release ack pending up to frame %d excluded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dnr</span> <span class="o">!=</span> <span class="n">y_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;release ack pending frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dnr</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">dnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">);</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">pr_debug</span>
			    <span class="p">(</span><span class="s">&quot;All sent frames acked. Stopped T2(retransmit)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SHDLC_T2_VALUE_MS</span><span class="p">));</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">pr_debug</span>
		    <span class="p">(</span><span class="s">&quot;Start T2(retransmit) for remaining unacked sent frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive validated frames from lower layer. skb contains HCI payload only.</span>
<span class="cm"> * Handle according to algorithm at spec:10.8.2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_rcv_i_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x_ns</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_nr</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;recvd I-frame %d, remote waiting frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SHDLC_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x_ns</span> <span class="o">!=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfc_shdlc_send_s_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">S_FRAME_REJ</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">,</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SHDLC_T1_VALUE_MS</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">)));</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;(re)Start T1(send ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfc_hci_recv_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfc_shdlc_x_lt_y_lteq_z</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfc_shdlc_reset_t2</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">);</span>

		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">=</span> <span class="n">y_nr</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_rcv_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;remote acked up to frame %d excluded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfc_shdlc_x_lt_y_lteq_z</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfc_shdlc_reset_t2</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">);</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">=</span> <span class="n">y_nr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_requeue_ack_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ns reset to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* remove len+control */</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* remove crc */</span>
		<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_rcv_rej</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;remote asks retransmition from frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfc_shdlc_x_lteq_y_lt_z</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">,</span> <span class="n">y_nr</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">);</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Stopped T2(retransmit)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">!=</span> <span class="n">y_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">=</span> <span class="p">((</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="n">y_nr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">nfc_shdlc_requeue_ack_pending</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* See spec RR:10.8.3 REJ:10.8.4 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_rcv_s_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">sframe_type</span> <span class="n">s_frame_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SHDLC_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">s_frame_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S_FRAME_RR</span>:
		<span class="n">nfc_shdlc_rcv_ack</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rnr</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* see SHDLC 10.7.7 */</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rnr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">nfc_shdlc_alloc_skb</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_FRAME_REJ</span>:
		<span class="n">nfc_shdlc_rcv_rej</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_FRAME_RNR</span>:
		<span class="n">nfc_shdlc_rcv_ack</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rnr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_connect_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_CONNECTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_DISCONNECTED</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * TODO: Could it be possible that there are pending</span>
<span class="cm">		 * executing commands that are waiting for connect to complete</span>
<span class="cm">		 * before they can be carried? As connect is a blocking</span>
<span class="cm">		 * operation, it would require that the userspace process can</span>
<span class="cm">		 * send commands on the same device from a second thread before</span>
<span class="cm">		 * the device is up. I don&#39;t think that is possible, is it?</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_result</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_connect_initiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nfc_shdlc_alloc_skb</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SHDLC_MAX_WINDOW</span><span class="p">;</span>
	<span class="o">*</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SHDLC_SREJ_SUPPORT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfc_shdlc_send_u_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">U_FRAME_RSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_connect_send_ua</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">nfc_shdlc_alloc_skb</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfc_shdlc_send_u_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">U_FRAME_UA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_rcv_u_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">uframe_modifier</span> <span class="n">u_frame_modifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">w</span> <span class="o">=</span> <span class="n">SHDLC_MAX_WINDOW</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">srej_support</span> <span class="o">=</span> <span class="n">SHDLC_SREJ_SUPPORT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;u_frame_modifier=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u_frame_modifier</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">u_frame_modifier</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">U_FRAME_RSET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SHDLC_NEGOCIATING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we sent RSET, but chip wants to negociate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">w</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">srej_support</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span>
					       <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">SHDLC_MAX_WINDOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">SHDLC_SREJ_SUPPORT</span> <span class="o">||</span> <span class="p">(</span><span class="n">srej_support</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
				<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">srej_support</span> <span class="o">=</span> <span class="n">srej_support</span><span class="p">;</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">nfc_shdlc_connect_send_ua</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
				<span class="n">nfc_shdlc_connect_complete</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">SHDLC_NEGOCIATING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: Chip wants to reset link</span>
<span class="cm">			 * send ua, empty skb lists, reset counters</span>
<span class="cm">			 * propagate info to HCI layer</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">U_FRAME_UA</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SHDLC_CONNECTING</span> <span class="o">&amp;&amp;</span>
		     <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SHDLC_NEGOCIATING</span><span class="p">))</span>
			<span class="n">nfc_shdlc_connect_complete</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_handle_rcv_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sframe_type</span> <span class="n">s_frame_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uframe_modifier</span> <span class="n">u_frame_modifier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rcvQlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">.</span><span class="n">qlen</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_HEAD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SHDLC_CONTROL_HEAD_I</span>:
		<span class="k">case</span> <span class="n">SHDLC_CONTROL_HEAD_I2</span>:
			<span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_NS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_NR_MASK</span><span class="p">;</span>
			<span class="n">nfc_shdlc_rcv_i_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SHDLC_CONTROL_HEAD_S</span>:
			<span class="n">s_frame_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_NR_MASK</span><span class="p">;</span>
			<span class="n">nfc_shdlc_rcv_s_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">s_frame_type</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SHDLC_CONTROL_HEAD_U</span>:
			<span class="n">u_frame_modifier</span> <span class="o">=</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="n">SHDLC_CONTROL_M_MASK</span><span class="p">;</span>
			<span class="n">nfc_shdlc_rcv_u_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">u_frame_modifier</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;UNKNOWN Control=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_w_used</span><span class="p">(</span><span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unack_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dnr</span> <span class="o">&lt;=</span> <span class="n">ns</span><span class="p">)</span>
		<span class="n">unack_count</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">dnr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">unack_count</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">dnr</span> <span class="o">+</span> <span class="n">ns</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">unack_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send frames according to algorithm at spec:10.8.1 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_handle_send_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time_sent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
		<span class="n">pr_debug</span>
		    <span class="p">(</span><span class="s">&quot;sendQlen=%d ns=%d dnr=%d rnr=%s w_room=%d unackQlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">.</span><span class="n">qlen</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">,</span>
		     <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rnr</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">?</span> <span class="s">&quot;false&quot;</span> <span class="o">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
		     <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">-</span> <span class="n">nfc_shdlc_w_used</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">dnr</span><span class="p">),</span>
		     <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">.</span><span class="n">qlen</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">.</span><span class="n">qlen</span> <span class="o">&lt;</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rnr</span> <span class="o">==</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">);</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Stopped T1(send ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">);</span>

		<span class="o">*</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SHDLC_CONTROL_HEAD_I</span> <span class="o">|</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Sending I-Frame %d, waiting to rcv %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span>
			 <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="cm">/*	SHDLC_DUMP_SKB(&quot;shdlc frame written&quot;, skb); */</span>

		<span class="n">nfc_shdlc_add_len_crc</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: Cannot send, shdlc machine is dead, we</span>
<span class="cm">			 * must propagate the information up to HCI.</span>
<span class="cm">			 */</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hard_fault</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">time_sent</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">=</span> <span class="n">time_sent</span><span class="p">;</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">,</span> <span class="n">time_sent</span> <span class="o">+</span>
				  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SHDLC_T2_VALUE_MS</span><span class="p">));</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Started T2 (retransmit)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_connect_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_t1_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SoftIRQ: need to send ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_t2_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SoftIRQ: need to retransmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_sm_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfc_shdlc</span><span class="p">,</span> <span class="n">sm_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SHDLC_DISCONNECTED</span>:
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHDLC_CONNECTING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_tries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">nfc_shdlc_connect_initiate</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfc_shdlc_connect_complete</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SHDLC_CONNECT_VALUE_MS</span><span class="p">));</span>

			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_NEGOCIATING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHDLC_NEGOCIATING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_CONNECTING</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nfc_shdlc_handle_rcv_queue</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHDLC_CONNECTED</span>:
		<span class="n">nfc_shdlc_handle_rcv_queue</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
		<span class="n">nfc_shdlc_handle_send_queue</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span> <span class="o">&amp;&amp;</span> <span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span>
			    <span class="p">(</span><span class="s">&quot;Handle T1(send ack) elapsed (T1 now inactive)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">nfc_shdlc_send_s_frame</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">S_FRAME_RR</span><span class="p">,</span>
						   <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hard_fault</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">&amp;&amp;</span> <span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span>
			    <span class="p">(</span><span class="s">&quot;Handle T2(retransmit) elapsed (T2 inactive)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">nfc_shdlc_requeue_ack_pending</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
			<span class="n">nfc_shdlc_handle_send_queue</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hard_fault</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: Handle hard_fault that occured during</span>
<span class="cm">			 * this invocation of the shdlc worker</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from syscall context to establish shdlc link. Sleeps until</span>
<span class="cm"> * link is ready or failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAIT_QUEUE_HEAD_ONSTACK</span><span class="p">(</span><span class="n">connect_wq</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_CONNECTING</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">connect_wq</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">connect_wq</span><span class="p">,</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_DISCONNECTED</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive an incoming shdlc frame. Frame has already been crc-validated.</span>
<span class="cm"> * skb contains only LLC header and payload.</span>
<span class="cm"> * If skb == NULL, it is a notification that the link below is dead.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfc_shdlc_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NULL Frame -&gt; link is dead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hard_fault</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SHDLC_DUMP_SKB</span><span class="p">(</span><span class="s">&quot;incoming frame&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_recv_frame</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">nfc_shdlc_connect</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfc_shdlc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nfc_shdlc_disconnect</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)</span>
		<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_hci_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hci_ready</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hci_ready</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">SHDLC_DUMP_SKB</span><span class="p">(</span><span class="s">&quot;queuing HCP packet to shdlc&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_start_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">protocols</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start_poll</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">start_poll</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">protocols</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_target_from_gate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">gate</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">nfc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target_from_gate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">target_from_gate</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_complete_target_discovered</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						<span class="n">u8</span> <span class="n">gate</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">nfc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">complete_target_discovered</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">complete_target_discovered</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span>
							      <span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_data_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">res_skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">data_exchange</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">data_exchange</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">res_skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfc_shdlc_check_presence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nfc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span> <span class="o">=</span> <span class="n">nfc_hci_get_clientdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_presence</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_presence</span><span class="p">(</span><span class="n">shdlc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfc_hci_ops</span> <span class="n">shdlc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">nfc_shdlc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">nfc_shdlc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hci_ready</span> <span class="o">=</span> <span class="n">nfc_shdlc_hci_ready</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit</span> <span class="o">=</span> <span class="n">nfc_shdlc_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_poll</span> <span class="o">=</span> <span class="n">nfc_shdlc_start_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_from_gate</span> <span class="o">=</span> <span class="n">nfc_shdlc_target_from_gate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete_target_discovered</span> <span class="o">=</span> <span class="n">nfc_shdlc_complete_target_discovered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data_exchange</span> <span class="o">=</span> <span class="n">nfc_shdlc_data_exchange</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_presence</span> <span class="o">=</span> <span class="n">nfc_shdlc_check_presence</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="nf">nfc_shdlc_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfc_hci_init_data</span> <span class="o">*</span><span class="n">init_data</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">protocols</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">tx_headroom</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_tailroom</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">max_link_payload</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">xmit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">shdlc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHDLC_DISCONNECTED</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">);</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shdlc</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">connect_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nfc_shdlc_connect_timeout</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">);</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shdlc</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t1_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nfc_shdlc_t1_timeout</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">);</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shdlc</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">t2_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">nfc_shdlc_t2_timeout</span><span class="p">;</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">SHDLC_MAX_WINDOW</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">srej_support</span> <span class="o">=</span> <span class="n">SHDLC_SREJ_SUPPORT</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span> <span class="n">nfc_shdlc_sm_work</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s_shdlc_sm_wq&quot;</span><span class="p">,</span> <span class="n">devname</span><span class="p">);</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">WQ_NON_REENTRANT</span> <span class="o">|</span> <span class="n">WQ_UNBOUND</span> <span class="o">|</span>
				       <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_allocwq</span><span class="p">;</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">client_headroom</span> <span class="o">=</span> <span class="n">tx_headroom</span><span class="p">;</span>
	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">client_tailroom</span> <span class="o">=</span> <span class="n">tx_tailroom</span><span class="p">;</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">nfc_hci_allocate_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc_ops</span><span class="p">,</span> <span class="n">init_data</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span>
					      <span class="n">tx_headroom</span> <span class="o">+</span> <span class="n">SHDLC_LLC_HEAD_ROOM</span><span class="p">,</span>
					      <span class="n">tx_tailroom</span> <span class="o">+</span> <span class="n">SHDLC_LLC_TAIL_ROOM</span><span class="p">,</span>
					      <span class="n">max_link_payload</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_allocdev</span><span class="p">;</span>

	<span class="n">nfc_hci_set_clientdata</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">shdlc</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">nfc_hci_register_device</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_regdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">shdlc</span><span class="p">;</span>

<span class="nl">err_regdev:</span>
	<span class="n">nfc_hci_free_device</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>

<span class="nl">err_allocdev:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">);</span>

<span class="nl">err_allocwq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_allocate</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nfc_shdlc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* TODO: Check that this cannot be called while still in use */</span>

	<span class="n">nfc_hci_unregister_device</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">nfc_hci_free_device</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">sm_wq</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">rcv_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">send_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">ack_pending_q</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">shdlc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_free</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nfc_shdlc_set_clientdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">clientdata</span> <span class="o">=</span> <span class="n">clientdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_set_clientdata</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">nfc_shdlc_get_clientdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">clientdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_get_clientdata</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">nfc_hci_dev</span> <span class="o">*</span><span class="nf">nfc_shdlc_get_hci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfc_shdlc</span> <span class="o">*</span><span class="n">shdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">shdlc</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nfc_shdlc_get_hci_dev</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
