<!DOCTYPE html>
<html><head><title>joekychen/linux » net › ipx › af_ipx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>af_ipx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Implements an IPX socket layer.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code is derived from work by</span>
<span class="cm"> *		Ross Biro	: 	Writing the original IP stack</span>
<span class="cm"> *		Fred Van Kempen :	Tidying up the TCP/IP</span>
<span class="cm"> *</span>
<span class="cm"> *	Many thanks go to Keith Baker, Institute For Industrial Information</span>
<span class="cm"> *	Technology Ltd, Swansea University for allowing me to work on this</span>
<span class="cm"> *	in my own time even though it was in some ways related to commercial</span>
<span class="cm"> *	work I am currently employed to do there.</span>
<span class="cm"> *</span>
<span class="cm"> *	All the material in this file is subject to the Gnu license version 2.</span>
<span class="cm"> *	Neither Alan Cox nor the Swansea University Computer Society admit</span>
<span class="cm"> *	liability nor provide warranty for any of this software. This material</span>
<span class="cm"> *	is provided as is and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> *	Portions Copyright (c) 2000-2003 Conectiva, Inc. &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *	Neither Arnaldo Carvalho de Melo nor Conectiva, Inc. admit liability nor</span>
<span class="cm"> *	provide warranty for any of this software. This material is provided</span>
<span class="cm"> *	&quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Portions Copyright (c) 1995 Caldera, Inc. &lt;greg@caldera.com&gt;</span>
<span class="cm"> *	Neither Greg Page nor Caldera, Inc. admit liability nor provide</span>
<span class="cm"> *	warranty for any of this software. This material is provided</span>
<span class="cm"> *	&quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> *	See net/ipx/ChangeLog.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ipx.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>

<span class="cp">#include &lt;net/ipx.h&gt;</span>
<span class="cp">#include &lt;net/p8022.h&gt;</span>
<span class="cp">#include &lt;net/psnap.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp_states.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ipx_register_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ipx_unregister_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define ipx_register_sysctl()</span>
<span class="cp">#define ipx_unregister_sysctl()</span>
<span class="cp">#endif</span>

<span class="cm">/* Configuration Variables */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ipxcfg_max_hops</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ipxcfg_auto_select_primary</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ipxcfg_auto_create_interfaces</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sysctl_ipx_pprop_broadcasting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Global Variables */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">p8022_datalink</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">pEII_datalink</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">p8023_datalink</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">pSNAP_datalink</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">ipx_dgram_ops</span><span class="p">;</span>

<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ipx_interfaces</span><span class="p">);</span>
<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">ipx_primary_net</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">ipx_internal_net</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">ipxrtr_add_route</span><span class="p">(</span><span class="n">__be32</span> <span class="n">network</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">node</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ipxrtr_del_routes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ipxrtr_route_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">usipx</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ipxrtr_route_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">ipx_route</span> <span class="o">*</span><span class="n">ipxrtr_lookup</span><span class="p">(</span><span class="n">__be32</span> <span class="n">net</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ipxrtr_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">ipx_interfaces_head</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ipx_interfaces</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipx_interface</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxcfg_set_auto_select</span><span class="p">(</span><span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipxcfg_auto_select_primary</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipx_primary_net</span><span class="p">)</span>
		<span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="n">ipx_interfaces_head</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxcfg_get_config_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_config_data</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_config_data</span> <span class="n">vals</span><span class="p">;</span>

	<span class="n">vals</span><span class="p">.</span><span class="n">ipxcfg_auto_create_interfaces</span> <span class="o">=</span> <span class="n">ipxcfg_auto_create_interfaces</span><span class="p">;</span>
	<span class="n">vals</span><span class="p">.</span><span class="n">ipxcfg_auto_select_primary</span>	   <span class="o">=</span> <span class="n">ipxcfg_auto_select_primary</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vals</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: Sockets may not be removed _during_ an interrupt or inet_bh</span>
<span class="cm"> * handler using this technique. They can be added although we do not</span>
<span class="cm"> * use this facility.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipx_remove_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Determine interface with which socket is associated */</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipx_destroy_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipx_remove_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
	<span class="n">sk_refcnt_debug_dec</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following code is used to support IPX Interfaces (IPXITF).  An</span>
<span class="cm"> * IPX interface is defined by a physical device and a frame type.</span>
<span class="cm"> */</span>

<span class="cm">/* ipxitf_clear_primary_net has to be called with ipx_interfaces_lock held */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxitf_clear_primary_net</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipxcfg_auto_select_primary</span><span class="p">)</span>
		<span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="n">ipx_interfaces_head</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">__ipxitf_find_using_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">__be16</span> <span class="n">datalink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">if_dev</span> <span class="o">==</span> <span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">if_dlink_type</span> <span class="o">==</span> <span class="n">datalink</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">ipxitf_find_using_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">__be16</span> <span class="n">datalink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">__ipxitf_find_using_phys</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">datalink</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">ipxitf_find_using_net</span><span class="p">(</span><span class="n">__be32</span> <span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">if_netnum</span> <span class="o">==</span> <span class="n">net</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">hold</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">ipx_primary_net</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="nl">hold:</span>
		<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sockets are bound to a particular IPX interface. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxitf_insert_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">intrfc</span> <span class="o">=</span> <span class="n">intrfc</span><span class="p">;</span>
	<span class="n">sk_add_node</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* caller must hold intrfc-&gt;if_sklist_lock */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">__ipxitf_find_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
					 <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipx_sk</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold a reference to intrfc */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">ipxitf_find_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
					<span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">__ipxitf_find_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="n">sock_hold</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">ipxitf_find_internal_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ipx_node</span><span class="p">,</span>
						<span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipxitf_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="cm">/* Delete all routes associated with this interface */</span>
	<span class="n">ipxrtr_del_routes</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="cm">/* error sockets */</span>
	<span class="n">sk_for_each_safe</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">=</span> <span class="n">ENOLINK</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sk_error_report</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span> <span class="cm">/* Indicates it is no longer bound */</span>
		<span class="n">sk_del_node_init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>

	<span class="cm">/* remove this interface from list */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="cm">/* remove this interface from *special* networks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">==</span> <span class="n">ipx_primary_net</span><span class="p">)</span>
		<span class="n">ipxitf_clear_primary_net</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">==</span> <span class="n">ipx_internal_net</span><span class="p">)</span>
		<span class="n">ipx_internal_net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span><span class="p">)</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ipxitf_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">__ipxitf_down</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">__ipxitf_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">__ipxitf_down</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_device_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">NETDEV_DOWN</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">NETDEV_UP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">if_dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">NETDEV_UP</span><span class="p">)</span>
				<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">__ipxitf_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">ipxitf_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">__ipxitf_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxitf_def_skb_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_queue_rcv_skb</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On input skb-&gt;sk is NULL. Nobody is charged for the memory.</span>
<span class="cm"> */</span>

<span class="cm">/* caller must hold a reference to intrfc */</span>

<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_demux_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_broadcast</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">ipx_broadcast_node</span><span class="p">,</span>
				   <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">is_broadcast</span> <span class="o">||</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">node</span><span class="p">,</span>
					     <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* We found a socket to which to send */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb1</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* skb may only be used once */</span>
			<span class="p">}</span>
			<span class="n">ipxitf_def_skb_handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">skb1</span><span class="p">);</span>

			<span class="cm">/* On an external interface, one socket can listen */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">!=</span> <span class="n">ipx_internal_net</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* skb was solely for us, and we did not make a copy, so free it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">ncp_connection_hack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The packet&#39;s target is a NCP connection handler. We want to hand it</span>
<span class="cm">	 * to the correct socket directly within the kernel, so that the</span>
<span class="cm">	 * mars_nwe packet distribution process does not have to do it. Here we</span>
<span class="cm">	 * only care about NCP and BURST packets.</span>
<span class="cm">	 *</span>
<span class="cm">	 * You might call this a hack, but believe me, you do not want a</span>
<span class="cm">	 * complete NCP layer in the kernel, and this is VERY fast as well. */</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ncphdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">ipx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ncphdr</span> <span class="o">==</span> <span class="mh">0x22</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x22</span><span class="p">)</span> <span class="cm">/* NCP request */</span>
		<span class="n">connection</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ncphdr</span> <span class="o">==</span> <span class="mh">0x77</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x77</span><span class="p">)</span> <span class="cm">/* BURST packet */</span>
		<span class="n">connection</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">ncphdr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
		<span class="cm">/* Now we have to look for a special NCP connection handling</span>
<span class="cm">		 * socket. Only these sockets have ipx_ncp_conn != 0, set by</span>
<span class="cm">		 * SIOCIPXNCPCONN. */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
		<span class="n">sk_for_each</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_ncp_conn</span> <span class="o">==</span> <span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="nl">found:</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_demux_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sock1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">sock2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">==</span> <span class="n">ipx_primary_net</span> <span class="o">&amp;&amp;</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">sock</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x451</span><span class="p">)</span>
		<span class="n">sock1</span> <span class="o">=</span> <span class="n">ncp_connection_hack</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">ipx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock1</span><span class="p">)</span>
		<span class="cm">/* No special socket found, forward the packet the normal way */</span>
		<span class="n">sock1</span> <span class="o">=</span> <span class="n">ipxitf_find_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">sock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to check if there is a primary net and if</span>
<span class="cm">	 * this is addressed to one of the *SPECIAL* sockets because</span>
<span class="cm">	 * these need to be propagated to the primary net.</span>
<span class="cm">	 * The *SPECIAL* socket list contains: 0x452(SAP), 0x453(RIP) and</span>
<span class="cm">	 * 0x456(Diagnostic).</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipx_primary_net</span> <span class="o">&amp;&amp;</span> <span class="n">intrfc</span> <span class="o">!=</span> <span class="n">ipx_primary_net</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">dsock</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">sock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dsock</span> <span class="o">==</span> <span class="mh">0x452</span> <span class="o">||</span> <span class="n">dsock</span> <span class="o">==</span> <span class="mh">0x453</span> <span class="o">||</span> <span class="n">dsock</span> <span class="o">==</span> <span class="mh">0x456</span><span class="p">)</span>
			<span class="cm">/* The appropriate thing to do here is to dup the</span>
<span class="cm">			 * packet and route to the primary net interface via</span>
<span class="cm">			 * ipxitf_send; however, we&#39;ll cheat and just demux it</span>
<span class="cm">			 * here. */</span>
			<span class="n">sock2</span> <span class="o">=</span> <span class="n">ipxitf_find_socket</span><span class="p">(</span><span class="n">ipx_primary_net</span><span class="p">,</span>
							<span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">sock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is nothing to do return. The kfree will cancel any charging.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sock2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This next segment of code is a little awkward, but it sets it up</span>
<span class="cm">	 * so that the appropriate number of copies of the SKB are made and</span>
<span class="cm">	 * that skb1 and skb2 point to it (them) so that it (they) can be</span>
<span class="cm">	 * demuxed to sock1 and/or sock2.  If we are unable to make enough</span>
<span class="cm">	 * copies, we do as much as is possible.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span>
		<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb1</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="cm">/* Do we need 2 SKBs? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock1</span> <span class="o">&amp;&amp;</span> <span class="n">sock2</span><span class="p">)</span>
		<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock1</span><span class="p">)</span>
		<span class="n">ipxitf_def_skb_handler</span><span class="p">(</span><span class="n">sock1</span><span class="p">,</span> <span class="n">skb1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock2</span><span class="p">)</span>
		<span class="n">ipxitf_def_skb_handler</span><span class="p">(</span><span class="n">sock2</span><span class="p">,</span> <span class="n">skb2</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_put:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock1</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sock1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock2</span><span class="p">)</span>
		<span class="n">sock_put</span><span class="p">(</span><span class="n">sock2</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_IPX_INTERN */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ipxitf_adjust_skbuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out_offset</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_ipx_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Hopefully, most cases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_offset</span> <span class="o">&gt;=</span> <span class="n">out_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Need new SKB */</span>
	<span class="n">len</span>  <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">out_offset</span><span class="p">;</span>
	<span class="n">skb2</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">out_offset</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
		<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb2</span><span class="p">),</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb2</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold a reference to intrfc and the skb has to be unshared */</span>
<span class="kt">int</span> <span class="nf">ipxitf_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dlink</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dest_node</span><span class="p">[</span><span class="n">IPX_NODE_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">send_to_wire</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_len</span><span class="p">;</span>

	<span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span> <span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span><span class="p">;</span>
	<span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span><span class="p">;</span>
	<span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_source</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">;</span>

	<span class="cm">/* see if we need to include the netnum in the route list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">last_hop</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">index</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
		<span class="o">*</span><span class="n">last_hop</span> <span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">netnum</span><span class="p">;</span>
		<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to know how many skbuffs it will take to send out this</span>
<span class="cm">	 * packet to avoid unnecessary copies.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dl</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span>
		<span class="n">send_to_wire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No non looped */</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if this should be demuxed to sockets on this interface</span>
<span class="cm">	 *</span>
<span class="cm">	 * We want to ensure the original was eaten or that we only use</span>
<span class="cm">	 * up clones.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">net</span> <span class="o">==</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * To our own node, loop and free the original.</span>
<span class="cm">		 * The internal net will receive on all node address.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">==</span> <span class="n">ipx_internal_net</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t charge sender */</span>
			<span class="n">skb_orphan</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* Will charge receiver */</span>
			<span class="k">return</span> <span class="n">ipxitf_demux_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Broadcast, loop and possibly keep to send on. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx_broadcast_node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_to_wire</span><span class="p">)</span>
				<span class="n">skb_orphan</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ipxitf_demux_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">send_to_wire</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_to_wire</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the originating net is not equal to our net; this is routed</span>
<span class="cm">	 * We are still charging the sender. Which is right - the driver</span>
<span class="cm">	 * free will handle this fairly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_source</span><span class="p">.</span><span class="n">net</span> <span class="o">!=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unshare the buffer before modifying the count in</span>
<span class="cm">		 * case it&#39;s a flood or tcpdump</span>
<span class="cm">		 */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_unshare</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span> <span class="o">&gt;</span> <span class="n">ipxcfg_max_hops</span><span class="p">)</span>
			<span class="n">send_to_wire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_to_wire</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine the appropriate hardware address */</span>
	<span class="n">addr_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx_broadcast_node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest_node</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">IPX_NODE_LEN</span><span class="o">-</span><span class="n">addr_len</span><span class="p">]),</span> <span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* Make any compensation for differing physical/data link size */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ipxitf_adjust_skbuff</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* set up data link and physical headers */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">);</span>

	<span class="cm">/* Send it out */</span>
	<span class="n">dl</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dest_node</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_add_local_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ipxrtr_add_route</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">,</span> <span class="n">intrfc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ipxitf_discover_netnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipxitf_pprop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>

	<span class="cm">/* See if we should update our network number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span> <span class="cm">/* net number of intrfc not known yet */</span>
		<span class="n">ipxitf_discover_netnum</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_type</span> <span class="o">==</span> <span class="n">IPX_TYPE_PPROP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_pprop</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* local processing follows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span><span class="p">)</span>
		<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">)</span>
		<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>

	<span class="cm">/* it doesn&#39;t make sense to route a pprop packet, there&#39;s no meaning</span>
<span class="cm">	 * in the ipx_dest_net for such packets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_type</span> <span class="o">!=</span> <span class="n">IPX_TYPE_PPROP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span> <span class="o">!=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We only route point-to-point packets. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_HOST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_unshare</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxrtr_route_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_intrfc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">out_free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* see if we should keep it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipx_broadcast_node</span><span class="p">,</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_demux_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_intrfc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we couldn&#39;t pawn it off so unload it */</span>
<span class="nl">out_free_skb:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out_intrfc:</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxitf_discover_netnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipx_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* see if this is an intra packet: source_net == dest_net */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span> <span class="o">==</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span> <span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span>
				<span class="n">ipxitf_find_using_net</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">);</span>
		<span class="cm">/* NB: NetWare servers lie about their hop count so we</span>
<span class="cm">		 * dropped the test based on it. This is the best way</span>
<span class="cm">		 * to determine this is a 0 hop count packet. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">;</span>
			<span class="n">ipxitf_add_local_route</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IPX: Network number collision &quot;</span>
				<span class="s">&quot;%lx</span><span class="se">\n</span><span class="s">        %s %s and %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">),</span>
				<span class="n">ipx_device_name</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				<span class="n">ipx_frame_name</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">if_dlink_type</span><span class="p">),</span>
				<span class="n">ipx_device_name</span><span class="p">(</span><span class="n">intrfc</span><span class="p">),</span>
				<span class="n">ipx_frame_name</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dlink_type</span><span class="p">));</span>
			<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipxitf_pprop - Process packet propagation IPX packet type 0x14, used for</span>
<span class="cm"> * 		  NetBIOS broadcasts</span>
<span class="cm"> * @intrfc: IPX interface receiving this packet</span>
<span class="cm"> * @skb: Received packet</span>
<span class="cm"> *</span>
<span class="cm"> * Checks if packet is valid: if its more than %IPX_MAX_PPROP_HOPS hops or if it</span>
<span class="cm"> * is smaller than a IPX header + the room for %IPX_MAX_PPROP_HOPS hops we drop</span>
<span class="cm"> * it, not even processing it locally, if it has exact %IPX_MAX_PPROP_HOPS we</span>
<span class="cm"> * don&#39;t broadcast it, but process it locally. See chapter 5 of Novell&#39;s &quot;IPX</span>
<span class="cm"> * RIP and SAP Router Specification&quot;, Part Number 107-000029-001.</span>
<span class="cm"> *</span>
<span class="cm"> * If it is valid, check if we have pprop broadcasting enabled by the user,</span>
<span class="cm"> * if not, just return zero for local processing.</span>
<span class="cm"> *</span>
<span class="cm"> * If it is enabled check the packet and don&#39;t broadcast it if we have already</span>
<span class="cm"> * seen this packet.</span>
<span class="cm"> *</span>
<span class="cm"> * Broadcast: send it to the interfaces that aren&#39;t on the packet visited nets</span>
<span class="cm"> * array, just after the IPX header.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns -EINVAL for invalid packets, so that the calling function drops</span>
<span class="cm"> * the packet without local processing. 0 if packet is to be locally processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_pprop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">ifcs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Illegal packet - too many hops or too short */</span>
	<span class="cm">/* We decide to throw it away: no broadcasting, no local processing.</span>
<span class="cm">	 * NetBIOS unaware implementations route them as normal packets -</span>
<span class="cm">	 * tctrl &lt;= 15, any data payload... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span> <span class="o">&gt;</span> <span class="n">IPX_MAX_PPROP_HOPS</span> <span class="o">||</span>
	    <span class="n">ntohs</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_pktsize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">IPX_MAX_PPROP_HOPS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* are we broadcasting this damn thing? */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysctl_ipx_pprop_broadcasting</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* We do broadcast packet on the IPX_MAX_PPROP_HOPS hop, but we</span>
<span class="cm">	 * process it locally. All previous hops broadcasted it, and process it</span>
<span class="cm">	 * locally. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span> <span class="o">==</span> <span class="n">IPX_MAX_PPROP_HOPS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ipx</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t broadcast packet if already seen this net */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="o">++</span> <span class="o">==</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* &lt; IPX_MAX_PPROP_HOPS hops &amp;&amp; input interface not in list. Save the</span>
<span class="cm">	 * position where we will insert recvd netnum into list, later on,</span>
<span class="cm">	 * in ipxitf_send */</span>
	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_hop</span><span class="p">.</span><span class="n">netnum</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>
	<span class="cm">/* xmit on all other interfaces... */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ifcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Except unconfigured interfaces */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifcs</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* That aren&#39;t in the list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifcs</span> <span class="o">==</span> <span class="n">intrfc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
		<span class="cm">/* don&#39;t consider the last entry in the packet list,</span>
<span class="cm">		 * it is our netnum, and it is not there yet */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifcs</span><span class="o">-&gt;</span><span class="n">if_netnum</span> <span class="o">==</span> <span class="o">*</span><span class="n">l</span><span class="o">++</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span> <span class="o">=</span> <span class="n">ifcs</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>
				<span class="n">ipxrtr_route_skb</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipxitf_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_interfaces</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipxcfg_auto_select_primary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipx_primary_net</span><span class="p">)</span>
		<span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="n">intrfc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">ipxitf_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">netnum</span><span class="p">,</span>
					  <span class="n">__be16</span> <span class="n">dlink_type</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">dlink</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">internal</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">ipx_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">intrfc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span>		<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span>	<span class="o">=</span> <span class="n">netnum</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dlink_type</span> 	<span class="o">=</span> <span class="n">dlink_type</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dlink</span> 	<span class="o">=</span> <span class="n">dlink</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_internal</span> 	<span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_ipx_offset</span> 	<span class="o">=</span> <span class="n">ipx_offset</span><span class="p">;</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sknum</span> 	<span class="o">=</span> <span class="n">IPX_MIN_EPHEMERAL_SOCKET</span><span class="p">;</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">intrfc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_create_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface_definition</span> <span class="o">*</span><span class="n">idef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="cm">/* Only one primary network allowed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx_primary_net</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Must have a valid network number */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_find_using_net</span><span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_alloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">),</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
	<span class="n">ipx_internal_net</span> <span class="o">=</span> <span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="n">intrfc</span><span class="p">;</span>
	<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">ipxitf_insert</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_add_local_route</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be16</span> <span class="nf">ipx_map_frame_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_ETHERII</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_8022</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_SNAP</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_SNAP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_8023</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface_definition</span> <span class="o">*</span><span class="n">idef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dlink_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">datalink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_special</span> <span class="o">==</span> <span class="n">IPX_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_create_internal</span><span class="p">(</span><span class="n">idef</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_special</span> <span class="o">==</span> <span class="n">IPX_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ipx_primary_net</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_find_using_net</span><span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span> <span class="o">&amp;&amp;</span> <span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="p">)</span>
		<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_device</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_dlink_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_8022</span>:
		<span class="n">dlink_type</span> 	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
		<span class="n">datalink</span> 	<span class="o">=</span> <span class="n">p8022_datalink</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_ETHERII</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_IEEE802</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlink_type</span> 	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">);</span>
			<span class="n">datalink</span> 	<span class="o">=</span> <span class="n">pEII_datalink</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_SNAP</span>:
		<span class="n">dlink_type</span> 	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_SNAP</span><span class="p">);</span>
		<span class="n">datalink</span> 	<span class="o">=</span> <span class="n">pSNAP_datalink</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_8023</span>:
		<span class="n">dlink_type</span> 	<span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>
		<span class="n">datalink</span> 	<span class="o">=</span> <span class="n">p8023_datalink</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPX_FRAME_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>

	<span class="cm">/* Check addresses are suitable */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">&gt;</span> <span class="n">IPX_NODE_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>

	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_find_using_phys</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dlink_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ok now create */</span>
		<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_network</span><span class="p">,</span> <span class="n">dlink_type</span><span class="p">,</span>
				      <span class="n">datalink</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span>
					<span class="n">datalink</span><span class="o">-&gt;</span><span class="n">header_length</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>
		<span class="cm">/* Setup primary if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_special</span> <span class="o">==</span> <span class="n">IPX_PRIMARY</span><span class="p">)</span>
			<span class="n">ipx_primary_net</span> <span class="o">=</span> <span class="n">intrfc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_node</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\000\000\000\000\000\000</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">IPX_NODE_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span> <span class="o">+</span> <span class="n">IPX_NODE_LEN</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="n">ipxitf_insert</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/* If the network number is known, add a route */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_intrfc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_add_local_route</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="nl">out_intrfc:</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_dev:</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface_definition</span> <span class="o">*</span><span class="n">idef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dlink_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_special</span> <span class="o">==</span> <span class="n">IPX_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipx_internal_net</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__ipxitf_put</span><span class="p">(</span><span class="n">ipx_internal_net</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dlink_type</span> <span class="o">=</span> <span class="n">ipx_map_frame_type</span><span class="p">(</span><span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_dlink_type</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlink_type</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">idef</span><span class="o">-&gt;</span><span class="n">ipx_device</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">__ipxitf_find_using_phys</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dlink_type</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">__ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_interfaces_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="nf">ipxitf_auto_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__be16</span> <span class="n">dlink_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">datalink</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check addresses are suitable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">&gt;</span> <span class="n">IPX_NODE_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">dlink_type</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_P_IPX</span>:		<span class="n">datalink</span> <span class="o">=</span> <span class="n">pEII_datalink</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_802_2</span>:	<span class="n">datalink</span> <span class="o">=</span> <span class="n">p8022_datalink</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_SNAP</span>:	<span class="n">datalink</span> <span class="o">=</span> <span class="n">pSNAP_datalink</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_802_3</span>:	<span class="n">datalink</span> <span class="o">=</span> <span class="n">p8023_datalink</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dlink_type</span><span class="p">,</span> <span class="n">datalink</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">+</span> <span class="n">datalink</span><span class="o">-&gt;</span><span class="n">header_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">[</span><span class="n">IPX_NODE_LEN</span><span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">]),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ipxitf_insert</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">intrfc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipxitf_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">sipx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ipx_interface_definition</span> <span class="n">f</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sipx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_family</span> <span class="o">!=</span> <span class="n">AF_IPX</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">f</span><span class="p">.</span><span class="n">ipx_network</span> <span class="o">=</span> <span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_network</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">ipx_device</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">ipx_device</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">ipx_node</span><span class="p">,</span> <span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="n">f</span><span class="p">.</span><span class="n">ipx_dlink_type</span> <span class="o">=</span> <span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_type</span><span class="p">;</span>
		<span class="n">f</span><span class="p">.</span><span class="n">ipx_special</span> <span class="o">=</span> <span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_special</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_action</span> <span class="o">==</span> <span class="n">IPX_DLTITF</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">sipx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">ipxif</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sipx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">;</span>
		<span class="n">dev</span>  <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">);</span>
		<span class="n">rc</span>   <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ipxif</span> <span class="o">=</span> <span class="n">ipxitf_find_using_phys</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">ipx_map_frame_type</span><span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_type</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxif</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_family</span>	<span class="o">=</span> <span class="n">AF_IPX</span><span class="p">;</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_network</span>	<span class="o">=</span> <span class="n">ipxif</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxif</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">ipxif</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SIOCAIPXITFCRT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipxcfg_auto_create_interfaces</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCAIPXPRISLT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipxcfg_set_auto_select</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Checksum routine for IPX</span>
<span class="cm"> */</span>

<span class="cm">/* Note: We assume ipx_tctrl==0 and htons(length)==ipx_pktsize */</span>
<span class="cm">/* This functions should *not* mess with packet contents */</span>

<span class="n">__be16</span> <span class="nf">ipx_cksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *	NOTE: sum is a net byte order quantity, which optimizes the</span>
<span class="cm">	 *	loop. This only works on big and little endian machines. (I</span>
<span class="cm">	 *	don&#39;t know of a machine that isn&#39;t.)</span>
<span class="cm">	 */</span>
	<span class="cm">/* handle the first 3 words separately; checksum should be skipped</span>
<span class="cm">	 * and ipx_tctrl masked out */</span>
	<span class="n">__u16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u16</span><span class="p">)</span><span class="n">htons</span><span class="p">(</span><span class="mh">0x00ff</span><span class="p">));</span>
	<span class="n">__u32</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Number of remaining complete words */</span>

	<span class="cm">/* Loop through them */</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Add on the last part word if it exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">ipx_pktsize</span> <span class="o">&amp;</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u16</span><span class="p">)</span><span class="n">htons</span><span class="p">(</span><span class="mh">0xff00</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="cm">/* Do final fixup */</span>
	<span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* It&#39;s a pity there&#39;s no concept of carry in C */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">sum</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Leave 0 alone; we don&#39;t want 0xffff here.  Note that we can&#39;t get</span>
<span class="cm">	 * here with 0x10000, so this check is the same as ((__u16)sum)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sum</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="o">~</span><span class="n">sum</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__be16</span><span class="p">)</span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ipx_frame_name</span><span class="p">(</span><span class="n">__be16</span> <span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_P_IPX</span>:		<span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;EtherII&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_802_2</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;802.2&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_SNAP</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;SNAP&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_802_3</span>:	<span class="n">rc</span> <span class="o">=</span> <span class="s">&quot;802.3&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ipx_device_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_internal</span> <span class="o">?</span> <span class="s">&quot;Internal&quot;</span> <span class="o">:</span>
		<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span> <span class="o">?</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handling for system calls applied via the various interfaces to an IPX</span>
<span class="cm"> * socket object. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">optval</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">SOL_IPX</span> <span class="o">&amp;&amp;</span> <span class="n">optname</span> <span class="o">==</span> <span class="n">IPX_TYPE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">SOL_IPX</span> <span class="o">&amp;&amp;</span> <span class="n">optname</span> <span class="o">==</span> <span class="n">IPX_TYPE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">optval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proto</span> <span class="n">ipx_proto</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;IPX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">obj_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_sock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SPX support is not anymore in the kernel sources. If you want to</span>
<span class="cm">	 * ressurrect it, completing it and making it understand shared skbs,</span>
<span class="cm">	 * be fully multithreaded, etc, grab the sources in an early 2.5 kernel</span>
<span class="cm">	 * tree.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_IPX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipx_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sk_refcnt_debug_inc</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_no_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Checksum off by default */</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipx_dgram_ops</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state_change</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="n">sock_set_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sk_refcnt_debug_release</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">ipx_destroy_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold a reference to intrfc */</span>

<span class="k">static</span> <span class="n">__be16</span> <span class="nf">ipx_first_free_socketnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">socketNum</span> <span class="o">=</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sknum</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socketNum</span> <span class="o">&lt;</span> <span class="n">IPX_MIN_EPHEMERAL_SOCKET</span><span class="p">)</span>
		<span class="n">socketNum</span> <span class="o">=</span> <span class="n">IPX_MIN_EPHEMERAL_SOCKET</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">__ipxitf_find_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">htons</span><span class="p">(</span><span class="n">socketNum</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">socketNum</span> <span class="o">&gt;</span> <span class="n">IPX_MAX_EPHEMERAL_SOCKET</span><span class="p">)</span>
			<span class="n">socketNum</span> <span class="o">=</span> <span class="n">IPX_MIN_EPHEMERAL_SOCKET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">socketNum</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sklist_lock</span><span class="p">);</span>
	<span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_sknum</span> <span class="o">=</span> <span class="n">socketNum</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">socketNum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ipx_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">)</span> <span class="o">||</span> <span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_find_using_net</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_network</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span> <span class="o">=</span> <span class="n">ipx_first_free_socketnum</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* protect IPX system stuff like routing/sap */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IPX_MIN_EPHEMERAL_SOCKET</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span> <span class="o">==</span> <span class="n">ipx_internal_net</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The source address is to be set explicitly if the</span>
<span class="cm">		 * socket is to be bound on the internal network. If a</span>
<span class="cm">		 * node number 0 was specified, the default is used.</span>
<span class="cm">		 */</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipx_broadcast_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipx_this_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipxitf_find_internal_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
						<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
				<span class="s">&quot;IPX: bind failed because port %X in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Source addresses are easy. It must be our</span>
<span class="cm">		 * network:node pair for an interface routed to IPX</span>
<span class="cm">		 * with the ipx routing ioctl()</span>
<span class="cm">		 */</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipxitf_find_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>
				<span class="s">&quot;IPX: bind failed because port %X in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* !def CONFIG_IPX_INTERN */</span><span class="cp"></span>

	<span class="cm">/* Source addresses are easy. It must be our network:node pair for</span>
<span class="cm">	   an interface routed to IPX with the ipx routing ioctl() */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipxitf_find_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SOCK_DEBUG</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;IPX: bind failed because port %X in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ntohs</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_IPX_INTERN */</span><span class="cp"></span>

	<span class="n">ipxitf_insert_socket</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
	<span class="n">sock_reset_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_put:</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipx_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_route</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span>	<span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> 	<span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>

	<span class="cm">/* put the autobinding in */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="n">uaddr</span><span class="p">;</span>

		<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_port</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_network</span> 	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* Someone zonked the iface */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span>
			<span class="n">IPX_NODE_LEN</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_IPX_INTERN */</span><span class="cp"></span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipx_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">uaddr</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We can either connect to primary network or somewhere</span>
<span class="cm">	 * we can route to */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">ipxrtr_lookup</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_network</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_network</span> <span class="o">&amp;&amp;</span> <span class="n">ipx_primary_net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">net</span>  <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_network</span><span class="p">;</span>
	<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_port</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
	<span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sipx_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> 	<span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> 	<span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
		<span class="n">ipxrtr_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_getname</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">uaddr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipx_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="n">sipx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">uaddr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span><span class="p">);</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">;</span>
		<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_network</span>	<span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
		<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_port</span>		<span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sipx</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_network</span> <span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_netnum</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sipx</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sipx</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span>
				<span class="n">IPX_NODE_LEN</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_IPX_INTERN */</span><span class="cp"></span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_network</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">sipx</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_port</span> <span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_family</span> <span class="o">=</span> <span class="n">AF_IPX</span><span class="p">;</span>
	<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_type</span>	 <span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">sipx</span><span class="p">.</span><span class="n">sipx_zero</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sipx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sipx</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NULL here for pt means the packet was looped back */</span>
	<span class="k">struct</span> <span class="n">ipx_interface</span> <span class="o">*</span><span class="n">intrfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ipx_pktsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* Not ours */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_OTHERHOST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">ipx_pktsize</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_pktsize</span><span class="p">);</span>

	<span class="cm">/* Too small or invalid header? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx_pktsize</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ipx_pktsize</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">ipx</span> <span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_checksum</span> <span class="o">!=</span> <span class="n">IPX_NO_CHECKSUM</span> <span class="o">&amp;&amp;</span>
	   <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_checksum</span> <span class="o">!=</span> <span class="n">ipx_cksum</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span> <span class="n">ipx_pktsize</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span>	<span class="o">=</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_tctrl</span><span class="p">;</span>
	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span>	<span class="o">=</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_dest</span><span class="p">.</span><span class="n">net</span><span class="p">;</span>
	<span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span> <span class="o">=</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_source</span><span class="p">.</span><span class="n">net</span><span class="p">;</span>

	<span class="cm">/* Determine what local ipx endpoint this is */</span>
	<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_find_using_phys</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipxcfg_auto_create_interfaces</span> <span class="o">&amp;&amp;</span>
		   <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_dest_net</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intrfc</span> <span class="o">=</span> <span class="n">ipxitf_auto_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intrfc</span><span class="p">)</span>
				<span class="n">ipxitf_hold</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrfc</span><span class="p">)</span>	<span class="cm">/* Not one of ours */</span>
				<span class="cm">/* or invalid packet for auto creation */</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_rcv</span><span class="p">(</span><span class="n">intrfc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">ipxitf_put</span><span class="p">(</span><span class="n">intrfc</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">usipx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="n">local_sipx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="cm">/* Socket gets bound below anyway */</span>
<span class="cm">/*	if (sk-&gt;sk_zapped)</span>
<span class="cm">		return -EIO; */</span>	<span class="cm">/* Socket not bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSG_DONTWAIT</span><span class="o">|</span><span class="n">MSG_CMSG_COMPAT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Max possible packet size limited by 16 bit pktsize in header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usipx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="n">uaddr</span><span class="p">;</span>

			<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_port</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_network</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* Someone zonked the iface */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span>
				<span class="n">IPX_NODE_LEN</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipx_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">uaddr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">usipx</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_family</span> <span class="o">!=</span> <span class="n">AF_IPX</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">usipx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_sipx</span><span class="p">;</span>
		<span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_family</span> 	<span class="o">=</span> <span class="n">AF_IPX</span><span class="p">;</span>
		<span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_type</span> 	<span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_port</span> 	<span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sock</span><span class="p">;</span>
		<span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_network</span> 	<span class="o">=</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">net</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">usipx</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxrtr_route_packet</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">usipx</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				 <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipx_sock</span> <span class="o">*</span><span class="n">ipxs</span> <span class="o">=</span> <span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="n">sipx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipxhdr</span> <span class="o">*</span><span class="n">ipx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="cm">/* put the autobinding in */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_ipx</span> <span class="n">uaddr</span><span class="p">;</span>

		<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_port</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_network</span> 	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IPX_INTERN</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* Someone zonked the iface */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uaddr</span><span class="p">.</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipxs</span><span class="o">-&gt;</span><span class="n">intrfc</span><span class="o">-&gt;</span><span class="n">if_node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_IPX_INTERN */</span><span class="cp"></span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipx_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">uaddr</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_ipx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_ZAPPED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSG_DONTWAIT</span><span class="p">,</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ipx</span> 	<span class="o">=</span> <span class="n">ipx_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">copied</span> 	<span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_pktsize</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_TRUNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">skb_copy_datagram_iovec</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">,</span>
				     <span class="n">copied</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
		<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_stamp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sipx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sipx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_family</span>	<span class="o">=</span> <span class="n">AF_IPX</span><span class="p">;</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_port</span>		<span class="o">=</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_source</span><span class="p">.</span><span class="n">sock</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_node</span><span class="p">,</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_source</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">IPX_NODE_LEN</span><span class="p">);</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_network</span>	<span class="o">=</span> <span class="n">IPX_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_source_net</span><span class="p">;</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_type</span> 	<span class="o">=</span> <span class="n">ipx</span><span class="o">-&gt;</span><span class="n">ipx_type</span><span class="p">;</span>
		<span class="n">sipx</span><span class="o">-&gt;</span><span class="n">sipx_zero</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">lock_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCOUTQ</span>:
		<span class="n">amount</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">-</span> <span class="n">sk_wmem_alloc_get</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCINQ</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
		<span class="cm">/* These two are safe on a single CPU system as only</span>
<span class="cm">		 * user tasks fiddle here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">amount</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipxhdr</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SIOCADDRT</span>:
	<span class="k">case</span> <span class="n">SIOCDELRT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxrtr_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSIFADDR</span>:
	<span class="k">case</span> <span class="n">SIOCAIPXITFCRT</span>:
	<span class="k">case</span> <span class="n">SIOCAIPXPRISLT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGIFADDR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxitf_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCIPXCFGDATA</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipxcfg_get_config_data</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCIPXNCPCONN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This socket wants to take care of the NCP connection</span>
<span class="cm">		 * handed to us in arg.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">ipx_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipx_ncp_conn</span><span class="p">,</span>
			      <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGSTAMP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sock_get_timestamp</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFDSTADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCSIFBRDADDR</span>:
	<span class="k">case</span> <span class="n">SIOCGIFNETMASK</span>:
	<span class="k">case</span> <span class="n">SIOCSIFNETMASK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipx_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * These 4 commands use same structure on 32bit and 64bit.  Rest of IPX</span>
<span class="cm">	 * commands is handled by generic ioctl code.  As these commands are</span>
<span class="cm">	 * SIOCPROTOPRIVATE..SIOCPROTOPRIVATE+3, they cannot be handled by generic</span>
<span class="cm">	 * code.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCAIPXITFCRT</span>:
	<span class="k">case</span> <span class="n">SIOCAIPXPRISLT</span>:
	<span class="k">case</span> <span class="n">SIOCIPXCFGDATA</span>:
	<span class="k">case</span> <span class="n">SIOCIPXNCPCONN</span>:
		<span class="k">return</span> <span class="n">ipx_ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Socket family declarations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">ipx_family_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">PF_IPX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">ipx_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">ipx_dgram_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">PF_IPX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ipx_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>		<span class="o">=</span> <span class="n">ipx_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">ipx_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">socketpair</span>	<span class="o">=</span> <span class="n">sock_no_socketpair</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accept</span>		<span class="o">=</span> <span class="n">sock_no_accept</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getname</span>	<span class="o">=</span> <span class="n">ipx_getname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">datagram_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">ipx_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">ipx_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">listen</span>		<span class="o">=</span> <span class="n">sock_no_listen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sock_no_shutdown</span><span class="p">,</span> <span class="cm">/* FIXME: support shutdown */</span>
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span> <span class="n">ipx_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span> <span class="n">ipx_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendmsg</span>	<span class="o">=</span> <span class="n">ipx_sendmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recvmsg</span>	<span class="o">=</span> <span class="n">ipx_recvmsg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">sock_no_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sendpage</span>	<span class="o">=</span> <span class="n">sock_no_sendpage</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">ipx_8023_packet_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span>		<span class="o">=</span> <span class="n">ipx_rcv</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="n">ipx_dix_packet_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">),</span>
	<span class="p">.</span><span class="n">func</span>		<span class="o">=</span> <span class="n">ipx_rcv</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ipx_dev_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">ipxitf_device_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">make_EII_client</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">destroy_EII_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ipx_8022_type</span> <span class="o">=</span> <span class="mh">0xE0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ipx_snap_id</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x37</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ipx_EII_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;IPX: Unable to register with Ethernet II</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ipx_8023_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;IPX: Unable to register with 802.3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ipx_llc_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;IPX: Unable to register with 802.2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ipx_snap_err_msg</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span>
	<span class="n">KERN_CRIT</span> <span class="s">&quot;IPX: Unable to register with SNAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">proto_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_proto</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_family_ops</span><span class="p">);</span>

	<span class="n">pEII_datalink</span> <span class="o">=</span> <span class="n">make_EII_client</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pEII_datalink</span><span class="p">)</span>
		<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_dix_packet_type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ipx_EII_err_msg</span><span class="p">);</span>

	<span class="n">p8023_datalink</span> <span class="o">=</span> <span class="n">make_8023_client</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p8023_datalink</span><span class="p">)</span>
		<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_8023_packet_type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ipx_8023_err_msg</span><span class="p">);</span>

	<span class="n">p8022_datalink</span> <span class="o">=</span> <span class="n">register_8022_client</span><span class="p">(</span><span class="n">ipx_8022_type</span><span class="p">,</span> <span class="n">ipx_rcv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p8022_datalink</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ipx_llc_err_msg</span><span class="p">);</span>

	<span class="n">pSNAP_datalink</span> <span class="o">=</span> <span class="n">register_snap_client</span><span class="p">(</span><span class="n">ipx_snap_id</span><span class="p">,</span> <span class="n">ipx_rcv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pSNAP_datalink</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ipx_snap_err_msg</span><span class="p">);</span>

	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_dev_notifier</span><span class="p">);</span>
	<span class="n">ipx_register_sysctl</span><span class="p">();</span>
	<span class="n">ipx_proc_init</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ipx_proto_finito</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipx_proc_exit</span><span class="p">();</span>
	<span class="n">ipx_unregister_sysctl</span><span class="p">();</span>

	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_dev_notifier</span><span class="p">);</span>

	<span class="n">ipxitf_cleanup</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSNAP_datalink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_snap_client</span><span class="p">(</span><span class="n">pSNAP_datalink</span><span class="p">);</span>
		<span class="n">pSNAP_datalink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p8022_datalink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_8022_client</span><span class="p">(</span><span class="n">p8022_datalink</span><span class="p">);</span>
		<span class="n">p8022_datalink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_8023_packet_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p8023_datalink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_8023_client</span><span class="p">(</span><span class="n">p8023_datalink</span><span class="p">);</span>
		<span class="n">p8023_datalink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_dix_packet_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pEII_datalink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_EII_client</span><span class="p">(</span><span class="n">pEII_datalink</span><span class="p">);</span>
		<span class="n">pEII_datalink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">proto_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipx_proto</span><span class="p">);</span>
	<span class="n">sock_unregister</span><span class="p">(</span><span class="n">ipx_family_ops</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ipx_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ipx_proto_finito</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_NETPROTO</span><span class="p">(</span><span class="n">PF_IPX</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
