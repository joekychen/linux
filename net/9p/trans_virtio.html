<!DOCTYPE html>
<html><head><title>joekychen/linux » net › 9p › trans_virtio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>trans_virtio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * The Virtio 9p transport driver</span>
<span class="cm"> *</span>
<span class="cm"> * This is a block based transport driver based on the lguest block driver</span>
<span class="cm"> * code.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007, 2008 Eric Van Hensbergen, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on virtio console driver</span>
<span class="cm"> *  Copyright (C) 2006, 2007 Rusty Russell, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *  as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to:</span>
<span class="cm"> *  Free Software Foundation</span>
<span class="cm"> *  51 Franklin Street, Fifth Floor</span>
<span class="cm"> *  Boston, MA  02111-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/un.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/9p/9p.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;net/9p/client.h&gt;</span>
<span class="cp">#include &lt;net/9p/transport.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/virtio.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_9p.h&gt;</span>
<span class="cp">#include &quot;trans_common.h&quot;</span>

<span class="cp">#define VIRTQUEUE_NUM	128</span>

<span class="cm">/* a single mutex to manage channel initialization and attachment */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">vp_wq</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">vp_pinned</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * struct virtio_chan - per-instance transport information</span>
<span class="cm"> * @initialized: whether the channel is initialized</span>
<span class="cm"> * @inuse: whether the channel is in use</span>
<span class="cm"> * @lock: protects multiple elements within this structure</span>
<span class="cm"> * @client: client instance</span>
<span class="cm"> * @vdev: virtio dev associated with this channel</span>
<span class="cm"> * @vq: virtio queue associated with this channel</span>
<span class="cm"> * @sg: scatter gather list which is used to pack a request (protected?)</span>
<span class="cm"> *</span>
<span class="cm"> * We keep all per-channel information in a structure.</span>
<span class="cm"> * This structure is allocated within the devices dev-&gt;mem space.</span>
<span class="cm"> * A pointer to the structure will get put in the transport private.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">inuse</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring_bufs_avail</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">vc_wq</span><span class="p">;</span>
	<span class="cm">/* This is global limit. Since we don&#39;t have a global structure,</span>
<span class="cm">	 * will be placing it in each channel.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">p9_max_pages</span><span class="p">;</span>
	<span class="cm">/* Scatterlist: can be too big for stack. */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">[</span><span class="n">VIRTQUEUE_NUM</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * tag name to identify a mount Non-null terminated</span>
<span class="cm">	 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">chan_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">virtio_chan_list</span><span class="p">;</span>

<span class="cm">/* How many bytes left in this page. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rest_of_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_virtio_close - reclaim resources of a channel</span>
<span class="cm"> * @client: client instance</span>
<span class="cm"> *</span>
<span class="cm"> * This reclaims a channel by freeing its resources and</span>
<span class="cm"> * reseting its inuse flag.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p9_virtio_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">inuse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * req_done - callback which signals activity from the server</span>
<span class="cm"> * @vq: virtio queue activity was received on</span>
<span class="cm"> *</span>
<span class="cm"> * This notifies us that the server has triggered some activity</span>
<span class="cm"> * on the virtio channel - most likely a response to request we</span>
<span class="cm"> * sent.  Figure out which requests now have responses and wake up</span>
<span class="cm"> * those threads.</span>
<span class="cm"> *</span>
<span class="cm"> * Bugs: could do with some additional sanity checking, but appears to work.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">req_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fcall</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;: request done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">virtqueue_get_buf</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Wakeup if anyone waiting for VirtIO ring space. */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">);</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;: rc %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;: lookup tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_tag_lookup</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">;</span>
		<span class="n">p9_client_cb</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pack_sg_list - pack a scatter gather list from a linear buffer</span>
<span class="cm"> * @sg: scatter/gather list to pack into</span>
<span class="cm"> * @start: which segment of the sg_list to start at</span>
<span class="cm"> * @limit: maximum segment to pack data to</span>
<span class="cm"> * @data: data to pack into scatter/gather list</span>
<span class="cm"> * @count: amount of data to pack into the scatter/gather list</span>
<span class="cm"> *</span>
<span class="cm"> * sg_lists have multiple segments of various sizes.  This will pack</span>
<span class="cm"> * arbitrary data into an existing scatter gather list, segmenting the</span>
<span class="cm"> * data as necessary within constraints.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pack_sg_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">rest_of_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">);</span>
		<span class="n">sg_set_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="o">-</span><span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We don&#39;t currently allow canceling of virtio requests */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_virtio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pack_sg_list_p - Just like pack_sg_list. Instead of taking a buffer,</span>
<span class="cm"> * this takes a list of pages.</span>
<span class="cm"> * @sg: scatter/gather list to pack into</span>
<span class="cm"> * @start: which segment of the sg_list to start at</span>
<span class="cm"> * @**pdata: a list of pages to add into sg.</span>
<span class="cm"> * @nr_pages: number of pages to pack into the scatter/gather list</span>
<span class="cm"> * @data: data to pack into scatter/gather list</span>
<span class="cm"> * @count: amount of data to pack into the scatter/gather list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pack_sg_list_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">start</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * if the first page doesn&#39;t start at</span>
<span class="cm">	 * page boundary find the offset</span>
<span class="cm">	 */</span>
	<span class="n">data_off</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">rest_of_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">],</span> <span class="n">pdata</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">data_off</span><span class="p">);</span>
		<span class="n">data_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">nr_pages</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">index</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_virtio_request - issue a request</span>
<span class="cm"> * @client: client instance issuing the request</span>
<span class="cm"> * @req: request to be issued</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">p9_virtio_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;9p debug: virtio request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_SENT</span><span class="p">;</span>
<span class="nl">req_retry:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Handle out VirtIO ring buffers */</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">pack_sg_list</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">in</span> <span class="o">=</span> <span class="n">pack_sg_list</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
			  <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">virtqueue_add_buf</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">,</span>
							<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span>  <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;Retry virtio request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">req_retry</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span>
				 <span class="s">&quot;virtio rpc add_buf returned failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">virtqueue_kick</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;virtio request kicked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_get_mapped_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kern_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We allow only p9_max_pages pinned. We wait for the</span>
<span class="cm">		 * Other zc request to finish here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp_pinned</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">p9_max_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">vp_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp_pinned</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">p9_max_pages</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">p9_payload_gup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">nr_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp_pinned</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* kernel buffer, no need to pin pages */</span>
		<span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nr_pages</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">rest_of_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">nr_pages</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nr_pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_virtio_zc_request - issue a zero copy request</span>
<span class="cm"> * @client: client instance issuing the request</span>
<span class="cm"> * @req: request to be issued</span>
<span class="cm"> * @uidata: user bffer that should be ued for zero copy read</span>
<span class="cm"> * @uodata: user buffer that shoud be user for zero copy write</span>
<span class="cm"> * @inlen: read buffer size</span>
<span class="cm"> * @olen: write buffer size</span>
<span class="cm"> * @hdrlen: reader header size, This is the size of response protocol data</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">p9_virtio_zc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">*</span><span class="n">uidata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uodata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inlen</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">outlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_hdr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">in_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">**</span><span class="n">out_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;virtio request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uodata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_nr_pages</span> <span class="o">=</span> <span class="n">p9_nr_pages</span><span class="p">(</span><span class="n">uodata</span><span class="p">,</span> <span class="n">outlen</span><span class="p">);</span>
		<span class="n">out_pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_nr_pages</span><span class="p">,</span>
				    <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">out_nr_pages</span> <span class="o">=</span> <span class="n">p9_get_mapped_pages</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">out_pages</span><span class="p">,</span> <span class="n">uodata</span><span class="p">,</span>
						   <span class="n">out_nr_pages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kern_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out_nr_pages</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">out_nr_pages</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">out_pages</span><span class="p">);</span>
			<span class="n">out_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uidata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_nr_pages</span> <span class="o">=</span> <span class="n">p9_nr_pages</span><span class="p">(</span><span class="n">uidata</span><span class="p">,</span> <span class="n">inlen</span><span class="p">);</span>
		<span class="n">in_pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">in_nr_pages</span><span class="p">,</span>
				   <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">in_nr_pages</span> <span class="o">=</span> <span class="n">p9_get_mapped_pages</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">in_pages</span><span class="p">,</span> <span class="n">uidata</span><span class="p">,</span>
						  <span class="n">in_nr_pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kern_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_nr_pages</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">in_nr_pages</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">in_pages</span><span class="p">);</span>
			<span class="n">in_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_SENT</span><span class="p">;</span>
<span class="nl">req_retry_pinned:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* out data */</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">pack_sg_list</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_pages</span><span class="p">)</span>
		<span class="n">out</span> <span class="o">+=</span> <span class="n">pack_sg_list_p</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span>
				      <span class="n">out_pages</span><span class="p">,</span> <span class="n">out_nr_pages</span><span class="p">,</span> <span class="n">uodata</span><span class="p">,</span> <span class="n">outlen</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Take care of in data</span>
<span class="cm">	 * For example TREAD have 11.</span>
<span class="cm">	 * 11 is the read/write header = PDU Header(7) + IO Size (4).</span>
<span class="cm">	 * Arrange in such a way that server places header in the</span>
<span class="cm">	 * alloced memory and payload onto the user buffer.</span>
<span class="cm">	 */</span>
	<span class="n">in</span> <span class="o">=</span> <span class="n">pack_sg_list</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
			  <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">in_hdr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_pages</span><span class="p">)</span>
		<span class="n">in</span> <span class="o">+=</span> <span class="n">pack_sg_list_p</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span> <span class="o">+</span> <span class="n">in</span><span class="p">,</span> <span class="n">VIRTQUEUE_NUM</span><span class="p">,</span>
				     <span class="n">in_pages</span><span class="p">,</span> <span class="n">in_nr_pages</span><span class="p">,</span> <span class="n">uidata</span><span class="p">,</span> <span class="n">inlen</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">virtqueue_add_buf</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">,</span>
						       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span>  <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;Retry virtio request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">req_retry_pinned</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span>
				 <span class="s">&quot;virtio rpc add_buf returned failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">virtqueue_kick</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_TRANS</span><span class="p">,</span> <span class="s">&quot;virtio request kicked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
				       <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Non kernel buffers are pinned, unpin them</span>
<span class="cm">	 */</span>
<span class="nl">err_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kern_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p9_release_pages</span><span class="p">(</span><span class="n">in_pages</span><span class="p">,</span> <span class="n">in_nr_pages</span><span class="p">);</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">in_nr_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp_pinned</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p9_release_pages</span><span class="p">(</span><span class="n">out_pages</span><span class="p">,</span> <span class="n">out_nr_pages</span><span class="p">);</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">out_nr_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp_pinned</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* wakeup anybody waiting for slots to pin pages */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp_wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">in_pages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">out_pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">p9_mount_tag_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">dev_to_virtio</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mount_tag</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">p9_mount_tag_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * p9_virtio_probe - probe for existence of 9P virtio channels</span>
<span class="cm"> * @vdev: virtio device to probe</span>
<span class="cm"> *</span>
<span class="cm"> * This probes for existing virtio channels.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_virtio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_chan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate virtio 9P channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>

	<span class="cm">/* We expect one virtqueue, for requests. */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span> <span class="o">=</span> <span class="n">virtio_find_single_vq</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">req_done</span><span class="p">,</span> <span class="s">&quot;requests&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_vq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">VIRTQUEUE_NUM</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">inuse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virtio_has_feature</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIRTIO_9P_MOUNT_TAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_9p_config</span><span class="p">,</span> <span class="n">tag_len</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">tag_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tag_len</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_vq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tag_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_vq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_9p_config</span><span class="p">,</span> <span class="n">tag</span><span class="p">),</span>
			<span class="n">tag</span><span class="p">,</span> <span class="n">tag_len</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag_len</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_attr_mount_tag</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_free_tag</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wait_queue_head_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_tag</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ring_bufs_avail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Ceiling limit to avoid denial of service attacks */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">p9_max_pages</span> <span class="o">=</span> <span class="n">nr_free_buffer_pages</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">virtio_chan_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_tag:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
<span class="nl">out_free_vq:</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">del_vqs</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * p9_virtio_create - allocate a new virtio channel</span>
<span class="cm"> * @client: client instance invoking this transport</span>
<span class="cm"> * @devname: string identifying the channel to connect to (unused)</span>
<span class="cm"> * @args: args passed from sys_mount() for per-transport options (unused)</span>
<span class="cm"> *</span>
<span class="cm"> * This sets up a transport channel for 9p communication.  Right now</span>
<span class="cm"> * we only match the first available channel, but eventually we couldlook up</span>
<span class="cm"> * alternate channels by matching devname versus a virtio_config entry.</span>
<span class="cm"> * We use a simple reference count mechanism to ensure that only a single</span>
<span class="cm"> * mount has a channel open at a time.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">p9_virtio_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">virtio_chan_list</span><span class="p">,</span> <span class="n">chan_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">strlen</span><span class="p">(</span><span class="n">devname</span><span class="p">)</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">inuse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no channels available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Connected</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_virtio_remove - clean up resources associated with a virtio device</span>
<span class="cm"> * @vdev: virtio device to remove</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p9_virtio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">inuse</span><span class="p">)</span>
		<span class="n">p9_virtio_close</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">del_vqs</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_9p_lock</span><span class="p">);</span>
	<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_attr_mount_tag</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">vc_wq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">virtio_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">VIRTIO_ID_9P</span><span class="p">,</span> <span class="n">VIRTIO_DEV_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">VIRTIO_9P_MOUNT_TAG</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The standard &quot;struct lguest_driver&quot;: */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">virtio_driver</span> <span class="n">p9_virtio_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">feature_table</span>  <span class="o">=</span> <span class="n">features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">feature_table_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">p9_virtio_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">p9_virtio_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_trans_module</span> <span class="n">p9_virtio_trans</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;virtio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">p9_virtio_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">p9_virtio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">p9_virtio_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">zc_request</span> <span class="o">=</span> <span class="n">p9_virtio_zc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">p9_virtio_cancel</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * We leave one entry for input and one entry for response</span>
<span class="cm">	 * headers. We also skip one more entry to accomodate, address</span>
<span class="cm">	 * that are not at page boundary, that can result in an extra</span>
<span class="cm">	 * page in zero copy.</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="n">VIRTQUEUE_NUM</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The standard init function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">p9_virtio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_chan_list</span><span class="p">);</span>

	<span class="n">v9fs_register_trans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_virtio_trans</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">register_virtio_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_virtio_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">p9_virtio_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_virtio_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_virtio_drv</span><span class="p">);</span>
	<span class="n">v9fs_unregister_trans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_virtio_trans</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">p9_virtio_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">p9_virtio_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">virtio</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eric Van Hensbergen &lt;ericvh@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Virtio 9p Transport&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
