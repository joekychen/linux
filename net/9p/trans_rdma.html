<!DOCTYPE html>
<html><head><title>joekychen/linux » net › 9p › trans_rdma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>trans_rdma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/fs/9p/trans_rdma.c</span>
<span class="cm"> *</span>
<span class="cm"> * RDMA transport layer based on the trans_fd.c implementation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2008 by Tom Tucker &lt;tom@opengridcomputing.com&gt;</span>
<span class="cm"> *  Copyright (C) 2006 by Russ Cox &lt;rsc@swtch.com&gt;</span>
<span class="cm"> *  Copyright (C) 2004-2005 by Latchesar Ionkov &lt;lucho@ionkov.net&gt;</span>
<span class="cm"> *  Copyright (C) 2004-2008 by Eric Van Hensbergen &lt;ericvh@gmail.com&gt;</span>
<span class="cm"> *  Copyright (C) 1997-2002 by Ron Minnich &lt;rminnich@sarnoff.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *  as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to:</span>
<span class="cm"> *  Free Software Foundation</span>
<span class="cm"> *  51 Franklin Street, Fifth Floor</span>
<span class="cm"> *  Boston, MA  02111-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/un.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/9p/9p.h&gt;</span>
<span class="cp">#include &lt;net/9p/client.h&gt;</span>
<span class="cp">#include &lt;net/9p/transport.h&gt;</span>
<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>
<span class="cp">#include &lt;rdma/rdma_cm.h&gt;</span>

<span class="cp">#define P9_PORT			5640</span>
<span class="cp">#define P9_RDMA_SQ_DEPTH	32</span>
<span class="cp">#define P9_RDMA_RQ_DEPTH	32</span>
<span class="cp">#define P9_RDMA_SEND_SGE	4</span>
<span class="cp">#define P9_RDMA_RECV_SGE	4</span>
<span class="cp">#define P9_RDMA_IRD		0</span>
<span class="cp">#define P9_RDMA_ORD		0</span>
<span class="cp">#define P9_RDMA_TIMEOUT		30000		</span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define P9_RDMA_MAXSIZE		(4*4096)	</span><span class="cm">/* Min SGE is 4, so we can</span>
<span class="cm">						 * safely advertise a maxsize</span>
<span class="cm">						 * of 64k */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * struct p9_trans_rdma - RDMA transport instance</span>
<span class="cm"> *</span>
<span class="cm"> * @state: tracks the transport state machine for connection setup and tear down</span>
<span class="cm"> * @cm_id: The RDMA CM ID</span>
<span class="cm"> * @pd: Protection Domain pointer</span>
<span class="cm"> * @qp: Queue Pair pointer</span>
<span class="cm"> * @cq: Completion Queue pointer</span>
<span class="cm"> * @dm_mr: DMA Memory Region pointer</span>
<span class="cm"> * @lkey: The local access only memory region key</span>
<span class="cm"> * @timeout: Number of uSecs to wait for connection management events</span>
<span class="cm"> * @sq_depth: The depth of the Send Queue</span>
<span class="cm"> * @sq_sem: Semaphore for the SQ</span>
<span class="cm"> * @rq_depth: The depth of the Receive Queue.</span>
<span class="cm"> * @rq_count: Count of requests in the Receive Queue.</span>
<span class="cm"> * @addr: The remote peer&#39;s address</span>
<span class="cm"> * @req_lock: Protects the active request list</span>
<span class="cm"> * @cm_done: Completion event for connection management tracking</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">P9_RDMA_INIT</span><span class="p">,</span>
		<span class="n">P9_RDMA_ADDR_RESOLVED</span><span class="p">,</span>
		<span class="n">P9_RDMA_ROUTE_RESOLVED</span><span class="p">,</span>
		<span class="n">P9_RDMA_CONNECTED</span><span class="p">,</span>
		<span class="n">P9_RDMA_FLUSHING</span><span class="p">,</span>
		<span class="n">P9_RDMA_CLOSING</span><span class="p">,</span>
		<span class="n">P9_RDMA_CLOSED</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">cm_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_pd</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mr</span> <span class="o">*</span><span class="n">dma_mr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lkey</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sq_depth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sq_sem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rq_depth</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">rq_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">req_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span> <span class="n">cm_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * p9_rdma_context - Keeps track of in-process WR</span>
<span class="cm"> *</span>
<span class="cm"> * @wc_op: The original WR op for when the CQE completes in error.</span>
<span class="cm"> * @busa: Bus address to unmap when the WR completes</span>
<span class="cm"> * @req: Keeps track of requests (send)</span>
<span class="cm"> * @rc: Keepts track of replies (receive)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p9_rdma_req</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">ib_wc_opcode</span> <span class="n">wc_op</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busa</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">p9_fcall</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * p9_rdma_opts - Collection of mount options</span>
<span class="cm"> * @port: port of connection</span>
<span class="cm"> * @sq_depth: The requested depth of the SQ. This really doesn&#39;t need</span>
<span class="cm"> * to be any deeper than the number of threads used in the client</span>
<span class="cm"> * @rq_depth: The depth of the RQ. Should be greater than or equal to SQ depth</span>
<span class="cm"> * @timeout: Time to wait in msecs for CM events</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p9_rdma_opts</span> <span class="p">{</span>
	<span class="kt">short</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sq_depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rq_depth</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Option Parsing (code inspired by NFS code)</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* Options that take integer arguments */</span>
	<span class="n">Opt_port</span><span class="p">,</span> <span class="n">Opt_rq_depth</span><span class="p">,</span> <span class="n">Opt_sq_depth</span><span class="p">,</span> <span class="n">Opt_timeout</span><span class="p">,</span> <span class="n">Opt_err</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_port</span><span class="p">,</span> <span class="s">&quot;port=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_sq_depth</span><span class="p">,</span> <span class="s">&quot;sq=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_rq_depth</span><span class="p">,</span> <span class="s">&quot;rq=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_timeout</span><span class="p">,</span> <span class="s">&quot;timeout=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * parse_opts - parse mount options into rdma options structure</span>
<span class="cm"> * @params: options string passed from mount</span>
<span class="cm"> * @opts: rdma transport-specific structure to parse options into</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 upon success, -ERRNO upon failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_opts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_rdma_opts</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_options</span><span class="p">;</span>

	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">P9_PORT</span><span class="p">;</span>
	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">sq_depth</span> <span class="o">=</span> <span class="n">P9_RDMA_SQ_DEPTH</span><span class="p">;</span>
	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">rq_depth</span> <span class="o">=</span> <span class="n">P9_RDMA_RQ_DEPTH</span><span class="p">;</span>
	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">P9_RDMA_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp_options</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_options</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
			 <span class="s">&quot;failed to allocate copy of option string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">tmp_options</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
				 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_port</span>:
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sq_depth</span>:
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">sq_depth</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rq_depth</span>:
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">rq_depth</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_timeout</span>:
			<span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* RQ must be at least as large as the SQ */</span>
	<span class="n">opts</span><span class="o">-&gt;</span><span class="n">rq_depth</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">rq_depth</span><span class="p">,</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">sq_depth</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_options</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">p9_cm_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">rdma_cm_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdma_cm_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ADDR_RESOLVED</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_INIT</span><span class="p">);</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_ADDR_RESOLVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ROUTE_RESOLVED</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_ADDR_RESOLVED</span><span class="p">);</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_ROUTE_RESOLVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ESTABLISHED</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_ROUTE_RESOLVED</span><span class="p">);</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_CONNECTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_DISCONNECTED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="p">)</span>
			<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_CLOSED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_TIMEWAIT_EXIT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ADDR_CHANGE</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ROUTE_ERROR</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_DEVICE_REMOVAL</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_MULTICAST_JOIN</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_MULTICAST_ERROR</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_REJECTED</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_CONNECT_REQUEST</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_CONNECT_RESPONSE</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_CONNECT_ERROR</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_ADDR_ERROR</span>:
	<span class="k">case</span> <span class="n">RDMA_CM_EVENT_UNREACHABLE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
		<span class="n">rdma_disconnect</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_wc_status</span> <span class="n">status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">byte_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int16_t</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span>
							 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">IB_WC_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_parse_header</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_tag_lookup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">;</span>
	<span class="n">p9_client_cb</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">err_out:</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;req %p err %d status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_FLUSHING</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ib_wc_status</span> <span class="n">status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">byte_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ib_dma_unmap_single</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qp_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;QP event %d context %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cq_comp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_cq</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cq_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">cq_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_wc</span> <span class="n">wc</span><span class="p">;</span>

	<span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ib_poll_cq</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wc</span><span class="p">.</span><span class="n">wr_id</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wc_op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IB_WC_RECV</span>:
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">);</span>
			<span class="n">handle_recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rdma</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">byte_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IB_WC_SEND</span>:
			<span class="n">handle_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rdma</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">byte_len</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">sq_sem</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unexpected completion type, c-&gt;wc_op=%d, wc.opcode=%d, status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">c</span><span class="o">-&gt;</span><span class="n">wc_op</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cq_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_event</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;CQ event %d context %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdma_destroy_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdma</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span><span class="p">))</span>
		<span class="n">ib_dereg_mr</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">))</span>
		<span class="n">ib_destroy_qp</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">))</span>
		<span class="n">ib_dealloc_pd</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">))</span>
		<span class="n">ib_destroy_cq</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">))</span>
		<span class="n">rdma_destroy_id</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">post_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_recv_wr</span> <span class="n">wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="n">sge</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				    <span class="n">c</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span>
				    <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sge</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>

	<span class="n">wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wc_op</span> <span class="o">=</span> <span class="n">IB_WC_RECV</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ib_post_recv</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>

 <span class="nl">error:</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_send_wr</span> <span class="n">wr</span><span class="p">,</span> <span class="o">*</span><span class="n">bad_wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_rdma_context</span> <span class="o">*</span><span class="n">rpl_context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Allocate an fcall for the reply */</span>
	<span class="n">rpl_context</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">rpl_context</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpl_context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the request has a buffer, steal it, otherwise</span>
<span class="cm">	 * allocate a new one.  Typically, requests should already</span>
<span class="cm">	 * have receive buffers allocated and just swap them around</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">)</span><span class="o">+</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span>
				  <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rpl_context</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpl_context</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Post a receive buffer for this request. We need to ensure</span>
<span class="cm">	 * there is a reply buffer available for every outstanding</span>
<span class="cm">	 * request. A flushed request can result in no reply for an</span>
<span class="cm">	 * outstanding request, so we must keep a count to avoid</span>
<span class="cm">	 * overflowing the RQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">post_recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rpl_context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">);</span>

	<span class="cm">/* remove posted receive buffer from request structure */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Post the request */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span> <span class="o">=</span> <span class="n">ib_dma_map_single</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				    <span class="n">c</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_dma_mapping_error</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sge</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busa</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">sge</span><span class="p">.</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>

	<span class="n">wr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wc_op</span> <span class="o">=</span> <span class="n">IB_WC_SEND</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">wr_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IB_WR_SEND</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">IB_SEND_SIGNALED</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">num_sge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">sq_sem</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ib_post_send</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_wr</span><span class="p">);</span>

 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rpl_context</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rpl_context</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
 <span class="nl">err_free1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rpl_context</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
 <span class="nl">err_free2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rpl_context</span><span class="p">);</span>
 <span class="nl">err_close:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">P9_RDMA_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">P9_RDMA_CLOSING</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rdma_disconnect</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdma_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rdma</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdma</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
	<span class="n">rdma_disconnect</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">);</span>
	<span class="n">rdma_destroy_trans</span><span class="p">(</span><span class="n">rdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * alloc_rdma - Allocate and initialize the rdma transport structure</span>
<span class="cm"> * @opts: Mount options structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="nf">alloc_rdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_rdma_opts</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">;</span>

	<span class="n">rdma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_trans_rdma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">sq_depth</span> <span class="o">=</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">sq_depth</span><span class="p">;</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_depth</span> <span class="o">=</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">rq_depth</span><span class="p">;</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">opts</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_done</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">sq_sem</span><span class="p">,</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">sq_depth</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rdma</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* its not clear to me we can do anything after send has been posted */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdma_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * trans_create_rdma - Transport method for creating atransport instance</span>
<span class="cm"> * @client: client instance</span>
<span class="cm"> * @addr: IP address string</span>
<span class="cm"> * @args: Mount options string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rdma_create_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_rdma_opts</span> <span class="n">opts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_trans_rdma</span> <span class="o">*</span><span class="n">rdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdma_conn_param</span> <span class="n">conn_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp_init_attr</span> <span class="n">qp_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_device_attr</span> <span class="n">devattr</span><span class="p">;</span>

	<span class="cm">/* Parse the transport specific mount options */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_opts</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Create and initialize the RDMA transport structure */</span>
	<span class="n">rdma</span> <span class="o">=</span> <span class="n">alloc_rdma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Create the RDMA CM ID */</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span> <span class="o">=</span> <span class="n">rdma_create_id</span><span class="p">(</span><span class="n">p9_cm_event_handler</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">RDMA_PS_TCP</span><span class="p">,</span>
				     <span class="n">IB_QPT_RC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Associate the client with the transport */</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">=</span> <span class="n">rdma</span><span class="p">;</span>

	<span class="cm">/* Resolve the server&#39;s address */</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdma_resolve_addr</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_done</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_ADDR_RESOLVED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Resolve the route to the server */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdma_resolve_route</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_done</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_ROUTE_RESOLVED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Query the device attributes */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ib_query_device</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Create the Completion Queue */</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span> <span class="o">=</span> <span class="n">ib_create_cq</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cq_comp_handler</span><span class="p">,</span>
				<span class="n">cq_event_handler</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="n">opts</span><span class="p">.</span><span class="n">sq_depth</span> <span class="o">+</span> <span class="n">opts</span><span class="p">.</span><span class="n">rq_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ib_req_notify_cq</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">,</span> <span class="n">IB_CQ_NEXT_COMP</span><span class="p">);</span>

	<span class="cm">/* Create the Protection Domain */</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">ib_alloc_pd</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Cache the DMA lkey in the transport */</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devattr</span><span class="p">.</span><span class="n">device_cap_flags</span> <span class="o">&amp;</span> <span class="n">IB_DEVICE_LOCAL_DMA_LKEY</span><span class="p">)</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">local_dma_lkey</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span> <span class="o">=</span> <span class="n">ib_get_dma_mr</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="n">IB_ACCESS_LOCAL_WRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">lkey</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">dma_mr</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create the Queue Pair */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">qp_attr</span><span class="p">);</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">event_handler</span> <span class="o">=</span> <span class="n">qp_event_handler</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">qp_context</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_wr</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="n">sq_depth</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_wr</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="n">rq_depth</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_send_sge</span> <span class="o">=</span> <span class="n">P9_RDMA_SEND_SGE</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">max_recv_sge</span> <span class="o">=</span> <span class="n">P9_RDMA_RECV_SGE</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">sq_sig_type</span> <span class="o">=</span> <span class="n">IB_SIGNAL_REQ_WR</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">qp_type</span> <span class="o">=</span> <span class="n">IB_QPT_RC</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">send_cq</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">qp_attr</span><span class="p">.</span><span class="n">recv_cq</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdma_create_qp</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qp_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">rdma</span><span class="o">-&gt;</span><span class="n">qp</span> <span class="o">=</span> <span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>

	<span class="cm">/* Request a connection */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conn_param</span><span class="p">));</span>
	<span class="n">conn_param</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn_param</span><span class="p">.</span><span class="n">private_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conn_param</span><span class="p">.</span><span class="n">responder_resources</span> <span class="o">=</span> <span class="n">P9_RDMA_IRD</span><span class="p">;</span>
	<span class="n">conn_param</span><span class="p">.</span><span class="n">initiator_depth</span> <span class="o">=</span> <span class="n">P9_RDMA_ORD</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rdma_connect</span><span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">cm_done</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">rdma</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">P9_RDMA_CONNECTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Connected</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">rdma_destroy_trans</span><span class="p">(</span><span class="n">rdma</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_trans_module</span> <span class="n">p9_rdma_trans</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rdma&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">P9_RDMA_MAXSIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">rdma_create_trans</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">rdma_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">rdma_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">rdma_cancel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * p9_trans_rdma_init - Register the 9P RDMA transport driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">p9_trans_rdma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_register_trans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_rdma_trans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">p9_trans_rdma_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v9fs_unregister_trans</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p9_rdma_trans</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">p9_trans_rdma_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">p9_trans_rdma_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tom Tucker &lt;tom@opengridcomputing.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RDMA Transport for 9P&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
