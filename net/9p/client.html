<!DOCTYPE html>
<html><head><title>joekychen/linux » net › 9p › client.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>client.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/9p/clnt.c</span>
<span class="cm"> *</span>
<span class="cm"> * 9P Client</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2008 by Eric Van Hensbergen &lt;ericvh@gmail.com&gt;</span>
<span class="cm"> *  Copyright (C) 2007 by Latchesar Ionkov &lt;lucho@ionkov.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *  as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to:</span>
<span class="cm"> *  Free Software Foundation</span>
<span class="cm"> *  51 Franklin Street, Fifth Floor</span>
<span class="cm"> *  Boston, MA  02111-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;net/9p/9p.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;net/9p/client.h&gt;</span>
<span class="cp">#include &lt;net/9p/transport.h&gt;</span>
<span class="cp">#include &quot;protocol.h&quot;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &lt;trace/events/9p.h&gt;</span>

<span class="cm">/*</span>
<span class="cm">  * Client Option Parsing (code inspired by NFS code)</span>
<span class="cm">  *  - a little lazy - parse all client options</span>
<span class="cm">  */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_msize</span><span class="p">,</span>
	<span class="n">Opt_trans</span><span class="p">,</span>
	<span class="n">Opt_legacy</span><span class="p">,</span>
	<span class="n">Opt_version</span><span class="p">,</span>
	<span class="n">Opt_err</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_msize</span><span class="p">,</span> <span class="s">&quot;msize=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_legacy</span><span class="p">,</span> <span class="s">&quot;noextend&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_trans</span><span class="p">,</span> <span class="s">&quot;trans=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_version</span><span class="p">,</span> <span class="s">&quot;version=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">p9_is_proto_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">p9_proto_2000L</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_is_proto_dotl</span><span class="p">);</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">p9_is_proto_dotu</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">p9_proto_2000u</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_is_proto_dotu</span><span class="p">);</span>

<span class="cm">/* Interpret mount option for protocol version */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_protocol_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;9p2000&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">p9_proto_legacy</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Protocol version: Legacy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;9p2000.u&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">p9_proto_2000u</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Protocol version: 9P2000.u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;9p2000.L&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">p9_proto_2000L</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;Protocol version: 9P2000.L</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown protocol version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">version</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * parse_options - parse mount options into client structure</span>
<span class="cm"> * @opts: options string passed from mount</span>
<span class="cm"> * @clnt: existing v9fs client information</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 upon success, -ERRNO upon failure</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_opts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_options</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">p9_proto_2000u</span><span class="p">;</span>
	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp_options</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_options</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
			 <span class="s">&quot;failed to allocate copy of option string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">tmp_options</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_msize</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;integer field, but no integer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_trans</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;problem allocating copy of trans arg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			 <span class="p">}</span>
			<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span> <span class="o">=</span> <span class="n">v9fs_get_trans_by_name</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Could not find request transport: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">s</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_legacy</span>:
			<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">p9_proto_legacy</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_version</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
					 <span class="s">&quot;problem allocating copy of version arg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_protocol_version</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">free_and_return:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_options</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_tag_alloc - lookup/allocate a request by tag</span>
<span class="cm"> * @c: client session to lookup tag within</span>
<span class="cm"> * @tag: numeric id for transaction</span>
<span class="cm"> *</span>
<span class="cm"> * this is a simple array lookup, but will grow the</span>
<span class="cm"> * request_slots as necessary to accommodate transaction</span>
<span class="cm"> * ids which did not previously have a slot.</span>
<span class="cm"> *</span>
<span class="cm"> * this code relies on the client spinlock to manage locks, its</span>
<span class="cm"> * possible we should switch to something else, but I&#39;d rather</span>
<span class="cm"> * stick with something low-overhead for the common case.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span>
<span class="nf">p9_tag_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc_msize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="n">max_size</span><span class="p">);</span>

	<span class="cm">/* This looks up the original request by tag so we know which</span>
<span class="cm">	 * buffer to read the data into */</span>
	<span class="n">tag</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* check again since original check was outside of lock */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag</span> <span class="o">/</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">P9_ROW_MAXTAG</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_req_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t grow tag array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_IDLE</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">tc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span> <span class="o">+=</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">row</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">/</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span>
	<span class="n">col</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">%</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wait_queue_head_t</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t grow tag array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">)</span> <span class="o">+</span> <span class="n">alloc_msize</span><span class="p">,</span>
				  <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">)</span> <span class="o">+</span> <span class="n">alloc_msize</span><span class="p">,</span>
				  <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t grow tag array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">alloc_msize</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">alloc_msize</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">sdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p9pdu_reset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">);</span>
	<span class="n">p9pdu_reset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_ALLOC</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_tag_lookup - lookup a request by tag</span>
<span class="cm"> * @c: client session to lookup tag within</span>
<span class="cm"> * @tag: numeric id for transaction</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="nf">p9_tag_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>

	<span class="cm">/* This looks up the original request by tag so we know which</span>
<span class="cm">	 * buffer to read the data into */</span>
	<span class="n">tag</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tag</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">)</span> 
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">row</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">/</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span>
	<span class="n">col</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">%</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_tag_lookup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * p9_tag_init - setup tags structure and contents</span>
<span class="cm"> * @c:  v9fs client struct</span>
<span class="cm"> *</span>
<span class="cm"> * This initializes the tags structure for each client instance.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_tag_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span> <span class="o">=</span> <span class="n">p9_idpool_create</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_idpool_get</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span> <span class="cm">/* reserve tag 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_idpool_destroy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_tag_cleanup - cleans up tags structure and reclaims resources</span>
<span class="cm"> * @c:  v9fs client struct</span>
<span class="cm"> *</span>
<span class="cm"> * This frees resources associated with the tags structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">p9_tag_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>

	<span class="cm">/* check to insure all requests are idle */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="o">/</span><span class="n">P9_ROW_MAXTAG</span><span class="p">);</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="n">REQ_STATUS_IDLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span>
					 <span class="s">&quot;Attempting to cleanup non-free tag %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
				<span class="cm">/* TODO: delay execution of cleanup */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_idpool_put</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span> <span class="cm">/* free reserved tag 0 */</span>
		<span class="n">p9_idpool_destroy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free requests associated with tags */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="o">/</span><span class="n">P9_ROW_MAXTAG</span><span class="p">);</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">P9_ROW_MAXTAG</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">tc</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">row</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_free_req - free a request and clean-up as necessary</span>
<span class="cm"> * c: client state</span>
<span class="cm"> * r: request to release</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p9_free_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;clnt %p req %p tag: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REQ_STATUS_IDLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">P9_NOTAG</span> <span class="o">&amp;&amp;</span> <span class="n">p9_idpool_check</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">))</span>
		<span class="n">p9_idpool_put</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_client_cb - call back from transport to client</span>
<span class="cm"> * c: client state</span>
<span class="cm"> * req: request received</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">p9_client_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot; tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;wakeup: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_cb</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * p9_parse_header - parse header arguments out of a packet</span>
<span class="cm"> * @pdu: packet to parse</span>
<span class="cm"> * @size: size of packet</span>
<span class="cm"> * @type: type of request</span>
<span class="cm"> * @tag: tag of packet</span>
<span class="cm"> * @rewind: set if we need to rewind offset afterwards</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">p9_parse_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fcall</span> <span class="o">*</span><span class="n">pdu</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int16_t</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">rewind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int8_t</span> <span class="n">r_type</span><span class="p">;</span>
	<span class="kt">int16_t</span> <span class="n">r_tag</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">r_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdu</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">pdu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dbw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rewind_and_exit</span><span class="p">;</span>

	<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">r_size</span><span class="p">;</span>
	<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">r_type</span><span class="p">;</span>
	<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">r_tag</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; size=%d type: %d tag: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pdu</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">r_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="n">r_tag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">r_size</span><span class="p">;</span>


<span class="nl">rewind_and_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rewind</span><span class="p">)</span>
		<span class="n">pdu</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_parse_header</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * p9_check_errors - check 9p packet for error return and process it</span>
<span class="cm"> * @c: current client instance</span>
<span class="cm"> * @req: request to parse and check for error conditions</span>
<span class="cm"> *</span>
<span class="cm"> * returns error code if one is discovered, otherwise returns 0</span>
<span class="cm"> *</span>
<span class="cm"> * this will have to be more complicated if we have multiple</span>
<span class="cm"> * error packet types</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_check_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int8_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ecode</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_parse_header</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * dump the response from server</span>
<span class="cm">	 * This should be after check errors which poplulate pdu_fcall.</span>
<span class="cm">	 */</span>
	<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t parse header %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">P9_RERROR</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">P9_RLERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ename</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;s?d&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p9_is_proto_dotu</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ecode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">p9_errstr2errno</span><span class="p">(</span><span class="n">ename</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ename</span><span class="p">));</span>

			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RERROR (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="o">-</span><span class="n">ecode</span><span class="p">,</span> <span class="n">ename</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ename</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ecode</span><span class="p">;</span>

		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RLERROR (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ecode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t parse error%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_check_zc_errors - check 9p packet for error return and process it</span>
<span class="cm"> * @c: current client instance</span>
<span class="cm"> * @req: request to parse and check for error conditions</span>
<span class="cm"> * @in_hdrlen: Size of response protocol buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * returns error code if one is discovered, otherwise returns 0</span>
<span class="cm"> *</span>
<span class="cm"> * this will have to be more complicated if we have multiple</span>
<span class="cm"> * error packet types</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_check_zc_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">uidata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_hdrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ecode</span><span class="p">;</span>
	<span class="kt">int8_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_parse_header</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * dump the response from server</span>
<span class="cm">	 * This should be after parse_header which poplulate pdu_fcall.</span>
<span class="cm">	 */</span>
	<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t parse header %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">P9_RERROR</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">P9_RLERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Error is reported in string format */</span>
		<span class="kt">uint16_t</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* 7 = header size for RERROR, 2 is the size of string len; */</span>
		<span class="kt">int</span> <span class="n">inline_len</span> <span class="o">=</span> <span class="n">in_hdrlen</span> <span class="o">-</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* Read the size of error string */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="n">ename</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ename</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">inline_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We have error in protocol buffer itself */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdu_read</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">ename</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  Part of the data is in user space buffer.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdu_read</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">ename</span><span class="p">,</span> <span class="n">inline_len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kern_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ename</span> <span class="o">+</span> <span class="n">inline_len</span><span class="p">,</span> <span class="n">uidata</span><span class="p">,</span>
				       <span class="n">len</span> <span class="o">-</span> <span class="n">inline_len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">ename</span> <span class="o">+</span> <span class="n">inline_len</span><span class="p">,</span>
						     <span class="n">uidata</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">inline_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ename</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p9_is_proto_dotu</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* For dotu we also have error code */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
					  <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ecode</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">p9_errstr2errno</span><span class="p">(</span><span class="n">ename</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ename</span><span class="p">));</span>

			<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RERROR (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="o">-</span><span class="n">ecode</span><span class="p">,</span> <span class="n">ename</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ename</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ecode</span><span class="p">;</span>

		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RLERROR (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ecode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ename</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t parse error%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span>
<span class="n">p9_client_rpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>

<span class="cm">/**</span>
<span class="cm"> * p9_client_flush - flush (cancel) a request</span>
<span class="cm"> * @c: client state</span>
<span class="cm"> * @oldreq: request to cancel</span>
<span class="cm"> *</span>
<span class="cm"> * This sents a flush for a particular request and links</span>
<span class="cm"> * the flush request to the original request.  The current</span>
<span class="cm"> * code only supports a single flush request although the protocol</span>
<span class="cm"> * allows for multiple flush requests to be sent for a single request.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_client_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">oldreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int16_t</span> <span class="n">oldtag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_parse_header</span><span class="p">(</span><span class="n">oldreq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldtag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TFLUSH tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oldtag</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">P9_TFLUSH</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">oldtag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>


	<span class="cm">/* if we haven&#39;t received a response for oldreq,</span>
<span class="cm">	   remove it from the list. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldreq</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">REQ_STATUS_FLSH</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldreq</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="nf">p9_client_prepare_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					      <span class="kt">int8_t</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_size</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;client %p op %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="cm">/* we allow for any status other than disconnected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">Disconnected</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="cm">/* if status is begin_disconnected we allow only clunk request */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BeginDisconnect</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">P9_TCLUNK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">P9_NOTAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">P9_TVERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">p9_idpool_get</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_tag_alloc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">req_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>

	<span class="cm">/* marshall the data */</span>
	<span class="n">p9pdu_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_vwritef</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
	<span class="n">p9pdu_finalize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">);</span>
	<span class="n">trace_9p_client_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="nl">reterr:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_client_rpc - issue a request and wait for a response</span>
<span class="cm"> * @c: client session</span>
<span class="cm"> * @type: type of request</span>
<span class="cm"> * @fmt: protocol format string (see protocol.c)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns request structure (which client must free using p9_free_req)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span>
<span class="nf">p9_client_rpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sigpending</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_prepare_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">again:</span>
	<span class="cm">/* Wait for the response */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
				       <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">Connected</span><span class="p">)</span>
				  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">P9_TFLUSH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">REQ_STATUS_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;req_status error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">t_err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">t_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">Connected</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;flushing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
			<span class="n">p9_client_flush</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="cm">/* if we received the response anyway, don&#39;t signal error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigpending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">recalc_sigpending</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_check_errors</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">trace_9p_client_res</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="nl">reterr:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * p9_client_zc_rpc - issue a request and wait for a response</span>
<span class="cm"> * @c: client session</span>
<span class="cm"> * @type: type of request</span>
<span class="cm"> * @uidata: user bffer that should be ued for zero copy read</span>
<span class="cm"> * @uodata: user buffer that shoud be user for zero copy write</span>
<span class="cm"> * @inlen: read buffer size</span>
<span class="cm"> * @olen: write buffer size</span>
<span class="cm"> * @hdrlen: reader header size, This is the size of response protocol data</span>
<span class="cm"> * @fmt: protocol format string (see protocol.c)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns request structure (which client must free using p9_free_req)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="nf">p9_client_zc_rpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">type</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">uidata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uodata</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">inlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">olen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_hdrlen</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">kern_buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sigpending</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We allocate a inline protocol data of only 4k bytes.</span>
<span class="cm">	 * The actual content is passed in zero-copy fashion.</span>
<span class="cm">	 */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_prepare_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">P9_ZC_HDR_SZ</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we are called with KERNEL_DS force kern_buf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment_eq</span><span class="p">(</span><span class="n">get_fs</span><span class="p">(),</span> <span class="n">KERNEL_DS</span><span class="p">))</span>
		<span class="n">kern_buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">zc_request</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">uidata</span><span class="p">,</span> <span class="n">uodata</span><span class="p">,</span>
				       <span class="n">inlen</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="n">in_hdrlen</span><span class="p">,</span> <span class="n">kern_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">REQ_STATUS_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span> <span class="s">&quot;req_status error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">t_err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">t_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">Connected</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;flushing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sigpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
			<span class="n">p9_client_flush</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="cm">/* if we received the response anyway, don&#39;t signal error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">REQ_STATUS_RCVD</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigpending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">recalc_sigpending</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_check_zc_errors</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">uidata</span><span class="p">,</span> <span class="n">in_hdrlen</span><span class="p">,</span> <span class="n">kern_buf</span><span class="p">);</span>
	<span class="n">trace_9p_client_res</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="nl">reterr:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="nf">p9_fid_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;clnt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p9_idpool_get</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_qid</span><span class="p">));</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">current_fsuid</span><span class="p">();</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">;</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">rdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidlist</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p9_fid_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_idpool_put</span><span class="p">(</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">rdir</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_client_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msize</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TVERSION msize %d protocol %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">p9_proto_2000L</span>:
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">P9_TVERSION</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="s">&quot;9P2000.L&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">p9_proto_2000u</span>:
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">P9_TVERSION</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="s">&quot;9P2000.u&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">p9_proto_legacy</span>:
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">P9_TVERSION</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="s">&quot;9P2000&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;version error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RVERSION msize %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;9P2000.L&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">p9_proto_2000L</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;9P2000.u&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">p9_proto_2000u</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;9P2000&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">=</span> <span class="n">p9_proto_legacy</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msize</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">=</span> <span class="n">msize</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="nf">p9_client_create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidlist</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_tag_init</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_client</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_opts</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy_tagpool</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="p">)</span>
		<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span> <span class="o">=</span> <span class="n">v9fs_get_default_trans</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_ERROR</span><span class="p">,</span>
			 <span class="s">&quot;No transport defined or default transport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">destroy_tagpool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span> <span class="o">=</span> <span class="n">p9_idpool_create</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">put_trans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;clnt %p trans %p msize %d protocol %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">clnt</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy_fidpool</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">&gt;</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">maxsize</span><span class="p">)</span>
		<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">maxsize</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9_client_version</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">close_trans</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">clnt</span><span class="p">;</span>

<span class="nl">close_trans:</span>
	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
<span class="nl">destroy_fidpool:</span>
	<span class="n">p9_idpool_destroy</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">);</span>
<span class="nl">put_trans:</span>
	<span class="n">v9fs_put_trans</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="p">);</span>
<span class="nl">destroy_tagpool:</span>
	<span class="n">p9_idpool_destroy</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">tagpool</span><span class="p">);</span>
<span class="nl">free_client:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_create</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">p9_client_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="o">*</span><span class="n">fidptr</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_MUX</span><span class="p">,</span> <span class="s">&quot;clnt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="p">)</span>
		<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>

	<span class="n">v9fs_put_trans</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">fidptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidlist</span><span class="p">,</span> <span class="n">flist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Found fid %d not clunked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">)</span>
		<span class="n">p9_idpool_destroy</span><span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">fidpool</span><span class="p">);</span>

	<span class="n">p9_tag_cleanup</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_destroy</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">p9_client_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;clnt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>
	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">Disconnected</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_disconnect</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">p9_client_begin_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;clnt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>
	<span class="n">clnt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BeginDisconnect</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_begin_disconnect</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="nf">p9_client_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">afid</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">uname</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n_uname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_qid</span> <span class="n">qid</span><span class="p">;</span>


	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TATTACH afid %d uname %s aname %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">afid</span> <span class="o">?</span> <span class="n">afid</span><span class="o">-&gt;</span><span class="n">fid</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">aname</span><span class="p">);</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">p9_fid_create</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TATTACH</span><span class="p">,</span> <span class="s">&quot;ddss?d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
			<span class="n">afid</span> <span class="o">?</span> <span class="n">afid</span><span class="o">-&gt;</span><span class="n">fid</span> <span class="o">:</span> <span class="n">P9_NOFID</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">n_uname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RATTACH qid %x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

	<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_qid</span><span class="p">));</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span><span class="p">)</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_attach</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="nf">p9_client_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">oldfid</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">nwname</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">**</span><span class="n">wnames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_qid</span> <span class="o">*</span><span class="n">wqids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">nwqids</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqids</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="n">p9_fid_create</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
			<span class="n">fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="n">oldfid</span><span class="p">;</span>


	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TWALK fids %d,%d nwname %ud wname[0] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">nwname</span><span class="p">,</span> <span class="n">wnames</span> <span class="o">?</span> <span class="n">wnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TWALK</span><span class="p">,</span> <span class="s">&quot;ddT&quot;</span><span class="p">,</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
								<span class="n">nwname</span><span class="p">,</span> <span class="n">wnames</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nwqids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clunk_fid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RWALK nwqid %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nwqids</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nwqids</span> <span class="o">!=</span> <span class="n">nwname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clunk_fid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">nwqids</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt;     [%d] %x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span> <span class="n">wqids</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wqids</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">path</span><span class="p">,</span>
			<span class="n">wqids</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nwname</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqids</span><span class="p">[</span><span class="n">nwqids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_qid</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">qid</span> <span class="o">=</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wqids</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>

<span class="nl">clunk_fid:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wqids</span><span class="p">);</span>
	<span class="n">p9_client_clunk</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">oldfid</span><span class="p">))</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_walk</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_qid</span> <span class="n">qid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iounit</span><span class="p">;</span>

	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; %s fid %d mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">clnt</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TLOPEN&quot;</span> <span class="o">:</span> <span class="s">&quot;TOPEN&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">clnt</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TLOPEN</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TOPEN</span><span class="p">,</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Qd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iounit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; %s qid %x.%llx.%x iounit %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">p9_is_proto_dotl</span><span class="p">(</span><span class="n">clnt</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RLOPEN&quot;</span> <span class="o">:</span> <span class="s">&quot;ROPEN&quot;</span><span class="p">,</span>  <span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">iounit</span><span class="p">);</span>

	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">iounit</span> <span class="o">=</span> <span class="n">iounit</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_open</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_create_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">ofid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">,</span>
		<span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_qid</span> <span class="o">*</span><span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iounit</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
			<span class="s">&quot;&gt;&gt;&gt; TLCREATE fid %d name %s flags %d mode %d gid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ofid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">ofid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TLCREATE</span><span class="p">,</span> <span class="s">&quot;dsddd&quot;</span><span class="p">,</span> <span class="n">ofid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Qd&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iounit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RLCREATE qid %x.%llx.%x iounit %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">qid</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
			<span class="n">qid</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">iounit</span><span class="p">);</span>

	<span class="n">ofid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">ofid</span><span class="o">-&gt;</span><span class="n">iounit</span> <span class="o">=</span> <span class="n">iounit</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_create_dotl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_fcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">perm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">*</span><span class="n">extension</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_qid</span> <span class="n">qid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iounit</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TCREATE fid %d name %s perm %d mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TCREATE</span><span class="p">,</span> <span class="s">&quot;dsdb?s&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span>
				<span class="n">mode</span><span class="p">,</span> <span class="n">extension</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Qd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iounit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RCREATE qid %x.%llx.%x iounit %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
				<span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">iounit</span><span class="p">);</span>

	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">iounit</span> <span class="o">=</span> <span class="n">iounit</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_fcreate</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">dfid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symtgt</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">p9_qid</span> <span class="o">*</span><span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TSYMLINK dfid %d name %s  symtgt %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">symtgt</span><span class="p">);</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TSYMLINK</span><span class="p">,</span> <span class="s">&quot;dssd&quot;</span><span class="p">,</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">symtgt</span><span class="p">,</span>
			<span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RSYMLINK qid %x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">qid</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">qid</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_symlink</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">dfid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">oldfid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TLINK dfid %d oldfid %d newname %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">newname</span><span class="p">);</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TLINK</span><span class="p">,</span> <span class="s">&quot;dds&quot;</span><span class="p">,</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">oldfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
			<span class="n">newname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RLINK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_link</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_fsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">datasync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TFSYNC fid %d datasync:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">datasync</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TFSYNC</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">datasync</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RFSYNC fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_fsync</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_clunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s (%d): Trying to clunk with NULL fid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">again:</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TCLUNK fid %d (try %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
								<span class="n">retries</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TCLUNK</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RCLUNK fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Fid is not valid even after a failed clunk</span>
<span class="cm">	 * If interrupted, retry once then give up and</span>
<span class="cm">	 * leak fid until umount.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_clunk</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TREMOVE fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREMOVE</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RREMOVE fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">p9_client_clunk</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_remove</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_unlinkat</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">dfid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TUNLINKAT fid %d %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">clnt</span> <span class="o">=</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TUNLINKAT</span><span class="p">,</span> <span class="s">&quot;dsd&quot;</span><span class="p">,</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RUNLINKAT fid %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_unlinkat</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">p9_client_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span>
								<span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dataptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kernel_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">non_zc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TREAD fid %d offset %llu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">rsize</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">iounit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsize</span> <span class="o">||</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span><span class="o">-</span><span class="n">P9_IOHDRSZ</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">-</span> <span class="n">P9_IOHDRSZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">rsize</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t bother zerocopy for small IO (&lt; 1024) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">zc_request</span> <span class="o">&amp;&amp;</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">indata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kernel_buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">indata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">udata</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * response header len is 11</span>
<span class="cm">		 * PDU Header(7) + IO Size (4)</span>
<span class="cm">		 */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_zc_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREAD</span><span class="p">,</span> <span class="n">indata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="mi">11</span><span class="p">,</span> <span class="n">kernel_buf</span><span class="p">,</span> <span class="s">&quot;dqd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
				       <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">non_zc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREAD</span><span class="p">,</span> <span class="s">&quot;dqd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				    <span class="n">rsize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dataptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RREAD count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">non_zc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">dataptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_read</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">p9_client_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">,</span>
							<span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kernel_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TWRITE fid %d offset %llu count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">rsize</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">iounit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsize</span> <span class="o">||</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span><span class="o">-</span><span class="n">P9_IOHDRSZ</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">-</span> <span class="n">P9_IOHDRSZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">rsize</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t bother zerocopy for small IO (&lt; 1024) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">zc_request</span> <span class="o">&amp;&amp;</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">odata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kernel_buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">odata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">odata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">udata</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_zc_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TWRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">odata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span>
				       <span class="n">P9_ZC_HDR_SZ</span><span class="p">,</span> <span class="n">kernel_buf</span><span class="p">,</span> <span class="s">&quot;dqd&quot;</span><span class="p">,</span>
				       <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TWRITE</span><span class="p">,</span> <span class="s">&quot;dqD&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
					    <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TWRITE</span><span class="p">,</span> <span class="s">&quot;dqU&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
					    <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">udata</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RWRITE count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_write</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">p9_wstat</span> <span class="o">*</span><span class="nf">p9_client_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_wstat</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_wstat</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ignored</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TSTAT fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TSTAT</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ignored</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;&lt;&lt;&lt; RSTAT sz=%x type=%x dev=%x qid=%x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt;    mode=%8.8x atime=%8.8x mtime=%8.8x length=%llx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt;    name=%s uid=%s gid=%s muid=%s extension=(%s)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt;    uid=%d gid=%d n_muid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">muid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">n_uid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">n_gid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">n_muid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_stat</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">p9_stat_dotl</span> <span class="o">*</span><span class="nf">p9_client_getattr_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
							<span class="n">u64</span> <span class="n">request_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_stat_dotl</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_stat_dotl</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TGETATTR fid %d, request_mask %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">request_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TGETATTR</span><span class="p">,</span> <span class="s">&quot;dq&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">request_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;&lt;&lt;&lt; RGETATTR st_result_mask=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; qid=%x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_mode=%8.8x st_nlink=%llu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_uid=%d st_gid=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_rdev=%llx st_size=%llx st_blksize=%llu st_blocks=%llu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_atime_sec=%lld st_atime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_mtime_sec=%lld st_mtime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_ctime_sec=%lld st_ctime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_btime_sec=%lld st_btime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;&lt;&lt;&lt; st_gen=%lld st_data_version=%lld&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_result_mask</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_mode</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_nlink</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_uid</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_gid</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_rdev</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_blksize</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_blocks</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_atime_sec</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_atime_nsec</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_mtime_sec</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_mtime_nsec</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_ctime_sec</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_ctime_nsec</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_btime_sec</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_btime_nsec</span><span class="p">,</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_gen</span><span class="p">,</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">st_data_version</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_getattr_dotl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p9_client_statsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_wstat</span> <span class="o">*</span><span class="n">wst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* NOTE: size shouldn&#39;t include its own length */</span>
	<span class="cm">/* size[2] type[2] dev[4] qid[13] */</span>
	<span class="cm">/* mode[4] atime[4] mtime[4] length[8]*/</span>
	<span class="cm">/* name[s] uid[s] gid[s] muid[s] */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">13</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">muid</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">muid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">p9_proto_2000u</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">p9_proto_2000L</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>	<span class="cm">/* extension[s] n_uid[4] n_gid[4] n_muid[4] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p9_client_wstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_wstat</span> <span class="o">*</span><span class="n">wst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">wst</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">p9_client_statsize</span><span class="p">(</span><span class="n">wst</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TWSTAT fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;     sz=%x type=%x dev=%x qid=%x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;     mode=%8.8x atime=%8.8x mtime=%8.8x length=%llx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;     name=%s uid=%s gid=%s muid=%s extension=(%s)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;     uid=%d gid=%d n_muid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">wst</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
		<span class="n">wst</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">wst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		<span class="n">wst</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">muid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">,</span>
		<span class="n">wst</span><span class="o">-&gt;</span><span class="n">n_uid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">n_gid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">n_muid</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TWSTAT</span><span class="p">,</span> <span class="s">&quot;dwS&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">wst</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">wst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RWSTAT fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_wstat</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_iattr_dotl</span> <span class="o">*</span><span class="n">p9attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TSETATTR fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;    valid=%x mode=%x uid=%d gid=%d size=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;    atime_sec=%lld atime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;    mtime_sec=%lld mtime_nsec=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span>
		<span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">atime_sec</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">atime_nsec</span><span class="p">,</span>
		<span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">mtime_sec</span><span class="p">,</span> <span class="n">p9attr</span><span class="o">-&gt;</span><span class="n">mtime_nsec</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TSETATTR</span><span class="p">,</span> <span class="s">&quot;dI&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">p9attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RSETATTR fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_setattr</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_rstatfs</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TSTATFS fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TSTATFS</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;ddqqqqqqd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bfree</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bavail</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">ffree</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RSTATFS fid %d type 0x%lx bsize %ld &quot;</span>
		<span class="s">&quot;blocks %llu bfree %llu bavail %llu files %llu ffree %llu &quot;</span>
		<span class="s">&quot;fsid %llu namelen %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">bfree</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">bavail</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">,</span>  <span class="n">sb</span><span class="o">-&gt;</span><span class="n">ffree</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_statfs</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">newdirfid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TRENAME fid %d newdirfid %d name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">newdirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TRENAME</span><span class="p">,</span> <span class="s">&quot;dds&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
			<span class="n">newdirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RRENAME fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_rename</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_renameat</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">olddirfid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">newdirfid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">olddirfid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TRENAMEAT olddirfid %d old name %s&quot;</span>
		   <span class="s">&quot; newdirfid %d new name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">olddirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span>
		   <span class="n">newdirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TRENAMEAT</span><span class="p">,</span> <span class="s">&quot;dsds&quot;</span><span class="p">,</span> <span class="n">olddirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
			    <span class="n">old_name</span><span class="p">,</span> <span class="n">newdirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RRENAMEAT newdirfid %d new name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">newdirfid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_renameat</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * An xattrwalk without @attr_name gives the fid for the lisxattr namespace</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="nf">p9_client_xattrwalk</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">file_fid</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">attr_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">attr_fid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">file_fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">attr_fid</span> <span class="o">=</span> <span class="n">p9_fid_create</span><span class="p">(</span><span class="n">clnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">attr_fid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">attr_fid</span><span class="p">);</span>
		<span class="n">attr_fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;&gt;&gt;&gt; TXATTRWALK file_fid %d, attr_fid %d name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">file_fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">attr_fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TXATTRWALK</span><span class="p">,</span> <span class="s">&quot;dds&quot;</span><span class="p">,</span>
			<span class="n">file_fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">attr_fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="n">attr_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clunk_fid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt;  RXATTRWALK fid %d size %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">attr_fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="o">*</span><span class="n">attr_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">attr_fid</span><span class="p">;</span>
<span class="nl">clunk_fid:</span>
	<span class="n">p9_client_clunk</span><span class="p">(</span><span class="n">attr_fid</span><span class="p">);</span>
	<span class="n">attr_fid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr_fid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">attr_fid</span> <span class="o">!=</span> <span class="n">file_fid</span><span class="p">))</span>
		<span class="n">p9_fid_destroy</span><span class="p">(</span><span class="n">attr_fid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">p9_client_xattrwalk</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_xattrcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">attr_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span>
		<span class="s">&quot;&gt;&gt;&gt; TXATTRCREATE fid %d name  %s size %lld flag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">attr_size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TXATTRCREATE</span><span class="p">,</span> <span class="s">&quot;dsqd&quot;</span><span class="p">,</span>
			<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr_size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RXATTRCREATE fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">p9_client_xattrcreate</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">non_zc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dataptr</span><span class="p">;</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TREADDIR fid %d offset %llu count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>

	<span class="n">rsize</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">iounit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsize</span> <span class="o">||</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span><span class="o">-</span><span class="n">P9_READDIRHDRSZ</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">-</span> <span class="n">P9_READDIRHDRSZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">rsize</span><span class="p">)</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t bother zerocopy for small IO (&lt; 1024) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">trans_mod</span><span class="o">-&gt;</span><span class="n">zc_request</span> <span class="o">&amp;&amp;</span> <span class="n">rsize</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * response header len is 11</span>
<span class="cm">		 * PDU Header(7) + IO Size (4)</span>
<span class="cm">		 */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_zc_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREADDIR</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dqd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">non_zc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREADDIR</span><span class="p">,</span> <span class="s">&quot;dqd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>
				    <span class="n">offset</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dataptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RREADDIR count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">non_zc</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">free_and_error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_readdir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_mknod_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="n">dev_t</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_qid</span> <span class="o">*</span><span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TMKNOD fid %d name %s mode %d major %d &quot;</span>
		<span class="s">&quot;minor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TMKNOD</span><span class="p">,</span> <span class="s">&quot;dsdddd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
		<span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RMKNOD qid %x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">qid</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_mknod_dotl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_mkdir_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				<span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_qid</span> <span class="o">*</span><span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TMKDIR fid %d name %s mode %d gid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TMKDIR</span><span class="p">,</span> <span class="s">&quot;dsdd&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
		<span class="n">gid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RMKDIR qid %x.%llx.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">qid</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_mkdir_dotl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_lock_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_flock</span> <span class="o">*</span><span class="n">flock</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TLOCK fid %d type %i flags %d &quot;</span>
			<span class="s">&quot;start %lld length %lld proc_id %d client_id %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">flock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TLOCK</span><span class="p">,</span> <span class="s">&quot;dbdqqds&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				<span class="n">flock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					<span class="n">flock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">flock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RLOCK status %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_lock_dotl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_getlock_dotl</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p9_getlock</span> <span class="o">*</span><span class="n">glock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TGETLOCK fid %d, type %i start %lld &quot;</span>
		<span class="s">&quot;length %lld proc_id %d client_id %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="n">glock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TGETLOCK</span><span class="p">,</span> <span class="s">&quot;dbqqds&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">,</span>  <span class="n">glock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="n">glock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;bqqds&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">glock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">glock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">glock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RGETLOCK type %i start %lld length %lld &quot;</span>
		<span class="s">&quot;proc_id %d client_id %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		<span class="n">glock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">glock</span><span class="o">-&gt;</span><span class="n">client_id</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_getlock_dotl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">p9_client_readlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">p9_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_client</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p9_req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">clnt</span><span class="p">;</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&gt;&gt;&gt; TREADLINK fid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">p9_client_rpc</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">P9_TREADLINK</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">p9pdu_readf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">clnt</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_9p_protocol_dump</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p9_debug</span><span class="p">(</span><span class="n">P9_DEBUG_9P</span><span class="p">,</span> <span class="s">&quot;&lt;&lt;&lt; RREADLINK target %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">target</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">p9_free_req</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">p9_client_readlink</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
