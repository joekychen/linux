<!DOCTYPE html>
<html><head><title>joekychen/linux » net › irda › ircomm › ircomm_tty_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ircomm_tty_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Filename:      ircomm_tty_ioctl.c</span>
<span class="cm"> * Version:</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Status:        Experimental.</span>
<span class="cm"> * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> * Created at:    Thu Jun 10 14:39:09 1999</span>
<span class="cm"> * Modified at:   Wed Jan  5 14:45:43 2000</span>
<span class="cm"> * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *     Copyright (c) 1999-2000 Dag Brattli, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *     This program is free software; you can redistribute it and/or</span>
<span class="cm"> *     modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *     published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *     the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *     This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> *     GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *     You should have received a copy of the GNU General Public License</span>
<span class="cm"> *     along with this program; if not, write to the Free Software</span>
<span class="cm"> *     Foundation, Inc., 59 Temple Place, Suite 330, Boston,</span>
<span class="cm"> *     MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irmod.h&gt;</span>

<span class="cp">#include &lt;net/irda/ircomm_core.h&gt;</span>
<span class="cp">#include &lt;net/irda/ircomm_param.h&gt;</span>
<span class="cp">#include &lt;net/irda/ircomm_tty_attach.h&gt;</span>
<span class="cp">#include &lt;net/irda/ircomm_tty.h&gt;</span>

<span class="cp">#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))</span>

<span class="cm">/*</span>
<span class="cm"> * Function ircomm_tty_change_speed (driver)</span>
<span class="cm"> *</span>
<span class="cm"> *    Change speed of the driver. If the remote device is a DCE, then this</span>
<span class="cm"> *    should make it change the speed of its serial port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ircomm_tty_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">cval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">||</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ircomm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/*  byte size and parity */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>: <span class="n">cval</span> <span class="o">=</span> <span class="n">IRCOMM_WSIZE_5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>: <span class="n">cval</span> <span class="o">=</span> <span class="n">IRCOMM_WSIZE_6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>: <span class="n">cval</span> <span class="o">=</span> <span class="n">IRCOMM_WSIZE_7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>: <span class="n">cval</span> <span class="o">=</span> <span class="n">IRCOMM_WSIZE_8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>  <span class="n">cval</span> <span class="o">=</span> <span class="n">IRCOMM_WSIZE_5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">IRCOMM_2_STOP_BIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">IRCOMM_PARITY_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">IRCOMM_PARITY_EVEN</span><span class="p">;</span>

	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>	<span class="cm">/* B0 transition handled in rs_set_termios */</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_DATA_RATE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>

	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">flow_control</span> <span class="o">|=</span> <span class="n">IRCOMM_RTS_CTS_IN</span><span class="p">;</span>
		<span class="cm">/* This got me. Bummer. Jean II */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">service_type</span> <span class="o">==</span> <span class="n">IRCOMM_3_WIRE_RAW</span><span class="p">)</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s(), enabling RTS/CTS on link that doesn&#39;t support it (3-wire-raw)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">flow_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRCOMM_RTS_CTS_IN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * Set up parity check flag</span>
<span class="c">	 */</span>

<span class="c">	if (I_INPCK(self-&gt;tty))</span>
<span class="c">		driver-&gt;read_status_mask |= LSR_FE | LSR_PE;</span>
<span class="c">	if (I_BRKINT(driver-&gt;tty) || I_PARMRK(driver-&gt;tty))</span>
<span class="c">		driver-&gt;read_status_mask |= LSR_BI;</span>

<span class="c">	/*</span>
<span class="c">	 * Characters to ignore</span>
<span class="c">	 */</span>
<span class="c">	driver-&gt;ignore_status_mask = 0;</span>
<span class="c">	if (I_IGNPAR(driver-&gt;tty))</span>
<span class="c">		driver-&gt;ignore_status_mask |= LSR_PE | LSR_FE;</span>

<span class="c">	if (I_IGNBRK(self-&gt;tty)) {</span>
<span class="c">		self-&gt;ignore_status_mask |= LSR_BI;</span>
<span class="c">		/*</span>
<span class="c">		 * If we&#39;re ignore parity and break indicators, ignore</span>
<span class="c">		 * overruns too. (For real raw support).</span>
<span class="c">		 */</span>
<span class="c">		if (I_IGNPAR(self-&gt;tty))</span>
<span class="c">			self-&gt;ignore_status_mask |= LSR_OE;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">cval</span><span class="p">;</span>

	<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_DATA_FORMAT</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_FLOW_CONTROL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ircomm_tty_set_termios (tty, old_termios)</span>
<span class="cm"> *</span>
<span class="cm"> *    This routine allows the tty driver to be notified when device&#39;s</span>
<span class="cm"> *    termios settings have changed.  Note that a well-designed tty driver</span>
<span class="cm"> *    should be prepared to accept the case where old == NULL, and try to</span>
<span class="cm"> *    do something rational.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ircomm_tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">==</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">)</span> <span class="o">==</span>
	     <span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ircomm_tty_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRCOMM_DTR</span><span class="o">|</span><span class="n">IRCOMM_RTS</span><span class="p">);</span>
		<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_DTE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_RTS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_DTE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ircomm_tty_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ircomm_tty_tiocmget (tty)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ircomm_tty_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span>  <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">&amp;</span> <span class="n">IRCOMM_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">&amp;</span> <span class="n">IRCOMM_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dce</span> <span class="o">&amp;</span> <span class="n">IRCOMM_CD</span><span class="p">)</span>  <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dce</span> <span class="o">&amp;</span> <span class="n">IRCOMM_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dce</span> <span class="o">&amp;</span> <span class="n">IRCOMM_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dce</span> <span class="o">&amp;</span> <span class="n">IRCOMM_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ircomm_tty_tiocmset (tty, set, clear)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ircomm_tty_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IRCOMM_TTY_MAGIC</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_DTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRCOMM_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRCOMM_DTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">set</span><span class="o">|</span><span class="n">clear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_DELTA_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">set</span><span class="o">|</span><span class="n">clear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">dte</span> <span class="o">|=</span> <span class="n">IRCOMM_DELTA_DTR</span><span class="p">;</span>

	<span class="n">ircomm_param_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCOMM_DTE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function get_serial_info (driver, retinfo)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ircomm_tty_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">closing_wait</span><span class="p">;</span>

	<span class="cm">/* For compatibility  */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">hub6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function set_serial_info (driver, new_info)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ircomm_tty_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	struct serial_struct new_serial;</span>
<span class="c">	struct ircomm_tty_cb old_state, *state;</span>

<span class="c">	IRDA_DEBUG(0, &quot;%s()\n&quot;, __func__ );</span>

<span class="c">	if (copy_from_user(&amp;new_serial,new_info,sizeof(new_serial)))</span>
<span class="c">		return -EFAULT;</span>


<span class="c">	state = self</span>
<span class="c">	old_state = *self;</span>

<span class="c">	if (!capable(CAP_SYS_ADMIN)) {</span>
<span class="c">		if ((new_serial.baud_base != state-&gt;settings.data_rate) ||</span>
<span class="c">		    (new_serial.close_delay != state-&gt;close_delay) ||</span>
<span class="c">		    ((new_serial.flags &amp; ~ASYNC_USR_MASK) !=</span>
<span class="c">		     (self-&gt;flags &amp; ~ASYNC_USR_MASK)))</span>
<span class="c">			return -EPERM;</span>
<span class="c">		state-&gt;flags = ((state-&gt;flags &amp; ~ASYNC_USR_MASK) |</span>
<span class="c">				 (new_serial.flags &amp; ASYNC_USR_MASK));</span>
<span class="c">		self-&gt;flags = ((self-&gt;flags &amp; ~ASYNC_USR_MASK) |</span>
<span class="c">			       (new_serial.flags &amp; ASYNC_USR_MASK));</span>
<span class="c">		/* self-&gt;custom_divisor = new_serial.custom_divisor; */</span>
<span class="c">		goto check_and_exit;</span>
<span class="c">	}</span>

<span class="c">	/*</span>
<span class="c">	 * OK, past this point, all the error checking has been done.</span>
<span class="c">	 * At this point, we start making changes.....</span>
<span class="c">	 */</span>

<span class="c">	if (self-&gt;settings.data_rate != new_serial.baud_base) {</span>
<span class="c">		self-&gt;settings.data_rate = new_serial.baud_base;</span>
<span class="c">		ircomm_param_request(self, IRCOMM_DATA_RATE, TRUE);</span>
<span class="c">	}</span>

<span class="c">	self-&gt;close_delay = new_serial.close_delay * HZ/100;</span>
<span class="c">	self-&gt;closing_wait = new_serial.closing_wait * HZ/100;</span>
<span class="c">	/* self-&gt;custom_divisor = new_serial.custom_divisor; */</span>

<span class="c">	self-&gt;flags = ((self-&gt;flags &amp; ~ASYNC_FLAGS) |</span>
<span class="c">		       (new_serial.flags &amp; ASYNC_FLAGS));</span>
<span class="c">	self-&gt;tty-&gt;low_latency = (self-&gt;flags &amp; ASYNC_LOW_LATENCY) ? 1 : 0;</span>

<span class="c"> check_and_exit:</span>

<span class="c">	if (self-&gt;flags &amp; ASYNC_INITIALIZED) {</span>
<span class="c">		if (((old_state.flags &amp; ASYNC_SPD_MASK) !=</span>
<span class="c">		     (self-&gt;flags &amp; ASYNC_SPD_MASK)) ||</span>
<span class="c">		    (old_driver.custom_divisor != driver-&gt;custom_divisor)) {</span>
<span class="c">			if ((driver-&gt;flags &amp; ASYNC_SPD_MASK) == ASYNC_SPD_HI)</span>
<span class="c">				driver-&gt;tty-&gt;alt_speed = 57600;</span>
<span class="c">			if ((driver-&gt;flags &amp; ASYNC_SPD_MASK) == ASYNC_SPD_VHI)</span>
<span class="c">				driver-&gt;tty-&gt;alt_speed = 115200;</span>
<span class="c">			if ((driver-&gt;flags &amp; ASYNC_SPD_MASK) == ASYNC_SPD_SHI)</span>
<span class="c">				driver-&gt;tty-&gt;alt_speed = 230400;</span>
<span class="c">			if ((driver-&gt;flags &amp; ASYNC_SPD_MASK) == ASYNC_SPD_WARP)</span>
<span class="c">				driver-&gt;tty-&gt;alt_speed = 460800;</span>
<span class="c">			ircomm_tty_change_speed(driver);</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ircomm_tty_ioctl (tty, cmd, arg)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ircomm_tty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ircomm_tty_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERCONFIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGSTRUCT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGICOUNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ircomm_tty_get_serial_info</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ircomm_tty_set_serial_info</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;(), TIOCMIWAIT, not impl!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TIOCGICOUNT</span>:
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), TIOCGICOUNT not impl!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		save_flags(flags); cli();</span>
<span class="c">		cnow = driver-&gt;icount;</span>
<span class="c">		restore_flags(flags);</span>
<span class="c">		p_cuser = (struct serial_icounter_struct __user *) arg;</span>
<span class="c">		if (put_user(cnow.cts, &amp;p_cuser-&gt;cts) ||</span>
<span class="c">		    put_user(cnow.dsr, &amp;p_cuser-&gt;dsr) ||</span>
<span class="c">		    put_user(cnow.rng, &amp;p_cuser-&gt;rng) ||</span>
<span class="c">		    put_user(cnow.dcd, &amp;p_cuser-&gt;dcd) ||</span>
<span class="c">		    put_user(cnow.rx, &amp;p_cuser-&gt;rx) ||</span>
<span class="c">		    put_user(cnow.tx, &amp;p_cuser-&gt;tx) ||</span>
<span class="c">		    put_user(cnow.frame, &amp;p_cuser-&gt;frame) ||</span>
<span class="c">		    put_user(cnow.overrun, &amp;p_cuser-&gt;overrun) ||</span>
<span class="c">		    put_user(cnow.parity, &amp;p_cuser-&gt;parity) ||</span>
<span class="c">		    put_user(cnow.brk, &amp;p_cuser-&gt;brk) ||</span>
<span class="c">		    put_user(cnow.buf_overrun, &amp;p_cuser-&gt;buf_overrun))</span>
<span class="c">			return -EFAULT;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>  <span class="cm">/* ioctls which we must ignore */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
