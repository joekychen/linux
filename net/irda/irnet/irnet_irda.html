<!DOCTYPE html>
<html><head><title>joekychen/linux » net › irda › irnet › irnet_irda.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>irnet_irda.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	IrNET protocol module : Synchronous PPP over an IrDA socket.</span>
<span class="cm"> *</span>
<span class="cm"> *		Jean II - HPL `00 - &lt;jt@hpl.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file implement the IRDA interface of IrNET.</span>
<span class="cm"> * Basically, we sit on top of IrTTP. We set up IrTTP, IrIAS properly,</span>
<span class="cm"> * and exchange frames with IrTTP.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;irnet_irda.h&quot;		</span><span class="cm">/* Private header */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * PPP disconnect work: we need to make sure we&#39;re in</span>
<span class="cm"> * process context when calling ppp_unregister_channel().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">irnet_ppp_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irnet_socket</span> <span class="o">*</span> <span class="n">self</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">irnet_socket</span><span class="p">,</span> <span class="n">disconnect_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we were connected, cleanup &amp; close the PPP</span>
<span class="cm">	 * channel, which will kill pppd (hangup) and the rest.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppp_unregister_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************* CONTROL CHANNEL *************************/</span>
<span class="cm">/*</span>
<span class="cm"> * When ppp is not active, /dev/irnet act as a control channel.</span>
<span class="cm"> * Writing allow to set up the IrDA destination of the IrNET channel,</span>
<span class="cm"> * and any application may be read events happening on IrNET...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Post an event to the control channel...</span>
<span class="cm"> * Put the event in the log, and then wait all process blocked on read</span>
<span class="cm"> * so they can read the log...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_post_event</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
		 <span class="n">irnet_event</span>	<span class="n">event</span><span class="p">,</span>
		 <span class="n">__u32</span>		<span class="n">saddr</span><span class="p">,</span>
		 <span class="n">__u32</span>		<span class="n">daddr</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="o">*</span>		<span class="n">name</span><span class="p">,</span>
		 <span class="n">__u16</span>		<span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>			<span class="n">index</span><span class="p">;</span>		<span class="cm">/* In the log */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p, event=%d, daddr=%08x, name=``%s&#39;&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">ap</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

  <span class="cm">/* Protect this section via spinlock.</span>
<span class="cm">   * Note : as we are the only event producer, we only need to exclude</span>
<span class="cm">   * ourself when touching the log, which is nice and easy.</span>
<span class="cm">   */</span>
  <span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="cm">/* Copy the event in the log */</span>
  <span class="n">index</span> <span class="o">=</span> <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>
  <span class="cm">/* Try to copy IrDA nickname */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="cm">/* Copy hints */</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">hints</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">hints</span><span class="p">;</span>
  <span class="cm">/* Try to get ppp unit number */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">ap</span> <span class="o">!=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">))</span>
    <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">unit</span> <span class="o">=</span> <span class="n">ppp_unit_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* Increment the index</span>
<span class="cm">   * Note that we increment the index only after the event is written,</span>
<span class="cm">   * to make sure that the readers don&#39;t get garbage... */</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">IRNET_MAX_EVENTS</span><span class="p">;</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;New event index is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>

  <span class="cm">/* Spin lock end */</span>
  <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="cm">/* Now : wake up everybody waiting for events... */</span>
  <span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">rwait</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************* IRDA SUBROUTINES *************************/</span>
<span class="cm">/*</span>
<span class="cm"> * These are a bunch of subroutines called from other functions</span>
<span class="cm"> * down there, mostly common code or to improve readability...</span>
<span class="cm"> *</span>
<span class="cm"> * Note : we duplicate quite heavily some routines of af_irda.c,</span>
<span class="cm"> * because our input structure (self) is quite different</span>
<span class="cm"> * (struct irnet instead of struct irda_sock), which make sharing</span>
<span class="cm"> * the same code impossible (at least, without templates).</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_open_tsap (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Open local Transport Service Access Point (TSAP)</span>
<span class="cm"> *</span>
<span class="cm"> * Create a IrTTP instance for us and set all the IrTTP callbacks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_open_tsap</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">notify_t</span>	<span class="n">notify</span><span class="p">;</span>		<span class="cm">/* Callback structure */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="n">DABORT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span> <span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;Already busy !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Initialize IrTTP callbacks to be used by the IrDA stack */</span>
  <span class="n">irda_notify_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="p">);</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">connect_confirm</span>	<span class="o">=</span> <span class="n">irnet_connect_confirm</span><span class="p">;</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">connect_indication</span>	<span class="o">=</span> <span class="n">irnet_connect_indication</span><span class="p">;</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">disconnect_indication</span>	<span class="o">=</span> <span class="n">irnet_disconnect_indication</span><span class="p">;</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">data_indication</span>	<span class="o">=</span> <span class="n">irnet_data_indication</span><span class="p">;</span>
  <span class="cm">/*notify.udata_indication	= NULL;*/</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">flow_indication</span>	<span class="o">=</span> <span class="n">irnet_flow_indication</span><span class="p">;</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">status_indication</span>	<span class="o">=</span> <span class="n">irnet_status_indication</span><span class="p">;</span>
  <span class="n">notify</span><span class="p">.</span><span class="n">instance</span>		<span class="o">=</span> <span class="n">self</span><span class="p">;</span>
  <span class="n">strlcpy</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IRNET_NOTIFY_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>

  <span class="cm">/* Open an IrTTP instance */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">=</span> <span class="n">irttp_open_tsap</span><span class="p">(</span><span class="n">LSAP_ANY</span><span class="p">,</span> <span class="n">DEFAULT_INITIAL_CREDIT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">notify</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
	 <span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;Unable to allocate TSAP !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Remember which TSAP selector we actually got */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">stsap_sel</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="o">-&gt;</span><span class="n">stsap_sel</span><span class="p">;</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot; - tsap=0x%p, sel=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">stsap_sel</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_ias_to_tsap (self, result, value)</span>
<span class="cm"> *</span>
<span class="cm"> *    Examine an IAS object and extract TSAP</span>
<span class="cm"> *</span>
<span class="cm"> * We do an IAP query to find the TSAP associated with the IrNET service.</span>
<span class="cm"> * When IrIAP pass us the result of the query, this function look at</span>
<span class="cm"> * the return values to check for failures and extract the TSAP if</span>
<span class="cm"> * possible.</span>
<span class="cm"> * Also deallocate value</span>
<span class="cm"> * The failure is in self-&gt;errno</span>
<span class="cm"> * Return TSAP or -1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span>
<span class="nf">irnet_ias_to_tsap</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">,</span>
		  <span class="kt">int</span>			<span class="n">result</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ias_value</span> <span class="o">*</span>	<span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u8</span>	<span class="n">dtsap_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* TSAP we are looking for */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* By default, no error */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Check if request succeeded */</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Standard errors : service not available */</span>
    <span class="k">case</span> <span class="n">IAS_CLASS_UNKNOWN</span>:
    <span class="k">case</span> <span class="n">IAS_ATTRIB_UNKNOWN</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;IAS object doesn&#39;t exist ! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Other errors, most likely IrDA stack failure */</span>
    <span class="k">default</span> <span class="o">:</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;IAS query failed ! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Success : we got what we wanted */</span>
    <span class="k">case</span> <span class="n">IAS_SUCCESS</span>:
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Check what was returned to us */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* What type of argument have we got ? */</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">IAS_INTEGER</span>:
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	    <span class="cm">/* Get the remote TSAP selector */</span>
	    <span class="n">dtsap_sel</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span><span class="p">;</span>
	  <span class="k">else</span>
	    <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	  <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;bad type ! (0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="cm">/* Cleanup */</span>
      <span class="n">irias_delete_value</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>	<span class="cm">/* value == NULL */</span>
    <span class="p">{</span>
      <span class="cm">/* Nothing returned to us - usually result != SUCCESS */</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_SR_ERROR</span><span class="p">,</span>
		 <span class="s">&quot;IrDA bug : result == SUCCESS &amp;&amp; value == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Return the TSAP */</span>
  <span class="k">return</span> <span class="n">dtsap_sel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_find_lsap_sel (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Try to lookup LSAP selector in remote LM-IAS</span>
<span class="cm"> *</span>
<span class="cm"> * Basically, we start a IAP query, and then go to sleep. When the query</span>
<span class="cm"> * return, irnet_getvalue_confirm will wake us up, and we can examine the</span>
<span class="cm"> * result of the query...</span>
<span class="cm"> * Note that in some case, the query fail even before we go to sleep,</span>
<span class="cm"> * creating some races...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_find_lsap_sel</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* This should not happen */</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">,</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span> <span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;busy with a previous query.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Create an IAP instance, will be closed in irnet_getvalue_confirm() */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="n">iriap_open</span><span class="p">(</span><span class="n">LSAP_ANY</span><span class="p">,</span> <span class="n">IAS_CLIENT</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span>
			   <span class="n">irnet_getvalue_confirm</span><span class="p">);</span>

  <span class="cm">/* Treat unexpected signals as disconnect */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>

  <span class="cm">/* Query remote LM-IAS */</span>
  <span class="n">iriap_getvaluebyclass_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rsaddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				<span class="n">IRNET_SERVICE_NAME</span><span class="p">,</span> <span class="n">IRNET_IAS_VALUE</span><span class="p">);</span>

  <span class="cm">/* The above request is non-blocking.</span>
<span class="cm">   * After a while, IrDA will call us back in irnet_getvalue_confirm()</span>
<span class="cm">   * We will then call irnet_ias_to_tsap() and finish the</span>
<span class="cm">   * connection procedure */</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_connect_tsap (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialise the TTP socket and initiate TTP connection</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_connect_tsap</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Open a local TSAP (an IrTTP instance) */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irnet_open_tsap</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;connect aborted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Connect to remote device */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irttp_connect_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span><span class="p">,</span>
			      <span class="n">self</span><span class="o">-&gt;</span><span class="n">rsaddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			      <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_sdu_size_rx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_SR_ERROR</span><span class="p">,</span> <span class="s">&quot;connect aborted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* The above call is non-blocking.</span>
<span class="cm">   * After a while, the IrDA stack will either call us back in</span>
<span class="cm">   * irnet_connect_confirm() or irnet_disconnect_indication()</span>
<span class="cm">   * See you there ;-) */</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_discover_next_daddr (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Query the IrNET TSAP of the next device in the log.</span>
<span class="cm"> *</span>
<span class="cm"> * Used in the TSAP discovery procedure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_discover_next_daddr</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Close the last instance of IrIAP, and open a new one.</span>
<span class="cm">   * We can&#39;t reuse the IrIAP instance in the IrIAP callback */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* Create a new IAP instance */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="n">iriap_open</span><span class="p">(</span><span class="n">LSAP_ANY</span><span class="p">,</span> <span class="n">IAS_CLIENT</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span>
			   <span class="n">irnet_discovervalue_confirm</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

  <span class="cm">/* Next discovery - before the call to avoid races */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="o">++</span><span class="p">;</span>

  <span class="cm">/* Check if we have one more address to try */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span> <span class="o">&lt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Query remote LM-IAS */</span>
      <span class="n">iriap_getvaluebyclass_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">,</span>
				    <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">saddr</span><span class="p">,</span>
				    <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
				    <span class="n">IRNET_SERVICE_NAME</span><span class="p">,</span> <span class="n">IRNET_IAS_VALUE</span><span class="p">);</span>
      <span class="cm">/* The above request is non-blocking.</span>
<span class="cm">       * After a while, IrDA will call us back in irnet_discovervalue_confirm()</span>
<span class="cm">       * We will then call irnet_ias_to_tsap() and come back here again... */</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_discover_daddr_and_lsap_sel (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    This try to find a device with the requested service.</span>
<span class="cm"> *</span>
<span class="cm"> * Initiate a TSAP discovery procedure.</span>
<span class="cm"> * It basically look into the discovery log. For each address in the list,</span>
<span class="cm"> * it queries the LM-IAS of the device to find if this device offer</span>
<span class="cm"> * the requested service.</span>
<span class="cm"> * If there is more than one node supporting the service, we complain</span>
<span class="cm"> * to the user (it should move devices around).</span>
<span class="cm"> * If we find one node which have the requested TSAP, we connect to it.</span>
<span class="cm"> *</span>
<span class="cm"> * This function just start the whole procedure. It request the discovery</span>
<span class="cm"> * log and submit the first IAS query.</span>
<span class="cm"> * The bulk of the job is handled in irnet_discovervalue_confirm()</span>
<span class="cm"> *</span>
<span class="cm"> * Note : this procedure fails if there is more than one device in range</span>
<span class="cm"> * on the same dongle, because IrLMP doesn&#39;t disconnect the LAP when the</span>
<span class="cm"> * last LSAP is closed. Moreover, we would need to wait the LAP</span>
<span class="cm"> * disconnection...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_discover_daddr_and_lsap_sel</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Ask lmp for the current discovery log */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="n">irlmp_get_discoveries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
					    <span class="n">DISCOVERY_DEFAULT_SLOTS</span><span class="p">);</span>

  <span class="cm">/* Check if the we got some results */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DRETURN</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">,</span> <span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;No Cachelog...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;Got the log (0x%p), size is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">);</span>

  <span class="cm">/* Start with the first discovery */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>

  <span class="cm">/* This will fail if the log is empty - this is non-blocking */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">irnet_discover_next_daddr</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Close IAP */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">)</span>
	<span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

      <span class="cm">/* Cleanup our copy of the discovery log */</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DRETURN</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">,</span> <span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;Cachelog empty...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* Follow me in irnet_discovervalue_confirm() */</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_dname_to_daddr (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Convert an IrDA nickname to a valid IrDA address</span>
<span class="cm"> *</span>
<span class="cm"> * It basically look into the discovery log until there is a match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_dname_to_daddr</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">irda_device_info</span> <span class="o">*</span><span class="n">discoveries</span><span class="p">;</span>	<span class="cm">/* Copy of the discovery log */</span>
  <span class="kt">int</span>	<span class="n">number</span><span class="p">;</span>			<span class="cm">/* Number of nodes in the log */</span>
  <span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Ask lmp for the current discovery log */</span>
  <span class="n">discoveries</span> <span class="o">=</span> <span class="n">irlmp_get_discoveries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">number</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
				      <span class="n">DISCOVERY_DEFAULT_SLOTS</span><span class="p">);</span>
  <span class="cm">/* Check if the we got some results */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">DRETURN</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">,</span> <span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;Cachelog empty...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Now, check all discovered devices (if any), and connect</span>
<span class="cm">   * client only about the services that the client is</span>
<span class="cm">   * interested in...</span>
<span class="cm">   */</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Does the name match ? */</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">discoveries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="n">NICKNAME_MAX_LEN</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="cm">/* Yes !!! Get it.. */</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">discoveries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">daddr</span><span class="p">;</span>
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;discovered device ``%s&#39;&#39; at address 0x%08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	  <span class="n">kfree</span><span class="p">(</span><span class="n">discoveries</span><span class="p">);</span>
	  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SR_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="cm">/* No luck ! */</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SR_INFO</span><span class="p">,</span> <span class="s">&quot;cannot discover device ``%s&#39;&#39; !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">discoveries</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************* SOCKET ROUTINES *************************/</span>
<span class="cm">/*</span>
<span class="cm"> * This are the main operations on IrNET sockets, basically to create</span>
<span class="cm"> * and destroy IrNET sockets. These are called from the PPP part...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Create a IrNET instance : just initialise some parameters...</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">irda_irnet_create</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">IRNET_MAGIC</span><span class="p">;</span>	<span class="cm">/* Paranoia */</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Prevent higher layer from accessing IrTTP */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Not connecting yet */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/* May be set via control channel */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>	<span class="cm">/* May be set via control channel */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rsaddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>	<span class="cm">/* May be set via control channel */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>	<span class="cm">/* Until we get connected */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>	<span class="cm">/* Until we get connected */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_sdu_size_rx</span> <span class="o">=</span> <span class="n">TTP_SAR_UNBOUND</span><span class="p">;</span>

  <span class="cm">/* Register as a client with IrLMP */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ckey</span> <span class="o">=</span> <span class="n">irlmp_register_client</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#ifdef DISCOVERY_NOMASK</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>		<span class="cm">/* For W2k compatibility */</span>
<span class="cp">#else </span><span class="cm">/* DISCOVERY_NOMASK */</span><span class="cp"></span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">irlmp_service_to_hint</span><span class="p">(</span><span class="n">S_LAN</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DISCOVERY_NOMASK */</span><span class="cp"></span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="n">FLOW_START</span><span class="p">;</span>	<span class="cm">/* Flow control from IrTTP */</span>

  <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disconnect_work</span><span class="p">,</span> <span class="n">irnet_ppp_disconnect</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Connect to the other side :</span>
<span class="cm"> *	o convert device name to an address</span>
<span class="cm"> *	o find the socket number (dlsap)</span>
<span class="cm"> *	o Establish the connection</span>
<span class="cm"> *</span>
<span class="cm"> * Note : We no longer mimic af_irda. The IAS query for finding the TSAP</span>
<span class="cm"> * is done asynchronously, like the TTP connection. This allow us to</span>
<span class="cm"> * call this function from any context (not only process).</span>
<span class="cm"> * The downside is that following what&#39;s happening in there is tricky</span>
<span class="cm"> * because it involve various functions all over the place...</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">irda_irnet_connect</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Check if we are already trying to connect.</span>
<span class="cm">   * Because irda_irnet_connect() can be called directly by pppd plus</span>
<span class="cm">   * packet retries in ppp_generic and connect may take time, plus we may</span>
<span class="cm">   * race with irnet_connect_indication(), we need to be careful there... */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span>
    <span class="n">DRETURN</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span> <span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;Already connecting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_SOCK_ERROR</span><span class="p">,</span> <span class="s">&quot;Socket not cleaned up...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Insert ourselves in the hashbin so that the IrNET server can find us.</span>
<span class="cm">   * Notes : 4th arg is string of 32 char max and must be null terminated</span>
<span class="cm">   *	     When 4th arg is used (string), 3rd arg isn&#39;t (int)</span>
<span class="cm">   *	     Can&#39;t re-insert (MUST remove first) so check for that... */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">q_next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>
      <span class="n">hashbin_insert</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="p">(</span><span class="n">irda_queue_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
      <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;Inserted ``%s&#39;&#39; in hashbin...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* If we don&#39;t have anything (no address, no name) */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">==</span> <span class="n">DEV_ADDR_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* Try to find a suitable address */</span>
      <span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">irnet_discover_daddr_and_lsap_sel</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">DRETURN</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;auto-connect failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* In most cases, the call above is non-blocking */</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* If we have only the name (no address), try to get an address */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">==</span> <span class="n">DEV_ADDR_ANY</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">irnet_dname_to_daddr</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">DRETURN</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;name connect failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="cm">/* Use the requested destination address */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rdaddr</span><span class="p">;</span>

      <span class="cm">/* Query remote LM-IAS to find LSAP selector */</span>
      <span class="n">irnet_find_lsap_sel</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="cm">/* The above call is non blocking */</span>
    <span class="p">}</span>

  <span class="cm">/* At this point, we are waiting for the IrDA stack to call us back,</span>
<span class="cm">   * or we have already failed.</span>
<span class="cm">   * We will finish the connection procedure in irnet_connect_tsap().</span>
<span class="cm">   */</span>
  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_irnet_destroy(self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Destroy irnet instance</span>
<span class="cm"> *</span>
<span class="cm"> * Note : this need to be called from a process context.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">irda_irnet_destroy</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="cm">/* Remove ourselves from hashbin (if we are queued in hashbin)</span>
<span class="cm">   * Note : `irnet_server.running&#39; protect us from calls in hashbin_delete() */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">q_next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">struct</span> <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">entry</span><span class="p">;</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;Removing from hash..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>
      <span class="n">entry</span> <span class="o">=</span> <span class="n">hashbin_remove_this</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="p">(</span><span class="n">irda_queue_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">q_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>
      <span class="n">DASSERT</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">self</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_SOCK_ERROR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t remove from hash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* If we were connected, post a message */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* Note : as the disconnect comes from ppp_generic, the unit number</span>
<span class="cm">       * doesn&#39;t exist anymore when we post the event, so we need to pass</span>
<span class="cm">       * NULL as the first arg... */</span>
      <span class="n">irnet_post_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IRNET_DISCONNECT_TO</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* Prevent various IrDA callbacks from messing up things</span>
<span class="cm">   * Need to be first */</span>
  <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>

  <span class="cm">/* Prevent higher layer from accessing IrTTP */</span>
  <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">);</span>

  <span class="cm">/* Unregister with IrLMP */</span>
  <span class="n">irlmp_unregister_client</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ckey</span><span class="p">);</span>

  <span class="cm">/* Unregister with LM-IAS */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Cleanup eventual discoveries from connection attempt or control channel */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Cleanup our copy of the discovery log */</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Close our IrTTP connection */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SOCK_INFO</span><span class="p">,</span> <span class="s">&quot;Closing our TTP connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">irttp_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">P_NORMAL</span><span class="p">);</span>
      <span class="n">irttp_close_tsap</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">stsap_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SOCK_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/************************** SERVER SOCKET **************************/</span>
<span class="cm">/*</span>
<span class="cm"> * The IrNET service is composed of one server socket and a variable</span>
<span class="cm"> * number of regular IrNET sockets. The server socket is supposed to</span>
<span class="cm"> * handle incoming connections and redirect them to one IrNET sockets.</span>
<span class="cm"> * It&#39;s a superset of the regular IrNET socket, but has a very distinct</span>
<span class="cm"> * behaviour...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_daddr_to_dname (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Convert an IrDA address to a IrDA nickname</span>
<span class="cm"> *</span>
<span class="cm"> * It basically look into the discovery log until there is a match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_daddr_to_dname</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">irda_device_info</span> <span class="o">*</span><span class="n">discoveries</span><span class="p">;</span>	<span class="cm">/* Copy of the discovery log */</span>
  <span class="kt">int</span>	<span class="n">number</span><span class="p">;</span>			<span class="cm">/* Number of nodes in the log */</span>
  <span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Ask lmp for the current discovery log */</span>
  <span class="n">discoveries</span> <span class="o">=</span> <span class="n">irlmp_get_discoveries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">number</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
				      <span class="n">DISCOVERY_DEFAULT_SLOTS</span><span class="p">);</span>
  <span class="cm">/* Check if the we got some results */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">DRETURN</span><span class="p">(</span><span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">,</span> <span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;Cachelog empty...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Now, check all discovered devices (if any) */</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Does the name match ? */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">discoveries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* Yes !!! Get it.. */</span>
	  <span class="n">strlcpy</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">));</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;Device 0x%08x is in fact ``%s&#39;&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
	  <span class="n">kfree</span><span class="p">(</span><span class="n">discoveries</span><span class="p">);</span>
	  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="cm">/* No luck ! */</span>
  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;: cannot discover device 0x%08x !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">discoveries</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_find_socket (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Find the correct IrNET socket</span>
<span class="cm"> *</span>
<span class="cm"> * Look into the list of IrNET sockets and finds one with the right</span>
<span class="cm"> * properties...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">irnet_socket</span> <span class="o">*</span>
<span class="nf">irnet_find_socket</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Get the addresses of the requester */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">irttp_get_daddr</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">irttp_get_saddr</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>

  <span class="cm">/* Try to get the IrDA nickname of the requester */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irnet_daddr_to_dname</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Protect access to the instance list */</span>
  <span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="cm">/* So now, try to get an socket having specifically</span>
<span class="cm">   * requested that nickname */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_find</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;Socket 0x%p matches rname ``%s&#39;&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">new</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* If no name matches, try to find an socket by the destination address */</span>
  <span class="cm">/* It can be either the requested destination address (set via the</span>
<span class="cm">   * control channel), or the current destination address if the</span>
<span class="cm">   * socket is in the middle of a connection request */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">new</span> <span class="o">!=</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* Does it have the same address ? */</span>
	  <span class="k">if</span><span class="p">((</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">==</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="cm">/* Yes !!! Get it.. */</span>
	      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;Socket 0x%p matches daddr %#08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">new</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="cm">/* If we don&#39;t have any socket, get the first unconnected socket */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">new</span> <span class="o">!=</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* Is it available ? */</span>
	  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">==</span> <span class="n">DEV_ADDR_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="cm">/* Yes !!! Get it.. */</span>
	      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_SERV_INFO</span><span class="p">,</span> <span class="s">&quot;Socket 0x%p is free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">new</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="cm">/* Spin lock end */</span>
  <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot; - new = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_connect_socket (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Connect an incoming connection to the socket</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_connect_socket</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">server</span><span class="p">,</span>
		     <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">new</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span>	<span class="n">qos</span><span class="p">,</span>
		     <span class="n">__u32</span>		<span class="n">max_sdu_size</span><span class="p">,</span>
		     <span class="n">__u8</span>		<span class="n">max_header_size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;(server=0x%p, new=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">server</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

  <span class="cm">/* Now attach up the new socket */</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">=</span> <span class="n">irttp_dup</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">IRDA_SERV_ERROR</span><span class="p">,</span> <span class="s">&quot;dup failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Set up all the relevant parameters on the new socket */</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">stsap_sel</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="o">-&gt;</span><span class="n">stsap_sel</span><span class="p">;</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span><span class="p">;</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">irttp_get_saddr</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">irttp_get_daddr</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>

  <span class="n">new</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">=</span> <span class="n">max_header_size</span><span class="p">;</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">max_sdu_size_tx</span> <span class="o">=</span> <span class="n">max_sdu_size</span><span class="p">;</span>
  <span class="n">new</span><span class="o">-&gt;</span><span class="n">max_data_size</span>   <span class="o">=</span> <span class="n">max_sdu_size</span><span class="p">;</span>
<span class="cp">#ifdef STREAM_COMPAT</span>
  <span class="cm">/* If we want to receive &quot;stream sockets&quot; */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">max_sdu_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">new</span><span class="o">-&gt;</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">irttp_get_max_seg_size</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* STREAM_COMPAT */</span><span class="cp"></span>

  <span class="cm">/* Clean up the original one to keep it in listen state */</span>
  <span class="n">irttp_listen</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>

  <span class="cm">/* Send a connection response on the new socket */</span>
  <span class="n">irttp_connect_response</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">max_sdu_size_rx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Allow PPP to send its junk over the new socket... */</span>
  <span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">);</span>

  <span class="cm">/* Not connecting anymore, and clean up last possible remains</span>
<span class="cm">   * of connection attempts on the socket */</span>
  <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">iriap_close</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
      <span class="n">new</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
      <span class="n">new</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#ifdef CONNECT_INDIC_KICK</span>
  <span class="cm">/* As currently we don&#39;t block packets in ppp_irnet_send() while passive,</span>
<span class="cm">   * this is not really needed...</span>
<span class="cm">   * Also, not doing it give IrDA a chance to finish the setup properly</span>
<span class="cm">   * before being swamped with packets... */</span>
  <span class="n">ppp_output_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONNECT_INDIC_KICK */</span><span class="cp"></span>

  <span class="cm">/* Notify the control channel */</span>
  <span class="n">irnet_post_event</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">IRNET_CONNECT_FROM</span><span class="p">,</span>
		   <span class="n">new</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_disconnect_server (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Cleanup the server socket when the incoming connection abort</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">irnet_disconnect_server</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Put the received packet in the black hole */</span>
  <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#ifdef FAIL_SEND_DISCONNECT</span>
  <span class="cm">/* Tell the other party we don&#39;t want to be connected */</span>
  <span class="cm">/* Hum... Is it the right thing to do ? And do we need to send</span>
<span class="cm">   * a connect response before ? It looks ok without this... */</span>
  <span class="n">irttp_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">P_NORMAL</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* FAIL_SEND_DISCONNECT */</span><span class="cp"></span>

  <span class="cm">/* Notify the control channel (see irnet_find_socket()) */</span>
  <span class="n">irnet_post_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IRNET_REQUEST_FROM</span><span class="p">,</span>
		   <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="cm">/* Clean up the server to keep it in listen state */</span>
  <span class="n">irttp_listen</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_setup_server (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Create a IrTTP server and set it up...</span>
<span class="cm"> *</span>
<span class="cm"> * Register the IrLAN hint bit, create a IrTTP instance for us,</span>
<span class="cm"> * set all the IrTTP callbacks and create an IrIAS entry...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_setup_server</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u16</span>		<span class="n">hints</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Initialise the regular socket part of the server */</span>
  <span class="n">irda_irnet_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>

  <span class="cm">/* Open a local TSAP (an IrTTP instance) for the server */</span>
  <span class="n">irnet_open_tsap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>

  <span class="cm">/* PPP part setup */</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* Get the hint bit corresponding to IrLAN */</span>
  <span class="cm">/* Note : we overload the IrLAN hint bit. As it is only a &quot;hint&quot;, and as</span>
<span class="cm">   * we provide roughly the same functionality as IrLAN, this is ok.</span>
<span class="cm">   * In fact, the situation is similar as JetSend overloading the Obex hint</span>
<span class="cm">   */</span>
  <span class="n">hints</span> <span class="o">=</span> <span class="n">irlmp_service_to_hint</span><span class="p">(</span><span class="n">S_LAN</span><span class="p">);</span>

<span class="cp">#ifdef ADVERTISE_HINT</span>
  <span class="cm">/* Register with IrLMP as a service (advertise our hint bit) */</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">skey</span> <span class="o">=</span> <span class="n">irlmp_register_service</span><span class="p">(</span><span class="n">hints</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ADVERTISE_HINT */</span><span class="cp"></span>

  <span class="cm">/* Register with LM-IAS (so that people can connect to us) */</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">ias_obj</span> <span class="o">=</span> <span class="n">irias_new_object</span><span class="p">(</span><span class="n">IRNET_SERVICE_NAME</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
  <span class="n">irias_add_integer_attrib</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">ias_obj</span><span class="p">,</span> <span class="n">IRNET_IAS_VALUE</span><span class="p">,</span>
			   <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">stsap_sel</span><span class="p">,</span> <span class="n">IAS_KERNEL_ATTR</span><span class="p">);</span>
  <span class="n">irias_insert_object</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">ias_obj</span><span class="p">);</span>

<span class="cp">#ifdef DISCOVERY_EVENTS</span>
  <span class="cm">/* Tell IrLMP we want to be notified of newly discovered nodes */</span>
  <span class="n">irlmp_update_client</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ckey</span><span class="p">,</span> <span class="n">hints</span><span class="p">,</span>
		      <span class="n">irnet_discovery_indication</span><span class="p">,</span> <span class="n">irnet_expiry_indication</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot; - self=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irda_destroy_server (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Destroy the IrTTP server...</span>
<span class="cm"> *</span>
<span class="cm"> * Reverse of the previous function...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">irnet_destroy_server</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef ADVERTISE_HINT</span>
  <span class="cm">/* Unregister with IrLMP */</span>
  <span class="n">irlmp_unregister_service</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">skey</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ADVERTISE_HINT */</span><span class="cp"></span>

  <span class="cm">/* Unregister with LM-IAS */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">ias_obj</span><span class="p">)</span>
    <span class="n">irias_delete_object</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">ias_obj</span><span class="p">);</span>

  <span class="cm">/* Cleanup the socket part */</span>
  <span class="n">irda_irnet_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_SERV_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/************************ IRDA-TTP CALLBACKS ************************/</span>
<span class="cm">/*</span>
<span class="cm"> * When we create a IrTTP instance, we pass to it a set of callbacks</span>
<span class="cm"> * that IrTTP will call in case of various events.</span>
<span class="cm"> * We take care of those events here.</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_data_indication (instance, sap, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Received some data from TinyTP. Just queue it on the receive queue</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">irnet_data_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>	<span class="n">instance</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span>	<span class="n">sap</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>	<span class="n">p</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self/ap=0x%p, skb=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;skb is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Check is ppp is ready to receive our packet */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;PPP not ready, dropping packet...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* When we return error, TTP will need to requeue the skb and</span>
<span class="cm">       * will stop the sender. IrTTP will stall until we send it a</span>
<span class="cm">       * flow control request... */</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* strip address/control field if present */</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="k">if</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">PPP_ALLSTATIONS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">PPP_UI</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* chop off address/control */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* decompress protocol field if compressed */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* protocol is compressed */</span>
      <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

  <span class="cm">/* pass to generic ppp layer */</span>
  <span class="cm">/* Note : how do I know if ppp can accept or not the packet ? This is</span>
<span class="cm">   * essential if I want to manage flow control smoothly... */</span>
  <span class="n">ppp_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_exit:</span>
  <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Packet too small, dropping...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
  <span class="n">ppp_input_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t return an error code, only for flow control... */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_disconnect_indication (instance, sap, reason, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Connection has been closed. Chech reason to find out why</span>
<span class="cm"> *</span>
<span class="cm"> * Note : there are many cases where we come here :</span>
<span class="cm"> *	o attempted to connect, timeout</span>
<span class="cm"> *	o connected, link is broken, LAP has timeout</span>
<span class="cm"> *	o connected, other side close the link</span>
<span class="cm"> *	o connection request on the server not handled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_disconnect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>	<span class="n">instance</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span>	<span class="n">sap</span><span class="p">,</span>
			    <span class="n">LM_REASON</span>	<span class="n">reason</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">test_open</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">test_connect</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Self is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Don&#39;t care about it, but let&#39;s not leak it */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
    <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="cm">/* Prevent higher layer from accessing IrTTP */</span>
  <span class="n">test_open</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">);</span>
  <span class="cm">/* Not connecting anymore...</span>
<span class="cm">   * (note : TSAP is open, so IAP callbacks are no longer pending...) */</span>
  <span class="n">test_connect</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>

  <span class="cm">/* If both self-&gt;ttp_open and self-&gt;ttp_connect are NULL, it mean that we</span>
<span class="cm">   * have a race condition with irda_irnet_destroy() or</span>
<span class="cm">   * irnet_connect_indication(), so don&#39;t mess up tsap...</span>
<span class="cm">   */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_open</span> <span class="o">||</span> <span class="n">test_connect</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Race condition detected...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* If we were active, notify the control channel */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">test_open</span><span class="p">)</span>
    <span class="n">irnet_post_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRNET_DISCONNECT_FROM</span><span class="p">,</span>
		     <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="cm">/* If we were trying to connect, notify the control channel */</span>
    <span class="k">if</span><span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">))</span>
      <span class="n">irnet_post_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRNET_NOANSWER_FROM</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="cm">/* Close our IrTTP connection, cleanup tsap */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;Closing our TTP connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">irttp_close_tsap</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* Cleanup the socket in case we want to reconnect in ppp_output_wakeup() */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">stsap_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="n">FLOW_START</span><span class="p">;</span>

  <span class="cm">/* Deal with the ppp instance if it&#39;s still alive */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">test_open</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* ppp_unregister_channel() wants a user context. */</span>
	  <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disconnect_work</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="cm">/* If we were trying to connect, flush (drain) ppp_generic</span>
<span class="cm">	   * Tx queue (most often we have blocked it), which will</span>
<span class="cm">	   * trigger an other attempt to connect. If we are passive,</span>
<span class="cm">	   * this will empty the Tx queue after last try. */</span>
	  <span class="n">ppp_output_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_connect_confirm (instance, sap, qos, max_sdu_size, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Connections has been confirmed by the remote device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_connect_confirm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>	<span class="n">instance</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span>	<span class="n">sap</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span>
		      <span class="n">__u32</span>	<span class="n">max_sdu_size</span><span class="p">,</span>
		      <span class="n">__u8</span>	<span class="n">max_header_size</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Check if socket is closing down (via irda_irnet_destroy()) */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Socket no longer connecting. Ouch !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* How much header space do we need to reserve */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">=</span> <span class="n">max_header_size</span><span class="p">;</span>

  <span class="cm">/* IrTTP max SDU size in transmit direction */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_sdu_size_tx</span> <span class="o">=</span> <span class="n">max_sdu_size</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">max_sdu_size</span><span class="p">;</span>
<span class="cp">#ifdef STREAM_COMPAT</span>
  <span class="k">if</span><span class="p">(</span><span class="n">max_sdu_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">irttp_get_max_seg_size</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* STREAM_COMPAT */</span><span class="cp"></span>

  <span class="cm">/* At this point, IrLMP has assigned our source address */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">irttp_get_saddr</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>

  <span class="cm">/* Allow higher layer to access IrTTP */</span>
  <span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">);</span>
  <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>	<span class="cm">/* Not racy, IrDA traffic is serial */</span>
  <span class="cm">/* Give a kick in the ass of ppp_generic so that he sends us some data */</span>
  <span class="n">ppp_output_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

  <span class="cm">/* Check size of received packet */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#ifdef PASS_CONNECT_PACKETS</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;Passing connect packet to PPP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* Try to pass it to PPP */</span>
      <span class="n">irnet_data_indication</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* PASS_CONNECT_PACKETS */</span><span class="cp"></span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Dropping non empty packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>	<span class="cm">/* Note : will be optimised with other kfree... */</span>
<span class="cp">#endif </span><span class="cm">/* PASS_CONNECT_PACKETS */</span><span class="cp"></span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="cm">/* Notify the control channel */</span>
  <span class="n">irnet_post_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRNET_CONNECT_TO</span><span class="p">,</span>
		   <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_flow_indication (instance, sap, flow)</span>
<span class="cm"> *</span>
<span class="cm"> *    Used by TinyTP to tell us if it can accept more data or not</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_flow_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>	<span class="n">instance</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span>	<span class="n">sap</span><span class="p">,</span>
		      <span class="n">LOCAL_FLOW</span> <span class="n">flow</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="p">;</span>
  <span class="n">LOCAL_FLOW</span>		<span class="n">oldflow</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_flow</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p, flow=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>

  <span class="cm">/* Update our state */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">=</span> <span class="n">flow</span><span class="p">;</span>

  <span class="cm">/* Check what IrTTP want us to do... */</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">FLOW_START</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;IrTTP wants us to start again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* Check if we really need to wake up PPP */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">oldflow</span> <span class="o">==</span> <span class="n">FLOW_STOP</span><span class="p">)</span>
	<span class="n">ppp_output_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
      <span class="k">else</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;But we were already transmitting !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">FLOW_STOP</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;IrTTP wants us to slow down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;Unknown flow command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_status_indication (instance, sap, reason, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Link (IrLAP) status report.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_status_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>	<span class="n">instance</span><span class="p">,</span>
			<span class="n">LINK_STATUS</span> <span class="n">link</span><span class="p">,</span>
			<span class="n">LOCK_STATUS</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Self is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* We can only get this event if we are connected */</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">STATUS_NO_ACTIVITY</span>:
      <span class="n">irnet_post_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRNET_BLOCKED_LINK</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;Unknown status...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_connect_indication(instance, sap, qos, max_sdu_size, userdata)</span>
<span class="cm"> *</span>
<span class="cm"> *    Incoming connection</span>
<span class="cm"> *</span>
<span class="cm"> * In theory, this function is called only on the server socket.</span>
<span class="cm"> * Some other node is attempting to connect to the IrNET service, and has</span>
<span class="cm"> * sent a connection request on our server socket.</span>
<span class="cm"> * We just redirect the connection to the relevant IrNET socket.</span>
<span class="cm"> *</span>
<span class="cm"> * Note : we also make sure that between 2 irnet nodes, there can</span>
<span class="cm"> * exist only one irnet connection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_connect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span>		<span class="n">instance</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span>		<span class="n">sap</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span>
			 <span class="n">__u32</span>		<span class="n">max_sdu_size</span><span class="p">,</span>
			 <span class="n">__u8</span>		<span class="n">max_header_size</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">server</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(server=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_CB_ERROR</span><span class="p">,</span>
	  <span class="s">&quot;Invalid instance (0x%p) !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">sap</span> <span class="o">==</span> <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">tsap</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid sap !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Try to find the most appropriate IrNET socket */</span>
  <span class="n">new</span> <span class="o">=</span> <span class="n">irnet_find_socket</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

  <span class="cm">/* After all this hard work, do we have an socket ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;: No socket waiting for this connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">irnet_disconnect_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Is the socket already busy ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;: Socket already connected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">irnet_disconnect_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* The following code is a bit tricky, so need comments ;-)</span>
<span class="cm">   */</span>
  <span class="cm">/* If ttp_connect is set, the socket is trying to connect to the other</span>
<span class="cm">   * end and may have sent a IrTTP connection request and is waiting for</span>
<span class="cm">   * a connection response (that may never come).</span>
<span class="cm">   * Now, the pain is that the socket may have opened a tsap and is</span>
<span class="cm">   * waiting on it, while the other end is trying to connect to it on</span>
<span class="cm">   * another tsap.</span>
<span class="cm">   * Because IrNET can be peer to peer, we need to workaround this.</span>
<span class="cm">   * Furthermore, the way the irnetd script is implemented, the</span>
<span class="cm">   * target will create a second IrNET connection back to the</span>
<span class="cm">   * originator and expect the originator to bind this new connection</span>
<span class="cm">   * to the original PPPD instance.</span>
<span class="cm">   * And of course, if we don&#39;t use irnetd, we can have a race when</span>
<span class="cm">   * both side try to connect simultaneously, which could leave both</span>
<span class="cm">   * connections half closed (yuck).</span>
<span class="cm">   * Conclusions :</span>
<span class="cm">   *	1) The &quot;originator&quot; must accept the new connection and get rid</span>
<span class="cm">   *	   of the old one so that irnetd works</span>
<span class="cm">   *	2) One side must deny the new connection to avoid races,</span>
<span class="cm">   *	   but both side must agree on which side it is...</span>
<span class="cm">   * Most often, the originator is primary at the LAP layer.</span>
<span class="cm">   * Jean II</span>
<span class="cm">   */</span>
  <span class="cm">/* Now, let&#39;s look at the way I wrote the test...</span>
<span class="cm">   * We need to clear up the ttp_connect flag atomically to prevent</span>
<span class="cm">   * irnet_disconnect_indication() to mess up the tsap we are going to close.</span>
<span class="cm">   * We want to clear the ttp_connect flag only if we close the tsap,</span>
<span class="cm">   * otherwise we will never close it, so we need to check for primary</span>
<span class="cm">   * *before* doing the test on the flag.</span>
<span class="cm">   * And of course, ALLOW_SIMULT_CONNECT can disable this entirely...</span>
<span class="cm">   * Jean II</span>
<span class="cm">   */</span>

  <span class="cm">/* Socket already connecting ? On primary ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="mi">0</span>
<span class="cp">#ifdef ALLOW_SIMULT_CONNECT</span>
     <span class="o">||</span> <span class="p">((</span><span class="n">irttp_is_primary</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* primary */</span>
	 <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">)))</span>
<span class="cp">#endif </span><span class="cm">/* ALLOW_SIMULT_CONNECT */</span><span class="cp"></span>
     <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Socket already connecting, but going to reuse it !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="cm">/* Cleanup the old TSAP if necessary - IrIAP will be cleaned up later */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* Close the old connection the new socket was attempting,</span>
<span class="cm">	   * so that we can hook it up to the new connection.</span>
<span class="cm">	   * It&#39;s now safe to do it... */</span>
	  <span class="n">irttp_close_tsap</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">);</span>
	  <span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* Three options :</span>
<span class="cm">       * 1) socket was not connecting or connected : ttp_connect should be 0.</span>
<span class="cm">       * 2) we don&#39;t want to connect the socket because we are secondary or</span>
<span class="cm">       * ALLOW_SIMULT_CONNECT is undefined. ttp_connect should be 1.</span>
<span class="cm">       * 3) we are half way in irnet_disconnect_indication(), and it&#39;s a</span>
<span class="cm">       * nice race condition... Fortunately, we can detect that by checking</span>
<span class="cm">       * if tsap is still alive. On the other hand, we can&#39;t be in</span>
<span class="cm">       * irda_irnet_destroy() otherwise we would not have found this</span>
<span class="cm">       * socket in the hashbin.</span>
<span class="cm">       * Jean II */</span>
      <span class="k">if</span><span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="cm">/* Don&#39;t mess this socket, somebody else in in charge... */</span>
	  <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Race condition detected, socket in use, abort connect...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="n">irnet_disconnect_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="cm">/* So : at this point, we have a socket, and it is idle. Good ! */</span>
  <span class="n">irnet_connect_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="n">max_sdu_size</span><span class="p">,</span> <span class="n">max_header_size</span><span class="p">);</span>

  <span class="cm">/* Check size of received packet */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#ifdef PASS_CONNECT_PACKETS</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_CB_INFO</span><span class="p">,</span> <span class="s">&quot;Passing connect packet to PPP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* Try to pass it to PPP */</span>
      <span class="n">irnet_data_indication</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* PASS_CONNECT_PACKETS */</span><span class="cp"></span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_CB_ERROR</span><span class="p">,</span> <span class="s">&quot;Dropping non empty packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>	<span class="cm">/* Note : will be optimised with other kfree... */</span>
<span class="cp">#endif </span><span class="cm">/* PASS_CONNECT_PACKETS */</span><span class="cp"></span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_TCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/********************** IRDA-IAS/LMP CALLBACKS **********************/</span>
<span class="cm">/*</span>
<span class="cm"> * These are the callbacks called by other layers of the IrDA stack,</span>
<span class="cm"> * mainly LMP for discovery and IAS for name queries.</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_getvalue_confirm (result, obj_id, value, priv)</span>
<span class="cm"> *</span>
<span class="cm"> *    Got answer from remote LM-IAS, just connect</span>
<span class="cm"> *</span>
<span class="cm"> * This is the reply to a IAS query we were doing to find the TSAP of</span>
<span class="cm"> * the device we want to connect to.</span>
<span class="cm"> * If we have found a valid TSAP, just initiate the TTP connection</span>
<span class="cm"> * on this TSAP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_getvalue_confirm</span><span class="p">(</span><span class="kt">int</span>	<span class="n">result</span><span class="p">,</span>
		       <span class="n">__u16</span>	<span class="n">obj_id</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ias_value</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span>	<span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;Self is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Check if already connected (via irnet_connect_socket())</span>
<span class="cm">   * or socket is closing down (via irda_irnet_destroy()) */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;Socket no longer connecting. Ouch !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* We probably don&#39;t need to make any more queries */</span>
  <span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* Post process the IAS reply */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span> <span class="o">=</span> <span class="n">irnet_ias_to_tsap</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

  <span class="cm">/* If error, just go out */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;IAS connect failed ! (0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_OCB_INFO</span><span class="p">,</span> <span class="s">&quot;daddr = %08x, lsap = %d, starting IrTTP connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span><span class="p">);</span>

  <span class="cm">/* Start up TTP - non blocking */</span>
  <span class="n">irnet_connect_tsap</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_discovervalue_confirm (result, obj_id, value, priv)</span>
<span class="cm"> *</span>
<span class="cm"> *    Handle the TSAP discovery procedure state machine.</span>
<span class="cm"> *    Got answer from remote LM-IAS, try next device</span>
<span class="cm"> *</span>
<span class="cm"> * We are doing a  TSAP discovery procedure, and we got an answer to</span>
<span class="cm"> * a IAS query we were doing to find the TSAP on one of the address</span>
<span class="cm"> * in the discovery log.</span>
<span class="cm"> *</span>
<span class="cm"> * If we have found a valid TSAP for the first time, save it. If it&#39;s</span>
<span class="cm"> * not the first time we found one, complain.</span>
<span class="cm"> *</span>
<span class="cm"> * If we have more addresses in the log, just initiate a new query.</span>
<span class="cm"> * Note that those query may fail (see irnet_discover_daddr_and_lsap_sel())</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise, wrap up the procedure (cleanup), check if we have found</span>
<span class="cm"> * any device and connect to it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_discovervalue_confirm</span><span class="p">(</span><span class="kt">int</span>		<span class="n">result</span><span class="p">,</span>
			    <span class="n">__u16</span>	<span class="n">obj_id</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ias_value</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span>	<span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
  <span class="n">__u8</span>			<span class="n">dtsap_sel</span><span class="p">;</span>		<span class="cm">/* TSAP we are looking for */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;Self is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Check if already connected (via irnet_connect_socket())</span>
<span class="cm">   * or socket is closing down (via irda_irnet_destroy()) */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;Socket no longer connecting. Ouch !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Post process the IAS reply */</span>
  <span class="n">dtsap_sel</span> <span class="o">=</span> <span class="n">irnet_ias_to_tsap</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

  <span class="cm">/* Have we got something ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* We found the requested service */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">!=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DERROR</span><span class="p">(</span><span class="n">IRDA_OCB_ERROR</span><span class="p">,</span> <span class="s">&quot;More than one device in range supports IrNET...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="cm">/* First time we found that one, save it ! */</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">;</span>
	  <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span> <span class="o">=</span> <span class="n">dtsap_sel</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="cm">/* If no failure */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">==</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

      <span class="cm">/* Search the next node */</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">irnet_discover_next_daddr</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* In this case, the above request was non-blocking.</span>
<span class="cm">	   * We will return here after a while... */</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="cm">/* In this case, we have processed the last discovery item */</span>
    <span class="p">}</span>

  <span class="cm">/* No more queries to be done (failure or last one) */</span>

  <span class="cm">/* We probably don&#39;t need to make any more queries */</span>
  <span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* No more items : remove the log and signal termination */</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_OCB_INFO</span><span class="p">,</span> <span class="s">&quot;Cleaning up log (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Cleanup our copy of the discovery log */</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* Check out what we found */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">==</span> <span class="n">DEV_ADDR_ANY</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>
      <span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>
      <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;: cannot discover IrNET in any device !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* We have a valid address - just connect */</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_OCB_INFO</span><span class="p">,</span> <span class="s">&quot;daddr = %08x, lsap = %d, starting IrTTP connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span><span class="p">);</span>

  <span class="cm">/* Start up TTP - non blocking */</span>
  <span class="n">irnet_connect_tsap</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DISCOVERY_EVENTS</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_discovery_indication (discovery)</span>
<span class="cm"> *</span>
<span class="cm"> *    Got a discovery indication from IrLMP, post an event</span>
<span class="cm"> *</span>
<span class="cm"> * Note : IrLMP take care of matching the hint mask for us, and also</span>
<span class="cm"> * check if it is a &quot;new&quot; node for us...</span>
<span class="cm"> *</span>
<span class="cm"> * As IrLMP filter on the IrLAN hint bit, we get both IrLAN and IrNET</span>
<span class="cm"> * nodes, so it&#39;s only at connection time that we will know if the</span>
<span class="cm"> * node support IrNET, IrLAN or both. The other solution is to check</span>
<span class="cm"> * in IAS the PNP ids and service name.</span>
<span class="cm"> * Note : even if a node support IrNET (or IrLAN), it&#39;s no guarantee</span>
<span class="cm"> * that we will be able to connect to it, the node might already be</span>
<span class="cm"> * busy...</span>
<span class="cm"> *</span>
<span class="cm"> * One last thing : in some case, this function will trigger duplicate</span>
<span class="cm"> * discovery events. On the other hand, we should catch all</span>
<span class="cm"> * discoveries properly (i.e. not miss one). Filtering duplicate here</span>
<span class="cm"> * is to messy, so we leave that to user space...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_discovery_indication</span><span class="p">(</span><span class="n">discinfo_t</span> <span class="o">*</span>		<span class="n">discovery</span><span class="p">,</span>
			   <span class="n">DISCOVERY_MODE</span>	<span class="n">mode</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span>		<span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_OCB_ERROR</span><span class="p">,</span>
	  <span class="s">&quot;Invalid instance (0x%p) !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_OCB_INFO</span><span class="p">,</span> <span class="s">&quot;Discovered new IrNET/IrLAN node %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">discovery</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>

  <span class="cm">/* Notify the control channel */</span>
  <span class="n">irnet_post_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IRNET_DISCOVER</span><span class="p">,</span>
		   <span class="n">discovery</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">discovery</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">discovery</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		   <span class="n">get_unaligned</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">discovery</span><span class="o">-&gt;</span><span class="n">hints</span><span class="p">));</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_expiry_indication (expiry)</span>
<span class="cm"> *</span>
<span class="cm"> *    Got a expiry indication from IrLMP, post an event</span>
<span class="cm"> *</span>
<span class="cm"> * Note : IrLMP take care of matching the hint mask for us, we only</span>
<span class="cm"> * check if it is a &quot;new&quot; node...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_expiry_indication</span><span class="p">(</span><span class="n">discinfo_t</span> <span class="o">*</span>	<span class="n">expiry</span><span class="p">,</span>
			<span class="n">DISCOVERY_MODE</span>	<span class="n">mode</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span>		<span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;(self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">,</span> <span class="p">,</span> <span class="n">IRDA_OCB_ERROR</span><span class="p">,</span>
	  <span class="s">&quot;Invalid instance (0x%p) !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">IRDA_OCB_INFO</span><span class="p">,</span> <span class="s">&quot;IrNET/IrLAN node %s expired...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">expiry</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>

  <span class="cm">/* Notify the control channel */</span>
  <span class="n">irnet_post_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IRNET_EXPIRE</span><span class="p">,</span>
		   <span class="n">expiry</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">expiry</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">expiry</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		   <span class="n">get_unaligned</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">expiry</span><span class="o">-&gt;</span><span class="n">hints</span><span class="p">));</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">IRDA_OCB_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DISCOVERY_EVENTS */</span><span class="cp"></span>


<span class="cm">/*********************** PROC ENTRY CALLBACKS ***********************/</span>
<span class="cm">/*</span>
<span class="cm"> * We create a instance in the /proc filesystem, and here we take care</span>
<span class="cm"> * of that...</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">irnet_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span>		<span class="n">state</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Get the IrNET server information... */</span>
  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;IrNET server - &quot;</span><span class="p">);</span>
  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;IrDA state: %s, &quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span> <span class="o">?</span> <span class="s">&quot;running&quot;</span> <span class="o">:</span> <span class="s">&quot;dead&quot;</span><span class="p">));</span>
  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;stsap_sel: %02x, &quot;</span><span class="p">,</span> <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">stsap_sel</span><span class="p">);</span>
  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;dtsap_sel: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irnet_server</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dtsap_sel</span><span class="p">);</span>

  <span class="cm">/* Do we need to continue ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Protect access to the instance list */</span>
  <span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="cm">/* Get the sockets one by one... */</span>
  <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Start printing info about the socket. */</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IrNET socket %d - &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>

      <span class="cm">/* First, get the requested configuration */</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Requested IrDA name: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, &quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;daddr: %08x, &quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rdaddr</span><span class="p">);</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;saddr: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rsaddr</span><span class="p">);</span>

      <span class="cm">/* Second, get all the PPP info */</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;	PPP state: %s&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">?</span> <span class="s">&quot;registered&quot;</span> <span class="o">:</span> <span class="s">&quot;unregistered&quot;</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, unit: ppp%d&quot;</span><span class="p">,</span>
			 <span class="n">ppp_unit_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">));</span>
	  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, channel: %d&quot;</span><span class="p">,</span>
			 <span class="n">ppp_channel_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">));</span>
	  <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, mru: %d&quot;</span><span class="p">,</span>
			 <span class="n">self</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">);</span>
	  <span class="cm">/* Maybe add self-&gt;flags ? Later... */</span>
	<span class="p">}</span>

      <span class="cm">/* Then, get all the IrDA specific info... */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">)</span>
	<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;connected&quot;</span><span class="p">;</span>
      <span class="k">else</span>
	<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;connecting&quot;</span><span class="p">;</span>
	<span class="k">else</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">iriap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;searching&quot;</span><span class="p">;</span>
	  <span class="k">else</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">)</span>
	      <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;weird&quot;</span><span class="p">;</span>
	    <span class="k">else</span>
	      <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;idle&quot;</span><span class="p">;</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">	IrDA state: %s, &quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;daddr: %08x, &quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;stsap_sel: %02x, &quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">stsap_sel</span><span class="p">);</span>
      <span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;dtsap_sel: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">dtsap_sel</span><span class="p">);</span>

      <span class="cm">/* Next socket, please... */</span>
      <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* Spin lock end */</span>
  <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irnet_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">irnet_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">irnet_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">irnet_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* PROC_FS */</span><span class="cp"></span>


<span class="cm">/********************** CONFIGURATION/CLEANUP **********************/</span>
<span class="cm">/*</span>
<span class="cm"> * Initialisation and teardown of the IrDA part, called at module</span>
<span class="cm"> * insertion and removal...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Prepare the IrNET layer for operation...</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span>
<span class="nf">irda_irnet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Pure paranoia - should be redundant */</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irnet_root</span><span class="p">));</span>

  <span class="cm">/* Setup start of irnet instance list */</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">hashbin_new</span><span class="p">(</span><span class="n">HB_NOLOCK</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
	 <span class="n">MODULE_ERROR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate hashbin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="cm">/* Init spinlock for instance list */</span>
  <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="cm">/* Initialise control channel */</span>
  <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">rwait</span><span class="p">);</span>
  <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="cm">/* Init spinlock for event logging */</span>
  <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">spinlock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
  <span class="cm">/* Add a /proc file for irnet infos */</span>
  <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;irnet&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">proc_irda</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irnet_proc_fops</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

  <span class="cm">/* Setup the IrNET server */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irnet_setup_server</span><span class="p">();</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
    <span class="cm">/* We are no longer functional... */</span>
    <span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Cleanup at exit...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">irda_irnet_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* We are no longer there... */</span>
  <span class="n">irnet_server</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
  <span class="cm">/* Remove our /proc file */</span>
  <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;irnet&quot;</span><span class="p">,</span> <span class="n">proc_irda</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

  <span class="cm">/* Remove our IrNET server from existence */</span>
  <span class="n">irnet_destroy_server</span><span class="p">();</span>

  <span class="cm">/* Remove all instances of IrNET socket still present */</span>
  <span class="n">hashbin_delete</span><span class="p">(</span><span class="n">irnet_server</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="p">(</span><span class="n">FREE_FUNC</span><span class="p">)</span> <span class="n">irda_irnet_destroy</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
