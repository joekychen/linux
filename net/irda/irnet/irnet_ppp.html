<!DOCTYPE html>
<html><head><title>joekychen/linux » net › irda › irnet › irnet_ppp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>irnet_ppp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	IrNET protocol module : Synchronous PPP over an IrDA socket.</span>
<span class="cm"> *</span>
<span class="cm"> *		Jean II - HPL `00 - &lt;jt@hpl.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file implement the PPP interface and /dev/irnet character device.</span>
<span class="cm"> * The PPP interface hook to the ppp_generic module, handle all our</span>
<span class="cm"> *	relationship to the PPP code in the kernel (and by extension to pppd),</span>
<span class="cm"> *	and exchange PPP frames with this module (send/receive).</span>
<span class="cm"> * The /dev/irnet device is used primarily for 2 functions :</span>
<span class="cm"> *	1) as a stub for pppd (the ppp daemon), so that we can appropriately</span>
<span class="cm"> *	generate PPP sessions (we pretend we are a tty).</span>
<span class="cm"> *	2) as a control channel (write commands, read events)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;irnet_ppp.h&quot;		</span><span class="cm">/* Private header */</span><span class="cp"></span>
<span class="cm">/* Please put other headers in irnet.h - Thanks */</span>

<span class="cm">/* Generic PPP callbacks (to call us) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ppp_channel_ops</span> <span class="n">irnet_ppp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start_xmit</span> <span class="o">=</span> <span class="n">ppp_irnet_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ppp_irnet_ioctl</span>
<span class="p">};</span>

<span class="cm">/************************* CONTROL CHANNEL *************************/</span>
<span class="cm">/*</span>
<span class="cm"> * When a pppd instance is not active on /dev/irnet, it acts as a control</span>
<span class="cm"> * channel.</span>
<span class="cm"> * Writing allow to set up the IrDA destination of the IrNET channel,</span>
<span class="cm"> * and any application may be read events happening in IrNET...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Write is used to send a command to configure a IrNET channel</span>
<span class="cm"> * before it is open by pppd. The syntax is : &quot;command argument&quot;</span>
<span class="cm"> * Currently there is only two defined commands :</span>
<span class="cm"> *	o name : set the requested IrDA nickname of the IrNET peer.</span>
<span class="cm"> *	o addr : set the requested IrDA address of the IrNET peer.</span>
<span class="cm"> * Note : the code is crude, but effective...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span>
<span class="nf">irnet_ctrl_write</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		 <span class="kt">size_t</span>		<span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span>		<span class="n">command</span><span class="p">[</span><span class="n">IRNET_MAX_COMMAND</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span>	<span class="n">start</span><span class="p">;</span>		<span class="cm">/* Current command being processed */</span>
  <span class="kt">char</span> <span class="o">*</span>	<span class="n">next</span><span class="p">;</span>		<span class="cm">/* Next command to process */</span>
  <span class="kt">int</span>		<span class="n">length</span><span class="p">;</span>		<span class="cm">/* Length of current command */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p, count=%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

  <span class="cm">/* Check for overflow... */</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">IRNET_MAX_COMMAND</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span>
	 <span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Too much data !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Get the data in the driver */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid user space pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Safe terminate the string */</span>
  <span class="n">command</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Command line received is ``%s&#39;&#39; (%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">command</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

  <span class="cm">/* Check every commands in the command line */</span>
  <span class="n">next</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Look at the next command */</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Scrap whitespaces before the command */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>

      <span class="cm">/* &#39;,&#39; is our command separator */</span>
      <span class="n">next</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>			<span class="cm">/* Terminate command */</span>
	  <span class="n">length</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>	<span class="cm">/* Length */</span>
	  <span class="n">next</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* Skip the &#39;\0&#39; */</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>

      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Found command ``%s&#39;&#39; (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

      <span class="cm">/* Check if we recognised one of the known command</span>
<span class="cm">       * We can&#39;t use &quot;switch&quot; with strings, so hack with &quot;continue&quot; */</span>

      <span class="cm">/* First command : name -&gt; Requested IrDA nickname */</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="cm">/* Copy the name only if is included and not &quot;any&quot; */</span>
	  <span class="k">if</span><span class="p">((</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;any&quot;</span><span class="p">)))</span>
	    <span class="p">{</span>
	      <span class="cm">/* Strip out trailing whitespaces */</span>
	      <span class="k">while</span><span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
		<span class="n">length</span><span class="o">--</span><span class="p">;</span>

	      <span class="n">DABORT</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">NICKNAME_MAX_LEN</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
		     <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid nickname.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	      <span class="cm">/* Copy the name for later reuse */</span>
	      <span class="n">memcpy</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Got rname = ``%s&#39;&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rname</span><span class="p">);</span>

	  <span class="cm">/* Restart the loop */</span>
	  <span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="cm">/* Second command : addr, daddr -&gt; Requested IrDA destination address</span>
<span class="cm">       * Also process : saddr -&gt; Requested IrDA source address */</span>
      <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;addr&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">||</span>
	 <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;daddr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">||</span>
	 <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;saddr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
	<span class="p">{</span>
	  <span class="n">__u32</span>		<span class="n">addr</span> <span class="o">=</span> <span class="n">DEV_ADDR_ANY</span><span class="p">;</span>

	  <span class="cm">/* Copy the address only if is included and not &quot;any&quot; */</span>
	  <span class="k">if</span><span class="p">((</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;any&quot;</span><span class="p">)))</span>
	    <span class="p">{</span>
	      <span class="kt">char</span> <span class="o">*</span>	<span class="n">begp</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	      <span class="kt">char</span> <span class="o">*</span>	<span class="n">endp</span><span class="p">;</span>

	      <span class="cm">/* Scrap whitespaces before the command */</span>
	      <span class="n">begp</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">begp</span><span class="p">);</span>

	      <span class="cm">/* Convert argument to a number (last arg is the base) */</span>
	      <span class="n">addr</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">begp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	      <span class="cm">/* Has it worked  ? (endp should be start + length) */</span>
	      <span class="n">DABORT</span><span class="p">(</span><span class="n">endp</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span>
		     <span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="cm">/* Which type of address ? */</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* Save it */</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rsaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Got rsaddr = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rsaddr</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="p">{</span>
	      <span class="cm">/* Save it */</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rdaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Got rdaddr = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rdaddr</span><span class="p">);</span>
	    <span class="p">}</span>

	  <span class="cm">/* Restart the loop */</span>
	  <span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="cm">/* Other possible command : connect N (number of retries) */</span>

      <span class="cm">/* No command matched -&gt; Failed... */</span>
      <span class="n">DABORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Not a recognised IrNET command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* Success : we have parsed all commands successfully */</span>
  <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef INITIAL_DISCOVERY</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_get_discovery_log (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Query the content on the discovery log if not done</span>
<span class="cm"> *</span>
<span class="cm"> * This function query the current content of the discovery log</span>
<span class="cm"> * at the startup of the event channel and save it in the internal struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">irnet_get_discovery_log</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u16</span>		<span class="n">mask</span> <span class="o">=</span> <span class="n">irlmp_service_to_hint</span><span class="p">(</span><span class="n">S_LAN</span><span class="p">);</span>

  <span class="cm">/* Ask IrLMP for the current discovery log */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="n">irlmp_get_discoveries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
					  <span class="n">DISCOVERY_DEFAULT_SLOTS</span><span class="p">);</span>

  <span class="cm">/* Check if the we got some results */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Got the log (0x%p), size is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Function irnet_read_discovery_log (self, event)</span>
<span class="cm"> *</span>
<span class="cm"> *    Read the content on the discovery log</span>
<span class="cm"> *</span>
<span class="cm"> * This function dump the current content of the discovery log</span>
<span class="cm"> * at the startup of the event channel.</span>
<span class="cm"> * Return 1 if wrote an event on the control channel...</span>
<span class="cm"> *</span>
<span class="cm"> * State of the ap-&gt;disco_XXX variables :</span>
<span class="cm"> * Socket creation :  discoveries = NULL ; disco_index = 0 ; disco_number = 0</span>
<span class="cm"> * While reading :    discoveries = ptr  ; disco_index = X ; disco_number = Y</span>
<span class="cm"> * After reading :    discoveries = NULL ; disco_index = Y ; disco_number = -1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">irnet_read_discovery_log</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span>		<span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>		<span class="n">done_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p, event=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">ap</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

  <span class="cm">/* Test if we have some work to do or we have already finished */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Already done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Test if it&#39;s the first time and therefore we need to get the log */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">irnet_get_discovery_log</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

  <span class="cm">/* Check if we have more item to dump */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span> <span class="o">&lt;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Write an event */</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Found %08x (%s) behind %08x {hints %02X-%02X}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">info</span><span class="p">,</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">saddr</span><span class="p">,</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">hints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">hints</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Writing discovery %d : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>

      <span class="cm">/* We have an event */</span>
      <span class="n">done_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="cm">/* Next discovery */</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Check if we have done the last item */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_index</span> <span class="o">&gt;=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* No more items : remove the log and signal termination */</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Cleaning up log (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* Cleanup our copy of the discovery log */</span>
	  <span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span><span class="p">);</span>
	  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">done_event</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* INITIAL_DISCOVERY */</span><span class="cp"></span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Read is used to get IrNET events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span>
<span class="nf">irnet_ctrl_read</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span>	<span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span>		<span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
  <span class="kt">char</span>		<span class="n">event</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>	<span class="cm">/* Max event is 61 char */</span>
  <span class="kt">ssize_t</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p, count=%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

  <span class="cm">/* Check if we can write an event out in one go */</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">,</span> <span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Buffer to small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef INITIAL_DISCOVERY</span>
  <span class="cm">/* Check if we have read the log */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">irnet_read_discovery_log</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* We have an event !!! Copy it to the user */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="p">)))</span>
	<span class="p">{</span>
	  <span class="n">DERROR</span><span class="p">(</span><span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid user space pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="n">DEXIT</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* INITIAL_DISCOVERY */</span><span class="cp"></span>

  <span class="cm">/* Put ourselves on the wait queue to be woken up */</span>
  <span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">rwait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
  <span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
      <span class="cm">/* If there is unread events */</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">!=</span> <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="cm">/* Yield and wait to be woken up */</span>
      <span class="n">schedule</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_RUNNING</span><span class="p">;</span>
  <span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">rwait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

  <span class="cm">/* Did we got it ? */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* No, return the error code */</span>
      <span class="n">DEXIT</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot; - ret %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Which event is it ? */</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">event</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">IRNET_DISCOVER</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Discovered %08x (%s) behind %08x {hints %02X-%02X}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">saddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">hints</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">hints</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_EXPIRE</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Expired %08x (%s) behind %08x {hints %02X-%02X}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">saddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">hints</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">hints</span><span class="p">.</span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_CONNECT_TO</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Connected to %08x (%s) on ppp%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">unit</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_CONNECT_FROM</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Connection from %08x (%s) on ppp%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">unit</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_REQUEST_FROM</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Request from %08x (%s) behind %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">saddr</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_NOANSWER_FROM</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;No-answer from %08x (%s) on ppp%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">unit</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_BLOCKED_LINK</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Blocked link with %08x (%s) on ppp%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">unit</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_DISCONNECT_FROM</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Disconnection from %08x (%s) on ppp%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">unit</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IRNET_DISCONNECT_TO</span>:
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Disconnected to %08x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">daddr</span><span class="p">,</span>
	      <span class="n">irnet_events</span><span class="p">.</span><span class="n">log</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;Bug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="cm">/* Increment our event index */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">IRNET_MAX_EVENTS</span><span class="p">;</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">CTRL_INFO</span><span class="p">,</span> <span class="s">&quot;Event is :%s&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

  <span class="cm">/* Copy it to the user */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">CTRL_ERROR</span><span class="p">,</span> <span class="s">&quot;Invalid user space pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Poll : called when someone do a select on /dev/irnet.</span>
<span class="cm"> * Just check if there are new events...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">irnet_ctrl_poll</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
		<span class="n">poll_table</span> <span class="o">*</span>	<span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

  <span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irnet_events</span><span class="p">.</span><span class="n">rwait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
  <span class="cm">/* If there is unread events */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">!=</span> <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
<span class="cp">#ifdef INITIAL_DISCOVERY</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Test if it&#39;s the first time and therefore we need to get the log */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">discoveries</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">irnet_get_discovery_log</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
      <span class="cm">/* Recheck */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">disco_number</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* INITIAL_DISCOVERY */</span><span class="cp"></span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">CTRL_TRACE</span><span class="p">,</span> <span class="s">&quot; - mask=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*********************** FILESYSTEM CALLBACKS ***********************/</span>
<span class="cm">/*</span>
<span class="cm"> * Implement the usual open, read, write functions that will be called</span>
<span class="cm"> * by the file system when some action is performed on /dev/irnet.</span>
<span class="cm"> * Most of those actions will in fact be performed by &quot;pppd&quot; or</span>
<span class="cm"> * the control channel, we just act as a redirector...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Open : when somebody open /dev/irnet</span>
<span class="cm"> * We basically create a new instance of irnet and initialise it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dev_irnet_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>	<span class="n">inode</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

<span class="cp">#ifdef SECURE_DEVIRNET</span>
  <span class="cm">/* This could (should?) be enforced by the permissions on /dev/irnet. */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* SECURE_DEVIRNET */</span><span class="cp"></span>

  <span class="cm">/* Allocate a private structure for this IrNET instance */</span>
  <span class="n">ap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate struct irnet...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* initialize the irnet structure */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

  <span class="cm">/* PPP channel setup */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irnet_ppp_ops</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2048</span> <span class="o">-</span> <span class="n">TTP_MAX_HEADER</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">PPP_HDRLEN</span><span class="p">);</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">TTP_MAX_HEADER</span><span class="p">;</span>		<span class="cm">/* for A/C + Max IrDA hdr */</span>
  <span class="cm">/* PPP parameters */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2048</span> <span class="o">-</span> <span class="n">TTP_MAX_HEADER</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">PPP_HDRLEN</span><span class="p">);</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60000000U</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">raccm</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>

  <span class="cm">/* Setup the IrDA part... */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irda_irnet_create</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t setup IrDA link...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

      <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* For the control channel */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">=</span> <span class="n">irnet_events</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>	<span class="cm">/* Cancel all past events */</span>

  <span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

  <span class="cm">/* Put our stuff where we will be able to find it later */</span>
  <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot; - ap=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Close : when somebody close /dev/irnet</span>
<span class="cm"> * Destroy the instance of /dev/irnet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dev_irnet_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>	<span class="n">inode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p, ap=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">file</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Detach ourselves */</span>
  <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* Close IrDA stuff */</span>
  <span class="n">irda_irnet_destroy</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

  <span class="cm">/* Disconnect from the generic PPP layer if not already done */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Channel still registered - deregistering !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">ppp_unregister_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Write does nothing.</span>
<span class="cm"> * (we receive packet from ppp_generic through ppp_irnet_send())</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dev_irnet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span>		<span class="n">count</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="o">*</span>	<span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

  <span class="n">DPASS</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p, ap=0x%p, count=%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">file</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">,</span> <span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* If we are connected to ppp_generic, let it handle the job */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">irnet_ctrl_write</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Read doesn&#39;t do much either.</span>
<span class="cm"> * (pppd poll us, but ultimately reads through /dev/ppp)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dev_irnet_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
	       <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span>	<span class="n">buf</span><span class="p">,</span>
	       <span class="kt">size_t</span>		<span class="n">count</span><span class="p">,</span>
	       <span class="n">loff_t</span> <span class="o">*</span>		<span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

  <span class="n">DPASS</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p, ap=0x%p, count=%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">file</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">,</span> <span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* If we are connected to ppp_generic, let it handle the job */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">irnet_ctrl_read</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Poll : called when someone do a select on /dev/irnet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">dev_irnet_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
	       <span class="n">poll_table</span> <span class="o">*</span>	<span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mask</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p, ap=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">file</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

  <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* If we are connected to ppp_generic, let it handle the job */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">|=</span> <span class="n">irnet_ctrl_poll</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot; - mask=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * IOCtl : Called when someone does some ioctls on /dev/irnet</span>
<span class="cm"> * This is the way pppd configure us and control us while the PPP</span>
<span class="cm"> * instance is active.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span>
<span class="nf">dev_irnet_ioctl</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span>	<span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cmd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">val</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot;(file=0x%p, ap=0x%p, cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">file</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="cm">/* Basic checks... */</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">,</span> <span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SECURE_DEVIRNET</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* SECURE_DEVIRNET */</span><span class="cp"></span>

  <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Set discipline (should be N_SYNC_PPP or N_TTY) */</span>
    <span class="k">case</span> <span class="n">TIOCSETD</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="k">if</span><span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">N_SYNC_PPP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">N_PPP</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Entering PPP discipline.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="cm">/* PPP channel setup (ap-&gt;chan in configured in dev_irnet_open())*/</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	  <span class="n">err</span> <span class="o">=</span> <span class="n">ppp_register_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* Our ppp side is active */</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Trying to establish a connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="cm">/* Setup the IrDA link now - may fail... */</span>
	      <span class="n">irda_irnet_connect</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="n">DERROR</span><span class="p">(</span><span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t setup PPP channel...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

          <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="cm">/* In theory, should be N_TTY */</span>
	  <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Exiting PPP discipline.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="cm">/* Disconnect from the generic PPP layer */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	  <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">ppp_unregister_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="n">DERROR</span><span class="p">(</span><span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Channel not registered !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Query PPP channel and unit number */</span>
    <span class="k">case</span> <span class="n">PPPIOCGCHAN</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">put_user</span><span class="p">(</span><span class="n">ppp_channel_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
						<span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCGUNIT</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ppp_open</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">put_user</span><span class="p">(</span><span class="n">ppp_unit_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
						<span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* All these ioctls can be passed both directly and from ppp_generic,</span>
<span class="cm">       * so we just deal with them in one place...</span>
<span class="cm">       */</span>
    <span class="k">case</span> <span class="n">PPPIOCGFLAGS</span>:
    <span class="k">case</span> <span class="n">PPPIOCSFLAGS</span>:
    <span class="k">case</span> <span class="n">PPPIOCGASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCSASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCGRASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCSRASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCGXASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCSXASYNCMAP</span>:
    <span class="k">case</span> <span class="n">PPPIOCGMRU</span>:
    <span class="k">case</span> <span class="n">PPPIOCSMRU</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Standard PPP ioctl.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ppp_irnet_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* TTY IOCTLs : Pretend that we are a tty, to keep pppd happy */</span>
      <span class="cm">/* Get termios */</span>
    <span class="k">case</span> <span class="n">TCGETS</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Get termios.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

<span class="cp">#ifndef TCGETS2</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">kernel_termios_to_user_termios</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
      <span class="k">if</span><span class="p">(</span><span class="n">kernel_termios_to_user_termios_1</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
      <span class="cm">/* Set termios */</span>
    <span class="k">case</span> <span class="n">TCSETSF</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;Set termios.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

<span class="cp">#ifndef TCGETS2</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">user_termios_to_kernel_termios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">user_termios_to_kernel_termios_1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Set DTR/RTS */</span>
    <span class="k">case</span> <span class="n">TIOCMBIS</span>:
    <span class="k">case</span> <span class="n">TIOCMBIC</span>:
      <span class="cm">/* Set exclusive/non-exclusive mode */</span>
    <span class="k">case</span> <span class="n">TIOCEXCL</span>:
    <span class="k">case</span> <span class="n">TIOCNXCL</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;TTY compatibility.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TCGETA</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;TCGETA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TCFLSH</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;TCFLSH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* Note : this will flush buffers in PPP, so it *must* be done</span>
<span class="cm">       * We should also worry that we don&#39;t accept junk here and that</span>
<span class="cm">       * we get rid of our own buffers */</span>
<span class="cp">#ifdef FLUSH_TO_PPP</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
      <span class="n">ppp_output_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* FLUSH_TO_PPP */</span><span class="cp"></span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">FIONREAD</span>:
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">FS_INFO</span><span class="p">,</span> <span class="s">&quot;FIONREAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">FS_ERROR</span><span class="p">,</span> <span class="s">&quot;Unsupported ioctl (0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">FS_TRACE</span><span class="p">,</span> <span class="s">&quot; - err = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************** PPP CALLBACKS **************************/</span>
<span class="cm">/*</span>
<span class="cm"> * This are the functions that the generic PPP driver in the kernel</span>
<span class="cm"> * will call to communicate to us.</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Prepare the ppp frame for transmission over the IrDA socket.</span>
<span class="cm"> * We make sure that the header space is enough, and we change ppp header</span>
<span class="cm"> * according to flags passed by pppd.</span>
<span class="cm"> * This is not a callback, but just a helper function used in ppp_irnet_send()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">irnet_prepare_skb</span><span class="p">(</span><span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>	<span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>	<span class="n">data</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">proto</span><span class="p">;</span>		<span class="cm">/* PPP protocol */</span>
  <span class="kt">int</span>			<span class="n">islcp</span><span class="p">;</span>		<span class="cm">/* Protocol == LCP */</span>
  <span class="kt">int</span>			<span class="n">needaddr</span><span class="p">;</span>	<span class="cm">/* Need PPP address */</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot;(ap=0x%p, skb=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

  <span class="cm">/* Extract PPP protocol from the frame */</span>
  <span class="n">data</span>  <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="n">proto</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="cm">/* LCP packets with codes between 1 (configure-request)</span>
<span class="cm">   * and 7 (code-reject) must be sent as though no options</span>
<span class="cm">   * have been negotiated. */</span>
  <span class="n">islcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_LCP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">);</span>

  <span class="cm">/* compress protocol field if option enabled */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SC_COMP_PROT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">islcp</span><span class="p">))</span>
    <span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

  <span class="cm">/* Check if we need address/control fields */</span>
  <span class="n">needaddr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SC_COMP_AC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">islcp</span><span class="p">);</span>

  <span class="cm">/* Is the skb headroom large enough to contain all IrDA-headers? */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">+</span> <span class="n">needaddr</span><span class="p">))</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>	<span class="n">new_skb</span><span class="p">;</span>

      <span class="n">DEBUG</span><span class="p">(</span><span class="n">PPP_INFO</span><span class="p">,</span> <span class="s">&quot;Reallocating skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="cm">/* Create a new skb */</span>
      <span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">+</span> <span class="n">needaddr</span><span class="p">);</span>

      <span class="cm">/* We have to free the original skb anyway */</span>
      <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

      <span class="cm">/* Did the realloc succeed ? */</span>
      <span class="n">DABORT</span><span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;Could not realloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="cm">/* Use the new skb instead */</span>
      <span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* prepend address/control fields if necessary */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">needaddr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PPP_ALLSTATIONS</span><span class="p">;</span>
      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PPP_UI</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Send a packet to the peer over the IrTTP connection.</span>
<span class="cm"> * Returns 1 iff the packet was accepted.</span>
<span class="cm"> * Returns 0 iff packet was not consumed.</span>
<span class="cm"> * If the packet was not accepted, we will call ppp_output_wakeup</span>
<span class="cm"> * at some later time to reactivate flow control in ppp_generic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ppp_irnet_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_channel</span> <span class="o">*</span>	<span class="n">chan</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>		<span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot;(channel=0x%p, ap/self=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">chan</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

  <span class="cm">/* Check if things are somewhat valid... */</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;Self is NULL !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Check if we are connected */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">)))</span>
    <span class="p">{</span>
<span class="cp">#ifdef CONNECT_IN_SEND</span>
      <span class="cm">/* Let&#39;s try to connect one more time... */</span>
      <span class="cm">/* Note : we won&#39;t be connected after this call, but we should be</span>
<span class="cm">       * ready for next packet... */</span>
      <span class="cm">/* If we are already connecting, this will fail */</span>
      <span class="n">irda_irnet_connect</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONNECT_IN_SEND */</span><span class="cp"></span>

      <span class="n">DEBUG</span><span class="p">(</span><span class="n">PPP_INFO</span><span class="p">,</span> <span class="s">&quot;IrTTP not ready ! (%ld-%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_open</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">);</span>

      <span class="cm">/* Note : we can either drop the packet or block the packet.</span>
<span class="cm">       *</span>
<span class="cm">       * Blocking the packet allow us a better connection time,</span>
<span class="cm">       * because by calling ppp_output_wakeup() we can have</span>
<span class="cm">       * ppp_generic resending the LCP request immediately to us,</span>
<span class="cm">       * rather than waiting for one of pppd periodic transmission of</span>
<span class="cm">       * LCP request.</span>
<span class="cm">       *</span>
<span class="cm">       * On the other hand, if we block all packet, all those periodic</span>
<span class="cm">       * transmissions of pppd accumulate in ppp_generic, creating a</span>
<span class="cm">       * backlog of LCP request. When we eventually connect later on,</span>
<span class="cm">       * we have to transmit all this backlog before we can connect</span>
<span class="cm">       * proper (if we don&#39;t timeout before).</span>
<span class="cm">       *</span>
<span class="cm">       * The current strategy is as follow :</span>
<span class="cm">       * While we are attempting to connect, we block packets to get</span>
<span class="cm">       * a better connection time.</span>
<span class="cm">       * If we fail to connect, we drain the queue and start dropping packets</span>
<span class="cm">       */</span>
<span class="cp">#ifdef BLOCK_WHEN_CONNECT</span>
      <span class="cm">/* If we are attempting to connect */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ttp_connect</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="cm">/* Blocking packet, ppp_generic will retry later */</span>
	  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* BLOCK_WHEN_CONNECT */</span><span class="cp"></span>

      <span class="cm">/* Dropping packet, pppd will retry later */</span>
      <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Check if the queue can accept any packet, otherwise block */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_flow</span> <span class="o">!=</span> <span class="n">FLOW_START</span><span class="p">)</span>
    <span class="n">DRETURN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PPP_INFO</span><span class="p">,</span> <span class="s">&quot;IrTTP queue full (%d skbs)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">));</span>

  <span class="cm">/* Prepare ppp frame for transmission */</span>
  <span class="n">skb</span> <span class="o">=</span> <span class="n">irnet_prepare_skb</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="n">DABORT</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;Prepare skb for Tx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Send the packet to IrTTP */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">irttp_data_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tsap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * &gt; IrTTPs tx queue is full, so we just have to</span>
<span class="cm">       * &gt; drop the frame! You might think that we should</span>
<span class="cm">       * &gt; just return -1 and don&#39;t deallocate the frame,</span>
<span class="cm">       * &gt; but that is dangerous since it&#39;s possible that</span>
<span class="cm">       * &gt; we have replaced the original skb with a new</span>
<span class="cm">       * &gt; one with larger headroom, and that would really</span>
<span class="cm">       * &gt; confuse do_dev_queue_xmit() in dev.c! I have</span>
<span class="cm">       * &gt; tried :-) DB</span>
<span class="cm">       * Correction : we verify the flow control above (self-&gt;tx_flow),</span>
<span class="cm">       * so we come here only if IrTTP doesn&#39;t like the packet (empty,</span>
<span class="cm">       * too large, IrTTP not connected). In those rare cases, it&#39;s ok</span>
<span class="cm">       * to drop it, we don&#39;t want to see it here again...</span>
<span class="cm">       * Jean II</span>
<span class="cm">       */</span>
      <span class="n">DERROR</span><span class="p">(</span><span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;IrTTP doesn&#39;t like this packet !!! (0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
      <span class="cm">/* irttp_data_request already free the packet */</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Packet has been consumed */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Take care of the ioctls that ppp_generic doesn&#39;t want to deal with...</span>
<span class="cm"> * Note : we are also called from dev_irnet_ioctl().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ppp_irnet_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_channel</span> <span class="o">*</span>	<span class="n">chan</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irnet_socket</span> <span class="o">*</span>	<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irnet_socket</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
  <span class="kt">int</span>			<span class="n">val</span><span class="p">;</span>
  <span class="n">u32</span>			<span class="n">accm</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot;(channel=0x%p, ap=0x%p, cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">chan</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="cm">/* Basic checks... */</span>
  <span class="n">DASSERT</span><span class="p">(</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">,</span> <span class="n">PPP_ERROR</span><span class="p">,</span> <span class="s">&quot;ap is NULL...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* PPP flags */</span>
    <span class="k">case</span> <span class="n">PPPIOCGFLAGS</span>:
      <span class="n">val</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rbits</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCSFLAGS</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SC_RCV_BITS</span><span class="p">;</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rbits</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">SC_RCV_BITS</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Async map stuff - all dummy to please pppd */</span>
    <span class="k">case</span> <span class="n">PPPIOCGASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCSASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCGRASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">raccm</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCSRASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">raccm</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCGXASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">)))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCSXASYNCMAP</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">accm</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">accm</span><span class="p">)))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">accm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40000000U</span><span class="p">;</span>		<span class="cm">/* can&#39;t escape 0x5e */</span>
      <span class="n">accm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x60000000U</span><span class="p">;</span>		<span class="cm">/* must escape 0x7d, 0x7e */</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">,</span> <span class="n">accm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">xaccm</span><span class="p">));</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Max PPP frame size */</span>
    <span class="k">case</span> <span class="n">PPPIOCGMRU</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mru</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PPPIOCSMRU</span>:
      <span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">PPP_MRU</span><span class="p">)</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">PPP_MRU</span><span class="p">;</span>
      <span class="n">ap</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="n">PPP_INFO</span><span class="p">,</span> <span class="s">&quot;Unsupported ioctl (0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">PPP_TRACE</span><span class="p">,</span> <span class="s">&quot; - err = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************** INITIALISATION **************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Module initialisation and all that jazz...</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Hook our device callbacks in the filesystem, to connect our code</span>
<span class="cm"> * to /dev/irnet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ppp_irnet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">DENTER</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Allocate ourselves as a minor in the misc range */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_misc_device</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Cleanup at exit...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">ppp_irnet_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DENTER</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* De-allocate /dev/irnet minor in misc range */</span>
  <span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irnet_misc_device</span><span class="p">);</span>

  <span class="n">DEXIT</span><span class="p">(</span><span class="n">MODULE_TRACE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Module main entry point</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">irnet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

  <span class="cm">/* Initialise both parts... */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">irda_irnet_init</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">ppp_irnet_init</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Module exit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">irnet_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">irda_irnet_cleanup</span><span class="p">();</span>
  <span class="n">ppp_irnet_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Module magic</span>
<span class="cm"> */</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">irnet_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">irnet_cleanup</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jean Tourrilhes &lt;jt@hpl.hp.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IrNET : Synchronous PPP over IrDA&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">187</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
