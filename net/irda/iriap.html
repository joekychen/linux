<!DOCTYPE html>
<html><head><title>joekychen/linux » net › irda › iriap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>iriap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Filename:      iriap.c</span>
<span class="cm"> * Version:       0.8</span>
<span class="cm"> * Description:   Information Access Protocol (IAP)</span>
<span class="cm"> * Status:        Experimental.</span>
<span class="cm"> * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> * Created at:    Thu Aug 21 00:02:07 1997</span>
<span class="cm"> * Modified at:   Sat Dec 25 16:42:42 1999</span>
<span class="cm"> * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *     Copyright (c) 1998-1999 Dag Brattli &lt;dagb@cs.uit.no&gt;,</span>
<span class="cm"> *     All Rights Reserved.</span>
<span class="cm"> *     Copyright (c) 2000-2003 Jean Tourrilhes &lt;jt@hpl.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *     This program is free software; you can redistribute it and/or</span>
<span class="cm"> *     modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *     published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *     the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *     Neither Dag Brattli nor University of Tromsø admit liability nor</span>
<span class="cm"> *     provide warranty for any of this software. This material is</span>
<span class="cm"> *     provided &quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irttp.h&gt;</span>
<span class="cp">#include &lt;net/irda/irlmp.h&gt;</span>
<span class="cp">#include &lt;net/irda/irias_object.h&gt;</span>
<span class="cp">#include &lt;net/irda/iriap_event.h&gt;</span>
<span class="cp">#include &lt;net/irda/iriap.h&gt;</span>

<span class="cp">#ifdef CONFIG_IRDA_DEBUG</span>
<span class="cm">/* FIXME: This one should go in irlmp.c */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ias_charset_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;CS_ASCII&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_7&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_8&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_ISO_8859_9&quot;</span><span class="p">,</span>
	<span class="s">&quot;CS_UNICODE&quot;</span>
<span class="p">};</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_IRDA_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">hashbin_t</span> <span class="o">*</span><span class="n">iriap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">service_handle</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iriap_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iriap_register_lsap</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">slsap_sel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">iriap_disconnect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
					<span class="n">LM_REASON</span> <span class="n">reason</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">iriap_connect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">max_sdu_size</span><span class="p">,</span>
				     <span class="n">__u8</span> <span class="n">max_header_size</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">iriap_connect_confirm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span>
				  <span class="n">__u32</span> <span class="n">max_sdu_size</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">max_header_size</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iriap_data_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">iriap_watchdog_timer_expired</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iriap_start_watchdog_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irda_start_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span>
			 <span class="n">iriap_watchdog_timer_expired</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">irias_objects_key</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_init (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    Initializes the IrIAP layer, called by the module initialization code</span>
<span class="cm"> *    in irmod.c</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">iriap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">oct_seq</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u16</span> <span class="n">hints</span><span class="p">;</span>

	<span class="cm">/* Allocate master array */</span>
	<span class="n">iriap</span> <span class="o">=</span> <span class="n">hashbin_new</span><span class="p">(</span><span class="n">HB_LOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iriap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Object repository - defined in irias_object.c */</span>
	<span class="n">irias_objects</span> <span class="o">=</span> <span class="n">hashbin_new</span><span class="p">(</span><span class="n">HB_LOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irias_objects</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t allocate irias_objects hashbin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hashbin_delete</span><span class="p">(</span><span class="n">iriap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lockdep_set_class_and_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irias_objects</span><span class="o">-&gt;</span><span class="n">hb_spinlock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irias_objects_key</span><span class="p">,</span>
				   <span class="s">&quot;irias_objects&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Register some default services for IrLMP</span>
<span class="cm">	 */</span>
	<span class="n">hints</span>  <span class="o">=</span> <span class="n">irlmp_service_to_hint</span><span class="p">(</span><span class="n">S_COMPUTER</span><span class="p">);</span>
	<span class="n">service_handle</span> <span class="o">=</span> <span class="n">irlmp_register_service</span><span class="p">(</span><span class="n">hints</span><span class="p">);</span>

	<span class="cm">/* Register the Device object with LM-IAS */</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">irias_new_object</span><span class="p">(</span><span class="s">&quot;Device&quot;</span><span class="p">,</span> <span class="n">IAS_DEVICE_ID</span><span class="p">);</span>
	<span class="n">irias_add_string_attrib</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;DeviceName&quot;</span><span class="p">,</span> <span class="s">&quot;Linux&quot;</span><span class="p">,</span> <span class="n">IAS_KERNEL_ATTR</span><span class="p">);</span>

	<span class="n">oct_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>  <span class="cm">/* Version 1 */</span>
	<span class="n">oct_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* IAS support bits */</span>
	<span class="n">oct_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* LM-MUX support bits */</span>
<span class="cp">#ifdef CONFIG_IRDA_ULTRA</span>
	<span class="n">oct_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Connectionless Data support */</span>
<span class="cp">#endif</span>
	<span class="n">irias_add_octseq_attrib</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;IrLMPSupport&quot;</span><span class="p">,</span> <span class="n">oct_seq</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">IAS_KERNEL_ATTR</span><span class="p">);</span>
	<span class="n">irias_insert_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Register server support with IrLMP so we can accept incoming</span>
<span class="cm">	 *  connections</span>
<span class="cm">	 */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">iriap_open</span><span class="p">(</span><span class="n">LSAP_IAS</span><span class="p">,</span> <span class="n">IAS_SERVER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), unable to open server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iriap_register_lsap</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">LSAP_IAS</span><span class="p">,</span> <span class="n">IAS_SERVER</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_cleanup (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    Initializes the IrIAP layer, called by the module cleanup code in</span>
<span class="cm"> *    irmod.c</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iriap_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irlmp_unregister_service</span><span class="p">(</span><span class="n">service_handle</span><span class="p">);</span>

	<span class="n">hashbin_delete</span><span class="p">(</span><span class="n">iriap</span><span class="p">,</span> <span class="p">(</span><span class="n">FREE_FUNC</span><span class="p">)</span> <span class="n">__iriap_close</span><span class="p">);</span>
	<span class="n">hashbin_delete</span><span class="p">(</span><span class="n">irias_objects</span><span class="p">,</span> <span class="p">(</span><span class="n">FREE_FUNC</span><span class="p">)</span> <span class="n">__irias_delete_object</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_open (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    Opens an instance of the IrIAP layer, and registers with IrLMP</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="nf">iriap_open</span><span class="p">(</span><span class="n">__u8</span> <span class="n">slsap_sel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="n">CONFIRM_CALLBACK</span> <span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: Unable to kmalloc!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Initialize instance</span>
<span class="cm">	 */</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">IAS_MAGIC</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IAS_CLIENT</span><span class="p">)</span>
		<span class="n">iriap_register_lsap</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">slsap_sel</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* iriap_getvaluebyclass_request() will construct packets before</span>
<span class="cm">	 * we connect, so this must have a sane value... Jean II */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">=</span> <span class="n">LMP_MAX_HEADER</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="n">hashbin_insert</span><span class="p">(</span><span class="n">iriap</span><span class="p">,</span> <span class="p">(</span><span class="n">irda_queue_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">self</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Initialize state machines */</span>
	<span class="n">iriap_next_client_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">S_DISCONNECT</span><span class="p">);</span>
	<span class="n">iriap_next_call_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">S_MAKE_CALL</span><span class="p">);</span>
	<span class="n">iriap_next_server_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">R_DISCONNECT</span><span class="p">);</span>
	<span class="n">iriap_next_r_connect_state</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">R_WAITING</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iriap_open</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function __iriap_close (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Removes (deallocates) the IrIAP instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__iriap_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">request_skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">request_skb</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_close (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    Closes IrIAP and deregisters with IrLMP</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iriap_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irlmp_close_lsap</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_remove</span><span class="p">(</span><span class="n">iriap</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">self</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">self</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">__iriap_close</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iriap_close</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iriap_register_lsap</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">slsap_sel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">notify_t</span> <span class="n">notify</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">irda_notify_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="p">);</span>
	<span class="n">notify</span><span class="p">.</span><span class="n">connect_confirm</span>       <span class="o">=</span> <span class="n">iriap_connect_confirm</span><span class="p">;</span>
	<span class="n">notify</span><span class="p">.</span><span class="n">connect_indication</span>    <span class="o">=</span> <span class="n">iriap_connect_indication</span><span class="p">;</span>
	<span class="n">notify</span><span class="p">.</span><span class="n">disconnect_indication</span> <span class="o">=</span> <span class="n">iriap_disconnect_indication</span><span class="p">;</span>
	<span class="n">notify</span><span class="p">.</span><span class="n">data_indication</span>       <span class="o">=</span> <span class="n">iriap_data_indication</span><span class="p">;</span>
	<span class="n">notify</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IAS_CLIENT</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IrIAS cli&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">notify</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IrIAS srv&quot;</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">irlmp_open_lsap</span><span class="p">(</span><span class="n">slsap_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notify</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: Unable to allocated LSAP!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">slsap_sel</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="o">-&gt;</span><span class="n">slsap_sel</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_disconnect_indication (handle, reason)</span>
<span class="cm"> *</span>
<span class="cm"> *    Got disconnect, so clean up everything associated with this connection</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_disconnect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
					<span class="n">LM_REASON</span> <span class="n">reason</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">irlmp_reasons</span><span class="p">[</span><span class="n">reason</span><span class="p">]);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">iriap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="cm">/* Not needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IAS_CLIENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), disconnect as client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>


		<span class="n">iriap_do_client_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_LM_DISCONNECT_INDICATION</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Inform service user that the request failed by sending</span>
<span class="cm">		 * it a NULL value. Warning, the client might close us, so</span>
<span class="cm">		 * remember no to use self anymore after calling confirm</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">)</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">(</span><span class="n">IAS_DISCONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), disconnect as server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">iriap_do_server_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_LM_DISCONNECT_INDICATION</span><span class="p">,</span>
				      <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">iriap_close</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_disconnect_request (handle)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_disconnect_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">LMP_MAX_HEADER</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			   <span class="s">&quot;%s(), Could not allocate an sk_buff of length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">LMP_MAX_HEADER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Reserve space for MUX control and LAP header</span>
<span class="cm">	 */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">LMP_MAX_HEADER</span><span class="p">);</span>

	<span class="n">irlmp_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_getvaluebyclass (addr, name, attr)</span>
<span class="cm"> *</span>
<span class="cm"> *    Retrieve all values from attribute in all objects with given class</span>
<span class="cm"> *    name</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iriap_getvaluebyclass_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				  <span class="n">__u32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">daddr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">,</span> <span class="n">skb_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="cm">/* Client must supply the destination device address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">saddr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Save operation, so we know what the later indication is about</span>
<span class="cm">	 */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">GET_VALUE_BY_CLASS</span><span class="p">;</span>

	<span class="cm">/* Give ourselves 10 secs to finish this operation */</span>
	<span class="n">iriap_start_watchdog_timer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>	<span class="cm">/* Up to IAS_MAX_CLASSNAME = 60 */</span>
	<span class="n">attr_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>	<span class="cm">/* Up to IAS_MAX_ATTRIBNAME = 60 */</span>

	<span class="n">skb_len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">attr_len</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">skb_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Reserve space for MUX and LAP header */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">name_len</span><span class="o">+</span><span class="n">attr_len</span><span class="p">);</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Build frame */</span>
	<span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IAP_LST</span> <span class="o">|</span> <span class="n">GET_VALUE_BY_CLASS</span><span class="p">;</span>
	<span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_len</span><span class="p">;</span>                       <span class="cm">/* Insert length of name */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>           <span class="cm">/* Insert name */</span>
	<span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_len</span><span class="p">;</span>              <span class="cm">/* Insert length of attr */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">name_len</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">);</span>  <span class="cm">/* Insert attr */</span>

	<span class="n">iriap_do_client_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_CALL_REQUEST_GVBC</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>

	<span class="cm">/* Drop reference count - see state_s_disconnect(). */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iriap_getvaluebyclass_request</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_getvaluebyclass_confirm (self, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Got result from GetValueByClass command. Parse it and return result</span>
<span class="cm"> *    to service user.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_getvaluebyclass_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ias_value</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">charset</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">value_len</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">tmp_cpu32</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">obj_id</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">type</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="cm">/* Initialize variables */</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Get length, MSB first */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Get object ID, MSB first */</span>
	<span class="n">obj_id</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), Value type = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IAS_INTEGER</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_cpu32</span><span class="p">,</span> <span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">be32_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_cpu32</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">irias_new_integer_value</span><span class="p">(</span><span class="n">tmp_cpu32</span><span class="p">);</span>

		<span class="cm">/*  Legal values restricted to 0x01-0x6f, page 15 irttp */</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), lsap=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IAS_STRING</span>:
		<span class="n">charset</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">charset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS_ASCII</span>:
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case CS_ISO_8859_1: */</span>
<span class="cm">/*		case CS_ISO_8859_2: */</span>
<span class="cm">/*		case CS_ISO_8859_3: */</span>
<span class="cm">/*		case CS_ISO_8859_4: */</span>
<span class="cm">/*		case CS_ISO_8859_5: */</span>
<span class="cm">/*		case CS_ISO_8859_6: */</span>
<span class="cm">/*		case CS_ISO_8859_7: */</span>
<span class="cm">/*		case CS_ISO_8859_8: */</span>
<span class="cm">/*		case CS_ISO_8859_9: */</span>
<span class="cm">/*		case CS_UNICODE: */</span>
		<span class="nl">default:</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), charset %s, not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">ias_charset_types</span><span class="p">[</span><span class="n">charset</span><span class="p">]);</span>

			<span class="cm">/* Aborting, close connection! */</span>
			<span class="n">iriap_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
			<span class="cm">/* break; */</span>
		<span class="p">}</span>
		<span class="n">value_len</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), strlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>

		<span class="cm">/* Make sure the string is null-terminated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">value_len</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="n">fp</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Got string %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">);</span>

		<span class="cm">/* Will truncate to IAS_MAX_STRING bytes */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">irias_new_string_value</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IAS_OCT_SEQ</span>:
		<span class="n">value_len</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* Will truncate to IAS_MAX_OCTET_STRING bytes */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">irias_new_octseq_value</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">irias_new_missing_value</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finished, close connection! */</span>
	<span class="n">iriap_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="cm">/* Warning, the client might close us, so remember no to use self</span>
<span class="cm">	 * anymore after calling confirm</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">)</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">(</span><span class="n">IAS_SUCCESS</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), missing handler!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">irias_delete_value</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_getvaluebyclass_response ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Send answer back to remote LM-IAS</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_getvaluebyclass_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					   <span class="n">__u16</span> <span class="n">obj_id</span><span class="p">,</span>
					   <span class="n">__u8</span> <span class="n">ret_code</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ias_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tmp_be32</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">tmp_be16</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="cm">/* Initialize variables */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  We must adjust the size of the response after the length of the</span>
<span class="cm">	 *  value. We add 32 bytes because of the 6 bytes for the frame and</span>
<span class="cm">	 *  max 5 bytes for the value coding.</span>
<span class="cm">	 */</span>
	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span>
			   <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Reserve space for MUX and LAP header */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Build frame */</span>
	<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_VALUE_BY_CLASS</span> <span class="o">|</span> <span class="n">IAP_LST</span><span class="p">;</span>
	<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret_code</span><span class="p">;</span>

	<span class="cm">/* Insert list length (MSB first) */</span>
	<span class="n">tmp_be16</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_be16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>  <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Insert object identifier ( MSB first) */</span>
	<span class="n">tmp_be16</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">obj_id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_be16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IAS_STRING</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ASCII */</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span> <span class="n">n</span><span class="o">+=</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IAS_INTEGER</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="n">tmp_be32</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_be32</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IAS_OCT_SEQ</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

		<span class="n">tmp_be16</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_be16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">oct_seq</span><span class="p">,</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span> <span class="n">n</span><span class="o">+=</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IAS_MISSING</span>:
		<span class="n">IRDA_DEBUG</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: sending IAS_MISSING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), type not implemented!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iriap_do_r_connect_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_CALL_RESPONSE</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>

	<span class="cm">/* Drop reference count - see state_r_execute(). */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_getvaluebyclass_indication (self, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    getvaluebyclass is requested from peer LM-IAS</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_getvaluebyclass_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ias_attrib</span> <span class="o">*</span><span class="n">attrib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attr_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">IAS_MAX_CLASSNAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* 60 bytes */</span>
	<span class="kt">char</span> <span class="n">attr</span><span class="p">[</span><span class="n">IAS_MAX_ATTRIBNAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* 60 bytes */</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">name_len</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">name_len</span> <span class="o">&lt;</span> <span class="n">IAS_MAX_CLASSNAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span> <span class="n">n</span><span class="o">+=</span><span class="n">name_len</span><span class="p">;</span>
	<span class="n">name</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">attr_len</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">attr_len</span> <span class="o">&lt;</span> <span class="n">IAS_MAX_ATTRIBNAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">fp</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">);</span> <span class="n">n</span><span class="o">+=</span><span class="n">attr_len</span><span class="p">;</span>
	<span class="n">attr</span><span class="p">[</span><span class="n">attr_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;LM-IAS: Looking up %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">irias_find_object</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;LM-IAS: Object %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">iriap_getvaluebyclass_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mh">0x1235</span><span class="p">,</span> <span class="n">IAS_CLASS_UNKNOWN</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">irias_missing</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;LM-IAS: found %s, id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">attrib</span> <span class="o">=</span> <span class="n">irias_find_attrib</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attrib</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;LM-IAS: Attribute %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="n">iriap_getvaluebyclass_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					       <span class="n">IAS_ATTRIB_UNKNOWN</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">irias_missing</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have a match; send the value.  */</span>
	<span class="n">iriap_getvaluebyclass_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">IAS_SUCCESS</span><span class="p">,</span>
				       <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_send_ack (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    Currently not used</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iriap_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">LMP_MAX_HEADER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Reserve space for MUX and LAP header */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Build frame */</span>
	<span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IAP_LST</span> <span class="o">|</span> <span class="n">IAP_ACK</span> <span class="o">|</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>

	<span class="n">irlmp_data_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iriap_connect_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">irlmp_connect_request</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">,</span> <span class="n">LSAP_IAS</span><span class="p">,</span>
				    <span class="n">self</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), connect failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">(</span><span class="n">IAS_DISCONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_connect_confirm (handle, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    LSAP connection confirmed!</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_connect_confirm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">max_seg_size</span><span class="p">,</span>
				  <span class="n">__u8</span> <span class="n">max_header_size</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">max_seg_size</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">=</span> <span class="n">max_header_size</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="n">iriap_do_client_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_LM_CONNECT_CONFIRM</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Drop reference count - see state_s_make_call(). */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_connect_indication ( handle, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Remote LM-IAS is requesting connection</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_connect_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">qos_info</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">max_seg_size</span><span class="p">,</span>
				     <span class="n">__u8</span> <span class="n">max_header_size</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;);</span>

	<span class="cm">/* Start new server */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">iriap_open</span><span class="p">(</span><span class="n">LSAP_IAS</span><span class="p">,</span> <span class="n">IAS_SERVER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), open failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now attach up the new &quot;socket&quot; */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">lsap</span> <span class="o">=</span> <span class="n">irlmp_dup</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), dup failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">max_seg_size</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">max_header_size</span> <span class="o">=</span> <span class="n">max_header_size</span><span class="p">;</span>

	<span class="cm">/* Clean up the original one to keep it in listen state */</span>
	<span class="n">irlmp_listen</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lsap</span><span class="p">);</span>

	<span class="n">iriap_do_server_event</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">IAP_LM_CONNECT_INDICATION</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/* Drop reference count - see state_r_disconnect(). */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_data_indication (handle, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Receives data from connection identified by handle from IrLMP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iriap_data_indication</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">opcode</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;);</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IAS_SERVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Call server */</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), Calling server!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">iriap_do_r_connect_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_RECV_F_LST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">IAP_LST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s:, IrIAS multiframe commands or &quot;</span>
			     <span class="s">&quot;results is not implemented yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for ack frames since they don&#39;t contain any data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">IAP_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s() Got ack frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IAP_LST</span><span class="p">;</span> <span class="cm">/* Mask away LST bit */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GET_INFO_BASE</span>:
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;IrLMP GetInfoBaseDetails not implemented!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GET_VALUE_BY_CLASS</span>:
		<span class="n">iriap_do_call_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IAP_RECV_F_LST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IAS_SUCCESS</span>:
			<span class="n">iriap_getvaluebyclass_confirm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IAS_CLASS_UNKNOWN</span>:
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), No such class!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* Finished, close connection! */</span>
			<span class="n">iriap_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Warning, the client might close us, so remember</span>
<span class="cm">			 * no to use self anymore after calling confirm</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">)</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">(</span><span class="n">IAS_CLASS_UNKNOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IAS_ATTRIB_UNKNOWN</span>:
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), No such attribute!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* Finished, close connection! */</span>
			<span class="n">iriap_disconnect_request</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Warning, the client might close us, so remember</span>
<span class="cm">			 * no to use self anymore after calling confirm</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">)</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">(</span><span class="n">IAS_ATTRIB_UNKNOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">self</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), Unknown op-code: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="cm">/* Cleanup - sub-calls will have done skb_get() as needed. */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_call_indication (self, skb)</span>
<span class="cm"> *</span>
<span class="cm"> *    Received call to server from peer LM-IAS</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iriap_call_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">opcode</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: IrIAS multiframe commands or results &quot;</span>
			     <span class="s">&quot;is not implemented yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span> <span class="cm">/* Mask away LST bit */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GET_INFO_BASE</span>:
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: GetInfoBaseDetails not implemented yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GET_VALUE_BY_CLASS</span>:
		<span class="n">iriap_getvaluebyclass_indication</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* skb will be cleaned up in iriap_data_indication */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function iriap_watchdog_timer_expired (data)</span>
<span class="cm"> *</span>
<span class="cm"> *    Query has taken too long time, so abort</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iriap_watchdog_timer_expired</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iriap_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_MAGIC</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="cm">/* iriap_close(self); */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ias_value_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;IAS_MISSING&quot;</span><span class="p">,</span>
	<span class="s">&quot;IAS_INTEGER&quot;</span><span class="p">,</span>
	<span class="s">&quot;IAS_OCT_SEQ&quot;</span><span class="p">,</span>
	<span class="s">&quot;IAS_STRING&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="nf">irias_seq_idx</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">irias_objects</span><span class="p">);</span>
	     <span class="n">obj</span><span class="p">;</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">irias_objects</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">irias_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irias_objects</span><span class="o">-&gt;</span><span class="n">hb_spinlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">irias_seq_idx</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">irias_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="o">?</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">irias_objects</span><span class="p">)</span>
		<span class="o">:</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">irias_objects</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irias_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irias_objects</span><span class="o">-&gt;</span><span class="n">hb_spinlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irias_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;LM-IAS Objects:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ias_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ias_attrib</span> <span class="o">*</span><span class="n">attrib</span><span class="p">;</span>

		<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_OBJECT_MAGIC</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;name: %s, id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="cm">/* Careful for priority inversions here !</span>
<span class="cm">		 * All other uses of attrib spinlock are independent of</span>
<span class="cm">		 * the object spinlock, so we are safe. Jean II */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">attribs</span><span class="o">-&gt;</span><span class="n">hb_spinlock</span><span class="p">);</span>

		<span class="cm">/* List all attributes for this object */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ias_attrib</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_first</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">attribs</span><span class="p">);</span>
		     <span class="n">attrib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
		     <span class="n">attrib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ias_attrib</span> <span class="o">*</span><span class="p">)</span> <span class="n">hashbin_get_next</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">attribs</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">attrib</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">IAS_ATTRIB_MAGIC</span><span class="p">,</span>
				    <span class="k">goto</span> <span class="n">outloop</span><span class="p">;</span> <span class="p">);</span>

			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; - Attribute name: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, &quot;</span><span class="p">,</span>
				   <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;value[%s]: &quot;</span><span class="p">,</span>
				   <span class="n">ias_value_types</span><span class="p">[</span><span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IAS_INTEGER</span>:
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IAS_STRING</span>:
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IAS_OCT_SEQ</span>:
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;octet sequence (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IAS_MISSING</span>:
				<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;type %d?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">attrib</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="n">IRDA_ASSERT_LABEL</span><span class="p">(</span><span class="n">outloop</span><span class="o">:</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">attribs</span><span class="o">-&gt;</span><span class="n">hb_spinlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">irias_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">irias_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">irias_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">irias_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">irias_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irias_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span> <span class="n">irias_objects</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;);</span>

	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irias_seq_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">irias_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>           <span class="o">=</span> <span class="n">irias_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>           <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>         <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* PROC_FS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
